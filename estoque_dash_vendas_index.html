<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Diagnóstico Final de Importação</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; line-height: 1.6; }
        #log { border: 1px solid #ccc; background-color: #1e1e1e; color: #d4d4d4; padding: 15px; height: 60vh; overflow-y: scroll; white-space: pre-wrap; margin-top: 20px; font-family: monospace; font-size: 14px; }
        .log-ok { color: #4CAF50; }
        .log-err { color: #F44336; font-weight: bold; }
        .log-info { color: #2196F3; }
        .log-warn { color: #FFC107; }
        .log-title { color: #9C27B0; font-weight: bold; text-transform: uppercase; margin-top: 15px; border-bottom: 1px solid #9C27B0; padding-bottom: 5px;}
        button { padding: 10px 15px; font-size: 16px; margin-right: 10px; cursor: pointer; }
        hr { margin: 20px 0; }
    </style>
</head>
<body>

    <h1>Página de Diagnóstico Final</h1>
    <p>Execute os testes na ordem para identificar a falha no processo de importação.</p>

    <button id="permissionTestButton">1. Testar Permissões da Tabela de Importação</button>
    <hr>
    <input type="file" id="fileInput">
    <button id="importTestButton">2. Executar Processo de Importação Completo</button>

    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const SUPABASE_URL = "https://msmyfxgrnuusnvoqyeuo.supabase.co";
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U";
        const STAGING_TABLE = 'vendas_xlsx';
        const FINAL_TABLE = 'vendas_canon';
        const REFRESH_RPC = 'refresh_sales_materialized';

        const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        const logEl = document.getElementById('log');

        function log(message, type = 'info') {
            const p = document.createElement('p');
            const timestamp = `[${new Date().toLocaleTimeString()}] `;
            p.textContent = timestamp + message;
            p.className = `log-${type}`;
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function testPermissions() {
            logEl.innerHTML = '';
            log('INICIANDO TESTE DE PERMISSÕES...', 'title');
            const dummyRow = { row_key: 'test-permission-row-123', loja: 'Teste' };

            // Teste de INSERT
            try {
                log(`Tentando INSERIR 1 linha em '${STAGING_TABLE}'...`, 'info');
                const { error } = await supa.from(STAGING_TABLE).insert([dummyRow]);
                if (error) throw error;
                log('Permissão de INSERT: OK', 'ok');
            } catch (e) {
                log('Permissão de INSERT: FALHOU', 'err');
                log(`ERRO: ${e.message}`, 'err');
                return;
            }

            // Teste de SELECT
            try {
                log(`Tentando LER a linha inserida de '${STAGING_TABLE}'...`, 'info');
                const { data, error } = await supa.from(STAGING_TABLE).select('row_key').eq('row_key', dummyRow.row_key);
                if (error) throw error;
                if (data && data.length > 0) {
                    log('Permissão de SELECT: OK', 'ok');
                } else {
                    throw new Error('A linha inserida não foi encontrada. Isso indica um problema de RLS (política de SELECT).');
                }
            } catch (e) {
                log('Permissão de SELECT: FALHOU', 'err');
                log(`ERRO: ${e.message}`, 'err');
                return;
            }

            // Teste de DELETE
            try {
                log(`Tentando DELETAR a linha inserida de '${STAGING_TABLE}'...`, 'info');
                const { error } = await supa.from(STAGING_TABLE).delete().eq('row_key', dummyRow.row_key);
                if (error) throw error;
                log('Permissão de DELETE: OK', 'ok');
            } catch (e) {
                log('Permissão de DELETE: FALHOU', 'err');
                log(`ERRO: ${e.message}`, 'err');
                return;
            }

            log('TESTE DE PERMISSÕES CONCLUÍDO COM SUCESSO!', 'ok');
        }

        async function runFullImport() {
            logEl.innerHTML = '';
            log('INICIANDO PROCESSO DE IMPORTAÇÃO COMPLETO...', 'title');
            const file = document.getElementById('fileInput').files[0];

            if (!file) {
                log('ERRO: Nenhum arquivo selecionado.', 'err');
                return;
            }
            log(`Arquivo selecionado: ${file.name}`, 'info');

            try {
                // ETAPA 1: Limpeza Inicial
                log('ETAPA 1: Limpando a tabela de importação (vendas_xlsx)...', 'info');
                const { error: truncateError } = await supa.from(STAGING_TABLE).delete().neq('row_key', 'never-match-this');
                if (truncateError) throw truncateError;
                log('Limpeza da tabela de importação: OK', 'ok');

                // ETAPA 2: Ler arquivo
                log('ETAPA 2: Lendo arquivo...', 'info');
                const json = await parseFile(file);
                log(`Arquivo lido. Encontradas ${json.length} linhas.`, 'ok');
                
                // ETAPA 3: Enviar para o Supabase
                log(`ETAPA 3: Enviando ${json.length} linhas para '${STAGING_TABLE}'...`, 'info');
                const { error: insertError } = await supa.from(STAGING_TABLE).insert(json);
                if (insertError) throw insertError;
                log(`Envio para '${STAGING_TABLE}': OK`, 'ok');

                // ETAPA 4: VERIFICAÇÃO PÓS-ENVIO
                log(`ETAPA 4: Verificando se os dados realmente estão em '${STAGING_TABLE}'...`, 'info');
                const { count: countAfterInsert, error: countError1 } = await supa.from(STAGING_TABLE).select('*', { count: 'exact', head: true });
                if (countError1) throw countError1;
                log(`Verificação 1: Encontradas ${countAfterInsert} linhas em '${STAGING_TABLE}'.`, countAfterInsert === json.length ? 'ok' : 'err');
                if (countAfterInsert !== json.length) {
                    throw new Error("A contagem de linhas após o envio não bate! O envio falhou silenciosamente.");
                }

                // ETAPA 5: Chamar a função de processamento
                log(`ETAPA 5: Chamando a função de processamento '${REFRESH_RPC}'...`, 'info');
                const { error: rpcError } = await supa.rpc(REFRESH_RPC);
                if (rpcError) throw rpcError;
                log(`Execução da função '${REFRESH_RPC}': OK`, 'ok');

                // ETAPA 6: VERIFICAÇÃO FINAL
                log(`ETAPA 6: Verificando resultado final...`, 'info');
                const { count: countAfterRpc, error: countError2 } = await supa.from(STAGING_TABLE).select('*', { count: 'exact', head: true });
                log(`Verificação 2: Linhas em '${STAGING_TABLE}' após processamento: ${countAfterRpc}. (Esperado: 0)`, countAfterRpc === 0 ? 'ok' : 'warn');

                const { count: finalCount, error: countError3 } = await supa.from(FINAL_TABLE).select('*', { count: 'exact', head: true });
                log(`Verificação 3: Linhas totais na tabela final '${FINAL_TABLE}': ${finalCount}.`, finalCount > 0 ? 'ok' : 'err');

                log('PROCESSO DE IMPORTAÇÃO CONCLUÍDO!', 'title');

            } catch (e) {
                log('!!!!!!!!!! O PROCESSO FALHOU !!!!!!!!!!', 'err');
                log(`ETAPA DA FALHA: ${e.message}`, 'err');
                log(`DETALHES DO ERRO: ${JSON.stringify(e, null, 2)}`, 'err');
            }
        }

        async function parseFile(file) {
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(buf, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { raw: false, defval: null });

            const headerMap = {
                'dia': 'dia', 'data': 'dia', 'hora': 'hora', 'unidade': 'unidade',
                'loja': 'loja', 'nome da loja': 'loja', 'canal': 'canal',
                'canal de venda': 'canal', 'pagamento_base': 'pagamento_base',
                'pagamento': 'pagamento_base', 'cancelado': 'cancelado',
                'fat': 'fat', 'faturamento': 'fat', 'des': 'des',
                'desconto': 'des', 'incentivos': 'des', 'fre': 'fre',
                'frete': 'fre', 'pedido_id': 'pedido_id', 'id do pedido': 'pedido_id'
            };

            return json.map((row, index) => {
                const newRow = {};
                for (const originalKey in row) {
                    const normalizedKey = String(originalKey).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    const dbColumn = headerMap[normalizedKey];
                    if (dbColumn) newRow[dbColumn] = row[originalKey];
                }
                const tempPedidoId = newRow['pedido_id'] || null;
                newRow['row_key'] = tempPedidoId ? `${tempPedidoId}-${new Date().getTime()}-${index}` : `import-${new Date().getTime()}-${index}`;
                return newRow;
            });
        }

        document.getElementById('permissionTestButton').addEventListener('click', testPermissions);
        document.getElementById('importTestButton').addEventListener('click', runFullImport);
    </script>
</body>
</html>
