<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Teste de Importação Supabase</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        #log { border: 1px solid #ccc; background-color: #fff; padding: 10px; height: 500px; overflow-y: scroll; white-space: pre-wrap; margin-top: 20px; font-family: monospace; }
        .log-ok { color: green; }
        .log-err { color: red; font-weight: bold; }
        .log-info { color: blue; }
        button { padding: 10px 15px; font-size: 16px; }
    </style>
</head>
<body>

    <h1>Página de Teste de Importação</h1>
    <p>Use esta página para isolar e depurar o processo de upload e processamento de dados no Supabase.</p>

    <input type="file" id="fileInput">
    <button id="startButton">Iniciar Teste de Importação</button>

    <h3>Log de Eventos:</h3>
    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ===============================================
        // CONFIGURAÇÕES (Suas credenciais Supabase)
        // ===============================================
        const SUPABASE_URL = "https://msmyfxgrnuusnvoqyeuo.supabase.co";
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U";
        const DEST_INSERT_TABLE = 'vendas_xlsx';
        const REFRESH_RPC = 'refresh_sales_materialized';

        const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        const logEl = document.getElementById('log');

        function log(message, type = 'info') {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            p.className = `log-${type}`;
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function startTest() {
            logEl.innerHTML = ''; // Limpa o log a cada teste
            const file = document.getElementById('fileInput').files[0];

            if (!file) {
                log('ERRO: Nenhum arquivo selecionado.', 'err');
                return;
            }

            log(`Arquivo selecionado: ${file.name}`, 'info');

            try {
                // 1. Limpar a tabela de importação para garantir um teste limpo
                log('PASSO 1: Limpando a tabela de importação (vendas_xlsx)...', 'info');
                const { error: truncateError } = await supa.from('vendas_xlsx').delete().neq('row_key', 'never-match-this');
                if (truncateError) throw truncateError;
                log('Limpeza concluída com sucesso.', 'ok');

                // 2. Ler e processar o arquivo
                log('PASSO 2: Lendo e processando o arquivo localmente...', 'info');
                const buf = await file.arrayBuffer();
                const wb = XLSX.read(buf, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, { raw: false, defval: null });
                log(`Encontradas ${json.length} linhas no arquivo.`, 'ok');

                const headerMap = {
                    'dia': 'dia', 'hora': 'hora', 'unidade': 'unidade',
                    'loja': 'Nome da loja', 'canal de venda': 'Canal de venda',
                    'pagamento_base': 'pagamento_base', 'cancelado': 'cancelado',
                    'pedidos': 'pedidos', 'fat': 'fat', 'des': 'des', 'fre': 'fre',
                    'pedido_id': 'pedido_id'
                };

                const transformedJson = json.map((row, index) => {
                    const newRow = {};
                    let tempPedidoId = null;
                    for (const originalKey in row) {
                        const normalizedKey = originalKey.trim().toLowerCase();
                        const dbColumn = headerMap[normalizedKey];
                        if (dbColumn) {
                            newRow[dbColumn] = row[originalKey];
                            if (normalizedKey === 'pedido_id') tempPedidoId = row[originalKey];
                        }
                    }
                    if (tempPedidoId) {
                        newRow['row_key'] = `${tempPedidoId}-${new Date().getTime()}-${index}`;
                    } else {
                        newRow['row_key'] = `import-${new Date().getTime()}-${index}`;
                    }
                    return newRow;
                });
                log('Transformação dos dados concluída.', 'ok');

                // 3. Inserir dados na tabela de importação
                log(`PASSO 3: Enviando ${transformedJson.length} linhas para a tabela '${DEST_INSERT_TABLE}'...`, 'info');
                const { error: insertError } = await supa.from(DEST_INSERT_TABLE).insert(transformedJson);
                if (insertError) throw insertError;
                log('Dados enviados com sucesso.', 'ok');

                // 4. Chamar a função de processamento no servidor
                log(`PASSO 4: Chamando a função de processamento no servidor ('${REFRESH_RPC}')...`, 'info');
                const { error: rpcError } = await supa.rpc(REFRESH_RPC);
                if (rpcError) throw rpcError;
                log('Função de processamento executada com sucesso.', 'ok');
                
                log('TESTE CONCLUÍDO!', 'ok');

            } catch (e) {
                log('!!!!!!!!!! OCORREU UM ERRO !!!!!!!!!!', 'err');
                log(`MENSAGEM: ${e.message}`, 'err');
                log(`DETALHES: ${JSON.stringify(e, null, 2)}`, 'err');
            }
        }

        document.getElementById('startButton').addEventListener('click', startTest);
    </script>
</body>
</html>
