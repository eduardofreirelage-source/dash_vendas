<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Supabase (v17.2 + hotfix gráfico)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#f6f7fb; --ink:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb;
        --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--ink);
           font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 6px}
      .muted{color:var(--muted);font-size:12px}
      .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
      .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;
            box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
      .k .t{color:var(--muted);font-size:12px}
      .k .v{font-size:20px;font-weight:800;margin-top:2px}
      .k .d{font-size:12px;margin-top:4px}
      .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--brd);
            border-radius:20px;background:#fff;font-size:12px;cursor:pointer}
      .pill input{margin:0 2px 0 0}
      select, input[type="date"]{
        appearance:none;background:#fff;border:1px solid var(--brd);border-radius:10px;padding:8px 10px;
        font:inherit;min-width:150px
      }
      button{border:1px solid var(--brd);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
      button.primary{background:#111827;color:#fff;border-color:#111827}
      .chartwrap{height:340px} /* altura fixa para estabilidade */
      .chartwrap canvas{width:100%;height:100%} /* canvas sempre ocupa o wrapper */
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:10px;
          overflow:auto;white-space:pre-wrap}
      @media(max-width:900px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media(max-width:520px){.grid4{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <!-- Chart.js UMD -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Build <b>v17.2 (hotfix gráfico + unidade)</b> • Fonte preferida: <code>public.vendas_kpi_daily</code></div>
          <div class="muted">URL: <code id="urlShow">—</code></div>
        </div>
        <div class="muted" id="periodoShow">Período: —</div>
      </div>

      <!-- Filtros -->
      <div class="card" style="margin-top:12px">
        <div class="row">
          <div>
            <div class="muted" style="margin-bottom:4px">Unidade</div>
            <select id="selUnidade" data-role="sel-unidade">
              <option>Todas</option>
            </select>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px">Período rápido (dias)</div>
            <div class="row">
              <button class="pill" data-quick="7">7</button>
              <button class="pill" data-quick="15">15</button>
              <button class="pill" data-quick="30">30</button>
              <button class="pill" data-quick="90">90</button>
              <button class="pill" data-quick="180">180</button>
              <button class="pill" data-quick="360">360</button>
            </div>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px">De / Até</div>
            <div class="row">
              <input type="date" id="dtDe" />
              <input type="date" id="dtAte" />
              <button id="btnAplicar">Aplicar</button>
            </div>
            <div class="muted" style="margin-top:2px">Se preencher as datas, o período rápido é ignorado.</div>
          </div>

          <div>
            <div class="muted" style="margin-bottom:6px">Modo de Faturamento</div>
            <label class="pill"><input type="radio" name="modo" value="bruto" checked /> Total (bruto)</label>
            <label class="pill"><input type="radio" name="modo" value="liquido" /> Líquido (Total − Entrega)</label>
          </div>

          <div style="margin-left:auto">
            <div class="muted" style="margin-bottom:6px">Ações</div>
            <div class="row">
              <button id="btnClear">Limpar filtros</button>
              <button id="btnReload" class="primary">Recarregar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid4" style="margin-top:12px">
        <div class="card k">
          <div class="t">Pedidos</div>
          <div class="v" id="k_ped">…</div>
          <div class="d" id="d_ped">—</div>
        </div>
        <div class="card k">
          <div class="t">Faturamento</div>
          <div class="v" id="k_fat">…</div>
          <div class="d" id="d_fat">—</div>
        </div>
        <div class="card k">
          <div class="t">Incentivos</div>
          <div class="v" id="k_des">…</div>
          <div class="d" id="d_des">—</div>
        </div>
        <div class="card k">
          <div class="t">Frete</div>
          <div class="v" id="k_fre">…</div>
          <div class="d" id="d_fre">—</div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="card" style="margin-top:12px">
        <div class="muted" style="margin-bottom:6px">Receita diária (R$)</div>
        <div id="chartLineWrap" class="chartwrap"><canvas id="chartLine"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="muted" style="margin-bottom:6px">Totais por dia da semana (R$)</div>
        <div id="chartWeekWrap" class="chartwrap"><canvas id="chartWeek"></canvas></div>
      </div>

      <!-- Logs -->
      <div class="card" style="margin-top:12px">
        <div class="muted" style="margin-bottom:6px">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ===== CREDENCIAIS (as suas) =====
      const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      // ===== FONTE (v17.2) =====
      const TABLE  = "vendas_kpi_daily";
      const COL_DT = "dia";

      // ===== UI helpers =====
      const $ = s=>document.querySelector(s);
      const elLog=$("#log"), elURL=$("#urlShow"), elPer=$("#periodoShow");
      const elUni=$("#selUnidade"), elDtDe=$("#dtDe"), elDtAte=$("#dtAte");
      const elPed=$("#k_ped"), elFat=$("#k_fat"), elDes=$("#k_des"), elFre=$("#k_fre");
      const elDPed=$("#d_ped"), elDFat=$("#d_fat"), elDDes=$("#d_des"), elDFre=$("#d_fre");

      function log(m){ elLog.textContent += "\n"+m; elLog.scrollTop = elLog.scrollHeight; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toISO(d){ return d.toISOString().slice(0,10); }
      function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
      function diffDays(a,b){ return Math.round((b-a)/86400000); }
      function fillSelect(el, items){ el.innerHTML=""; for(const it of items){ const o=document.createElement("option"); o.value=it; o.textContent=it; el.appendChild(o);} }

      // ===== Supabase =====
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      elURL.textContent = SUPABASE_URL.replace(/^https?:\/\//,'');

      // ===== Estado =====
      const state = { unidade:"Todas", modo:"bruto", start:addDays(new Date(),-30), end:new Date() };

      // ===== Anti-reentrância (evita “infinito”) =====
      let isLoading = false;

      // ===== Unidades (amplo, sem filtro) =====
      async function loadUnidadesAmplo(){
        try{
          const hoje = new Date();
          const inicio = addDays(hoje, -365);
          const fromISO = toISO(inicio), toISO_ = toISO(hoje);
          const page = 5000; let off=0, todos=[];

          for(;;){
            const r = await supa.from(TABLE)
              .select("unidade")
              .gte(COL_DT, fromISO).lte(COL_DT, toISO_)
              .range(off, off+page-1);
            if(r.error){ log("[ERRO-Unidades] "+r.error.message); break; }
            const rows = r.data||[];
            if(!rows.length) break;
            for(const x of rows){ if(x && x.unidade){ todos.push(String(x.unidade).trim()); } }
            if(rows.length<page) break;
            off += page;
          }
          const uniq = Array.from(new Set(todos)).sort((a,b)=>a.localeCompare(b,"pt-BR"));
          fillSelect(elUni, ["Todas", ...uniq]);
          if(uniq.includes(state.unidade)) elUni.value = state.unidade;
          else { state.unidade="Todas"; elUni.value="Todas"; }
          log("[Unidades] opções: "+JSON.stringify(uniq));
        }catch(e){ log("[ERRO-LoadUnidades] "+(e.message||e)); }
      }

      // ===== Fetch paginado =====
      async function fetchJanela(fromISO, toISO, unidade){
        const selCols="dia,unidade,pedidos,fat,des,fre";
        const page=5000; let off=0, acc=[];
        for(;;){
          let q = supa.from(TABLE).select(selCols).gte(COL_DT, fromISO).lte(COL_DT, toISO).range(off, off+page-1);
          if(unidade && unidade!=="Todas") q = q.eq("unidade", unidade);
          const r = await q;
          if(r.error) throw r.error;
          const rows = r.data||[];
          acc.push(...rows);
          if(rows.length<page) break;
          off+=page;
        }
        return acc;
      }

      // ===== Charts (Chart.js) =====
      let charts = { line:null, week:null };

      function resetCanvas(idWrap, idCanvas){
        const wrap = document.getElementById(idWrap);
        wrap.innerHTML = `<canvas id="${idCanvas}"></canvas>`;
        // CSS já garante width/height via .chartwrap canvas
        return document.getElementById(idCanvas).getContext("2d");
      }

      function drawCharts(rows){
        // ordena
        rows.sort((a,b)=> a.dia < b.dia ? -1 : (a.dia>b.dia?1:0));
        const mode = state.modo;

        // destruir instâncias antigas
        if(charts.line){ charts.line.destroy(); charts.line=null; }
        if(charts.week){ charts.week.destroy(); charts.week=null; }

        // recriar canvases do zero (mata qualquer sobra da lib)
        const ctx1 = resetCanvas("chartLineWrap","chartLine");
        const ctx2 = resetCanvas("chartWeekWrap","chartWeek");

        // linha
        const labels = rows.map(r=>r.dia);
        const values = rows.map(r=> mode==="liquido" ? (Number(r.fat||0)-Number(r.fre||0)) : Number(r.fat||0));

        charts.line = new Chart(ctx1, {
          type:"line",
          data:{ labels, datasets:[{ label:"Receita diária (R$)", data:values, tension:.25 }] },
          options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:"index", intersect:false},
            scales:{ x:{ ticks:{ autoSkip:true, maxRotation:0 } }, y:{ beginAtZero:true } } }
        });

        // semana
        const map = new Map();
        for(const r of rows){
          const dow = new Date(r.dia+"T00:00:00").getDay();
          const v   = mode==="liquido" ? (Number(r.fat||0)-Number(r.fre||0)) : Number(r.fat||0);
          map.set(dow, (map.get(dow)||0)+v);
        }
        const nomes=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
        const wkData=[0,1,2,3,4,5,6].map(i=>map.get(i)||0);

        charts.week = new Chart(ctx2, {
          type:"bar",
          data:{ labels:nomes, datasets:[{ label:"Totais por dia da semana (R$)", data:wkData }] },
          options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
        });
      }

      function setKPIs(rows, rowsPrev){
        const sum=(arr,k)=>arr.reduce((a,x)=>a+Number(x[k]||0),0);
        const pedidos=rows.reduce((a,x)=>a+Number(x.pedidos||0),0);
        const faturamento=sum(rows,"fat"), descontos=sum(rows,"des"), frete=sum(rows,"fre");
        elPed.textContent=fmtInt(pedidos);
        elFat.textContent=fmtBRL(faturamento);
        elDes.textContent=fmtBRL(descontos);
        elFre.textContent=fmtBRL(frete);
        const pedidosPrev=rowsPrev.reduce((a,x)=>a+Number(x.pedidos||0),0);
        const fatPrev=sum(rowsPrev,"fat"), desPrev=sum(rowsPrev,"des"), frePrev=sum(rowsPrev,"fre");
        function deltaTxt(cur,prev,isMoney=true){
          if(prev===0) return "—";
          const pct=((cur-prev)/prev)*100;
          const base=isMoney?fmtBRL(prev):fmtInt(prev);
          return `${pct>=0?"+":""}${pct.toFixed(1)}% vs ant. • ant: ${base}`;
        }
        elDPed.textContent=deltaTxt(pedidos,pedidosPrev,false);
        elDFat.textContent=deltaTxt(faturamento,fatPrev,true);
        elDDes.textContent=deltaTxt(descontos,desPrev,true);
        elDFre.textContent=deltaTxt(frete,frePrev,true);
      }

      async function recarregar(){
        if(isLoading) return; // evita reentrância
        isLoading = true;
        try{
          const fromISO=toISO(state.start), toISO_=toISO(state.end);
          elPer.textContent=`Período: ${fromISO} → ${toISO_}`;
          log(`[Query] ${TABLE} | ${fromISO} → ${toISO_} | UNI=${state.unidade} | modo=${state.modo}`);

          const rows = await fetchJanela(fromISO,toISO_,state.unidade);
          log(`[OK] Linhas (atual): ${rows.length}`);

          // período anterior (mesmo tamanho de janela)
          const dias = diffDays(state.start,state.end)+1;
          const prevEnd = addDays(state.start,-1);
          const prevStart = addDays(prevEnd,-(dias-1));
          const pFrom=toISO(prevStart), pTo=toISO(prevEnd);
          log(`[Query] anterior: ${pFrom} → ${pTo}`);
          const rowsPrev = await fetchJanela(pFrom,pTo,state.unidade);

          setKPIs(rows,rowsPrev);
          drawCharts(rows);
        }catch(e){
          log("[ERRO] "+(e.message||e));
          console.error(e);
        }finally{
          isLoading = false;
        }
      }

      // ===== Eventos =====
      elUni.addEventListener("change", ()=>{ state.unidade=elUni.value; recarregar(); });
      document.querySelectorAll("[data-quick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const n=Number(btn.getAttribute("data-quick"))||30;
          state.end=new Date(); state.start=addDays(state.end,-n);
          elDtDe.value=""; elDtAte.value="";
          recarregar();
        });
      });
      document.getElementById("btnAplicar").addEventListener("click", ()=>{
        const de=elDtDe.value, ate=elDtAte.value;
        if(de && ate){ state.start=new Date(de+"T00:00:00"); state.end=new Date(ate+"T23:59:59"); recarregar(); }
        else{ log("[Warn] Preencha De e Até (datas)."); }
      });
      Array.from(document.getElementsByName("modo")).forEach(r=>{
        r.addEventListener("change", ()=>{ state.modo=r.value; recarregar(); });
      });
      document.getElementById("btnClear").addEventListener("click", ()=>{
        state.unidade="Todas"; elUni.value="Todas";
        state.modo="bruto"; document.querySelector('[name="modo"][value="bruto"]').checked=true;
        state.end=new Date(); state.start=addDays(state.end,-30);
        elDtDe.value=""; elDtAte.value="";
        recarregar();
      });
      document.getElementById("btnReload").addEventListener("click", ()=> recarregar());

      // ===== Boot =====
      (async function boot(){
        log("[Boot] v17.2 — gráficos estáveis (Chart.js) + unidade hotfix + anti-reentrância");
        await loadUnidadesAmplo();              // popula unidades (Todas, Savassi, Raja, …)
        state.end=new Date(); state.start=addDays(state.end,-30);
        await recarregar();                     // 1ª carga
      })();
    </script>
  </body>
</html>
