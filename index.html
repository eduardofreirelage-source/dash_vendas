<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon embutido (evita 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232563eb'/%3E%3Ctext x='32' y='38' font-size='26' text-anchor='middle' fill='%23fff' font-family='Arial'%3EMF%3C/text%3E%3C/svg%3E">
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff;cursor:pointer}
    .pill button.active{background:var(--accent);color:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,button,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    input[type="date"]{padding:7px 10px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    .chartbox{position:relative;height:300px;width:100%}
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{min-width:180px}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .status{font-size:12px}
    .status.ok{color:var(--good)} .status.err{color:var(--bad)}
    .hidden{display:none !important}
    @media (max-width:980px){ .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))} .filters-grid{grid-template-columns:repeat(6,1fr)} .grow{min-width:140px} }
    @media (max-width:560px){ .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr} .filters-grid{grid-template-columns:repeat(4,1fr)} .grow{min-width:120px} }

    /* AUTH */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px;cursor:pointer}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH OVERLAY -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso — Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>

      <div id="authForm">
        <div class="field">
          <label for="authEmail">E-mail</label>
          <input id="authEmail" type="email" autocomplete="email" placeholder="voce@empresa.com" />
        </div>
        <div class="field" id="passRow">
          <label for="authPass">Senha</label>
          <input id="authPass" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
        <div class="field hidden" id="newPassRow">
          <label for="newPass">Nova senha</label>
          <input id="newPass" type="password" autocomplete="new-password" placeholder="Nova senha" />
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <span class="muted" id="forgot" style="cursor:pointer">Esqueci a senha</span>
          <div>
            <button id="btnSignup" style="display:none">Criar conta</button>
            <button id="btnLogin">Entrar</button>
            <button id="btnSaveNew" style="display:none">Salvar nova senha</button>
          </div>
        </div>
        <div class="error" id="authErr"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <div class="topbar">
        <span class="status" id="statusTxt"></span>
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filterbox" id="fx">
      <summary>
        FILTROS
        <span class="muted right" id="limpar" title="Limpar filtros" style="font-weight:400">Limpar</span>
      </summary>
      <div class="body">
        <div class="filters-grid">
          <!-- Linha 1 -->
          <div class="col-6">
            <div class="row">
              <span class="lbl">Unidade</span>
              <select id="uni" class="grow"></select>
            </div>
          </div>
          <div class="col-6">
            <div class="row">
              <span class="lbl">Nome da loja (Top 10)</span>
              <div id="lojas" class="chips"></div>
            </div>
          </div>

          <!-- Linha 2 -->
          <div class="col-3">
            <div class="row">
              <span class="lbl">De</span>
              <input type="date" id="dini" class="grow" />
            </div>
          </div>
          <div class="col-3">
            <div class="row">
              <span class="lbl">Até</span>
              <input type="date" id="dfim" class="grow" />
            </div>
          </div>
          <div class="col-3">
            <div class="row">
              <span class="lbl">Período rápido</span>
              <select id="pr" class="grow">
                <option value="7">Últimos 7</option>
                <option value="15">Últimos 15</option>
                <option value="30" selected>Últimos 30</option>
                <option value="90">Últimos 90</option>
                <option value="180">Últimos 180</option>
                <option value="360">Últimos 360</option>
              </select>
            </div>
          </div>
          <div class="col-3">
            <div class="row">
              <span class="lbl">Turno</span>
              <select id="turno" class="grow" multiple>
                <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
              </select>
            </div>
          </div>

          <!-- Linha 3 -->
          <div class="col-4">
            <div class="row">
              <span class="lbl">Canal de venda</span>
              <select id="canal" class="grow" multiple></select>
            </div>
          </div>
          <div class="col-4">
            <div class="row">
              <span class="lbl">Pagamento</span>
              <select id="pag" class="grow" multiple></select>
            </div>
          </div>
          <div class="col-4">
            <div class="row">
              <span class="lbl">Está cancelado?</span>
              <select id="canc" class="grow">
                <option value="Todos" selected>Todos</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>
          </div>
        </div>
        <div class="hint">Datas limitadas ao último lançamento do banco. Ao aplicar, a caixa se recolhe automaticamente.</div>

        <!-- Import CSV (Admin light) -->
        <div class="row" style="margin-top:8px;justify-content:space-between;flex-wrap:wrap">
          <div>
            <input type="file" id="csvfile" accept=".csv" />
            <button id="btnImport">Importar CSV (incremental)</button>
            <progress id="prog" value="0" max="100" style="display:none"></progress>
          </div>
          <div class="muted" id="impMsg"></div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária — sombra = período anterior</div>
        <div class="pill" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média (7d)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana</div>
        <div class="pill" data-target="dowMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora (0–23)</div>
        <div class="pill" data-target="hourMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
      <div class="muted" style="margin-top:6px">Horas com baixa atividade são ocultadas (proxy &gt; 30min sem venda).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por mês</div>
        <div class="pill" data-target="monMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas (R$)</div>
        <div class="pill" data-target="topMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Supabase =====
  var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });

  // ===== Fonte de dados (tabela preferida; fallback para view) =====
  var SOURCE_PREF = "vendas_kpi_daily_v2_data";
  var SOURCE_FALL = "vendas_kpi_daily_v2";
  var TABLE = null;             // selecionada
  var keyLoja = "Nome da loja"; // detecta automaticamente a grafia usada
  var keyCanal = "Canal de venda";

  // ===== Estado / elementos =====
  var app=document.getElementById("app"), gate=document.getElementById("gate");
  var who=document.getElementById("who"), statusTxt=document.getElementById("statusTxt");
  var uni=document.getElementById("uni"), lojasBox=document.getElementById("lojas");
  var dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  var turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  var periodoTxt=document.getElementById("periodo"), fx=document.getElementById("fx");
  var csvfile=document.getElementById("csvfile"), btnImport=document.getElementById("btnImport"), prog=document.getElementById("prog"), impMsg=document.getElementById("impMsg");

  // AUTH elements
  var tabLogin=document.getElementById("tabLogin"), tabSignup=document.getElementById("tabSignup");
  var authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass");
  var btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup"), btnLogout=document.getElementById("btnLogout");
  var authErr=document.getElementById("authErr"), forgot=document.getElementById("forgot");
  var newPassRow=document.getElementById("newPassRow"), passRow=document.getElementById("passRow"), newPass=document.getElementById("newPass"), btnSaveNew=document.getElementById("btnSaveNew");

  // KPIs
  function setText(id, txt){ var el=document.getElementById(id); if(el) el.textContent = txt; }
  function setDelta(el, cur, prev){ var pct = prev>0 ? ( (cur-prev)/prev*100 ) : 0; var cls = pct>=0 ? "up" : "down"; var arrow = pct>=0 ? "▲" : "▼"; el.className="delta "+cls; el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"% "+arrow; }
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ if(!(d instanceof Date) || isNaN(d)) return null; return d.toISOString().slice(0,10); }
  function parseISO(s){ if(!s) return null; return new Date(s+"T00:00:00Z"); }
  function addDays(d, k){ var t=new Date(d.getTime()); t.setUTCDate(t.getUTCDate()+k); return t; }
  function movingAvg(arr, win){ var out=[], acc=0; for(var i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push(acc / Math.min(i+1,win)); } return out; }
  function avg(a,b){ return b>0 ? a/b : 0; }

  // Charts
  var chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  var lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";
  function destroyChart(c){ if(c){ try{c.destroy();}catch(e){} } return null; }

  // Limites de data
  var minISO=null, maxISO=null;
  var diasSet = new Set();

  // ===== AUTH UI =====
  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }
  tabLogin.addEventListener("click", ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; });
  tabSignup.addEventListener("click", ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; });

  btnLogin.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
    afterLogin();
  });
  btnSignup.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password: pass });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail se necessário.";
  });
  btnLogout.addEventListener("click", async ()=>{ await supa.auth.signOut(); showGate(); });

  // Esqueci senha
  forgot.addEventListener("click", async ()=>{
    const email=(authEmail.value||"").trim();
    if(!email){ authErr.textContent="Digite seu e-mail e clique novamente."; return; }
    const { error } = await supa.auth.resetPasswordForEmail(email, { redirectTo: location.origin + location.pathname });
    authErr.textContent = error ? error.message : "Enviamos o link de redefinição para seu e-mail.";
  });

  // Modo recovery (quando volta do e-mail)
  function checkRecovery(){
    const hash = location.hash||"";
    if(hash.includes("access_token") || (new URLSearchParams(location.search)).get("type")==="recovery"){
      passRow.classList.add("hidden");
      newPassRow.classList.remove("hidden");
      btnLogin.style.display="none"; btnSignup.style.display="none"; btnSaveNew.style.display="inline-block";
      authErr.textContent = "Defina sua nova senha:";
    }
  }
  btnSaveNew.addEventListener("click", async ()=>{
    const np = (newPass.value||"").trim();
    if(!np){ authErr.textContent="Informe a nova senha."; return; }
    const { error } = await supa.auth.updateUser({ password: np });
    authErr.textContent = error ? error.message : "Senha atualizada. Faça login novamente.";
  });

  supa.auth.onAuthStateChange((_e, session)=>{
    if(session){ hideGate(); afterLogin(); } else { showGate(); }
  });

  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    hideGate();
    await pickSource();
    await bootstrap();
  }

  // ===== Fonte: escolher tabela ou view e detectar grafias =====
  async function pickSource(){
    TABLE = null;
    // Tenta tabela
    let r = await supa.from(SOURCE_PREF).select("dia").limit(1);
    if(!r.error){ TABLE = SOURCE_PREF; }
    else{
      let r2 = await supa.from(SOURCE_FALL).select("dia").limit(1);
      if(!r2.error){ TABLE = SOURCE_FALL; }
    }
    if(!TABLE){
      statusTxt.className="status err";
      statusTxt.textContent="Sem dados na fonte.";
      return;
    }
    // Detecta chaves ("Nome da loja" vs "Nome da Loja"; "Canal de venda" já está estável)
    const t = await supa.from(TABLE).select("*").limit(1);
    if(!t.error && t.data && t.data[0]){
      const obj=t.data[0];
      if(!("Nome da loja" in obj) && ("Nome da Loja" in obj)) keyLoja="Nome da Loja";
      keyCanal = ("Canal de venda" in obj) ? "Canal de venda" : Object.keys(obj).find(k=>k.toLowerCase()=="canal de venda") || "Canal de venda";
    }
    statusTxt.className="status ok";
    statusTxt.textContent="Fonte: "+TABLE;
  }

  // ===== Util: coleta tudo (paginado) para colunas específicas =====
  async function fetchPaged(columns, filters){
    var out=[], page=10000, from=0, to=page-1, more=true;
    while(more){
      let q = supa.from(TABLE).select(columns).order("dia",{ascending:true}).range(from,to);
      if(filters && filters.dgte) q = q.gte("dia", filters.dgte);
      if(filters && filters.dlte) q = q.lte("dia", filters.dlte);
      const r = await q;
      if(r.error){ throw r.error; }
      const a=r.data||[];
      out = out.concat(a);
      more = a.length===page;
      from += page; to += page;
    }
    return out;
  }

  async function fetchMinMax(){
    minISO = null; maxISO = null; diasSet = new Set();
    // pega min e max
    let r1 = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    let r2 = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r1.error || r2.error){ throw (r1.error||r2.error); }
    minISO = r1.data?.[0]?.dia || null;
    maxISO = r2.data?.[0]?.dia || null;
    if(minISO && maxISO){
      // popula diasSet (pode ser pesado; mas ajuda a "snap" e validação de datas)
      const all = await fetchPaged("dia", {});
      (all||[]).forEach(x=>diasSet.add(x.dia));
    }
  }
  function snap(iso){
    if(!iso || diasSet.has(iso)) return iso;
    const d = parseISO(iso); if(!d) return null;
    for(let k=1;k<=60;k++){
      const a = toISO(addDays(d, -k)); const b = toISO(addDays(d, k));
      if(diasSet.has(a)) return a;
      if(diasSet.has(b)) return b;
    }
    return null;
  }

  // ===== Construção dos filtros (opções) =====
  async function buildOptions(){
    // Unidades, canais, pagamentos e top 10 lojas no banco todo
    const base = await fetchPaged("*", {}); // busca leve (sem filtros) — robusto p/ grafias
    const setUni=new Set(), setCan=new Set(), setPag=new Set(), sumLoja=new Map();
    base.forEach(r=>{
      if(r.unidade) setUni.add(r.unidade);
      const loja = r[keyLoja]; if(loja){ sumLoja.set(loja, (sumLoja.get(loja)||0) + Number(r.fat||0)); }
      const c = r[keyCanal]; if(c) setCan.add(c);
      if(r.pagamento) setPag.add(r.pagamento);
    });
    // unidades
    uni.innerHTML = ""; ["Todas", ...Array.from(setUni).sort()].forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; uni.appendChild(o); });
    uni.value="Todas";
    // chips lojas (Top 10 por fat)
    lojasBox.innerHTML="";
    const top = Array.from(sumLoja.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
    top.forEach(([name])=>{
      const chip=document.createElement("span"); chip.className="chip"; chip.textContent=name; chip.setAttribute("data-v", name);
      chip.addEventListener("click", ()=>{ chip.classList.toggle("active"); reload(); fx.open=false; });
      lojasBox.appendChild(chip);
    });
    // canal
    canal.innerHTML=""; Array.from(setCan).sort().forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; canal.appendChild(o); });
    // pagamento
    pag.innerHTML=""; Array.from(setPag).sort().forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; pag.appendChild(o); });
  }

  // ===== Carregamento principal =====
  async function bootstrap(){
    try{
      if(!TABLE){ await pickSource(); if(!TABLE) return; }
      await fetchMinMax();
      if(!minISO || !maxISO){
        statusTxt.className="status err"; statusTxt.textContent="Sem dados.";
        return;
      }
      // datas padrão: últimos 30 até maxISO
      const end = parseISO(maxISO); const start = addDays(end, -29);
      dini.value = toISO(start); dfim.value = toISO(end);
      await buildOptions();
      // listeners
      document.getElementById("limpar").addEventListener("click", (e)=>{
        e.preventDefault();
        uni.value="Todas"; dini.value=toISO(start); dfim.value=toISO(end); pr.value="30";
        turno.value=""; canal.value=""; pag.value=""; canc.value="Todos";
        Array.from(lojasBox.children).forEach(c=>c.classList.remove("active"));
        reload();
        fx.open=false;
      });
      [uni,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>{
        el.addEventListener("change", ()=>{ applyQuickDate(); reload(); fx.open=false; });
      });
      // toggles de gráficos
      document.querySelectorAll(".pill").forEach(p=>{
        p.addEventListener("click", (ev)=>{
          const btn = ev.target.closest("button"); if(!btn) return;
          p.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          const target=p.getAttribute("data-target"), val=btn.getAttribute("data-val");
          if(target==="lineMode") lineMode=val;
          if(target==="dowMode") dowMode=val;
          if(target==="dowPedMode") dowPedMode=val;
          if(target==="hourMode") hourMode=val;
          if(target==="monMode") monMode=val;
          if(target==="topMode") topMode=val;
          reload(); // redesenha com o novo modo
        });
      });
      // Import
      btnImport.addEventListener("click", importCSV);

      await reload();
    }catch(e){
      statusTxt.className="status err"; statusTxt.textContent = "Erro ao iniciar.";
    }
  }

  function applyQuickDate(){
    // se o usuário mexeu em "pr", ajusta datas para [maxISO - (pr-1) .. maxISO]
    if(!maxISO) return;
    const days = Number(pr.value||0);
    if(!days) return;
    const end = parseISO(maxISO); const start = addDays(end, -(days-1));
    dini.value = toISO(start); dfim.value = toISO(end);
  }

  function getSelected(el){
    return Array.from(el.selectedOptions||[]).map(o=>o.value);
  }

  // ====== Carga de dados atual (com filtros) ======
  async function reload(){
    try{
      if(!TABLE){ await pickSource(); if(!TABLE) return; }
      // datas
      let sISO = dini.value||minISO, eISO = dfim.value||maxISO;
      if(!sISO) sISO=minISO; if(!eISO) eISO=maxISO;
      sISO = snap(sISO)||sISO; eISO = snap(eISO)||eISO;
      periodoTxt.textContent = "Período: "+(sISO||"—")+" → "+(eISO||"—");

      // Busca apenas por data (robusto a diferenças de grafia). Demais filtros aplico no client.
      const rows = await fetchPaged("*", { dgte:sISO, dlte:eISO });

      // Determina chaves outra vez (se necessário)
      if(rows[0]){
        if(!("Nome da loja" in rows[0]) && ("Nome da Loja" in rows[0])) keyLoja="Nome da Loja";
        if(!("Canal de venda" in rows[0])){ keyCanal = Object.keys(rows[0]).find(k=>k.toLowerCase()=="canal de venda") || keyCanal; }
      }

      // Filtros client-side
      const lojasSel = Array.from(lojasBox.children).filter(c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      const turnosSel = getSelected(turno);
      const canaisSel = getSelected(canal);
      const pagsSel   = getSelected(pag);
      const cancSel   = canc.value||"Todos";
      const uniSel    = uni.value||"Todas";

      const cur = rows.filter(r=>{
        if(uniSel!=="Todas" && r.unidade!==uniSel) return false;
        if(lojasSel.length && !lojasSel.includes(r[keyLoja])) return false;
        if(turnosSel.length && (!r.turno || !turnosSel.includes(r.turno))) return false;
        if(canaisSel.length && (!r[keyCanal] || !canaisSel.includes(r[keyCanal]))) return false;
        if(pagsSel.length && (!r.pagamento || !pagsSel.includes(r.pagamento))) return false;
        if(cancSel!=="Todos" && (r.cancelado||"")!==cancSel) return false;
        return true;
      });

      // Período anterior (mesmo nº de dias)
      const sD = parseISO(sISO), eD = parseISO(eISO);
      const daysLen = Math.max(1, Math.round((eD - sD)/(24*3600*1000))+1);
      const prevEnd = addDays(sD,-1), prevStart = addDays(prevEnd, -(daysLen-1));
      const antRows = await fetchPaged("*", { dgte: toISO(prevStart), dlte: toISO(prevEnd) });
      const ant = antRows.filter(r=>{
        if(uniSel!=="Todas" && r.unidade!==uniSel) return false;
        if(lojasSel.length && !lojasSel.includes(r[keyLoja])) return false;
        if(turnosSel.length && (!r.turno || !turnosSel.includes(r.turno))) return false;
        if(canaisSel.length && (!r[keyCanal] || !canaisSel.includes(r[keyCanal]))) return false;
        if(pagsSel.length && (!r.pagamento || !pagsSel.includes(r.pagamento))) return false;
        if(cancSel!=="Todos" && (r.cancelado||"")!==cancSel) return false;
        return true;
      });

      renderKPIs(cur, ant);
      renderCharts(cur, ant);
    }catch(e){
      statusTxt.className="status err"; statusTxt.textContent="Falha ao carregar.";
    }
  }

  // ===== KPIs =====
  function renderKPIs(cur, ant){
    const sum = (arr,k)=>arr.reduce((s,r)=>s+Number(r[k]||0),0);
    const ped = sum(cur,"pedidos"), fat=sum(cur,"fat"), des=sum(cur,"des"), fre=sum(cur,"fre");
    const pedA=sum(ant,"pedidos"), fatA=sum(ant,"fat"), desA=sum(ant,"des"), freA=sum(ant,"fre");
    const dias = new Set(cur.map(r=>r.dia)).size || 1;
    const diasA= new Set(ant.map(r=>r.dia)).size || 1;

    const tkm = ped>0 ? fat/ped : 0; const tkmA = pedA>0 ? fatA/pedA : 0;
    const fmd = fat/dias;            const fmdA = fatA/diasA;

    const fatL = fat - des - fre - (0.12*fat);
    const fatLA= fatA - desA - freA - (0.12*fatA);
    const desP = fat>0 ? (des/fat*100) : 0;
    const desPA= fatA>0 ? (desA/fatA*100) : 0;
    const freM = ped>0 ? (fre/ped) : 0;
    const freMA= pedA>0 ? (freA/pedA) : 0;
    const fatLP= fat>0 ? (fatL/fat*100) : 0;
    const fatLPA= fatA>0 ? (fatLA/fatA*100) : 0;

    setText("k_ped", fmtInt(ped));
    setText("k_tkm", fmtBRL(tkm));
    setText("k_fat", fmtBRL(fat));
    setText("k_fmd", fmtBRL(fmd));
    setText("k_fatl", fmtBRL(fatL));
    setText("k_fatlp", fatLP.toFixed(1)+"%");
    setText("k_des", fmtBRL(des));
    setText("k_desp", desP.toFixed(1)+"%");
    setText("k_fre", fmtBRL(fre));
    setText("k_frem", fmtBRL(freM));

    setDelta(document.getElementById("d_ped"), ped, pedA);
    setDelta(document.getElementById("d_tkm"), tkm, tkmA);
    setDelta(document.getElementById("d_fat"), fat, fatA);
    setDelta(document.getElementById("d_fmd"), fmd, fmdA);
    setDelta(document.getElementById("d_fatl"), fatL, fatLA);
    setDelta(document.getElementById("d_fatlp"), fatLP, fatLPA);
    setDelta(document.getElementById("d_des"), des, desA);
    setDelta(document.getElementById("d_desp"), desP, desPA);
    setDelta(document.getElementById("d_fre"), fre, freA);
    setDelta(document.getElementById("d_frem"), freM, freMA);
  }

  // ===== Gráficos =====
  function groupBy(arr, keyFn, valFn){
    const m=new Map();
    arr.forEach(r=>{ const k=keyFn(r); m.set(k, (m.get(k)||0)+valFn(r)); });
    const labels=Array.from(m.keys()).sort();
    const values=labels.map(k=>m.get(k));
    return {labels, values};
  }
  function drawLine(labels, curVals, prevVals){
    chartLine = destroyChart(chartLine);
    var ctx=document.getElementById("cLine").getContext("2d");
    var dataCur = curVals.slice();
    var dataMed = movingAvg(curVals, 7);
    var showMed = (lineMode==="media");
    var mainData = showMed? dataMed : dataCur;
    chartLine = new window.Chart(ctx, {
      type:"line",
      data:{ labels: labels, datasets:[
        { data: prevVals, fill:true, borderWidth:0, backgroundColor:"rgba(2,132,199,0.12)", pointRadius:0, tension:0.2 },
        { label: showMed? "Média (7d)" : "Total", data: mainData, borderWidth:2, pointRadius:0, tension:0.2 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }
  function drawBar(canvasId, labels, totals, counts, mode, horizontal){
    var showMed = (mode==="media");
    var vals = showMed ? totals.map((v,i)=> avg(v, counts[i]||1)) : totals.slice();
    var ctx=document.getElementById(canvasId).getContext("2d");
    var cfg = {
      type:"bar",
      data:{ labels:labels, datasets:[{ data:vals }] },
      options:{ indexAxis: horizontal?'y':'x', responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    };
    return new window.Chart(ctx, cfg);
  }

  function renderCharts(cur, ant){
    // Linha diária (fat)
    const byDay = groupBy(cur, r=>r.dia, r=>Number(r.fat||0));
    const byDayPrev = groupBy(ant, r=>r.dia, r=>Number(r.fat||0));
    drawLine(byDay.labels, byDay.values, byDayPrev.values);

    // DOW receita
    (function(){
      const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      const m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
      const diasSet=new Set(cur.map(r=>r.dia));
      Array.from(diasSet).forEach(d=>{ cnt[parseISO(d).getUTCDay()]++; });
      cur.forEach(r=>{ const d=parseISO(r.dia).getUTCDay(); m[d]+=Number(r.fat||0); });
      chartDowFat = destroyChart(chartDowFat);
      chartDowFat = drawBar("cDowFat", lbl, m, cnt, dowMode, false);
    })();

    // DOW pedidos
    (function(){
      const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      const m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
      const diasSet=new Set(cur.map(r=>r.dia));
      Array.from(diasSet).forEach(d=>{ cnt[parseISO(d).getUTCDay()]++; });
      cur.forEach(r=>{ const d=parseISO(r.dia).getUTCDay(); m[d]+=Number(r.pedidos||0); });
      chartDowPed = destroyChart(chartDowPed);
      chartDowPed = drawBar("cDowPed", lbl, m, cnt, dowPedMode, false);
    })();

    // HORA
    (function(){
      const m=Array(24).fill(0), daysByHour=Array(24).fill(0).map(()=>new Set());
      cur.forEach(r=>{
        const h = Number(r.hora); if(isNaN(h) || h<0 || h>23) return;
        m[h]+=Number(r.fat||0); daysByHour[h].add(r.dia);
      });
      const totalDays = new Set(cur.map(r=>r.dia)).size || 1;
      const labels=[], totals=[], counts=[];
      for(let h=0; h<24; h++){
        const active = daysByHour[h].size;
        const keep = active >= Math.ceil(totalDays*0.5) && m[h]>0; // oculta horários pouco ativos
        if(keep){ labels.push(String(h).padStart(2,"0")+":00"); totals.push(m[h]); counts.push(active); }
      }
      chartHour = destroyChart(chartHour);
      chartHour = drawBar("cHour", labels, totals, counts, hourMode, false);
    })();

    // MÊS
    (function(){
      const m=new Map(), cnt=new Map(), daysPerMonth=new Map();
      cur.forEach(r=>{
        const ym = (r.dia||"").slice(0,7);
        m.set(ym, (m.get(ym)||0)+Number(r.fat||0));
        if(!daysPerMonth.has(ym)) daysPerMonth.set(ym, new Set());
        daysPerMonth.get(ym).add(r.dia);
      });
      Array.from(daysPerMonth.keys()).forEach(ym=> cnt.set(ym, daysPerMonth.get(ym).size));
      const labels=Array.from(m.keys()).sort();
      const totals=labels.map(x=>m.get(x)), counts=labels.map(x=>cnt.get(x)||1);
      chartMonth = destroyChart(chartMonth);
      chartMonth = drawBar("cMonth", labels, totals, counts, monMode, false);
    })();

    // TOP 10 LOJAS
    (function(){
      const byLoja=new Map(), days=new Set(cur.map(r=>r.dia)).size||1;
      cur.forEach(r=>{ const n=r[keyLoja]; if(!n) return; byLoja.set(n,(byLoja.get(n)||0)+Number(r.fat||0)); });
      const top = Array.from(byLoja.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const labels=top.map(x=>x[0]), totals=top.map(x=>x[1]), counts=labels.map(_=>days);
      chartTop = destroyChart(chartTop);
      chartTop = drawBar("cTop", labels, totals, counts, topMode, true);
    })();
  }

  // ===== Import CSV (incremental + dedup) =====
  function normKey(s){
    return String(s||"").toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // sem acento
      .replace(/\s+/g," ").trim();
  }
  function toNumber(v){
    if(v===null||v===undefined||v==="") return 0;
    if(typeof v==="number") return v;
    const s=String(v).replace(/\./g,"").replace(",","."); // "1.234,56" -> "1234.56"
    const n=Number(s); return isNaN(n)?0:n;
  }
  function toDateISO(v){
    if(!v) return null;
    const s=String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return m[3]+"-"+m[2]+"-"+m[1];
    return null;
  }

  async function importCSV(){
    const f = csvfile.files?.[0];
    if(!f){ impMsg.textContent="Selecione o arquivo CSV."; return; }
    prog.style.display="inline-block"; prog.value=0; impMsg.textContent="Lendo…";
    // lê como texto para Papa detectar delimitador
    Papa.parse(f, {
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        try{
          const rows=res.data||[];
          if(!rows.length){ impMsg.textContent="Arquivo vazio."; prog.style.display="none"; return; }

          // Mapeia colunas por normalização
          const sample = rows[0]||{};
          const map = {}; Object.keys(sample).forEach(k=> map[normKey(k)] = k);
          function pick(...cands){ for(const c of cands){ const k=map[normKey(c)]; if(k) return k; } return null; }

          const K = {
            dia: pick("dia","data"),
            unidade: pick("unidade"),
            pedidos: pick("pedidos","qtd","quantidade"),
            fat: pick("fat","faturamento","total"),
            des: pick("des","desconto"),
            fre: pick("fre","frete","entrega"),
            loja: pick("nome da loja","nome da Loja","loja","nome_loja"),
            turno: pick("turno"),
            canal: pick("canal de venda","canal"),
            pagamento: pick("pagamento","forma de pagamento","meio de pagamento"),
            cancelado: pick("cancelado"),
            hora: pick("hora")
          };

          if(!K.dia || !K.unidade || !K.fat){
            impMsg.textContent="Nada para importar (colunas obrigatórias não reconhecidas: dia/unidade/fat).";
            prog.style.display="none"; return;
          }

          // Consolida + dedup no próprio arquivo (chave composta)
            // soma pedidos, fat, des, fre
          const acc = new Map();
          rows.forEach(r=>{
            const dia = toDateISO(r[K.dia]); if(!dia) return;
            const unidade = (r[K.unidade]||"").trim(); if(!unidade) return;
            const loja = (K.loja? (r[K.loja]||"").trim() : "") || "";
            const hora = K.hora ? Number(String(r[K.hora]).replace(/\D/g,"")) : -1;
            const canal = K.canal ? (r[K.canal]||"").trim() : "";
            const pagamento = K.pagamento ? (r[K.pagamento]||"").trim() : "";
            const cancelado = K.cancelado ? (String(r[K.cancelado]||"").trim()) : "";

            const pedidos = K.pedidos ? toNumber(r[K.pedidos]) : 0;
            const fat = toNumber(r[K.fat]), des = K.des? toNumber(r[K.des]) : 0, fre = K.fre? toNumber(r[K.fre]) : 0;

            const key = [dia,unidade,loja,hora,pagamento,canal].join("|");
            if(!acc.has(key)) acc.set(key, { dia, unidade, pedidos:0, fat:0, des:0, fre:0, [keyLoja]:loja, turno: (K.turno? (r[K.turno]||"").trim():""), [keyCanal]:canal, pagamento, cancelado, hora:(isNaN(hora)?-1:hora) });
            const o = acc.get(key);
            o.pedidos += pedidos;
            o.fat += fat;
            o.des += des;
            o.fre += fre;
            // se qualquer linha for "Sim", marca como Sim
            if((cancelado||"").toLowerCase().startsWith("s")) o.cancelado="Sim";
          });

          const data = Array.from(acc.values());
          if(!data.length){ impMsg.textContent="Nada para importar (dados inválidos)."; prog.style.display="none"; return; }

          // Divide em lotes e UPSERT com onConflict = chave composta
          const chunk=800; let done=0;
          for(let i=0;i<data.length;i+=chunk){
            const slice = data.slice(i,i+chunk);
            const up = await supa.from(SOURCE_PREF).upsert(slice, {
              onConflict: 'dia,unidade,"'+keyLoja+'",hora,pagamento,"'+keyCanal+'"',
              ignoreDuplicates: false
            });
            if(up.error){ impMsg.textContent="Erro ao inserir: "+up.error.message; prog.style.display="none"; return; }
            done+=slice.length; prog.value = Math.round(done/data.length*100);
          }

          impMsg.textContent="Importado com sucesso.";
          prog.style.display="none";
          await pickSource(); // garante que fonte está ok
          await fetchMinMax(); await buildOptions(); await reload();
          fx.open=false;
        }catch(err){
          impMsg.textContent="Erro: "+(err.message||err);
          prog.style.display="none";
        }
      },
      error: (err)=>{ impMsg.textContent="CSV inválido: "+(err.message||err); prog.style.display="none"; }
    });
  }

  // ===== Início =====
  (async function init(){
    checkRecovery();
    const { data:{ session } } = await supa.auth.getSession();
    if(session){ hideGate(); await pickSource(); await bootstrap(); }
    else { showGate(); }
  })();

})();
</script>
</body>
</html>
