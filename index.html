<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- favicon embutido -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50%" x="50%" dominant-baseline="middle" text-anchor="middle" font-size="48">üçΩÔ∏è</text></svg>'>
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .topbar{display:flex;gap:8px;align-items:center}
    button,select,input{font:inherit;border:1px solid var(--brd);border-radius:10px;background:#fff;padding:8px 10px}
    button{cursor:pointer}
    .ghost{background:#fff}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid{display:grid;gap:12px}
    .cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kpi{position:relative}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)}
    .chartbox{position:relative;height:300px}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff}
    .pill button.active{background:var(--accent);color:#fff}
    details.filterbox{border:1px solid var(--brd);border-radius:14px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;display:flex;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    .filters{padding:12px 14px}
    .fgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    .seg{display:flex;gap:6px;align-items:center}
    .seg .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{min-width:180px;width:100%}
    select[multiple]{height:38px} /* compacto no mobile */
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#eef2ff;border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    @media (max-width:940px){.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))} .fgrid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:560px){.cols-4,.cols-2{grid-template-columns:1fr} .fgrid{grid-template-columns:repeat(4,1fr)}}
    /* Gate (auth) */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:none;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso ‚Äî Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div class="field">
        <label for="authEmail">E-mail</label>
        <input id="authEmail" type="email" placeholder="voce@empresa.com">
      </div>
      <div class="field">
        <label for="authPass">Senha</label>
        <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="field" id="fieldNewPass" style="display:none">
        <label for="authNew">Nova senha</label>
        <input id="authNew" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="error" id="authErr"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="btnForgot" class="ghost">Esqueci a senha</button>
        <button id="btnSignup" style="display:none">Criar conta</button>
        <button id="btnLogin">Entrar</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <h1>Maestro Food</h1>
      <div class="topbar">
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <details class="filterbox" id="fx" open>
      <summary>FILTROS <span class="muted" id="limpar">Limpar</span></summary>
      <div class="filters">
        <div class="fgrid">
          <div class="col-6 seg">
            <span class="lbl">Unidade</span>
            <select id="uni" class="grow"></select>
          </div>
          <div class="col-6 seg">
            <span class="lbl">Nome da loja (Top 10)</span>
            <div id="lojas" class="chips"></div>
          </div>

          <div class="col-3 seg">
            <span class="lbl">De</span>
            <input id="dini" type="date" class="grow">
          </div>
          <div class="col-3 seg">
            <span class="lbl">At√©</span>
            <input id="dfim" type="date" class="grow">
          </div>
          <div class="col-3 seg">
            <span class="lbl">Per√≠odo r√°pido</span>
            <select id="pr" class="grow">
              <option value="7">√öltimos 7</option>
              <option value="15">√öltimos 15</option>
              <option value="30" selected>√öltimos 30</option>
              <option value="90">√öltimos 90</option>
              <option value="180">√öltimos 180</option>
              <option value="360">√öltimos 360</option>
            </select>
          </div>
          <div class="col-3 seg">
            <span class="lbl">Turno</span>
            <select id="turno" class="grow" multiple>
              <option>Manh√£</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>

          <div class="col-4 seg">
            <span class="lbl">Canal de venda</span>
            <select id="canal" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Pagamento</span>
            <select id="pag" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Est√° cancelado?</span>
            <select id="canc" class="grow">
              <option value="Todos" selected>Todos</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div class="col-12 card" style="border-style:dashed">
            <b>Admin</b> ‚Äî Importar CSV (<i>Pasta2.csv</i>)
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <input type="file" id="csvfile" accept=".csv">
              <button id="btnImport">Importar CSV</button>
              <progress id="prog" value="0" max="100" style="display:none;height:10px;width:200px"></progress>
              <span class="muted">Se sua base usa <i>materialized view</i> (<code>vendas_kpi_daily_v2</code>), atualize a MV no banco ap√≥s importar para refletir aqui.</span>
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">‚Äî</div><div class="delta" id="d_ped">‚Äî</div></div>
      <div class="card kpi"><div class="title">Ticket M√©dio</div><div class="val" id="k_tkm">‚Äî</div><div class="delta" id="d_tkm">‚Äî</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">‚Äî</div><div class="delta" id="d_fat">‚Äî</div></div>
      <div class="card kpi"><div class="title">Faturamento M√©dio (dia)</div><div class="val" id="k_fmd">‚Äî</div><div class="delta" id="d_fmd">‚Äî</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">‚Äî</div><div class="delta" id="d_des">‚Äî</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">‚Äî</div><div class="delta" id="d_desp">‚Äî</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">‚Äî</div><div class="delta" id="d_fre">‚Äî</div></div>
      <div class="card kpi"><div class="title">Frete M√©dio</div><div class="val" id="k_frem">‚Äî</div><div class="delta" id="d_frem">‚Äî</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento L√≠quido</div><div class="val" id="k_fatl">‚Äî</div><div class="delta" id="d_fatl">‚Äî</div></div>
      <div class="card kpi"><div class="title">Faturamento L√≠quido %</div><div class="val" id="k_fatlp">‚Äî</div><div class="delta" id="d_fatlp">‚Äî</div></div>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita di√°ria</div>
        <div class="pill" data-target="lineMode"><button data-val="total" class="active">Total</button><button data-val="media">M√©dia (7d)</button></div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
      <div class="muted" style="margin-top:6px">Sombra clara = per√≠odo anterior do mesmo tamanho.</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana</div>
        <div class="pill" data-target="dowMode"><button data-val="total" class="active">Total</button><button data-val="media">M√©dia</button></div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode"><button data-val="total" class="active">Total</button><button data-val="media">M√©dia</button></div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora (0‚Äì23)</div>
        <div class="pill" data-target="hourMode"><button data-val="total" class="active">Total</button><button data-val="media">M√©dia</button></div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
      <div class="muted" style="margin-top:6px">Horas com baixa atividade s√£o ocultadas (proxy >30 min sem venda).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por m√™s</div>
        <div class="pill" data-target="monMode"><button data-val="total" class="active">Total</button><button data-val="media">M√©dia</button></div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas (R$)</div>
        <div class="pill" data-target="topMode"><button data-val="total" class="active">Total</button><button data-val="media">M√©dia</button></div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__=true;

  // ===== Supabase =====
  const SUPABASE_URL="https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE="vendas_kpi_daily_v2";          // leitura
  const STAGING="vendas_kpi_daily_v2_data";    // import CSV

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } });

  // ===== Helpers =====
  const $=id=>document.getElementById(id);
  const toISO=d=>d.toISOString().slice(0,10);
  const parseISO=s=>new Date(s+"T00:00:00Z");
  const addDays=(d,k)=>{const t=new Date(d);t.setUTCDate(t.getUTCDate()+k);return t;}
  const fmtBRL=n=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt=n=>new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const debounce=(fn,wait)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}}
  const movingAvg=(arr,win)=>arr.map((_,i)=>arr.slice(Math.max(0,i-win+1),i+1).reduce((s,v)=>s+v,0)/Math.min(i+1,win));

  // ===== Auth (gate) =====
  const gate=$("gate"), app=$("app"), who=$("who");
  const tabLogin=$("tabLogin"), tabSignup=$("tabSignup"), btnLogin=$("btnLogin"), btnSignup=$("btnSignup");
  const btnForgot=$("btnForgot"), authErr=$("authErr"), authEmail=$("authEmail"), authPass=$("authPass"), authNew=$("authNew"), fieldNewPass=$("fieldNewPass");
  const btnLogout=$("btnLogout");
  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }

  tabLogin.onclick=()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; fieldNewPass.style.display="none"; authErr.textContent=""; }
  tabSignup.onclick=()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; fieldNewPass.style.display="none"; authErr.textContent=""; }

  btnLogin.onclick=async()=>{
    authErr.textContent="";
    const { error }=await supa.auth.signInWithPassword({ email:authEmail.value.trim(), password:authPass.value });
    if(error){ authErr.textContent=error.message; return; }
    afterLogin();
  };
  btnSignup.onclick=async()=>{
    authErr.textContent="";
    const { error }=await supa.auth.signUp({ email:authEmail.value.trim(), password:authPass.value });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail (se necess√°rio).";
  };
  btnForgot.onclick=async()=>{
    authErr.textContent="Enviando e-mail de recupera√ß√£o‚Ä¶";
    const { error }=await supa.auth.resetPasswordForEmail(authEmail.value.trim(), { redirectTo: location.href });
    authErr.textContent = error ? error.message : "E-mail enviado. Siga as instru√ß√µes.";
  };
  btnLogout.onclick=async()=>{ await supa.auth.signOut(); showGate(); };

  supa.auth.onAuthStateChange((e,session)=>{
    if(session){ afterLogin(); } else { showGate(); }
  });
  async function afterLogin(){
    const { data:{user} }=await supa.auth.getUser();
    who.textContent=user?.email||"";
    hideGate();
    boot();
  }

  // ===== Filtros/UI =====
  const selUni=$("uni"), dini=$("dini"), dfim=$("dfim"), pr=$("pr"), turno=$("turno"), canal=$("canal"), pag=$("pag"), canc=$("canc"), lojasBox=$("lojas");
  $("limpar").onclick=(e)=>{ e.preventDefault(); selUni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos"; [...lojasBox.children].forEach(c=>c.classList.remove("active")); recarregarDebounced(); $("fx").open=false; };

  // ===== Data limits =====
  let minISO=null, maxISO=null;
  async function fetchLimites(){
    const r=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO=r.data?.[0]?.dia||null; maxISO=r2.data?.[0]?.dia||null;
    if(minISO&&maxISO){ dini.min=minISO; dfim.min=minISO; dini.max=maxISO; dfim.max=maxISO; }
  }

  async function fetchUnidades(){
    const seen=new Set(["Todas"]); const out=["Todas"];
    const r=await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).limit(10000);
    (r.data||[]).forEach(x=>{const u=(x.unidade||"").trim(); if(u&&!seen.has(u)){ seen.add(u); out.push(u); }});
    return out.length>1?out:["Todas","Uni. Raja","Uni.Savassi"];
  }

  async function fetchPaged(fields,startISO,endISO,uni,lojas,fx){
    let page=1000,off=0,out=[];
    for(;;){
      let q=supa.from(TABLE).select(fields).gte("dia",startISO).lte("dia",endISO).order("dia",{ascending:true}).range(off,off+page-1);
      if(uni && uni!=="Todas") q=q.eq("unidade",uni);
      if(lojas?.length) q=q.in("Nome da Loja",lojas);
      if(fx.turno?.length) q=q.in("turno",fx.turno);
      if(fx.canal?.length) q=q.in("Canal de venda",fx.canal);
      if(fx.pag?.length)   q=q.in("pagamento",fx.pag);
      if(fx.canc && fx.canc!=="Todos") q=q.eq("cancelado", fx.canc==="Sim"?"Sim":"N√£o");
      const r=await q; if(r.error) throw r.error;
      out=out.concat(r.data||[]);
      if(!r.data || r.data.length<page) break;
      off+=page; if(off>500000) break;
    }
    return out;
  }

  function setDelta(el,cur,prev){
    const pct=prev>0?((cur-prev)/prev*100):0; el.className="delta "+(pct>=0?"up":"down");
    el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"% "+(pct>=0?"‚ñ≤":"‚ñº");
  }

  function drawLine(labels,vals,prevVals,mode){
    if(window._line){ window._line.destroy(); }
    const showMed=(mode==="media"); const main=showMed?movingAvg(vals,7):vals;
    window._line=new Chart($("cLine").getContext("2d"),{
      type:"line",
      data:{labels,datasets:[
        {data:prevVals,fill:true,borderWidth:0,backgroundColor:"rgba(59,130,246,.12)",pointRadius:0,tension:.2},
        {data:main,borderWidth:2,pointRadius:0,tension:.2}
      ]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }
  function drawBar(id,labels,totals,counts,mode){
    if(window["_c"+id]){ window["_c"+id].destroy(); }
    const showMed=(mode==="media"); const vals=showMed?totals.map((v,i)=> counts[i]? v/counts[i] : 0):totals;
    window["_c"+id]=new Chart($(id).getContext("2d"),{
      type:"bar", data:{labels,datasets:[{data:vals}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  async function recarregar(){
    if(!maxISO) await fetchLimites();
    const ps=dini.value, pe=dfim.value;
    let s,e;
    if(ps&&pe){ s=parseISO(ps); e=parseISO(pe); } else { e=parseISO(maxISO); s=addDays(e,-(Number(pr.value||30)-1)); dini.value=toISO(s); dfim.value=toISO(e); }
    const startISO=toISO(s), endISO=toISO(e);

    const lojas=[...lojasBox.children].filter(c=>c.classList.contains("active")).map(c=>c.dataset.v);
    const fx={ turno:[...turno.selectedOptions].map(o=>o.value), canal:[...canal.selectedOptions].map(o=>o.value), pag:[...pag.selectedOptions].map(o=>o.value), canc:canc.value };
    const uni=selUni.value||"Todas";

    const fields='dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora';
    const cur=await fetchPaged(fields,startISO,endISO,uni==="Todas"?null:uni,lojas,fx);

    const span=Math.max(1,Math.round((parseISO(endISO)-parseISO(startISO))/(86400000))+1);
    const prevEnd=addDays(parseISO(startISO),-1), prevStart=addDays(prevEnd,-(span-1));
    const ant=await fetchPaged(fields,toISO(prevStart),toISO(prevEnd),uni==="Todas"?null:uni,lojas,fx);

    // Carrega op√ß√µes de Canal/Pag se ainda n√£o veio
    if(canal.options.length===0 || pag.options.length===0){
      const all=await fetchPaged('dia,"Canal de venda",pagamento',minISO||startISO,maxISO||endISO,null,null,{});
      [...new Set((all||[]).map(r=>r["Canal de venda"]).filter(Boolean))].sort().forEach(v=>{ const o=document.createElement("option");o.value=v;o.textContent=v;canal.appendChild(o) });
      [...new Set((all||[]).map(r=>r["pagamento"]).filter(Boolean))].sort().forEach(v=>{ const o=document.createElement("option");o.value=v;o.textContent=v;pag.appendChild(o) });
    }

    // KPIs
    const S=a=>a.reduce((s,r)=>s+Number(r||0),0);
    const ped=S(cur.map(r=>r.pedidos)), pedA=S(ant.map(r=>r.pedidos));
    const fat=S(cur.map(r=>r.fat)), fatA=S(ant.map(r=>r.fat));
    const des=S(cur.map(r=>r.des)), desA=S(ant.map(r=>r.des));
    const fre=S(cur.map(r=>r.fre)), freA=S(ant.map(r=>r.fre));
    const diasCur=new Set(cur.map(r=>r.dia)).size||1, diasAnt=new Set(ant.map(r=>r.dia)).size||1;

    const tkm=ped?fat/ped:0, tkmA=pedA?fatA/pedA:0;
    const fmd=fat/diasCur, fmdA=fatA/diasAnt;
    const fatL=fat-des-fre-(0.12*fat), fatLA=fatA-desA-freA-(0.12*fatA);
    const desP=fat?des/fat*100:0, desPA=fatA?desA/fatA*100:0;
    const freM=ped?fre/ped:0, freMA=pedA?freA/pedA:0;
    const fatLP=fat?fatL/fat*100:0, fatLPA=fatA?fatLA/fatA*100:0;

    $("k_ped").textContent=fmtInt(ped);   setDelta($("d_ped"),ped,pedA);
    $("k_tkm").textContent=fmtBRL(tkm);   setDelta($("d_tkm"),tkm,tkmA);
    $("k_fat").textContent=fmtBRL(fat);   setDelta($("d_fat"),fat,fatA);
    $("k_fmd").textContent=fmtBRL(fmd);   setDelta($("d_fmd"),fmd,fmdA);
    $("k_des").textContent=fmtBRL(des);   setDelta($("d_des"),des,desA);
    $("k_desp").textContent=desP.toFixed(1)+"%"; setDelta($("d_desp"),desP,desPA);
    $("k_fre").textContent=fmtBRL(fre);   setDelta($("d_fre"),fre,freA);
    $("k_frem").textContent=fmtBRL(freM); setDelta($("d_frem"),freM,freMA);
    $("k_fatl").textContent=fmtBRL(fatL); setDelta($("d_fatl"),fatL,fatLA);
    $("k_fatlp").textContent=fatLP.toFixed(1)+"%"; setDelta($("d_fatlp"),fatLP,fatLPA);

    // Linha (com sombra)
    const byDayMap=new Map(), prevMap=new Map();
    cur.forEach(r=>byDayMap.set(r.dia,(byDayMap.get(r.dia)||0)+Number(r.fat||0)));
    ant.forEach(r=>prevMap.set(r.dia,(prevMap.get(r.dia)||0)+Number(r.fat||0)));
    const labels=[...byDayMap.keys()].sort(), vals=labels.map(k=>byDayMap.get(k));
    const prevVals=[...prevMap.keys()].sort().map(k=>prevMap.get(k));
    drawLine(labels,vals,prevVals,window._lineMode||"total");

    // DOW ‚Äî fat
    const dowLbl=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
    const cnt=[0,0,0,0,0,0,0], tot=[0,0,0,0,0,0,0]; new Set(cur.map(r=>r.dia)).forEach(d=>cnt[parseISO(d).getUTCDay()]++);
    cur.forEach(r=>{ tot[parseISO(r.dia).getUTCDay()]+=Number(r.fat||0) });
    drawBar("cDowFat",dowLbl,tot,cnt,window._dowMode||"total");

    // DOW ‚Äî pedidos
    const totP=[0,0,0,0,0,0,0]; cur.forEach(r=>{ totP[parseISO(r.dia).getUTCDay()]+=Number(r.pedidos||0) });
    drawBar("cDowPed",dowLbl,totP,cnt,window._dowPedMode||"total");

    // Hora (remove horas com pouca atividade)
    const hTot=Array(24).fill(0), hDays=Array(24).fill(0).map(()=>new Set());
    cur.forEach(r=>{ if(r.hora!=null){ hTot[+r.hora]+=Number(r.fat||0); hDays[+r.hora].add(r.dia) }});
    const totalDays=new Set(cur.map(r=>r.dia)).size||1;
    const hLbl=[], hVal=[], hCnt=[]; for(let h=0;h<24;h++){ const a=hDays[h].size; if(a>=Math.ceil(totalDays*0.5) && hTot[h]>0){ hLbl.push(String(h).padStart(2,"0")+":00"); hVal.push(hTot[h]); hCnt.push(a); } }
    drawBar("cHour",hLbl,hVal,hCnt,window._hourMode||"total");

    // M√™s
    const mMap=new Map(), mDays=new Map();
    cur.forEach(r=>{ const ym=r.dia.slice(0,7); mMap.set(ym,(mMap.get(ym)||0)+Number(r.fat||0)); if(!mDays.has(ym)) mDays.set(ym,new Set()); mDays.get(ym).add(r.dia); });
    const mLbl=[...mMap.keys()].sort(), mTot=mLbl.map(k=>mMap.get(k)), mCnt=mLbl.map(k=>mDays.get(k)?.size||1);
    drawBar("cMonth",mLbl,mTot,mCnt,window._monMode||"total");

    // Top 10 lojas (+chips)
    const byLoja={}; cur.forEach(r=>{ const n=r["Nome da Loja"]; if(!n) return; byLoja[n]=(byLoja[n]||0)+Number(r.fat||0) });
    const top=Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const tLbl=top.map(x=>x[0]), tTot=top.map(x=>x[1]), tCnt=tLbl.map(_=>diasCur);
    if(window._cTop) window._cTop.destroy();
    window._cTop=new Chart($("cTop").getContext("2d"),{type:"bar",data:{labels:tLbl,datasets:[{data:(window._topMode==="media"?tTot.map((v,i)=>v/tCnt[i]):tTot)}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
    if(lojasBox.children.length===0){ tLbl.forEach(lbl=>{ const chip=document.createElement("span"); chip.className="chip"; chip.textContent=lbl; chip.dataset.v=lbl; chip.onclick=()=>{ chip.classList.toggle("active"); recarregarDebounced(); }; lojasBox.appendChild(chip); }); }
  }
  const recarregarDebounced=debounce(recarregar,120);

  function wirePill(targetVar){
    document.querySelectorAll(`.pill[data-target="${targetVar}"] button`).forEach(btn=>{
      btn.onclick=()=>{ document.querySelectorAll(`.pill[data-target="${targetVar}"] button`).forEach(b=>b.classList.remove("active")); btn.classList.add("active"); window["_"+targetVar]=btn.dataset.val; recarregarDebounced(); };
    });
  }

  async function boot(){
    await fetchLimites();
    const end=parseISO(maxISO), start=addDays(end,-29); dini.value=toISO(start); dfim.value=toISO(end);
    const opts=await fetchUnidades(); selUni.innerHTML=""; opts.forEach(u=>{ const o=document.createElement("option");o.value=u;o.textContent=u; selUni.appendChild(o) }); selUni.value="Todas";
    [selUni,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>el.addEventListener("change",()=>{ $("fx").open=false; recarregarDebounced(); }));
    ["lineMode","dowMode","dowPedMode","hourMode","monMode","topMode"].forEach(wirePill);
    await recarregar();
  }

  // Import CSV (sem DELETE para evitar 400/RLS)
  $("btnImport").onclick=()=>{
    const f=$("csvfile").files?.[0]; if(!f){ alert("Selecione o arquivo Pasta2.csv"); return; }
    const prog=$("prog"); prog.style.display="inline-block"; prog.value=0;
    Papa.parse(f,{header:true,skipEmptyLines:true,complete:async(res)=>{
      const rows=res.data||[]; const chunk=1500; let done=0, ok=true;
      for(let i=0;i<rows.length;i+=chunk){
        const slice=rows.slice(i,i+chunk).map(r=>({
          dia:r.dia, unidade:r.unidade, pedidos:Number(r.pedidos)||0, fat:Number(r.fat)||0, des:Number(r.des)||0, fre:Number(r.fre)||0,
          "Nome da Loja":r["Nome da Loja"], turno:r.turno, "Canal de venda":r["Canal de venda"], pagamento:r.pagamento, cancelado:r.cancelado, hora:(r.hora===""||r.hora==null)?null:Number(r.hora)
        }));
        const ins=await supa.from(STAGING).insert(slice);
        if(ins.error){ ok=false; alert("Erro ao inserir: "+ins.error.message); break; }
        done+=slice.length; prog.value=Math.round(done/rows.length*100);
      }
      prog.style.display="none";
      if(ok){ alert("Import conclu√≠do. Se os dados n√£o aparecerem, atualize a view/materialized view no banco."); await fetchLimites(); await recarregar(); }
    }});
  };

  // init
  (async()=>{ const { data:{session} }=await supa.auth.getSession(); if(session){ afterLogin(); } else { showGate(); } })();

})(); 
</script>
</body>
</html>
