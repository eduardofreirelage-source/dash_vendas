<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pratos & Mapa de Produção</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --ink:#101828; --muted:#667085; --line:#e7e9ee;
      --wine:#7b1e3a; --wine-2:#9a294a; --ok:#059669; --warn:#b45309; --bad:#dc2626;
      --chip:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 14px;font-size:28px}
    h2{margin:0 0 12px;font-size:20px}
    .status{font-size:13px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--bad)}
    .tabs, .subtabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab, .subtab{padding:9px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active, .subtab.active{background:#eef2f6;font-weight:700}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(16,24,40,.05);margin-bottom:14px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
    textarea{min-height:80px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .btn.ghost{background:#f8fafc}
    .btn.small{padding:7px 10px;font-size:13px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .right{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 9px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .pill.ok{border-color:#b7f7d2;background:#ecfdf5;color:#065f46}
    .pill.bad{border-color:#fecaca;background:#fff1f2;color:#991b1b}
    .hint{color:#64748b;font-size:12px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:9px 10px;text-align:left;vertical-align:middle}
    th{background:#f8fafc}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    details.dash{border:1px dashed #cbd5e1;padding:12px;border-radius:12px;background:#fafbff}
    summary{cursor:pointer;font-weight:600}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:12px;min-width:140px}
    .soft{color:#64748b}
    .nowrap{white-space:nowrap}
    @media (max-width:900px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <h1>Pratos & Mapa de Produção</h1>
    <div id="status" class="status">Carregando…</div>
  </div>

  <!-- Abas de nível 1 -->
  <div class="tabs">
    <button class="tab active" data-tab="tab-pratos">Pratos</button>
    <button class="tab" data-tab="tab-producao">Mapa de Produção</button>
  </div>

  <!-- ========================= PRATOS ========================= -->
  <div class="section" id="tab-pratos">
    <!-- Sub-abas -->
    <div class="subtabs">
      <button class="subtab active" data-sub="sub-lista-pratos">Pratos</button>
      <button class="subtab" data-sub="sub-componentes">Componentes de Prato</button>
      <button class="subtab" data-sub="sub-receitas">Receitas</button>
      <button class="subtab" data-sub="sub-ingredientes">Ingredientes</button>
    </div>

    <!-- ---------- Sub: PRATOS ---------- -->
    <div id="sub-lista-pratos" class="subpage">
      <h2>Pratos</h2>
      <div class="grid cols-2">
        <div>
          <input id="pratos-search" placeholder="Buscar prato cadastrado">
        </div>
        <div class="right">
          <button id="btnNovoPrato" class="btn">+ Novo prato</button>
        </div>
      </div>

      <div class="sep"></div>
      <div class="hint">Mostrando até 10 por página</div>
      <div style="overflow:auto">
        <table id="tblPratos">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Receitas</th>
              <th>Ativo</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="flex" id="pratos-pager" style="margin-top:8px">
        <span class="pill" id="pratos-page-info">Página 1/1</span>
        <div class="row-actions">
          <button class="btn small" id="pratos-prev">◀</button>
          <button class="btn small" id="pratos-next">▶</button>
        </div>
      </div>

      <!-- Form de edição/cadastro (fica ABAIXO da lista) -->
      <div class="sep"></div>
      <h2 id="prato-form-title">Editar prato</h2>
      <div class="grid cols-4">
        <div>
          <label>Nome</label>
          <input id="prato-nome" placeholder="Ex.: Strogonoff de frango">
        </div>
        <div>
          <label>Categoria</label>
          <select id="prato-cat">
            <option value="PRATOS" selected>PRATOS</option>
            <option value="ACOMPANHAMENTOS">ACOMPANHAMENTOS</option>
            <option value="BEBIDAS">BEBIDAS</option>
            <option value="SOBREMESA">SOBREMESA</option>
            <option value="PROMOÇÕES">PROMOÇÕES</option>
            <option value="OUTROS">OUTROS</option>
          </select>
        </div>
        <div>
          <label>Peso do prato</label>
          <select id="prato-peso-un">
            <option value="g">g</option><option value="ml">ml</option>
          </select>
          <input id="prato-peso" placeholder="Ex.: 500 (g/ml)" style="margin-top:8px">
        </div>
        <div>
          <label>Preço de venda (fator ou preço)</label>
          <input id="prato-preco" placeholder="Ex.: 3,2 (fator) ou 34,90 (R$)">
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:10px">
        <div>
          <label>Custo do prato (calculado)</label>
          <input id="prato-custo" disabled placeholder="R$ 0,00">
        </div>
        <div>
          <label>Última alteração</label>
          <input id="prato-ultima" disabled placeholder="—">
        </div>
        <div style="align-self:end" class="right">
          <button id="btnSalvarPrato" class="btn pri">Salvar</button>
          <button id="btnCancelarPrato" class="btn">Cancelar</button>
        </div>
      </div>

      <!-- IMPORTAÇÃO do dashboard (colapsável, abaixo de tudo) -->
      <div class="sep"></div>
      <details class="dash" id="dash-import">
        <summary>Pratos do Dashboard (clique para expandir/ocultar)</summary>
        <div class="grid cols-3" style="margin-top:10px">
          <div>
            <label>Categoria (quando disponível na fonte)</label>
            <select id="dash-cat">
              <option value="">Sem categoria</option>
              <option>PRATOS</option>
              <option>ACOMPANHAMENTOS</option>
              <option>BEBIDAS</option>
              <option>SOBREMESA</option>
              <option>PROMOÇÕES</option>
              <option>OUTROS</option>
            </select>
          </div>
          <div>
            <label>Buscar no dashboard</label>
            <input id="dash-search" placeholder="Digite para filtrar…">
          </div>
          <div style="align-self:end" class="right">
            <button id="btnSyncAll" class="btn">Sincronizar todos que faltam</button>
          </div>
        </div>
        <div style="overflow:auto;margin-top:10px">
          <table id="tblDash">
            <thead><tr><th>Prato (dashboard)</th><th>Categoria</th><th>Situação</th><th>Ação</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>
    </div>

    <!-- ---------- Sub: COMPONENTES DO PRATO ---------- -->
    <div id="sub-componentes" class="subpage" style="display:none">
      <h2>Componentes do Prato</h2>
      <div class="grid cols-4">
        <div>
          <label>Selecione o prato</label>
          <select id="cp-prato"></select>
        </div>
        <div>
          <label>Receita</label>
          <select id="cp-receita"></select>
        </div>
        <div>
          <label>Qtd por prato</label>
          <input id="cp-qtd" placeholder="Ex.: 220">
        </div>
        <div>
          <label>Unidade</label>
          <select id="cp-und">
            <option value="g" selected>g</option><option value="ml">ml</option>
            <option value="porcao">porção</option>
          </select>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Observações</label>
          <input id="cp-obs" placeholder="Opcional">
        </div>
        <div style="align-self:end" class="right">
          <button id="btnAddPrComp" class="btn pri">Adicionar Receita ao Prato</button>
          <button id="btnReloadPrComp" class="btn">Recarregar</button>
        </div>
      </div>
      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblPrComp">
          <thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ---------- Sub: RECEITAS ---------- -->
    <div id="sub-receitas" class="subpage" style="display:none">
      <h2>Receitas</h2>

      <div class="grid cols-3">
        <div>
          <label>Nome da receita</label>
          <input id="rec-nome" placeholder="Ex.: Arroz Branco pronto">
        </div>
        <div>
          <label>Rendimento (quantidade)</label>
          <input id="rec-rend-qtd" placeholder="Ex.: 1000">
        </div>
        <div>
          <label>Unidade do rendimento</label>
          <select id="rec-rend-und"><option value="g" selected>g</option><option>kg</option><option>ml</option><option>L</option><option value="porcao">porção</option></select>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div>
          <label>Perda global (%)</label>
          <input id="rec-perda" value="0">
        </div>
        <div>
          <label>Observações</label>
          <input id="rec-obs" placeholder="Opcional">
        </div>
        <div style="align-self:end" class="right">
          <button id="btnSaveRec" class="btn pri">Salvar NOVA Receita + Itens</button>
          <button id="btnUpdateRec" class="btn" style="display:none">Salvar alterações da receita</button>
          <button id="btnCancelRecEdit" class="btn ghost" style="display:none">Cancelar edição</button>
        </div>
      </div>

      <div class="sep"></div>
      <div class="pill" style="font-weight:700">Itens da NOVA receita</div>
      <div class="grid cols-4">
        <div>
          <label>Tipo</label>
          <select id="draft-tipo"><option value="INGREDIENTE" selected>Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
        </div>
        <div>
          <label>Referência</label>
          <select id="draft-ref"></select>
        </div>
        <div>
          <label>Qtd</label>
          <input id="draft-qtd" placeholder="Ex.: 300">
        </div>
        <div>
          <label>Unidade</label>
          <select id="draft-und"><option value="g" selected>g</option><option>kg</option><option value="ml">ml</option><option>L</option><option value="un">un</option></select>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label>Perda da linha (%)</label>
          <input id="draft-perda" value="0">
        </div>
        <div style="align-self:end" class="right">
          <button id="btnDraftAdd" class="btn">Adicionar à grade</button>
          <button id="btnDraftClear" class="btn ghost">Limpar grade</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:8px">
        <table id="tblDraft">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div class="grid cols-2">
        <div>
          <label>Receitas existentes (selecione para editar)</label>
          <select id="ri-receita"></select>
        </div>
        <div style="align-self:end"><span class="pill">Edite o cabeçalho acima e os itens abaixo</span></div>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tblRi">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblRec">
          <thead><tr><th>Nome</th><th>Rendimento</th><th>Perda %</th><th>Itens</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ---------- Sub: INGREDIENTES ---------- -->
    <div id="sub-ingredientes" class="subpage" style="display:none">
      <h2>Ingredientes</h2>
      <div class="grid cols-3">
        <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"></div>
        <div><label>Unidade</label>
          <select id="ing-und"><option>g</option><option selected>kg</option><option>ml</option><option>L</option><option>un</option></select>
        </div>
        <div><label>Custo unitário</label><input id="ing-custo" placeholder="Ex.: 0,0123"></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="cols-2"><label>Observações</label><input id="ing-obs" placeholder="Opcional"></div>
        <div style="align-self:end" class="right">
          <button id="btnSaveIng" class="btn pri">Salvar ingrediente</button>
          <button id="btnCancelIngEdit" class="btn ghost" style="display:none">Cancelar edição</button>
        </div>
      </div>
      <div id="ing-mode-hint" class="hint"></div>

      <div class="sep"></div>
      <div class="grid cols-2">
        <div class="pill">Ingredientes cadastrados</div>
        <div class="right"><input id="ing-search" placeholder="Buscar"></div>
      </div>
      <div style="overflow:auto;margin-top:6px">
        <table id="tblIng">
          <thead><tr><th>Nome</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ========================= MAPA DE PRODUÇÃO ========================= -->
  <div class="section" id="tab-producao" style="display:none">
    <div class="subtabs">
      <button class="subtab active" data-sub="sub-prev">Previsão</button>
      <button class="subtab" data-sub="sub-compras">Compras</button>
    </div>

    <!-- PREVISÃO -->
    <div id="sub-prev" class="subpage">
      <h2>Mapa de Produção – Previsão</h2>
      <div class="grid cols-4">
        <div>
          <label>Período rápido (dias)</label>
          <div class="flex">
            <button class="btn small prd" data-d="7">07</button>
            <button class="btn small prd" data-d="15">15</button>
            <button class="btn small prd" data-d="30">30</button>
            <button class="btn small prd" data-d="60">60</button>
            <button class="btn small prd" data-d="90">90</button>
          </div>
        </div>
        <div>
          <label>Início</label>
          <input id="mp-inicio" type="date">
        </div>
        <div>
          <label>Fim</label>
          <input id="mp-fim" type="date">
        </div>
        <div style="align-self:end" class="right">
          <button id="btnCalcularPrev" class="btn pri">Calcular previsão</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="soft">Pratos considerados</div><div id="kpi-pratos" style="font-weight:700">—</div></div>
        <div class="box"><div class="soft">Receitas consolidadas</div><div id="kpi-rec" style="font-weight:700">—</div></div>
        <div class="box"><div class="soft">Itens por dia</div><div id="kpi-dia" style="font-weight:700">—</div></div>
      </div>

      <div class="sep"></div>
      <h3>Produção diária por Receita (consolidada)</h3>
      <div style="overflow:auto">
        <table id="tblPrev">
          <thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th>Qtd/Semana</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="btnExportPrev" class="btn">Exportar PDF</button>
      </div>
      <div class="hint" id="prev-hint"></div>
    </div>

    <!-- COMPRAS -->
    <div id="sub-compras" class="subpage" style="display:none">
      <h2>Mapa de Produção – Compras</h2>
      <div class="hint">Consolidação automática de ingredientes com base na previsão selecionada.</div>
      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblCompras">
          <thead><tr><th>Ingrediente</th><th>Un</th><th>Qtd total</th><th>Observações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="right" style="margin-top:8px">
        <button id="btnExportCompras" class="btn">Exportar PDF</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ---------- Helpers (definidos ANTES de qualquer uso) ---------- */
const $  = (id)=> document.getElementById(id);
const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
const setStatus = (msg, cls)=>{ const el=$('status'); if(!el) return; el.textContent=msg; el.className='status'+(cls?(' '+cls):''); };
const fmt = (n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
const ptToNumber = (v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
const todayStr = ()=> new Date().toISOString().slice(0,10);
const weekDayPt = (isoDate)=> new Date(isoDate+'T00:00:00').toLocaleDateString('pt-BR',{weekday:'long'});

/* ---------- Supabase ---------- */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---------- Estado ---------- */
let pratos = [];              // cache de pratos
let pratosPage = 1;           // paginação
const PAGE_SIZE = 10;
let pratoEditId = null;

let recEditId = null;
let draftItems = [];

let ingEditId = null;

const DASHBOARD_PRATOS_SOURCE = 'vendas_pratos_pratos'; // coluna esperada: prato; categoria é opcional

/* ---------- Abas nível 1 ---------- */
function switchTab(tabId){
  $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tabId));
  $$('.section').forEach(s=> s.id===tabId ? s.style.display='block' : s.style.display='none');
}
$$('.tab').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));

/* ---------- Sub-abas ---------- */
function switchSub(subId, scopeEl){
  $$('.subtab', scopeEl).forEach(s=> s.classList.toggle('active', s.dataset.sub===subId));
  $$('.subpage', scopeEl.parentElement).forEach(p=> p.id===subId ? p.style.display='block' : p.style.display='none');
}
$$('#tab-pratos .subtab').forEach(b=> b.addEventListener('click', ()=> switchSub(b.dataset.sub, $('tab-pratos'))));
$$('#tab-producao .subtab').forEach(b=> b.addEventListener('click', ()=> switchSub(b.dataset.sub, $('tab-producao'))));

/* ---------- UTIL: Carregar opções em selects ---------- */
async function fillOptionsFrom(table, selectId, valueKey, labelKey, whereEq){
  const sel=$(selectId); if(!sel) return;
  sel.innerHTML='<option value="">Carregando…</option>';
  try{
    let q = supa.from(table).select(`${valueKey},${labelKey}`).order(labelKey,{ascending:true});
    if(whereEq){ Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v)); }
    const { data, error } = await q;
    if(error) throw error;
    sel.innerHTML='';
    (data||[]).forEach(r=>{
      const o=document.createElement('option');
      o.value=r[valueKey]; o.textContent=r[labelKey];
      sel.appendChild(o);
    });
  }catch(e){
    sel.innerHTML='<option value="">(n/d)</option>';
  }
}

/* =================== PRATOS =================== */
function renderPratos(){
  const tbody = $('tblPratos').querySelector('tbody');
  const term = $('pratos-search').value?.toLowerCase().trim() || '';
  const filtered = pratos.filter(p => !term || String(p.nome).toLowerCase().includes(term));
  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  if(pratosPage>totalPages) pratosPage=totalPages;
  const start = (pratosPage-1)*PAGE_SIZE;
  const pageItems = filtered.slice(start, start+PAGE_SIZE);
  tbody.innerHTML='';
  pageItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.nome}</td>
      <td>${p.categoria||'—'}</td>
      <td>${p.receitas ?? '—'}</td>
      <td>${p.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${p.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${p.id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
  $('pratos-page-info').textContent = `Página ${pratosPage}/${totalPages}`;
  $('pratos-prev').disabled = pratosPage<=1;
  $('pratos-next').disabled = pratosPage>=totalPages;
}
$('pratos-prev').addEventListener('click', ()=>{ pratosPage=Math.max(1, pratosPage-1); renderPratos(); });
$('pratos-next').addEventListener('click', ()=>{ pratosPage=pratosPage+1; renderPratos(); });
$('pratos-search').addEventListener('input', ()=>{ pratosPage=1; renderPratos(); });

$('tblPratos').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id, act = btn.dataset.act;
  if(act==='edit'){
    const p = pratos.find(x=> String(x.id)===String(id));
    if(!p) return;
    pratoEditId = p.id;
    $('prato-form-title').textContent = 'Editar prato';
    $('prato-nome').value = p.nome||'';
    $('prato-cat').value  = p.categoria || 'PRATOS';
    $('prato-peso').value = p.peso ?? '';
    $('prato-peso-un').value = p.peso_un || 'g';
    $('prato-preco').value = p.preco_venda ?? '';
    $('prato-custo').value = p.custo ?? '';
    $('prato-ultima').value = p.updated_at ? new Date(p.updated_at).toLocaleString('pt-BR') : '—';
  }else if(act==='toggle'){
    try{
      const p = pratos.find(x=> String(x.id)===String(id));
      const { error } = await supa.from('pratos').update({ ativo: !p.ativo }).eq('id', id);
      if(error) throw error;
      await loadPratos();
    }catch(e){ alert(e.message||e); }
  }else if(act==='del'){
    if(!confirm('Excluir prato?')) return;
    try{
      const { error } = await supa.from('pratos').delete().eq('id', id);
      if(error) throw error;
      await loadPratos();
    }catch(e){ alert(e.message||e); }
  }
});
$('btnNovoPrato').addEventListener('click', ()=>{
  pratoEditId=null;
  $('prato-form-title').textContent='Novo prato';
  $('prato-nome').value='';
  $('prato-cat').value='PRATOS';
  $('prato-peso').value=''; $('prato-peso-un').value='g';
  $('prato-preco').value='';
  $('prato-custo').value=''; $('prato-ultima').value='';
});
$('btnCancelarPrato').addEventListener('click', ()=> $('btnNovoPrato').click());

$('btnSalvarPrato').addEventListener('click', async ()=>{
  const nome=$('prato-nome').value.trim();
  const categoria=$('prato-cat').value;
  const peso=ptToNumber($('prato-peso').value);
  const peso_un=$('prato-peso-un').value;
  const preco_venda=$('prato-preco').value.trim(); // pode ser fator ou preço – armazenar como texto por ora
  if(!nome){ alert('Informe o nome do prato'); return; }
  try{
    if(pratoEditId){
      const { error } = await supa.from('pratos').update({ nome,categoria,peso,peso_un,preco_venda }).eq('id', pratoEditId);
      if(error) throw error;
    }else{
      const { error } = await supa.from('pratos').insert({ nome,categoria,peso,peso_un,preco_venda,ativo:true });
      if(error) throw error;
    }
    await loadPratos();
    setStatus('Prato salvo','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
});

async function loadPratos(){
  try{
    // tenta a view de resumo; se não existir, cai para tabela
    let data=null, error=null;
    ({data, error} = await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true}));
    if(error){ ({data, error} = await supa.from('pratos').select('*').order('nome',{ascending:true})); }
    if(error) throw error;
    pratos = data||[];
    renderPratos();
    await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true});
  }catch(e){
    pratos=[]; renderPratos();
    setStatus('Não foi possível carregar pratos: '+(e.message||e),'err');
  }
}

/* ------- Importar do dashboard ------- */
async function loadDash(){
  const tbody=$('tblDash').querySelector('tbody');
  tbody.innerHTML='<tr><td colspan="4">Carregando…</td></tr>';
  try{
    // tenta com categoria; se der erro, volta só prato
    let dash=null, err=null;
    ({data:dash, error:err} = await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato,categoria'));
    if(err){ ({data:dash, error:err} = await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato')); }
    if(err) throw err;
    const nomesDash = Array.from(new Set((dash||[]).map(r=>r.prato).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    const { data:pr } = await supa.from('pratos').select('id,nome');
    const exist = new Set((pr||[]).map(p=>p.nome));
    const catFilter = $('dash-cat').value?.trim().toUpperCase();
    const term = $('dash-search').value?.toLowerCase().trim()||'';

    tbody.innerHTML='';
    (dash||[]).filter(r=>{
      if(term && !String(r.prato||'').toLowerCase().includes(term)) return false;
      if(catFilter && String(r.categoria||'').toUpperCase()!==catFilter) return false;
      return true;
    }).forEach(r=>{
      const already = exist.has(r.prato);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.prato}</td>
        <td>${r.categoria || '<span class="soft">N/D</span>'}</td>
        <td>${already?'<span class="pill">Já existe</span>':'<span class="pill">Falta importar</span>'}</td>
        <td>${already?'-':`<button class="btn small" data-import="${r.prato.replace(/"/g,'&quot;')}" data-cat="${(r.categoria||'PRATOS').replace(/"/g,'&quot;')}">Importar</button>`}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    tbody.innerHTML='<tr><td colspan="4">Não foi possível ler a fonte do dashboard.</td></tr>';
  }
}
$('dash-cat').addEventListener('change', loadDash);
$('dash-search').addEventListener('input', loadDash);
$('tblDash').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-import]'); if(!btn) return;
  const nome = btn.dataset.import; const categoria = btn.dataset.cat || 'PRATOS';
  try{
    const { error } = await supa.from('pratos').insert({ nome, categoria, ativo:true });
    if(error && !String(error.message||'').includes('duplicate')) throw error;
    await loadPratos(); await loadDash();
  }catch(ex){ alert(ex.message||ex); }
});
$('btnSyncAll').addEventListener('click', async ()=>{
  const btns = $$('button[data-import]', $('tblDash'));
  for(const b of btns){ b.click(); }
});

/* =================== COMPONENTES DO PRATO =================== */
$('btnAddPrComp').addEventListener('click', async ()=>{
  const prato_id = $('cp-prato').value;
  const receita_id = $('cp-receita').value;
  const qtd = ptToNumber($('cp-qtd').value);
  const unidade = $('cp-und').value;
  const obs = $('cp-obs').value.trim() || null;
  if(!prato_id || !receita_id || !qtd){ alert('Selecione prato/receita e informe quantidade'); return; }
  try{
    const { error } = await supa.from('prato_receitas').insert({ prato_id, receita_id, qtd, unidade, obs });
    if(error && !String(error.message||'').includes('duplicate')) throw error;
    $('cp-qtd').value=''; $('cp-obs').value='';
    await loadPratoCompTable();
  }catch(e){ alert(e.message||e); }
});
$('btnReloadPrComp').addEventListener('click', loadPratoCompTable);
$('cp-prato').addEventListener('change', loadPratoCompTable);

async function loadPratoCompTable(){
  const prato_id = $('cp-prato').value;
  const tb = $('tblPrComp').querySelector('tbody');
  tb.innerHTML='';
  if(!prato_id) return;
  try{
    const { data, error } = await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id', prato_id);
    if(error) throw error;
    for(const row of (data||[])){
      const { data: rec } = await supa.from('receitas').select('nome').eq('id', row.receita_id).single();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${rec?.nome||'(removida)'}</td>
        <td>${fmt(row.qtd)}</td>
        <td>${row.unidade}</td>
        <td class="row-actions"><button class="btn small" data-del="${row.id}">Remover</button></td>`;
      tb.appendChild(tr);
    }
  }catch(e){
    tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>';
  }
}
$('tblPrComp').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button[data-del]'); if(!btn) return;
  if(!confirm('Remover receita do prato?')) return;
  try{
    const { error } = await supa.from('prato_receitas').delete().eq('id', btn.dataset.del);
    if(error) throw error;
    await loadPratoCompTable();
  }catch(ex){ alert(ex.message||ex); }
});

/* =================== RECEITAS =================== */
async function refreshDraftRefs(){
  const tipo=$('draft-tipo').value;
  if(tipo==='INGREDIENTE') await fillOptionsFrom('ingredientes','draft-ref','id','nome',{ativo:true});
  else await fillOptionsFrom('receitas','draft-ref','id','nome',{ativo:true});
}
$('draft-tipo').addEventListener('change', refreshDraftRefs);

function renderDraft(){
  const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML='';
  draftItems.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.tipo}</td><td>${it.nome}</td>
      <td>${fmt(it.qtd)}</td><td>${it.unidade}</td><td>${fmt(it.perda_pct)}%</td>
      <td class="row-actions"><button class="btn small" data-rm="${idx}">Remover</button></td>`;
    tb.appendChild(tr);
  });
}
$('tblDraft').addEventListener('click', (e)=>{
  const btn=e.target.closest('button[data-rm]'); if(!btn) return;
  draftItems.splice(+btn.dataset.rm,1); renderDraft();
});
$('btnDraftAdd').addEventListener('click', async ()=>{
  const tipo=$('draft-tipo').value;
  const ref_id=$('draft-ref').value;
  const qtd=ptToNumber($('draft-qtd').value);
  const unidade=$('draft-und').value;
  const perda_pct=ptToNumber($('draft-perda').value);
  if(!ref_id || !qtd){ alert('Selecione a referência e informe a quantidade'); return; }
  let nome=''; 
  if(tipo==='INGREDIENTE'){ const {data}=await supa.from('ingredientes').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; }
  else { const {data}=await supa.from('receitas').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; }
  draftItems.push({tipo,ref_id,nome,qtd,unidade,perda_pct});
  $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft();
});
$('btnDraftClear').addEventListener('click', ()=>{ draftItems=[]; renderDraft(); });

$('btnSaveRec').addEventListener('click', async ()=>{
  const nome=$('rec-nome').value.trim();
  const rendimento_qtd=ptToNumber($('rec-rend-qtd').value);
  const unidade_rendimento=$('rec-rend-und').value;
  const perda_pct=ptToNumber($('rec-perda').value);
  const obs=$('rec-obs').value.trim()||null;
  if(!nome || !rendimento_qtd){ alert('Informe nome e rendimento'); return; }
  try{
    const { data:ins, error } = await supa.from('receitas').insert({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).select('id').single();
    if(error) throw error;
    const receita_id=ins.id;
    if(draftItems.length){
      const payload=draftItems.map(d=>({receita_id,tipo:d.tipo,ref_id:d.ref_id,qtd:d.qtd,unidade:d.unidade,perda_pct:d.perda_pct}));
      const {error:err2}=await supa.from('receita_itens').insert(payload);
      if(err2) alert('Receita salva, erro ao salvar itens: '+(err2.message||err2));
    }
    draftItems=[]; renderDraft();
    $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-perda').value='0'; $('rec-obs').value='';
    await loadReceitas();
    setStatus('Receita salva','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
});

$('btnUpdateRec').addEventListener('click', async ()=>{
  if(!recEditId) return;
  const nome=$('rec-nome').value.trim();
  const rendimento_qtd=ptToNumber($('rec-rend-qtd').value);
  const unidade_rendimento=$('rec-rend-und').value;
  const perda_pct=ptToNumber($('rec-perda').value);
  const obs=$('rec-obs').value.trim()||null;
  if(!nome || !rendimento_qtd){ alert('Informe nome e rendimento'); return; }
  try{
    const { error } = await supa.from('receitas').update({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).eq('id',recEditId);
    if(error) throw error;
    await loadReceitas();
    setStatus('Receita atualizada','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
});
$('btnCancelRecEdit').addEventListener('click', ()=>{
  recEditId=null;
  $('btnSaveRec').style.display='inline-flex';
  $('btnUpdateRec').style.display='none';
  $('btnCancelRecEdit').style.display='none';
  $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-perda').value='0'; $('rec-obs').value='';
});

$('ri-receita').addEventListener('change', loadReceitaItensTable);
$('tblRi').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id, act=btn.dataset.act;
  if(act==='del'){
    if(!confirm('Remover componente?')) return;
    const { error } = await supa.from('receita_itens').delete().eq('id', id);
    if(error){ alert(error.message||error); return; }
    await loadReceitaItensTable();
  }
  if(act==='save-row'){
    const row = Array.from($('tblRi').querySelectorAll(`[data-id="${id}"]`))
      .reduce((acc,el)=>{ acc[el.dataset.k]=el.value; return acc; },{});
    const payload = { qtd:ptToNumber(row.qtd), unidade:row.unidade, perda_pct:ptToNumber(row.perda_pct) };
    const { error } = await supa.from('receita_itens').update(payload).eq('id', id);
    if(error){ alert(error.message||error); return; }
    setStatus('Linha atualizada','ok');
  }
});

async function loadReceitaItensTable(){
  const receitaId = $('ri-receita').value;
  const tb = $('tblRi').querySelector('tbody');
  tb.innerHTML='';
  if(!receitaId) return;
  const { data, error } = await supa.from('receita_itens').select('*').eq('receita_id', receitaId);
  if(error){ tb.innerHTML='<tr><td colspan="6">Erro ao listar itens</td></tr>'; return; }
  for(const it of (data||[]).sort((a,b)=>a.tipo.localeCompare(b.tipo))){
    let nome='—';
    if(it.tipo==='INGREDIENTE'){
      const {data:ing}=await supa.from('ingredientes').select('nome').eq('id', it.ref_id).single();
      nome=ing?.nome||'(ingrediente removido)';
    }else{
      const {data:rec}=await supa.from('receitas').select('nome').eq('id', it.ref_id).single();
      nome=rec?.nome||'(receita removida)';
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.tipo}</td>
      <td>${nome}</td>
      <td><input data-k="qtd" data-id="${it.id}" value="${it.qtd}"></td>
      <td>
        <select data-k="unidade" data-id="${it.id}">
          ${['g','kg','ml','L','un'].map(u=>`<option value="${u}" ${u===it.unidade?'selected':''}>${u}</option>`).join('')}
        </select>
      </td>
      <td><input data-k="perda_pct" data-id="${it.id}" value="${it.perda_pct||0}"></td>
      <td class="row-actions">
        <button class="btn small" data-act="save-row" data-id="${it.id}">Salvar</button>
        <button class="btn small" data-act="del" data-id="${it.id}">Remover</button>
      </td>`;
    tb.appendChild(tr);
  }
}

async function loadReceitas(){
  const tb=$('tblRec').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="6">Carregando…</td></tr>';
  try{
    const { data, error } = await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true});
    if(error) throw error;
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.nome}</td>
        <td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td>
        <td>${fmt(r.perda_pct)}%</td>
        <td>${r.itens}</td>
        <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
    await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true});
    await fillOptionsFrom('receitas','ri-receita','id','nome',{ativo:true});
  }catch(e){
    tb.innerHTML='<tr><td colspan="6">Crie a view v_receitas_resumo</td></tr>';
    await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true});
    await fillOptionsFrom('receitas','ri-receita','id','nome',{ativo:true});
  }
}
$('tblRec').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id, act=btn.dataset.act;
  if(act==='del'){
    if(!confirm('Excluir receita e seus itens?')) return;
    const { error } = await supa.from('receitas').delete().eq('id', id);
    if(error){ alert(error.message||error); return; }
  }else if(act==='toggle'){
    const { data } = await supa.from('receitas').select('ativo').eq('id', id).single();
    const { error } = await supa.from('receitas').update({ ativo: !data.ativo }).eq('id', id);
    if(error){ alert(error.message||error); return; }
  }else if(act==='edit'){
    const { data, error } = await supa.from('receitas').select('*').eq('id', id).single();
    if(error){ alert(error.message||error); return; }
    recEditId=data.id;
    $('rec-nome').value=data.nome||'';
    $('rec-rend-qtd').value=data.rendimento_qtd??'';
    $('rec-rend-und').value=data.unidade_rendimento||'g';
    $('rec-perda').value=data.perda_pct??'0';
    $('rec-obs').value=data.obs||'';
    $('btnSaveRec').style.display='none';
    $('btnUpdateRec').style.display='inline-flex';
    $('btnCancelRecEdit').style.display='inline-flex';
    $('ri-receita').value=String(data.id); $('ri-receita').dispatchEvent(new Event('change'));
  }
});

/* =================== INGREDIENTES =================== */
async function loadIngredientes(){
  const tb=$('tblIng').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="5">Carregando…</td></tr>';
  try{
    const { data, error } = await supa.from('ingredientes').select('*').order('nome',{ascending:true});
    if(error) throw error;
    tb.innerHTML='';
    (data||[]).forEach(row=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${row.nome}</td>
        <td>${row.unidade}</td>
        <td>R$ ${fmt(row.custo_unitario)}</td>
        <td>${row.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-act="edit" data-id="${row.id}">Editar</button>
          <button class="btn small" data-act="toggle" data-id="${row.id}">${row.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-act="del" data-id="${row.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
    await refreshDraftRefs();
  }catch(e){
    tb.innerHTML='<tr><td colspan="5">Erro/Tabela não encontrada: ingredientes</td></tr>';
  }
}
$('tblIng').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id, act=btn.dataset.act;
  if(act==='del'){
    if(!confirm('Excluir ingrediente?')) return;
    const { error } = await supa.from('ingredientes').delete().eq('id', id);
    if(error){ alert(error.message||error); return; }
  }else if(act==='toggle'){
    const { data } = await supa.from('ingredientes').select('ativo').eq('id', id).single();
    const { error } = await supa.from('ingredientes').update({ ativo: !data.ativo }).eq('id', id);
    if(error){ alert(error.message||error); return; }
  }else if(act==='edit'){
    const { data, error } = await supa.from('ingredientes').select('*').eq('id', id).single();
    if(error){ alert(error.message||error); return; }
    ingEditId=data.id;
    $('ing-nome').value=data.nome||''; $('ing-und').value=data.unidade||'kg';
    $('ing-custo').value=data.custo_unitario!=null? String(data.custo_unitario).replace('.',','):'';
    $('ing-obs').value=data.obs||'';
    $('btnCancelIngEdit').style.display='inline-flex'; $('ing-mode-hint').textContent='Editando ingrediente #'+data.id;
    $('btnSaveIng').textContent='Atualizar ingrediente';
  }
  await loadIngredientes();
});
$('btnCancelIngEdit').addEventListener('click', ()=>{
  ingEditId=null; $('ing-nome').value=''; $('ing-custo').value=''; $('ing-obs').value='';
  $('ing-und').value='kg'; $('btnCancelIngEdit').style.display='none'; $('ing-mode-hint').textContent='';
  $('btnSaveIng').textContent='Salvar ingrediente';
});
$('btnSaveIng').addEventListener('click', async ()=>{
  const nome=$('ing-nome').value.trim();
  const unidade=$('ing-und').value;
  const custo=ptToNumber($('ing-custo').value);
  const obs=$('ing-obs').value.trim()||null;
  if(!nome){ alert('Informe o nome do ingrediente'); return; }
  try{
    if(ingEditId){
      const { error } = await supa.from('ingredientes').update({ nome,unidade,custo_unitario:custo,obs }).eq('id', ingEditId);
      if(error) throw error;
    }else{
      const { error } = await supa.from('ingredientes').insert({ nome,unidade,custo_unitario:custo,obs });
      if(error) throw error;
    }
    await loadIngredientes();
    setStatus('Ingrediente salvo','ok');
    $('btnCancelIngEdit').click();
  }catch(e){ setStatus(e.message||e,'err'); }
});

/* =================== MAPA DE PRODUÇÃO (esqueleto) =================== */
$$('.prd').forEach(b=> b.addEventListener('click', ()=>{
  const d=+b.dataset.d;
  const fim=new Date(); const ini=new Date(fim); ini.setDate(fim.getDate()-d+1);
  $('mp-inicio').value=ini.toISOString().slice(0,10);
  $('mp-fim').value=fim.toISOString().slice(0,10);
}));
$('mp-inicio').value = todayStr();
$('mp-fim').value    = todayStr();

$('btnCalcularPrev').addEventListener('click', async ()=>{
  // Aqui virão as queries reais para médias por dia da semana.
  // Por ora, deixamos um placeholder amigável.
  $('kpi-pratos').textContent='—'; $('kpi-rec').textContent='—'; $('kpi-dia').textContent='—';
  const tb=$('tblPrev').querySelector('tbody'); tb.innerHTML='';
  const ini=$('mp-inicio').value, fim=$('mp-fim').value;
  if(!ini||!fim){ alert('Selecione início e fim'); return; }
  $('prev-hint').textContent = `Período selecionado: ${weekDayPt(ini)} (${ini}) → ${weekDayPt(fim)} (${fim}).`;
  // PLACEHOLDER de demonstração
  const demo=[{receita:'Arroz Branco',un:'g',dia:3200,sem:22400},{receita:'Strogonoff de Frango',un:'g',dia:5500,sem:38500}];
  demo.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.receita}</td><td>${r.un}</td><td class="nowrap">${fmt(r.dia)}</td><td class="nowrap">${fmt(r.sem)}</td>`;
    tb.appendChild(tr);
  });
  $('kpi-pratos').textContent='(demo)';
  $('kpi-rec').textContent=demo.length;
  $('kpi-dia').textContent=fmt(demo.reduce((s,x)=>s+x.dia,0));
});
$('btnExportPrev').addEventListener('click', ()=> alert('Exportação para PDF será implementada em seguida.'));
$('btnExportCompras').addEventListener('click', ()=> alert('Exportação para PDF das compras será implementada após a consolidação dos ingredientes da previsão.'));

async function init(){
  try{
    await loadPratos();
    await loadReceitas();
    await loadIngredientes();
    await loadDash();
    await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true});
    await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true});
    setStatus('Pronto','ok');
  }catch(e){
    setStatus(e.message||e,'err');
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
