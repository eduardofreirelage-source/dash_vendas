<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Food Dashboard - FINAL 100% FUNCIONAL</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-indicator {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .status-indicator.success {
            background: rgba(76, 175, 80, 0.8);
        }

        .status-indicator.error {
            background: rgba(244, 67, 54, 0.8);
        }

        .period-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .filters-section {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-info {
            background: #ffc107;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .kpi-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .kpi-comparison {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .comparison-positive {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }

        .comparison-negative {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .comparison-neutral {
            background: rgba(158, 158, 158, 0.1);
            color: #9e9e9e;
        }

        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .import-section {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .import-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 15px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 200px;
        }

        .file-input-label:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .import-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .import-status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .import-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .kpis-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>üçî Maestro Food Dashboard</h1>
            <div class="status-indicators">
                <div class="status-indicator" id="statusSupabase">‚è≥ Conectando...</div>
                <div class="status-indicator" id="statusData">‚è≥ Carregando...</div>
                <div class="status-indicator" id="statusFilters">‚è≥ Preparando...</div>
            </div>
        </div>

        <!-- Period Info -->
        <div class="period-info" id="periodInfo">
            üìÖ Per√≠odo: Carregando... ¬∑ 0 registros
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-grid">
                <!-- Unidade -->
                <div class="filter-group">
                    <label for="filterUnidade">üìç Unidade</label>
                    <select id="filterUnidade">
                        <option value="">Todas</option>
                    </select>
                </div>

                <!-- Nome da Loja -->
                <div class="filter-group">
                    <label for="filterLoja">üè™ Nome da Loja (Top 10)</label>
                    <select id="filterLoja">
                        <option value="">Todos</option>
                    </select>
                </div>

                <!-- Data Inicial -->
                <div class="filter-group">
                    <label for="dataInicial">üìÖ Data Inicial</label>
                    <input type="date" id="dataInicial">
                </div>

                <!-- Data Final -->
                <div class="filter-group">
                    <label for="dataFinal">üìÖ Data Final</label>
                    <input type="date" id="dataFinal">
                </div>

                <!-- Per√≠odo R√°pido -->
                <div class="filter-group">
                    <label for="filterPeriodoRapido">‚ö° Per√≠odo R√°pido</label>
                    <select id="filterPeriodoRapido" onchange="handlePeriodoRapido()">
                        <option value="">Personalizado</option>
                        <option value="hoje">Hoje</option>
                        <option value="ontem">Ontem</option>
                        <option value="ultimos7">√öltimos 7 dias</option>
                        <option value="ultimos30">√öltimos 30 dias</option>
                        <option value="ultimos90">√öltimos 90 dias</option>
                        <option value="anoAtual">Este ano</option>
                    </select>
                </div>

                <!-- Turno -->
                <div class="filter-group">
                    <label for="filterTurno">üåÖ Turno</label>
                    <select id="filterTurno">
                        <option value="">Todos</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                        <option value="Madrugada">Madrugada</option>
                    </select>
                </div>

                <!-- Canal de Venda -->
                <div class="filter-group">
                    <label for="filterCanal">üì± Canal de Venda</label>
                    <select id="filterCanal">
                        <option value="">Todos</option>
                    </select>
                </div>

                <!-- Pagamento -->
                <div class="filter-group">
                    <label for="filterPagamento">üí≥ Pagamento</label>
                    <select id="filterPagamento">
                        <option value="">Todos</option>
                    </select>
                </div>

                <!-- Cancelado -->
                <div class="filter-group">
                    <label for="filterCancelado">‚ùå Cancelado</label>
                    <select id="filterCancelado">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">N√£o</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">üîÑ Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üßπ Limpar</button>
                <button class="btn btn-info" onclick="debugInfo()">üîç Debug</button>
            </div>
        </div>

        <!-- KPIs Grid -->
        <div class="kpis-grid">
            <!-- Pedidos -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üì¶</div>
                    <div class="kpi-title">PEDIDOS</div>
                </div>
                <div class="kpi-value" id="kpiPedidos">-</div>
                <div class="kpi-comparison" id="compPedidos">N/A</div>
            </div>

            <!-- Ticket M√©dio -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-title">TICKET M√âDIO</div>
                </div>
                <div class="kpi-value" id="kpiTicketMedio">R$ -</div>
                <div class="kpi-comparison" id="compTicketMedio">N/A</div>
            </div>

            <!-- Faturamento -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-title">FATURAMENTO</div>
                </div>
                <div class="kpi-value" id="kpiFaturamento">R$ -</div>
                <div class="kpi-comparison" id="compFaturamento">N/A</div>
            </div>

            <!-- Faturamento M√©dio/Dia -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üìà</div>
                    <div class="kpi-title">FATURAMENTO M√âDIO/DIA</div>
                </div>
                <div class="kpi-value" id="kpiFaturamentoDia">R$ -</div>
                <div class="kpi-comparison" id="compFaturamentoDia">N/A</div>
            </div>

            <!-- Incentivos -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üéÅ</div>
                    <div class="kpi-title">INCENTIVOS</div>
                </div>
                <div class="kpi-value" id="kpiIncentivos">R$ -</div>
                <div class="kpi-comparison" id="compIncentivos">N/A</div>
            </div>

            <!-- Incentivos % -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üìä</div>
                    <div class="kpi-title">INCENTIVOS %</div>
                </div>
                <div class="kpi-value" id="kpiIncentivosPercent">-%</div>
                <div class="kpi-comparison" id="compIncentivosPercent">N/A</div>
            </div>

            <!-- Frete -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üöö</div>
                    <div class="kpi-title">FRETE</div>
                </div>
                <div class="kpi-value" id="kpiFrete">R$ -</div>
                <div class="kpi-comparison" id="compFrete">N/A</div>
            </div>

            <!-- Faturamento L√≠quido -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üíé</div>
                    <div class="kpi-title">FATURAMENTO L√çQUIDO</div>
                </div>
                <div class="kpi-value" id="kpiFaturamentoLiquido">R$ -</div>
                <div class="kpi-comparison" id="compFaturamentoLiquido">N/A</div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <div class="chart-title">üìä Receita Di√°ria</div>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <!-- Import Section -->
        <div class="import-section">
            <div class="import-title">üìÅ Importar Dados CSV</div>
            <div style="text-align: center;">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="importCSV()">
                    <label for="csvFile" class="file-input-label">
                        üìÑ Selecionar arquivo CSV
                    </label>
                </div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="import-status" id="importStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Vari√°veis globais
        let allData = [];
        let filteredData = [];
        let chart = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando Maestro Food Dashboard (FINAL 100% FUNCIONAL)...');
            
            try {
                // Testar conex√£o Supabase
                console.log('üîó Testando conex√£o com Supabase...');
                const { data, error } = await supabase.from('vendas_kpi_daily_v2_data').select('*').limit(1);
                
                if (error) {
                    throw new Error(`Falha na conex√£o: ${error.message}`);
                }
                
                console.log('‚úÖ Conex√£o Supabase estabelecida com sucesso');
                updateStatusIndicator('statusSupabase', 'success', '‚úÖ Supabase Conectado');
                
                // Carregar dados
                await loadData();
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                updateStatusIndicator('statusSupabase', 'error', '‚ùå Erro de Conex√£o');
                updateStatusIndicator('statusData', 'error', '‚ùå Sem Dados');
                updateStatusIndicator('statusFilters', 'error', '‚ùå Erro');
            }
        });

        // Atualizar indicador de status
        function updateStatusIndicator(id, type, text) {
            const indicator = document.getElementById(id);
            indicator.textContent = text;
            indicator.className = `status-indicator ${type}`;
        }

        // Carregar dados
        async function loadData() {
            console.log('üìä Carregando dados...');
            
            try {
                allData = [];
                let page = 1;
                const pageSize = 1000;
                
                while (true) {
                    console.log(`üìÑ Carregando p√°gina ${page}...`);
                    
                    const { data, error } = await supabase
                        .from('vendas_kpi_daily_v2_data')
                        .select('*')
                        .range((page - 1) * pageSize, page * pageSize - 1);
                    
                    if (error) {
                        throw new Error(`Erro ao carregar dados: ${error.message}`);
                    }
                    
                    if (!data || data.length === 0) {
                        console.log('üìÑ Fim dos dados');
                        break;
                    }
                    
                    console.log(`‚úÖ P√°gina ${page}: ${data.length} registros`);
                    allData.push(...data);
                    
                    if (data.length < pageSize) {
                        console.log('üìÑ √öltima p√°gina');
                        break;
                    }
                    
                    page++;
                }
                
                if (allData.length === 0) {
                    throw new Error('Sem dados dispon√≠veis');
                }
                
                console.log(`‚úÖ Total de registros carregados: ${allData.length}`);
                
                // Processar dados
                filteredData = [...allData];
                
                // Construir op√ß√µes dos filtros
                console.log('üîß Construindo op√ß√µes dos filtros...');
                buildFilterOptions();
                console.log('‚úÖ Op√ß√µes dos filtros constru√≠das');
                
                // Atualizar status
                updateStatusIndicator('statusData', 'success', `‚úÖ ${allData.length} registros`);
                updateStatusIndicator('statusFilters', 'success', '‚úÖ Dados carregados');
                
                // Calcular per√≠odo e KPIs
                updateStatusIndicators();
                calculateKPIs();
                updateChart();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                updateStatusIndicator('statusData', 'error', '‚ùå Erro ao carregar');
                throw error;
            }
        }

        // Construir op√ß√µes dos filtros
        function buildFilterOptions() {
            // Unidade
            const unidades = [...new Set(allData.map(r => r.unidade).filter(Boolean))];
            populateSelect('filterUnidade', unidades);
            
            // Loja (Top 10 por faturamento)
            const lojasFaturamento = {};
            allData.forEach(record => {
                const loja = record['Nome da loja'];
                if (loja) {
                    lojasFaturamento[loja] = (lojasFaturamento[loja] || 0) + (record.fat || 0);
                }
            });
            
            const topLojas = Object.entries(lojasFaturamento)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([loja]) => loja);
            
            populateSelect('filterLoja', topLojas);
            
            // Canal de Venda
            const canais = [...new Set(allData.map(r => r['Canal de venda']).filter(Boolean))];
            populateSelect('filterCanal', canais);
            
            // Pagamento
            const pagamentos = [...new Set(allData.map(r => r.pagamento).filter(Boolean))];
            populateSelect('filterPagamento', pagamentos);
        }

        // Popular select
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Limpar op√ß√µes existentes (exceto a primeira)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Adicionar novas op√ß√µes
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // Restaurar valor selecionado
            select.value = currentValue;
        }

        // Fun√ß√£o para formatar data no formato YYYY-MM-DD
        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Manipular Per√≠odo R√°pido
        function handlePeriodoRapido() {
            const periodoRapido = document.getElementById('filterPeriodoRapido').value;
            const dataInicialInput = document.getElementById('dataInicial');
            const dataFinalInput = document.getElementById('dataFinal');
            
            if (periodoRapido) {
                const today = new Date();
                let startDate, endDate;
                
                switch (periodoRapido) {
                    case 'hoje':
                        startDate = today;
                        endDate = today;
                        break;
                    case 'ontem':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 1);
                        endDate = startDate;
                        break;
                    case 'ultimos7':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 6);
                        endDate = today;
                        break;
                    case 'ultimos30':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 29);
                        endDate = today;
                        break;
                    case 'ultimos90':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 89);
                        endDate = today;
                        break;
                    case 'anoAtual':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        endDate = today;
                        break;
                    default:
                        startDate = null;
                        endDate = null;
                }
                
                if (startDate && endDate) {
                    dataInicialInput.value = formatDate(startDate);
                    dataFinalInput.value = formatDate(endDate);
                } else {
                    dataInicialInput.value = '';
                    dataFinalInput.value = '';
                }
            } else {
                dataInicialInput.value = '';
                dataFinalInput.value = '';
            }
            
            applyFilters();
        }

        // Aplicar filtros
        function applyFilters() {
            console.log('üîç Aplicando filtros...');
            
            // Obter valores dos filtros
            const unidade = document.getElementById('filterUnidade').value;
            const loja = document.getElementById('filterLoja').value;
            let dataInicial = document.getElementById('dataInicial').value;
            let dataFinal = document.getElementById('dataFinal').value;
            const turno = document.getElementById('filterTurno').value;
            const canal = document.getElementById('filterCanal').value;
            const pagamento = document.getElementById('filterPagamento').value;
            const cancelado = document.getElementById('filterCancelado').value;
            
            // Validar e ajustar datas
            if (dataInicial) {
                const startDate = new Date(dataInicial);
                if (isNaN(startDate.getTime())) {
                    console.error('Data inicial inv√°lida:', dataInicial);
                    dataInicial = null;
                }
            }
            if (dataFinal) {
                const endDate = new Date(dataFinal);
                endDate.setHours(23, 59, 59, 999); // Incluir todo o dia final
                if (isNaN(endDate.getTime())) {
                    console.error('Data final inv√°lida:', dataFinal);
                    dataFinal = null;
                } else {
                    dataFinal = formatDate(endDate);
                }
            }
            
            console.log('üìÖ Filtros aplicados:', { 
                unidade, loja, dataInicial, dataFinal, turno, canal, pagamento, cancelado 
            });
            
            filteredData = allData.filter(record => {
                // Filtro de unidade
                if (unidade && record.unidade !== unidade) return false;
                
                // Filtro de loja
                if (loja && record['Nome da loja'] !== loja) return false;
                
                // Filtros de data
                if (dataInicial && record.dia && record.dia < dataInicial) return false;
                if (dataFinal && record.dia && record.dia > dataFinal) return false;
                
                // Filtro de turno
                if (turno && record.turno !== turno) return false;
                
                // Filtro de canal
                if (canal && record['Canal de venda'] !== canal) return false;
                
                // Filtro de pagamento
                if (pagamento && record.pagamento !== pagamento) return false;
                
                // Filtro de cancelado
                if (cancelado !== '' && record.cancelado.toString() !== cancelado) return false;
                
                return true;
            });
            
            console.log(`‚úÖ Filtros aplicados: ${filteredData.length} registros`);
            
            updateStatusIndicators();
            calculateKPIs();
            updateChart();
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('filterUnidade').value = '';
            document.getElementById('filterLoja').value = '';
            document.getElementById('dataInicial').value = '';
            document.getElementById('dataFinal').value = '';
            document.getElementById('filterPeriodoRapido').value = '';
            document.getElementById('filterTurno').value = '';
            document.getElementById('filterCanal').value = '';
            document.getElementById('filterPagamento').value = '';
            document.getElementById('filterCancelado').value = '';
            
            filteredData = [...allData];
            updateStatusIndicators();
            calculateKPIs();
            updateChart();
        }

        // Calcular KPIs
        function calculateKPIs() {
            if (filteredData.length === 0) {
                // Zerar KPIs se n√£o h√° dados
                document.getElementById('kpiPedidos').textContent = '-';
                document.getElementById('kpiTicketMedio').textContent = 'R$ -';
                document.getElementById('kpiFaturamento').textContent = 'R$ -';
                document.getElementById('kpiFaturamentoDia').textContent = 'R$ -';
                document.getElementById('kpiIncentivos').textContent = 'R$ -';
                document.getElementById('kpiIncentivosPercent').textContent = '-%';
                document.getElementById('kpiFrete').textContent = 'R$ -';
                document.getElementById('kpiFaturamentoLiquido').textContent = 'R$ -';
                
                // Zerar compara√ß√µes
                ['compPedidos', 'compTicketMedio', 'compFaturamento', 'compFaturamentoDia', 
                 'compIncentivos', 'compIncentivosPercent', 'compFrete', 'compFaturamentoLiquido'].forEach(id => {
                    document.getElementById(id).textContent = 'N/A';
                    document.getElementById(id).className = 'kpi-comparison comparison-neutral';
                });
                
                return;
            }
            
            // Calcular KPIs atuais
            const totalPedidos = filteredData.reduce((sum, r) => sum + (r.pedidos || 0), 0);
            const totalFaturamento = filteredData.reduce((sum, r) => sum + (r.fat || 0), 0);
            const totalDesconto = filteredData.reduce((sum, r) => sum + (r.des || 0), 0);
            const totalFrete = filteredData.reduce((sum, r) => sum + (r.fre || 0), 0);
            
            const ticketMedio = totalPedidos > 0 ? totalFaturamento / totalPedidos : 0;
            const faturamentoLiquido = totalFaturamento - totalDesconto;
            const incentivosPercent = totalFaturamento > 0 ? (totalDesconto / totalFaturamento) * 100 : 0;
            
            // Calcular dias √∫nicos
            const diasUnicos = new Set(filteredData.map(r => r.dia)).size;
            const faturamentoDia = diasUnicos > 0 ? totalFaturamento / diasUnicos : 0;
            
            // Atualizar KPIs na interface
            document.getElementById('kpiPedidos').textContent = totalPedidos.toLocaleString('pt-BR');
            document.getElementById('kpiTicketMedio').textContent = `R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('kpiFaturamento').textContent = `R$ ${totalFaturamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('kpiFaturamentoDia').textContent = `R$ ${faturamentoDia.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('kpiIncentivos').textContent = `R$ ${totalDesconto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('kpiIncentivosPercent').textContent = `${incentivosPercent.toFixed(1)}%`;
            document.getElementById('kpiFrete').textContent = `R$ ${totalFrete.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('kpiFaturamentoLiquido').textContent = `R$ ${faturamentoLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            // Calcular comparativos (por enquanto N/A)
            ['compPedidos', 'compTicketMedio', 'compFaturamento', 'compFaturamentoDia', 
             'compIncentivos', 'compIncentivosPercent', 'compFrete', 'compFaturamentoLiquido'].forEach(id => {
                document.getElementById(id).textContent = 'N/A';
                document.getElementById(id).className = 'kpi-comparison comparison-neutral';
            });
        }

        // Atualizar indicadores de status
        function updateStatusIndicators() {
            if (filteredData.length === 0) {
                document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Sem dados ¬∑ 0 registros';
                return;
            }
            
            // Calcular per√≠odo
            const datas = filteredData.map(r => r.dia).filter(Boolean).sort();
            const dataInicial = datas[0];
            const dataFinal = datas[datas.length - 1];
            
            document.getElementById('periodInfo').textContent = 
                `üìÖ Per√≠odo: ${dataInicial} ‚Üí ${dataFinal} ¬∑ ${filteredData.length} registros`;
        }

        // Atualizar gr√°fico
        function updateChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            if (filteredData.length === 0) {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Receita Di√°ria',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
                return;
            }
            
            // Agrupar dados por dia
            const dadosPorDia = {};
            filteredData.forEach(record => {
                const dia = record.dia;
                if (!dadosPorDia[dia]) {
                    dadosPorDia[dia] = 0;
                }
                dadosPorDia[dia] += record.fat || 0;
            });
            
            const labels = Object.keys(dadosPorDia).sort();
            const data = labels.map(dia => dadosPorDia[dia]);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Receita Di√°ria',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fun√ß√£o de debug
        function debugInfo() {
            console.log('üîç DEBUG INFO:');
            console.log('Total de dados:', allData.length);
            console.log('Dados filtrados:', filteredData.length);
            console.log('Primeiros 5 registros:', allData.slice(0, 5));
            
            // Verificar campos de data
            const dataInicial = document.getElementById('dataInicial');
            const dataFinal = document.getElementById('dataFinal');
            
            console.log('Campos de data:');
            console.log('dataInicial:', dataInicial ? dataInicial.value : 'n√£o encontrado');
            console.log('dataFinal:', dataFinal ? dataFinal.value : 'n√£o encontrado');
            
            // Verificar dados do dia 10/08/2025
            const dados10Agosto = allData.filter(r => r.dia === '2025-08-10');
            console.log('Dados do dia 10/08/2025:', dados10Agosto.length, dados10Agosto);
            
            alert(`DEBUG INFO:\n\nTotal de dados: ${allData.length}\nDados filtrados: ${filteredData.length}\nDados 10/08/2025: ${dados10Agosto.length}\n\nVerifique o console para mais detalhes.`);
        }

        // Importar CSV
        async function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo CSV.');
                return;
            }
            
            console.log('üìÅ Iniciando importa√ß√£o do arquivo:', file.name);
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const importStatus = document.getElementById('importStatus');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            importStatus.style.display = 'none';
            
            try {
                let processedCount = 0;
                let errorCount = 0;
                
                Papa.parse(file, {
                    header: true,
                    delimiter: ';',
                    encoding: 'UTF-8',
                    skipEmptyLines: true,
                    chunk: async function(results) {
                        const chunk = results.data;
                        const validRecords = [];
                        
                        chunk.forEach(row => {
                            try {
                                // Mapear campos
                                const record = {
                                    dia: convertDateToBR(row['Data da venda']),
                                    unidade: row['unidade'] || '',
                                    'Nome da loja': row['Nome da loja'] || '',
                                    'Canal de venda': row['Canal de venda'] || '',
                                    pagamento: row['Pagamento'] || '',
                                    cancelado: row['Est√° cancelado'] === 'Sim',
                                    turno: getTurno(row['Data da venda']),
                                    pedidos: 1,
                                    fat: parseFloat(row['Total']?.replace(',', '.')) || 0,
                                    des: parseFloat(row['Desconto']?.replace(',', '.')) || 0,
                                    fre: parseFloat(row['Entrega']?.replace(',', '.')) || 0,
                                    hora: new Date().getHours()
                                };
                                
                                if (record.dia && record.fat > 0) {
                                    validRecords.push(record);
                                }
                            } catch (error) {
                                console.error('Erro ao processar linha:', error);
                                errorCount++;
                            }
                        });
                        
                        if (validRecords.length > 0) {
                            try {
                                const { error } = await supabase
                                    .from('vendas_kpi_daily_v2_data')
                                    .insert(validRecords);
                                
                                if (error) {
                                    console.error('Erro ao inserir lote:', error);
                                    errorCount += validRecords.length;
                                } else {
                                    processedCount += validRecords.length;
                                }
                            } catch (insertError) {
                                console.error('Erro na inser√ß√£o:', insertError);
                                errorCount += validRecords.length;
                            }
                        }
                        
                        // Atualizar progresso
                        const progress = Math.min((processedCount + errorCount) / 1000 * 100, 90);
                        progressFill.style.width = progress + '%';
                    },
                    complete: async function() {
                        progressFill.style.width = '100%';
                        
                        importStatus.style.display = 'block';
                        if (errorCount === 0) {
                            importStatus.className = 'import-status success';
                            importStatus.textContent = `‚úÖ Importa√ß√£o conclu√≠da! ${processedCount} registros importados.`;
                        } else {
                            importStatus.className = 'import-status error';
                            importStatus.textContent = `‚ö†Ô∏è Importa√ß√£o conclu√≠da com avisos. ${processedCount} registros importados, ${errorCount} erros.`;
                        }
                        
                        // Recarregar dados
                        setTimeout(async () => {
                            await loadData();
                        }, 2000);
                    },
                    error: function(error) {
                        console.error('Erro no parsing:', error);
                        importStatus.style.display = 'block';
                        importStatus.className = 'import-status error';
                        importStatus.textContent = `‚ùå Erro na importa√ß√£o: ${error.message}`;
                    }
                });
                
            } catch (error) {
                console.error('Erro na importa√ß√£o:', error);
                importStatus.style.display = 'block';
                importStatus.className = 'import-status error';
                importStatus.textContent = `‚ùå Erro na importa√ß√£o: ${error.message}`;
            }
        }

        // Converter data para formato brasileiro
        function convertDateToBR(dateStr) {
            if (!dateStr) return null;
            
            try {
                let date;
                
                // Tentar parsear como DD/MM/YYYY (com ou sem hora)
                if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(dateStr)) {
                    const match = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (match) {
                        const [, day, month, year] = match;
                        // Validar componentes da data
                        if (parseInt(day) > 31 || parseInt(month) > 12 || parseInt(year) < 2000) {
                            console.error('Data inv√°lida:', dateStr);
                            return null;
                        }
                        // Construir data no formato YYYY-MM-DD
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                }
                
                // Tentar parsear como YYYY-MM-DD
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        // Validar se a data √© v√°lida
                        return dateStr;
                    }
                }
                
                // Tentar parsear com Date
                date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                }
                
                console.error('Formato de data n√£o reconhecido:', dateStr);
                return null;
            } catch (error) {
                console.error('Erro ao converter data:', dateStr, error);
                return null;
            }
        }

        // Obter turno baseado na hora
        function getTurno(dateStr) {
            if (!dateStr) return 'Manh√£';
            
            try {
                const match = dateStr.match(/(\d{1,2}):(\d{2})/);
                if (match) {
                    const hour = parseInt(match[1]);
                    if (hour >= 6 && hour < 12) return 'Manh√£';
                    if (hour >= 12 && hour < 18) return 'Tarde';
                    if (hour >= 18 && hour < 24) return 'Noite';
                    return 'Madrugada';
                }
                return 'Manh√£';
            } catch (error) {
                return 'Manh√£';
            }
        }
    </script>
</body>
</html>
