<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food — KPIs</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="28" fill="%232ea779"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">MF</text></svg>'/>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--text:#0f172a;--acc:#2563eb;--border:#e5e7eb}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1180px;margin:16px auto 64px;padding:0 16px}
  h1{font-size:22px;margin:6px 0 4px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111827}
  .btn{background:var(--acc);border:1px solid var(--acc);color:#fff;cursor:pointer}
  .kpi{display:flex;align-items:flex-end;gap:8px}
  .kpi b{font-size:30px}
  .title{font-size:16px;margin-bottom:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px 10px;text-align:left}
  th{background:#f2f5fa}
  canvas{background:#fff;border:1px solid var(--border);border-radius:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Maestro Food</h1>
  <div class="muted">Período: <span id="periodo">—</span></div>

  <!-- Filtros -->
  <div class="card">
    <div class="row cols-4">
      <div>
        <label>Período rápido</label>
        <select id="quick">
          <option value="30">Últimos 30</option>
          <option value="7">Últimos 7</option>
          <option value="14">Últimos 14</option>
          <option value="mes">Mês atual</option>
          <option value="ano">Ano atual</option>
        </select>
      </div>
      <div>
        <label>De</label>
        <input id="dini" type="date"/>
      </div>
      <div>
        <label>Até</label>
        <input id="dfim" type="date"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnApply" class="btn">Aplicar</button>
      </div>
    </div>

    <div class="row cols-4" style="margin-top:10px">
      <div><label>Unidade</label><input id="unidade" placeholder="ex.: Uni.Raja"/></div>
      <div><label>Nome da loja</label><input id="loja" placeholder="contém…"/></div>
      <div><label>Cancelado?</label>
        <select id="cancelado">
          <option value="">Todos</option>
          <option value="Não">Não</option>
          <option value="Sim">Sim</option>
        </select>
      </div>
      <div><label>Pagamento (exato)</label><input id="pagamento" placeholder="Crédito, Pago Online…"/></div>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <div><label>Canal (exato)</label><input id="canal" placeholder="iFood, Telefone, VideoSoft…"/></div>
      <div class="muted">Fonte: <code>vendas_xlsx</code> · RPCs: <code>kpi_vendas</code>, <code>resumo_vendas</code>, <code>amostra_vendas</code> (dedupe dentro do recorte)</div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row cols-4" style="margin-top:12px">
    <div class="card"><div class="title">Pedidos</div><div class="kpi"><b id="k_ped">0</b></div></div>
    <div class="card"><div class="title">Faturamento</div><div class="kpi"><b id="k_fat">R$ 0,00</b></div></div>
    <div class="card"><div class="title">Ticket Médio</div><div class="kpi"><b id="k_tkt">R$ 0,00</b><span class="muted">(fat/pedidos)</span></div></div>
    <div class="card"><div class="title">Faturamento Líquido</div><div class="kpi"><b id="k_liq">R$ 0,00</b><span class="muted">(fat − des)</span></div></div>
  </div>

  <!-- Resumo do filtro (Bruta × Canônica) -->
  <div class="card" style="margin-top:12px">
    <div class="title">Resumo das linhas filtradas (Bruta × Canônica)</div>
    <table>
      <thead><tr><th>Linhas brutas</th><th>Linhas únicas (dedupe)</th><th>Duplicatas descartadas</th><th>% duplicatas</th></tr></thead>
      <tbody id="tbResumo"><tr><td>—</td><td>—</td><td>—</td><td>—</td></tr></tbody>
    </table>
  </div>

  <!-- Gráfico + amostra -->
  <div class="row cols-2" style="margin-top:12px">
    <div class="card">
      <div class="title">Receita diária</div>
      <canvas id="chart" height="120"></canvas>
      <div class="muted" id="pontos" style="margin-top:4px">Pontos: 0</div>
    </div>
    <div class="card">
      <div class="title">Amostra filtrada (até 10)</div>
      <pre id="amostra">(vazio)</pre>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<script>
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const $ = (id)=>document.getElementById(id);
const quick=$('quick'), dini=$('dini'), dfim=$('dfim'), periodo=$('periodo');
const unidade=$('unidade'), loja=$('loja'), cancelado=$('cancelado'), pagamento=$('pagamento'), canal=$('canal');
const k_ped=$('k_ped'), k_fat=$('k_fat'), k_tkt=$('k_tkt'), k_liq=$('k_liq'), pontos=$('pontos'), amostra=$('amostra');

const brl = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'});
function fmtBRL(n){ return brl.format(n || 0); }
function todayISO(d=new Date()){ d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function addDays(iso, delta){ const d=new Date(iso); d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); }

function applyQuick(){
  const now = todayISO();
  let start, end = now;
  if(quick.value==='mes'){
    const d=new Date(); const y=d.getFullYear(), m=d.getMonth();
    start = new Date(y,m,1).toISOString().slice(0,10);
  }else if(quick.value==='ano'){
    const d=new Date(); const y=d.getFullYear();
    start = new Date(y,0,1).toISOString().slice(0,10);
  }else{
    const n = parseInt(quick.value,10) || 30;
    start = addDays(now, -(n-1));
  }
  dini.value = start; dfim.value = end;
}

let chart;
function renderChart(labels, values){
  if(chart){ chart.destroy(); }
  const ctx = document.getElementById('chart');
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label:'Receita', data: values, tension:0.25 }]},
    options: { responsive:true, scales:{ y:{ ticks:{ callback:v=>brl.format(v).replace('R$','') }}}}
  });
  pontos.textContent = 'Pontos: ' + values.length;
}

function params(){
  const p_dini = dini.value || todayISO();
  const p_dfim = dfim.value || p_dini;
  const p_unids = unidade.value ? [unidade.value] : null;
  const p_canais = canal.value ? [canal.value] : null;
  const p_pags   = pagamento.value ? [pagamento.value] : null;
  const p_loja   = loja.value || null;
  const p_cancelado = cancelado.value || null;
  periodo.textContent = p_dini + ' → ' + p_dfim;
  return { p_dini, p_dfim, p_unids, p_canais, p_pags, p_loja, p_cancelado };
}

async function loadResumo(){
  const args = params();
  const { data, error } = await supa.rpc('resumo_vendas', args);
  const el = document.getElementById('tbResumo');
  if(error){ console.error(error); el.innerHTML = '<tr><td colspan="4">Erro no resumo</td></tr>'; return; }
  const r = (data&&data[0])||{brutas:0,canon:0,duplicatas:0,perc_dup:0};
  el.innerHTML = `<tr>
    <td>${Number(r.brutas||0).toLocaleString('pt-BR')}</td>
    <td>${Number(r.canon||0).toLocaleString('pt-BR')}</td>
    <td>${Number(r.duplicatas||0).toLocaleString('pt-BR')}</td>
    <td>${Number(r.perc_dup||0).toLocaleString('pt-BR')}%</td>
  </tr>`;
}

async function loadAmostra(){
  const args = params();
  const r = await supa.rpc('amostra_vendas', args);
  amostra.textContent = r.error ? JSON.stringify(r.error,null,2) : JSON.stringify(r.data||[],null,2);
}

async function loadKPIs(){
  const args = params();
  const { data, error } = await supa.rpc('kpi_vendas', args);
  if(error){ console.error(error); alert('Erro ao carregar KPIs'); return; }

  let pedidos=0, fat=0, des=0, fre=0;
  const labels=[], values=[];
  (data||[]).forEach(r=>{
    pedidos += Number(r.pedidos||0);
    fat     += Number(r.fat||0);
    des     += Number(r.des||0);
    fre     += Number(r.fre||0);
    labels.push(String(r.dia));
    values.push(Number(r.fat||0));
  });
  const tkt = pedidos>0 ? (fat/pedidos) : 0;
  const liq = fat - des; // se quiser: - fre

  k_ped.textContent = pedidos.toLocaleString('pt-BR');
  k_fat.textContent = fmtBRL(fat);
  k_tkt.textContent = fmtBRL(tkt);
  k_liq.textContent = fmtBRL(liq);

  renderChart(labels, values);
}

async function aplicar(){
  await loadKPIs();
  await loadResumo();
  await loadAmostra();
}

$('btnApply').addEventListener('click', aplicar);
quick.addEventListener('change', ()=>{applyQuick(); aplicar();});

// Inicializa
applyQuick();
aplicar();
</script>
</body>
</html>
