<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Importador XLSX — Maestro</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body{font:14px/1.4 system-ui;background:#0b1220;color:#e5e7eb;margin:0;padding:24px}
  .box{max-width:860px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px}
  h1{margin:0 0 8px;font-size:20px}
  .muted{color:#9ca3af}
  input,button{padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
  button{background:#2563eb;border-color:#2563eb;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #log{white-space:pre-wrap;background:#0b1220;border:1px dashed #374151;border-radius:8px;padding:12px;margin-top:12px;max-height:260px;overflow:auto}
</style>
</head>
<body>
<div class="box">
  <h1>Importador XLSX — Maestro</h1>
  <p class="muted">Envia linhas para <b>public.vendas_xlsx</b>. O banco deriva <i>dia/hora/minuto/turno</i> do <i>ts_venda</i> (ou de "Data da venda").</p>
  <div class="row" style="margin-top:8px">
    <input id="file" type="file" accept=".xlsx,.xls"/>
    <button id="go">Importar</button>
  </div>
  <div id="log"></div>
</div>

<script>
const SUPABASE_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const log = (m)=>{ const el=document.getElementById('log'); el.textContent += m + "\n"; el.scrollTop=el.scrollHeight; };

function parseBrToISOts(s){
  if(!s) return null;
  s = String(s).trim().replace(/\s+/g,' ');
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m) return `${m[1]}-${m[2]}-${m[3]} ${m[4]||'00'}:${m[5]||'00'}:${m[6]||'00'}`;
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){
    const dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0'), yy = m[3];
    const hh = (m[4]||'00').padStart(2,'0'), mi=(m[5]||'00').padStart(2,'0'), ss=(m[6]||'00').padStart(2,'0');
    return `${yy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }
  return null;
}

document.getElementById('go').onclick = async ()=>{
  const f = document.getElementById('file').files[0];
  if(!f){ log("Selecione um .xlsx"); return; }
  log(`Lendo planilha: ${f.name}`);

  const data = await f.arrayBuffer();
  const wb = XLSX.read(data, { type:'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  let rows = XLSX.utils.sheet_to_json(ws, { defval:null, raw:false });

  log(`Linhas na planilha: ${rows.length}`);

  // Mapeia colunas esperadas
  const map = (obj, k)=> Object.keys(obj).find(h => h.toLowerCase().trim() === k.toLowerCase());
  const mData     = map(rows[0]||{}, 'Data da venda');
  const mUnidade  = map(rows[0]||{}, 'unidade') || map(rows[0]||{}, 'Código da loja');
  const mLoja     = map(rows[0]||{}, 'Nome da loja');
  const mCanal    = map(rows[0]||{}, 'Canal de venda');
  const mPag      = map(rows[0]||{}, 'Pagamento');
  const mCancel   = map(rows[0]||{}, 'Está cancelado');
  const mTotal    = map(rows[0]||{}, 'Total');
  const mDes      = map(rows[0]||{}, 'Desconto');
  const mFre      = map(rows[0]||{}, 'Entrega');

  let ok=0, bad=0;
  const batch=500;
  for(let i=0;i<rows.length;i+=batch){
    const slice = rows.slice(i,i+batch).map(r=>{
      const dataTxt = mData ? r[mData] : null;
      const isoTs   = parseBrToISOts(dataTxt);
      if(!isoTs) { bad++; return null; }
      return {
        ts_venda: isoTs,                                  // canônico
        "Data da venda": dataTxt,                         // guarda original (se sua tabela tiver essa coluna)
        unidade: r[mUnidade] || null,
        "Nome da loja": r[mLoja] || null,
        "Canal de venda": r[mCanal] || null,
        pagamento: r[mPag] || null,
        cancelado: (String(r[mCancel]||'').trim().toLowerCase() in {'s':1,'sim':1,'true':1,'1':1}) ? 'Sim' : 'Não',
        fat: Number(String(r[mTotal]||'0').replace('.','').replace(',','.'))||0,
        des: Number(String(r[mDes]  ||'0').replace('.','').replace(',','.'))||0,
        fre: Number(String(r[mFre]  ||'0').replace('.','').replace(',','.'))||0,
        pedidos: 1
      };
    }).filter(Boolean);

    if(!slice.length){ continue; }
    const { error } = await supa.from('vendas_xlsx').insert(slice);
    if(error){ log(`Erro batch ${i}-${i+slice.length}: ${error.message}`); bad += slice.length; }
    else { ok += slice.length; log(`OK ${ok} (erros acumulados: ${bad})`); }
  }

  log(`Importação concluída. OK=${ok}, ERROS=${bad}`);
};
</script>
</body>
</html>
