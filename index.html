<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maestro Food</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#667085;--text:#0f172a;--blue:#1a73e8;--stroke:#e6eaf2;--radius:14px}
    body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .container{max-width:1200px;margin:24px auto 64px;padding:0 16px}
    h1{font-size:24px;font-weight:700;margin:6px 0 0}
    small.muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:14px}
    .card.dashed{border-style:dashed}
    summary{cursor:pointer}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{appearance:none;border:1px solid var(--stroke);background:#fff;color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    select[multiple]{height:140px}
    .inline{display:flex;gap:10px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#eef3ff;color:#1747b7}
    .grid-kpi{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .kpi h3{font-size:12px;color:var(--muted);margin:0 0 8px}
    .kpi b{font-size:22px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef3ff;color:#1747b7;font-weight:600}
    .right{text-align:right}
    .hint{color:var(--muted);font-size:12px}
    #srcInfo{font-weight:700}
    #srcInfo.ok{color:#0f974d}
    #srcInfo.err{color:#c0392b}
    #importStatus{font-size:12px}
    @media (max-width:960px){.grid-kpi{grid-template-columns:repeat(2,1fr)}.cols-4,.cols-3,.cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Maestro Food</h1>
    <div class="inline" style="justify-content:space-between;margin-top:4px;">
      <small id="periodo" class="muted">Período: —</small>
      <small id="srcInfo" class="muted">Fonte: —</small>
    </div>

    <details id="fx" class="card" open>
      <summary class="inline" style="justify-content:space-between;">
        <b>FILTROS</b>
        <button id="btnLimpar" class="btn ghost" type="button">Limpar</button>
      </summary>

      <div class="row cols-2" style="margin-top:12px;">
        <div><label>Unidade</label><select id="fUnidade"></select></div>
        <div><label>Nome da loja</label><select id="fLoja"></select></div>
      </div>

      <div class="row cols-4" style="margin-top:8px;">
        <div><label>De</label><input id="fDini" type="date"/></div>
        <div><label>Até</label><input id="fDfim" type="date"/></div>
        <div>
          <label>Período rápido</label>
          <select id="fQuick">
            <option>Últimos 30</option>
            <option>Últimos 60</option>
            <option selected>Últimos 90</option>
            <option>Este mês</option>
            <option>Último mês</option>
            <option>Este ano</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="fTurno" multiple>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px;">
        <div><label>Canal de venda</label><select id="fCanal" multiple></select></div>
        <div><label>Pagamento</label><select id="fPag" multiple></select></div>
        <div>
          <label>Está cancelado?</label>
          <select id="fCanc"><option>Todos</option><option>Não</option><option>Sim</option></select>
        </div>
      </div>

      <div class="card dashed" style="margin-top:12px;">
        <div class="row cols-2">
          <div class="inline"><label style="margin:0;">Admin — Importar CSV (<b>Pasta2.csv</b>)</label></div>
          <div class="right"><span id="importStatus" class="muted"></span></div>
        </div>
        <div class="inline" style="margin-top:8px;">
          <input id="csv" type="file" accept=".csv,text/csv"/>
          <button id="btnImport" class="btn" type="button">Importar CSV (incremental)</button>
        </div>
        <p class="hint" style="margin-top:8px;">
          Importação somativa com <b>deduplicação por chave</b> (dia, unidade, "Nome da loja", hora, pagamento, "Canal de venda").  
          Obrigatório no CSV: <b>Data da venda</b> (dia) • <b>unidade</b> • <b>Total</b> (fat). Aceita “Entrega”, “Desconto”, etc.
        </p>
      </div>
    </details>

    <div class="grid-kpi" style="margin-top:14px;">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
      <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
      <div class="card kpi"><h3>Faturamento Médio (dia)</h3><b id="kFatDia">—</b></div>
      <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
      <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
      <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
      <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="inline" style="justify-content:space-between;">
        <b>Receita diária (R$)</b>
        <div class="inline"><span class="pill">Total</span></div>
      </div>
      <div style="height:220px;margin-top:8px;"><canvas id="chart"></canvas></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
  (function(){
    // ====== CONFIG ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const TABLE         = "vendas_kpi_daily_v2_data";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:true,autoRefreshToken:true}});

    // ====== DOM ======
    const $ = (id)=>document.getElementById(id);
    const periodoEl=$("periodo"), srcInfo=$("srcInfo"), fx=$("fx");
    const uni=$("fUnidade"), loja=$("fLoja"), dini=$("fDini"), dfim=$("fDfim"),
          pr=$("fQuick"), turno=$("fTurno"), canal=$("fCanal"), pag=$("fPag"), canc=$("fCanc");
    const btnLimpar=$("btnLimpar"), csv=$("csv"), btnImport=$("btnImport"), importStatus=$("importStatus");
    const kPedidos=$("kPedidos"), kTicket=$("kTicket"), kFat=$("kFat"), kFatDia=$("kFatDia"),
          kDes=$("kDes"), kDesPct=$("kDesPct"), kFre=$("kFre"), kFatLiq=$("kFatLiq");
    const chartEl=$("chart"); let chart;

    // ====== STATE / UTILS ======
    let minISO=null, maxISO=null, totalLinhas=0;
    const fmtBRL=(v)=> (isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—");
    const fmtPct=(v)=> (isFinite(v)? (v*100).toFixed(1).replace('.',',')+'%' : "—");
    const onlyDate=(iso)=> iso && iso.slice ? iso.slice(0,10) : null;
    const parseBR=(x)=>{ if(x==null||x==='')return 0; if(typeof x==='number')return x; const s=String(x).trim().replace(/\./g,'').replace(',','.'); const n=Number(s); return isFinite(n)?n:0; };
    const norm=(s)=> String(s??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    const normCancel=(v)=>{const s=String(v??"").trim().toLowerCase(); if(v===true||s==="sim"||s==="s"||s==="1"||s==="true")return"Sim"; return"Não";};
    const stripBOM=(h)=> h.replace(/^\uFEFF/,'');

    function ddmmyyyyToISO(s){
      if(!s) return null; s=String(s).trim();
      const [datePart,timePart]=s.split(' ');
      const [d,m,y]=(datePart||'').split('/');
      const di=+d, mi=+m, yi=+y;
      if(!di||!mi||!yi||mi<1||mi>12||di<1||di>31||yi<1900||yi>2100) return null;
      const iso=`${String(yi).padStart(4,'0')}-${String(mi).padStart(2,'0')}-${String(di).padStart(2,'0')}`;
      const test=new Date(iso); if(isNaN(test)) return null;
      return iso + (timePart? 'T'+timePart+':00':'T00:00:00');
    }
    function hourFromDateText(s){ const str=String(s??''); const parts=str.split(' '); if(parts[1]&&parts[1].includes(':')){ const [hh]=parts[1].split(':'); const h=parseInt(hh,10); return isFinite(h)?h:-1 } return -1 }
    function applyQuickDate(){
      const opt=pr.value; const end=new Date(); let start;
      if(opt.startsWith("Últimos ")){ const n=parseInt(opt.split(' ')[1],10); start=new Date(); start.setDate(end.getDate()-(n-1)); }
      else if(opt==="Este mês"){ start=new Date(end.getFullYear(),end.getMonth(),1); }
      else if(opt==="Último mês"){ start=new Date(end.getFullYear(),end.getMonth()-1,1); const e=new Date(end.getFullYear(),end.getMonth(),0); dini.value=e?e:null; }
      else if(opt==="Este ano"){ start=new Date(end.getFullYear(),0,1); }
      else { start=new Date(end.getFullYear(),end.getMonth(),end.getDate()-29); }
      dini.value = new Date(start).toISOString().slice(0,10);
      dfim.value = new Date(end).toISOString().slice(0,10);
    }

    // ====== Fonte / opções ======
    async function fetchMinMax(){
      const a=await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
      const b=await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
      if(!a.error && a.data?.length && !b.error && b.data?.length){
        minISO=onlyDate(a.data[0].dia); maxISO=onlyDate(b.data[0].dia);
        const cnt=await supa.from(TABLE).select('dia',{count:'exact',head:true});
        totalLinhas = cnt.count ?? 0;
        srcInfo.textContent = `Fonte OK (${minISO} → ${maxISO}) · linhas: ${totalLinhas} · origem: ${TABLE}`;
        srcInfo.classList.remove('err'); srcInfo.classList.add('ok');
      }else{
        srcInfo.textContent = "Sem dados na fonte.";
        srcInfo.classList.add('err');
        minISO=maxISO=null;
      }
    }

    async function buildOptions(){
      // valores distintos direto no servidor
      const f1 = supa.from(TABLE).select('unidade', { distinct: true }).order('unidade',{ascending:true});
      const f2 = supa.from(TABLE).select('pagamento', { distinct: true }).order('pagamento',{ascending:true});
      const f3 = supa.from(TABLE).select('"Canal de venda"', { distinct: true }).order('Canal de venda',{ascending:true});
      const f4 = supa.from(TABLE).select('"Nome da loja"', { distinct: true }).order('Nome da loja',{ascending:true});

      const [r1,r2,r3,r4] = await Promise.all([f1,f2,f3,f4]);

      const u = [...new Set((r1.data||[]).map(x=>x.unidade).filter(v=>v!=='' && v!=null))];
      const p = [...new Set((r2.data||[]).map(x=>x.pagamento).filter(Boolean))];
      const c = [...new Set((r3.data||[]).map(x=>x["Canal de venda"]).filter(Boolean))];
      const l = [...new Set((r4.data||[]).map(x=>x["Nome da loja"]).filter(Boolean))];

      uni.innerHTML  = `<option>Todas</option>` + u.map(v=>`<option>${v}</option>`).join('');
      pag.innerHTML  = p.map(v=>`<option>${v}</option>`).join('');
      canal.innerHTML= c.map(v=>`<option>${v}</option>`).join('');
      loja.innerHTML = `<option>Todos</option>` + l.slice(0,50).map(v=>`<option>${v}</option>`).join(''); // até 50 pra não poluir
    }

    // ====== Paginação server-side ======
    async function fetchAllFiltered(a,b,uniSel,lojaSel,turnSel,canSel,pagSel,cancSel,pageSize=5000){
      const out=[]; let from=0;
      while(true){
        let qb = supa.from(TABLE)
          .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
          .gte('dia', a).lte('dia', b)
          .order('dia',{ascending:true})
          .range(from, from+pageSize-1);

        if(uniSel !== 'Todas') qb = qb.eq('unidade', uniSel);
        if(lojaSel !== 'Todos') qb = qb.eq('Nome da loja', lojaSel);
        if(turnSel.length) qb = qb.in('turno', turnSel);
        if(canSel.length)  qb = qb.in('Canal de venda', canSel);
        if(pagSel.length)  qb = qb.in('pagamento', pagSel);
        if(cancSel !== 'Todos') qb = qb.eq('cancelado', cancSel);

        const { data, error } = await qb;
        if(error){ console.error(error); break; }
        out.push(...(data||[]));
        if(!data || data.length < pageSize) break;
        from += pageSize;
      }
      return out;
    }

    // ====== Reload ======
    async function reload(){
      if(!minISO||!maxISO){ periodoEl.textContent='Sem dados.'; return; }
      const a = dini.value || minISO;
      const b = dfim.value || maxISO;
      const uniSel  = uni.value || 'Todas';
      const lojaSel = loja.value || 'Todos';
      const turnSel = Array.from(turno.selectedOptions).map(o=>o.value);
      const canSel  = Array.from(canal.selectedOptions).map(o=>o.value);
      const pagSel  = Array.from(pag.selectedOptions).map(o=>o.value);
      const cancSel = canc.value || 'Todos';

      const data = await fetchAllFiltered(a,b,uniSel,lojaSel,turnSel,canSel,pagSel,cancSel,5000);
      const rows = (data||[]).map(x=>({
        ...x,
        dia: (x.dia||'').slice(0,10),
        cancelado: normCancel(x.cancelado),
        fat: Number(x.fat)||0, des:Number(x.des)||0, fre:Number(x.fre)||0, pedidos:Number(x.pedidos)||0
      }));

      periodoEl.textContent = `Período: ${a} → ${b} · registros filtrados: ${rows.length}`;

      const pedidos = rows.reduce((s,r)=>s+r.pedidos,0);
      const fat     = rows.reduce((s,r)=>s+r.fat,0);
      const des     = rows.reduce((s,r)=>s+r.des,0);
      const fre     = rows.reduce((s,r)=>s+r.fre,0);
      const dias    = new Set(rows.map(r=>r.dia)).size || 1;

      kPedidos.textContent = pedidos.toLocaleString('pt-BR');
      kFat.textContent     = fmtBRL(fat);
      kTicket.textContent  = fmtBRL(pedidos? fat/pedidos : 0);
      kFatDia.textContent  = fmtBRL(fat/dias);
      kDes.textContent     = fmtBRL(des);
      kDesPct.textContent  = fmtPct(fat? des/fat : 0);
      kFre.textContent     = fmtBRL(fre);
      kFatLiq.textContent  = fmtBRL(fat-des-fre);

      const byDay=new Map(); rows.forEach(r=>byDay.set(r.dia,(byDay.get(r.dia)||0)+r.fat));
      const labels=Array.from(byDay.keys()).sort(); const values=labels.map(d=>byDay.get(d));
      if(chart) chart.destroy();
      chart=new Chart(chartEl.getContext('2d'), {
        type:'line',
        data:{labels,datasets:[{label:'Receita',data:values,tension:0.2,pointRadius:0}]},
        options:{
          animation:false,
          responsive:true,
          maintainAspectRatio:false,
          parsing:false,
          plugins:{decimation:{enabled:true,algorithm:'lttb'}},
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // ====== Import CSV (incremental) ======
    function mapHeader(h){
      h = stripBOM(String(h||'')); const key = (h.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim());
      const cand = [
        {std:'dia', list:['dia','data','data da venda','data de venda','data_venda','datadavenda','date']},
        {std:'unidade', list:['unidade','filial','unidades','uni','store']},
        {std:'pedidos', list:['pedidos','pedido','qtd','qtde','quantidade','orders','qty']},
        {std:'fat', list:['fat','faturamento','total','valor total','valor','total geral','revenue','sales']},
        {std:'des', list:['des','desconto','discount']},
        {std:'fre', list:['fre','frete','entrega','delivery','shipping']},
        {std:'turno', list:['turno','shift','periodo','período']},
        {std:'Nome da loja', list:['nome da loja','nome loja','loja','nomedaloja','nome_da_loja','store_name']},
        {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda','channel','sales_channel']},
        {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento','payment','payment_method']},
        {std:'cancelado', list:['esta cancelado','está cancelado','cancelado','cancelada','cancelled','canceled']},
        {std:'hora', list:['hora','horario','horário','hour','time']},
        {std:'Data da venda', list:['data da venda']},
        {std:'Entrega', list:['entrega']},
        {std:'Desconto', list:['desconto']},
        {std:'Total', list:['total']},
      ];
      for (const c of cand) if (c.list.includes(key)) return c.std;
      return h;
    }

    btnImport.addEventListener('click', async ()=>{
      const file=csv.files?.[0];
      if(!file){ importStatus.textContent='Selecione um CSV.'; importStatus.style.color='#c0392b'; return; }
      importStatus.textContent='Lendo arquivo…'; importStatus.style.color='#667085';

      Papa.parse(file,{
        header:true, skipEmptyLines:'greedy', delimiter:"", transformHeader: mapHeader,
        complete: async (res)=>{
          const raw=res.data||[];
          const headers=Object.keys(raw[0]||{});
          const hasDia = headers.includes('dia') || headers.includes('Data da venda');
          const hasUni = headers.includes('unidade');
          const hasFat = headers.includes('fat') || headers.includes('Total');
          if(!hasDia || !hasUni || !hasFat){
            importStatus.textContent='Nada para importar (colunas obrigatórias não reconhecidas: dia/unidade/fat).';
            importStatus.style.color='#c0392b'; return;
          }

          const normRows = raw.map((r)=>{
            let dval = r.dia ?? r['Data da venda'];
            let iso  = null;
            if(dval){ iso = (String(dval).includes('/')) ? ddmmyyyyToISO(dval) : dval; }
            if(!iso) return null;

            const hora = ('hora' in r) ? (parseInt(r.hora,10)||-1) : hourFromDateText(dval);
            const fat  = parseBR(r.fat ?? r.Total ?? 0);
            const des  = parseBR(r.des ?? r['Desconto'] ?? 0);
            const fre  = parseBR(r.fre ?? r['Entrega']  ?? 0);
            const unidade = String(r.unidade||'').trim();
            if(!unidade || !isFinite(fat)) return null;

            return {
              dia: (iso||'').slice(0,10),
              unidade,
              pedidos: Math.max(1, Number(r.pedidos)||1),
              fat, des, fre,
              turno: r.turno ?? null,
              pagamento: r.pagamento ?? null,
              "Canal de venda": r["Canal de venda"] ?? r.Canal ?? null,
              "Nome da loja": r["Nome da loja"] ?? r.Loja ?? null,
              cancelado: normCancel(r.cancelado ?? r['Está cancelado']),
              hora: isFinite(hora)?hora:-1
            };
          }).filter(Boolean);

          if(!normRows.length){ importStatus.textContent='Nada para importar (linhas inválidas).'; importStatus.style.color='#c0392b'; return; }

          // agrega por chave para evitar 409
          const acc=new Map();
          for(const r of normRows){
            const key=[r.dia,r.unidade,r["Nome da loja"],r.hora,r.pagamento,r["Canal de venda"]].join('|');
            const v=acc.get(key)||{...r};
            v.pedidos=(v.pedidos||0)+(r.pedidos||0);
            v.fat=(v.fat||0)+(r.fat||0);
            v.des=(v.des||0)+(r.des||0);
            v.fre=(v.fre||0)+(r.fre||0);
            v.cancelado=r.cancelado||v.cancelado;
            acc.set(key,v);
          }
          const rows=[...acc.values()];
          importStatus.textContent=`Enviando ${rows.length.toLocaleString('pt-BR')} registros…`; importStatus.style.color='#667085';

          const onC='dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"';
          const chunk=1000;
          for(let i=0;i<rows.length;i+=chunk){
            const part=rows.slice(i,i+chunk);
            const r=await supa.from(TABLE).upsert(part,{onConflict:onC});
            if(r.error){ console.error(r.error); importStatus.textContent='Erro ao inserir.'; importStatus.style.color='#c0392b'; return; }
          }

          importStatus.textContent='Importado.'; importStatus.style.color='#0f974d';
          await fetchMinMax(); await buildOptions(); await reload();
        },
        error: err => { console.error(err); importStatus.textContent='Erro ao ler CSV.'; importStatus.style.color='#c0392b'; }
      });
    });

    // ====== Listeners ======
    pr.addEventListener("change", ()=>{ applyQuickDate(); reload(); fx.open=false; });
    [uni,dini,dfim,turno,canal,pag,canc,loja].forEach(e=> e.addEventListener("change", ()=>{ reload(); fx.open=false; }));
    btnLimpar.addEventListener('click', ()=>{ uni.value='Todas'; loja.value='Todos'; turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value='Todos'; applyQuickDate(); reload(); });

    // ====== Boot ======
    (async function boot(){
      await fetchMinMax();
      applyQuickDate();
      await buildOptions();
      await reload();
    })();
  })();
  </script>
</body>
</html>
