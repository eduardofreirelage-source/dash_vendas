<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Maestro Food</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#667085;--text:#0f172a;--blue:#1a73e8;--stroke:#e7ecf3;--r:14px}
    body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1100px;margin:24px auto 60px;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    small{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);padding:14px}
    .row{display:grid;gap:10px}
    .row-4{grid-template-columns:repeat(4,1fr)}
    .row-3{grid-template-columns:repeat(3,1fr)}
    .row-2{grid-template-columns:repeat(2,1fr)}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,button{width:100%;appearance:none;border:1px solid var(--stroke);border-radius:10px;padding:10px 12px;background:#fff}
    button.btn{background:var(--blue);color:#fff;border:none;cursor:pointer}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin-top:12px}
    .kpi h3{font:600 12px/1.2 ui-sans-serif;color:var(--muted);margin:0 0 6px}
    .kpi b{font-size:22px}
    #chartBox{height:260px;margin-top:12px}
    .muted{color:var(--muted)}
    @media (max-width:900px){.row-4{grid-template-columns:1fr 1fr}.kpis{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Maestro Food</h1>
    <small id="periodo">Período: —</small>

    <div class="card" style="margin-top:12px">
      <div class="row row-4">
        <div>
          <label>Período rápido</label>
          <select id="fQuick">
            <option>Últimos 7</option>
            <option>Últimos 15</option>
            <option selected>Últimos 30</option>
            <option>Últimos 60</option>
            <option>Últimos 90</option>
            <option>Este mês</option>
            <option>Último mês</option>
            <option>Este ano</option>
          </select>
        </div>
        <div>
          <label>De</label>
          <input id="fDini" type="date"/>
        </div>
        <div>
          <label>Até</label>
          <input id="fDfim" type="date"/>
        </div>
        <div style="align-self:end">
          <button id="btnAplicar" class="btn">Aplicar</button>
        </div>
      </div>

      <div class="row row-3" style="margin-top:10px">
        <div>
          <label>Unidade</label>
          <select id="fUnidade"></select>
        </div>
        <div>
          <label>Nome da loja</label>
          <select id="fLoja"></select>
        </div>
        <div>
          <label>Cancelado?</label>
          <select id="fCanc">
            <option>Todos</option>
            <option>Não</option>
            <option>Sim</option>
          </select>
        </div>
      </div>

      <div class="row row-2" style="margin-top:10px">
        <div>
          <label>Canal de venda</label>
          <select id="fCanal" multiple></select>
        </div>
        <div>
          <label>Pagamento</label>
          <select id="fPag" multiple></select>
        </div>
      </div>
    </div>

    <div class="kpis">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
      <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
      <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
    </div>

    <div class="card" id="chartBox">
      <canvas id="chart" height="240"></canvas>
      <small class="muted" id="serieInfo"></small>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <script>
  (function(){
    // ======= CONFIG =======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:true,autoRefreshToken:true}});

    // ======= DOM =======
    const el=id=>document.getElementById(id);
    const periodo=el('periodo');
    const fQuick=el('fQuick'), fDini=el('fDini'), fDfim=el('fDfim'), btnAp=el('btnAplicar');
    const fUnidade=el('fUnidade'), fLoja=el('fLoja'), fCanal=el('fCanal'), fPag=el('fPag'), fCanc=el('fCanc');

    const kPedidos=el('kPedidos'), kFat=el('kFat'), kTicket=el('kTicket'), kFatLiq=el('kFatLiq');
    const chartEl=el('chart'), serieInfo=el('serieInfo'); let chart=null;

    // ======= UTILS =======
    const fmtBRL = v => (isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—");
    const toISO = d => { if(!d) return null; const dt=new Date(d); return isNaN(dt)? null : dt.toISOString().slice(0,10); };
    const getMulti = (sel) => Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
    function applyQuick(){
      const opt=fQuick.value, end=new Date(); let start=new Date();
      if(opt.startsWith('Últimos ')){ const n=parseInt(opt.split(' ')[1],10)||30; start.setDate(end.getDate()-(n-1)); }
      else if(opt==='Este mês'){ start=new Date(end.getFullYear(), end.getMonth(), 1); }
      else if(opt==='Último mês'){ start=new Date(end.getFullYear(), end.getMonth()-1, 1); const e=new Date(end.getFullYear(), end.getMonth(), 0); fDini.value=toISO(start); fDfim.value=toISO(e); return; }
      else if(opt==='Este ano'){ start=new Date(end.getFullYear(),0,1); }
      else { start.setDate(end.getDate()-29); }
      fDini.value=toISO(start); fDfim.value=toISO(end);
    }

    // ======= POPULAR FILTROS (RPC) =======
    async function loadFilterOptions(){
      const _dini=(fDini.value||'').slice(0,10)||null;
      const _dfim=(fDfim.value||'').slice(0,10)||null;
      const _unidade = (fUnidade.value && fUnidade.value!=='Todas') ? fUnidade.value : null;

      const r = await supa.rpc('dash_filtros',{ _dini, _dfim, _unidade });
      if(r.error){ console.error(r.error); return; }

      const data = r.data || {};
      const unidades = (data.unidades||[]).map(String);
      const lojas    = (data.lojas||[]).map(String);
      const canais   = (data.canais||[]).map(String);
      const pagamentos=(data.pagamentos||[]).map(String);

      const keep = (sel, nov, primeira) => {
        const cur = sel.multiple ? getMulti(sel) : sel.value;
        sel.innerHTML = primeira
          ? `<option>${primeira}</option>` + nov.map(v=>`<option>${v}</option>`).join('')
          : nov.map(v=>`<option>${v}</option>`).join('');
        if(sel.multiple){
          Array.from(sel.options).forEach(o=>{ if(cur.includes(o.value)) o.selected=true; });
        }else{
          if(nov.includes(cur)) sel.value=cur; else sel.selectedIndex=0;
        }
      };

      keep(fUnidade, unidades, 'Todas');
      keep(fLoja,     lojas,    'Todos');
      keep(fCanal,    canais,   null);
      keep(fPag,      pagamentos,null);
    }

    // ======= RELOAD (KPIs + Série) =======
    async function reloadAll(){
      const _dini=(fDini.value||'').slice(0,10)||null;
      const _dfim=(fDfim.value||'').slice(0,10)||null;

      const _unidade = (fUnidade.value && fUnidade.value!=='Todas') ? fUnidade.value : null;
      const _loja    = (fLoja.value && fLoja.value!=='Todos') ? fLoja.value : null;
      const _canaisArr  = getMulti(fCanal);   const _canais = _canaisArr.length? _canaisArr : null;
      const _pagsArr    = getMulti(fPag);     const _pagamentos = _pagsArr.length? _pagsArr   : null;
      const _cancelado  = fCanc.value || 'Todos'; // passa string ('Todos'|'Sim'|'Não')

      // KPIs
      const k = await supa.rpc('dash_kpis',{
        _dini, _dfim, _unidade, _loja, _canais, _pagamentos, _cancelado
      });

      if(k.error){
        console.error(k.error);
        kPedidos.textContent='—'; kFat.textContent='—'; kTicket.textContent='—'; kFatLiq.textContent='—';
      }else{
        const r = k.data?.[0] || {};
        const pedidos = Number(r.pedidos||0);
        const fat     = Number(r.fat||0);
        const des     = Number(r.descontos||0);
        const fre     = Number(r.fretes||0);
        const liq     = isFinite(fat - des - fre) ? (fat - des - fre) : 0;
        const ticket  = pedidos ? (fat/pedidos) : 0;

        kPedidos.textContent = pedidos.toLocaleString('pt-BR');
        kFat.textContent     = fmtBRL(fat);
        kTicket.textContent  = fmtBRL(ticket);
        kFatLiq.textContent  = fmtBRL(liq);
      }

      // Série (gráfico)
      const s = await supa.rpc('dash_serie',{
        _dini, _dfim, _unidade, _loja, _canais, _pagamentos, _cancelado
      });

      if(s.error || !Array.isArray(s.data) || s.data.length===0){
        if(chart) chart.destroy();
        serieInfo.textContent='Sem pontos no período.';
      }else{
        const labels = s.data.map(r=>r.dia);
        const values = s.data.map(r=>Number(r.fat||0)).map(v=> isFinite(v)? v:0);
        const ctx = chartEl.getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets:[{ label:'Receita', data:values, tension:0.2 }] },
          options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
        });
        serieInfo.textContent = `Pontos: ${s.data.length.toLocaleString('pt-BR')}`;
      }

      periodo.textContent = `Período: ${_dini??'—'} → ${_dfim??'—'}`;
    }

    // ======= LISTENERS =======
    fQuick.addEventListener('change', async ()=>{ applyQuick(); await loadFilterOptions(); await reloadAll(); });
    el('btnAplicar').addEventListener('click', async ()=>{ await loadFilterOptions(); await reloadAll(); });
    fUnidade.addEventListener('change', async ()=>{ await loadFilterOptions(); await reloadAll(); });
    fLoja.addEventListener('change', reloadAll);
    fCanal.addEventListener('change', reloadAll);
    fPag.addEventListener('change', reloadAll);
    fCanc.addEventListener('change', reloadAll);

    // ======= BOOT =======
    (async function(){
      applyQuick();
      await loadFilterOptions();  // popula selects reais
      await reloadAll();          // KPIs + série via RPC
    })();
  })();
  </script>
</body>
</html>
