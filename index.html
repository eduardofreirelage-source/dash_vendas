<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maestro Food - Dashboard (Pronto para Uso)</title>
  <!-- Favicon inline p/ evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>' />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root {
      --bg:#f5f7fb; --card:#fff; --muted:#667085; --text:#0f172a; --blue:#1a73e8; --stroke:#e6eaf2;
      --radius:14px; --success:#16a34a; --error:#dc2626; --warning:#f59e0b;
    }
    body { background:var(--bg); color:var(--text); font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; }
    .container { max-width:1200px; margin:24px auto 64px; padding:0 16px; }
    h1 { font-size:24px; font-weight:700; margin:8px 0 4px; }
    small.muted { color:var(--muted); }
    .row { display:grid; gap:12px; }
    .cols-2 { grid-template-columns:repeat(2,1fr); }
    .cols-3 { grid-template-columns:repeat(3,1fr); }
    .cols-4 { grid-template-columns:repeat(4,1fr); }
    .card { background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:14px; }
    .card.dashed { border-style:dashed; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, button, textarea {
      appearance:none; border:1px solid var(--stroke); background:#fff; color:var(--text);
      border-radius:10px; padding:10px 12px; width:100%;
    }
    select[multiple] { height:140px; }
    .inline { display:flex; gap:10px; align-items:center; }
    .btn { background:var(--blue); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.ghost { background:#eef3ff; color:#1747b7; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    .grid-kpi { display:grid; gap:12px; grid-template-columns:repeat(4,1fr); }
    .kpi h3 { font-size:12px; color:var(--muted); margin:0 0 8px; }
    .kpi b { font-size:22px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eef3ff; color:#1747b7; font-weight:600; }
    .right { text-align:right; }
    .hint { color:var(--muted); font-size:12px; }
    .status { font-size:12px; font-weight:500; }
    .status.success { color:var(--success); }
    .status.error { color:var(--error); }
    .status.warning { color:var(--warning); }
    .debug-btn { position:fixed; top:10px; right:10px; z-index:9999; font-size:10px; padding:4px 8px; }
    @media (max-width:960px){ .grid-kpi{ grid-template-columns:repeat(2,1fr);} .cols-4{grid-template-columns:1fr;} .cols-3{grid-template-columns:1fr;} .cols-2{grid-template-columns:1fr;} }
  </style>
  <!-- libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Maestro Food - Dashboard (Pronto para Uso)</h1>
    <small id="periodo" class="muted">Período: —</small>
    <button id="debugBtn" class="btn ghost debug-btn" onclick="debugInfo()">Debug</button>

    <details id="fx" class="card" open>
      <summary class="inline" style="justify-content:space-between;">
        <b>FILTROS</b>
        <div class="inline">
          <button id="btnLimpar" class="btn ghost" type="button">Limpar</button>
        </div>
      </summary>

      <div class="row cols-2" style="margin-top:12px;">
        <div>
          <label>Unidade</label>
          <select id="fUnidade"></select>
        </div>
        <div>
          <label>Nome da loja (Top 10)</label>
          <select id="fLoja"></select>
        </div>
      </div>

      <div class="row cols-4" style="margin-top:8px;">
        <div>
          <label>De</label>
          <input id="fDini" type="date" />
        </div>
        <div>
          <label>Até</label>
          <input id="fDfim" type="date" />
        </div>
        <div>
          <label>Período rápido</label>
          <select id="fQuick">
            <option>Últimos 30</option>
            <option>Últimos 60</option>
            <option selected>Últimos 90</option>
            <option>Este mês</option>
            <option>Último mês</option>
            <option>Este ano</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="fTurno" multiple>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px;">
        <div>
          <label>Canal de venda</label>
          <select id="fCanal" multiple></select>
        </div>
        <div>
          <label>Pagamento</label>
          <select id="fPag" multiple></select>
        </div>
        <div>
          <label>Está cancelado?</label>
          <select id="fCanc">
            <option>Todos</option><option>Não</option><option>Sim</option>
          </select>
        </div>
      </div>

      <div class="card dashed" style="margin-top:12px;">
        <div class="row cols-2">
          <div class="inline">
            <label style="margin:0;">Admin — Importar CSV (<b>Pasta2.csv</b>)</label>
          </div>
          <div class="right"><span id="importStatus" class="status muted">Selecione um arquivo CSV</span></div>
        </div>
        <div class="inline" style="margin-top:8px;">
          <input id="csv" type="file" accept=".csv,text/csv" />
          <button id="btnImport" class="btn" type="button">Importar CSV (incremental)</button>
        </div>
        <p class="hint" style="margin-top:8px;">
          Importação é somativa com deduplicação por chave composta
          (dia, unidade, "Nome da loja", hora, pagamento, "Canal de venda").  
          Campos mínimos aceitos no CSV: <b>Data da venda</b> (dia) • <b>unidade</b> • <b>Total</b> (fat).  
          Demais colunas são mapeadas automaticamente (ex.: <i>Desconto</i>, <i>Entrega</i>, <i>Está cancelado</i>…).
        </p>
      </div>
    </details>

    <div class="grid-kpi" style="margin-top:14px;">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
      <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
      <div class="card kpi"><h3>Faturamento Médio (dia)</h3><b id="kFatDia">—</b></div>
      <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
      <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
      <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
      <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="inline" style="justify-content:space-between;">
        <b>Receita diária (R$)</b>
        <div class="inline">
          <span class="pill" id="modoTotal">Total</span>
          <span class="pill" id="modoAvg" style="margin-left:6px;background:#fff;border:1px solid var(--stroke);color:var(--muted);">Média (7d)</span>
        </div>
      </div>
      <canvas id="chart" height="120" style="margin-top:8px;"></canvas>
    </div>
  </div>

  <script>
  (function(){
    // ====== CONFIG CORRIGIDA ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    
    // Chave ANON do Supabase configurada
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    
    console.log("✅ Chave do Supabase configurada corretamente");
    
    const PREFER_TABLE  = "vendas_kpi_daily_v2_data"; // preferível
    const FALLBACK_VIEW = "vendas_kpi_daily_v2";      // compat
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { 
      auth: { persistSession: true, autoRefreshToken: true } 
    });

    // ====== DOM ======
    const el = (id)=>document.getElementById(id);
    const fx = el("fx");
    const periodoEl = el("periodo");
    const uni = el("fUnidade"), loja = el("fLoja"), dini = el("fDini"), dfim = el("fDfim"),
          pr = el("fQuick"), turno = el("fTurno"), canal = el("fCanal"), pag = el("fPag"), canc = el("fCanc");
    const btnLimpar = el("btnLimpar"), csv = el("csv"), btnImport = el("btnImport"), importStatus = el("importStatus");
    const kPedidos = el("kPedidos"), kTicket = el("kTicket"), kFat = el("kFat"), kFatDia = el("kFatDia"),
          kDes = el("kDes"), kDesPct = el("kDesPct"), kFre = el("kFre"), kFatLiq = el("kFatLiq");
    const modoTotal = el("modoTotal"), modoAvg = el("modoAvg");
    const chartEl = el("chart");
    let chart;

    // ====== STATE ======
    let TABLE = null;
    let minISO = null, maxISO = null;
    let lastData = [];

    // ====== UTILS CORRIGIDAS ======
    const fmtBRL = (v)=> (isFinite(v) ? v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : "—");
    const fmtPct = (v)=> (isFinite(v) ? (v*100).toFixed(1).replace('.',',')+'%' : "—");
    
    const toISO = (d) => {
      if (!d) return null;
      try {
        const date = new Date(d);
        if (isNaN(date.getTime())) return null;
        return date.toISOString().slice(0, 10);
      } catch (error) {
        console.warn(`Erro ao converter data: ${d}`, error);
        return null;
      }
    };
    
    const onlyDateISO = (iso)=> iso && iso.length>=10 ? iso.slice(0,10) : iso;
    
    const parseBR = (x)=> {
      if (x==null || x==='') return 0;
      if (typeof x === 'number') return x;
      const s = String(x).trim().replace(/\./g,'').replace(',','.');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    };
    
    const norm = (s) => {
      return String(s ?? "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    };
    
    const normCancel = (v)=>{
      const s = String(v??"").trim().toLowerCase();
      if (v===true || s==="sim" || s==="s" || s==="1" || s==="true") return "Sim";
      return "Não";
    };

    // Função de conversão de data corrigida
    function ddmmyyyyToISO(s){
      if(!s) return null;
      const str = String(s).trim();
      const [datePart, timePart] = str.split(' ');
      
      if (!datePart) return null;
      
      const [d, m, y] = datePart.split('/');
      
      // Validação mais rigorosa
      const day = parseInt(d, 10);
      const month = parseInt(m, 10);
      const year = parseInt(y, 10);
      
      if (!day || !month || !year || 
          day < 1 || day > 31 || 
          month < 1 || month > 12 || 
          year < 1900 || year > 2100) {
        console.warn(`Data inválida: ${s}`);
        return null;
      }
      
      const isoDate = `${year.toString().padStart(4,'0')}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      
      // Validar se a data é realmente válida
      const testDate = new Date(isoDate);
      if (testDate.getFullYear() !== year || 
          testDate.getMonth() + 1 !== month || 
          testDate.getDate() !== day) {
        console.warn(`Data inválida após conversão: ${s}`);
        return null;
      }
      
      return `${isoDate}${timePart ? 'T' + timePart + ':00' : 'T00:00:00'}`;
    }

    // Mapeamento de headers melhorado
    const mapHeader = (h) => {
      const key = norm(h);
      const cand = [
        {std:'dia', list:['dia','data','data da venda','data de venda','data_venda','datadavenda','date']},
        {std:'unidade', list:['unidade','filial','unidades','uni','store','loja']},
        {std:'pedidos', list:['pedidos','pedido','qtd','qtde','quantidade','orders','qty']},
        {std:'fat', list:['fat','faturamento','total','valor total','valor','total geral','revenue','sales']},
        {std:'des', list:['des','desconto','discount']},
        {std:'fre', list:['fre','frete','entrega','delivery','shipping']},
        {std:'turno', list:['turno','shift','periodo','período']},
        {std:'Nome da loja', list:['nome da loja','nome loja','loja','nomedaloja','nome_da_loja','store_name']},
        {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda','channel','sales_channel']},
        {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento','payment','payment_method']},
        {std:'cancelado', list:['esta cancelado','está cancelado','cancelado','cancelada','cancelled','canceled']},
        {std:'hora', list:['hora','horario','horário','hour','time']},
      ];
      
      for (const c of cand) {
        if (c.list.includes(key)) {
          console.log(`Mapeando header: "${h}" -> "${c.std}"`);
          return c.std;
        }
      }
      
      console.log(`Header não mapeado: "${h}"`);
      return h; // mantém desconhecidos
    };

    function hourFromDateText(s){
      const str = String(s??'');
      const parts = str.split(' ');
      if(parts[1] && parts[1].includes(':')){
        const [hh] = parts[1].split(':');
        const h = parseInt(hh,10);
        return isFinite(h)? h : -1;
      }
      return -1;
    }

    function applyQuickDate(){
      const opt = pr.value;
      const today = new Date();
      let start, end = new Date();
      if(opt.startsWith("Últimos ")){
        const n = parseInt(opt.split(' ')[1],10); // 30/60/90
        start = new Date();
        start.setDate(end.getDate()- (n-1));
      } else if(opt==="Este mês"){
        start = new Date(end.getFullYear(), end.getMonth(), 1);
      } else if(opt==="Último mês"){
        start = new Date(end.getFullYear(), end.getMonth()-1, 1);
        end = new Date(end.getFullYear(), end.getMonth(), 0);
      } else if(opt==="Este ano"){
        start = new Date(end.getFullYear(), 0, 1);
      } else {
        start = new Date(end.getFullYear(), end.getMonth(), end.getDate()-29);
      }
      dini.value = toISO(start);
      dfim.value = toISO(end);
    }

    function getSelected(sel){
      if(sel.multiple){
        return Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
      }
      return sel.value;
    }

    // Funções de status
    function showLoading(message) {
      importStatus.textContent = message;
      importStatus.className = 'status';
      importStatus.style.color = '#1a73e8';
    }

    function showError(message) {
      importStatus.textContent = message;
      importStatus.className = 'status error';
    }

    function showSuccess(message) {
      importStatus.textContent = message;
      importStatus.className = 'status success';
    }

    function showWarning(message) {
      importStatus.textContent = message;
      importStatus.className = 'status warning';
    }

    // ====== DATA SOURCE ======
    async function pickSource(){
      try {
        // tenta tabela
        let ok = await supa.from(PREFER_TABLE).select('dia').limit(1);
        if(!ok.error) { 
          TABLE = PREFER_TABLE; 
          console.log('Usando tabela:', PREFER_TABLE);
          return; 
        }
        // tenta view
        ok = await supa.from(FALLBACK_VIEW).select('dia').limit(1);
        if(!ok.error){ 
          TABLE = FALLBACK_VIEW; 
          console.log('Usando view:', FALLBACK_VIEW);
          return; 
        }
        TABLE = null;
        console.error('Nenhuma fonte de dados encontrada');
      } catch (error) {
        console.error('Erro ao conectar com Supabase:', error);
        TABLE = null;
      }
    }

    async function fetchMinMax(){
      if(!TABLE){ minISO=maxISO=null; return; }
      try {
        const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
        const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
        if(!a.error && a.data?.length && !b.error && b.data?.length){
          minISO = onlyDateISO(a.data[0].dia);
          maxISO = onlyDateISO(b.data[0].dia);
          console.log('Período disponível:', minISO, '→', maxISO);
        } else {
          minISO = maxISO = null;
        }
      } catch (error) {
        console.error('Erro ao buscar min/max:', error);
        minISO = maxISO = null;
      }
    }

    async function buildOptions(){
      if(!TABLE) return;
      try {
        // Unidade
        {
          const r = await supa.from(TABLE).select('unidade').not('unidade','is',null).order('unidade',{ascending:true}).range(0,9999);
          const arr = [...new Set((r.data||[]).map(x=>x.unidade).filter(Boolean))];
          uni.innerHTML = `<option>Todas</option>` + arr.map(v=>`<option>${v}</option>`).join('');
          console.log('Unidades carregadas:', arr.length);
        }
        // Pagamento
        {
          const r = await supa.from(TABLE).select('pagamento').not('pagamento','is',null).order('pagamento',{ascending:true}).range(0,9999);
          const arr = [...new Set((r.data||[]).map(x=>x.pagamento).filter(Boolean))];
          pag.innerHTML = arr.map(v=>`<option>${v}</option>`).join('');
          console.log('Formas de pagamento carregadas:', arr.length);
        }
        // Canal de venda (coluna com espaço → usar aspas no select)
        {
          const r = await supa.from(TABLE).select('"Canal de venda"').order('Canal de venda',{ascending:true}).range(0,9999);
          const arr = [...new Set((r.data||[]).map(x=>x["Canal de venda"]).filter(Boolean))];
          canal.innerHTML = arr.map(v=>`<option>${v}</option>`).join('');
          console.log('Canais de venda carregados:', arr.length);
        }
        // Lojas Top 10 (agregado em banco)
        {
          const q = await supa.from(TABLE)
            .select('"Nome da loja",fat')
            .not('fat','is',null)
            .not('Nome da loja','is',null)
            .range(0,20000);
          const acc = new Map();
          (q.data||[]).forEach(r=>{
            const k = r["Nome da loja"];
            acc.set(k, (acc.get(k)||0) + (Number(r.fat)||0));
          });
          const top = Array.from(acc.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
          loja.innerHTML = `<option>Todos</option>` + top.map(v=>`<option>${v}</option>`).join('');
          console.log('Top 10 lojas carregadas:', top.length);
        }
      } catch (error) {
        console.error('Erro ao carregar opções:', error);
      }
    }

    function insideSel(v, arr){ return !arr?.length || arr.includes(v); }

    function inDateRange(iso, a, b){
      const d = iso;
      return (!a || d>=a) && (!b || d<=b);
    }

    function computeKPIs(rows){
      const pedidos = rows.reduce((s,r)=> s + (Number(r.pedidos)||0), 0);
      const fat     = rows.reduce((s,r)=> s + (Number(r.fat)||0), 0);
      const des     = rows.reduce((s,r)=> s + (Number(r.des)||0), 0);
      const fre     = rows.reduce((s,r)=> s + (Number(r.fre)||0), 0);
      const fatliq  = fat - des - fre;
      const dias    = new Set(rows.map(r=>r.dia)).size || 1;
      const ticket  = pedidos ? fat / pedidos : 0;
      const fatDia  = fat / dias;
      const desPct  = fat ? (des/fat) : 0;

      kPedidos.textContent = pedidos.toLocaleString('pt-BR');
      kTicket.textContent  = fmtBRL(ticket);
      kFat.textContent     = fmtBRL(fat);
      kFatDia.textContent  = fmtBRL(fatDia);
      kDes.textContent     = fmtBRL(des);
      kDesPct.textContent  = fmtPct(desPct);
      kFre.textContent     = fmtBRL(fre);
      kFatLiq.textContent  = fmtBRL(fatliq);
    }

    function drawChart(rows){
      const byDay = new Map();
      rows.forEach(r=> byDay.set(r.dia, (byDay.get(r.dia)||0) + (Number(r.fat)||0)) );
      const labels = Array.from(byDay.keys()).sort();
      const values = labels.map(d=> byDay.get(d));

      const ctx = chartEl.getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Receita', data: values, tension:0.2 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // Função reload melhorada
    async function reload() {
      if (!TABLE) { 
        periodoEl.textContent = 'Sem dados.'; 
        computeKPIs([]); 
        if (chart) chart.destroy(); 
        return; 
      }

      const a = dini.value || minISO;
      const b = dfim.value || maxISO;
      const uniSel = uni.value || 'Todas';
      const lojaSel = loja.value || 'Todos';
      const turnSel = getSelected(turno).map(String);
      const canSel = getSelected(canal).map(String);
      const pagSel = getSelected(pag).map(String);
      const cancSel = canc.value || 'Todos';

      console.log('Filtros aplicados:', {
        periodo: `${a} → ${b}`,
        unidade: uniSel,
        loja: lojaSel,
        turnos: turnSel,
        canais: canSel,
        pagamentos: pagSel,
        cancelado: cancSel
      });

      try {
        // Carrega dados com tratamento de erro
        const q = await supa.from(TABLE)
          .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
          .order('dia', { ascending: true })
          .range(0, 200000);

        if (q.error) {
          console.error('Erro ao carregar dados:', q.error);
          periodoEl.textContent = 'Erro ao carregar dados';
          return;
        }

        let rows = (q.data || []).map(r => ({
          ...r,
          dia: onlyDateISO(r.dia),
          cancelado: normCancel(r.cancelado)
        }));

        console.log(`Dados carregados: ${rows.length} registros`);

        // Aplicar filtros com logs
        const originalCount = rows.length;
        
        rows = rows.filter(r => {
          if (!inDateRange(r.dia, a, b)) return false;
          if (uniSel !== 'Todas' && norm(r.unidade) !== norm(uniSel)) return false;
          if (lojaSel !== 'Todos' && norm(r["Nome da loja"]) !== norm(lojaSel)) return false;
          if (turnSel.length && !insideSel(r.turno, turnSel)) return false;
          if (canSel.length && !insideSel(r["Canal de venda"], canSel)) return false;
          if (pagSel.length && !insideSel(r.pagamento, pagSel)) return false;
          if (cancSel !== 'Todos' && normCancel(r.cancelado) !== cancSel) return false;
          return true;
        });

        console.log(`Após filtros: ${rows.length} de ${originalCount} registros`);

        lastData = rows;
        periodoEl.textContent = `Período: ${a ?? '—'} → ${b ?? '—'} (${rows.length} registros)`;
        computeKPIs(rows);
        drawChart(rows);
        
      } catch (error) {
        console.error('Erro durante reload:', error);
        periodoEl.textContent = 'Erro ao processar dados';
      }
    }

    // ====== IMPORT MELHORADO ======
    
    // Validação de arquivo CSV
    csv.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
          showError('Selecione um arquivo CSV válido');
          this.value = '';
          return;
        }
        if (file.size > 50 * 1024 * 1024) { // 50MB
          showError('Arquivo muito grande (máximo 50MB)');
          this.value = '';
          return;
        }
        showSuccess(`Arquivo selecionado: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`);
      }
    });

    btnImport.addEventListener('click', async ()=>{
      const file = csv.files?.[0];
      if(!file){ 
        showError('Selecione um CSV primeiro'); 
        return; 
      }
      
      btnImport.disabled = true;
      showLoading('Lendo arquivo…');

      Papa.parse(file, {
        header: true,
        skipEmptyLines: 'greedy',
        delimiter: '', // Auto-detecta delimitador (, ; \t)
        quoteChar: '"',
        escapeChar: '"',
        transformHeader: mapHeader,
        beforeFirstChunk: function(chunk) {
          console.log('Iniciando parse do CSV...');
          return chunk;
        },
        step: function(row, parser) {
          // Log de progresso a cada 50KB
          if (parser.getCharIndex() % 50000 === 0) {
            const progress = Math.round(parser.getCharIndex() / file.size * 100);
            showLoading(`Processando... ${progress}%`);
          }
        },
        complete: async (res) => {
          console.log('Parse completo:', res.meta);
          
          if (res.errors && res.errors.length > 0) {
            console.warn('Erros durante parse:', res.errors);
            showWarning(`Aviso: ${res.errors.length} erros encontrados no CSV`);
          }
          
          const raw = res.data || [];
          console.log(`Linhas lidas: ${raw.length}`);
          
          if (!raw.length) {
            showError('Arquivo CSV vazio');
            btnImport.disabled = false;
            return;
          }

          // Verificar headers
          const headers = Object.keys(raw[0] || {});
          console.log('Headers detectados:', headers);

          // Verificar se as colunas obrigatórias existem após o mapeamento
          const hasDia = headers.includes('dia') || headers.some(h => norm(h).includes('data'));
          const hasUni = headers.includes('unidade');
          const hasFat = headers.includes('fat') || headers.includes('Total');

          console.log('Validação colunas:', { hasDia, hasUni, hasFat });

          if (!hasDia || !hasUni || !hasFat) {
            const missing = [];
            if (!hasDia) missing.push('Data/Dia');
            if (!hasUni) missing.push('Unidade');
            if (!hasFat) missing.push('Faturamento/Total');
            
            showError(`Colunas obrigatórias não encontradas: ${missing.join(', ')}`);
            console.error('Colunas obrigatórias ausentes:', missing);
            btnImport.disabled = false;
            return;
          }

          showLoading('Processando dados…');

          // Mapeia → normaliza (versão corrigida)
          const normRows = raw.map((r, index) => {
            try {
              // Determinar campo de data
              let diaValue = r.dia || r['Data da venda'] || r['data'] || r['Data'];
              let diaIso = null;
              
              if (diaValue) {
                if (String(diaValue).includes('/')) {
                  diaIso = ddmmyyyyToISO(diaValue);
                } else {
                  diaIso = toISO(diaValue);
                }
              }
              
              if (!diaIso) {
                console.warn(`Linha ${index + 1}: Data inválida - ${diaValue}`);
                return null;
              }
              
              // Extrair hora
              const hora = ('hora' in r) ? 
                (parseInt(r.hora, 10) || -1) : 
                hourFromDateText(diaValue);
              
              // Valores monetários
              const fat = parseBR(r.fat || r['Total'] || r.total || 0);
              const des = parseBR(r.des || r['Desconto'] || r.desconto || 0);
              const fre = parseBR(r.fre || r['Entrega'] || r.entrega || r.frete || 0);
              
              // Validar valores essenciais
              if (!isFinite(fat) || fat < 0) {
                console.warn(`Linha ${index + 1}: Faturamento inválido - ${fat}`);
                return null;
              }
              
              const unidade = String(r.unidade || r.Unidade || '').trim();
              if (!unidade) {
                console.warn(`Linha ${index + 1}: Unidade vazia`);
                return null;
              }
              
              return {
                dia: onlyDateISO(diaIso),
                unidade: unidade,
                pedidos: Math.max(1, Number(r.pedidos) || 1),
                fat: fat,
                des: Math.max(0, des),
                fre: Math.max(0, fre),
                turno: r.turno || r.Turno || null,
                pagamento: r.pagamento || r.Pagamento || null,
                "Canal de venda": r["Canal de venda"] || r.Canal || null,
                "Nome da loja": r["Nome da loja"] || r.Loja || null,
                cancelado: normCancel(r.cancelado || r['Está cancelado']),
                hora: isFinite(hora) ? hora : -1
              };
            } catch (error) {
              console.error(`Erro processando linha ${index + 1}:`, error, r);
              return null;
            }
          }).filter(Boolean); // Remove nulls

          console.log(`Processadas ${normRows.length} linhas válidas de ${raw.length} total`);

          if(!normRows.length){ 
            showError('Nenhuma linha válida encontrada'); 
            btnImport.disabled = false;
            return; 
          }

          showLoading('Deduplicando dados…');

          // Dedup no client (soma fat/des/fre, conta pedidos)
          const acc = new Map();
          for(const r of normRows){
            const key = [r.dia,r.unidade,r["Nome da loja"],r.hora,r.pagamento,r["Canal de venda"]].join('|');
            const v = acc.get(key) || { ...r };
            v.pedidos = (v.pedidos||0) + (r.pedidos||0);
            v.fat = (v.fat||0) + (r.fat||0);
            v.des = (v.des||0) + (r.des||0);
            v.fre = (v.fre||0) + (r.fre||0);
            v.cancelado = r.cancelado || v.cancelado;
            acc.set(key, v);
          }
          const rows = Array.from(acc.values());

          showLoading(`Enviando ${rows.length.toLocaleString('pt-BR')} registros…`);

          // Garante fonte
          if(!TABLE) await pickSource();
          if(!TABLE){ 
            showError('Sem tabela definida no banco'); 
            btnImport.disabled = false;
            return; 
          }

          try {
            // Upsert (onConflict com aspas nas colunas com espaço)
            const onC = 'dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"';
            const r = await supa.from(TABLE).upsert(rows, { onConflict:onC });
            
            if(r.error){ 
              console.error('Erro no upsert:', r.error);
              showError('Erro ao inserir dados no banco'); 
              btnImport.disabled = false;
              return; 
            }

            showSuccess(`✅ ${rows.length} registros importados com sucesso!`);
            
            // Atualizar interface
            await fetchMinMax();
            await buildOptions();
            await reload();
            
          } catch (error) {
            console.error('Erro durante upsert:', error);
            showError('Erro ao salvar no banco de dados');
          }
          
          btnImport.disabled = false;
        },
        error: function(error) {
          console.error('Erro no parse:', error);
          showError('Erro ao ler arquivo CSV');
          btnImport.disabled = false;
        }
      });
    });

    // ====== LISTENERS ======
    pr.addEventListener("change", ()=>{ applyQuickDate(); reload(); fx.open=false; });
    [uni,dini,dfim,turno,canal,pag,canc,loja].forEach(elm=>{
      elm.addEventListener("change", ()=>{ reload(); fx.open=false; });
    });
    btnLimpar.addEventListener('click', ()=>{
      uni.value = 'Todas';
      loja.value = 'Todos';
      turno.selectedIndex = -1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value='Todos';
      applyQuickDate(); reload();
    });

    // ====== DEBUG FUNCTION ======
    window.debugInfo = function() {
      console.log('=== DEBUG INFO ===');
      console.log('TABLE:', TABLE);
      console.log('minISO:', minISO);
      console.log('maxISO:', maxISO);
      console.log('SUPABASE_ANON válida:', SUPABASE_ANON !== "SUA_CHAVE_ANON_AQUI");
      console.log('Último dados:', lastData?.length || 0, 'registros');
      console.log('Filtros atuais:', {
        unidade: uni.value,
        loja: loja.value,
        periodo: `${dini.value} → ${dfim.value}`,
        cancelado: canc.value
      });
      console.log('Supabase client:', supa);
      console.log('==================');
    };

    // ====== BOOT ======
    (async function boot(){
      console.log('🚀 Iniciando Maestro Food Dashboard...');
      await pickSource();
      await fetchMinMax();
      applyQuickDate();
      await buildOptions();
      await reload();
      console.log('✅ Dashboard inicializado');
    })();

  })();
  </script>
</body>
</html>

