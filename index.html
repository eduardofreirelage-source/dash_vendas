<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DASHBOARD — CFO (v3.2.0 — Robusto)</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%232f6ef7"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#2f6ef7;
      --ok:#10b981; --down:#ef4444;
      --chip:#f7e9ed;                        /* fundo claro vinho */
      --bar:#334155;
      --wine:#7b1e3a;                        /* vinho escuro */
      --wine-soft:#9c3554;
      --c-now:#7b1e3a; --c-now-soft:#9c3554; --c-prev:#94a3b8; --c-prev-soft:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.clear{gap:6px}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;transition:max-height .25s ease}
    .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
    .sec-title{display:flex;align-items:center;gap:10px;font-weight:700}
    .ico{width:16px;height:16px;color:#475569}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    input[type="date"], .msel-btn, .input{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:44px;font-size:16px}
    input[type="date"]::-webkit-calendar-picker-indicator{transform:scale(1.2)}
    .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    .chip{padding:10px 0;border:1px solid #efd5db;border-radius:10px;background:var(--chip);cursor:pointer;text-align:center;font-weight:800;color:#7b1e3a}
    .chip.active{background:var(--c-now);border-color:var(--c-now);color:#fff;box-shadow:0 1px 0 rgba(123,30,58,.06)}
    .msel{position:relative}
    .msel-btn{cursor:pointer;text-align:left}
    .msel-btn:after{content:"▾";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;cursor:pointer}
    .msel-opt:hover{background:#f3f4f6}
    .msel-opt label { cursor: pointer; flex: 1; }
    .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05);cursor:pointer;transition:border-color .15s ease, box-shadow .15s ease, transform .02s ease}
    .kpi:active{transform:scale(.995)}
    .kpi.active{border-color:var(--c-now);box-shadow:0 0 0 4px rgba(123,30,58,.06)}
    .kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
    .kpi h4 .spacer{flex:1}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .accent{height:2px;background:var(--wine);border-radius:999px;margin:6px 0 6px 0;opacity:.95}
    .kpi .sub{font-size:12px;color:#667085;margin-top:2px}
    .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:12px;margin-left:12px;background:rgba(148,163,184,.15);color:#64748b}
    .delta svg{width:12px;height:12px}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .delta.down{background:rgba(148,163,184,.15);border-color:rgba(148,163,184,.35);color:#64748b}
    .delta.flat{background:#f1f5f9;border-color:#e2e8f0;color:#64748b}
    .chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
    .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:800}
    .seg button.active{background:var(--c-now);color:#fff}
    .chart-box{height:280px;position:relative}
    .chart-box canvas{display:block;width:100%;height:100%}
    .chart-card.wide{grid-column:span 2}
    .chart-card.wide .chart-box{height:360px}
    .center-link{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.92);border:1px solid var(--line);padding:4px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;color:#334155;white-space:nowrap}
    .section.collapsed .row, .section.collapsed #periodoInfo, .section.collapsed .upload-info{display:none}
    .section.collapsed .sec-head{cursor:pointer}
    .diag{font-size:12px;color:#475569;margin-left:8px}
    .upload-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .upload-info{margin-top:8px;font-size:12px;color:#475569}
    @media (max-width:1024px){.cols-3,.krow{grid-template-columns:repeat(2,1fr)}.cols-2,.chart-card.wide{grid-template-columns:1fr}}
    @media (max-width:640px){.cols-3,.krow{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>DASHBOARD</h1>
      <div class="upload-bar">
        <button id="btnUpload" class="btn">📤 Carregar Excel</button>
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
      </div>
    </div>

    <div id="secDatas" class="section">
      <div class="sec-head">
        <div class="sec-title">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
          Filtros de Data
        </div>
        <button id="btnClear" class="btn clear">✖ Limpar filtros</button>
      </div>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Intervalo (início)</div>
          <input type="date" id="fDe">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Intervalo (fim)</div>
          <input type="date" id="fAte">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Período rápido</div>
          <div class="chips">
            <button class="chip" data-q="7">07</button>
            <button class="chip" data-q="15">15</button>
            <button class="chip active" data-q="30">30</button>
            <button class="chip" data-q="60">60</button>
            <button class="chip" data-q="90">90</button>
            <button class="chip" data-q="120">120</button>
          </div>
          <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">—</div>
        </div>
      </div>
    </div>

    <div id="secFiltros" class="section">
      <div class="sec-head">
        <div class="sec-title">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
          Filtros
        </div>
        <div>
          <span id="status" class="muted">—</span>
          <span id="diag" class="diag"></span>
          <div id="uploadInfo" class="upload-info"></div>
        </div>
      </div>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Unidade</div>
          <div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Nome da Loja</div>
          <div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Turno da Venda</div>
          <div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px;">
        <div>
          <div class="muted" style="margin-bottom:6px;">Canal de Venda</div>
          <div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Tipo de Pagamento</div>
          <div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Cancelado</div>
          <div id="ms-cancel" class="msel">
            <button class="msel-btn">Não</button>
            <div class="msel-panel"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="krow">
      <div class="kpi" data-kpi="ped">
        <h4><span>Pedidos</span><span class="spacer"></span><span id="d_ped" class="delta flat">—</span></h4>
        <div class="val" id="k_ped">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_ped">—</span></div>
      </div>
      <div class="kpi" data-kpi="tkt">
        <h4><span>Ticket Médio</span><span class="spacer"></span><span id="d_tkt" class="delta flat">—</span></h4>
        <div class="val" id="k_tkt">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_tkt">—</span></div>
      </div>
      <div class="kpi active" data-kpi="fat">
        <h4><span>Faturamento</span><span class="spacer"></span><span id="d_fat" class="delta flat">—</span></h4>
        <div class="val" id="k_fat">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_fat">—</span></div>
      </div>
    </div>

    <div class="krow" style="margin-top:12px;">
      <div class="kpi" data-kpi="fatmed">
        <h4><span>Faturamento Médio</span><span class="spacer"></span><span id="d_fatmed" class="delta flat">—</span></h4>
        <div class="val" id="k_fatmed">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_fatmed">—</span></div>
      </div>
      <div class="kpi" data-kpi="des">
        <h4><span>Incentivos</span><span class="spacer"></span><span id="d_des" class="delta flat">—</span></h4>
        <div class="val" id="k_des">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_des">—</span></div>
      </div>
      <div class="kpi" data-kpi="desperc">
        <h4><span>% de Incentivos</span><span class="spacer"></span><span id="d_desperc" class="delta flat">—</span></h4>
        <div class="val" id="k_desperc">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_desperc">—</span></div>
      </div>
    </div>

    <div class="krow" style="margin-top:12px;">
      <div class="kpi" data-kpi="fre">
        <h4><span>Frete</span><span class="spacer"></span><span id="d_fre" class="delta flat">—</span></h4>
        <div class="val" id="k_fre">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_fre">—</span></div>
      </div>
      <div class="kpi" data-kpi="fremed">
        <h4><span>Frete Médio</span><span class="spacer"></span><span id="d_fremed" class="delta flat">—</span></h4>
        <div class="val" id="k_fremed">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_fremed">—</span></div>
      </div>
      <div class="kpi" data-kpi="canc_ped">
        <h4><span>Pedidos Cancelados</span><span class="spacer"></span><span id="d_canc_ped" class="delta flat">—</span></h4>
        <div class="val" id="k_canc_ped">—</div>
        <div class="accent"></div>
        <div class="sub">Participação: <span id="k_canc_part">—</span> (Anterior: <span id="p_canc_part">—</span>)</div>
      </div>
    </div>

    <div class="krow" style="margin-top:12px;">
      <div class="kpi" data-kpi="canc_val">
        <h4><span>Valor de Cancelados</span><span class="spacer"></span><span id="d_canc_val" class="delta flat">—</span></h4>
        <div class="val" id="k_canc_val">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_canc_val">—</span></div>
      </div>
      <div class="kpi" data-kpi="roi">
        <h4><span>ROI</span><span class="spacer"></span><span id="d_roi" class="delta flat">—</span></h4>
        <div class="val" id="k_roi">—</div>
        <div class="accent"></div>
        <div class="sub">Anterior: <span id="p_roi">—</span></div>
      </div>
      <div></div>
    </div>

    <div class="section">
      <div class="sec-head">
        <div class="sec-title">Gráficos</div>
        <div id="segGlobal" class="seg">
          <button class="active" data-mode="total">Total</button>
          <button data-mode="media">Média</button>
        </div>
      </div>

      <div class="row cols-2">
        <div class="chart-card wide">
          <div class="chart-head"><div class="muted" id="title_month">Vendas por mês — últimos 12M vs. 12M anteriores</div></div>
          <div class="chart-box"><canvas id="ch_month"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head"><div class="muted" id="title_dow">Vendas por dia da semana</div></div>
          <div class="chart-box"><canvas id="ch_dow"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head"><div class="muted" id="title_hour">Vendas por hora</div></div>
          <div class="chart-box"><canvas id="ch_hour"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head"><div class="muted" id="title_turno">Vendas por turno</div></div>
          <div class="chart-box"><canvas id="ch_turno"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head"><div class="muted" id="title_top6">Participação por loja — Top 6</div></div>
          <div class="chart-box">
            <canvas id="ch_top6"></canvas>
            <button id="top6Center" class="center-link">Total: R$ 0,00</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

  <script>
"use strict";

/* ===================== CONFIGURAÇÃO CENTRALIZADA ===================== */
const CONFIG = {
  SUPABASE_URL: 'https://msmyfxgrnuusnvoqyeuo.supabase.co',
  SUPABASE_ANON: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U',
  DB: {
    READ_VIEW: 'vendas_canon',
    DATE_RANGE_VIEW: 'vw_vendas_daterange',
    DEST_INSERT_TABLE: 'vendas_xlsx',
    REFRESH_RPC: 'refresh_sales_materialized',
    RPC_FN: {
      kpi: 'kpi_vendas',
      kpi_v2: 'kpi_vendas_v2',
      dow: 'chart_vendas_dow_v1',
      month: 'chart_vendas_mes_v1',
      hour: 'chart_vendas_hora_v1',
      turno: 'chart_vendas_turno_v1',
    },
  },
  KPI_META: {
    fat:     { label: 'Faturamento',          fmt: 'money',    forceMode: null,  needsCancel: null },
    ped:     { label: 'Pedidos',              fmt: 'count',    forceMode: null,  needsCancel: null },
    tkt:     { label: 'Ticket médio',          fmt: 'money',    forceMode: 'media', needsCancel: null },
    des:     { label: 'Incentivos',            fmt: 'money',    forceMode: null,  needsCancel: null },
    desperc: { label: '% de incentivos',       fmt: 'percent',  forceMode: 'media', needsCancel: null },
    fre:     { label: 'Frete',                 fmt: 'money',    forceMode: null,  needsCancel: null },
    fremed:  { label: 'Frete médio',           fmt: 'money',    forceMode: 'media', needsCancel: null },
    fatmed:  { label: 'Faturamento médio',     fmt: 'money',    forceMode: 'media', needsCancel: null },
    canc_ped:{ label: 'Pedidos cancelados',    fmt: 'count',    forceMode: null,  needsCancel: 'Sim' },
    canc_val:{ label: 'Valor de cancelados',   fmt: 'money',    forceMode: null,  needsCancel: 'Sim' },
  	roi:      { label: 'ROI',                   fmt: 'percent',  forceMode: 'media', needsCancel: null },
  },
  CHART_COLORS: ["#7b1e3a", "#8c2947", "#9c3554", "#ad4061", "#bd4c6e", "#ce577b"],
};

/* ===================== ESTADO DA APLICAÇÃO ===================== */
const state = {
  firstDay: '',
  lastDay: '',
  selectedKPI: 'fat',
  chartModeGlobal: 'total',
  lastPrevRange: { dePrev: null, atePrev: null },
  collapseTimer: null,
};

/* ===================== ELEMENTOS DO DOM ===================== */
const DOM = {
  status: document.getElementById('status'),
  diag: document.getElementById('diag'),
  uploadInfo: document.getElementById('uploadInfo'),
  fDe: document.getElementById('fDe'),
  fAte: document.getElementById('fAte'),
  periodoInfo: document.getElementById('periodoInfo'),
  segGlobal: document.getElementById('segGlobal'),
  top6Center: document.getElementById('top6Center'),
  fileExcel: document.getElementById('fileExcel'),
  chips: [...document.querySelectorAll('.chip')],
  kpis: [...document.querySelectorAll('.kpi[data-kpi]')],
};

/* ===================== INICIALIZAÇÃO ===================== */
const supa = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON);
const multiSelects = {
  unids: MultiSelect('ms-unids', 'Todas as unidades'),
  lojas: MultiSelect('ms-lojas', 'Todas as lojas'),
  canais: MultiSelect('ms-canais', 'Todos os canais'),
  turnos: MultiSelect('ms-turnos', 'Todos os turnos'),
  pags: MultiSelect('ms-pags', 'Todos os tipos'),
  cancel: MultiSelect('ms-cancel', 'Todos'),
};

/* ===================== HELPERS E FORMATADORES ===================== */
const setStatus = (text, type) => {
  DOM.status.textContent = text;
  DOM.status.style.color = type === 'err' ? '#ef4444' : type === 'ok' ? '#10b981' : '#667085';
};
const money = v => (v == null || !isFinite(+v)) ? 'R$ 0,00' : 'R$ ' + (+v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const num = v => (v == null || !isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
const pctf = v => (v == null || !isFinite(+v)) ? '0,0%' : ((+v) * 100).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
const iso = d => d.toISOString().slice(0, 10);
const addDaysISO = (isoStr, n) => { const d = new Date(`${isoStr}T00:00:00`); d.setDate(d.getDate() + n); return iso(d); };
const daysLen = (de, ate) => { const d1 = new Date(`${de}T00:00:00`), d2 = new Date(`${ate}T00:00:00`); return Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1; };

/* ===================== COMPONENTE MULTISELECT ===================== */
function MultiSelect(rootId, placeholder) {
  const root = document.getElementById(rootId);
  if (!root) return { setOptions: () => {}, get: () => [], set: () => {} };
  const btn = root.querySelector('.msel-btn');
  const panel = root.querySelector('.msel-panel');
  let options = [], selected = new Set(), filtered = [];

  function renderOptions() {
    const container = document.createElement('div');
    (filtered.length ? filtered : options).forEach(value => {
      const row = document.createElement('div');
      row.className = 'msel-opt';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = value;
      cb.checked = selected.has(value);
      const uniqueId = `${rootId}-${value.replace(/[^a-zA-Z0-9]/g, '-')}`;
      cb.id = uniqueId;
      const lb = document.createElement('label');
      lb.textContent = value;
      lb.htmlFor = uniqueId;
      row.addEventListener('click', (e) => {
        if (e.target !== cb) cb.click();
      });
      cb.addEventListener('change', () => {
        cb.checked ? selected.add(value) : selected.delete(value);
        updateButtonText();
        applyAll();
        resetAutoCollapse();
      });
      row.append(cb, lb);
      container.appendChild(row);
    });

    const oldOptions = panel.querySelector('div');
    if(oldOptions) oldOptions.remove();
    panel.appendChild(container);
  }

  function createPanel() {
    panel.innerHTML = '';
    const searchInput = document.createElement('input');
    searchInput.className = 'msel-search';
    searchInput.placeholder = 'Filtrar…';
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      filtered = options.filter(v => v.toLowerCase().includes(query));
      renderOptions();
      resetAutoCollapse();
    });
    panel.appendChild(searchInput);
    renderOptions();
  }

  function updateButtonText() {
    btn.textContent = selected.size === 0 ? placeholder : `${selected.size} selecionado(s)`;
  }

  btn.addEventListener('click', (e) => { e.stopPropagation(); root.classList.toggle('open'); resetAutoCollapse(); });
  document.addEventListener('click', () => { root.classList.remove('open'); });

  return {
    setOptions(list, keepOrder = false) {
      options = [...new Set((list || []).filter(v => v != null).map(String))];
      if (!keepOrder) options.sort((a, b) => a.localeCompare(b, 'pt-BR'));
      filtered = [...options];
      selected = new Set([...selected].filter(v => options.includes(v)));
      createPanel();
      updateButtonText();
    },
    get() { return [...selected]; },
    set(vals) { selected = new Set((vals || []).map(String)); updateButtonText(); if(panel.querySelector('.msel-search')) renderOptions(); }
  };
}


/* ===================== LÓGICA DE FILTROS E PERÍODO ===================== */
function applyQuickPeriod(days) {
  DOM.chips.forEach(c => c.classList.toggle('active', c.dataset.q === String(days)));
  const endDate = state.lastDay || iso(new Date());
  const startDate = addDaysISO(endDate, -(Number(days) - 1));
  DOM.fDe.value = startDate;
  DOM.fAte.value = endDate;
  DOM.periodoInfo.textContent = `Último dia carregado: ${state.lastDay || 'Nenhum'}`;
  applyAll();
}

// O restante do seu código JavaScript (funções de cálculo, gráficos, etc.) permanece aqui.
// ...
// A ÚNICA MUDANÇA SIGNIFICATIVA ESTÁ NA FUNÇÃO init() NO FINAL DO ARQUIVO.
// ... (todas as outras funções que já corrigimos antes) ...

/* ===================== ATUALIZAÇÃO DE KPIs ===================== */
async function updateKPIs() { /* ...código mantido... */ }
/* ===================== CONFIGURAÇÃO E CRIAÇÃO DE GRÁFICOS ===================== */
function setupChartDefaults() { /* ...código mantido... */ }
function createBarChart(canvasId, labels, nowArr, prevArr, tooltipExtra = '', fmt = 'money') { /* ...código mantido... */ }
/* ===================== ATUALIZAÇÃO DE GRÁFICOS (CLIENT-SIDE AGGREGATION) ===================== */
async function baseQuery(de, ate) { /* ...código mantido... */ }
function calculateMetricValue(acc, metric, mode) { /* ...código mantido... */ }
/* ===================== ATUALIZAÇÃO DE GRÁFICOS (ORQUESTRADOR) ===================== */
function updateChartTitles() { /* ...código mantido... */ }
async function updateStandardCharts() { /* ...código mantido... */ }
async function updateTop6Chart() { /* ...código mantido... */ }
function createDonutChart(canvasId, labels, values) { /* ...código mantido... */ }
/* ===================== UPLOAD EXCEL ===================== */
/* ...código mantido... */
/* ===================== AUTO-COLLAPSE UI ===================== */
function resetAutoCollapse() { /* ...código mantido... */ }
/* ===================== LOOP PRINCIPAL ===================== */
async function applyAll() { /* ...código mantido... */ }


/* ===================== INICIALIZAÇÃO DA PÁGINA (VERSÃO ROBUSTA) ===================== */
async function init() {
  	setStatus('Carregando interface…');
  	setupChartDefaults();

    // Tenta carregar os dados essenciais, mas não quebra a aplicação se falhar
  	try {
      const { data, error } = await supa.from(CONFIG.DB.DATE_RANGE_VIEW).select('min_dia, max_dia').limit(1);
      if (error) {
          // Lança o erro para ser pego pelo bloco catch externo.
          throw new Error(`Falha ao buscar range de datas: ${error.message}`);
      }
      if (data?.length) {
        state.firstDay = data[0].min_dia;
        state.lastDay = data[0].max_dia;
      }
  	} catch (e) {
      // Se a conexão com o banco falhar, informa o usuário claramente e continua.
      console.error('ERRO CRÍTICO DE INICIALIZAÇÃO:', e);
      setStatus('Falha ao conectar com o banco de dados.', 'err');
      DOM.periodoInfo.textContent = 'Verifique a conexão ou as permissões no Supabase (RLS).';
  	}

    // O resto da inicialização da UI acontece independentemente da conexão com o banco.
  	DOM.periodoInfo.textContent = `Último dia carregado: ${state.lastDay || 'Nenhum'}`;
  	
  	// TODO: Chamar uma função para carregar os filtros dinâmicos (unidades, lojas, etc.)
  	multiSelects.turnos.setOptions(['Dia', 'Noite']);
  	multiSelects.cancel.setOptions(['', 'Não', 'Sim']);
  	multiSelects.cancel.set(['Não']);

  	// Adicionar event listeners
  	DOM.chips.forEach(b => b.addEventListener('click', () => { resetAutoCollapse(); applyQuickPeriod(b.dataset.q); }));
  	document.getElementById('btnClear').addEventListener('click', clearFilters);
  	[DOM.fDe, DOM.fAte].forEach(inp => inp.addEventListener('change', () => {
      DOM.chips.forEach(c => c.classList.remove('active'));
      applyAll();
      resetAutoCollapse();
  	}));
  	DOM.kpis.forEach(card => card.addEventListener('click', () => {
      state.selectedKPI = card.dataset.kpi;
      DOM.kpis.forEach(k => k.classList.toggle('active', k === card));
      updateChartTitles();
      applyAll();
      resetAutoCollapse();
  	}));
    DOM.segGlobal.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      state.chartModeGlobal = btn.dataset.mode;
      DOM.segGlobal.querySelectorAll('button').forEach(b => b.classList.toggle('active', b === btn));
      updateChartTitles();
      applyAll();
    });

  	updateChartTitles();
    // Inicia a primeira carga de dados. Se as datas não foram carregadas, usará a data atual como fallback.
  	applyQuickPeriod('30');
  	resetAutoCollapse();

    ['click','input','change','keydown','mousemove','wheel','touchstart'].forEach(ev=>{
      document.addEventListener(ev, ()=>resetAutoCollapse(), {passive:true});
    });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
