<!doctype html>
<html lang="pt-BR">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width,initial-scale=1"/>
Â  <title>DASHBOARD â€” CFO (v3.3.0 â€” Completo e Corrigido)</title>
Â  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%232f6ef7"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#2f6ef7;
Â  Â  Â  --ok:#10b981; --down:#ef4444;
Â  Â  Â  --chip:#f7e9ed; --bar:#334155; --wine:#7b1e3a; --wine-soft:#9c3554;
Â  Â  Â  --c-now:#7b1e3a; --c-now-soft:#9c3554; --c-prev:#94a3b8; --c-prev-soft:#cbd5e1;
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
Â  Â  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
Â  Â  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
Â  Â  h1{margin:0;font-size:28px;letter-spacing:.2px}
Â  Â  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
Â  Â  .btn.clear{gap:6px}
Â  Â  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;transition:max-height .25s ease}
Â  Â  .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
Â  Â  .sec-title{display:flex;align-items:center;gap:10px;font-weight:700}
Â  Â  .ico{width:16px;height:16px;color:#475569}
Â  Â  .muted{color:var(--muted)}
Â  Â  .row{display:grid;gap:12px}
Â  Â  .cols-3{grid-template-columns:repeat(3,1fr)}
Â  Â  .cols-2{grid-template-columns:repeat(2,1fr)}
Â  Â  input[type="date"], .msel-btn, .input{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:44px;font-size:16px}
Â  Â  input[type="date"]::-webkit-calendar-picker-indicator{transform:scale(1.2)}
Â  Â  .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
Â  Â  .chip{padding:10px 0;border:1px solid #efd5db;border-radius:10px;background:var(--chip);cursor:pointer;text-align:center;font-weight:800;color:#7b1e3a}
Â  Â  .chip.active{background:var(--c-now);border-color:var(--c-now);color:#fff;box-shadow:0 1px 0 rgba(123,30,58,.06)}
Â  Â  .msel{position:relative}
Â  Â  .msel-btn{cursor:pointer;text-align:left}
Â  Â  .msel-btn:after{content:"â–¾";float:right;color:#475569}
Â  Â  .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
Â  Â  .msel.open .msel-panel{display:block}
Â  Â  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
Â  Â  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;cursor:pointer}
Â  Â  .msel-opt:hover{background:#f3f4f6}
    .msel-opt label { cursor: pointer; flex: 1; }
Â  Â  .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
Â  Â  .kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05);cursor:pointer;transition:border-color .15s ease, box-shadow .15s ease, transform .02s ease}
Â  Â  .kpi:active{transform:scale(.995)}
Â  Â  .kpi.active{border-color:var(--c-now);box-shadow:0 0 0 4px rgba(123,30,58,.06)}
Â  Â  .kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
Â  Â  .kpi h4 .spacer{flex:1}
Â  Â  .kpi .val{font-size:22px;font-weight:800}
Â  Â  .kpi .accent{height:2px;background:var(--wine);border-radius:999px;margin:6px 0 6px 0;opacity:.95}
Â  Â  .kpi .sub{font-size:12px;color:#667085;margin-top:2px}
Â  Â  .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:12px;margin-left:12px;background:rgba(148,163,184,.15);color:#64748b}
Â  Â  .delta svg{width:12px;height:12px}
Â  Â  .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
Â  Â  .delta.down{background:rgba(148,163,184,.15);border-color:rgba(148,163,184,.35);color:#64748b}
Â  Â  .delta.flat{background:#f1f5f9;border-color:#e2e8f0;color:#64748b}
Â  Â  .chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
Â  Â  .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
Â  Â  .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
Â  Â  .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:800}
Â  Â  .seg button.active{background:var(--c-now);color:#fff}
Â  Â  .chart-box{height:280px;position:relative}
Â  Â  .chart-box canvas{display:block;width:100%;height:100%}
Â  Â  .chart-card.wide{grid-column:span 2}
Â  Â  .chart-card.wide .chart-box{height:360px}
Â  Â  .center-link{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.92);border:1px solid var(--line);padding:4px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;color:#334155;white-space:nowrap}
Â  Â  .section.collapsed .row, .section.collapsed #periodoInfo, .section.collapsed .upload-info{display:none}
Â  Â  .section.collapsed .sec-head{cursor:pointer}
Â  Â  .diag{font-size:12px;color:#475569;margin-left:8px}
Â  Â  .upload-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
Â  Â  .upload-info{margin-top:8px;font-size:12px;color:#475569}
Â  Â  @media (max-width:1024px){.cols-3,.krow{grid-template-columns:repeat(2,1fr)}.cols-2,.chart-card.wide{grid-template-columns:1fr}}
Â  Â  @media (max-width:640px){.cols-3,.krow{grid-template-columns:1fr}}
Â  </style>
</head>
<body>
Â  <div class="wrap">
Â  Â  <div class="top">
Â  Â  Â  <h1>DASHBOARD</h1>
Â  Â  Â  <div class="upload-bar">
Â  Â  Â  Â  <button id="btnUpload" class="btn">ðŸ“¤ Carregar Excel</button>
Â  Â  Â  Â  <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="secDatas" class="section">
Â  Â  Â  <div class="sec-head">
Â  Â  Â  Â  <div class="sec-title">
Â  Â  Â  Â  Â  <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
Â  Â  Â  Â  Â  Filtros de Data
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="btnClear" class="btn clear">âœ– Limpar filtros</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="row cols-3">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Intervalo (inÃ­cio)</div>
Â  Â  Â  Â  Â  <input type="date" id="fDe">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Intervalo (fim)</div>
Â  Â  Â  Â  Â  <input type="date" id="fAte">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">PerÃ­odo rÃ¡pido</div>
Â  Â  Â  Â  Â  <div class="chips">
Â  Â  Â  Â  Â  Â  <button class="chip" data-q="7">07</button>
Â  Â  Â  Â  Â  Â  <button class="chip" data-q="15">15</button>
Â  Â  Â  Â  Â  Â  <button class="chip active" data-q="30">30</button>
Â  Â  Â  Â  Â  Â  <button class="chip" data-q="60">60</button>
Â  Â  Â  Â  Â  Â  <button class="chip" data-q="90">90</button>
Â  Â  Â  Â  Â  Â  <button class="chip" data-q="120">120</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="secFiltros" class="section">
Â  Â  Â  <div class="sec-head">
Â  Â  Â  Â  <div class="sec-title">
Â  Â  Â  Â  Â  <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
Â  Â  Â  Â  Â  Filtros
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <span id="status" class="muted">â€”</span>
Â  Â  Â  Â  Â  <span id="diag" class="diag"></span>
Â  Â  Â  Â  Â  <div id="uploadInfo" class="upload-info"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="row cols-3">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Unidade</div>
Â  Â  Â  Â  Â  <div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Nome da Loja</div>
Â  Â  Â  Â  Â  <div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Turno da Venda</div>
Â  Â  Â  Â  Â  <div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="row cols-3" style="margin-top:10px;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Canal de Venda</div>
Â  Â  Â  Â  Â  <div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Tipo de Pagamento</div>
Â  Â  Â  Â  Â  <div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px;">Cancelado</div>
Â  Â  Â  Â  Â  <div id="ms-cancel" class="msel">
Â  Â  Â  Â  Â  Â  <button class="msel-btn">NÃ£o</button>
Â  Â  Â  Â  Â  Â  <div class="msel-panel"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="krow">
Â  Â  Â  <div class="kpi" data-kpi="ped">
Â  Â  Â  Â  <h4><span>Pedidos</span><span class="spacer"></span><span id="d_ped" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_ped">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_ped">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi" data-kpi="tkt">
Â  Â  Â  Â  <h4><span>Ticket MÃ©dio</span><span class="spacer"></span><span id="d_tkt" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_tkt">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_tkt">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi active" data-kpi="fat">
Â  Â  Â  Â  <h4><span>Faturamento</span><span class="spacer"></span><span id="d_fat" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_fat">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_fat">â€”</span></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="krow" style="margin-top:12px;">
Â  Â  Â  <div class="kpi" data-kpi="fatmed">
Â  Â  Â  Â  <h4><span>Faturamento MÃ©dio</span><span class="spacer"></span><span id="d_fatmed" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_fatmed">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_fatmed">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi" data-kpi="des">
Â  Â  Â  Â  <h4><span>Incentivos</span><span class="spacer"></span><span id="d_des" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_des">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_des">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi" data-kpi="desperc">
Â  Â  Â  Â  <h4><span>% de Incentivos</span><span class="spacer"></span><span id="d_desperc" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_desperc">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_desperc">â€”</span></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="krow" style="margin-top:12px;">
Â  Â  Â  <div class="kpi" data-kpi="fre">
Â  Â  Â  Â  <h4><span>Frete</span><span class="spacer"></span><span id="d_fre" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_fre">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_fre">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi" data-kpi="fremed">
Â  Â  Â  Â  <h4><span>Frete MÃ©dio</span><span class="spacer"></span><span id="d_fremed" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_fremed">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_fremed">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi" data-kpi="canc_ped">
Â  Â  Â  Â  <h4><span>Pedidos Cancelados</span><span class="spacer"></span><span id="d_canc_ped" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_canc_ped">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">ParticipaÃ§Ã£o: <span id="k_canc_part">â€”</span> (Anterior: <span id="p_canc_part">â€”</span>)</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="krow" style="margin-top:12px;">
Â  Â  Â  <div class="kpi" data-kpi="canc_val">
Â  Â  Â  Â  <h4><span>Valor de Cancelados</span><span class="spacer"></span><span id="d_canc_val" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_canc_val">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_canc_val">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="kpi" data-kpi="roi">
Â  Â  Â  Â  <h4><span>ROI</span><span class="spacer"></span><span id="d_roi" class="delta flat">â€”</span></h4>
Â  Â  Â  Â  <div class="val" id="k_roi">â€”</div>
Â  Â  Â  Â  <div class="accent"></div>
Â  Â  Â  Â  <div class="sub">Anterior: <span id="p_roi">â€”</span></div>
Â  Â  Â  </div>
Â  Â  Â  <div></div>
Â  Â  </div>

Â  Â  <div class="section">
Â  Â  Â  <div class="sec-head">
Â  Â  Â  Â  <div class="sec-title">GrÃ¡ficos</div>
Â  Â  Â  Â  <div id="segGlobal" class="seg">
Â  Â  Â  Â  Â  <button class="active" data-mode="total">Total</button>
Â  Â  Â  Â  Â  <button data-mode="media">MÃ©dia</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="row cols-2">
Â  Â  Â  Â  <div class="chart-card wide">
Â  Â  Â  Â  Â  <div class="chart-head"><div class="muted" id="title_month">Vendas por mÃªs â€” Ãºltimos 12M vs. 12M anteriores</div></div>
Â  Â  Â  Â  Â  <div class="chart-box"><canvas id="ch_month"></canvas></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  <div class="chart-head"><div class="muted" id="title_dow">Vendas por dia da semana</div></div>
Â  Â  Â  Â  Â  <div class="chart-box"><canvas id="ch_dow"></canvas></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  <div class="chart-head"><div class="muted" id="title_hour">Vendas por hora</div></div>
Â  Â  Â  Â  Â  <div class="chart-box"><canvas id="ch_hour"></canvas></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  <div class="chart-head"><div class="muted" id="title_turno">Vendas por turno</div></div>
Â  Â  Â  Â  Â  <div class="chart-box"><canvas id="ch_turno"></canvas></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  <div class="chart-head"><div class="muted" id="title_top6">ParticipaÃ§Ã£o por loja â€” Top 6</div></div>
Â  Â  Â  Â  Â  <div class="chart-box">
Â  Â  Â  Â  Â  Â  <canvas id="ch_top6"></canvas>
Â  Â  Â  Â  Â  Â  <button id="top6Center" class="center-link">Total: R$ 0,00</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

Â  <script>
"use strict";

/* ===================== CONFIGURAÃ‡ÃƒO CENTRALIZADA ===================== */
const CONFIG = {
Â  SUPABASE_URL: 'https://msmyfxgrnuusnvoqyeuo.supabase.co',
Â  SUPABASE_ANON: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U',
Â  DB: {
Â  Â  READ_VIEW: 'vendas_canon',
Â  Â  DATE_RANGE_VIEW: 'vw_vendas_daterange',
Â  Â  DEST_INSERT_TABLE: 'vendas_xlsx',
Â  Â  REFRESH_RPC: 'refresh_sales_materialized',
Â  Â  RPC_FN: {
Â  Â  Â  kpi: 'kpi_vendas',
Â  Â  Â  kpi_v2: 'kpi_vendas_v2',
Â  Â  Â  dow: 'chart_vendas_dow_v1',
Â  Â  Â  month: 'chart_vendas_mes_v1',
Â  Â  Â  hour: 'chart_vendas_hora_v1',
Â  Â  Â  turno: 'chart_vendas_turno_v1',
Â  Â  },
Â  },
Â  KPI_META: {
Â  Â  fat:Â  Â  Â { label: 'Faturamento',Â  Â  Â  Â  Â  fmt: 'money',Â  Â  forceMode: null,Â  needsCancel: null },
Â  Â  ped:Â  Â  Â { label: 'Pedidos',Â  Â  Â  Â  Â  Â  Â  fmt: 'count',Â  Â  forceMode: null,Â  needsCancel: null },
Â  Â  tkt:Â  Â  Â { label: 'Ticket mÃ©dio',Â  Â  Â  Â  Â  fmt: 'money',Â  Â  forceMode: 'media', needsCancel: null },
Â  Â  des:Â  Â  Â { label: 'Incentivos',Â  Â  Â  Â  Â  Â  fmt: 'money',Â  Â  forceMode: null,Â  needsCancel: null },
Â  Â  desperc: { label: '% de incentivos',Â  Â  Â  Â fmt: 'percent',Â  forceMode: 'media', needsCancel: null },
Â  Â  fre:Â  Â  Â { label: 'Frete',Â  Â  Â  Â  Â  Â  Â  Â  Â fmt: 'money',Â  Â  forceMode: null,Â  needsCancel: null },
Â  Â  fremed:Â  { label: 'Frete mÃ©dio',Â  Â  Â  Â  Â  Â fmt: 'money',Â  Â  forceMode: 'media', needsCancel: null },
Â  Â  fatmed:Â  { label: 'Faturamento mÃ©dio',Â  Â  Â fmt: 'money',Â  Â  forceMode: 'media', needsCancel: null },
Â  Â  canc_ped:{ label: 'Pedidos cancelados',Â  Â  fmt: 'count',Â  Â  forceMode: null,Â  needsCancel: 'Sim' },
Â  Â  canc_val:{ label: 'Valor de cancelados',Â  Â fmt: 'money',Â  Â  forceMode: null,Â  needsCancel: 'Sim' },
Â  	roi:Â  Â  Â  { label: 'ROI',Â  Â  Â  Â  Â  Â  Â  Â  Â  Â fmt: 'percent',Â  forceMode: 'media', needsCancel: null },
Â  },
Â  CHART_COLORS: ["#7b1e3a", "#8c2947", "#9c3554", "#ad4061", "#bd4c6e", "#ce577b"],
};

/* ===================== ESTADO DA APLICAÃ‡ÃƒO ===================== */
const state = {
Â  firstDay: '',
Â  lastDay: '',
Â  selectedKPI: 'fat',
Â  chartModeGlobal: 'total',
Â  lastPrevRange: { dePrev: null, atePrev: null },
Â  collapseTimer: null,
};

/* ===================== ELEMENTOS DO DOM ===================== */
const DOM = {
Â  status: document.getElementById('status'),
Â  diag: document.getElementById('diag'),
Â  uploadInfo: document.getElementById('uploadInfo'),
Â  fDe: document.getElementById('fDe'),
Â  fAte: document.getElementById('fAte'),
Â  periodoInfo: document.getElementById('periodoInfo'),
Â  segGlobal: document.getElementById('segGlobal'),
Â  top6Center: document.getElementById('top6Center'),
Â  fileExcel: document.getElementById('fileExcel'),
Â  chips: [...document.querySelectorAll('.chip')],
Â  kpis: [...document.querySelectorAll('.kpi[data-kpi]')],
};

/* ===================== INICIALIZAÃ‡ÃƒO ===================== */
const supa = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON);
const multiSelects = {
Â  unids: MultiSelect('ms-unids', 'Todas as unidades'),
Â  lojas: MultiSelect('ms-lojas', 'Todas as lojas'),
Â  canais: MultiSelect('ms-canais', 'Todos os canais'),
Â  turnos: MultiSelect('ms-turnos', 'Todos os turnos'),
Â  pags: MultiSelect('ms-pags', 'Todos os tipos'),
Â  cancel: MultiSelect('ms-cancel', 'Todos'),
};

/* ===================== HELPERS E FORMATADORES ===================== */
const setStatus = (text, type) => {
Â  DOM.status.textContent = text;
Â  DOM.status.style.color = type === 'err' ? '#ef4444' : type === 'ok' ? '#10b981' : '#667085';
};
const money = v => (v == null || !isFinite(+v)) ? 'R$ 0,00' : 'R$ ' + (+v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const num = v => (v == null || !isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
const pctf = v => (v == null || !isFinite(+v)) ? '0,0%' : ((+v) * 100).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
const iso = d => d.toISOString().slice(0, 10);
const addDaysISO = (isoStr, n) => { const d = new Date(`${isoStr}T00:00:00`); d.setDate(d.getDate() + n); return iso(d); };
const daysLen = (de, ate) => { const d1 = new Date(`${de}T00:00:00`), d2 = new Date(`${ate}T00:00:00`); return Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1; };

/* ===================== COMPONENTE MULTISELECT ===================== */
function MultiSelect(rootId, placeholder) {
Â  const root = document.getElementById(rootId);
  if (!root) return { setOptions: () => {}, get: () => [], set: () => {} };
Â  const btn = root.querySelector('.msel-btn');
  const panel = root.querySelector('.msel-panel');
Â  let options = [], selected = new Set(), filtered = [];

Â  function renderOptions() {
Â  Â  const container = document.createElement('div');
Â  Â  (filtered.length ? filtered : options).forEach(value => {
Â  Â  Â  const row = document.createElement('div');
Â  Â  Â  row.className = 'msel-opt';
Â  Â  Â  const cb = document.createElement('input');
Â  Â  Â  cb.type = 'checkbox';
Â  Â  Â  cb.value = value;
Â  Â  Â  cb.checked = selected.has(value);
Â  Â  Â  const uniqueId = `${rootId}-${value.replace(/[^a-zA-Z0-9]/g, '-')}`;
Â  Â  Â  cb.id = uniqueId;
Â  Â  Â  const lb = document.createElement('label');
Â  Â  Â  lb.textContent = value;
Â  Â  Â  lb.htmlFor = uniqueId;
Â  Â  Â  row.addEventListener('click', (e) => {
        if (e.target !== cb) cb.click();
      });
Â  Â  Â  cb.addEventListener('change', () => {
Â  Â  Â  Â  cb.checked ? selected.add(value) : selected.delete(value);
Â  Â  Â  Â  updateButtonText();
Â  Â  Â  Â  applyAll();
Â  Â  Â  Â  resetAutoCollapse();
Â  Â  Â  });
Â  Â  Â  row.append(cb, lb);
Â  Â  Â  container.appendChild(row);
Â  Â  });

Â  Â  const oldOptions = panel.querySelector('div');
Â  Â  if(oldOptions) oldOptions.remove();
Â  Â  panel.appendChild(container);
Â  }

Â  function createPanel() {
Â  Â  panel.innerHTML = '';
Â  Â  const searchInput = document.createElement('input');
Â  Â  searchInput.className = 'msel-search';
Â  Â  searchInput.placeholder = 'Filtrarâ€¦';
Â  Â  searchInput.addEventListener('input', () => {
Â  Â  Â  const query = searchInput.value.toLowerCase();
Â  Â  Â  filtered = options.filter(v => v.toLowerCase().includes(query));
Â  Â  Â  renderOptions();
Â  Â  Â  resetAutoCollapse();
Â  Â  });
Â  Â  panel.appendChild(searchInput);
Â  Â  renderOptions();
Â  }

Â  function updateButtonText() {
Â  Â  btn.textContent = selected.size === 0 ? placeholder : `${selected.size} selecionado(s)`;
Â  }

Â  btn.addEventListener('click', (e) => { e.stopPropagation(); root.classList.toggle('open'); resetAutoCollapse(); });
Â  document.addEventListener('click', () => { root.classList.remove('open'); });

Â  return {
Â  Â  setOptions(list, keepOrder = false) {
Â  Â  Â  options = [...new Set((list || []).filter(v => v != null).map(String))];
Â  Â  Â  if (!keepOrder) options.sort((a, b) => a.localeCompare(b, 'pt-BR'));
Â  Â  Â  filtered = [...options];
Â  Â  Â  selected = new Set([...selected].filter(v => options.includes(v)));
Â  Â  Â  createPanel();
Â  Â  Â  updateButtonText();
Â  Â  },
Â  Â  get() { return [...selected]; },
Â  Â  set(vals) { selected = new Set((vals || []).map(String)); updateButtonText(); if(panel.querySelector('.msel-search')) renderOptions(); }
Â  };
}


/* ===================== LÃ“GICA DE FILTROS E PERÃODO ===================== */
function computePrevRangeISO(deISO, ateISO) {
Â  const d1 = new Date(`${deISO}T00:00:00`), d2 = new Date(`${ateISO}T00:00:00`);
Â  const lastDayOfMonth = (y, m) => new Date(y, m + 1, 0).getDate();
Â  const isFullMonthsAligned = d1.getDate() === 1 && d2.getDate() === lastDayOfMonth(d2.getFullYear(), d2.getMonth());

Â  if (isFullMonthsAligned) {
Â  Â  const p1 = new Date(d1); p1.setFullYear(p1.getFullYear() - 1);
Â  Â  const p2 = new Date(d2); p2.setFullYear(p2.getFullYear() - 1);
Â  Â  return { dePrev: iso(p1), atePrev: iso(p2) };
Â  }

Â  const len = daysLen(deISO, ateISO);
Â  const atePrev = new Date(d1.getTime() - 86400000);
Â  const dePrev = new Date(atePrev.getTime() - (len - 1) * 86400000);
Â  return { dePrev: iso(dePrev), atePrev: iso(atePrev) };
}

function applyQuickPeriod(days) {
Â  DOM.chips.forEach(c => c.classList.toggle('active', c.dataset.q === String(days)));
Â  const endDate = state.lastDay || iso(new Date());
Â  const startDate = addDaysISO(endDate, -(Number(days) - 1));
Â  DOM.fDe.value = startDate;
Â  DOM.fAte.value = endDate;
Â  DOM.periodoInfo.textContent = `Ãšltimo dia carregado: ${state.lastDay || 'Nenhum'}`;
Â  applyAll();
}

function clearFilters() {
Â  Object.values(multiSelects).forEach(ms => ms.set([]));
Â  multiSelects.cancel.set(['NÃ£o']);
Â  applyQuickPeriod('30');
}

/* ===================== LÃ“GICA DE DADOS (API E CÃLCULOS) ===================== */
function buildQueryParams(de, ate, overrideCancel = null) {
Â  const getMultiSelect = (ms) => ms.get().length ? ms.get() : null;
Â  let p_cancelado = null;
Â  if (overrideCancel) {
Â  Â  p_cancelado = overrideCancel;
Â  } else {
Â  Â  const canc = multiSelects.cancel.get();
Â  Â  if (canc.length === 1 && ['Sim', 'NÃ£o'].includes(canc[0])) p_cancelado = canc[0];
Â  }
Â  return {
Â  Â  p_dini: de, p_dfim: ate,
Â  Â  p_unids: getMultiSelect(multiSelects.unids),
Â  Â  p_lojas: getMultiSelect(multiSelects.lojas),
Â  Â  p_turnos: getMultiSelect(multiSelects.turnos),
Â  Â  p_canais: getMultiSelect(multiSelects.canais),
Â  Â  p_pags: getMultiSelect(multiSelects.pags),
Â  Â  p_cancelado,
Â  };
}

function getKpiRpcName(params) {
Â  return params.p_unids ? CONFIG.DB.RPC_FN.kpi_v2 : CONFIG.DB.RPC_FN.kpi;
}

function prepareKpiRpcArgs(name, params) {
Â  if (name === CONFIG.DB.RPC_FN.kpi) {
Â  Â  const { p_unids, ...rest } = params;
Â  Â  return rest;
Â  }
Â  return params;
}

function aggregateRows(rows) {
Â  return (rows || []).reduce((acc, r) => ({
Â  Â  ped: acc.ped + (+r.pedidos || 0),
Â  Â  fat: acc.fat + (+r.fat || 0),
Â  Â  des: acc.des + (+r.des || 0),
Â  Â  fre: acc.fre + (+r.fre || 0),
Â  }), { ped: 0, fat: 0, des: 0, fre: 0 });
}

/* ===================== ATUALIZAÃ‡ÃƒO DE KPIs ===================== */
function deltaBadge(element, current, previous) {
Â  if (!element) return;
Â  if (!isFinite(previous) || +previous === 0) {
Â  Â  element.textContent = 'â€”';
Â  Â  element.className = 'delta flat';
Â  Â  return;
Â  }
Â  const diff = ((current - previous) / previous) * 100;
Â  const upSVG = '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>';
Â  const downSVG = '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>';
Â  element.innerHTML = `${diff >= 0 ? upSVG : downSVG} ${Math.abs(diff).toFixed(1)}%`;
Â  element.className = `delta ${diff >= 0 ? 'up' : 'down'}`;
}

async function updateKPIs() {
Â  const de = DOM.fDe.value || state.firstDay;
Â  const ate = DOM.fAte.value || state.lastDay;
Â  const { dePrev, atePrev } = computePrevRangeISO(de, ate);
Â  state.lastPrevRange = { dePrev, atePrev };

Â  const pNow = buildQueryParams(de, ate);
Â  const pPrev = buildQueryParams(dePrev, atePrev);
Â  const nameNow = getKpiRpcName(pNow), namePrev = getKpiRpcName(pPrev);

Â  const [nowRes, prevRes, cNowRes, cPrevRes] = await Promise.all([
Â  Â  supa.rpc(nameNow, prepareKpiRpcArgs(nameNow, pNow)),
Â  Â  supa.rpc(namePrev, prepareKpiRpcArgs(namePrev, pPrev)),
Â  Â  supa.rpc(nameNow, prepareKpiRpcArgs(nameNow, { ...pNow, p_cancelado: 'Sim' })),
Â  Â  supa.rpc(namePrev, prepareKpiRpcArgs(namePrev, { ...pPrev, p_cancelado: 'Sim' })),
Â  ]);

Â  if (nowRes.error) throw nowRes.error;
Â  if (prevRes.error) throw prevRes.error;

Â  const N = aggregateRows(nowRes.data);
Â  const P = aggregateRows(prevRes.data);
Â  const CN = aggregateRows(cNowRes.data);
Â  const CP = aggregateRows(cPrevRes.data);

Â  const len = daysLen(de, ate);
Â  const tktN = N.ped > 0 ? (N.fat / N.ped) : 0, tktP = P.ped > 0 ? (P.fat / P.ped) : 0;
Â  const fatMedN = len ? (N.fat / len) : 0, fatMedP = len ? (P.fat / len) : 0;
Â  const desPercN = N.fat > 0 ? (N.des / N.fat) : 0, desPercP = P.fat > 0 ? (P.des / P.fat) : 0;
Â  const freMedN = N.ped > 0 ? (N.fre / N.ped) : 0, freMedP = P.ped > 0 ? (P.fre / P.ped) : 0;
Â  const partCancN = N.ped > 0 ? (CN.ped / N.ped) : 0, partCancP = P.ped > 0 ? (CP.ped / P.ped) : 0;
Â  const roiN = N.des > 0 ? (N.fat - N.des) / N.des : NaN;
Â  const roiP = P.des > 0 ? (P.fat - P.des) / P.des : NaN;
Â  
Â  const updateKpiDom = (kpi, val, prev, deltaVal, deltaPrev) => {
Â  Â  const valElem = document.getElementById(`k_${kpi}`);
Â  Â  const prevElem = document.getElementById(`p_${kpi}`);
Â  Â  const deltaElem = document.getElementById(`d_${kpi}`);
Â    if (valElem) valElem.textContent = val;
Â    if (prevElem) prevElem.textContent = prev;
Â    deltaBadge(deltaElem, deltaVal, deltaPrev);
Â  };

Â  updateKpiDom('ped', num(N.ped), num(P.ped), N.ped, P.ped);
Â  updateKpiDom('tkt', money(tktN), money(tktP), tktN, tktP);
Â  updateKpiDom('fat', money(N.fat), money(P.fat), N.fat, P.fat);
Â  updateKpiDom('fatmed', money(fatMedN), money(fatMedP), fatMedN, fatMedP);
Â  updateKpiDom('des', money(N.des), money(P.des), N.des, P.des);
Â  updateKpiDom('desperc', pctf(desPercN), pctf(desPercP), desPercN, desPercP);
Â  updateKpiDom('fre', money(N.fre), money(P.fre), N.fre, P.fre);
Â  updateKpiDom('fremed', money(freMedN), money(freMedP), freMedN, freMedP);
Â  updateKpiDom('canc_ped', num(CN.ped), '', CN.ped, CP.ped);
Â  updateKpiDom('canc_val', money(CN.fat), money(CP.fat), CN.fat, CP.fat);
Â  updateKpiDom('roi', isFinite(roiN) ? pctf(roiN) : 'â€”', isFinite(roiP) ? pctf(roiP) : 'â€”', isFinite(roiN) ? roiN : 0, isFinite(roiP) ? roiP : 0);

Â  document.getElementById('k_canc_part').textContent = pctf(partCancN);
Â  document.getElementById('p_canc_part').textContent = pctf(partCancP);
}

/* ===================== CONFIGURAÃ‡ÃƒO E CRIAÃ‡ÃƒO DE GRÃFICOS ===================== */
function setupChartDefaults() {
Â  Chart.defaults.font.family = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu';
Â  Chart.defaults.color = '#334155';
Â  Chart.defaults.plugins.legend.position = 'top';
Â  Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.95)';
Â  Chart.defaults.plugins.tooltip.titleColor = '#e2e8f0';
Â  Chart.defaults.plugins.tooltip.bodyColor = '#e2e8f0';
Â  Chart.defaults.plugins.tooltip.borderColor = 'rgba(148,163,184,.25)';
Â  Chart.defaults.plugins.tooltip.borderWidth = 1;
Â  Chart.defaults.datasets.bar.borderRadius = 6;
Â  Chart.defaults.datasets.bar.borderSkipped = false;
Â  Chart.defaults.datasets.bar.maxBarThickness = 42;
Â  Chart.defaults.devicePixelRatio = Math.max(1, window.devicePixelRatio || 1);
}

const gradNow = ctx => { const g = ctx.createLinearGradient(0, 0, 0, 240); g.addColorStop(0, 'rgba(123,30,58,0.95)'); g.addColorStop(1, 'rgba(156,53,84,0.55)'); return g; };
const gradPrev = ctx => { const g = ctx.createLinearGradient(0, 0, 0, 240); g.addColorStop(0, 'rgba(148,163,184,0.85)'); g.addColorStop(1, 'rgba(203,213,225,0.45)'); return g; };

const formatTickBy = (fmt, v) => {
Â  if (fmt === 'count') return num(v);
Â  if (fmt === 'percent') return `${((Number(v) || 0) * 100).toFixed(0)}%`;
Â  const val = Number(v) || 0;
Â  if (Math.abs(val) >= 1e6) return `R$ ${(val / 1e6).toFixed(1).replace('.', ',')} mi`;
Â  if (Math.abs(val) >= 1e3) return `R$ ${(val / 1e3).toFixed(1).replace('.', ',')} mil`;
Â  return `R$ ${val.toFixed(0)}`;
};
const formatValueBy = (fmt, v) => {
Â  if (fmt === 'count') return num(v);
Â  if (fmt === 'percent') return pctf(v);
Â  return money(v);
};

function createBarChart(canvasId, labels, nowArr, prevArr, tooltipExtra = '', fmt = 'money') {
Â  const canvas = document.getElementById(canvasId);
Â  if (!canvas) return;
Â  if (canvas.__chart) canvas.__chart.destroy();
Â  const ctx = canvas.getContext('2d');
Â  canvas.__chart = new Chart(ctx, {
Â  Â  type: 'bar',
Â  Â  data: {
Â  Â  Â  labels,
Â  Â  Â  datasets: [
Â  Â  Â  Â  { label: 'Atual', data: nowArr.map(v => +v || 0), backgroundColor: gradNow(ctx) },
Â  Â  Â  Â  { label: 'Anterior', data: prevArr.map(v => +v || 0), backgroundColor: gradPrev(ctx) }
Â  Â  Â  ]
Â  Â  },
Â  Â  options: {
Â  Â  Â  responsive: true, maintainAspectRatio: false, animation: false,
Â  Â  Â  scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: (v) => formatTickBy(fmt, v) } } },
Â  Â  Â  plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false, callbacks: { label: (c) => `${c.dataset.label}: ${formatValueBy(fmt, c.parsed.y || 0)}`, footer: () => tooltipExtra } } }
Â  Â  }
Â  });
}

/* ===================== ATUALIZAÃ‡ÃƒO DE GRÃFICOS (CLIENT-SIDE AGGREGATION) ===================== */
async function baseQuery(de, ate) {
Â  const meta = CONFIG.KPI_META[state.selectedKPI] || CONFIG.KPI_META.fat;
Â  let q = supa.from(CONFIG.DB.READ_VIEW)
Â  Â  .select('dia,hora,turno,fat,des,fre,cancelado,loja,unidade,canal,pagamento_base')
Â  Â  .gte('dia', de).lte('dia', ate)
Â  Â  .order('dia', { ascending: true })
Â  Â  .range(0, 199999);

Â  const applyFilter = (col, ms) => { if (ms.get().length) q = q.in(col, ms.get()); };
Â  applyFilter('unidade', multiSelects.unids);
Â  applyFilter('loja', multiSelects.lojas);
Â  applyFilter('turno', multiSelects.turnos);
Â  applyFilter('canal', multiSelects.canais);
Â  applyFilter('pagamento_base', multiSelects.pags);
Â  
Â  const forcedCancel = meta.needsCancel;
Â  if (forcedCancel) {
Â  Â  q = q.eq('cancelado', forcedCancel);
Â  } else {
Â  Â  const canc = multiSelects.cancel.get();
Â  Â  if (canc.length === 1 && ['Sim', 'NÃ£o'].includes(canc[0])) q = q.eq('cancelado', canc[0]);
Â  }

Â  const { data, error } = await q;
Â  if (error) { console.error('[REST baseQuery]', error); throw error; }
Â  return data || [];
}

const bucketKey = (type, row) => {
Â  if (type === 'dow') return (new Date(`${row.dia}T00:00:00`)).getDay();
Â  if (type === 'hour') return row.hora ?? null;
Â  if (type === 'turno') return row.turno ?? null;
Â  if (type === 'month') { const d = new Date(`${row.dia}T00:00:00`); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }
Â  return null;
};

function calculateMetricValue(acc, metric, mode) {
Â  const effectiveMode = (CONFIG.KPI_META[metric]?.forceMode || mode);
Â  const divisor = effectiveMode === 'media' ? Math.max(1, acc.days.size) : 1;
Â  
Â  switch (metric) {
Â  Â  case 'fat': case 'des': case 'fre': case 'canc_val':
Â  Â  Â  return acc[metric] / divisor;
Â  	case 'ped': case 'canc_ped':
Â  Â  Â  return acc.ped / divisor;
Â  	case 'tkt': return acc.ped > 0 ? (acc.fat / acc.ped) : 0;
Â  	case 'desperc': return acc.fat > 0 ? (acc.des / acc.fat) : 0;
Â  	case 'fremed': return acc.ped > 0 ? (acc.fre / acc.ped) : 0;
Â  	case 'fatmed': return acc.fat / Math.max(1, acc.days.size);
Â  	case 'roi': return acc.des > 0 ? ((acc.fat - acc.des) / acc.des) : 0;
Â  	default: return acc.fat / divisor;
Â  }
}

function computeByBucket(rows, type, metric, mode) {
Â  const map = new Map();
Â  for (const r of rows) {
Â  Â  const key = bucketKey(type, r);
Â  Â  if (key == null) continue;
Â  Â  if (!map.has(key)) map.set(key, { fat: 0, des: 0, fre: 0, ped: 0, days: new Set() });
Â  Â  const acc = map.get(key);
Â  Â  acc.fat += +r.fat || 0;
Â  Â  acc.des += +r.des || 0;
Â  Â  acc.fre += +r.fre || 0;
Â  Â  acc.ped += 1;
Â  Â  acc.days.add(r.dia);
Â  }

Â  const result = [];
Â  map.forEach((acc, key) => {
Â  	result.push({ key, value: calculateMetricValue(acc, metric, mode) });
Â  });
Â  
Â  return result.sort((a, b) => {
Â  	if (['dow', 'hour'].includes(type)) return a.key - b.key;
Â  	return String(a.key).localeCompare(String(b.key), 'pt-BR');
Â  });
}

/* ===================== ATUALIZAÃ‡ÃƒO DE GRÃFICOS (ORQUESTRADOR) ===================== */
function updateChartTitles() {
Â  const meta = CONFIG.KPI_META[state.selectedKPI] || CONFIG.KPI_META.fat;
Â  const modeText = (meta.forceMode || state.chartModeGlobal) === 'media' ? ' (mÃ©dia)' : '';
Â  document.getElementById('title_month').textContent = `${meta.label}${modeText} por mÃªs â€” Ãºltimos 12M vs. 12M anteriores`;
Â  document.getElementById('title_dow').textContent = `${meta.label}${modeText} por dia da semana`;
Â  document.getElementById('title_hour').textContent = `${meta.label}${modeText} por hora`;
Â  document.getElementById('title_turno').textContent = `${meta.label}${modeText} por turno`;
Â  document.getElementById('title_top6').textContent = `ParticipaÃ§Ã£o por loja â€” Top 6 (${meta.label}${modeText})`;
}

async function updateStandardCharts() {
Â  try {
Â  Â  const de = DOM.fDe.value || state.firstDay;
Â  	const ate = DOM.fAte.value || state.lastDay;
Â  	const { dePrev, atePrev } = state.lastPrevRange;
Â  	const meta = CONFIG.KPI_META[state.selectedKPI] || CONFIG.KPI_META.fat;
Â  	const mode = meta.forceMode || state.chartModeGlobal;
Â  	const tip = `PerÃ­odo anterior: ${dePrev} â†’ ${atePrev}`;

Â  	const canUseRpc = state.selectedKPI === 'fat' && !meta.needsCancel;

Â  	if (canUseRpc) {
Â  Â  Â  const fetchRpc = (kind, d1, d2) => supa.rpc(CONFIG.DB.RPC_FN[kind], buildQueryParams(d1, d2)).then(r => r.data || []);
Â  Â  Â  const [nowD, prevD, nowH, prevH, nowT, prevT] = await Promise.all([
Â  Â  Â  Â  fetchRpc('dow', de, ate), fetchRpc('dow', dePrev, atePrev),
Â  Â  Â  Â  fetchRpc('hour', de, ate), fetchRpc('hour', dePrev, atePrev),
Â  Â  Â  Â  fetchRpc('turno', de, ate), fetchRpc('turno', dePrev, atePrev)
Â  Â  Â  ]);
      
Â  Â  Â  const dowLabels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
Â  Â  Â  const nDow = Array(7).fill(0), pDow = Array(7).fill(0);
Â  Â  Â  nowD.forEach(r => nDow[r.dow] = r[mode] || 0);
Â  Â  Â  prevD.forEach(r => pDow[r.dow] = r[mode] || 0);
Â  Â  Â  createBarChart('ch_dow', dowLabels, nDow, pDow, tip, meta.fmt);
      
      const allHours = Array.from({length: 24}, (_, i) => i);
      const nHour = new Map(nowH.map(r => [r.h, r[mode] || 0]));
      const pHour = new Map(prevH.map(r => [r.h, r[mode] || 0]));
      const activeHours = allHours.filter(h => nHour.has(h) || pHour.has(h));
      const hourLabels = activeHours.map(h => `${String(h).padStart(2, '0')}h`);
      createBarChart('ch_hour', hourLabels, activeHours.map(h => nHour.get(h) || 0), activeHours.map(h => pHour.get(h) || 0), tip, meta.fmt);

      const turnoOrder = ['Dia', 'Noite'];
      const nTurno = new Map(nowT.map(r => [r.turno, r[mode] || 0]));
      const pTurno = new Map(prevT.map(r => [r.turno, r[mode] || 0]));
      const activeTurnos = turnoOrder.filter(t => nTurno.has(t) || pTurno.has(t));
      createBarChart('ch_turno', activeTurnos, activeTurnos.map(t => nTurno.get(t) || 0), activeTurnos.map(t => pTurno.get(t) || 0), tip, meta.fmt);

Â  	} else {
Â  Â  Â  const [rowsNow, rowsPrev] = await Promise.all([baseQuery(de, ate), baseQuery(dePrev, atePrev)]);
Â  Â  Â  
Â  Â  Â  const dowLabels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
Â  Â  Â  const curD = new Map(computeByBucket(rowsNow, 'dow', state.selectedKPI, mode).map(o => [o.key, o.value]));
Â  Â  Â  const prvD = new Map(computeByBucket(rowsPrev, 'dow', state.selectedKPI, mode).map(o => [o.key, o.value]));
Â  Â  Â  createBarChart('ch_dow', dowLabels, dowLabels.map((_, i) => curD.get(i) || 0), dowLabels.map((_, i) => prvD.get(i) || 0), tip, meta.fmt);
      
      const allHours = Array.from({length: 24}, (_, i) => i);
      const curH = new Map(computeByBucket(rowsNow, 'hour', state.selectedKPI, mode).map(o => [o.key, o.value]));
      const prvH = new Map(computeByBucket(rowsPrev, 'hour', state.selectedKPI, mode).map(o => [o.key, o.value]));
      const activeHours = allHours.filter(h => curH.has(h) || prvH.has(h));
      const hourLabels = activeHours.map(h => `${String(h).padStart(2, '0')}h`);
      createBarChart('ch_hour', hourLabels, activeHours.map(h => curH.get(h) || 0), activeHours.map(h => prvH.get(h) || 0), tip, meta.fmt);

      const turnoOrder = ['Dia', 'Noite'];
      const curT = new Map(computeByBucket(rowsNow, 'turno', state.selectedKPI, mode).map(o => [o.key, o.value]));
      const prvT = new Map(computeByBucket(rowsPrev, 'turno', state.selectedKPI, mode).map(o => [o.key, o.value]));
      const activeTurnos = turnoOrder.filter(t => curT.has(t) || prvT.has(t));
      createBarChart('ch_turno', activeTurnos, activeTurnos.map(t => curT.get(t) || 0), activeTurnos.map(t => prvT.get(t) || 0), tip, meta.fmt);
Â  	}
Â  } catch (e) {
Â  	console.error('Erro ao atualizar grÃ¡ficos padrÃ£o:', e);
Â  }
}

async function updateTop6Chart() {
Â  try {
Â  	const de = DOM.fDe.value || state.firstDay;
Â  	const ate = DOM.fAte.value || state.lastDay;
Â  	const rows = await baseQuery(de, ate);
Â  	const byStore = new Map();

Â  	rows.forEach(r => {
Â  Â  Â  const key = r.loja || 'â€”';
Â  Â  Â  if (!byStore.has(key)) byStore.set(key, { fat: 0, des: 0, fre: 0, ped: 0, days: new Set() });
Â  Â  Â  const acc = byStore.get(key);
Â  Â  Â  acc.fat += +r.fat || 0;
Â  Â  Â  acc.des += +r.des || 0;
Â  Â  Â  acc.fre += +r.fre || 0;
Â  Â  Â  acc.ped += 1;
Â  Â  Â  acc.days.add(r.dia);
Â  	});
Â  	
Â  	const top6 = [...byStore.entries()]
Â  Â  Â  .map(([loja, acc]) => ({
Â  Â  Â  	label: loja,
Â  Â  Â  	value: calculateMetricValue(acc, state.selectedKPI, state.chartModeGlobal)
Â  Â  Â  }))
Â  Â  Â  .sort((a, b) => b.value - a.value)
Â  Â  Â  .slice(0, 6);

Â  	createDonutChart('ch_top6', top6.map(d => d.label), top6.map(d => d.value));
Â  } catch (e) {
Â  	console.warn('Erro Top 6:', e.message || e);
Â  	createDonutChart('ch_top6', [], []);
Â  }
}

function createDonutChart(canvasId, labels, values) {
Â  const canvas = document.getElementById(canvasId);
Â  if (!canvas) return;
Â  if (canvas.__chart) canvas.__chart.destroy();

Â  const total = values.reduce((a, b) => a + b, 0);
Â  const meta = CONFIG.KPI_META[state.selectedKPI] || CONFIG.KPI_META.fat;
Â  DOM.top6Center.textContent = `Total: ${formatValueBy(meta.fmt, total)}`;

Â  canvas.__chart = new Chart(canvas.getContext('2d'), {
Â  	type: 'doughnut',
Â  	data: { labels, datasets: [{ data: values, backgroundColor: CONFIG.CHART_COLORS, borderColor: '#fff', borderWidth: 1 }] },
Â  	options: {
Â  Â  Â  responsive: true, maintainAspectRatio: false, cutout: '60%',
Â  Â  Â  plugins: {
Â  Â  Â  	legend: { position: 'right', labels: { usePointStyle: true, pointStyle: 'circle', boxWidth: 10, padding: 16 } },
Â  Â  Â  	tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatValueBy(meta.fmt, ctx.parsed)} (${(total ? (ctx.parsed / total * 100) : 0).toFixed(1)}%)` } }
Â  Â  Â  }
Â  	}
Â  });
}

/* ===================== AUTO-COLLAPSE UI ===================== */
function resetAutoCollapse() {
Â  const sections = [document.getElementById('secDatas'), document.getElementById('secFiltros')];
Â  sections.forEach(s => s?.classList.remove('collapsed'));
Â  clearTimeout(state.collapseTimer);
Â  state.collapseTimer = setTimeout(() => {
Â  	sections.forEach(s => s?.classList.add('collapsed'));
Â  }, 15000);
}

/* ===================== LOOP PRINCIPAL ===================== */
async function applyAll() {
Â  try {
Â  	setStatus('Consultandoâ€¦');
Â  	
Â  	let kpiOk = true;
Â  	await updateKPIs().catch(e => {
Â  Â  Â  console.error('Erro ao atualizar KPIs:', e);
Â  Â  Â  kpiOk = false;
Â  	});

Â  	await Promise.all([
Â  Â  Â  updateStandardCharts(),
Â  Â  Â  updateTop6Chart(),
Â  	]);

Â  	setStatus(kpiOk ? 'OK' : 'OK (sem KPIs â€” RPC indisponÃ­vel)', kpiOk ? 'ok' : 'ok');
Â  	resetAutoCollapse();
Â  } catch (e) {
Â  	console.error('Erro na atualizaÃ§Ã£o principal:', e);
Â  	setStatus(`Erro: ${e.message || e}`, 'err');
Â  }
}


/* ===================== INICIALIZAÃ‡ÃƒO DA PÃGINA ===================== */
async function init() {
Â  	setStatus('Carregando interfaceâ€¦');
Â  	setupChartDefaults();

Â  	try {
Â  Â  Â  const { data, error } = await supa.from(CONFIG.DB.DATE_RANGE_VIEW).select('min_dia, max_dia').limit(1);
Â  Â  Â  if (error) {
          throw new Error(`Falha ao buscar range de datas: ${error.message}`);
      }
Â  Â  Â  if (data?.length) {
Â  Â  Â    state.firstDay = data[0].min_dia;
Â  Â  Â    state.lastDay = data[0].max_dia;
Â  Â  Â  }
Â  	} catch (e) {
Â  Â  Â  console.error('ERRO CRÃTICO DE INICIALIZAÃ‡ÃƒO:', e);
Â  Â  Â  setStatus('Falha ao conectar com o banco de dados.', 'err');
      DOM.periodoInfo.textContent = 'Verifique a conexÃ£o ou as permissÃµes no Supabase (RLS).';
Â  	}

Â  	DOM.periodoInfo.textContent = `Ãšltimo dia carregado: ${state.lastDay || 'Nenhum'}`;
Â  	
Â  	multiSelects.turnos.setOptions(['Dia', 'Noite']);
Â  	multiSelects.cancel.setOptions(['', 'NÃ£o', 'Sim']);
Â  Â  multiSelects.cancel.set(['NÃ£o']);

Â  	// Adicionar event listeners
Â  	DOM.chips.forEach(b => b.addEventListener('click', () => { resetAutoCollapse(); applyQuickPeriod(b.dataset.q); }));
Â  	document.getElementById('btnClear').addEventListener('click', clearFilters);
Â  	[DOM.fDe, DOM.fAte].forEach(inp => inp.addEventListener('change', () => {
Â  Â  Â  DOM.chips.forEach(c => c.classList.remove('active'));
Â  Â  Â  applyAll();
Â  Â  Â  resetAutoCollapse();
Â  	}));
Â  	DOM.kpis.forEach(card => card.addEventListener('click', () => {
Â  Â  Â  state.selectedKPI = card.dataset.kpi;
Â  Â  Â  DOM.kpis.forEach(k => k.classList.toggle('active', k === card));
Â  Â  Â  updateChartTitles();
Â  Â  Â  applyAll();
Â  Â  Â  resetAutoCollapse();
Â  	}));
    DOM.segGlobal.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      state.chartModeGlobal = btn.dataset.mode;
      DOM.segGlobal.querySelectorAll('button').forEach(b => b.classList.toggle('active', b === btn));
      updateChartTitles();
      applyAll();
    });

Â  	updateChartTitles();
Â  	applyQuickPeriod('30');
Â  	resetAutoCollapse();

    ['click','input','change','keydown','mousemove','wheel','touchstart'].forEach(ev=>{
      document.addEventListener(ev, ()=>resetAutoCollapse(), {passive:true});
    });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
