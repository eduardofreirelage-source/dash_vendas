<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maestro Food — XLSX (validação + KPIs)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--ink2:#cbd5e1;--mut:#9ca3af;--b:#1f2937;--brand:#3b82f6}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
  h1{margin:0 0 10px;font-size:22px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--b);border-radius:14px;padding:14px}
  label{display:block;color:var(--ink2);margin-bottom:6px}
  select,input[type=date],input[type=file]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--b);background:#0b1220;color:var(--ink)}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--b);background:#1f2937;color:#fff;cursor:pointer}
  .primary{background:var(--brand)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kpi{display:flex;flex-direction:column;gap:6px}.kpi .t{color:var(--ink2);font-size:12px}.kpi .v{font-size:22px;font-weight:700}
  .mut{color:var(--mut)}
  .hr{height:1px;background:var(--b);margin:10px 0}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--b);padding:8px 10px;white-space:nowrap;text-align:left}
  .progress{height:10px;background:#111827;border-radius:10px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#10b981,#22c55e)}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid var(--b);padding:10px;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food — XLSX (validação + KPIs)</h1>

  <!-- Health -->
  <div class="card">
    <div class="row">
      <button id="btnHealth" class="primary">Health</button>
      <div id="health" class="mut">—</div>
      <div class="mut">Fonte: vendas_xlsx · URL: uahmcfzerofhzjvlzrqc.supabase.co</div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card grid g4">
    <div><label>De</label><input type="date" id="dini"></div>
    <div><label>Até</label><input type="date" id="dfim"></div>
    <div><label>Unidade</label><select id="unidade"><option value="">Todas</option></select></div>
    <div><label>Loja (sem vazias/“Loja Centro”)</label><select id="loja"><option value="">Todas</option></select></div>
    <div><label>Canal</label><select id="canal"><option value="">Todos</option></select></div>
    <div><label>Pagamento</label><select id="pag"><option value="">Todos</option></select></div>
    <div><label>Cancelado?</label><select id="canc"><option>Não</option><option>Sim</option><option>Todos</option></select></div>
    <div style="display:flex;align-items:flex-end;gap:8px">
      <button id="apply" class="primary">Aplicar</button>
      <button id="clear">Limpar</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid g4">
    <div class="card kpi"><div class="t">Pedidos</div><div id="k_ped" class="v">—</div></div>
    <div class="card kpi"><div class="t">Faturamento</div><div id="k_fat" class="v">—</div></div>
    <div class="card kpi"><div class="t">Ticket Médio</div><div id="k_tick" class="v">—</div></div>
    <div class="card kpi"><div class="t">Faturamento Líquido</div><div id="k_fatl" class="v">—</div></div>
  </div>
  <div class="grid g3" style="margin-top:10px">
    <div class="card kpi"><div class="t">Incentivos</div><div id="k_des" class="v">—</div></div>
    <div class="card kpi"><div class="t">Frete</div><div id="k_fre" class="v">—</div></div>
    <div class="card kpi"><div class="t">Período</div><div id="k_per" class="v mut">—</div></div>
  </div>

  <!-- Resumo + Prévia -->
  <div class="card">
    <div id="resumo" class="mut">Resumo do filtro…</div>
    <div class="hr"></div>
    <div style="overflow:auto;max-height:420px">
      <table id="tprev">
        <thead><tr>
          <th>dia</th><th>hora</th><th>unidade</th><th>Nome da loja</th><th>Canal</th>
          <th>pagamento</th><th>cancelado</th><th>pedidos</th><th>fat</th><th>des</th><th>fre</th><th>turno</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Import XLSX + Validação -->
  <div class="card">
    <div class="grid g3">
      <div>
        <label>Arquivo .xlsx</label>
        <input type="file" id="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
      </div>
      <div>
        <label>Planilha (aba)</label>
        <select id="sheetSel"><option value="">(carregue o arquivo…)</option></select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="validate" class="">Validar</button>
        <button id="exportErrors">Exportar erros (CSV)</button>
        <button id="import" class="primary">Importar (upsert)</button>
      </div>
    </div>
    <div class="hr"></div>
    <div class="progress"><div id="ibar" class="bar"></div></div>
    <div id="istatus" class="mut" style="margin-top:8px">—</div>
    <div class="hr"></div>
    <div><b>Relatório de validação</b></div>
    <pre id="vreport">—</pre>
  </div>
</div>

<script>
/* ==========================
   CONFIG SUPABASE
========================== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const TABLE='vendas_xlsx';
const BATCH=800; // menor p/ evitar payload grande

/* ==========================
   HELPERS
========================== */
const $ = id => document.getElementById(id);
function money(n){ return 'R$ '+Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function br(n){ return Number(n||0).toLocaleString('pt-BR'); }
function parseNum(v){ if(v==null||v==='') return 0; if(typeof v==='number') return v; const s=String(v).replace(/\s/g,'').replace(/\./g,'').replace(',','.'); const n=Number(s); return isFinite(n)?n:0; }
function norm(s){ return String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
function onlyHour(hms){
  if(hms==null) return null;
  const m=String(hms).match(/(\d{1,2})(?::\d{2}(?::\d{2})?)?/);
  return m?Math.max(0,Math.min(23,parseInt(m[1],10))):null;
}
function parseDateFlexible(s){
  if(!s) return null;
  const str=String(s).trim();
  // ISO yyyy-mm-dd[ hh:mm[:ss]]
  let m=str.match(/^(\d{4})[-/\.](\d{1,2})[-/\.](\d{1,2})(?:[ T](\d{1,2})(?::(\d{2})(?::\d{2})?)?)?$/);
  if(m){
    const [_,Y,M,D,H='00',I='00']=m; return {dia:`${Y}-${M.padStart(2,'0')}-${D.padStart(2,'0')}`,hora: Number(H)};
  }
  // dd/mm/yyyy[ hh:mm[:ss]]
  m=str.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})(?:\s+(\d{1,2})(?::(\d{2})(?::\d{2})?)?)?$/);
  if(m){
    const [_,D,M,Y,H='00',I='00']=m; return {dia:`${Y}-${M.padStart(2,'0')}-${D.padStart(2,'0')}`,hora: Number(H)};
  }
  return null;
}
function turnoFromHour(h){ if(h==null) return null; if(h>=6&&h<12) return 'Manhã'; if(h>=12&&h<18) return 'Tarde'; if(h>=18&&h<24) return 'Noite'; return 'Madrugada'; }
function basePayment(p){
  const s=norm(p).toLowerCase();
  if(!s) return null;
  if(s.includes('pix')) return 'PIX';
  if(s.includes('dinheiro')) return 'Dinheiro';
  if(s.includes('cartao')||s.includes('cartão')) return 'Cartão';
  if(s.includes('online')) return 'Pago Online';
  if(s.includes('nao cadastrado')||s.includes('não cadastrado')) return 'Pagamento não cadastrado';
  if(s.includes('consumo funcionario')) return 'Consumo Funcionário';
  return p;
}
function makeKey(n){
  const parts=[n.dia,n.unidade,(n["Nome da loja"]||''),n.hora,(n.pagamento||''),(n["Canal de venda"]||''),n.pedidos,n.fat.toFixed(2),n.des.toFixed(2),n.fre.toFixed(2),(n.cancelado||'')];
  const s=parts.join('|'); let h=0; for(let i=0;i<s.length;i++) h=(h*31+s.charCodeAt(i))|0;
  return 'rk_'+(h>>>0).toString(16);
}

/* ==========================
   HEADERS (inclui variações 2024/2025)
========================== */
const HDR={
  pedido:['Pedido','Nº do pedido','Numero do pedido','Número do pedido'],
  data:['Data da venda','Data','Venda','Data Pedido'],
  unidade:['Unidade','unidade','Código da loja','Codigo da loja','cod loja','Loja (cód)'],
  loja:['Nome da loja','Loja','Filial','Ponto de venda'],
  canal:['Canal de venda','Canal','Origem'],
  pagamento:['Pagamento','Forma de pagamento','Meio de pagamento'],
  cancelado:['Está cancelado','Está cancelado?','Cancelado','Status cancelamento'],
  total:['Total','Total do pedido','Valor Total','Valor'],
  desconto:['Desconto','Descontos'],
  entrega:['Entrega','Frete','Taxa de entrega','Taxa de envio'],
  turno:['Turno'],
};
function pick(row, keys){ for(const k of keys) if(k in row && String(row[k]).trim()!=='') return row[k]; return ''; }
function guessUnidade(row){
  const u=pick(row,HDR.unidade); if(u) return String(u).trim();
  const loja=pick(row,HDR.loja); const s=norm(loja).toLowerCase();
  if(!s) return null; if(s.includes('savassi')) return 'Uni.Savassi'; if(s.includes('raja')) return 'Uni.Raja'; if(s.includes('centro')) return 'Uni.Raja';
  return null;
}

/* ==========================
   XLSX UI
========================== */
let workbook=null, sheetName=null, lastErrors=[];
$('file').addEventListener('change', async (e)=>{
  resetValidation();
  const file=e.target.files[0]; if(!file) return;
  workbook = await file.arrayBuffer().then(b=>XLSX.read(b,{type:'array'}));
  $('sheetSel').innerHTML='';
  workbook.SheetNames.forEach((nm,i)=>{
    const o=document.createElement('option'); o.value=nm; o.textContent=`${i+1}. ${nm}`; $('sheetSel').appendChild(o);
  });
  $('sheetSel').value=workbook.SheetNames[0];
  sheetName=workbook.SheetNames[0];
});
$('sheetSel').addEventListener('change', e=>{ sheetName=e.target.value; resetValidation(); });

function resetValidation(){
  $('vreport').textContent='—';
  $('istatus').textContent='—';
  $('ibar').style.width='0%';
  lastErrors=[];
}

$('validate').onclick = async ()=>{
  const rows=getRows(); if(!rows) return;
  const res=validateRows(rows);
  $('vreport').textContent = formatReport(res);
  lastErrors=res.errors;
};

$('exportErrors').onclick = ()=>{
  if(!lastErrors.length){ alert('Sem erros para exportar.'); return; }
  const header=Object.keys(lastErrors[0]);
  const csv=[header.join(';')].concat(lastErrors.map(o=>header.map(k=>String(o[k]??'').replace(/;/g,',')).join(';'))).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='erros_validacao.csv'; a.click(); URL.revokeObjectURL(url);
};

$('import').onclick = async ()=>{
  const rows=getRows(); if(!rows) return;
  const {valid, errors} = validateRows(rows);
  $('vreport').textContent = formatReport({valid,errors});
  lastErrors=errors;

  if(valid.length===0){ $('istatus').textContent='Nada para importar (tudo inválido/ignorado).'; return; }

  $('istatus').textContent='Enviando para o Supabase…';
  let ok=0, fail=0;
  for(let i=0;i<valid.length;i+=BATCH){
    const pack = valid.slice(i,i+BATCH).map(n=>({...n, row_key: makeKey(n)}));
    const up = await sb.from(TABLE).upsert(pack, { onConflict:'row_key' });
    if(up.error){ console.error(up.error); fail+=pack.length; $('istatus').textContent=`Erro: ${up.error.message}`; }
    else ok+=pack.length;
    const p=Math.min(100,Math.round(((i+BATCH)/valid.length)*100)); $('ibar').style.width=p+'%';
    $('istatus').textContent=`Importando… ${Math.min(i+BATCH,valid.length)} / ${valid.length} (ok: ${ok}, erros: ${fail})`;
    await new Promise(r=>setTimeout(r,0));
  }
  $('istatus').textContent=`Concluído. OK: ${ok}, Erros: ${fail}`;
  await loadOptionsAndHealth(); await applyFilters();
};

/* validação e normalização */
function getRows(){
  if(!workbook){ alert('Selecione o arquivo .xlsx'); return null; }
  sheetName = sheetName || workbook.SheetNames[0];
  const ws = workbook.Sheets[sheetName]; if(!ws){ alert('Aba não encontrada'); return null; }
  return XLSX.utils.sheet_to_json(ws,{defval:''});
}
function validateRows(rows){
  const valid=[], errors=[];
  for(const r of rows){
    // ignora linhas “TOTAL”, vazias ou sem data
    const rawDate = pick(r,HDR.data);
    if(!rawDate || /total/i.test(String(r[HDR.pedido?.[0]]||''))) { continue; }

    const dt = parseDateFlexible(rawDate);
    if(!dt){ errors.push({...r, __motivo:'Data inválida'}); continue; }

    const loja = String(pick(r,HDR.loja)||'').trim();
    if(loja==='' || loja==='Loja Centro'){ /* ignorado por regra */ continue; }

    const unidade = guessUnidade(r);
    const fat = parseNum(pick(r,HDR.total));
    const des = parseNum(pick(r,HDR.desconto));
    const fre = parseNum(pick(r,HDR.entrega));
    const canal = String(pick(r,HDR.canal)||'').trim()||null;
    const pagamento = String(pick(r,HDR.pagamento)||'').trim()||null;
    let cancelado = String(pick(r,HDR.cancelado)||'').trim();
    cancelado = cancelado ? (/(^s|sim|true|1)/i.test(cancelado)?'Sim':'Não') : 'Não';
    const turno = String(pick(r,HDR.turno)||'').trim() || turnoFromHour(dt.hora) || null;

    if(!fat && !des && !fre){ errors.push({...r, __motivo:'Valores numéricos vazios (Total/Desconto/Entrega)'}); continue; }

    valid.push({
      dia: dt.dia,
      hora: onlyHour(dt.hora),
      unidade,
      "Nome da loja": loja,
      "Canal de venda": canal,
      pagamento,
      pagamento_base: basePayment(pagamento),
      cancelado,
      pedidos: 1,
      fat, des, fre,
      turno
    });
  }
  return {valid, errors};
}
function formatReport({valid,errors}){
  return [
    `Linhas na planilha: ${br((valid.length||0)+(errors.length||0))}`,
    `Válidas (importáveis): ${br(valid.length)}`,
    `Inválidas/ignoradas: ${br(errors.length)}`,
    '',
    errors.length?`Amostra de erros (até 5):\n${errors.slice(0,5).map(e=>`• ${e.__motivo} | Data: ${pick(e,HDR.data)} | Loja: ${pick(e,HDR.loja)}`).join('\n')}`:'Sem erros.'
  ].join('\n');
}

/* ==========================
   KPIs + Prévia (RPCs)
========================== */
const getF = ()=>({
  _dini: $('dini').value||null,
  _dfim: $('dfim').value||null,
  _unidade: $('unidade').value||null,
  _loja: $('loja').value||null,
  _canais: $('canal').value?[$('canal').value]:null,
  _pagamentos: $('pag').value?[$('pag').value]:null,
  _cancelado: $('canc').value||'Não'
});

$('apply').onclick = ()=>applyFilters();
$('clear').onclick = ()=>{ ['unidade','loja','canal','pag'].forEach(i=>$(i).value=''); $('canc').value='Não'; applyFilters(); };

async function applyFilters(){
  const f=getF();
  const k=await sb.rpc('dash_kpis_xlsx_v1', f);
  if(k.error){ console.error(k.error); return; }
  const d=(k.data||[])[0]||{};
  $('k_ped').textContent = br(d.pedidos||0);
  $('k_fat').textContent = money(d.fat||0);
  $('k_tick').textContent= money(d.ticket_medio||0);
  $('k_fatl').textContent= money(d.fat_liquido||0);
  $('k_des').textContent = money(d.descontos||0);
  $('k_fre').textContent = money(d.fretes||0);
  $('k_per').textContent = `${f._dini||'—'} → ${f._dfim||'—'}`;

  const r=await sb.rpc('dash_rows_xlsx_v1',{...f,_limit:200,_offset:0});
  const tb=$('tprev').querySelector('tbody'); tb.innerHTML='';
  (r.data||[]).forEach(x=>{
    const tr=document.createElement('tr');
    [x.dia,x.hora,x.unidade,x["Nome da loja"],x["Canal de venda"],x.pagamento,x.cancelado,x.pedidos,
     Number(x.fat).toFixed(2),Number(x.des).toFixed(2),Number(x.fre).toFixed(2),x.turno]
    .forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
    tb.appendChild(tr);
  });

  $('resumo').textContent = `Período: ${f._dini||'—'} → ${f._dfim||'—'} | Unidade: ${f._unidade||'Todas'} | Loja: ${f._loja||'Todas'} | Canal: ${f._canais?f._canais.join(', '):'Todos'} | Pagamento: ${f._pagamentos?f._pagamentos.join(', '):'Todos'} | Cancelado: ${f._cancelado}`;
}

/* ==========================
   OPTIONS + HEALTH
========================== */
$('btnHealth').onclick = runHealth;
async function runHealth(){
  const h=await sb.rpc('dash_health_xlsx_v1');
  if(h.error){ $('health').textContent='Erro: '+h.error.message; return; }
  const r=(h.data||[])[0]||{};
  $('health').textContent = `Min: ${r.min_dia||'—'} · Max: ${r.max_dia||'—'} · Total: ${br(r.total||0)} · Cancelado — Sim: ${br(r.cancelado_sim||0)}, Não: ${br(r.cancelado_nao||0)}`;
}
(async function boot(){
  const op=await sb.rpc('dash_options_xlsx_v1');
  if(!op.error && op.data){
    const d=op.data;
    fillSel('unidade', d.unidades||[]);
    fillSel('loja', d.lojas||[]);
    fillSel('canal', d.canais||[]);
    fillSel('pag', d.pagamentos||[]);
    if(d.periodo){ $('dini').value=d.periodo.min||''; $('dfim').value=d.periodo.max||''; }
  }
  await runHealth();
  await applyFilters();
})();
function fillSel(id,arr){ const el=$(id); const cur=el.value; el.innerHTML=`<option value="">${id==='pag'?'Todos':'Todas'}</option>`; (arr||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); }); if(cur) el.value=cur; }
</script>
</body>
</html>
