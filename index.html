<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Maestro Food</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='64' fill='%232563eb'/%3E%3Ctext x='50%' y='58%' text-anchor='middle' font-size='64' fill='white' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E"/>
<style>
:root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
.wrap{max-width:1200px;margin:22px auto;padding:0 16px}
h1{margin:0 0 4px;font-size:20px}
.muted{color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
.topbar{display:flex;gap:8px;align-items:center}
button,select,input{font:inherit;border:1px solid var(--brd);border-radius:10px;background:#fff;padding:8px 10px}
button{cursor:pointer}
button.ghost{background:#fff}
details.filter{background:#fff;border:1px solid var(--brd);border-radius:14px}
details.filter>summary{padding:12px 14px;font-weight:700;list-style:none;cursor:pointer;display:flex;justify-content:space-between}
details.filter[open]>summary{border-bottom:1px solid var(--brd)}
details.filter .body{padding:12px 14px}
.grid{display:grid;gap:10px}
.filters{grid-template-columns:repeat(12,1fr)}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
.seg{display:flex;gap:8px;align-items:center}
.lbl{font-size:12px;color:var(--muted);min-width:120px}
.card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px}
.kgrid{grid-template-columns:repeat(4,1fr)}
.val{font-size:22px;font-weight:700}
.delta{font-size:12px}
.delta.up{color:var(--good)}.delta.down{color:var(--bad)}
.chartbox{position:relative;height:300px}
.pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
.pill button{border:0;background:#fff;padding:6px 10px}
.pill button.active{background:var(--accent);color:#fff}
.badge{font-size:12px;border:1px solid var(--brd);border-radius:999px;padding:3px 8px}
.hint{font-size:12px;color:var(--muted)}
/* Auth */
.gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
.gate .box{width:360px;max-width:92vw;background:#fff;border:1px solid var(--brd);border-radius:14px;padding:18px}
.tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
.tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
.tabs button.active{background:var(--accent);color:#fff}
.field{display:flex;flex-direction:column;margin-top:8px}
.field label{font-size:12px;color:var(--muted);margin-bottom:4px}
.error{color:#b91c1c;font-size:12px;min-height:16px;margin-top:6px}
@media (max-width:940px){.kgrid{grid-template-columns:repeat(2,1fr)}.filters{grid-template-columns:repeat(6,1fr)}}
@media (max-width:560px){.kgrid,.filters{grid-template-columns:repeat(4,1fr)}.col-6,.col-4,.col-3{grid-column:span 4}}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<!-- AUTH -->
<div id="gate" class="gate" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 8px">Acesso — Maestro Food</h3>
    <div class="tabs"><button id="tLogin" class="active">Entrar</button><button id="tSign">Criar conta</button></div>
    <div class="field"><label>E-mail</label><input id="aEmail" type="email" placeholder="voce@empresa.com"></div>
    <div class="field"><label>Senha</label><input id="aPass" type="password" placeholder="••••••••"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="bForgot" class="ghost">Esqueci a senha</button>
      <button id="bSign" style="display:none">Criar conta</button>
      <button id="bLogin">Entrar</button>
    </div>
    <div id="authMsg" class="error"></div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="toolbar">
    <div>
      <h1>Maestro Food</h1>
      <div class="muted" id="periodo">Período: —</div>
    </div>
    <div class="topbar">
      <span class="muted" id="who"></span>
      <button id="bLogout">Sair</button>
    </div>
  </div>

  <details id="fx" class="filter" open>
    <summary>FILTROS <span id="bClear" class="muted" style="font-weight:400">Limpar</span></summary>
    <div class="body">
      <div class="grid filters">
        <div class="col-6 seg"><span class="lbl">Unidade</span><select id="fUni" class="col-12"><option>Todas</option></select></div>
        <div class="col-6 seg"><span class="lbl">Nome da loja (Top 10)</span><select id="fLoja" class="col-12"><option value="">Todas</option></select></div>

        <div class="col-3 seg"><span class="lbl">De</span><input id="fDe" type="date" class="col-12"/></div>
        <div class="col-3 seg"><span class="lbl">Até</span><input id="fAte" type="date" class="col-12"/></div>
        <div class="col-3 seg"><span class="lbl">Período rápido</span>
          <select id="fPr" class="col-12"><option value="7">Últimos 7</option><option value="15">Últimos 15</option><option value="30" selected>Últimos 30</option><option value="90">Últimos 90</option></select>
        </div>
        <div class="col-3 seg"><span class="lbl">Turno</span>
          <select id="fTurno" class="col-12"><option value="">Todos</option><option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option></select>
        </div>

        <div class="col-4 seg"><span class="lbl">Canal de venda</span><select id="fCanal" class="col-12"><option value="">Todos</option></select></div>
        <div class="col-4 seg"><span class="lbl">Pagamento</span><select id="fPag" class="col-12"><option value="">Todos</option></select></div>
        <div class="col-4 seg"><span class="lbl">Está cancelado?</span>
          <select id="fCanc" class="col-12"><option>Todos</option><option>Sim</option><option selected>Não</option></select>
        </div>
      </div>

      <div class="card" style="border-style:dashed;margin-top:10px">
        <b>Admin — Importar CSV (<i>Pasta2.csv</i>)</b> · o intervalo do arquivo é limpo antes de inserir
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
          <input id="csv" type="file" accept=".csv"/>
          <button id="bImport">Importar CSV</button>
          <progress id="prog" value="0" max="100" style="display:none"></progress>
          <span id="impTag" class="badge" style="display:none">Importado</span>
          <span id="impWarn" class="muted"></span>
        </div>
      </div>
    </div>
  </details>

  <!-- KPIs -->
  <div class="grid kgrid" style="margin-top:12px">
    <div class="card"><div class="muted">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped"></div></div>
    <div class="card"><div class="muted">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm"></div></div>
    <div class="card"><div class="muted">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat"></div></div>
    <div class="card"><div class="muted">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd"></div></div>
  </div>
  <div class="grid kgrid" style="margin-top:12px">
    <div class="card"><div class="muted">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des"></div></div>
    <div class="card"><div class="muted">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp"></div></div>
    <div class="card"><div class="muted">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre"></div></div>
    <div class="card"><div class="muted">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem"></div></div>
  </div>
  <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px">
    <div class="card"><div class="muted">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl"></div></div>
    <div class="card"><div class="muted">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp"></div></div>
  </div>

  <!-- Gráfico -->
  <div class="card" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted">Receita diária</div>
      <div class="pill" id="mLine"><button data-v="total" class="active">Total</button><button data-v="media">Média (7d)</button></div>
    </div>
    <div class="chartbox"><canvas id="cLine"></canvas></div>
  </div>
</div>

<script>
(function(){
  // ====== Config ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE  = "vendas_kpi_daily_v2";       // view/tabela de leitura
  const STAGE  = "vendas_kpi_daily_v2_data";  // staging de escrita

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:true}});

  // ====== Utils ======
  const q = s=>document.querySelector(s);
  const fmtBRL = n=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = n=> new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = d=> d.toISOString().slice(0,10);
  const parseBR = (s)=>{ if(s==null||s==="") return 0; return Number(String(s).replace(/\./g,"").replace(",",".")); }
  const sha1 = async (s)=>{ const enc=new TextEncoder().encode(s); const buf=await crypto.subtle.digest("SHA-1",enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
  const uniq = arr => Array.from(new Set(arr));
  function addDays(iso, k){ const d=new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+k); return toISO(d); }
  function setDelta(el, cur, ant){ const pct = ant>0 ? ((cur-ant)/ant*100) : 0; el.className="delta "+(pct>=0?"up":"down"); el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"%"; }

  // ====== Auth UI ======
  const gate=q("#gate"), app=q("#app"), who=q("#who");
  const tLogin=q("#tLogin"), tSign=q("#tSign"), bLogin=q("#bLogin"), bSign=q("#bSign"), bForgot=q("#bForgot"), aEmail=q("#aEmail"), aPass=q("#aPass"), authMsg=q("#authMsg");
  const bLogout=q("#bLogout");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function showApp(){ gate.style.display="none"; app.style.display="block"; }

  tLogin.onclick=()=>{ tLogin.classList.add("active"); tSign.classList.remove("active"); bLogin.style.display="inline-block"; bSign.style.display="none"; authMsg.textContent=""; }
  tSign.onclick =()=>{ tSign.classList.add("active"); tLogin.classList.remove("active"); bSign.style.display="inline-block"; bLogin.style.display="none"; authMsg.textContent=""; }

  bLogin.onclick=async ()=>{ authMsg.textContent=""; const {error}=await supa.auth.signInWithPassword({email:aEmail.value, password:aPass.value}); if(error){authMsg.textContent=error.message;return;} afterLogin(); }
  bSign.onclick =async ()=>{ authMsg.textContent=""; const {error}=await supa.auth.signUp({email:aEmail.value, password:aPass.value}); authMsg.textContent= error? error.message : "Conta criada. Verifique seu e-mail (se necessário)."; }
  bForgot.onclick=async ()=>{ authMsg.textContent=""; if(!aEmail.value){authMsg.textContent="Informe o e-mail.";return;} const {error}=await supa.auth.resetPasswordForEmail(aEmail.value,{redirectTo:location.href}); authMsg.textContent= error? error.message : "Se o e-mail existir, enviarei o link de redefinição."; }
  bLogout.onclick=async ()=>{ await supa.auth.signOut(); showGate(); }

  supa.auth.onAuthStateChange((_e, s)=>{ if(s){ afterLogin(); } else { showGate(); } });

  async function afterLogin(){ const {data:{user}}=await supa.auth.getUser(); who.textContent=user?.email||""; showApp(); boot(); }

  // ====== Filtros/UI ======
  const fUni=q("#fUni"), fLoja=q("#fLoja"), fDe=q("#fDe"), fAte=q("#fAte"), fPr=q("#fPr"), fTurno=q("#fTurno"), fCanal=q("#fCanal"), fPag=q("#fPag"), fCanc=q("#fCanc"), bClear=q("#bClear"), periodo=q("#periodo");
  const csv=q("#csv"), bImport=q("#bImport"), prog=q("#prog"), impTag=q("#impTag"), impWarn=q("#impWarn");
  let minISO=null, maxISO=null, lineMode="total", chartLine=null;

  q("#mLine").addEventListener("click",(ev)=>{ if(ev.target.tagName!=="BUTTON")return; [...ev.currentTarget.children].forEach(b=>b.classList.remove("active")); ev.target.classList.add("active"); lineMode=ev.target.dataset.v; refresh(); });

  bClear.onclick=()=>{ fUni.value="Todas"; fLoja.value=""; fDe.value=""; fAte.value=""; fPr.value="30"; fTurno.value=""; fCanal.value=""; fPag.value=""; fCanc.value="Não"; q("#fx").open=false; refresh(); };
  [fUni,fLoja,fDe,fAte,fPr,fTurno,fCanal,fPag,fCanc].forEach(el=>el.addEventListener("change",()=>{ q("#fx").open=false; refresh(); }));

  // ====== Boot (limites e opções) ======
  async function boot(){
    // limites de data
    const r1=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r1.error||r2.error){ periodo.textContent="Período: —"; return; }
    minISO=r1.data[0]?.dia||null; maxISO=r2.data[0]?.dia||null;
    if(maxISO){ fAte.value=maxISO; fDe.value=addDays(maxISO,-29); periodo.textContent=`Período: ${fDe.value} → ${fAte.value}`; }

    // Unidades únicas
    const u=await supa.from(TABLE).select("unidade").limit(10000);
    const UU=uniq((u.data||[]).map(x=>(x.unidade||"").trim()).filter(Boolean)).sort();
    fUni.innerHTML=`<option>Todas</option>${UU.map(v=>`<option>${v}</option>`).join("")}`;

    // Canal/Pagamento
    const cp=await supa.from(TABLE).select('"Canal de venda",pagamento').limit(20000);
    const canals=uniq((cp.data||[]).map(x=>x["Canal de venda"]).filter(Boolean)).sort();
    const pags  =uniq((cp.data||[]).map(x=>x.pagamento).filter(Boolean)).sort();
    fCanal.innerHTML=`<option value="">Todos</option>${canals.map(v=>`<option>${v}</option>`).join("")}`;
    fPag.innerHTML  =`<option value="">Todos</option>${pags.map(v=>`<option>${v}</option>`).join("")}`;

    // Top10 lojas para dropdown
    const top=await supa.from(TABLE).select('"Nome da loja",fat').limit(100000);
    const agg={}; (top.data||[]).forEach(r=>{ const n=r["Nome da loja"]; if(!n) return; agg[n]=(agg[n]||0)+Number(r.fat||0); });
    const top10=Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
    fLoja.innerHTML = `<option value="">Todas</option>${top10.map(v=>`<option>${v}</option>`).join("")}`;

    refresh();
  }

  // ====== Consulta ======
  async function fetchRange(startISO, endISO){
    let qy = supa.from(TABLE).select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
      .gte("dia", startISO).lte("dia", endISO).order("dia",{ascending:true});
    if(fUni.value && fUni.value!=="Todas") qy= qy.eq("unidade", fUni.value);
    if(fLoja.value) qy= qy.eq("Nome da loja", fLoja.value);
    if(fTurno.value) qy= qy.eq("turno", fTurno.value);
    if(fCanal.value) qy= qy.eq("Canal de venda", fCanal.value);
    if(fPag.value)   qy= qy.eq("pagamento", fPag.value);
    if(fCanc.value!=="Todos") qy= qy.eq("cancelado", fCanc.value);
    const r = await qy.range(0, 499999);
    if(r.error) throw r.error;
    return r.data||[];
  }

  function movingAvg(arr, n){ const out=[]; let acc=0; for(let i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=n) acc-=arr[i-n]; out.push(acc/Math.min(i+1,n)); } return out; }
  function drawLine(days, curVals, prevVals){
    if(chartLine){ try{ chartLine.destroy(); }catch{} }
    const ctx=q("#cLine").getContext("2d");
    const data = (lineMode==="media") ? movingAvg(curVals,7) : curVals;
    chartLine = new Chart(ctx,{type:"line",data:{labels:days,datasets:[
      {data:prevVals,fill:true,borderWidth:0,backgroundColor:"rgba(2,132,199,.12)",pointRadius:0,tension:.25},
      {data, borderWidth:2, pointRadius:0, tension:.25}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}});
  }

  async function refresh(){
    if(!fDe.value||!fAte.value){ if(maxISO){ fAte.value=maxISO; fDe.value=addDays(maxISO,-29); } }
    periodo.textContent=`Período: ${fDe.value} → ${fAte.value}`;

    const cur = await fetchRange(fDe.value, fAte.value);
    // Período anterior (mesmo nº de dias)
    const daysLen = Math.max(1, Math.round((new Date(fAte.value)-new Date(fDe.value))/86400000)+1);
    const prevEnd  = addDays(fDe.value, -1);
    const prevStart= addDays(prevEnd, -(daysLen-1));
    const ant = await fetchRange(prevStart, prevEnd);

    // KPIs
    const S = a=>a.reduce((s,r)=>s+Number(r||0),0);
    const ped = S(cur.map(r=>r.pedidos));
    const fat = S(cur.map(r=>r.fat));
    const des = S(cur.map(r=>r.des));
    const fre = S(cur.map(r=>r.fre));
    const pedA= S(ant.map(r=>r.pedidos));
    const fatA= S(ant.map(r=>r.fat));
    const desA= S(ant.map(r=>r.des));
    const freA= S(ant.map(r=>r.fre));
    const dias= uniq(cur.map(r=>r.dia)).length || 1;
    const diasA=uniq(ant.map(r=>r.dia)).length || 1;

    const tkm = ped>0 ? fat/ped : 0, tkmA = pedA>0 ? fatA/pedA : 0;
    const fmd = fat/dias,           fmdA = fatA/diasA;
    const fatL= fat - des - fre - (0.12*fat);
    const fatLA=fatA- desA- freA- (0.12*fatA);
    const desP= fat>0 ? des/fat*100 : 0,  desPA=fatA>0 ? desA/fatA*100 : 0;
    const freM= ped>0 ? fre/ped : 0,     freMA=pedA>0 ? freA/pedA : 0;
    const fatLP= fat>0 ? fatL/fat*100 : 0, fatLPA= fatA>0 ? fatLA/fatA*100 : 0;

    q("#k_ped").textContent=fmtInt(ped); setDelta(q("#d_ped"),ped,pedA);
    q("#k_tkm").textContent=fmtBRL(tkm); setDelta(q("#d_tkm"),tkm,tkmA);
    q("#k_fat").textContent=fmtBRL(fat); setDelta(q("#d_fat"),fat,fatA);
    q("#k_fmd").textContent=fmtBRL(fmd); setDelta(q("#d_fmd"),fmd,fmdA);
    q("#k_des").textContent=fmtBRL(des); setDelta(q("#d_des"),des,desA);
    q("#k_desp").textContent=(desP).toFixed(1)+"%"; setDelta(q("#d_desp"),desP,desPA);
    q("#k_fre").textContent=fmtBRL(fre); setDelta(q("#d_fre"),fre,freA);
    q("#k_frem").textContent=fmtBRL(freM); setDelta(q("#d_frem"),freM,freMA);
    q("#k_fatl").textContent=fmtBRL(fatL); setDelta(q("#d_fatl"),fatL,fatLA);
    q("#k_fatlp").textContent=(fatLP).toFixed(1)+"%"; setDelta(q("#d_fatlp"),fatLP,fatLPA);

    // Linha com sombra
    const byDay=(list)=>{ const m=new Map(); list.forEach(r=>m.set(r.dia,(m.get(r.dia)||0)+Number(r.fat||0))); const lbl=[...m.keys()].sort(); return {lbl, vals:lbl.map(k=>m.get(k))}; };
    const C=byDay(cur), P=byDay(ant);
    drawLine(C.lbl, C.vals, P.vals);
  }

  // ====== Import CSV com DEDUPE ======
  bImport.onclick=async ()=>{
    impWarn.textContent=""; impTag.style.display="none";
    const file=csv.files?.[0]; if(!file){ alert("Selecione o Pasta2.csv"); return; }
    prog.style.display="inline-block"; prog.value=0;

    // 1) Parse
    const rows = await new Promise((ok,ko)=>{
      Papa.parse(file, { header:true, skipEmptyLines:true, dynamicTyping:false,
        complete: r=>ok(r.data||[]), error: ko
      });
    });

    // 2) Transform -> staging schema
    function parseDateParts(s){ // "dd/mm/aaaa HH:MM"
      if(!s) return {dia:null,hora:null};
      const m = String(s).match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
      if(!m) return {dia:null,hora:null};
      const iso = `${m[3]}-${m[2]}-${m[1]}`;
      const hora = Number(m[4])||0;
      return {dia:iso, hora:hora};
    }
    const norm = s => (s==null?"":String(s).trim());
    const mapRow = (r)=>{
      const dt = parseDateParts(r["Data da venda"]);
      const cancel = (norm(r["Está cancelado"]).toUpperCase()==="S"||norm(r["Está cancelado"])==="Sim") ? "Sim" : "Não";
      const out = {
        dia: dt.dia,
        unidade: norm(r["unidade"]),
        pedidos: 1,
        fat: parseBR(r["Total"]),
        des: parseBR(r["Desconto"]),
        fre: parseBR(r["Entrega"]) + parseBR(r["Valor Entregador"]),
        "Nome da loja": norm(r["Nome da loja"]),
        turno: norm(r["Turno"]),
        "Canal de venda": norm(r["Canal de venda"]),
        pagamento: norm(r["Pagamento"]) || norm(r["Forma de pagamento"]),
        cancelado: cancel,
        hora: dt.hora,
        _np: norm(r["Número do pedido no parceiro"]||"")
      };
      return out;
    };
    const mapped = rows.map(mapRow).filter(r=>r.dia); // descarta sem data

    if(mapped.length===0){ prog.style.display="none"; alert("Arquivo sem linhas válidas."); return; }

    // 3) UID por linha
    async function makeUID(r){
      const key = [
        r.dia, r.hora??"", r.unidade, r["Nome da loja"], r["Canal de venda"],
        r.pagamento, r._np||"", (r.fat??0).toFixed(2), r.cancelado
      ].map(v=>String(v||"").toLowerCase().trim()).join("|");
      return sha1(key);
    }
    const fileUIDs = new Set();
    const withUID = [];
    for(let i=0;i<mapped.length;i++){
      const uid = await makeUID(mapped[i]);
      if(fileUIDs.has(uid)) continue; // remove duplicados internos
      fileUIDs.add(uid);
      withUID.push({...mapped[i], _uid:uid});
    }

    // 4) Descobrir intervalo e buscar existentes no STAGE para dedupe
    const allDays = uniq(withUID.map(r=>r.dia)).sort();
    const sISO = allDays[0], eISO = allDays[allDays.length-1];
    // limpa intervalo antigo ANTES (para permitir reprocessar o mesmo período sem criar acúmulo se você desejar)
    await supa.from(STAGE).delete().gte("dia", sISO).lte("dia", eISO);

    // Buscar o que restou no intervalo (se houver linhas fora do recorte) – e cruzar UID
    const existQ = await supa.from(STAGE).select('dia,unidade,fat,des,fre,"Nome da loja","Canal de venda",pagamento,cancelado,hora').gte("dia", sISO).lte("dia", eISO).limit(500000);
    const existUIDs = new Set();
    for(const r of (existQ.data||[])){
      const uid = await makeUID({...r, _np:""});
      existUIDs.add(uid);
    }

    // 5) Filtro final a inserir (delta)
    const toInsert = withUID.filter(r=>!existUIDs.has(r._uid)).map(r=>{
      const o={...r}; delete o._uid; delete o._np; return o;
    });

    // 6) Inserção em lotes
    const CHUNK=2000; let done=0;
    for(let i=0;i<toInsert.length;i+=CHUNK){
      const slice = toInsert.slice(i,i+CHUNK);
      const ins = await supa.from(STAGE).insert(slice);
      if(ins.error){ console.error(ins.error); impWarn.textContent = "Alguns lotes falharam: "+ins.error.message; }
      done += slice.length; prog.value = Math.round(done/toInsert.length*100);
    }
    prog.style.display="none"; impTag.style.display="inline-block";
    impWarn.textContent = `Linhas válidas: ${mapped.length.toLocaleString("pt-BR")} • Inseridas: ${toInsert.length.toLocaleString("pt-BR")}`;
    await refresh();
  };

  // start
  (async ()=>{ const {data:{session}}=await supa.auth.getSession(); if(session){ afterLogin(); } else { showGate(); } })();
})();
</script>
</html>
