<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v17.2 (Diagnóstico + Charts estáveis)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--bd:#e5e7eb;--chip:#eef2ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:20px;font-weight:700;margin-top:4px}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .pill{display:inline-block;background:var(--chip);border-radius:999px;padding:2px 8px;margin-right:6px}
    .btn{background:#111827;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.alt{background:#374151}
    .btn.ghost{background:#fff;color:#111827;border:1px solid var(--bd)}
    .btn.small{padding:6px 8px;font-size:12px}
    select,input{border:1px solid var(--bd);border-radius:8px;padding:8px 10px;background:#fff}
    label{font-size:12px;color:var(--muted)}
    .controls{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
    .controls .col{display:flex;flex-direction:column;gap:6px}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .inline{display:flex;align-items:center;gap:8px}
    .chart-card{padding:16px}
    canvas{max-width:100%;height:300px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    @media (max-width:980px){.controls{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:600px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js (estável / sem CORS) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">
          Build <span class="pill">v17.2</span>
          Fonte preferida: <code>public.vendas_kpi_daily</code>
        </div>
        <div class="muted">URL: <code id="urlShow">—</code></div>
      </div>
      <div class="muted" id="periodoShow">Período: —</div>
    </div>

    <!-- Diagnóstico -->
    <div class="card" style="margin-top:12px">
      <div class="title">Diagnóstico (pré-check)</div>
      <div id="diag" class="muted">—</div>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-top:12px">
      <div class="title">Filtros (em cascata)</div>
      <div class="controls" style="margin-top:10px">
        <div class="col">
          <label>Unidade</label>
          <select id="selUnidade">
            <option>Todas</option>
          </select>
        </div>
        <div class="col">
          <label>Período rápido (dias)</label>
          <div class="stack">
            <button class="btn small ghost" data-days="7">7</button>
            <button class="btn small ghost" data-days="15">15</button>
            <button class="btn small ghost" data-days="30">30</button>
            <button class="btn small ghost" data-days="90">90</button>
            <button class="btn small ghost" data-days="180">180</button>
            <button class="btn small ghost" data-days="360">360</button>
          </div>
        </div>
        <div class="col">
          <label>De (dd/mm/aaaa)</label>
          <input id="dtDe" placeholder="dd/mm/aaaa" />
        </div>
        <div class="col">
          <label>Até (dd/mm/aaaa)</label>
          <input id="dtAte" placeholder="dd/mm/aaaa" />
        </div>
        <div class="col">
          <label>Modo de Faturamento</label>
          <div class="inline">
            <label class="inline"><input type="radio" name="modo" value="bruto" checked /> Total (bruto)</label>
            <label class="inline"><input type="radio" name="modo" value="liquido" /> Líquido (Total − Entrega)</label>
          </div>
        </div>
        <div class="col">
          <label>Ações</label>
          <div class="stack">
            <button id="btnAplicar" class="btn">Aplicar</button>
            <button id="btnLimpar" class="btn alt">Limpar filtros</button>
            <button id="btnReload" class="btn ghost">Recarregar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi">
      <div class="card">
        <div class="title">Pedidos</div>
        <div class="val" id="k_ped">…</div>
        <div class="muted" id="k_ped_prev">—</div>
      </div>
      <div class="card">
        <div class="title">Faturamento</div>
        <div class="val" id="k_fat">…</div>
        <div class="muted" id="k_fat_prev">—</div>
      </div>
      <div class="card">
        <div class="title">Incentivos</div>
        <div class="val" id="k_des">…</div>
        <div class="muted" id="k_des_prev">—</div>
      </div>
      <div class="card">
        <div class="title">Frete</div>
        <div class="val" id="k_fre">…</div>
        <div class="muted" id="k_fre_prev">—</div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid2">
      <div class="card chart-card">
        <div class="title">Receita diária (R$)</div>
        <canvas id="chartLine"></canvas>
      </div>
      <div class="card chart-card">
        <div class="title">Totais por dia da semana (R$)</div>
        <canvas id="chartBars"></canvas>
      </div>
    </div>

    <!-- Logs -->
    <div class="card" style="margin:12px 0 24px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

  <script>
    // ====== CREDENCIAIS (as que você me passou) ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

    // ====== TABELA/VIEW PREFERIDA ======
    const TABLE = "vendas_kpi_daily"; // colunas: dia, unidade, pedidos, fat, des, fre

    // ====== UI/Helpers ======
    const elLog = document.getElementById("log");
    const elDiag = document.getElementById("diag");
    const elPeriodo = document.getElementById("periodoShow");
    const elUrlShow = document.getElementById("urlShow");
    const selUnidade = document.getElementById("selUnidade");
    const dtDe = document.getElementById("dtDe");
    const dtAte = document.getElementById("dtAte");
    const btnsQuick = Array.from(document.querySelectorAll('[data-days]'));
    const btnAplicar = document.getElementById("btnAplicar");
    const btnLimpar = document.getElementById("btnLimpar");
    const btnReload = document.getElementById("btnReload");

    const k_ped = document.getElementById("k_ped");
    const k_fat = document.getElementById("k_fat");
    const k_des = document.getElementById("k_des");
    const k_fre = document.getElementById("k_fre");
    const k_ped_prev = document.getElementById("k_ped_prev");
    const k_fat_prev = document.getElementById("k_fat_prev");
    const k_des_prev = document.getElementById("k_des_prev");
    const k_fre_prev = document.getElementById("k_fre_prev");

    const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
    const fmtInt = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
    const log = m => { elLog.textContent += "\n" + m; elLog.scrollTop = elLog.scrollHeight; };
    const toISO = d => d.toISOString().slice(0,10);
    const parseDMY = (s) => {
      const m = String(s||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const [_, dd, mm, yy] = m;
      const dt = new Date(Date.UTC(Number(yy), Number(mm)-1, Number(dd), 12, 0, 0));
      return isNaN(dt.getTime()) ? null : dt;
    };
    const addDays = (date, n) => { const d = new Date(date); d.setUTCDate(d.getUTCDate()+n); return d; };

    // ====== Supabase client ======
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ====== Estado ======
    let quickDays = 30;   // período rápido padrão
    let chartLine, chartBars;

    // ====== Charts (Chart.js) ======
    function drawLine(data, label){
      // destrói instância anterior para evitar “gráfico infinito”
      if(chartLine){ chartLine.destroy(); }
      const ctx = document.getElementById("chartLine").getContext("2d");
      chartLine = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(d => d.dia),
          datasets: [{
            label, data: data.map(d => d.valor),
            tension: .25
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: { beginAtZero: true }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function drawBars(byWeek){
      if(chartBars){ chartBars.destroy(); }
      const ctx = document.getElementById("chartBars").getContext("2d");
      const ordem = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      const labels = ordem;
      const vals = ordem.map(k => byWeek[k]||0);
      chartBars = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Total (R$)", data: vals }] },
        options: {
          responsive:true, animation:false,
          scales:{ y:{ beginAtZero:true } },
          plugins:{ legend:{ display:false } }
        }
      });
    }

    // ====== Fetch paginado (sem ORDER) ======
    async function fetchPaged(table, fromISO, toISO, unidade){
      const page = 5000;
      let off = 0, acc = [];
      for(;;){
        let q = supa.from(table)
          .select("dia,unidade,pedidos,fat,des,fre")
          .gte("dia", fromISO).lte("dia", toISO)
          .range(off, off+page-1);
        if(unidade && unidade !== "Todas") q = q.eq("unidade", unidade);
        const r = await q;
        if(r.error) throw r.error;
        const arr = r.data||[];
        acc = acc.concat(arr);
        if(arr.length < page) break;
        off += page;
      }
      return acc;
    }

    // ====== Agregações ======
    function sumNums(arr, field){ return arr.reduce((a,x)=>a + Number(x[field]||0), 0); }
    function groupByDiaSum(arr, modo){
      // agrega por dia (somando fat/des/fre/pedidos)
      const map = new Map();
      for(const r of arr){
        const k = r.dia;
        if(!map.has(k)) map.set(k, { pedidos:0, fat:0, des:0, fre:0 });
        const o = map.get(k);
        o.pedidos += Number(r.pedidos||0);
        o.fat += Number(r.fat||0);
        o.des += Number(r.des||0);
        o.fre += Number(r.fre||0);
      }
      const out = [];
      for(const [k,v] of map.entries()){
        const valor = modo==="liquido" ? (v.fat - v.fre) : v.fat;
        out.push({ dia:k, valor });
      }
      // ordena por data
      out.sort((a,b)=> a.dia.localeCompare(b.dia));
      return out;
    }
    function weekDayIndex(iso){ return new Date(iso+"T00:00:00Z").getUTCDay(); } // 0=Dom
    function labelWeek(i){ return ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][i]; }
    function byWeekSum(daily){
      const acc = {};
      for(const d of daily){
        const wd = labelWeek(weekDayIndex(d.dia));
        acc[wd] = (acc[wd]||0) + d.valor;
      }
      return acc;
    }

    // ====== KPIs + período anterior ======
    function setKPIs(cur, prev){
      const ped = cur.reduce((a,x)=>a+Number(x.pedidos||0),0);
      const fat = sumNums(cur,"fat");
      const des = sumNums(cur,"des");
      const fre = sumNums(cur,"fre");

      const pedP = prev.reduce((a,x)=>a+Number(x.pedidos||0),0);
      const fatP = sumNums(prev,"fat");
      const desP = sumNums(prev,"des");
      const freP = sumNums(prev,"fre");

      const varPct = (c,p)=> p ? ((c-p)/p*100) : 0;
      const deltaFmt = (pct,valPrev,fmt=fmtBRL) =>
        `${pct>=0?"+":""}${pct.toFixed(1)}% vs ant. • ant: ${fmt(valPrev)}`;

      k_ped.textContent = fmtInt(ped);
      k_fat.textContent = fmtBRL(fat);
      k_des.textContent = fmtBRL(des);
      k_fre.textContent = fmtBRL(fre);

      k_ped_prev.textContent = deltaFmt(varPct(ped,pedP), pedP, fmtInt);
      k_fat_prev.textContent = deltaFmt(varPct(fat,fatP), fatP, fmtBRL);
      k_des_prev.textContent = deltaFmt(varPct(des,desP), desP, fmtBRL);
      k_fre_prev.textContent = deltaFmt(varPct(fre,freP), freP, fmtBRL);
    }

    // ====== Diagnóstico ======
    async function diagnostico(){
      try{
        const r = await supa.from(TABLE).select("dia,unidade,pedidos,fat,des,fre").limit(1);
        if(r.error) throw r.error;
        if(!r.data || r.data.length===0){
          elDiag.textContent = "⚠ Tabela/VIEW encontrada, mas sem linhas.";
        }else{
          const sample = r.data[0];
          elDiag.textContent = "✓ OK: colunas presentes. Exemplo: " + JSON.stringify(sample);
        }
      }catch(e){
        elDiag.textContent = "✗ ERRO: " + (e.message||String(e));
      }
    }

    // ====== Unidades (distintas no período atual) ======
    function fillUnidades(rows){
      const set = new Set(["Todas"]);
      for(const r of rows){ if(r.unidade) set.add(r.unidade); }
      const atual = selUnidade.value || "Todas";
      selUnidade.innerHTML = "";
      for(const u of set){
        const opt = document.createElement("option");
        opt.textContent = u; opt.value = u;
        if(u===atual) opt.selected = true;
        selUnidade.appendChild(opt);
      }
    }

    // ====== Janela de datas ======
    function resolveJanela(){
      const inpDe = parseDMY(dtDe.value);
      const inpAte = parseDMY(dtAte.value);
      let end = new Date(); // hoje (UTC)
      end = new Date(Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate(), 12,0,0));
      let start = addDays(end, - (quickDays - 1));

      if(inpDe && inpAte && inpDe <= inpAte){
        start = inpDe; end = inpAte;
      }
      return { startISO: toISO(start), endISO: toISO(end) };
    }
    function janelaAnterior({startISO,endISO}){
      const s = new Date(startISO+"T12:00:00Z");
      const e = new Date(endISO+"T12:00:00Z");
      const dias = Math.round((e - s) / (24*3600*1000)) + 1;
      const ePrev = addDays(s,-1);
      const sPrev = addDays(ePrev, -(dias-1));
      return { startISO: toISO(sPrev), endISO: toISO(ePrev) };
    }

    // ====== Fluxo principal ======
    async function recarregar(){
      try{
        const unidade = selUnidade.value || "Todas";
        const modo = (document.querySelector('input[name="modo"]:checked')||{}).value || "bruto";
        const jan = resolveJanela();
        elPeriodo.textContent = `Período: ${jan.startISO} → ${jan.endISO}`;
        log(`[Query] ${TABLE} | ${jan.startISO} → ${jan.endISO} | UNI=${unidade} | modo=${modo}`);

        // atual
        const rows = await fetchPaged(TABLE, jan.startISO, jan.endISO, unidade);
        log(`[OK] Linhas (atual): ${rows.length.toLocaleString("pt-BR")}`);
        fillUnidades(rows); // popula sem repetir centenas de vezes

        // anterior (mesma janela, período imediatamente anterior)
        const janPrev = janelaAnterior(jan);
        log(`[Query] anterior: ${janPrev.startISO} → ${janPrev.endISO}`);
        const rowsPrev = await fetchPaged(TABLE, janPrev.startISO, janPrev.endISO, unidade);

        // KPIs
        setKPIs(rows, rowsPrev);

        // Gráfico linha (diário) — usa 'modo'
        const daily = groupByDiaSum(rows, modo);
        drawLine(daily, modo==="liquido" ? "Receita diária (líquida)" : "Receita diária (bruta)");

        // Barras por dia da semana — a partir do mesmo array 'daily'
        const wk = byWeekSum(daily);
        drawBars(wk);

        log("[OK] KPIs e gráficos atualizados.");
      }catch(e){
        console.error(e);
        log("[ERRO] " + (e.message||String(e)));
      }
    }

    // ====== Eventos UI ======
    btnsQuick.forEach(b=>{
      b.addEventListener("click", ()=>{
        quickDays = Number(b.getAttribute("data-days"));
        // limpando datas manuais para usar o período rápido
        dtDe.value = ""; dtAte.value = "";
        recarregar();
      });
    });
    btnAplicar.onclick = ()=> recarregar();
    btnReload.onclick = ()=> recarregar();
    btnLimpar.onclick = ()=>{
      selUnidade.value = "Todas";
      quickDays = 30;
      dtDe.value = ""; dtAte.value = "";
      document.querySelector('input[name="modo"][value="bruto"]').checked = true;
      recarregar();
    };
    selUnidade.onchange = ()=> recarregar();
    document.querySelectorAll('input[name="modo"]').forEach(r=> r.onchange = ()=> recarregar());

    // ====== Boot ======
    (async function boot(){
      document.getElementById("urlShow").textContent = SUPABASE_URL.replace(/^https?:\/\//,"");
      log("[Boot] v17.2 — diagnóstico + gráficos estáveis (Chart.js) • sem ORDER/max • paginação 5k");
      await diagnostico();
      // período default 30 dias
      quickDays = 30;
      recarregar();
    })();
  </script>
</body>
</html>
