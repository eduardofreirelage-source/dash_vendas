=<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v14.2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#0f172a; --muted:#6b7280; --card:#fff; --bd:#e5e7eb; --bg:#f6f7fb; }
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    select,button{border:1px solid var(--bd);background:#fff;border-radius:8px;padding:8px 10px;font:inherit}
    button{cursor:pointer}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    .charts{display:grid;grid-template-columns:1fr;gap:12px}
    .chart{min-height:240px}
    @media (max-width:900px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid4{grid-template-columns:1fr}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Recharts + React + ReactDOM UMD (para os gráficos) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">Build v14.2 • fonte: <code>public.vendas_kpi_daily</code></div>
      </div>
      <div class="muted" id="periodo">Período: —</div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card">
        <div class="title">Período</div>
        <select id="selPeriodo">
          <option value="30">Últimos 30 dias</option>
          <option value="60" selected>Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="180">Últimos 180 dias</option>
          <option value="365">Últimos 365 dias</option>
        </select>
      </div>
      <div class="card">
        <div class="title">UNIDADE</div>
        <select id="selUnidade"><option>Todas</option></select>
      </div>
      <div class="card">
        <div class="title">FATURAMENTO</div>
        <select id="selModo">
          <option value="bruto" selected>Total (bruto)</option>
          <option value="liquido">Líquido (Total − Entrega)</option>
        </select>
      </div>
      <div class="card">
        <div class="title">Ações</div>
        <button id="btnReload">Recarregar</button>
      </div>
    </div>

    <div class="grid4" style="margin-top:12px">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="muted" id="k_ped_v">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="muted" id="k_fat_v">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div><div class="muted" id="k_desc_v">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="muted" id="k_fre_v">—</div></div>
    </div>

    <div class="charts" style="margin-top:12px">
      <div class="card"><div class="title">Receita diária (R$)</div><div id="chart1" class="chart"></div></div>
      <div class="card"><div class="title">Totais por dia da semana (R$)</div><div id="chart2" class="chart"></div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

  <script>
    // ====== CONFIG — use os seus dados ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const TABLE = "vendas_kpi_daily"; // view agregada: dia, unidade, pedidos, fat, des, fre

    // ====== Helpers ======
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const $ = (id)=>document.getElementById(id);
    const logEl = $("log");
    function log(t){ logEl.textContent += "\n" + t; }
    const BRL = (n)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(+n||0);
    const INT = (n)=> new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(+n||0));
    const pct = (v)=> (isFinite(v)? (v>0? `+${v.toFixed(1)}%` : `${v.toFixed(1)}%`) : "—");

    function rangeDays(days){
      const end = new Date(); end.setHours(23,59,59,999);
      const start = new Date(end); start.setDate(end.getDate()-(days-1)); // inclusive
      return { start: start.toISOString().slice(0,10), end: end.toISOString().slice(0,10) };
    }

    // ====== CONSULTAS ======
    // (1) UNIDADES (sem filtro de unidade! dedup client-side; pega amostra grande)
    async function loadUnidades(){
      log("[Boot] v14.2 — carregando unidades globais…");
      const page = 5000;
      let off = 0, set = new Set(), tentativas = 0;

      // Busca apenas a coluna 'unidade' (payload mínimo) e deduplica
      while (tentativas < 3) { // 3 páginas * 5000 já cobre bem
        const q = await supa.from(TABLE)
          .select("unidade")
          .order("unidade", { ascending: true })
          .range(off, off+page-1);
        if (q.error){ log("[ERRO-UNIDADES] "+q.error.message); break; }
        (q.data||[]).forEach(r => { if (r.unidade && r.unidade.trim()) set.add(r.unidade.trim()); });
        if (!q.data || q.data.length < page) break;
        off += page; tentativas++;
      }
      const arr = ["Todas", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
      const sel = $("selUnidade");
      sel.innerHTML = "";
      arr.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
      log("[OK] UNIDADES disponíveis: " + arr.join(", "));
    }

    // (2) Linhas do período (com filtro unidade opcional), sem sum() no servidor
    async function fetchPeriodo(d1, d2, unidade){
      const page = 2000;
      let off = 0, acc = [];
      for(;;){
        let req = supa.from(TABLE)
          .select("dia,unidade,pedidos,fat,des,fre")
          .gte("dia", d1).lte("dia", d2)
          .order("dia", { ascending: true })
          .range(off, off+page-1);
        if (unidade && unidade !== "Todas"){
          req = req.eq("unidade", unidade);
        }
        const r = await req;
        if (r.error){ throw r.error; }
        const arr = r.data || [];
        acc = acc.concat(arr);
        if (arr.length < page) break;
        off += page;
      }
      return acc;
    }

    // (3) KPIs e séries
    function computeKpis(rows, modo){
      let ped=0,fat=0,des=0,fre=0;
      for(const r of rows){
        ped += (r.pedidos||0);
        const bruto = +r.fat || 0;
        const d = +r.des || 0;
        const f = +r.fre || 0;
        fat += (modo==="liquido" ? (bruto - f) : bruto);
        des += d;
        fre += f;
      }
      return { ped, fat, des, fre };
    }

    // (4) Desenha gráficos (limpando o container para não “infinito”)
    function drawCharts(rows, modo){
      // limpa
      $("chart1").innerHTML = "";
      $("chart2").innerHTML = "";

      // consolida por dia
      const byDay = new Map();
      for(const r of rows){
        const key = r.dia;
        const bruto = +r.fat || 0, fre = +r.fre || 0;
        const valor = (modo==="liquido" ? (bruto - fre) : bruto);
        const prev = byDay.get(key) || 0;
        byDay.set(key, prev + valor);
      }
      const data1 = Array.from(byDay.entries()).map(([dia,val])=>({ dia, valor: +val.toFixed(2)}));
      data1.sort((a,b)=> a.dia.localeCompare(b.dia));

      // por dia da semana
      const dowNames = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      const byDow = new Array(7).fill(0);
      for(const d of data1){
        const dt = new Date(d.dia+"T12:00:00");
        const dow = dt.getDay();
        byDow[dow] += d.valor;
      }
      const data2 = dowNames.map((nome,idx)=>({ dia:nome, valor:+byDow[idx].toFixed(2) }));

      // Render (Recharts UMD)
      const { LineChart, Line, XAxis, YAxis, Tooltip, CartesianGrid, ResponsiveContainer, BarChart, Bar, Legend } = window.Recharts;

      // Chart 1
      ReactDOM.render(
        React.createElement(ResponsiveContainer, { width:"100%", height:240 },
          React.createElement(LineChart, { data:data1 },
            React.createElement(CartesianGrid, { strokeDasharray:"3 3" }),
            React.createElement(XAxis, { dataKey:"dia" }),
            React.createElement(YAxis, { tickFormatter:(v)=>BRL(v) }),
            React.createElement(Tooltip, { formatter:(v)=>BRL(v) }),
            React.createElement(Line, { type:"monotone", dataKey:"valor", dot:false })
          )
        ),
        $("chart1")
      );

      // Chart 2
      ReactDOM.render(
        React.createElement(ResponsiveContainer, { width:"100%", height:240 },
          React.createElement(BarChart, { data:data2 },
            React.createElement(CartesianGrid, { strokeDasharray:"3 3" }),
            React.createElement(XAxis, { dataKey:"dia" }),
            React.createElement(YAxis, { tickFormatter:(v)=>BRL(v) }),
            React.createElement(Tooltip, { formatter:(v)=>BRL(v) }),
            React.createElement(Legend, null),
            React.createElement(Bar, { dataKey:"valor" })
          )
        ),
        $("chart2")
      );
    }

    // ====== FLUXO PRINCIPAL ======
    async function go(){
      try{
        const days = +$("selPeriodo").value;
        const unidade = $("selUnidade").value;
        const modo = $("selModo").value;

        const { start, end } = rangeDays(days);
        $("periodo").textContent = `Período: ${start} → ${end}`;

        log(`[Query] ${TABLE} | janela ${days}d ${start} → ${end} | UNIDADE=${unidade} | modo=${modo}`);

        // atual
        const rowsNow = await fetchPeriodo(start, end, unidade);

        // anterior
        const s2 = new Date(start); s2.setDate(s2.getDate()-days);
        const e2 = new Date(end);   e2.setDate(e2.getDate()-days);
        const prevStart = s2.toISOString().slice(0,10);
        const prevEnd   = e2.toISOString().slice(0,10);
        const rowsPrev  = await fetchPeriodo(prevStart, prevEnd, unidade);

        // KPIs
        const kNow  = computeKpis(rowsNow, modo);
        const kPrev = computeKpis(rowsPrev, modo);
        const vPed = (kPrev.ped? ((kNow.ped - kPrev.ped)/kPrev.ped*100) : NaN);
        const vFat = (kPrev.fat? ((kNow.fat - kPrev.fat)/kPrev.fat*100) : NaN);
        const vDes = (kPrev.des? ((kNow.des - kPrev.des)/kPrev.des*100) : NaN);
        const vFre = (kPrev.fre? ((kNow.fre - kPrev.fre)/kPrev.fre*100) : NaN);

        $("k_ped").textContent = INT(kNow.ped);
        $("k_fat").textContent = BRL(kNow.fat);
        $("k_desc").textContent = BRL(kNow.des);
        $("k_fre").textContent = BRL(kNow.fre);
        $("k_ped_v").textContent = pct(vPed) + " vs ant.";
        $("k_fat_v").textContent = pct(vFat) + " vs ant.";
        $("k_desc_v").textContent = pct(vDes) + " vs ant.";
        $("k_fre_v").textContent = pct(vFre) + " vs ant.";

        drawCharts(rowsNow, modo);

        log(`[OK] Carregadas ${rowsNow.length.toLocaleString("pt-BR")} linhas (atual).`);
      }catch(e){
        console.error(e);
        log("[ERRO] " + (e.message || String(e)));
      }
    }

    // eventos
    $("btnReload").addEventListener("click", go);
    $("selPeriodo").addEventListener("change", go);
    $("selUnidade").addEventListener("change", go);
    $("selModo").addEventListener("change", go);

    // boot
    (async function boot(){
      await loadUnidades(); // carrega opções sem aplicar filtro
      await go();           // faz a primeira carga
    })();
  </script>
</body>
</html>
