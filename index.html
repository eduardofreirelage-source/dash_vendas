<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Build v10.3 (fixo: vendas / data_venda)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--bg:#f6f7fb;--txt:#0f172a;--muted:#6b7280;--card:#fff;--bd:#e5e7eb;--ok:#065f46;--warn:#b45309}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:980px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--muted);font-size:12px}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
      .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .title{font-size:12px;color:var(--muted)}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      code{background:#eef2ff;padding:0 4px;border-radius:4px}
      .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
      .spacer{flex:1}
      select,button{font:inherit}
      button{cursor:pointer}
      .btn{background:#fff;border:1px solid var(--bd);border-radius:8px;padding:8px 10px}
      .btn:hover{background:#f8fafc}
      .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff}
      .select{min-width:220px;padding:8px 10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
      @media (max-width:820px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:480px){.grid{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="row" style="align-items:flex-end">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Build v10.3 • fonte fixa <code>public.vendas</code> • colunas fixas</div>
          <div class="muted">URL: <code>https://uahmcfzerofhzjvlzrqc.supabase.co</code></div>
        </div>
        <div class="spacer"></div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="pill">
          <strong>Filtro: UNIDADE</strong>
          <select id="uni" class="select">
            <option value="">Todas</option>
          </select>
          <button id="btnReload" class="btn" title="Recarregar KPIs com o filtro atual">Recarregar</button>
        </div>
        <div class="spacer"></div>
        <button id="btnForce" class="btn" title="Força fallback: 30→60→90→180→365 dias">Forçar janela (fallback)</button>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== CREDENCIAIS (as que você me deu) ======
      var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      // ====== MAPEAMENTO FIXO ======
      var TABLE   = "vendas";       // <— fixo
      var COL_DT  = "data_venda";   // <— fixo (DATE)
      var COL_TOT = "valor_total";  // <— fixo (numeric)
      var COL_DES = "desconto";     // <— fixo (numeric)
      var COL_ENT = "entrega";      // <— fixo (numeric)
      var COL_UNI = "unidade";      // <— fixo (text)

      // ====== UI helpers ======
      var elLog=document.getElementById("log");
      var elPed=document.getElementById("k_ped");
      var elFat=document.getElementById("k_fat");
      var elDes=document.getElementById("k_desc");
      var elFre=document.getElementById("k_fre");
      var elPer=document.getElementById("periodo");
      var elUni=document.getElementById("uni");
      var elReload=document.getElementById("btnReload");
      var elForce=document.getElementById("btnForce");

      function log(m){ elLog.textContent += "\n"+m; elLog.scrollTop=elLog.scrollHeight; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toISO(d){ return d.toISOString().slice(0,10); }
      function toNum(x){
        if(x==null||x==="")return 0;
        if(typeof x==="number")return x;
        var s=String(x).trim(); if(!s)return 0;
        var t=s.replace(/\./g,"").replace(/,/g,"."); // "1.234,56" -> "1234.56"
        var n=Number(t); return isFinite(n)?n:0;
      }

      // ====== Supabase client ======
      var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      async function fetchRange(tbl, fromISO, toISO, unidade){
        const page=10000; let acc=[], off=0;
        for(;;){
          let q = supa.from(tbl)
            .select([COL_DT,COL_TOT,COL_DES,COL_ENT,COL_UNI].join(","))  // sem order
            .gte(COL_DT, fromISO)
            .lte(COL_DT, toISO);
          if(unidade) q = q.eq(COL_UNI, unidade);
          q = q.range(off, off+page-1);
          const r = await q;
          if(r.error){ throw r.error; }
          const arr = r.data || [];
          acc = acc.concat(arr);
          if(arr.length<page) break;
          off += page;
        }
        return acc;
      }

      async function tryWindow(days, unidade, quiet){
        const end = new Date(); end.setHours(23,59,59,999);
        const start = new Date(end); start.setDate(end.getDate()-(days-1)); start.setHours(0,0,0,0);
        if(!quiet) log("[Query] Tentando janela "+days+"d: "+toISO(start)+" → "+toISO(end));
        const rows = await fetchRange(TABLE, toISO(start), toISO(end), unidade);
        return { rows, start, end };
      }

      function fillUnits(rows){
        const set = new Set();
        for(const r of rows){ if(r[COL_UNI]) set.add(String(r[COL_UNI])); }
        const cur = elUni.value;
        elUni.innerHTML = '<option value="">Todas</option>';
        Array.from(set).sort().forEach(u=>{
          const opt = document.createElement("option");
          opt.value=u; opt.textContent=u;
          elUni.appendChild(opt);
        });
        // mantém seleção se existir
        if(cur && set.has(cur)) elUni.value = cur;
      }

      function fillKPIs(rows, start, end){
        let pedidos=rows.length, fat=0, des=0, ent=0;
        for(const r of rows){
          fat += toNum(r[COL_TOT]);
          des += toNum(r[COL_DES]);
          ent += toNum(r[COL_ENT]);
        }
        elPed.textContent = fmtInt(pedidos);
        elFat.textContent = fmtBRL(fat);
        elDes.textContent = fmtBRL(des);
        elFre.textContent = fmtBRL(ent);
        elPer.textContent = "Período: "+toISO(start)+" → "+toISO(end);
      }

      async function load(unidade, forced){
        try{
          if(!forced) elLog.textContent = "Iniciando…";
          log("[Boot] v10.3 — fonte fixa: "+TABLE+" • col datas: "+COL_DT);
          const windows = [30,60,90,180,365];
          let got=null;
          for(const d of windows){
            try{
              got = await tryWindow(d, unidade, false);
              if(got.rows.length>0){ log("[OK] Linhas retornadas: "+got.rows.length.toLocaleString("pt-BR")+" (janela "+d+"d)"); break; }
            }catch(e){
              log("[-] Falha na janela "+d+"d: "+(e.message||String(e)));
            }
          }
          if(!got || got.rows.length===0){
            throw new Error("Nenhuma linha retornada nas janelas 30/60/90/180/365 dias.");
          }
          fillUnits(got.rows);
          fillKPIs(got.rows, got.start, got.end);
          log("[OK] KPIs calculados"+(unidade?(" (UNIDADE="+unidade+")"):"")+".");
        }catch(e){
          log("[ERRO] "+(e.message||String(e)));
        }
      }

      // eventos
      elReload.addEventListener("click", ()=> load(elUni.value||"", true));
      elForce .addEventListener("click", ()=> load(elUni.value||"", true));
      elUni.addEventListener("change", ()=> load(elUni.value||"", true));

      // boot
      (async function(){ await load("", false); })();
    </script>
  </body>
</html>
