<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ========= PROMPT MESTRE (v18.2.2)
    - Fonte de dados robusta: tenta vendas_kpi_daily_v2; fallback vendas_kpi_daily_v2_data
    - Auto detecção da coluna de loja: "Nome da loja" OU "Nome da Loja"
    - Filtros nunca usam dia=null; sempre limitados a min/max do banco
    - Facets (Unidade/Loja/Canal/Pagamento) refeitos no período atual
    - Importação somativa + dedup no arquivo (sem onConflict no server)
    - UI limpa; status curto; sem logs verbosos
    - Sem retrocesso: mantém correções e nomes aprovados
  ======================================= -->

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- favicon inline (evita 404) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72"><rect width="72" height="72" rx="14" fill="%232563eb"/><path d="M22 40c10 0 10-8 20-8 6 0 8 4 8 8 0 8-8 16-18 16S14 52 14 44c0-8 6-12 8-12" fill="white" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>'>

  <style>
    :root{ --bg:#f4f6fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --pri:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--brd);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
    .filters{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px}
    .grid{display:grid;gap:10px}
    .g12{grid-template-columns:repeat(12,1fr)}
    .c12{grid-column:span 12}.c6{grid-column:span 6}.c4{grid-column:span 4}.c3{grid-column:span 3}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    select,input{width:100%;padding:10px;border:1px solid var(--brd);background:#fff;border-radius:10px;font:inherit}
    .btn{border:0;background:var(--pri);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin-top:12px}
    .kpi .t{font-size:12px;color:var(--muted)} .kpi .v{font-size:22px;font-weight:700;margin-top:6px}
    .chartbox{height:360px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{font-size:12px;color:var(--muted)}
    .ok{color:#16a34a}.err{color:#b91c1c}
    @media (max-width:980px){ .kpis{grid-template-columns:repeat(2,1fr)} .g12{grid-template-columns:repeat(6,1fr)} }
    @media (max-width:560px){ .kpis{grid-template-columns:1fr} .g12{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <button id="btnClear" class="badge">Limpar</button>
    </div>

    <!-- FILTROS -->
    <div class="filters">
      <div class="grid g12">
        <div class="c6">
          <label>Unidade</label>
          <select id="uni"></select>
        </div>
        <div class="c6">
          <label>Nome da loja</label>
          <select id="loja"></select>
        </div>

        <div class="c3">
          <label>De</label>
          <input id="dini" type="date" />
        </div>
        <div class="c3">
          <label>Até</label>
          <input id="dfim" type="date" />
        </div>
        <div class="c3">
          <label>Período rápido</label>
          <select id="pr">
            <option value="7">Últimos 7</option>
            <option value="15">Últimos 15</option>
            <option value="30">Últimos 30</option>
            <option value="90" selected>Últimos 90</option>
            <option value="180">Últimos 180</option>
          </select>
        </div>
        <div class="c3">
          <label>Turno</label>
          <select id="turno">
            <option value="Todos" selected>Todos</option>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>

        <div class="c4">
          <label>Canal de venda</label>
          <select id="canal"></select>
        </div>
        <div class="c4">
          <label>Pagamento</label>
          <select id="pag"></select>
        </div>
        <div class="c4">
          <label>Está cancelado?</label>
          <select id="canc">
            <option value="Todos" selected>Todos</option>
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>

        <div class="c12 card" style="border-style:dashed">
          <b>Admin — Importar CSV (<i>Pasta2.csv</i>)</b>
          <div class="row" style="margin-top:8px">
            <input type="file" id="csv" accept=".csv" />
            <button class="btn" id="import">Importar CSV</button>
            <button class="badge" id="diag">Diagnóstico</button>
            <span class="status" id="status"></span>
          </div>
          <div class="status">Importação soma e dedup por (dia,unidade,Loja,hora,pagamento,Canal).</div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="card kpi"><div class="t">Pedidos</div><div class="v" id="k_ped">—</div></div>
      <div class="card kpi"><div class="t">Ticket Médio</div><div class="v" id="k_tkm">—</div></div>
      <div class="card kpi"><div class="t">Faturamento</div><div class="v" id="k_fat">—</div></div>
      <div class="card kpi"><div class="t">Faturamento Médio (dia)</div><div class="v" id="k_fmd">—</div></div>
    </div>

    <!-- GRÁFICO -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:600">Receita diária</div>
        <span class="badge" id="modeBtn">Total</span>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__MF_BOOT__) return; window.__MF_BOOT__=true;

  // ===== CONFIG =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Tabelas candidatas (ordem de preferência)
  const SOURCES = ["vendas_kpi_daily_v2", "vendas_kpi_daily_v2_data"];
  let TABLE = null;

  // Colunas dinâmicas
  let COL_LOJA_OBJ = "Nome da loja";   // para r[COL_LOJA_OBJ]
  let COL_LOJA_SQL = '"Nome da loja"'; // para select()
  const COL_CANAL_OBJ = "Canal de venda";
  const COL_CANAL_SQL = '"Canal de venda"';

  // UI refs
  const dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  const uni=document.getElementById("uni"), loja=document.getElementById("loja");
  const turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  const statusEl=document.getElementById("status"), periodoEl=document.getElementById("periodo"), modeBtn=document.getElementById("modeBtn");

  // State
  let minISO=null, maxISO=null, chartLine=null, showAvg=false;

  // Utils
  const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtINT = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Number(n)||0);
  const setStatus=(m,ok)=>{ statusEl.textContent=m||""; statusEl.className="status "+(ok===true?"ok":ok===false?"err":""); if(ok===true){ setTimeout(()=>{ statusEl.textContent=""; statusEl.className="status"; },2200);} };
  const safeISO = d=>{ try{ if(!d) return null; const x=new Date(d+"T00:00:00"); return isNaN(x)?null:x.toISOString().slice(0,10);}catch(_){return null;} };
  const addDays=(iso,dd)=>{ const x=new Date((iso||"1970-01-01")+"T00:00:00"); x.setDate(x.getDate()+dd); return x.toISOString().slice(0,10); };
  const numberFromBR = s=>{ if(s===undefined||s===null||s==="") return 0; if(typeof s==="number") return s; s=String(s).trim().replace(/[R$\s]/g,""); if(s.includes(",")) s=s.replace(/\./g,"").replace(",","."); return Number(s)||0; };

  async function pickTable(){
    for(const t of SOURCES){
      const q = await supa.from(t).select("dia").limit(1);
      if(!q.error){ TABLE=t; return true; }
    }
    setStatus("Nenhuma tabela acessível (v2 / v2_data).", false);
    return false;
  }
  async function detectLojaColumn(){
    // tenta "Nome da loja"
    let q = await supa.from(TABLE).select('"Nome da loja"').limit(1);
    if(!q.error){ COL_LOJA_OBJ="Nome da loja"; COL_LOJA_SQL='"Nome da loja"'; return; }
    // tenta "Nome da Loja"
    q = await supa.from(TABLE).select('"Nome da Loja"').limit(1);
    if(!q.error){ COL_LOJA_OBJ="Nome da Loja"; COL_LOJA_SQL='"Nome da Loja"'; return; }
    // sem coluna de loja
    COL_LOJA_OBJ=null; COL_LOJA_SQL=null;
  }

  async function refreshLimits(){
    const a=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const b=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO=a.data?.[0]?.dia||null; maxISO=b.data?.[0]?.dia||null;
    if(minISO && maxISO){
      dini.min=minISO; dfim.min=minISO; dini.max=maxISO; dfim.max=maxISO;
      if(!dfim.value) dfim.value=maxISO;
      if(!dini.value){ const days=(Number(pr.value)||90)-1; dini.value=addDays(maxISO,-days); }
    }
  }

  async function loadUnidades(){
    const set=new Set(); let from=0, page=2000;
    for(;;){
      const {data,error}=await supa.from(TABLE).select("unidade").not("unidade","is",null).range(from,from+page-1);
      if(error) break;
      (data||[]).forEach(r=>{ const v=(r.unidade??"").toString().trim(); if(v) set.add(v); });
      if(!data || data.length<page) break; from+=page; if(from>500000) break;
    }
    uni.innerHTML=""; const o0=document.createElement("option"); o0.value="Todas"; o0.textContent="Todas"; uni.appendChild(o0);
    Array.from(set).sort((a,b)=>a.localeCompare(b,"pt-BR")).forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; uni.appendChild(o); });
    if(!uni.value) uni.value="Todas";
  }

  async function rebuildFacets(){
    let s=safeISO(dini.value), e=safeISO(dfim.value);
    if((!s||!e) && maxISO){ e=maxISO; s=addDays(maxISO,-((Number(pr.value)||90)-1)); if(!dini.value) dini.value=s; if(!dfim.value) dfim.value=e; }

    const setLoja=new Set(), setCanal=new Set(), setPag=new Set();
    let from=0, page=2000;
    for(;;){
      const cols = [COL_CANAL_SQL, "pagamento"].filter(Boolean);
      if(COL_LOJA_SQL) cols.unshift(COL_LOJA_SQL);
      let q=supa.from(TABLE).select(cols.join(",")).range(from,from+page-1);
      if(s) q=q.gte("dia",s); if(e) q=q.lte("dia",e);
      if(uni.value && uni.value!=="Todas") q=q.eq("unidade",uni.value);
      if(turno.value && turno.value!=="Todos") q=q.eq("turno",turno.value);
      if(canc.value && canc.value!=="Todos") q=q.eq("cancelado",canc.value);
      if(COL_LOJA_OBJ) q=q.not(COL_LOJA_OBJ,"is",null);
      q=q.not(COL_CANAL_OBJ,"is",null).not("pagamento","is",null);
      const {data,error}=await q; if(error) break;
      (data||[]).forEach(r=>{
        if(COL_LOJA_OBJ){ const L=(r[COL_LOJA_OBJ]??"").toString().trim(); if(L) setLoja.add(L); }
        const C=(r[COL_CANAL_OBJ]??"").toString().trim(); if(C) setCanal.add(C);
        const P=(r["pagamento"]??"").toString().trim(); if(P) setPag.add(P);
      });
      if(!data || data.length<page) break; from+=page; if(from>500000) break;
    }
    const refill=(sel,set,allLbl)=>{
      const cur=sel.value; sel.innerHTML="";
      const o0=document.createElement("option"); o0.value=allLbl; o0.textContent=allLbl; sel.appendChild(o0);
      Array.from(set).sort((a,b)=>a.localeCompare(b,"pt-BR")).forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
      sel.value=(cur && (cur===o0.value || set.has(cur)))?cur:o0.value;
    };
    if(COL_LOJA_OBJ){ refill(loja,setLoja,"Todas"); } else { loja.innerHTML='<option value="Todas">Todas</option>'; }
    refill(canal,setCanal,"Todos");
    refill(pag,setPag,"Todos");
  }

  async function fetchPaged(s,e){
    let cols=['dia','unidade','pedidos','fat','des','fre','turno',COL_CANAL_SQL,'pagamento','cancelado','hora'];
    if(COL_LOJA_SQL) cols.splice(6,0,COL_LOJA_SQL);
    const fields=cols.join(",");
    let from=0,page=2000,out=[];
    for(;;){
      let q=supa.from(TABLE).select(fields).order("dia",{ascending:true}).range(from,from+page-1);
      if(s) q=q.gte("dia",s); if(e) q=q.lte("dia",e);
      if(uni.value && uni.value!=="Todas") q=q.eq("unidade",uni.value);
      if(COL_LOJA_OBJ && loja.value && loja.value!=="Todas") q=q.eq(COL_LOJA_OBJ,loja.value);
      if(turno.value && turno.value!=="Todos") q=q.eq("turno",turno.value);
      if(canal.value && canal.value!=="Todos") q=q.eq(COL_CANAL_OBJ,canal.value);
      if(pag.value && pag.value!=="Todos") q=q.eq("pagamento",pag.value);
      if(canc.value && canc.value!=="Todos") q=q.eq("cancelado",canc.value);
      const {data,error}=await q; if(error) throw error;
      out=out.concat(data||[]); if(!data || data.length<page) break; from+=page; if(from>500000) break;
    }
    return out;
  }

  function drawLine(labels, values){
    if(chartLine){ try{chartLine.destroy();}catch(_){ } }
    chartLine=new window.Chart(document.getElementById("cLine").getContext("2d"),{
      type:"line",
      data:{labels,datasets:[{data:values,borderWidth:2,pointRadius:0,tension:0.2}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  function render(rows){
    const byDay=new Map(); let ped=0,fat=0;
    rows.forEach(r=>{ ped+=Number(r.pedidos||0); fat+=Number(r.fat||0); byDay.set(r.dia,(byDay.get(r.dia)||0)+Number(r.fat||0)); });
    const days=Array.from(byDay.keys()).sort(); const vals=days.map(d=>byDay.get(d)||0);
    let series=vals;
    if(showAvg){
      let acc=0,out=[]; for(let i=0;i<vals.length;i++){ acc+=vals[i]; if(i>=7) acc-=vals[i-7]; out.push(acc/Math.min(i+1,7)); }
      series=out;
    }
    document.getElementById("k_ped").textContent=fmtINT(ped);
    document.getElementById("k_tkm").textContent=fmtBRL(ped? fat/ped : 0);
    document.getElementById("k_fat").textContent=fmtBRL(fat);
    document.getElementById("k_fmd").textContent=fmtBRL(days.length? fat/days.length : 0);
    drawLine(days,series);
  }

  async function reload(){
    if(!TABLE){ setStatus("Sem tabela definida.",false); return; }
    let s=safeISO(dini.value), e=safeISO(dfim.value);
    if((!s||!e) && maxISO){ e=maxISO; s=addDays(maxISO,-((Number(pr.value)||90)-1)); if(!dini.value) dini.value=s; if(!dfim.value) dfim.value=e; }
    periodoEl.textContent="Período: "+(s||"—")+" → "+(e||"—");
    try{
      await rebuildFacets();
      const rows=await fetchPaged(s,e);
      render(rows);
      setStatus("");
    }catch(err){ setStatus("Falha ao carregar: "+(err.message||err),false); }
  }

  // ===== IMPORT (somativa + dedup no arquivo) =====
  const sanitizeHeader = h=>String(h||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g," ");
  const getVal=(row,key)=> row?.[key] ?? row?.[key?.toLowerCase()] ?? row?.[key?.toUpperCase()];

  function guessCols(headers){
    const H=(headers||[]).map(sanitizeHeader);
    const find=(...alts)=>{ for(const a of alts){ const i=H.indexOf(a); if(i>=0) return headers[i]; } return null; };
    return {
      dia: find("data da venda","data","dia","data do pedido"),
      hora: find("hora","horario","hora da venda"),
      unidade: find("unidade","filial"),
      loja: find("nome da loja","loja","pdv"),
      turno: find("turno","periodo"),
      canal: find("canal de venda","canal","origem"),
      pagamento: find("pagamento","forma de pagamento","meio de pagamento"),
      cancelado: find("esta cancelado","cancelado","status cancelado"),
      fat: find("total","valor total","faturamento","receita","valor"),
      des: find("desconto","descontos","incentivos","incentivo"),
      fre: find("entrega","frete","taxa de entrega"),
      pedidos: find("pedidos","quantidade","qtd")
    };
  }

  document.getElementById("import").addEventListener("click", ()=>{
    const f=document.getElementById("csv").files[0]; if(!f){ setStatus("Selecione o arquivo.",false); return; }
    if(!TABLE){ setStatus("Sem tabela definida.",false); return; }
    setStatus("Lendo arquivo…");
    Papa.parse(f,{
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        try{
          const rows=res.data||[]; if(rows.length===0){ setStatus("Arquivo vazio.",false); return; }
          const cols=guessCols(res.meta.fields||[]);
          if(!cols.dia || !cols.unidade || !cols.fat){ setStatus("Colunas mínimas não encontradas (dia/unidade/total).",false); return; }

          const acc=new Map();
          for(const r of rows){
            // data
            const raw=(getVal(r,cols.dia)||"").toString().trim();
            let iso=null;
            if(/^\d{2}\/\d{2}\/\d{4}/.test(raw)){ const [dd,mm,yy]=raw.slice(0,10).split("/"); iso=safeISO(`${yy}-${mm}-${dd}`); }
            else { iso=safeISO(raw); }
            if(!iso) continue;

            // hora
            let hour=null; if(cols.hora){ const hv=String(getVal(r,cols.hora)||"").trim(); const m=hv.match(/(\d{1,2})/); hour=m? Math.min(23,Math.max(0,Number(m[1])||0)) : null; }

            const obj={
              dia: iso,
              unidade: String(getVal(r,cols.unidade)||"").trim()||"—",
              pedidos: cols.pedidos ? (Number(getVal(r,cols.pedidos))||0) : 1,
              fat: numberFromBR(getVal(r,cols.fat)),
              des: cols.des ? numberFromBR(getVal(r,cols.des)) : 0,
              fre: cols.fre ? numberFromBR(getVal(r,cols.fre)) : 0,
              turno: cols.turno ? String(getVal(r,cols.turno)||"").trim() : null,
              [COL_CANAL_OBJ]: cols.canal ? String(getVal(r,cols.canal)||"").trim() : null,
              pagamento: cols.pagamento ? String(getVal(r,cols.pagamento)||"").trim() : null,
              cancelado: (function(){ if(!cols.cancelado) return "Não"; const v=String(getVal(r,cols.cancelado)||"").toLowerCase(); return /sim|true|1|cancel/i.test(v)?"Sim":"Não"; })(),
              hora: hour
            };
            if(COL_LOJA_OBJ){ obj[COL_LOJA_OBJ] = cols.loja ? String(getVal(r,cols.loja)||"").trim() : null; }

            // chave composta
            const key=[obj.dia,obj.unidade,(COL_LOJA_OBJ? (obj[COL_LOJA_OBJ]||"") : ""),obj.hora==null?"":obj.hora,obj.pagamento||"",obj[COL_CANAL_OBJ]||""].join("§");
            if(!acc.has(key)) acc.set(key,{...obj});
            else { const a=acc.get(key); a.pedidos+=obj.pedidos; a.fat+=obj.fat; a.des+=obj.des; a.fre+=obj.fre; }
          }

          const payload=Array.from(acc.values()); if(payload.length===0){ setStatus("Nada para importar (colunas não reconhecidas).",false); return; }
          setStatus("Enviando "+payload.length.toLocaleString("pt-BR")+"…");

          // Inserção em lotes (sem onConflict no server)
          const chunk=1200;
          for(let i=0;i<payload.length;i+=chunk){
            const slice=payload.slice(i,i+chunk);
            const { error } = await supa.from(TABLE).insert(slice);
            if(error){ setStatus("Erro ao inserir: "+error.message,false); return; }
          }
          setStatus("Importado.",true);
          await refreshLimits();
          await loadUnidades();
          await rebuildFacets();
          await reload();
        }catch(err){ setStatus("Erro: "+(err.message||err),false); }
      },
      error:(e)=>setStatus("Erro CSV: "+(e.message||e),false)
    });
  });

  // Diagnóstico rápido
  document.getElementById("diag").addEventListener("click", async ()=>{
    if(!TABLE){ setStatus("Sem tabela definida.",false); return; }
    const a=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const b=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    const mi=a.data?.[0]?.dia||null, ma=b.data?.[0]?.dia||null;
    if(!mi||!ma){ setStatus("Sem dados na origem: "+TABLE,false); return; }
    setStatus(`OK — ${mi}→${ma} em ${TABLE}`,true);
  });

  // Eventos
  document.getElementById("btnClear").addEventListener("click", async ()=>{
    uni.value="Todas"; loja.value="Todas"; turno.value="Todos"; canal.value="Todos"; pag.value="Todos"; canc.value="Todos";
    if(maxISO){ dfim.value=maxISO; dini.value=addDays(maxISO,-((Number(pr.value)||90)-1)); }
    await rebuildFacets(); await reload();
  });
  [dini,dfim,uni,loja,turno,canal,pag,canc].forEach(el=> el.addEventListener("change", ()=>reload()));
  pr.addEventListener("change", ()=>{ if(maxISO){ dfim.value=maxISO; dini.value=addDays(maxISO,-((Number(pr.value)||90)-1)); } reload(); });
  modeBtn.addEventListener("click", ()=>{ showAvg=!showAvg; modeBtn.textContent=showAvg?"Média (7d)":"Total"; reload(); });

  // BOOT
  (async function(){
    setStatus("Detectando origem…");
    const ok = await pickTable();
    if(!ok){ setStatus("Sem dados na fonte: null", false); return; }
    await detectLojaColumn();
    await refreshLimits();
    if(!minISO || !maxISO){ setStatus("Sem dados na origem: "+TABLE,false); return; }
    await loadUnidades();
    await rebuildFacets();
    await reload();
    setStatus("");
  })();

})();
</script>
</body>
</html>
