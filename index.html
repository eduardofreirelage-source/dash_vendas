<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Food Dashboard - COM TIMEOUT HANDLING</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .timeout-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            animation: timeout-pulse 2s infinite;
        }

        .unlimited-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }

        .robust-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            animation: glow 3s infinite;
        }

        @keyframes timeout-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 6px 25px rgba(245, 158, 11, 0.6); }
        }

        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-indicator {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 8px 16px;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .status-indicator.success {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .status-indicator.warning {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.5);
        }

        .status-indicator.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .status-indicator.retry {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            animation: retry-pulse 1s infinite;
        }

        @keyframes retry-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .performance-metric {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 12px 16px;
            color: white;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .timeout-info {
            background: rgba(139, 92, 246, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            font-size: 0.9rem;
            text-align: center;
        }

        .period-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
            font-weight: 500;
        }

        .filters-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            background: rgba(255,255,255,0.15);
        }

        .filter-group select option {
            background: #333;
            color: white;
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-timeout {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-unlimited {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .kpis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .kpi-card:hover::before {
            left: 100%;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.15);
        }

        .kpi-title {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .kpi-value {
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-comparison {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .comparison-positive {
            color: #22c55e;
        }

        .comparison-negative {
            color: #ef4444;
        }

        .comparison-neutral {
            color: rgba(255,255,255,0.6);
        }

        .chart-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .chart-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .data-table-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-info {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .virtual-table {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .table-header-row {
            background: rgba(255,255,255,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 1px;
            padding: 15px;
            font-weight: 600;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .table-body {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .table-body::-webkit-scrollbar {
            width: 8px;
        }

        .table-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .table-body::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 1px;
            padding: 12px 15px;
            color: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background-color 0.2s ease;
        }

        .table-row:hover {
            background: rgba(255,255,255,0.1);
        }

        .table-cell {
            font-size: 0.85rem;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            color: white;
            max-width: 400px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px auto;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .retry-indicator {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            color: #a78bfa;
            font-size: 0.85rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .kpis-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .performance-metrics {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }

            .table-header-row,
            .table-row {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .table-cell:nth-child(4),
            .table-cell:nth-child(5) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>🔄 Dashboard COM TIMEOUT HANDLING</h3>
            <p id="loadingStatus">Inicializando sistema robusto...</p>
            <div class="progress-container">
                <div id="loadingProgress" class="progress-bar">0%</div>
            </div>
            <div id="retryIndicator" class="retry-indicator" style="display: none;">
                🔄 Tentativa de reconexão em andamento...
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>
                🍽️ Maestro Food Dashboard
                <span class="timeout-badge">🔄 TIMEOUT HANDLING</span>
                <span class="unlimited-badge">∞ UNLIMITED</span>
                <span class="robust-badge">💪 ROBUST</span>
            </h1>
            <div class="status-indicators">
                <div id="supabaseStatus" class="status-indicator warning">⏳ Conectando...</div>
                <div id="dataStatus" class="status-indicator warning">⏳ Carregando...</div>
                <div id="timeoutStatus" class="status-indicator warning">⏳ Timeout Handler...</div>
                <div id="processStatus" class="status-indicator warning">⏳ Processando...</div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="performance-metrics">
            <div class="performance-metric">
                <div class="metric-label">Tempo Total</div>
                <div class="metric-value" id="loadTime">-</div>
            </div>
            <div class="performance-metric">
                <div class="metric-label">Registros/Seg</div>
                <div class="metric-value" id="throughput">-</div>
            </div>
            <div class="performance-metric">
                <div class="metric-label">Total Registros</div>
                <div class="metric-value" id="totalRecords">-</div>
            </div>
            <div class="performance-metric">
                <div class="metric-label">Páginas</div>
                <div class="metric-value" id="totalPages">-</div>
            </div>
            <div class="performance-metric">
                <div class="metric-label">Tentativas</div>
                <div class="metric-value" id="retryCount">0</div>
            </div>
            <div class="performance-metric">
                <div class="metric-label">Status</div>
                <div class="metric-value" id="loadingStatusMetric">-</div>
            </div>
        </div>

        <!-- Timeout Info -->
        <div class="timeout-info" id="timeoutInfo">
            🔄 Sistema com Timeout Handling: Tratamento robusto de timeouts do servidor
        </div>

        <!-- Period Info -->
        <div class="period-info" id="periodInfo">
            📅 Período: Carregando...
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterUnidade">🏢 Unidade</label>
                    <select id="filterUnidade">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterLoja">🏪 Nome da Loja (Top 10)</label>
                    <select id="filterLoja">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="dataInicial">📅 Data Inicial</label>
                    <input type="date" id="dataInicial">
                </div>

                <div class="filter-group">
                    <label for="dataFinal">📅 Data Final</label>
                    <input type="date" id="dataFinal">
                </div>

                <div class="filter-group">
                    <label for="filterPeriodo">⏰ Período Rápido</label>
                    <select id="filterPeriodo">
                        <option value="">Personalizado</option>
                        <option value="hoje">Hoje</option>
                        <option value="ontem">Ontem</option>
                        <option value="ultimos7dias">Últimos 7 dias</option>
                        <option value="ultimos30dias">Últimos 30 dias</option>
                        <option value="mesAtual">Mês atual</option>
                        <option value="mesAnterior">Mês anterior</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterTurno">🌅 Turno</label>
                    <select id="filterTurno">
                        <option value="">Todos</option>
                        <option value="Manhã">Manhã</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                        <option value="Madrugada">Madrugada</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterCanal">📱 Canal de Venda</label>
                    <select id="filterCanal">
                        <option value="">Todos</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterPagamento">💳 Pagamento</label>
                    <select id="filterPagamento">
                        <option value="">Todos</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterCancelado">❌ Cancelado</label>
                    <select id="filterCancelado">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()" id="applyBtn">🔍 Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="clearFilters()">🔄 Limpar Filtros</button>
                <button class="btn btn-timeout" onclick="forceReload()">🔄 Recarregar com Timeout</button>
                <button class="btn btn-unlimited" onclick="checkTimeoutHandling()">💪 Verificar Robustez</button>
                <button class="btn btn-secondary" onclick="debugInfo()">🔧 Debug</button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpis-container">
            <div class="kpi-card">
                <div class="kpi-title">📦 Pedidos</div>
                <div class="kpi-value" id="kpiPedidos">-</div>
                <div class="kpi-comparison" id="compPedidos">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">🎯 Ticket Médio</div>
                <div class="kpi-value" id="kpiTicketMedio">R$ -</div>
                <div class="kpi-comparison" id="compTicketMedio">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">💰 Faturamento</div>
                <div class="kpi-value" id="kpiFaturamento">R$ -</div>
                <div class="kpi-comparison" id="compFaturamento">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">📈 Faturamento Médio/Dia</div>
                <div class="kpi-value" id="kpiFaturamentoDia">R$ -</div>
                <div class="kpi-comparison" id="compFaturamentoDia">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">🎁 Incentivos</div>
                <div class="kpi-value" id="kpiIncentivos">R$ -</div>
                <div class="kpi-comparison" id="compIncentivos">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">📊 Incentivos %</div>
                <div class="kpi-value" id="kpiIncentivosPercent">-%</div>
                <div class="kpi-comparison" id="compIncentivosPercent">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">🚚 Frete</div>
                <div class="kpi-value" id="kpiFrete">R$ -</div>
                <div class="kpi-comparison" id="compFrete">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">💎 Faturamento Líquido</div>
                <div class="kpi-value" id="kpiFaturamentoLiquido">R$ -</div>
                <div class="kpi-comparison" id="compFaturamentoLiquido">
                    <span class="comparison-neutral">— N/A</span>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-title">📊 Receita Diária (COM TIMEOUT HANDLING)</div>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <!-- Virtual Data Table -->
        <div class="data-table-container">
            <div class="table-header">
                <div class="table-title">📋 Dados Detalhados (COM TIMEOUT HANDLING)</div>
                <div class="table-controls">
                    <div class="table-info" id="tableInfo">Carregando...</div>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="50">50 por página</option>
                        <option value="100" selected>100 por página</option>
                        <option value="250">250 por página</option>
                        <option value="500">500 por página</option>
                        <option value="1000">1000 por página</option>
                        <option value="5000">5000 por página</option>
                        <option value="10000">10000 por página</option>
                    </select>
                </div>
            </div>
            
            <div class="virtual-table">
                <div class="table-header-row">
                    <div>Data</div>
                    <div>Loja</div>
                    <div>Faturamento</div>
                    <div>Desconto</div>
                    <div>Turno</div>
                </div>
                <div class="table-body" id="virtualTableBody">
                    <!-- Dados serão inseridos via JavaScript -->
                </div>
            </div>
            
            <div class="pagination-controls">
                <button class="btn btn-secondary" onclick="previousPage()" id="prevBtn">⬅️ Anterior</button>
                <div class="pagination-info" id="paginationInfo">Página 1 de 1</div>
                <button class="btn btn-secondary" onclick="nextPage()" id="nextBtn">Próxima ➡️</button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variáveis globais para carregamento COM TIMEOUT HANDLING
        let allData = [];
        let filteredData = [];
        let minISO = '';
        let maxISO = '';
        let chart = null;
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let totalLoadedPages = 0;
        let totalRecords = 0;
        let isLoadingComplete = false;
        let totalRetries = 0;

        // Métricas de performance
        let performanceMetrics = {
            startTime: Date.now(),
            loadTime: 0,
            throughput: 0,
            totalRecords: 0,
            totalPages: 0,
            retryCount: 0
        };

        // Configurações de timeout handling
        const TIMEOUT_CONFIG = {
            maxRetries: 5,
            baseDelay: 2000, // 2 segundos
            maxDelay: 30000, // 30 segundos
            backoffMultiplier: 2,
            pauseEveryPages: 20,
            pauseDuration: 1000
        };

        // Função para converter data para formato ISO
        function convertDateToISO(dateString) {
            if (!dateString) return null;
            
            try {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                } else {
                    const brazilianMatch = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (brazilianMatch) {
                        const [, day, month, year] = brazilianMatch;
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                }
                return null;
            } catch (error) {
                console.error('❌ Erro na conversão de data:', dateString, error);
                return null;
            }
        }

        // Função para converter números brasileiros
        function parseBRNumber(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;
            
            const str = value.toString().replace(',', '.');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        // Função para determinar turno
        function determineTurno(dateString) {
            if (!dateString) return 'Dia';
            
            const match = dateString.match(/(\d{1,2}):(\d{2})/);
            if (!match) return 'Dia';
            
            const hour = parseInt(match[1]);
            
            if (hour >= 6 && hour < 12) return 'Manhã';
            else if (hour >= 12 && hour < 18) return 'Tarde';
            else if (hour >= 18 && hour < 24) return 'Noite';
            else return 'Madrugada';
        }

        // Função para calcular delay com backoff exponencial
        function calculateDelay(retryCount) {
            const delay = Math.min(
                TIMEOUT_CONFIG.baseDelay * Math.pow(TIMEOUT_CONFIG.backoffMultiplier, retryCount),
                TIMEOUT_CONFIG.maxDelay
            );
            return delay + Math.random() * 1000; // Adiciona jitter
        }

        // Função para sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Atualizar status de loading
        function updateLoadingStatus(message, progress = null) {
            document.getElementById('loadingStatus').textContent = message;
            if (progress !== null) {
                const progressBar = document.getElementById('loadingProgress');
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress.toFixed(0) + '%';
            }
        }

        // Mostrar indicador de retry
        function showRetryIndicator(show, message = '') {
            const indicator = document.getElementById('retryIndicator');
            if (show) {
                indicator.textContent = message;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Atualizar métricas de performance
        function updatePerformanceMetrics() {
            document.getElementById('loadTime').textContent = (performanceMetrics.loadTime / 1000).toFixed(2) + 's';
            document.getElementById('throughput').textContent = performanceMetrics.throughput.toLocaleString('pt-BR');
            document.getElementById('totalRecords').textContent = performanceMetrics.totalRecords.toLocaleString('pt-BR');
            document.getElementById('totalPages').textContent = performanceMetrics.totalPages.toLocaleString('pt-BR');
            document.getElementById('retryCount').textContent = performanceMetrics.retryCount.toLocaleString('pt-BR');
            document.getElementById('loadingStatusMetric').textContent = isLoadingComplete ? 'Completo' : 'Carregando...';
        }

        // Inicialização do dashboard COM TIMEOUT HANDLING
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔄 Iniciando Dashboard COM TIMEOUT HANDLING...');
            
            try {
                updateLoadingStatus('Conectando ao Supabase...', 5);
                updateStatus('supabaseStatus', 'success', '✅ Supabase Conectado');
                
                updateLoadingStatus('Inicializando sistema robusto...', 10);
                updateStatus('timeoutStatus', 'success', '🔄 Timeout Handler Ativo');
                
                updateLoadingStatus('Carregando TODOS os dados com timeout handling...', 15);
                updateStatus('dataStatus', 'warning', '⏳ Carregando com robustez...');
                
                await loadAllDataWithTimeoutHandling();
                
                updateLoadingStatus('Processamento robusto concluído!', 100);
                
                performanceMetrics.loadTime = Date.now() - performanceMetrics.startTime;
                performanceMetrics.throughput = Math.round(allData.length / (performanceMetrics.loadTime / 1000));
                performanceMetrics.totalRecords = allData.length;
                performanceMetrics.totalPages = totalLoadedPages;
                performanceMetrics.retryCount = totalRetries;
                
                updatePerformanceMetrics();
                
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 1000);
                
                console.log('✅ Dashboard COM TIMEOUT HANDLING inicializado com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro na inicialização COM TIMEOUT HANDLING:', error);
                updateStatus('supabaseStatus', 'error', '❌ Erro de conexão');
                updateStatus('dataStatus', 'error', '❌ Erro ao carregar');
                updateStatus('timeoutStatus', 'error', '❌ Timeout handler falhou');
                updateStatus('processStatus', 'error', '❌ Falha na inicialização');
                
                updateLoadingStatus('Erro na inicialização COM TIMEOUT HANDLING: ' + error.message, 0);
            }
        });

        // Atualizar indicadores de status
        function updateStatus(elementId, type, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status-indicator ${type}`;
                element.textContent = text;
            }
        }

        // Carregamento COM TIMEOUT HANDLING
        async function loadAllDataWithTimeoutHandling() {
            console.log('🔄 Carregando TODOS os dados COM TIMEOUT HANDLING...');
            
            try {
                allData = [];
                let page = 0;
                const batchSize = 1000; // Limite real do Supabase
                let hasMore = true;
                let totalLoaded = 0;
                totalLoadedPages = 0;
                totalRetries = 0;
                
                updateStatus('dataStatus', 'warning', '⏳ Carregando com robustez...');
                
                console.log('🔄 TIMEOUT HANDLING ATIVO: Tratamento robusto de timeouts implementado');
                
                // CARREGAMENTO COM TIMEOUT HANDLING
                while (hasMore) {
                    let retryCount = 0;
                    let success = false;
                    let data = null;
                    
                    // Loop de retry para cada página
                    while (!success && retryCount < TIMEOUT_CONFIG.maxRetries) {
                        try {
                            console.log(`🔄 Carregando página ${page + 1} com ${batchSize} registros... (tentativa ${retryCount + 1})`);
                            
                            if (retryCount > 0) {
                                const delay = calculateDelay(retryCount - 1);
                                console.log(`⏳ Aguardando ${(delay / 1000).toFixed(1)}s antes da tentativa ${retryCount + 1}...`);
                                showRetryIndicator(true, `🔄 Tentativa ${retryCount + 1}/${TIMEOUT_CONFIG.maxRetries} - Aguardando ${(delay / 1000).toFixed(1)}s...`);
                                updateStatus('timeoutStatus', 'retry', `🔄 Retry ${retryCount}/${TIMEOUT_CONFIG.maxRetries}`);
                                await sleep(delay);
                            }
                            
                            const result = await supabase
                                .from('vendas_kpi_daily_v2_data')
                                .select('*')
                                .range(page * batchSize, (page + 1) * batchSize - 1)
                                .order('dia', { ascending: true });
                            
                            if (result.error) {
                                throw result.error;
                            }
                            
                            data = result.data;
                            success = true;
                            showRetryIndicator(false);
                            updateStatus('timeoutStatus', 'success', '🔄 Timeout Handler Ativo');
                            
                        } catch (error) {
                            retryCount++;
                            totalRetries++;
                            performanceMetrics.retryCount = totalRetries;
                            updatePerformanceMetrics();
                            
                            console.error(`❌ Erro na tentativa ${retryCount} da página ${page + 1}:`, error);
                            
                            // Verificar se é timeout
                            if (error.code === '57014' || error.message?.includes('timeout')) {
                                console.log(`🔄 Timeout detectado - tentativa ${retryCount}/${TIMEOUT_CONFIG.maxRetries}`);
                                
                                if (retryCount >= TIMEOUT_CONFIG.maxRetries) {
                                    console.error(`❌ Máximo de tentativas atingido para página ${page + 1}`);
                                    throw new Error(`Timeout persistente após ${TIMEOUT_CONFIG.maxRetries} tentativas na página ${page + 1}`);
                                }
                            } else {
                                // Erro não relacionado a timeout
                                throw error;
                            }
                        }
                    }
                    
                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        totalLoaded += data.length;
                        totalLoadedPages++;
                        
                        console.log(`✅ Página ${page + 1}: ${data.length} registros (Total: ${totalLoaded.toLocaleString('pt-BR')})`);
                        
                        const progress = Math.min(15 + (page * 0.2), 85);
                        updateLoadingStatus(`Carregando COM TIMEOUT HANDLING: ${totalLoaded.toLocaleString('pt-BR')} registros`, progress);
                        updateStatus('dataStatus', 'warning', `⏳ ${totalLoaded.toLocaleString('pt-BR')} registros`);
                        
                        // LÓGICA CORRIGIDA: Continua se a página está cheia
                        hasMore = data.length === batchSize;
                        page++;
                        
                        console.log(`🔍 DEBUG: data.length=${data.length}, batchSize=${batchSize}, hasMore=${hasMore}`);
                        
                        // Atualizar métricas em tempo real
                        performanceMetrics.totalRecords = totalLoaded;
                        performanceMetrics.totalPages = totalLoadedPages;
                        updatePerformanceMetrics();
                        
                        // Pausa estratégica para não sobrecarregar o servidor
                        if (page % TIMEOUT_CONFIG.pauseEveryPages === 0) {
                            console.log(`⏸️ Pausa estratégica de ${TIMEOUT_CONFIG.pauseDuration}ms após ${page} páginas`);
                            await sleep(TIMEOUT_CONFIG.pauseDuration);
                        }
                        
                    } else {
                        hasMore = false;
                        console.log('🔄 Fim dos dados - carregamento COM TIMEOUT HANDLING concluído!');
                    }
                }
                
                isLoadingComplete = true;
                console.log(`✅ TOTAL DE REGISTROS CARREGADOS COM TIMEOUT HANDLING: ${allData.length.toLocaleString('pt-BR')}`);
                console.log(`✅ TOTAL DE PÁGINAS CARREGADAS: ${totalLoadedPages.toLocaleString('pt-BR')}`);
                console.log(`🔄 TOTAL DE TENTATIVAS DE RETRY: ${totalRetries.toLocaleString('pt-BR')}`);
                
                if (allData.length === 0) {
                    updateStatus('dataStatus', 'warning', '⚠️ Sem dados');
                    updateStatus('processStatus', 'warning', '⚠️ Banco vazio');
                    document.getElementById('periodInfo').textContent = '📅 Período: Sem dados · 0 registros';
                    return;
                }
                
                updateLoadingStatus('Processando dados COM TIMEOUT HANDLING...', 90);
                
                await processAllDataWithTimeoutHandling();
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados COM TIMEOUT HANDLING:', error);
                updateStatus('dataStatus', 'error', '❌ Erro ao carregar');
                updateStatus('timeoutStatus', 'error', '❌ Timeout handler falhou');
                throw error;
            }
        }

        // Processamento COM TIMEOUT HANDLING
        async function processAllDataWithTimeoutHandling() {
            console.log('⚙️ Processando TODOS os dados COM TIMEOUT HANDLING...');
            
            try {
                let validData = [];
                let invalidCount = 0;
                
                console.log(`🔄 Processando ${allData.length.toLocaleString('pt-BR')} registros...`);
                
                for (const record of allData) {
                    const isoDate = convertDateToISO(record.dia);
                    
                    if (isoDate) {
                        record.dia = isoDate;
                        record.turno = determineTurno(record.dia);
                        validData.push(record);
                    } else {
                        invalidCount++;
                    }
                }
                
                allData = validData;
                filteredData = [...allData];
                
                console.log(`✅ Dados COM TIMEOUT HANDLING processados: ${allData.length.toLocaleString('pt-BR')} registros válidos, ${invalidCount} inválidos`);
                
                await calculateDateRangeWithTimeoutHandling();
                await buildFilterOptionsWithTimeoutHandling();
                await calculateKPIsWithTimeoutHandling();
                await updateChartWithTimeoutHandling();
                await initializeVirtualTableWithTimeoutHandling();
                
                updateStatus('dataStatus', 'success', `🔄 ${allData.length.toLocaleString('pt-BR')} registros COM TIMEOUT HANDLING`);
                updateStatus('processStatus', 'success', '✅ Processamento COM TIMEOUT HANDLING concluído');
                
                updateTimeoutHandlingInfo();
                
            } catch (error) {
                console.error('❌ Erro ao processar dados COM TIMEOUT HANDLING:', error);
                updateStatus('processStatus', 'error', '❌ Erro no processamento COM TIMEOUT HANDLING');
                throw error;
            }
        }

        // Calcular período dos dados COM TIMEOUT HANDLING
        async function calculateDateRangeWithTimeoutHandling() {
            if (allData.length === 0) {
                document.getElementById('periodInfo').textContent = '📅 Período: Sem dados · 0 registros';
                return;
            }
            
            try {
                const dates = allData.map(record => record.dia).filter(date => date).sort();
                minISO = dates[0];
                maxISO = dates[dates.length - 1];
                
                console.log('📅 Período COM TIMEOUT HANDLING calculado:', minISO, '→', maxISO);
                
                const minFormatted = formatDateBR(minISO);
                const maxFormatted = formatDateBR(maxISO);
                
                document.getElementById('periodInfo').textContent = 
                    `📅 Período: ${minFormatted} → ${maxFormatted} · ${allData.length.toLocaleString('pt-BR')} registros COM TIMEOUT HANDLING`;
                
                document.getElementById('dataInicial').value = minISO;
                document.getElementById('dataFinal').value = maxISO;
                
            } catch (error) {
                console.error('❌ Erro ao calcular período COM TIMEOUT HANDLING:', error);
                document.getElementById('periodInfo').textContent = '📅 Período: Erro ao calcular COM TIMEOUT HANDLING · 0 registros';
            }
        }

        // Formatar data para exibição brasileira
        function formatDateBR(isoDate) {
            if (!isoDate) return '';
            
            try {
                const [year, month, day] = isoDate.split('-');
                return `${day}/${month}/${year}`;
            } catch (error) {
                console.error('❌ Erro ao formatar data COM TIMEOUT HANDLING:', isoDate, error);
                return isoDate;
            }
        }

        // Construir opções dos filtros COM TIMEOUT HANDLING
        async function buildFilterOptionsWithTimeoutHandling() {
            console.log('🔧 Construindo opções dos filtros COM TIMEOUT HANDLING...');
            
            try {
                const unidades = [...new Set(allData.map(record => record.unidade).filter(u => u))].sort();
                
                // Top 10 lojas por faturamento
                const lojasFaturamento = {};
                allData.forEach(record => {
                    const loja = record['Nome da loja'];
                    if (loja) {
                        lojasFaturamento[loja] = (lojasFaturamento[loja] || 0) + parseBRNumber(record.fat);
                    }
                });
                
                const topLojas = Object.entries(lojasFaturamento)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10)
                    .map(([loja]) => loja);
                
                const canais = [...new Set(allData.map(record => record['Canal de venda']).filter(c => c))].sort();
                const pagamentos = [...new Set(allData.map(record => record.pagamento).filter(p => p))].sort();
                
                buildSelectOptions('filterUnidade', unidades);
                buildSelectOptions('filterLoja', topLojas);
                buildSelectOptions('filterCanal', canais);
                buildSelectOptions('filterPagamento', pagamentos);
                
                console.log('✅ Opções dos filtros COM TIMEOUT HANDLING construídas');
                
            } catch (error) {
                console.error('❌ Erro ao construir filtros COM TIMEOUT HANDLING:', error);
            }
        }

        // Construir opções de um select
        function buildSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Aplicar filtros COM TIMEOUT HANDLING
        async function applyFilters() {
            console.log('🔄 Aplicando filtros COM TIMEOUT HANDLING...');
            
            try {
                const applyBtn = document.getElementById('applyBtn');
                applyBtn.disabled = true;
                applyBtn.textContent = '⏳ Processando COM TIMEOUT HANDLING...';
                
                const filters = {
                    unidade: document.getElementById('filterUnidade').value,
                    loja: document.getElementById('filterLoja').value,
                    dataInicial: document.getElementById('dataInicial').value,
                    dataFinal: document.getElementById('dataFinal').value,
                    turno: document.getElementById('filterTurno').value,
                    canal: document.getElementById('filterCanal').value,
                    pagamento: document.getElementById('filterPagamento').value,
                    cancelado: document.getElementById('filterCancelado').value
                };
                
                console.log('📅 Filtros COM TIMEOUT HANDLING aplicados:', filters);
                
                filteredData = allData.filter(record => {
                    if (filters.unidade && record.unidade !== filters.unidade) return false;
                    if (filters.loja && record['Nome da loja'] !== filters.loja) return false;
                    if (filters.dataInicial && record.dia < filters.dataInicial) return false;
                    if (filters.dataFinal && record.dia > filters.dataFinal) return false;
                    if (filters.turno && record.turno !== filters.turno) return false;
                    if (filters.canal && record['Canal de venda'] !== filters.canal) return false;
                    if (filters.pagamento && record.pagamento !== filters.pagamento) return false;
                    if (filters.cancelado !== '') {
                        const isCancelado = record.cancelado === true || record.cancelado === 'true';
                        if (filters.cancelado === 'true' && !isCancelado) return false;
                        if (filters.cancelado === 'false' && isCancelado) return false;
                    }
                    return true;
                });
                
                console.log(`✅ Filtros COM TIMEOUT HANDLING aplicados: ${filteredData.length.toLocaleString('pt-BR')} registros de ${allData.length.toLocaleString('pt-BR')} totais`);
                
                currentPage = 1;
                
                updateFilteredPeriodWithTimeoutHandling();
                await calculateKPIsWithTimeoutHandling();
                await updateChartWithTimeoutHandling();
                await updateVirtualTableWithTimeoutHandling();
                
                updateTimeoutHandlingInfo();
                
            } catch (error) {
                console.error('❌ Erro ao aplicar filtros COM TIMEOUT HANDLING:', error);
            } finally {
                const applyBtn = document.getElementById('applyBtn');
                applyBtn.disabled = false;
                applyBtn.textContent = '🔍 Aplicar Filtros';
            }
        }

        // Atualizar período filtrado COM TIMEOUT HANDLING
        function updateFilteredPeriodWithTimeoutHandling() {
            if (filteredData.length === 0) {
                document.getElementById('periodInfo').textContent = '📅 Período: Sem dados · 0 registros';
                return;
            }
            
            const dates = filteredData.map(record => record.dia).filter(date => date);
            dates.sort();
            
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            const minFormatted = formatDateBR(minDate);
            const maxFormatted = formatDateBR(maxDate);
            
            document.getElementById('periodInfo').textContent = 
                `📅 Período: ${minFormatted} → ${maxFormatted} · ${filteredData.length.toLocaleString('pt-BR')} registros COM TIMEOUT HANDLING`;
        }

        // Limpar filtros
        function clearFilters() {
            console.log('🔄 Limpando filtros COM TIMEOUT HANDLING...');
            
            document.getElementById('filterUnidade').value = '';
            document.getElementById('filterLoja').value = '';
            document.getElementById('dataInicial').value = minISO;
            document.getElementById('dataFinal').value = maxISO;
            document.getElementById('filterPeriodo').value = '';
            document.getElementById('filterTurno').value = '';
            document.getElementById('filterCanal').value = '';
            document.getElementById('filterPagamento').value = '';
            document.getElementById('filterCancelado').value = '';
            
            applyFilters();
        }

        // Calcular KPIs COM TIMEOUT HANDLING
        async function calculateKPIsWithTimeoutHandling() {
            console.log('📊 Calculando KPIs COM TIMEOUT HANDLING...');
            
            try {
                if (filteredData.length === 0) {
                    const kpiElements = ['kpiPedidos', 'kpiTicketMedio', 'kpiFaturamento', 'kpiFaturamentoDia', 
                                       'kpiIncentivos', 'kpiIncentivosPercent', 'kpiFrete', 'kpiFaturamentoLiquido'];
                    
                    kpiElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = id.includes('Percent') ? '-%' : (id.includes('kpi') && !id.includes('Pedidos') ? 'R$ -' : '-');
                        }
                    });
                    
                    ['compPedidos', 'compTicketMedio', 'compFaturamento', 'compFaturamentoDia', 
                     'compIncentivos', 'compIncentivosPercent', 'compFrete', 'compFaturamentoLiquido'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.innerHTML = '<span class="comparison-neutral">— N/A</span>';
                        }
                    });
                    
                    return;
                }
                
                const pedidos = filteredData.length;
                const faturamento = filteredData.reduce((sum, record) => sum + parseBRNumber(record.fat), 0);
                const desconto = filteredData.reduce((sum, record) => sum + parseBRNumber(record.des), 0);
                const frete = filteredData.reduce((sum, record) => sum + parseBRNumber(record.fre), 0);
                
                const ticketMedio = pedidos > 0 ? faturamento / pedidos : 0;
                const faturamentoLiquido = faturamento - desconto;
                const incentivosPercent = faturamento > 0 ? (desconto / faturamento) * 100 : 0;
                
                const diasUnicos = [...new Set(filteredData.map(record => record.dia))].length;
                const faturamentoDia = diasUnicos > 0 ? faturamento / diasUnicos : 0;
                
                document.getElementById('kpiPedidos').textContent = pedidos.toLocaleString('pt-BR');
                document.getElementById('kpiTicketMedio').textContent = 'R$ ' + ticketMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiFaturamento').textContent = 'R$ ' + faturamento.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiFaturamentoDia').textContent = 'R$ ' + faturamentoDia.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiIncentivos').textContent = 'R$ ' + desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiIncentivosPercent').textContent = incentivosPercent.toFixed(1) + '%';
                document.getElementById('kpiFrete').textContent = 'R$ ' + frete.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiFaturamentoLiquido').textContent = 'R$ ' + faturamentoLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                console.log('✅ KPIs COM TIMEOUT HANDLING calculados');
                
            } catch (error) {
                console.error('❌ Erro ao calcular KPIs COM TIMEOUT HANDLING:', error);
            }
        }

        // Atualizar gráfico COM TIMEOUT HANDLING
        async function updateChartWithTimeoutHandling() {
            console.log('📈 Atualizando gráfico COM TIMEOUT HANDLING...');
            
            try {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                if (chart) {
                    chart.destroy();
                }
                
                if (filteredData.length === 0) {
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Receita Diária',
                                data: [],
                                borderColor: 'rgba(102, 126, 234, 1)',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: getChartOptionsWithTimeoutHandling()
                    });
                    return;
                }
                
                const dailyRevenue = {};
                filteredData.forEach(record => {
                    const day = record.dia;
                    if (day) {
                        dailyRevenue[day] = (dailyRevenue[day] || 0) + parseBRNumber(record.fat);
                    }
                });
                
                const sortedDays = Object.keys(dailyRevenue).sort();
                const revenues = sortedDays.map(day => dailyRevenue[day]);
                const labels = sortedDays.map(day => formatDateBR(day));
                
                // Otimização para gráficos com muitos pontos
                let finalLabels = labels;
                let finalRevenues = revenues;
                
                if (labels.length > 500) {
                    const step = Math.ceil(labels.length / 500);
                    finalLabels = labels.filter((_, index) => index % step === 0);
                    finalRevenues = revenues.filter((_, index) => index % step === 0);
                }
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: finalLabels,
                        datasets: [{
                            label: 'Receita Diária',
                            data: finalRevenues,
                            borderColor: 'rgba(139, 92, 246, 1)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: finalLabels.length > 200 ? 0 : 1,
                            pointHoverRadius: 3
                        }]
                    },
                    options: getChartOptionsWithTimeoutHandling()
                });
                
                console.log('✅ Gráfico COM TIMEOUT HANDLING atualizado');
                
            } catch (error) {
                console.error('❌ Erro ao atualizar gráfico COM TIMEOUT HANDLING:', error);
            }
        }

        // Opções do gráfico COM TIMEOUT HANDLING
        function getChartOptionsWithTimeoutHandling() {
            return {
                responsive: true,
                animation: {
                    duration: 300
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        labels: { color: 'white' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255,255,255,0.3)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: { 
                        ticks: { 
                            color: 'white',
                            maxTicksLimit: 20
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: { 
                        ticks: { 
                            color: 'white',
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };
        }

        // Inicializar tabela virtual COM TIMEOUT HANDLING
        async function initializeVirtualTableWithTimeoutHandling() {
            console.log('📋 Inicializando tabela virtual COM TIMEOUT HANDLING...');
            
            totalPages = Math.ceil(filteredData.length / pageSize);
            await updateVirtualTableWithTimeoutHandling();
        }

        // Atualizar tabela virtual COM TIMEOUT HANDLING
        async function updateVirtualTableWithTimeoutHandling() {
            try {
                if (filteredData.length === 0) {
                    document.getElementById('virtualTableBody').innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.6);">Nenhum dado encontrado</div>';
                    document.getElementById('tableInfo').textContent = '0 registros';
                    document.getElementById('paginationInfo').textContent = 'Página 0 de 0';
                    return;
                }

                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                const pageData = filteredData.slice(start, end);
                totalPages = Math.ceil(filteredData.length / pageSize);

                const tableBody = document.getElementById('virtualTableBody');
                const fragment = document.createDocumentFragment();

                pageData.forEach(record => {
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    
                    row.innerHTML = `
                        <div class="table-cell">${formatDateBR(record.dia) || '-'}</div>
                        <div class="table-cell">${record['Nome da loja'] || '-'}</div>
                        <div class="table-cell">R$ ${parseBRNumber(record.fat).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        <div class="table-cell">R$ ${parseBRNumber(record.des).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
                        <div class="table-cell">${record.turno || '-'}</div>
                    `;
                    
                    fragment.appendChild(row);
                });

                tableBody.innerHTML = '';
                tableBody.appendChild(fragment);

                const startRecord = (currentPage - 1) * pageSize + 1;
                const endRecord = Math.min(currentPage * pageSize, filteredData.length);
                
                document.getElementById('tableInfo').textContent = 
                    `${startRecord}-${endRecord} de ${filteredData.length.toLocaleString('pt-BR')} registros`;
                
                document.getElementById('paginationInfo').textContent = 
                    `Página ${currentPage} de ${totalPages}`;

                document.getElementById('prevBtn').disabled = currentPage <= 1;
                document.getElementById('nextBtn').disabled = currentPage >= totalPages;

                console.log(`✅ Tabela virtual COM TIMEOUT HANDLING atualizada: página ${currentPage}/${totalPages}`);

            } catch (error) {
                console.error('❌ Erro ao atualizar tabela virtual COM TIMEOUT HANDLING:', error);
            }
        }

        // Navegação da tabela virtual
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateVirtualTableWithTimeoutHandling();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                updateVirtualTableWithTimeoutHandling();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            updateVirtualTableWithTimeoutHandling();
        }

        // Forçar recarregamento COM TIMEOUT HANDLING
        function forceReload() {
            console.log('🔄 Forçando recarregamento COM TIMEOUT HANDLING...');
            location.reload();
        }

        // Verificar timeout handling
        function checkTimeoutHandling() {
            console.log('🔄 Verificando sistema COM TIMEOUT HANDLING...');
            
            const totalRecords = allData.length;
            const totalPages = Math.ceil(totalRecords / 1000);
            
            alert(`🔄 SISTEMA COM TIMEOUT HANDLING CONFIRMADO!

📊 Total de Registros: ${totalRecords.toLocaleString('pt-BR')}
📄 Páginas Carregadas: ${totalLoadedPages.toLocaleString('pt-BR')}
🔄 Total de Retries: ${totalRetries.toLocaleString('pt-BR')}
⏱️ Tempo de Carregamento: ${(performanceMetrics.loadTime / 1000).toFixed(2)}s
🚀 Throughput: ${performanceMetrics.throughput.toLocaleString('pt-BR')} registros/seg

✅ TIMEOUT HANDLING ATIVO: Tratamento robusto de timeouts
✅ RETRY SYSTEM: Até ${TIMEOUT_CONFIG.maxRetries} tentativas por página
✅ BACKOFF EXPONENCIAL: Delays inteligentes entre tentativas
🔄 SISTEMA ROBUSTO E CONFIÁVEL!`);
        }

        // Atualizar informações do timeout handling
        function updateTimeoutHandlingInfo() {
            const totalRecords = allData.length;
            const filteredRecords = filteredData.length;
            const loadedPages = totalLoadedPages;
            const retries = totalRetries;
            
            document.getElementById('timeoutInfo').textContent = 
                `🔄 Sistema COM TIMEOUT HANDLING: ${totalRecords.toLocaleString('pt-BR')} registros · ${loadedPages.toLocaleString('pt-BR')} páginas · ${retries} retries · ${filteredRecords.toLocaleString('pt-BR')} filtrados`;
        }

        // Função de debug COM TIMEOUT HANDLING
        function debugInfo() {
            console.log('🔄 === DEBUG INFO COM TIMEOUT HANDLING ===');
            console.log('📊 Total de registros:', allData.length.toLocaleString('pt-BR'));
            console.log('🔍 Registros filtrados:', filteredData.length.toLocaleString('pt-BR'));
            console.log('📄 Páginas carregadas:', totalLoadedPages.toLocaleString('pt-BR'));
            console.log('🔄 Total de retries:', totalRetries.toLocaleString('pt-BR'));
            console.log('📅 Período:', minISO, '→', maxISO);
            console.log('⚡ Performance:', performanceMetrics);
            console.log('🧠 Memória estimada:', (allData.length * 0.7 / 1024).toFixed(1), 'KB');
            console.log('📋 Paginação:', `Página ${currentPage}/${totalPages}, ${pageSize} por página`);
            console.log('✅ Carregamento completo:', isLoadingComplete);
            console.log('🔄 TIMEOUT CONFIG:', TIMEOUT_CONFIG);
            
            if (filteredData.length > 0) {
                console.log('📋 Amostra de dados filtrados:', filteredData.slice(0, 3));
                
                const testDate = '2025-08-10';
                const testData = filteredData.filter(record => record.dia === testDate);
                console.log(`🎯 Dados para ${testDate}:`, testData.length, 'registros');
                
                if (testData.length > 0) {
                    const totalPedidos = testData.length;
                    const totalFaturamento = testData.reduce((sum, record) => sum + parseBRNumber(record.fat), 0);
                    const totalDesconto = testData.reduce((sum, record) => sum + parseBRNumber(record.des), 0);
                    console.log(`📊 ${testDate} - Pedidos: ${totalPedidos}, Faturamento: R$ ${totalFaturamento.toFixed(2)}, Desconto: R$ ${totalDesconto.toFixed(2)}`);
                }
            }
            
            console.log('🔄 === FIM DEBUG COM TIMEOUT HANDLING ===');
        }
    </script>
</body>
</html>

