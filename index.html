<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard de Vendas ‚Ä¢ Filtros</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#0b1220;--ink:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #1f2937}
  .brand{font-weight:700}
  .row{display:flex;gap:16px;flex-wrap:wrap;margin:16px 20px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px}
  .kpi .v{font-size:22px;font-weight:700;margin-top:2px}
  .muted{color:var(--muted)}
  .filters{display:grid;grid-template-columns:repeat(6,minmax(180px,1fr));gap:10px}
  select, input[type="date"], input[type="text"]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:var(--ink)}
  button{background:var(--accent);color:#002;border:0;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer}
  button.secondary{background:#1f2937;color:var(--ink);border:1px solid #334155}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:14px}
  canvas{width:100%;height:360px;background:#0b1220;border-radius:10px}
  #debug{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;border-radius:12px;padding:12px;max-height:340px;overflow:auto;border:1px solid #1f2937}
  details summary{cursor:pointer}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .col-map{display:grid;grid-template-columns:repeat(6,minmax(180px,1fr));gap:10px;margin-top:8px}
</style>
</head>
<body>
<header>
  <div class="brand">Vendas ‚Ä¢ Filtros consistentes</div>
  <div class="flex">
    <input id="url" placeholder="Supabase URL" style="width:320px" />
    <input id="key" placeholder="Anon key" style="width:420px" />
    <button id="saveConn" class="secondary">Salvar</button>
  </div>
</header>

<section class="row">
  <div class="card" style="flex:1">
    <details open>
      <summary class="muted">Per√≠odo & A√ß√µes</summary>
      <div class="filters" style="grid-template-columns:repeat(5,minmax(180px,1fr))">
        <div><label class="muted">De</label><input type="date" id="dini"/></div>
        <div><label class="muted">At√©</label><input type="date" id="dfim"/></div>
        <div><label class="muted">Cancelado</label>
          <select id="cancel" multiple size="3">
            <option value="">(Todos)</option>
            <option>N√£o</option>
            <option>Sim</option>
          </select>
        </div>
        <div class="flex" style="align-self:end;gap:10px">
          <button id="apply">Aplicar</button>
          <button id="smoke" class="secondary">Smoke tests</button>
        </div>
      </div>
    </details>

    <details style="margin-top:10px">
      <summary class="muted">Mapeamento de Colunas (para preencher as listas)</summary>
      <div class="col-map">
        <div><label class="muted">Unidade ‚Üê</label><select id="map-unid"></select></div>
        <div><label class="muted">Lojas ‚Üê</label><select id="map-loja"></select></div>
        <div><label class="muted">Turno ‚Üê</label><select id="map-turno"></select></div>
        <div><label class="muted">Canal ‚Üê</label><select id="map-canal"></select></div>
        <div><label class="muted">Pagamento ‚Üê</label><select id="map-pag"></select></div>
        <div><label class="muted">Cancelado ‚Üê</label><select id="map-cancel"></select></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button id="saveMap" class="secondary">Salvar mapeamento</button>
        <span class="muted">O filtro <b>Lojas</b> vem de <code>vw_vendas.loja</code> (definido no SQL).</span>
      </div>
    </details>
  </div>
</section>

<section class="row">
  <div class="card" style="flex:1">
    <div class="muted" style="margin-bottom:8px">Filtros</div>
    <div class="filters">
      <div><label class="muted">Unidades</label><select id="unids" multiple size="8"></select></div>
      <div><label class="muted">Lojas</label><select id="lojas" multiple size="8"></select></div>
      <div><label class="muted">Turnos</label><select id="turnos" multiple size="8"></select></div>
      <div><label class="muted">Canais</label><select id="canais" multiple size="8"></select></div>
      <div><label class="muted">Pagamentos</label><select id="pags" multiple size="8"></select></div>
      <div style="align-self:end"><button id="limpar" class="secondary">Limpar</button></div>
    </div>
  </div>
</section>

<section class="row">
  <div class="card kpis" style="flex:1">
    <div class="kpi"><div class="muted">Pedidos</div><div id="kpi-ped" class="v">‚Äî</div></div>
    <div class="kpi"><div class="muted">Faturamento</div><div id="kpi-fat" class="v">‚Äî</div></div>
    <div class="kpi"><div class="muted">Descontos</div><div id="kpi-des" class="v">‚Äî</div></div>
    <div class="kpi"><div class="muted">Frete</div><div id="kpi-fre" class="v">‚Äî</div></div>
  </div>
</section>

<section class="row">
  <div class="grid" style="flex:1">
    <div class="card"><div class="muted">Dia da semana</div><canvas id="c-dow"></canvas></div>
    <div class="card"><div class="muted">M√™s</div><canvas id="c-month"></canvas></div>
    <div class="card"><div class="muted">Hora</div><canvas id="c-hour"></canvas></div>
    <div class="card"><div class="muted">Turno</div><canvas id="c-shift"></canvas></div>
  </div>
</section>

<section class="row">
  <div class="card" style="flex:1">
    <div class="muted">Carregar Excel</div>
    <div class="flex">
      <input type="file" id="file" accept=".xlsx,.xls,.csv"/>
      <button id="btnUpload" class="secondary">Validar arquivo</button>
      <span class="muted">Valida no navegador; grava√ß√£o no banco depende de RPC de ingest√£o.</span>
    </div>
  </div>
</section>

<section class="row">
  <div class="card" style="flex:1">
    <div class="muted">Debug</div>
    <div id="debug">Pronto.</div>
  </div>
</section>

<script>
const DEFAULT_URL='https://uahmcfzerofhzjvlzrqc.supabase.co';
const DEFAULT_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const $=s=>document.querySelector(s);
const log=(...a)=>{ const d=$('#debug'); d.textContent += '\\n' + a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' '); d.scrollTop=d.scrollHeight; };
const setTxt=(s,v)=>{$(s).textContent=v;};
const unwrapOne=x=>Array.isArray(x)?(x[0]||{}):(x||{});
const mvals=sel=>Array.from($(sel).selectedOptions).map(o=>o.value).filter(v=>v!=='');
const fmt=n=> (n==null||Number.isNaN(+n))?'0':(+n).toLocaleString('pt-BR',{maximumFractionDigits:2});

function loadConn(){ $('#url').value=localStorage.getItem('sb_url')||DEFAULT_URL; $('#key').value=localStorage.getItem('sb_key')||DEFAULT_KEY; }
function saveConn(){ localStorage.setItem('sb_url',$('#url').value.trim()); localStorage.setItem('sb_key',$('#key').value.trim()); }
async function rpc(fn, body){
  const url=$('#url').value.trim(), key=$('#key').value.trim();
  const res = await fetch(`${url}/rest/v1/rpc/${fn}`,{
    method:'POST',
    headers:{apikey:key,Authorization:`Bearer ${key}`,'Content-Type':'application/json',Prefer:'count=none'},
    body: JSON.stringify(body||{})
  });
  if(!res.ok) throw new Error(`${fn} -> ${res.status} ${await res.text()}`);
  return res.json();
}

/*** Mapeamento auxiliar (apenas UI das listas). Back-end usa vw_vendas.loja ***/
const DEFAULT_MAP={unid:'unidade',loja:'loja',turno:'turno',canal:'canal',pag:'pagamento_base',cancel:'cancelado'};
function getMap(){ try{return JSON.parse(localStorage.getItem('colmap')||'{}')}catch{return{}} }
function setMap(m){ localStorage.setItem('colmap',JSON.stringify(m)) }
async function getColumns(){
  const url=$('#url').value.trim(), key=$('#key').value.trim();
  const r = await fetch(`${url}/rest/v1/vw_vendas?select=*&limit=1`,{headers:{apikey:key,Authorization:`Bearer ${key}`}});
  if(!r.ok){ log('‚ö†Ô∏è getColumns:', await r.text()); return Object.values(DEFAULT_MAP); }
  const arr=await r.json(); return Object.keys(arr[0]||{});
}
async function mountMappingUI(){
  const cols=await getColumns(); const m=Object.assign({},DEFAULT_MAP,getMap());
  const fill=(id,val)=>{ const el=$(id); el.innerHTML=''; cols.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;el.appendChild(o)}); el.value=val; };
  fill('#map-unid',m.unid); fill('#map-loja',m.loja); fill('#map-turno',m.turno);
  fill('#map-canal',m.canal); fill('#map-pag',m.pag); fill('#map-cancel',m.cancel);
  $('#saveMap').onclick=()=>{ const nm={unid:$('#map-unid').value,loja:$('#map-loja').value,turno:$('#map-turno').value,canal:$('#map-canal').value,pag:$('#map-pag').value,cancel:$('#map-cancel').value}; setMap(nm); log('üíæ Mapeamento salvo:',nm); loadFilters(); };
}

const encodeSel = col => encodeURIComponent(`"${col}"`);
async function distinctFiltered(col, dini, dfim){
  if(!col) return [];
  const url=$('#url').value.trim(), key=$('#key').value.trim();
  const qs = new URLSearchParams();
  qs.set('select', encodeSel(col));
  if(dini&&dfim) qs.set('and',`(dia.gte.${dini},dia.lte.${dfim})`);
  else if(dini) qs.set('dia',`gte.${dini}`);
  else if(dfim) qs.set('dia',`lte.${dfim}`);
  qs.set('limit','10000');
  const r = await fetch(`${url}/rest/v1/vw_vendas?${qs.toString()}`,{headers:{apikey:key,Authorization:`Bearer ${key}`}});
  if(!r.ok){ log('‚ö†Ô∏è distinctFiltered',col,await r.text()); return []; }
  const rows = await r.json();
  const vals = rows.map(x=>x[col]).filter(v=>v!=null && v!=='');
  const uniq = [...new Set(vals.map(v=>v.toString()))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
  log(`‚Ä¢ ${col}: ${uniq.length} distintos`, uniq.slice(0,10));
  return uniq;
}
async function loadFilters(){
  const dini=$('#dini').value||null, dfim=$('#dfim').value||null;
  const m=Object.assign({},DEFAULT_MAP,getMap());
  const [unids,lojas,turnos,canais,pags]=await Promise.all([
    distinctFiltered(m.unid,dini,dfim),
    distinctFiltered(m.loja,dini,dfim),
    distinctFiltered(m.turno,dini,dfim),
    distinctFiltered(m.canal,dini,dfim),
    distinctFiltered(m.pag,dini,dfim),
  ]);
  const fill=(sel,arr)=>{ const el=$(sel); el.innerHTML=''; arr.forEach(v=>{const o=document.createElement('option'); o.value=(v||'').toString().toLowerCase(); o.textContent=v||''; el.appendChild(o);}); };
  fill('#unids',unids); fill('#lojas',lojas); fill('#turnos',turnos); fill('#canais',canais); fill('#pags',pags);
  log('üîé Listas conclu√≠das',{unids:unids.length,lojas:lojas.length,turnos:turnos.length,canais:canais.length,pags:pags.length});
}

/*** Gr√°ficos simples ***/
function drawBar(id,labels,values){
  const c=document.getElementById(id), ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const w=c.width,h=c.height,p=36,bw=(w-p*2)/Math.max(1,labels.length), vmax=Math.max(1,...values.map(v=>+v||0));
  ctx.strokeStyle='#334155'; ctx.beginPath(); ctx.moveTo(p,h-p); ctx.lineTo(w-p,h-p); ctx.stroke();
  for(let i=0;i<labels.length;i++){ const v=+values[i]||0, x=p+i*bw+6, bh=(v/vmax)*(h-p*2), y=(h-p)-bh;
    ctx.fillStyle='#22d3ee'; ctx.fillRect(x,y,bw-12,bh);
    ctx.fillStyle='#94a3b8'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.fillText(labels[i], x+(bw-12)/2, h-p+14);
  }
}
const sum=(arr,key='total')=>arr.reduce((a,x)=>a+(+x[key]||0),0);
function checkSum(label,rows,kfat){ const s=sum(rows,'total'); const ok=Math.abs(s-(+kfat||0))<1e-6; log(`${ok?'‚úÖ':'‚ùå'} ${label} soma=${fmt(s)} vs KPI.fat=${fmt(kfat)} ${ok?'(ok)':'(mismatch)'}`); }

/*** Par√¢metros e chamadas ***/
const mvals=sel=>Array.from($(sel).selectedOptions).map(o=>o.value).filter(v=>v!=='');
function buildParams(){
  const canc=mvals('#cancel');
  let p_cancel=null;
  if(canc.length===1){ const v=canc[0]; if(['sim','n√£o','nao','naÃÉo','nao'].includes(v)) p_cancel = v[0].toUpperCase()+v.slice(1); if(['Sim','N√£o'].includes(v)) p_cancel=v; }
  return {
    p_dini: $('#dini').value||null,
    p_dfim: $('#dfim').value||null,
    p_unids: mvals('#unids').length? mvals('#unids'): null,
    p_lojas: mvals('#lojas').length? mvals('#lojas'): null,
    p_turnos: mvals('#turnos').length? mvals('#turnos'): null,
    p_canais: mvals('#canais').length? mvals('#canais'): null,
    p_pags:   mvals('#pags').length?   mvals('#pags')  : null,
    p_cancelado: p_cancel
  };
}
async function applyAll(){
  const p=buildParams(); log('‚Üí KPI params',p);
  const k=(await rpc('kpi_vendas_v2',p))[0]||{};
  setTxt('#kpi-ped',fmt(k.pedidos)); setTxt('#kpi-fat',fmt(k.fat)); setTxt('#kpi-des',fmt(k.des)); setTxt('#kpi-fre',fmt(k.fre)); log('‚úÖ KPI',k);

  const dow=await rpc('chart_vendas_dow_v2',p);
  drawBar('c-dow', dow.map(d=>['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][d.dow??0]), dow.map(d=>d.total)); checkSum('DOW',dow,k.fat);

  const mon=await rpc('chart_vendas_mes_v2',p);
  drawBar('c-month', mon.map(d=>d.ym), mon.map(d=>d.total)); checkSum('M√äS',mon,k.fat);

  let hor; try{ hor=await rpc('chart_vendas_hora_v3',p);}catch{ hor=await rpc('chart_vendas_hora_v2',p); }
  drawBar('c-hour', hor.map(d=>String(d.h)), hor.map(d=>d.total)); checkSum('HORA',hor,k.fat);

  const tur=await rpc('chart_vendas_turno_v2',p);
  drawBar('c-shift', tur.map(d=>d.turno), tur.map(d=>d.total)); checkSum('TURNO',tur,k.fat);
}
async function smoke(){
  const p=buildParams(), k=((await rpc('kpi_vendas_v2',p))[0]||{});
  const [d,m,h,t]=await Promise.all([
    rpc('chart_vendas_dow_v2',p),
    rpc('chart_vendas_mes_v2',p),
    (async()=>{ try{return await rpc('chart_vendas_hora_v3',p);}catch{return await rpc('chart_vendas_hora_v2',p);} })(),
    rpc('chart_vendas_turno_v2',p),
  ]);
  log('SMOKE ‚Üí KPI.fat',fmt(k.fat));
  log('  DOW  sum=',fmt(sum(d)), Math.abs(sum(d)-k.fat)<1e-6?'‚úÖ':'‚ùå');
  log('  M√äS  sum=',fmt(sum(m)), Math.abs(sum(m)-k.fat)<1e-6?'‚úÖ':'‚ùå');
  log('  HORA sum=',fmt(sum(h)), Math.abs(sum(h)-k.fat)<1e-6?'‚úÖ':'‚ùå');
  log('  TURNO sum=',fmt(sum(t)), Math.abs(sum(t)-k.fat)<1e-6?'‚úÖ':'‚ùå');
}

/*** Upload local ***/
let pickedFile=null; $('#file').addEventListener('change',e=>{pickedFile=e.target.files?.[0]||null; log('üìÑ Selecionado:', pickedFile?pickedFile.name:'(nenhum)');});
$('#btnUpload').addEventListener('click', async()=>{
  if(!pickedFile){ log('‚ö†Ô∏è Selecione um arquivo'); return; }
  if(typeof XLSX==='undefined'){ log('‚ùå SheetJS bloqueado. Hospede xlsx.full.min.js no Storage.'); return; }
  const ab=await pickedFile.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{defval:null}); log(`‚úÖ Lido: ${rows.length} linhas (apenas valida√ß√£o local)`);
});

/*** INIT ***/
async function init(){
  $('#url').value=localStorage.getItem('sb_url')||DEFAULT_URL;
  $('#key').value=localStorage.getItem('sb_key')||DEFAULT_KEY;
  $('#saveConn').onclick=()=>{localStorage.setItem('sb_url',$('#url').value.trim()); localStorage.setItem('sb_key',$('#key').value.trim());};

  const today=new Date(), dfim=today.toISOString().slice(0,10), dini=new Date(today-29*86400000).toISOString().slice(0,10);
  $('#dini').value=dini; $('#dfim').value=dfim;

  $('#apply').onclick=async()=>{ await loadFilters(); await applyAll(); };
  $('#smoke').onclick=smoke;
  $('#limpar').onclick=()=>{ ['#unids','#lojas','#turnos','#canais','#pags','#cancel'].forEach(id=>Array.from($(id).options).forEach(o=>o.selected=false)); applyAll(); };

  try{
    const ping=await rpc('kpi_vendas_v2',{p_dini:'2025-05-14',p_dfim:'2025-05-14',p_unids:null,p_lojas:null,p_turnos:null,p_canais:null,p_pags:null,p_cancelado:null});
    log('‚úÖ Supabase client ok'); log('Ping KPI (bruto):', ping); log('Ping KPI (unwrap):', ((ping||[])[0]||{}));
  }catch(e){ log('‚ùå conex√£o', e.message); }

  await mountMappingUI();
  await loadFilters();
  await applyAll();
}
init();
</script>
</body>
</html>
