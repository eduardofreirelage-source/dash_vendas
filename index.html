<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äì Upload1</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#0b1220;--muted:#667085;--ok:#067a46;--bad:#b91c1c}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-top:12px}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--bad)}
    #log,#preview,#map{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#f8fafc;border:1px dashed var(--line);border-radius:10px;padding:10px;max-height:280px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:800px){.row{grid-template-columns:1fr}}
    input[type=file]{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .hl{background:#eef6ff;border:1px solid #dbeafe;padding:2px 6px;border-radius:6px}
  </style>

  <!-- XLSX UMD com fallback de CDN -->
  <script>
    (function(){
      const urls=[
        'https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js',
        'https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js',
        'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
      ];
      (function load(i){
        const s=document.createElement('script');
        s.src=urls[i]; s.async=true; s.crossOrigin='anonymous';
        s.onload=()=>console.log('[XLSX] OK:',s.src);
        s.onerror=()=>{ if(i+1<urls.length) load(i+1); else console.error('[XLSX] Falhou em todos os CDNs'); };
        document.head.appendChild(s);
      })(0);
    })();
  </script>

  <!-- Supabase (opcional) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div><strong>Upload</strong> <span class="muted">(.xlsx/.xls/.csv com ‚ÄúData da venda‚Äù)</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" />
          <button id="btnSave" class="btn" disabled>‚¨ÜÔ∏è Salvar no banco</button>
          <button id="btnClear" class="btn" title="Limpar pr√©via">üßπ Limpar</button>
        </div>
      </div>
      <div id="status" class="muted" style="margin-top:8px">Pr√©via pronta (supabase desativado).</div>
      <div id="log" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="muted">Pr√©via (5 primeiras linhas v√°lidas):</div>
          <div id="preview"></div>
        </div>
        <div>
          <div class="muted">Mapeamento escolhido:</div>
          <div id="map"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted"><strong>Ajuda r√°pida</strong></div>
      <ul class="muted" style="margin-top:6px">
        <li>Se aparecer ‚Äú<span class="hl">null value in column "dia"</span>‚Äù, nenhuma coluna de data foi reconhecida. Renomeie para <em>Data da venda</em> / <em>Data do pedido</em>.</li>
        <li>Aceita datas Excel (serial) ou <code>dd/mm/aaaa</code> (com hora opcional).</li>
      </ul>
    </div>
  </div>

  <script>
    // ======= CONFIG SUPABASE =======
    const ENABLE_SUPABASE = false;   // <<< mude para true para gravar
    const SUPABASE_URL = 'https://SEU-PROJETO.supabase.co';
    const SUPABASE_ANON_KEY = 'SEU-ANON-KEY';
    const TABLE = 'vendas_xlsx';

    const supa = (ENABLE_SUPABASE && window.supabase)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    // ======= HELPERS =======
    const $ = s => document.querySelector(s);
    const setStatus = (t, cls='') => { const el=$('#status'); el.className=cls; el.textContent=t }
    const log = (...a)=>{$('#log').textContent += a.join(' ') + '\n'}

    const sanitize = s => (s??'').toString()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/\s+/g,' ').trim().toLowerCase();

    function excelSerialToJSDate(n){
      try{
        const utcDays = Math.floor(n - 25569);
        const utc = utcDays * 86400;
        const base = new Date(utc * 1000);
        const frac = n - Math.floor(n) + 1e-7;
        let secs = Math.floor(86400 * frac);
        const s = secs % 60; secs -= s;
        const h = Math.floor(secs / 3600);
        const m = Math.floor(secs / 60) % 60;
        base.setFullYear(base.getUTCFullYear(), base.getUTCMonth(), base.getUTCDate());
        base.setHours(h, m, s, 0);
        return base;
      }catch{ return null }
    }
    function parseBRDateTime(s){
      if(typeof s!=='string') return null;
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(!m) return null;
      let [_, d, M, y, h, mm] = m;
      if(y.length===2) y = '20'+y;
      const dt = new Date(Number(y), Number(M)-1, Number(d), Number(h||0), Number(mm||0), 0, 0);
      return isNaN(dt) ? null : dt;
    }
    const toISO = d => d.toISOString().slice(0,10);
    const toHour = d => d.getHours();
    const nnum = v => Number((v??0).toString().replace(',','.')) || 0;

    function findColumn(cols, cands){
      const low = cols.map(c=>sanitize(c));
      for(const c of cands){
        const i = low.indexOf(sanitize(c));
        if(i>=0) return cols[i];
      }
      for(const c of cols){
        const s = sanitize(c);
        let ok = true;
        for(const w of sanitize(cands[0]).split(/\s+/)) if(!s.includes(w)){ok=false;break;}
        if(ok) return c;
      }
      return null;
    }

    function summarizeMap(mp){
      return [
        `dia: ${mp.colDate || '(n√£o encontrado)'}`,
        `hora: ${mp.colHour || '(derivado/ausente)'}`,
        `unidade: ${mp.colUnid || '‚Äî'}`,
        `loja: ${mp.colLojaCod || mp.colLojaNome || '‚Äî'}`,
        `canal: ${mp.colCanal || '‚Äî'}`,
        `pagamento_base: ${mp.colPag || '‚Äî'}`,
        `cancelado: ${mp.colCancel || '‚Äî'}`,
        `pedidos: ${mp.colPed || '(default 1)'}`,
        `fat: ${mp.colFat || '(n√£o mapeado)'}`,
        `des: ${mp.colDes || '(n√£o mapeado)'}`,
        `fre: ${mp.colFre || '(n√£o mapeado)'}`
      ].join('\n');
    }

    async function insertChunks(rows, n=800, onProgress=null){
      for(let i=0;i<rows.length;i+=n){
        const part=rows.slice(i,i+n);
        const {error} = await supa.from(TABLE).insert(part);
        if(error) throw error;
        if(onProgress) onProgress(Math.min(i+n, rows.length), rows.length);
      }
    }

    let lastRows = [];

    async function handleFile(file){
      $('#log').textContent=''; $('#preview').textContent=''; $('#map').textContent='';
      setStatus(`Lendo ${file.name}‚Ä¶`);
      const buf = await file.arrayBuffer();

      if(!window.XLSX){ setStatus('XLSX ainda carregando. Tente novamente em 1‚Äì2s.', 'bad'); return; }

      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, {defval:null});
      if(!data.length){ setStatus('Arquivo sem linhas.', 'bad'); return; }

      const cols = Object.keys(data[0]||{});
      const colDate = findColumn(cols, ['data da venda','data venda','data do pedido','data pedido','data','data hora','data/hora','datahora']);
      const colHour = findColumn(cols, ['hora','horario']);
      const colUnid = findColumn(cols, ['unidade']);
      const colLojaCod = findColumn(cols, ['codigo da loja','c√≥digo da loja','cod loja']);
      const colLojaNome= findColumn(cols, ['nome da loja','loja']);
      const colCanal   = findColumn(cols, ['canal de venda','canal','origem']);
      const colPag     = findColumn(cols, ['pagamento','meio de pagamento','tipo pagamento','pagamento base']);
      const colCancel  = findColumn(cols, ['esta cancelado','est√° cancelado','cancelado']);
      const colPed     = findColumn(cols, ['itens','qtd','quantidade']);
      const colFat     = findColumn(cols, ['valor entregador','total','faturamento','faturamento liquido','fat']);
      const colDes     = findColumn(cols, ['desconto']);
      const colFre     = findColumn(cols, ['entrega','frete']);

      const mapping = {colDate,colHour,colUnid,colLojaCod,colLojaNome,colCanal,colPag,colCancel,colPed,colFat,colDes,colFre};
      $('#map').textContent = summarizeMap(mapping);

      if(!colDate){
        setStatus('N√£o encontrei a coluna de DATA. Renomeie para ‚ÄúData da venda‚Äù (ou similar) e reenvie.', 'bad');
        log('Colunas detectadas:', JSON.stringify(cols, null, 2));
        return;
      }

      let ok=0,bad=0;
      const out=[], dropped=[];
      for(const r of data){
        let d = r[colDate], jsd=null;
        if(typeof d==='number') jsd = excelSerialToJSDate(d);
        if(!jsd && typeof d==='string') jsd = parseBRDateTime(d);
        if(!jsd && d instanceof Date && !isNaN(d)) jsd = d;
        if(!jsd){ bad++; dropped.push({motivo:'data inv√°lida', amostra:d}); continue; }

        const dia = toISO(jsd);

        let hora=null;
        if(colHour && r[colHour]!=null && r[colHour]!==''){
          const hv = r[colHour];
          if(typeof hv==='number'){ hora = (hv>=0 && hv<=23) ? Math.trunc(hv) : toHour(excelSerialToJSDate(hv)); }
          else if(typeof hv==='string'){ const m = hv.match(/(\d{1,2})/); hora = m ? Number(m[1]) : null; }
        } else {
          hora = toHour(jsd);
        }
        if(!(hora>=0 && hora<=23)) hora = null;

        const unidade = colUnid ? String(r[colUnid]??'').trim() : null;
        const loja    = colLojaCod ? String(r[colLojaCod]??'').trim()
                      : colLojaNome ? String(r[colLojaNome]??'').trim() : null;
        const canal   = colCanal ? String(r[colCanal]??'').trim() : null;
        const pagamento_base = colPag ? String(r[colPag]??'').trim() : null;
        const cancelRaw = colCancel ? String(r[colCancel]??'').trim().toLowerCase() : 'n√£o';
        const cancelado = (cancelRaw==='sim'||cancelRaw==='true'||cancelRaw==='1') ? 'Sim' : 'N√£o';
        const pedidos = colPed ? Number(r[colPed]??0) : 1;

        const fat = nnum(r[colFat]); const des = nnum(r[colDes]); const fre = nnum(r[colFre]);

        out.push({ dia, hora, unidade, loja, canal, pagamento_base, cancelado, pedidos, fat, des, fre });
        ok++;
      }

      lastRows = out;
      $('#btnSave').disabled = !(ENABLE_SUPABASE && supa && lastRows.length>0);

      $('#preview').textContent = out.slice(0,5).map(o=>JSON.stringify(o)).join('\n') || '(sem linhas v√°lidas)';
      log(`Linhas lidas: ${data.length}`);
      log(`V√°lidas: ${ok}`);
      if(bad>0) log(`Descartadas: ${bad} (exemplo: ${JSON.stringify(dropped[0]||{},null,2)})`);

      setStatus(ENABLE_SUPABASE ? 'Pr√©via pronta. Clique ‚ÄúSalvar no banco‚Äù.' : 'Pr√©via pronta (supabase desativado).', ENABLE_SUPABASE ? '' : 'muted');
    }

    async function saveToDb(){
      if(!(ENABLE_SUPABASE && supa)){ setStatus('Ative o Supabase nas configs do arquivo.', 'bad'); return; }
      if(!lastRows.length){ setStatus('Nada para salvar.', 'bad'); return; }
      try{
        setStatus(`Gravando ${lastRows.length} linha(s)‚Ä¶`);
        await insertChunks(lastRows, 800, (done,total)=>setStatus(`Gravando‚Ä¶ ${done}/${total}`));
        setStatus(`‚úÖ Gravado: ${lastRows.length} linha(s).`, 'ok');
      }catch(e){
        setStatus(`Erro ao gravar: ${e.message}`, 'bad');
        log('Detalhes:', JSON.stringify(e,null,2));
      }
    }

    // ======= Eventos =======
    $('#fileExcel').addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return;
      setStatus(`Arquivo: ${f.name}`);
      handleFile(f);
    });
    $('#btnSave').addEventListener('click', saveToDb);
    $('#btnClear').addEventListener('click', ()=>{
      $('#fileExcel').value = '';
      $('#log').textContent = '';
      $('#preview').textContent = '';
      $('#map').textContent = '';
      $('#btnSave').disabled = true;
      lastRows = [];
      setStatus('‚Äî');
    });
  </script>
</body>
</html>
