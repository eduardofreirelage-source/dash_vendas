<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard – Upload para vendas_xlsx</title>
<style>
  :root { color-scheme: dark; --bg:#0e1116; --fg:#e6edf3; --muted:#9aa4ad; --ok:#1f6feb; --chip:#30363d; --card:#11151c; --accent:#2ea043; --warn:#d29922; --bad:#f85149; }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji";}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px;}
  h1{margin:0 0 16px;font-weight:700;font-size:28px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;background:var(--card);border:1px solid var(--chip);padding:12px 12px;border-radius:10px}
  .btn{appearance:none;border:1px solid var(--chip);background:#1a1f24;color:var(--fg);padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn:hover{border-color:#3b434b}
  .btn.ok{background:var(--ok);border-color:var(--ok)}
  .btn.ghost{background:transparent}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:var(--chip);padding:4px 10px;border-radius:999px;color:var(--muted);font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .card{background:var(--card);border:1px solid var(--chip);border-radius:10px;padding:12px}
  textarea{width:100%;background:#0b0f14;color:#c9d1d9;border:1px solid #30363d;border-radius:8px;padding:10px;min-height:420px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
  .help{margin-top:12px;background:var(--card);border:1px solid var(--chip);border-radius:10px;padding:12px;color:var(--muted)}
  .status{margin-left:auto;color:var(--muted);font-size:12px}
  .warn{background:#2a1f00;border:1px solid #4d3b00;color:#ffda6b;padding:6px 10px;border-radius:8px}
  .okmsg{background:#001e12;border:1px solid #003d25;color:#5cffb1;padding:6px 10px;border-radius:8px}
  .err{color:#ffb4b4}
  .kbd{background:#0b0f14;border:1px solid #30363d;border-bottom-width:2px;border-radius:6px;padding:1px 6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard</h1>

  <div class="bar">
    <span class="chip">.csv</span>
    <span class="chip">.xlsx / .xls</span>
    <small class="chip">Excel serial, dd/mm/aaaa ou yyyy-mm-dd. Se vier <b>data+hora</b>, extraímos a hora automaticamente.</small>

    <input id="file" type="file" accept=".csv,.xlsx,.xls" class="btn" />
    <button id="saveBtn" class="btn ok">Salvar no banco</button>
    <button id="clearBtn" class="btn ghost">Limpar UI</button>
    <span id="status" class="status">—</span>
  </div>

  <div class="chips" style="margin:10px 0 0 4px">
    <span class="chip">Leitor Excel: <span id="xlsxStat">verificando…</span></span>
    <span class="chip">Linhas <b id="totAll">0</b></span>
    <span class="chip">Válidas <b id="totOk">0</b></span>
    <span class="chip">Puladas (sem data) <b id="totSkip">0</b></span>
  </div>

  <div class="row">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Prévia (5 primeiras linhas válidas):</strong>
        <small class="warn" id="xlsxWarn" style="display:none">Arquivo Excel selecionado, mas a biblioteca XLSX local não foi encontrada. Tentando CDN…</small>
      </div>
      <textarea id="preview" readonly>—</textarea>
    </div>
    <div class="card">
      <strong>Mapeamento escolhido:</strong>
      <textarea id="mapping" readonly>—</textarea>
    </div>
  </div>

  <div class="help">
    <ul style="margin:0 0 8px 16px">
      <li>Se aparecer <span class="kbd">"null value in column <b>dia</b>"</span>, alguma linha veio sem data. Eu pulo essas linhas no upload.</li>
      <li>Datas aceitas: Excel serial, <b>dd/mm/aaaa</b> ou <b>yyyy-mm-dd</b>. Se vier data+hora, eu extraio a <b>hora</b> automaticamente.</li>
      <li>Se a sua rede bloquear CDN, deixe o arquivo <code>xlsx.full.min.js</code> na <b>mesma pasta</b> deste HTML.</li>
    </ul>
    <div id="flash" class=""></div>
  </div>
</div>

<!-- 1) Tenta carregar a biblioteca local -->
<script src="xlsx.full.min.js" onerror="window.__XLSX_LOCAL_FAIL__=true"></script>
<script>
  (function ensureXLSX(){
    const st = document.getElementById('xlsxStat');
    const warn = document.getElementById('xlsxWarn');
    function ok(msg){ st.textContent = 'OK' + (msg?(' ('+msg+')'):''); }
    function bad(){ st.innerHTML = '<span class="err">indisponível</span>'; }

    if (window.XLSX) { ok('local'); return; }
    if (window.__XLSX_LOCAL_FAIL__) {
      warn.style.display = '';
      // tenta fallback de CDN
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js';
      s.onload = () => window.XLSX ? ok('CDN') : bad();
      s.onerror = bad;
      document.head.appendChild(s);
    } else {
      // ainda carregando local
      setTimeout(ensureXLSX, 300);
    }
  })();
</script>

<script>
/*** =================== CONFIG SUPABASE =================== ***/
const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const TABLE = 'vendas_xlsx';

/*** =================== UI REFS =================== ***/
const $file = document.getElementById('file');
const $save = document.getElementById('saveBtn');
const $clear = document.getElementById('clearBtn');
const $status = document.getElementById('status');
const $prev = document.getElementById('preview');
const $map = document.getElementById('mapping');
const $totAll = document.getElementById('totAll');
const $totOk = document.getElementById('totOk');
const $totSkip = document.getElementById('totSkip');
const $flash = document.getElementById('flash');

/*** =================== STATE =================== ***/
let parsed = [];     // registros válidos prontos para salvar
let skipped = 0;     // pulados sem data
let headerMap = {};  // mapeamento detectado

/*** =================== HELPERS =================== ***/
const deburr = (s) => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'');
const norm = (s) => deburr(String(s).trim().toLowerCase());

function parseMoney(x){
  if (x==null || x==='') return 0;
  if (typeof x === 'number') return x;
  let s = String(x).replace(/[^\d,.-]/g,'').replace(/\.(?=\d{3}(\D|$))/g,''); // remove separadores de milhar
  // se tem vírgula e não tem ponto → vírgula como decimal
  if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
  // se tem vírgula e ponto, assume vírgula como milhar e ponto como decimal → remove vírgula
  if (s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
  const n = Number(s);
  return isFinite(n) ? n : 0;
}

function excelDateToJSDate(serial){
  // 25569 = 1970-01-01; Excel tem o bug de 1900, mas a lib já considera.
  const utc_days  = Math.floor(serial - 25569);
  const utc_value = utc_days * 86400; 
  const date_info = new Date(utc_value * 1000);
  const fractional_day = serial - Math.floor(serial) + 0.0000001;
  let totalSeconds = Math.floor(86400 * fractional_day);
  const seconds = totalSeconds % 60; totalSeconds -= seconds;
  const hours = Math.floor(totalSeconds / (60*60));
  const minutes = Math.floor(totalSeconds / 60) % 60;
  return { date: date_info, hours, minutes, seconds };
}

function parseDateLike(v){
  if (v == null || v === '') return { dia:null, hora:null };
  if (typeof v === 'number'){ // excel serial
    const {date, hours} = excelDateToJSDate(v);
    const dia = date.toISOString().slice(0,10);
    return { dia, hora: hours };
  }
  const s = String(v).trim();
  // 2025-08-15
  const iso = /^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}:\d{2})?/.test(s);
  if (iso){
    const d = new Date(s.replace(' ','T'));
    const dia = isFinite(d) ? d.toISOString().slice(0,10) : null;
    const hora = isFinite(d) ? d.getHours() : null;
    return { dia, hora };
  }
  // dd/mm/aaaa [hh:mm]
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2}))?/);
  if (m){
    const dd=+m[1], mm=+m[2]-1, yy=+m[3], hh=m[4]?+m[4]:0, min=m[5]?+m[5]:0;
    const d = new Date(Date.UTC(yy,mm,dd,hh,min,0));
    const dia = d.toISOString().slice(0,10);
    const hora = hh;
    return { dia, hora };
  }
  return { dia:null, hora:null };
}

function detectMapping(cols){
  const N = cols.map(c => ({raw:c, key:norm(c)}));
  const has = (...keys)=> N.find(o => keys.includes(o.key))?.raw;

  const dia    = has('data da venda','data do pedido','data','dia','data venda','data do ped','data do pedido/compra');
  const hora   = has('hora','horario','hora da venda','hora do pedido');
  const unid   = has('unidade','uni','filial','empresa','cod unidade');
  const loja   = has('nome da loja','loja','codigo da loja','código da loja','loja nome');
  const canal  = has('canal de venda','canal','origem','canal venda');
  const pag    = has('pagamento base','pagamento','tipo de pagamento','forma de pagamento','pagamento_base');
  const canc   = has('está cancelado','cancelado','cancelada','foi cancelado');
  const ped    = has('itens','qtd','qtde','qtd pedidos','qtd_pedidos','pedidos','qtd_vendas');
  const fat    = has('valor entregador','faturamento','valor total','total','fat','receita');
  const des    = has('desconto','des','vl desconto');
  const fre    = has('entrega','frete','fre','taxa entrega','taxa de entrega');
  const pedido = has('pedido','id pedido','numero do pedido','nº pedido','pedido id');

  return { dia, hora, unid, loja, canal, pag, canc, ped, fat, des, fre, pedido };
}

function turnoFromHour(h){
  if (h==null) return null;
  if (h<=11) return 'Manhã';
  if (h<=18) return 'Dia';
  return 'Noite';
}

/*** =================== PARSER =================== ***/
async function handleFile(file){
  flash('Lendo arquivo…');
  parsed = []; skipped = 0;

  const ext = (file.name.split('.').pop()||'').toLowerCase();
  let rows = [];

  if (ext === 'csv'){
    const text = await file.text();
    // usa SheetJS também para CSV (mantém coerência)
    const wb = XLSX.read(text, { type:'string' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
  } else {
    if (!window.XLSX){ flash('Falha ao carregar a biblioteca XLSX.', true); return; }
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
  }

  if (!rows.length){ flash('Nenhuma linha detectada.', true); return; }

  const cols = Object.keys(rows[0]);
  headerMap = detectMapping(cols);

  // exibe mapeamento
  $map.value = JSON.stringify({
    dia: headerMap.dia || 'Data da venda',
    hora: headerMap.hora || '(derivada/ausente)',
    unid: headerMap.unid || 'unidade',
    loja: headerMap.loja || 'Nome da loja',
    canal: headerMap.canal || 'Canal de venda',
    pag: headerMap.pag || 'Pagamento',
    canc: headerMap.canc || 'Está cancelado',
    ped: headerMap.ped || 'Itens',
    fat: headerMap.fat || 'Valor Entregador',
    des: headerMap.des || 'Desconto',
    fre: headerMap.fre || 'Entrega',
    pedido_id: headerMap.pedido || '(opcional/ausente)'
  }, null, 2);

  // normaliza
  const out = [];
  for (const r of rows){
    // data + hora
    let dia = null, hora = null;

    if (headerMap.dia){
      const parsed = parseDateLike(r[headerMap.dia]);
      dia = parsed.dia;
      hora = parsed.hora;
    }
    if (!dia){ skipped++; continue; }     // pulo sem data (evita "null value in column dia")
    if (!hora && headerMap.hora){         // se houver coluna separada de hora
      const hv = r[headerMap.hora];
      if (typeof hv === 'number'){ hora = Math.max(0, Math.min(23, Math.round(hv))); }
      else if (/\d{1,2}:\d{2}/.test(String(hv))) hora = +String(hv).split(':')[0];
    }

    const rec = {
      dia, 
      hora: (hora!=null && isFinite(hora)) ? Math.max(0, Math.min(23, Math.trunc(hora))) : null,
      unidade: headerMap.unid ? String(r[headerMap.unid]||'').trim() : null,
      loja: headerMap.loja ? String(r[headerMap.loja]||'').trim() : null,
      canal: headerMap.canal ? String(r[headerMap.canal]||'').trim() : null,
      pagamento_base: headerMap.pag ? String(r[headerMap.pag]||'').trim() : null,
      cancelado: (() => {
        const v = headerMap.canc ? String(r[headerMap.canc]||'').trim().toLowerCase() : '';
        if (['sim','true','1','cancelado','cancelada','yes'].includes(v)) return 'Sim';
        return 'Não';
      })(),
      pedidos: headerMap.ped ? (parseInt(r[headerMap.ped],10)||0) : 0,
      fat: parseMoney(headerMap.fat ? r[headerMap.fat] : 0),
      des: parseMoney(headerMap.des ? r[headerMap.des] : 0),
      fre: parseMoney(headerMap.fre ? r[headerMap.fre] : 0),
      pedido_id: headerMap.pedido ? String(r[headerMap.pedido]||'').trim() : null,
      turno: turnoFromHour((hora!=null && isFinite(hora))?hora:null),

      // **IMPORTANTE**: deixa row_key nulo para o gatilho preencher
      row_key: null
    };
    out.push(rec);
  }

  parsed = out;
  const prev5 = parsed.slice(0,5);

  $totAll.textContent = rows.length;
  $totOk.textContent = parsed.length;
  $totSkip.textContent = skipped;

  $prev.value = prev5.length ? JSON.stringify(prev5, null, 2) : '—';
  flash(`Linhas válidas: ${parsed.length} • Puladas: ${skipped}`);
}

/*** =================== SAVE (REST/UPSERT) =================== ***/
async function saveAll(){
  if (!parsed.length){ flash('Nada para salvar. Faça o upload primeiro.', true); return; }

  $save.disabled = true; $file.disabled = true;
  const total = parsed.length;
  const batchSize = 500;
  let ok = 0, fail = 0, lastErr = null;

  for (let i=0;i<parsed.length;i+=batchSize){
    const lote = parsed.slice(i, i+batchSize);

    // chama REST com UPSERT por row_key (on_conflict=row_key)
    const url = `${SUPABASE_URL}/rest/v1/${TABLE}?on_conflict=row_key`;
    try{
      const res = await fetch(url, {
        method:'POST',
        headers:{
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'resolution=merge-duplicates' // UPSERT
        },
        body: JSON.stringify(lote)
      });
      if (!res.ok){
        const txt = await res.text();
        fail += lote.length;
        lastErr = txt;
        flash(`Falhou lote ${i/batchSize+1}: ${txt}`, true);
      }else{
        ok += lote.length;
        $status.textContent = `Salvando… ${ok}/${total}`;
      }
    }catch(e){
      fail += lote.length;
      lastErr = e.message;
      flash(`Erro de rede no lote ${i/batchSize+1}: ${e.message}`, true);
    }
  }

  $save.disabled = false; $file.disabled = false;

  if (fail===0){
    flash(`✅ Envio concluído: ${ok}/${total} inseridos/atualizados.`, false, true);
  }else{
    alert(`Parte dos registros falhou.\nInseridos: ${ok}\nFalhas: ${fail}\nÚltimo erro:\n${lastErr}`);
  }
}

/*** =================== UI BINDINGS =================== ***/
$file.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if (!f) return;
  handleFile(f);
});
$save.addEventListener('click', saveAll);
$clear.addEventListener('click', ()=>{
  $file.value = '';
  parsed = []; skipped = 0; headerMap={};
  $prev.value = '—'; $map.value = '—';
  $totAll.textContent = '0'; $totOk.textContent = '0'; $totSkip.textContent = '0';
  flash('UI limpa.');
});

/*** =================== FLASH =================== ***/
function flash(msg, isErr=false, good=false){
  $status.textContent = msg;
  $flash.className = good ? 'okmsg' : (isErr?'warn':'');
  $flash.textContent = msg;
}
</script>
</body>
</html>
