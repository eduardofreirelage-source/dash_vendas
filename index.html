<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Upload de Vendas → Supabase</title>

<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- SheetJS (XLSX/CSV) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root { --fg:#111; --muted:#666; --ok:#1b8f3f; --warn:#b8860b; --err:#b00020; --bg:#fafafa; --card:#fff; --bd:#e6e6e6; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
  header{padding:14px 16px;border-bottom:1px solid var(--bd);background:#fff;position:sticky;top:0}
  main{padding:16px;display:grid;gap:16px;grid-template-columns:1.2fr .8fr}
  h2{margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-weight:600}
  input[type=text],input[type=password],textarea,select{border:1px solid var(--bd);border-radius:8px;padding:8px 10px;min-width:220px}
  button{border:none;background:#111;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.secondary{background:#444}
  button.ghost{background:#f2f2f2;color:#111}
  button:disabled{opacity:.5;cursor:not-allowed}
  small.muted{color:var(--muted)}
  .grid{display:grid;gap:8px}
  .map-grid{display:grid;grid-template-columns:200px 1fr;gap:8px;align-items:center}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;margin-left:8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  pre{white-space:pre-wrap;background:#0d1117;color:#c9d1d9;padding:10px;border-radius:8px;max-height:280px;overflow:auto;font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--bd);padding:6px 8px;font-size:12px;text-align:left}
  .kpi{display:flex;gap:12px;flex-wrap:wrap}
  .pill{padding:8px 10px;border-radius:8px;background:#f6f6f6;border:1px solid var(--bd)}
  .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:#111;width:0%}
</style>
</head>
<body>
<header>
  <strong>Upload de Vendas → Supabase</strong>
  <span class="badge">planilha → RPC → vendas_upload → vw_vendas</span>
</header>

<main>
  <!-- Coluna esquerda -->
  <section class="card">
    <h2>1) Conexão</h2>
    <div class="grid">
      <div class="row">
        <label>Supabase URL</label>
        <input id="url" type="text" value="https://uahmcfzerofhzjvlzrqc.supabase.co" style="min-width:420px"/>
      </div>
      <div class="row">
        <label>Anon Key</label>
        <input id="key" type="password" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" style="min-width:620px"/>
        <button class="secondary" id="btnConnect">Conectar</button>
        <span id="connStatus" class="badge">—</span>
      </div>
      <small class="muted">O usuário/papel do token precisa de: SELECT/INSERT/UPDATE em <code>vendas_upload</code>, SELECT em <code>vw_vendas</code>, EXECUTE em <code>ingest_vendas_json(jsonb)</code>.</small>
    </div>
  </section>

  <section class="card">
    <h2>Debug</h2>
    <div class="row" style="gap:8px">
      <button class="ghost" id="btnSmoke">Smoke test (contar vw_vendas)</button>
      <button class="ghost" id="btnLists">Recarregar listas</button>
    </div>
    <pre id="log">Pronto.</pre>
  </section>

  <!-- Coluna esquerda (abaixo) -->
  <section class="card" style="grid-column:1 / span 1">
    <h2>2) Arquivo</h2>
    <div class="row">
      <input id="file" type="file" accept=".xlsx,.xls,.csv"/>
      <button id="btnValidate" disabled>Validar</button>
      <small class="muted">Aceita .xlsx/.xls/.csv. A validação é local (navegador).</small>
    </div>
    <div id="fileInfo" class="row"></div>
  </section>

  <!-- Coluna direita (mapeamento) -->
  <section class="card" style="grid-column:2 / span 1">
    <h2>3) Mapeamento de colunas</h2>
    <small class="muted">Mapeie as colunas da planilha para os campos canônicos que o backend espera.</small>
    <div id="mapArea" class="map-grid" style="margin-top:10px"></div>
  </section>

  <!-- Linha inteira -->
  <section class="card" style="grid-column:1 / span 2">
    <h2>4) Enviar ao banco (RPC <code>ingest_vendas_json</code>)</h2>
    <div class="row" style="gap:12px">
      <button id="btnSave" disabled>Salvar no banco</button>
      <small class="muted">Envia em lotes (padrão 2.000 linhas por chamada) com deduplicação via <code>row_key</code>.</small>
    </div>
    <div class="progress" style="margin-top:10px"><div id="bar" class="bar"></div></div>
    <div id="saveInfo" class="row" style="margin-top:8px"></div>
  </section>

  <!-- Amostra -->
  <section class="card" style="grid-column:1 / span 2">
    <h2>Amostra (10 primeiras linhas lidas)</h2>
    <div id="sample"></div>
  </section>

  <!-- KPIs simples só para validar carga -->
  <section class="card" style="grid-column:1 / span 2">
    <h2>5) Resumo pós-carga</h2>
    <div class="kpi" id="kpis">
      <div class="pill" id="kpiCount">linhas: —</div>
      <div class="pill" id="kpiUnid">unidades: —</div>
      <div class="pill" id="kpiLoja">lojas: —</div>
      <div class="pill" id="kpiTurno">turnos: —</div>
      <div class="pill" id="kpiCanal">canais: —</div>
      <div class="pill" id="kpiPags">pagamentos: —</div>
    </div>
  </section>
</main>

<script>
/** ========= Helpers ========= **/
const $ = (q)=>document.querySelector(q);
const log = (msg, type='')=>{
  const pre = $('#log');
  const tag = type==='err' ? '❌ ' : type==='warn' ? '⚠️ ' : type==='ok' ? '✅ ' : '';
  pre.textContent += (pre.textContent.endsWith('\n')?'':'\n') + tag + (typeof msg==='string'?msg:JSON.stringify(msg,null,2));
  pre.scrollTop = pre.scrollHeight;
};
const setBar = (p)=> $('#bar').style.width = `${Math.max(0,Math.min(100,p))}%`;
const nf = new Intl.NumberFormat('pt-BR',{maximumFractionDigits:2});

const CANON = [
  {key:'dia', label:'Data (dia)'},
  {key:'hora', label:'Hora (0-23)'},
  {key:'unidade', label:'Unidade'},
  {key:'loja', label:'Loja (NOME DA LOJA)'},
  {key:'canal', label:'Canal'},
  {key:'pagamento_base', label:'Pagamento'},
  {key:'cancelado', label:'Cancelado (Sim/Não)'},
  {key:'pedidos', label:'Pedidos (int)'},
  {key:'fat', label:'Faturamento'},
  {key:'des', label:'Desconto'},
  {key:'fre', label:'Frete'},
  {key:'turno', label:'Turno'},
  {key:'pedido_id', label:'Pedido ID (opcional)'}
];

function normalizeHeader(h){
  if(!h) return '';
  return String(h).toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // tira acentos
    .replace(/\s+/g,' ').trim();
}
function guessMapping(headers){
  const norm = headers.map(h=>({raw:h,n:normalizeHeader(h)}));
  const pick = (cands)=> {
    for(const c of cands){
      const f = norm.find(x=> x.n===c || x.n.includes(c));
      if(f) return f.raw;
    }
    return '';
  };
  return {
    dia: pick(['data da venda','data_venda','data','dia']),
    hora: pick(['hora','hr']),
    unidade: pick(['unidade']),
    loja: pick(['nome da loja','loja','consumidor','nome']),
    canal: pick(['canal de venda','canal']),
    pagamento_base: pick(['pagamento','pagamento base','forma de pagamento']),
    cancelado: pick(['esta cancelado','está cancelado','cancelado']),
    pedidos: pick(['itens','pedidos','quantidade']),
    fat: pick(['total','valor total','faturamento','receita']),
    des: pick(['desconto']),
    fre: pick(['entrega','frete']),
    turno: pick(['turno']),
    pedido_id: pick(['pedido id','pedido'])
  };
}
function excelSerialToISO(serial){
  // Excel serial (1900-based). Aceita número ou string
  const n = Number(serial);
  if(!isFinite(n) || n<=59) return null;
  const ms = Math.round((n - 25569) * 86400 * 1000);
  const d = new Date(ms);
  if(isNaN(d.getTime())) return null;
  return d.toISOString().slice(0,10);
}
function parseDateSmart(v){
  if(v==null || v==='') return null;
  // Se já vier Date, ou string ISO yyyy-mm-dd
  if (v instanceof Date) return v.toISOString().slice(0,10);
  const s = String(v).trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;            // YYYY-MM-DD
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)){                   // DD/MM/YYYY
    const [d,m,y] = s.split('/');
    return `${y}-${m}-${d}`;
  }
  if (/^\d+(\.\d+)?$/.test(s)){                           // possível serial Excel
    const iso = excelSerialToISO(Number(s));
    if (iso) return iso;
  }
  // Último recurso: Date.parse
  const t = Date.parse(s);
  if(!isNaN(t)) return new Date(t).toISOString().slice(0,10);
  return null;
}
function parseHoraSmart(v){
  if(v==null || v==='') return null;
  const s = String(v).trim();
  if (/^\d{1,2}$/.test(s)) return parseInt(s,10);
  const m = s.match(/^(\d{1,2})[:h]/i);
  if(m) return Math.max(0, Math.min(23, parseInt(m[1],10)));
  const n = Number(s);
  if (isFinite(n)) return Math.max(0, Math.min(23, Math.round(n)));
  return null;
}
function parseCancel(v){
  const s = String(v??'').toLowerCase().trim();
  if (['sim','s','true','1','yes'].includes(s)) return 'Sim';
  return 'Não';
}
function parseNumKeep(v){
  // o RPC aceita número (ex: 123.45) ou texto pt-BR (ex: "1.234,56")
  if(v==null) return null;
  const s = String(v).trim();
  if(s==='') return null;
  // se vier "1.234,56" mantenho; se vier número, devolvo Number
  if (/[0-9],[0-9]{1,2}$/.test(s) || /,0$/.test(s)) return s;
  const n = Number(s.replace(/\s/g,''));
  return isFinite(n) ? n : s;
}

/** ========= Estado ========= **/
let supa = null;
let rowsRaw = [];
let headers = [];
let mapping = {};
let rowsMapped = [];

/** ========= UI ========= **/
function renderMapping(){
  const area = $('#mapArea');
  area.innerHTML = '';
  if(headers.length===0){
    area.innerHTML = '<small class="muted">Carregue e valide um arquivo para montar o mapeamento.</small>';
    return;
  }
  for(const c of CANON){
    const lab = document.createElement('div');
    lab.textContent = c.label;
    const sel = document.createElement('select');
    sel.dataset.key = c.key;
    sel.innerHTML = ['<option value="">(sem coluna)</option>']
      .concat(headers.map(h=>`<option value="${h}">${h}</option>`)).join('');
    if (mapping[c.key]) sel.value = mapping[c.key];
    sel.addEventListener('change', ()=>{
      mapping[sel.dataset.key] = sel.value || '';
      prepareMapped();
    });
    area.appendChild(lab);
    area.appendChild(sel);
  }
}
function renderSample(){
  const cont = $('#sample');
  if(rowsRaw.length===0){ cont.innerHTML = '<small class="muted">Sem dados.</small>'; return; }
  const head = headers.slice(0,50);
  const first = rowsRaw.slice(0,10);
  let html = '<div style="overflow:auto"><table><thead><tr>';
  for(const h of head) html += `<th>${h}</th>`;
  html += '</tr></thead><tbody>';
  for(const r of first){
    html += '<tr>';
    for(const h of head) html += `<td>${(r[h]??'')}</td>`;
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  cont.innerHTML = html;
}
function setConn(state, msg=''){
  const el = $('#connStatus');
  el.textContent = state ? '✅ conectado' : '—';
  if(msg) log(msg, state?'ok':'err');
}

/** ========= Conectar ========= **/
$('#btnConnect').addEventListener('click', async ()=>{
  const url = $('#url').value.trim();
  const key = $('#key').value.trim();
  supa = window.supabase.createClient(url, key, { auth: { persistSession:false }});
  setConn(true, 'Supabase client ok');
});

/** ========= Validar arquivo ========= **/
$('#file').addEventListener('change', ()=>{
  $('#btnValidate').disabled = !$('#file').files?.length;
});
$('#btnValidate').addEventListener('click', async ()=>{
  const f = $('#file').files?.[0];
  if(!f){ alert('Escolha um arquivo primeiro'); return; }
  try{
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array', cellDates:true, raw:false});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
    rowsRaw = data;
    headers = Object.keys(data[0]||{});
    mapping = guessMapping(headers);
    $('#fileInfo').innerHTML = `<strong>${f.name}</strong> — ${nf.format(rowsRaw.length)} linhas lidas`;
    renderMapping();
    renderSample();
    prepareMapped();
    $('#btnSave').disabled = false;
    log(`Validação OK. Cabeçalhos: ${JSON.stringify(headers)}`);
  }catch(e){
    log(`Erro ao ler arquivo: ${e.message||e}`, 'err');
  }
});

/** ========= Preparar linhas mapeadas ========= **/
function prepareMapped(){
  if(rowsRaw.length===0){ rowsMapped = []; return; }
  rowsMapped = rowsRaw.map(r=>{
    const get = (k)=> mapping[k] ? (r[mapping[k]] ?? null) : null;
    return {
      dia: parseDateSmart(get('dia')),
      hora: parseHoraSmart(get('hora')),
      unidade: (get('unidade')??'').toString().trim(),
      loja: (get('loja')??'').toString().trim(),
      canal: (get('canal')??'').toString().trim(),
      pagamento_base: (get('pagamento_base')??'').toString().trim(),
      cancelado: parseCancel(get('cancelado')),
      pedidos: (get('pedidos')==null || String(get('pedidos')).trim()==='' ) ? 1 : parseInt(get('pedidos'),10),
      fat: parseNumKeep(get('fat')),
      des: parseNumKeep(get('des')),
      fre: parseNumKeep(get('fre')),
      turno: (get('turno')??'').toString().trim(),
      pedido_id: (get('pedido_id')??'').toString().trim()
    };
  });
}

/** ========= Salvar no banco (RPC) ========= **/
$('#btnSave').addEventListener('click', async ()=>{
  if(!supa){ alert('Conecte primeiro'); return; }
  if(!rowsMapped?.length){ alert('Valide o arquivo e mapeie as colunas'); return; }

  // limpeza básica: remove linhas sem data
  const toSend = rowsMapped.filter(x=> !!x.dia);
  if(toSend.length===0){ alert('Nenhuma linha com data reconhecida. Ajuste o mapeamento de "Data (dia)".'); return; }

  $('#btnSave').disabled = true;
  setBar(0);
  $('#saveInfo').textContent = `Enviando ${nf.format(toSend.length)} linhas…`;

  const BATCH = 2000;
  let done = 0, okBatches=0, errBatches=0;
  for(let i=0;i<toSend.length;i+=BATCH){
    const chunk = toSend.slice(i, i+BATCH);
    try{
      const { data, error } = await supa.rpc('ingest_vendas_json', { p_rows: chunk });
      if(error) throw error;
      okBatches++;
      done += chunk.length;
      setBar(Math.round(done*100/toSend.length));
      $('#saveInfo').textContent = `Gravado: ${nf.format(done)} / ${nf.format(toSend.length)} (lotes OK: ${okBatches}, erros: ${errBatches})`;
      log(`Lote OK: +${chunk.length} (retorno RPC: ${data})`, 'ok');
    }catch(e){
      errBatches++;
      log(`Erro no lote (${i}-${i+BATCH}): ${e.message||e}`, 'err');
    }
  }

  $('#btnSave').disabled = false;
  await refreshKPIs();
});

/** ========= Smoke + Listas ========= **/
$('#btnSmoke').addEventListener('click', refreshKPIs);
$('#btnLists').addEventListener('click', refreshLists);

async function refreshKPIs(){
  if(!supa){ log('Conecte primeiro', 'warn'); return; }
  try{
    // count total via HEAD
    let count = null;
    {
      const { data, error, count:ct } = await supa
        .from('vw_vendas')
        .select('dia', { head:true, count:'exact' });
      if(error){ log(`count head falhou: ${error.message}`, 'warn'); }
      count = ct ?? null;
    }
    // fallback se head não der count
    if(count==null){
      const { data, error } = await supa.rpc('rpc_count_vw_vendas'); // caso exista
      if(!error && data && typeof data==='number') count = data;
    }
    // distincts
    const [un,lo,tu,ca,pa] = await Promise.all([
      supa.from('vw_vendas').select('unidade', {distinct:true}).limit(10000),
      supa.from('vw_vendas').select('loja', {distinct:true}).limit(10000),
      supa.from('vw_vendas').select('turno', {distinct:true}).limit(10000),
      supa.from('vw_vendas').select('canal', {distinct:true}).limit(10000),
      supa.from('vw_vendas').select('pagamento_base', {distinct:true}).limit(10000),
    ]);

    $('#kpiCount').textContent = `linhas: ${count ?? (un.data?.length || 0)}`;
    $('#kpiUnid').textContent  = `unidades: ${un.data?.length ?? 0}`;
    $('#kpiLoja').textContent  = `lojas: ${lo.data?.length ?? 0}`;
    $('#kpiTurno').textContent = `turnos: ${tu.data?.length ?? 0}`;
    $('#kpiCanal').textContent = `canais: ${ca.data?.length ?? 0}`;
    $('#kpiPags').textContent  = `pagamentos: ${pa.data?.length ?? 0}`;

    log('Smoke test concluído.', 'ok');
  }catch(e){
    log(`Smoke error: ${e.message||e}`, 'err');
  }
}
async function refreshLists(){
  if(!supa){ log('Conecte primeiro', 'warn'); return; }
  try{
    const [un,lo,tu,ca,pa] = await Promise.all([
      supa.from('vw_vendas').select('unidade', {distinct:true}).limit(2000),
      supa.from('vw_vendas').select('loja', {distinct:true}).limit(2000),
      supa.from('vw_vendas').select('turno', {distinct:true}).limit(2000),
      supa.from('vw_vendas').select('canal', {distinct:true}).limit(2000),
      supa.from('vw_vendas').select('pagamento_base', {distinct:true}).limit(2000),
    ]);
    log('Listas (amostras):', 'ok');
    log({
      unidade: (un.data||[]).slice(0,10),
      loja: (lo.data||[]).slice(0,10),
      turno: (tu.data||[]).slice(0,10),
      canal: (ca.data||[]).slice(0,10),
      pagamento: (pa.data||[]).slice(0,10)
    });
  }catch(e){
    log(`loadFilters erro: ${e.message||e}`, 'err');
  }
}
</script>
</body>
</html>
