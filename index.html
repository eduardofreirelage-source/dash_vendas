<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DASHBOARD — CFO (v2.9.0 Light)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%232f6ef7"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{ --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb;
         --pri:#2f6ef7; --ok:#10b981; --down:#ef4444; --chip:#eef2ff; --bar:#374151; }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  h1{margin:0;font-size:28px;letter-spacing:.2px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.clear{gap:6px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px}
  .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .sec-title{display:flex;align-items:center;gap:10px;font-weight:700}
  .ico{width:16px;height:16px;color:#475569}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  input[type="date"], .msel-btn{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
  .chip{padding:8px 0;border:1px solid var(--line);border-radius:10px;background:var(--chip);cursor:pointer;text-align:center;font-weight:700;letter-spacing:.5px}
  .chip.active{background:var(--pri);border-color:var(--pri);color:#fff}

  /* Multiselect */
  .msel{position:relative}
  .msel-btn{cursor:pointer;text-align:left}
  .msel-btn:after{content:"▾";float:right;color:#475569}
  .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
  .msel-opt:hover{background:#f3f4f6}

  /* KPIs */
  .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px 12px 12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
  .kpi .bar{position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:14px 0 0 14px;background:var(--bar)}
  .kpi h4{margin:0 0 8px;font-size:13px;color:#475569;display:flex;justify-content:space-between;align-items:center;padding-right:18px}
  .kpi .val{font-size:22px;font-weight:800}
  .kpi .sub{font-size:12px;color:#667085;margin-top:2px}
  .delta{display:inline-flex;gap:6px;align-items:center;padding:5px 12px;border-radius:999px;border:1px solid var(--line);font-weight:800;font-size:15px}
  .delta svg{width:14px;height:14px}
  .delta.up{color:var(--ok);border-color:#86efac}
  .delta.down{color:var(--down);border-color:#fecaca}
  .delta.flat{color:#64748b}
  #periodoInfo{font-size:12px;color:var(--muted)}

  /* Charts */
  .charts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
  .card-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tog{display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .tog button{border:0;background:#fff;padding:6px 10px;font-weight:700;cursor:pointer}
  .tog button.active{background:var(--pri);color:#fff}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>DASHBOARD</h1>
    <div class="right"><button id="btnUpload" class="btn">📤 Carregar Excel</button></div>
  </div>

  <!-- Filtros de Data -->
  <div class="section">
    <div class="sec-head">
      <div class="sec-title">
        <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v2l-7 8v6l-4 2v-8L3 6V4z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
        Filtros de Data
      </div>
      <button id="btnClear" class="btn clear">✖ Limpar filtros</button>
    </div>
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px;">Intervalo (início)</div><input type="date" id="fDe"></div>
      <div><div class="muted" style="margin-bottom:6px;">Intervalo (fim)</div><input type="date" id="fAte"></div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Período rápido</div>
        <div class="chips">
          <button class="chip" data-q="7">07</button><button class="chip" data-q="15">15</button>
          <button class="chip active" data-q="30">30</button><button class="chip" data-q="60">60</button>
          <button class="chip" data-q="90">90</button><button class="chip" data-q="120">120</button>
        </div>
        <div id="periodoInfo" style="margin-top:6px;">—</div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="section">
    <div class="sec-head">
      <div class="sec-title">
        <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 4a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v2l-7 8v6l-4 2v-8L3 6V4z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
        Filtros
      </div>
      <div id="status" class="muted">—</div>
    </div>

    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px;">Unidade</div><div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Nome da Loja</div><div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Turno da Venda</div><div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div></div>
    </div>

    <div class="row cols-3" style="margin-top:10px;">
      <div><div class="muted" style="margin-bottom:6px;">Canal de Venda</div><div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Tipo de Pagamento</div><div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div></div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Cancelado</div>
        <div id="ms-cancel" class="msel">
          <button class="msel-btn">Não</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="Não" checked><label>Não</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs (mantidos) -->
  <div class="krow">
    <div class="kpi"><span class="bar"></span><h4><span>Pedidos</span><span id="d_ped" class="delta flat">—</span></h4><div class="val" id="k_ped">—</div><div class="sub">Anterior: <span id="p_ped">—</span></div></div>
    <div class="kpi"><span class="bar"></span><h4><span>Faturamento</span><span id="d_fat" class="delta flat">—</span></h4><div class="val" id="k_fat">—</div><div class="sub">Anterior: <span id="p_fat">—</span></div></div>
    <div class="kpi"><span class="bar"></span><h4><span>Incentivos</span><span id="d_des" class="delta flat">—</span></h4><div class="val" id="k_des">—</div><div class="sub">Anterior: <span id="p_des">—</span></div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi"><span class="bar"></span><h4><span>% de Incentivos</span><span id="d_desperc" class="delta flat">—</span></h4><div class="val" id="k_desperc">—</div><div class="sub">Anterior: <span id="p_desperc">—</span></div></div>
    <div class="kpi"><span class="bar"></span><h4><span>Ticket Médio</span><span id="d_tkt" class="delta flat">—</span></h4><div class="val" id="k_tkt">—</div><div class="sub">Anterior: <span id="p_tkt">—</span></div></div>
    <div class="kpi"><span class="bar"></span><h4><span>Faturamento Médio</span><span id="d_fatmed" class="delta flat">—</span></h4><div class="val" id="k_fatmed">—</div><div class="sub">Anterior: <span id="p_fatmed">—</span></div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi"><span class="bar"></span><h4><span>Frete</span><span id="d_fre" class="delta flat">—</span></h4><div class="val" id="k_fre">—</div><div class="sub">Anterior: <span id="p_fre">—</span></div></div>
    <div class="kpi"><span class="bar"></span><h4><span>Frete Médio</span><span id="d_fremed" class="delta flat">—</span></h4><div class="val" id="k_fremed">—</div><div class="sub">Anterior: <span id="p_fremed">—</span></div></div>
    <div class="kpi"><span class="bar"></span><h4><span>Pedidos Cancelados</span><span id="d_canc_ped" class="delta flat">—</span></h4><div class="val" id="k_canc_ped">—</div><div class="sub">Participação: <span id="k_canc_part">—</span> (Anterior: <span id="p_canc_part">—</span>)</div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi"><span class="bar"></span><h4><span>Valor de Cancelados</span><span id="d_canc_val" class="delta flat">—</span></h4><div class="val" id="k_canc_val">—</div><div class="sub">Anterior: <span id="p_canc_val">—</span></div></div>
  </div>

  <!-- GRÁFICOS -->
  <div class="charts">
    <div class="card">
      <div class="card-head">
        <div><strong>Vendas por dia da semana</strong> <span class="hint">Atual × Anterior</span></div>
        <div class="tog" data-for="dow">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="media">Média</button>
        </div>
      </div>
      <canvas id="ch_dow" height="210"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <div><strong>Vendas por mês</strong> <span class="hint">Atual × Anterior</span></div>
        <div class="tog" data-for="month">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="media">Média</button>
        </div>
      </div>
      <canvas id="ch_month" height="210"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <div><strong>Vendas por hora</strong> <span class="hint">Atual × Anterior</span></div>
        <div class="tog" data-for="hour">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="media">Média</button>
        </div>
      </div>
      <div class="hint" id="hour_hint" style="display:none;margin-bottom:8px;">Este gráfico precisa que a RPC retorne o campo <code>hora</code>.</div>
      <canvas id="ch_hour" height="210"></canvas>
    </div>

    <div class="card">
      <div class="card-head">
        <div><strong>Vendas por turno</strong> <span class="hint">Atual × Anterior</span></div>
        <div class="tog" data-for="turno">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="media">Média</button>
        </div>
      </div>
      <div class="hint" id="turno_hint" style="display:none;margin-bottom:8px;">Este gráfico precisa que a RPC retorne o campo <code>turno</code>.</div>
      <canvas id="ch_turno" height="210"></canvas>
    </div>
  </div>
</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
/* ===== CONFIG ===== */
const SUPABASE_URL='https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
const $=id=>document.getElementById(id);
const setStatus=(t,k)=>{const el=$('status'); el.textContent=t; el.style.color=(k==='err'?'#ef4444':k==='ok'?'#10b981':'#667085');};

/* ===== UTIL ===== */
const money=v=>(v==null||!isFinite(+v))?'R$ 0,00':'R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const num=v=>(v==null||!isFinite(+v))?'0':(+v).toLocaleString('pt-BR');
const pctf=v=>(v==null||!isFinite(+v))?'0,0%':((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
function iso(d){return d.toISOString().slice(0,10);}
function addDaysISO(isoStr,n){const d=new Date(isoStr+'T00:00:00'); d.setDate(d.getDate()+n); return iso(d);}
function daysLen(de,ate){const d1=new Date(de+'T00:00:00'), d2=new Date(ate+'T00:00:00');return Math.round((d2-d1)/86400000)+1;}
function upSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 3l5 6h-3v8H8V9H5l5-6z"/></svg>';}
function downSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 17l-5-6h3V3h4v8h3l-5 6z"/></svg>';}
function deltaBadge(el,curr,prev){ if(!isFinite(prev)||+prev===0){el.textContent='—';el.className='delta flat';return;} const p=((curr-prev)/prev)*100; el.innerHTML=(p>=0?upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%'; el.className='delta '+(p>=0?'up':'down'); }

/* ===== MULTISELECT ===== */
function MultiSelect(rootId,placeholder){
  const root=$(rootId),btn=root.querySelector('.msel-btn'),panel=root.querySelector('.msel-panel');
  let options=[],selected=new Set(),filtered=[];
  function render(){ panel.innerHTML=''; const q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar…'; q.addEventListener('input',()=>{filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase())); draw();}); panel.appendChild(q); draw(); }
  function draw(){ const box=document.createElement('div'); (filtered.length?filtered:options).forEach(v=>{ const row=document.createElement('div'); row.className='msel-opt'; const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=selected.has(v); const lb=document.createElement('label'); lb.textContent=v; cb.addEventListener('change',()=>{cb.checked?selected.add(v):selected.delete(v); refresh(); applyAll();}); row.appendChild(cb); row.appendChild(lb); box.appendChild(row);}); panel.querySelectorAll('.msel-opt').forEach(n=>n.remove()); panel.appendChild(box); }
  function refresh(){ btn.textContent=selected.size===0?placeholder:`${selected.size} selecionado(s)`; }
  btn.addEventListener('click',()=>root.classList.toggle('open'));
  document.addEventListener('click',e=>{ if(!root.contains(e.target)) root.classList.remove('open'); });
  return { setOptions(list){options=(list||[]).filter(Boolean); filtered=options.slice(); selected=new Set(); render(); refresh();}, get(){return [...selected];}, set(vals){selected=new Set(vals||[]); refresh(); draw();} };
}

/* ===== ESTADO / PERÍODO ===== */
let firstDay='',lastDay='', rowsNow=[], rowsPrev=[];
const chips=[...document.querySelectorAll('.chip')];
const fDe=$('fDe'), fAte=$('fAte'), periodoInfo=$('periodoInfo');
const ms={ unids:MultiSelect('ms-unids','Todas as unidades'),
           lojas:MultiSelect('ms-lojas','Todas as lojas'),
           canais:MultiSelect('ms-canais','Todos os canais'),
           turnos:MultiSelect('ms-turnos','Todos os turnos'),
           pags:MultiSelect('ms-pags','Todos os tipos'),
           cancel:MultiSelect('ms-cancel','Todos') };

function setActiveChip(val){ chips.forEach(c=>c.classList.toggle('active',c.dataset.q===String(val))); }
function applyQuick(val){ setActiveChip(val); const ate=lastDay||iso(new Date()); const de=addDaysISO(ate,-(Number(val)-1)); fDe.value=de; fAte.value=ate; periodoInfo.textContent=`Último dia carregado: ${lastDay}`; applyAll(); }
$('btnClear').addEventListener('click',()=>{ ms.unids.set([]); ms.lojas.set([]); ms.canais.set([]); ms.turnos.set([]); ms.pags.set([]); ms.cancel.set(['Não']); applyQuick('30'); });
chips.forEach(b=>b.addEventListener('click',()=>applyQuick(b.dataset.q)));
[fDe,fAte].forEach(inp=>inp.addEventListener('change',()=>{ chips.forEach(c=>c.classList.remove('active')); periodoInfo.textContent=`Último dia carregado: ${lastDay}`; applyAll(); }));

/* ===== PARÂMETROS ===== */
function buildParams(de,ate,overrideCancel=null,includeUnids=false){
  const canc = overrideCancel!=null ? [overrideCancel] : ms.cancel.get();
  let p_cancelado=null; if(canc.length===1&&(canc[0]==='Não'||canc[0]==='Sim')) p_cancelado=canc[0];
  const obj={ p_dini:de, p_dfim:ate,
              p_lojas:  ms.lojas.get().length  ? ms.lojas.get()  : null,
              p_turnos: ms.turnos.get().length ? ms.turnos.get() : null,
              p_canais: ms.canais.get().length ? ms.canais.get() : null,
              p_pags:   ms.pags.get().length   ? ms.pags.get()   : null,
              p_cancelado };
  if(includeUnids && ms.unids.get().length) obj.p_unids = ms.unids.get();
  return obj;
}
function agg(rows){ let ped=0,fat=0,des=0,fre=0; for(const r of (rows||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; } return {ped,fat,des,fre}; }

/* ===== CHART helpers ===== */
let ch={ dow:null, month:null, hour:null, turno:null };
const COLORS={ now:'rgba(47,110,247,0.85)', prev:'rgba(2,132,199,0.6)' };

function ensureChart(ctxId,labels,nowArr,prevArr){
  const ctx=$(ctxId).getContext('2d');
  if(ch[ctxId.split('_')[1]]) ch[ctxId.split('_')[1]].destroy();
  ch[ctxId.split('_')[1]] = new Chart(ctx,{ type:'bar',
    data:{ labels, datasets:[
      {label:'Atual', data:nowArr, backgroundColor:COLORS.now},
      {label:'Anterior', data:prevArr, backgroundColor:COLORS.prev}
    ]},
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{ grid:{display:false}}, y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)'} } },
      plugins:{ legend:{ position:'top' }, tooltip:{ mode:'index', intersect:false } }
    }
  });
}

function groupByDow(rows, mode){
  const labels=['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'];
  const sum=new Array(7).fill(0), cnt=new Array(7).fill(0);
  for(const r of rows){
    const d=new Date((r.dia||r.data||r.date)+'T00:00:00');
    if(isNaN(d)) continue;
    let wd=d.getDay(); // 0=Dom
    wd=(wd+6)%7; // 0=Seg ... 6=Dom
    sum[wd]+= +r.fat||0; cnt[wd]+=1;
  }
  const arr = mode==='media' ? sum.map((s,i)=>cnt[i]?s/cnt[i]:0) : sum;
  return {labels, values:arr};
}
function groupByMonth(rows, mode){
  const m = {};
  for(const r of rows){
    const d = new Date((r.dia||r.data||r.date)+'T00:00:00');
    if(isNaN(d)) continue;
    const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    if(!m[key]) m[key]={sum:0,cnt:0};
    m[key].sum += +r.fat||0; m[key].cnt += 1;
  }
  const labels = Object.keys(m).sort();
  const values = labels.map(k => (mode==='media' ? (m[k].cnt? m[k].sum/m[k].cnt : 0) : m[k].sum));
  return {labels, values};
}
function groupByHour(rows, mode){
  const sum=new Array(24).fill(0), cnt=new Array(24).fill(0);
  let has=false;
  for(const r of rows){
    if(typeof r.hora === 'number' || (typeof r.hora==='string' && r.hora!=='')){
      const h = Math.max(0, Math.min(23, parseInt(r.hora,10)));
      sum[h]+= +r.fat||0; cnt[h]+=1; has=true;
    }
  }
  const labels=[...Array(24)].map((_,i)=>String(i).padStart(2,'0')+'h');
  return {labels, values:(mode==='media'? sum.map((s,i)=>cnt[i]?s/cnt[i]:0):sum), has};
}
function groupByTurno(rows, mode){
  const order = ['Manhã','Dia','Tarde','Noite','Madrugada'];
  const idx = (t)=>{const p=order.indexOf(t); return p>=0?p:order.length;};
  const map={}; let has=false;
  for(const r of rows){
    if(r.turno!=null && r.turno!==''){ has=true; const k=r.turno; if(!map[k]) map[k]={sum:0,cnt:0}; map[k].sum+= +r.fat||0; map[k].cnt+=1; }
  }
  const labels = Object.keys(map).sort((a,b)=>idx(a)-idx(b));
  const values = labels.map(k => (mode==='media'? (map[k].cnt? map[k].sum/map[k].cnt:0): map[k].sum));
  return {labels, values, has};
}

/* Render all charts based on current toggle modes */
function renderCharts(){
  // modes
  const modeDow   = document.querySelector('.tog[data-for="dow"] .active').dataset.mode;
  const modeMonth = document.querySelector('.tog[data-for="month"] .active').dataset.mode;
  const modeHour  = document.querySelector('.tog[data-for="hour"] .active').dataset.mode;
  const modeTurno = document.querySelector('.tog[data-for="turno"] .active').dataset.mode;

  // DOW
  const gN1=groupByDow(rowsNow,modeDow), gP1=groupByDow(rowsPrev,modeDow);
  const labels1=gN1.labels; const now1=gN1.values; const prev1=gP1.values;
  ensureChart('ch_dow',labels1,now1,prev1);

  // Month
  const gN2=groupByMonth(rowsNow,modeMonth), gP2=groupByMonth(rowsPrev,modeMonth);
  const labels2=[...new Set([...gN2.labels, ...gP2.labels])].sort();
  const map2=(labels,vals)=>{const m={}; labels.forEach((k,i)=>m[k]=vals[i]); return labels2.map(k=>m[k]??0);};
  ensureChart('ch_month',labels2, map2(gN2.labels,gN2.values), map2(gP2.labels,gP2.values));

  // Hour
  const gN3=groupByHour(rowsNow,modeHour), gP3=groupByHour(rowsPrev,modeHour);
  $('hour_hint').style.display = (gN3.has||gP3.has)?'none':'block';
  ensureChart('ch_hour', gN3.labels, gN3.values, gP3.values);

  // Turno
  const gN4=groupByTurno(rowsNow,modeTurno), gP4=groupByTurno(rowsPrev,modeTurno);
  $('turno_hint').style.display = (gN4.has||gP4.has)?'none':'block';
  const labels4=[...new Set([...gN4.labels, ...gP4.labels])];
  const map4=(labels,vals)=>{const m={}; labels.forEach((k,i)=>m[k]=vals[i]); return labels4.map(k=>m[k]??0);};
  ensureChart('ch_turno', labels4, map4(gN4.labels,gN4.values), map4(gP4.labels,gP4.values));
}

/* Toggle handlers */
document.querySelectorAll('.tog').forEach(t=>{
  t.addEventListener('click', (ev)=>{
    if(ev.target.tagName!=='BUTTON') return;
    t.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    ev.target.classList.add('active');
    renderCharts();
  });
});

/* ===== APPLY (KPIs + rows p/ gráficos) ===== */
async function applyAll(){
  try{
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    const len=daysLen(de,ate);
    const atePrevISO=new Date(new Date(de+'T00:00:00').getTime()-86400000);
    const dePrevISO=new Date(atePrevISO.getTime()-(len-1)*86400000);
    const dePrev=iso(dePrevISO), atePrev=iso(atePrevISO);
    setStatus('Consultando…');

    const hasUnids = ms.unids.get().length>0;
    const rpc = hasUnids ? 'kpi_vendas_v2' : 'kpi_vendas';

    const [now,prev,cNow,cPrev]=await Promise.all([
      supa.rpc(rpc, buildParams(de,ate,null,hasUnids)),
      supa.rpc(rpc, buildParams(dePrev,atePrev,null,hasUnids)),
      supa.rpc(rpc, buildParams(de,ate,'Sim',hasUnids)),
      supa.rpc(rpc, buildParams(dePrev,atePrev,'Sim',hasUnids)),
    ]);
    if(now.error) throw now.error; if(prev.error) throw prev.error;
    if(cNow.error) throw cNow.error; if(cPrev.error) throw cPrev.error;

    rowsNow = now.data||[]; rowsPrev = prev.data||[];

    // KPIs agregados
    const N=agg(rowsNow), P=agg(rowsPrev), CN=agg(cNow.data), CP=agg(cPrev.data);
    const tktN=N.ped>0?(N.fat/N.ped):0, tktP=P.ped>0?(P.fat/P.ped):0;
    const fatMedN=len>0?(N.fat/len):0,   fatMedP=len>0?(P.fat/len):0;
    const desPercN=N.fat>0?(N.des/N.fat):0, desPercP=P.fat>0?(P.des/P.fat):0;
    const freMedN=N.ped>0?(N.fre/N.ped):0,  freMedP=P.ped>0?(P.fre/P.ped):0;
    const partCancN=N.ped>0?(CN.ped/N.ped):0, partCancP=P.ped>0?(CP.ped/P.ped):0;

    $('k_ped').textContent=num(N.ped); $('p_ped').textContent=num(P.ped); deltaBadge($('d_ped'),N.ped,P.ped);
    $('k_fat').textContent=money(N.fat); $('p_fat').textContent=money(P.fat); deltaBadge($('d_fat'),N.fat,P.fat);
    $('k_des').textContent=money(N.des); $('p_des').textContent=money(P.des); deltaBadge($('d_des'),N.des,P.des);

    $('k_desperc').textContent=pctf(desPercN); $('p_desperc').textContent=pctf(desPercP); deltaBadge($('d_desperc'),desPercN,desPercP);
    $('k_tkt').textContent=money(tktN); $('p_tkt').textContent=money(tktP); deltaBadge($('d_tkt'),tktN,tktP);
    $('k_fatmed').textContent=money(fatMedN); $('p_fatmed').textContent=money(fatMedP); deltaBadge($('d_fatmed'),fatMedN,fatMedP);

    $('k_fre').textContent=money(N.fre); $('p_fre').textContent=money(P.fre); deltaBadge($('d_fre'),N.fre,P.fre);
    $('k_fremed').textContent=money(freMedN); $('p_fremed').textContent=money(freMedP); deltaBadge($('d_fremed'),freMedN,freMedP);

    $('k_canc_ped').textContent=num(CN.ped); deltaBadge($('d_canc_ped'),CN.ped,CP.ped);
    $('k_canc_val').textContent=money(CN.fat); $('p_canc_val').textContent=money(CP.fat); deltaBadge($('d_canc_val'),CN.fat,CP.fat);
    $('k_canc_part').textContent=pctf(partCancN); $('p_canc_part').textContent=pctf(partCancP);

    setStatus('OK','ok');

    // desenhar gráficos
    renderCharts();
  }catch(e){ console.error(e); setStatus('Erro: '+(e.message||e),'err'); }
}

/* ===== BOOT ===== */
(async function init(){
  setStatus('Carregando…');
  const dr=await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }

  const [unids,lojas,canais,turnos,pags]=await Promise.all([
    supa.from('vw_vendas_unidades').select('unidade').order('unidade'),
    supa.from('vw_vendas_lojas').select('loja').order('loja'),
    supa.from('vw_vendas_canais').select('canal').order('canal'),
    supa.from('vw_vendas_turnos').select('turno').order('turno'),
    supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
  ]);
  const setOpts=(res,field,msel)=> msel.setOptions((res.data||[]).map(r=>r[field]));
  if(!unids.error) setOpts(unids,'unidade',ms.unids);
  if(!lojas.error) setOpts(lojas,'loja',ms.lojas);
  if(!canais.error) setOpts(canais,'canal',ms.canais);
  if(!turnos.error) setOpts(turnos,'turno',ms.turnos);
  if(!pags.error) setOpts(pags,'pagamento_base',ms.pags);
  ms.cancel.setOptions(['','Não','Sim']); ms.cancel.set(['Não']);

  $('periodoInfo').textContent=`Último dia carregado: ${lastDay}`;
  applyQuick('30');
})();
</script>
</body>
</html>
