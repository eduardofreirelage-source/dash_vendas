<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--mut:#667085;--blue:#1a73e8;--bd:#e6eaf2;--r:14px}
  body{background:var(--bg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink)}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 4px}
  small{color:var(--mut)}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:14px}
  .row{display:grid;gap:10px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  label{font-size:12px;color:var(--mut);display:block;margin-bottom:4px}
  input,select,button{border:1px solid var(--bd);border-radius:10px;padding:10px;background:#fff;width:100%}
  select[multiple]{height:120px}
  button{background:var(--blue);color:#fff;border:none;border-radius:10px;cursor:pointer}
  .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  .kpi h3{font-size:12px;color:var(--mut);margin:0 0 6px}
  .kpi b{font-size:20px}
  .right{text-align:right}
  .mut{color:var(--mut)}
  #chart{height:260px;display:block}
  .flex{display:flex;gap:8px;align-items:center;justify-content:space-between}
  @media (max-width:960px){.cols-4,.cols-3,.kpis{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food</h1>
  <small id="status">—</small>

  <div class="card" style="margin-top:10px">
    <div class="row cols-4">
      <div><label>Unidade</label><select id="fUnidade"></select></div>
      <div><label>Nome da loja (Top 10)</label><select id="fLoja"></select></div>
      <div><label>De</label><input id="fDini" type="date"/></div>
      <div><label>Até</label><input id="fDfim" type="date"/></div>
    </div>

    <div class="row cols-4" style="margin-top:8px">
      <div>
        <label>Período rápido</label>
        <select id="fQuick">
          <option>Últimos 30</option>
          <option>Últimos 60</option>
          <option selected>Últimos 90</option>
          <option>Este mês</option>
          <option>Último mês</option>
          <option>Este ano</option>
        </select>
      </div>
      <div><label>Turno</label><select id="fTurno" multiple>
        <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option></select></div>
      <div><label>Canal de venda</label><select id="fCanal" multiple></select></div>
      <div><label>Pagamento</label><select id="fPag" multiple></select></div>
    </div>

    <div class="row cols-3" style="margin-top:8px">
      <div><label>Está cancelado?</label><select id="fCanc"><option>Todos</option><option>Não</option><option>Sim</option></select></div>
      <div class="flex">
        <div class="mut" id="msg"></div>
      </div>
      <div class="right"><label>&nbsp;</label><button id="btnLimpar" type="button">Limpar</button></div>
    </div>
  </div>

  <div class="kpis" style="margin-top:10px">
    <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
    <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
    <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
    <div class="card kpi"><h3>Faturamento Médio (dia)</h3><b id="kFatDia">—</b></div>
    <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
    <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
    <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
    <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="flex"><b>Receita diária</b><span class="mut" id="resumo"></span></div>
    <canvas id="chart"></canvas>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="flex">
      <div><b>Admin — Importar CSV (Pasta2.csv)</b></div>
      <div class="mut">Cada linha = 1 pedido (sem agregação). Dedup por chave composta.</div>
    </div>
    <div class="flex" style="margin-top:8px">
      <input id="csv" type="file" accept=".csv,text/csv"/>
      <button id="btnImport" type="button">Importar CSV</button>
      <span id="impStatus" class="mut"></span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(async function(){
  // -------- CONFIG --------
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";
  const UNIQUE_KEYS = 'dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // -------- DOM --------
  const $=id=>document.getElementById(id);
  const statusEl=$("status"), msg=$("msg"), resumo=$("resumo");
  const dini=$("fDini"), dfim=$("fDfim"), pr=$("fQuick");
  const uni=$("fUnidade"), loja=$("fLoja"), turno=$("fTurno"), canal=$("fCanal"), pag=$("fPag"), canc=$("fCanc");
  const btnLimpar=$("btnLimpar");
  const kPedidos=$("kPedidos"), kTicket=$("kTicket"), kFat=$("kFat"), kFatDia=$("kFatDia"),
        kDes=$("kDes"), kDesPct=$("kDesPct"), kFre=$("kFre"), kFatLiq=$("kFatLiq");
  const chartEl=$("chart"); let chart=null;
  const csv=$("csv"), btnImport=$("btnImport"), impStatus=$("impStatus");

  // -------- STATE --------
  let loadToken=0;
  let cache=[];

  // -------- UTILS --------
  const fmtBRL=v=> (isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—");
  const fmtPct=v=> (isFinite(v)? (v*100).toFixed(1).replace('.',',')+'%' : "—");
  const onlyDate=iso=> iso && iso.length>=10 ? iso.slice(0,10) : null;
  const norm = s => String(s??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const normCancel = v => (v===true || ['sim','s','1','true','y'].includes(norm(v))) ? 'Sim' : 'Não';
  const tzISO = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const selected = sel => Array.from(sel.selectedOptions||[]).map(o=>o.value);
  const parseBR = x => {
    if (x==null || x==='') return 0;
    if (typeof x==='number') return x;
    const n = Number(String(x).replace(/\./g,'').replace(',','.').trim());
    return isFinite(n)? n : 0;
  };
  function ddmmyyyyToISO(s){
    if(!s) return null;
    const str=String(s).trim();
    const [d,m,y]=str.split(/[\/\-]/);
    const day=parseInt(d,10), mon=parseInt(m,10), yr=parseInt(y,10);
    if(!(day>0 && mon>0 && yr>1900)) return null;
    return `${yr.toString().padStart(4,'0')}-${mon.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
  }
  function deriveTurno(h, fallback){
    const hh = Number(h);
    if (isFinite(hh)) {
      if (hh>=6 && hh<12) return 'Manhã';
      if (hh>=12 && hh<18) return 'Tarde';
      if (hh>=18 && hh<24) return 'Noite';
      if (hh>=0 && hh<6) return 'Madrugada';
    }
    return fallback || null;
  }
  function applyQuickDate(){
    const end=new Date(); let start;
    if(pr.value.startsWith("Últimos ")){ const n=parseInt(pr.value.split(' ')[1],10); start=new Date(); start.setDate(end.getDate()-(n-1)); }
    else if(pr.value==="Este mês"){ start=new Date(end.getFullYear(),end.getMonth(),1); }
    else if(pr.value==="Último mês"){ start=new Date(end.getFullYear(),end.getMonth()-1,1); const e=new Date(end.getFullYear(),end.getMonth(),0); dini.value=tzISO(start); dfim.value=tzISO(e); return;}
    else if(pr.value==="Este ano"){ start=new Date(end.getFullYear(),0,1); }
    else { start=new Date(end.getFullYear(),end.getMonth(),end.getDate()-29); }
    dini.value=tzISO(start); dfim.value=tzISO(end);
  }

  // -------- MIN/MAX/TOTAL --------
  async function minmax(){
    const a=await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const b=await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    const c=await supa.from(TABLE).select('*',{count:'exact', head:true});
    const min=onlyDate(a.data?.[0]?.dia)||'—', max=onlyDate(b.data?.[0]?.dia)||'—', tot=c.count??'—';
    statusEl.textContent=`Período: ${min} → ${max} (${tot} linhas)`;
    if(!dini.value || !dfim.value) applyQuickDate();
    return {min,max,tot};
  }

  // -------- FETCH PAGINADO (sem dedup) --------
  async function fetchAll(a,b){
    const myToken=++loadToken;
    const page=5000; let off=0, all=[];
    msg.textContent='Carregando…';
    while(true){
      if (myToken!==loadToken) return [];
      const {data, error} = await supa.from(TABLE)
        .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja","Canal de venda",pagamento,turno,cancelado,hora')
        .gte('dia', a).lte('dia', b)
        .order('dia',{ascending:true})
        .range(off, off+page-1);
      if(error){ console.error(error); msg.textContent='Erro ao carregar dados.'; return []; }
      if(!data?.length) break;
      all = all.concat(data.map(r=>({
        dia: onlyDate(r.dia),
        unidade: (r.unidade??'').trim(),
        pedidos: 1, // modelo correto = 1 por linha
        fat: Number(r.fat)||0, des:Number(r.des)||0, fre:Number(r.fre)||0,
        pagamento: (r.pagamento??'').trim(),
        "Canal de venda": (r["Canal de venda"]??'').trim(),
        "Nome da loja": (r["Nome da loja"]??'').trim(),
        hora: Number(r.hora),
        turno: deriveTurno(r.hora, (r.turno??'').trim()),
        cancelado: normCancel(r.cancelado)
      })));
      off += page;
      msg.textContent=`Carregando… ${all.length.toLocaleString('pt-BR')} linhas`;
      if(data.length<page) break;
      if(off>5_000_000) break;
    }
    msg.textContent=`Concluído. ${all.length.toLocaleString('pt-BR')} linhas.`;
    return all;
  }

  // -------- OPTIONS --------
  function buildOptions(rows){
    const setUni=new Set(['Todas']);
    const setCan=new Set(), setPag=new Set();
    const fatPorLoja=new Map();
    rows.forEach(r=>{
      if(r.unidade) setUni.add(r.unidade);
      if(r['Canal de venda']) setCan.add(r['Canal de venda']);
      if(r.pagamento) setPag.add(r.pagamento);
      if(r['Nome da loja']) fatPorLoja.set(r['Nome da loja'], (fatPorLoja.get(r['Nome da loja'])||0)+r.fat);
    });
    uni.innerHTML=[...setUni].sort((a,b)=>a.localeCompare(b,'pt-BR')).map(v=>`<option>${v}</option>`).join('');
    canal.innerHTML=[...setCan].size? [...setCan].sort().map(v=>`<option>${v}</option>`).join(''):'';
    pag.innerHTML=[...setPag].size? [...setPag].sort().map(v=>`<option>${v}</option>`).join(''):'';
    const top=[...fatPorLoja.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
    loja.innerHTML=['Todos',...top].map(v=>`<option>${v}</option>`).join('');
    uni.value='Todas'; loja.value='Todos'; turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value='Todos';
  }

  // -------- KPIs & CHART --------
  function computeKPIs(rows){
    const pedidos = rows.length;                   // << correto: conta linhas
    const fat = rows.reduce((s,r)=>s+r.fat,0);
    const des = rows.reduce((s,r)=>s+r.des,0);
    const fre = rows.reduce((s,r)=>s+r.fre,0);
    const fatliq = fat - des - fre;
    const dias = new Set(rows.map(r=>r.dia)).size || 1;
    const ticket = pedidos ? fat/pedidos : 0;
    const fatDia = fat / dias;
    const desPct = fat ? des/fat : 0;

    kPedidos.textContent = pedidos.toLocaleString('pt-BR');
    kTicket.textContent  = fmtBRL(ticket);
    kFat.textContent     = fmtBRL(fat);
    kFatDia.textContent  = fmtBRL(fatDia);
    kDes.textContent     = fmtBRL(des);
    kDesPct.textContent  = fmtPct(desPct);
    kFre.textContent     = fmtBRL(fre);
    kFatLiq.textContent  = fmtBRL(fatliq);
    resumo.textContent   = `${rows.length.toLocaleString('pt-BR')} registros`;
  }

  function drawChart(rows){
    const by=new Map();
    rows.forEach(r=> by.set(r.dia,(by.get(r.dia)||0)+r.fat));
    const labels=[...by.keys()].sort();
    const values=labels.map(d=>by.get(d));
    if(chart){ chart.destroy(); chart=null; }
    if(!labels.length) return;
    const ctx=chartEl.getContext('2d');
    chart=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{label:'Receita',data:values,tension:0.2}]},
      options:{
        responsive:true, maintainAspectRatio:false, animation:false, resizeDelay:150,
        interaction:{mode:'index',intersect:false},
        scales:{y:{beginAtZero:true}}
      }
    });
  }

  function applyFiltersAndRender(){
    const uniSel=uni.value||'Todas', lojaSel=loja.value||'Todos';
    const tSel=selected(turno).map(norm);
    const cSel=selected(canal).map(norm);
    const pSel=selected(pag).map(norm);
    const cancSel=canc.value||'Todos';

    const rows = cache.filter(r=>{
      if(uniSel!=='Todas' && norm(r.unidade)!==norm(uniSel)) return false;
      if(lojaSel!=='Todos' && norm(r["Nome da loja"])!==norm(lojaSel)) return false;
      if(tSel.length && !tSel.includes(norm(r.turno))) return false;
      if(cSel.length && !cSel.includes(norm(r["Canal de venda"]))) return false;
      if(pSel.length && !pSel.includes(norm(r.pagamento))) return false;
      if(cancSel!=='Todos' && normCancel(r.cancelado)!==cancSel) return false;
      return true;
    });

    computeKPIs(rows);
    drawChart(rows);
  }

  async function reload(){
    const a=dini.value, b=dfim.value;
    cache = await fetchAll(a,b);
    buildOptions(cache);
    applyFiltersAndRender();
  }

  // -------- IMPORTAÇÃO (cada linha = 1 pedido) --------
  btnImport.addEventListener('click', ()=>{
    const file=csv.files?.[0];
    if(!file){ impStatus.textContent='Selecione um CSV.'; return; }
    impStatus.textContent='Lendo…';

    const batchSize=4000;
    const buffer=[];

    function toRow(r){
      // mapeamentos mínimos:
      const diaRaw = r.dia ?? r['Data da venda'] ?? r['data'] ?? r['Data'];
      const diaISO = diaRaw ? (String(diaRaw).includes('/')? ddmmyyyyToISO(diaRaw) : String(diaRaw).slice(0,10)) : null;
      const unidade = r.unidade ?? r.Unidade ?? '';
      const fat = parseBR(r.fat ?? r.Total ?? r.total);
      const des = parseBR(r.des ?? r['Desconto']);
      const fre = parseBR(r.fre ?? r['Entrega'] ?? r['Frete']);
      const canal = r['Canal de venda'] ?? r.Canal ?? r['canal'];
      const pagto = r['pagamento'] ?? r['Pagamento'] ?? r['Forma de pagamento'];
      const loja = r['Nome da loja'] ?? r['Loja'];
      let hora = r.hora ?? r['Hora'];
      if (hora==null && typeof diaRaw==='string' && diaRaw.includes(':')) {
        const hh = parseInt(diaRaw.split(' ')[1]?.split(':')[0],10); hora = isFinite(hh)? hh : -1;
      }
      hora = isFinite(Number(hora)) ? Number(hora) : -1;

      return diaISO ? {
        dia: diaISO,
        unidade: String(unidade||'').trim(),
        pedidos: 1,                 // << sempre 1 por linha
        fat, des, fre,
        turno: deriveTurno(hora, r.turno ?? r.Turno ?? null),
        pagamento: pagto ?? null,
        "Canal de venda": canal ?? null,
        "Nome da loja": loja ?? null,
        cancelado: normCancel(r.cancelado ?? r['Está cancelado']),
        hora
      } : null;
    }

    function flush = async (final=false) => {
      if(!buffer.length) return;
      impStatus.textContent = `Enviando… ${buffer.length.toLocaleString('pt-BR')} linhas`;
      const { error } = await supa.from(TABLE).upsert(buffer,{ onConflict: UNIQUE_KEYS });
      buffer.length=0;
      if(error){ console.error(error); impStatus.textContent='Erro ao inserir.'; return false; }
      if(final) impStatus.textContent='Importado.';
      return true;
    };

    Papa.parse(file,{
      header:true,
      skipEmptyLines:'greedy',
      delimiter:",", // padrão
      transformHeader: h => String(h).trim(),
      chunk: async (res, parser)=>{
        for(const r of res.data){
          const row = toRow(r);
          if(row) buffer.push(row);
          if(buffer.length>=batchSize){
            parser.pause();
            const ok = await flush();
            if(!ok) { parser.abort(); return; }
            parser.resume();
          }
        }
        impStatus.textContent=`Lendo… ${res.meta.cursor.toLocaleString('pt-BR')} bytes`;
      },
      complete: async ()=>{
        await flush(true);
        await minmax();
        await reload();
      },
      error: (e)=>{ console.error(e); impStatus.textContent='Erro no parse do CSV.'; }
    });
  });

  // -------- LISTENERS --------
  pr.addEventListener('change', ()=>{ applyQuickDate(); reload(); });
  [dini,dfim].forEach(e=> e.addEventListener('change', ()=> reload()));
  [uni,loja,turno,canal,pag,canc].forEach(e=> e.addEventListener('change', ()=> applyFiltersAndRender()));
  btnLimpar.addEventListener('click', ()=>{ applyQuickDate(); reload(); });

  // -------- BOOT --------
  await minmax();
  applyQuickDate();
  await reload();
})();
</script>
</body>
</html>
