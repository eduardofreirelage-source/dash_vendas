<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard — Upload para vendas_xlsx</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0e1014; --panel:#151821; --muted:#8b91a1; --text:#dde3ee;
      --ok:#2ecc71; --warn:#e2b93b; --err:#ff5c5c; --brand:#3b82f6;
      --chip:#1f2330;
    }
    html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    .wrap{max-width:1120px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 18px;font-size:28px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--panel);border:1px solid #23283a;padding:12px 12px 14px;border-radius:12px}
    .chip{background:var(--chip);border:1px solid #273047;color:#b6c2d9;border-radius:999px;padding:6px 10px}
    .btn{background:var(--brand);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.sec{background:#2b3042}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grow{flex:1}
    .msg{margin-top:10px;border-radius:10px;padding:10px 12px}
    .msg.ok{background:rgba(46,204,113,.09);border:1px solid #2ecc71}
    .msg.warn{background:rgba(226,185,59,.09);border:1px solid #e2b93b}
    .msg.err{background:rgba(255,92,92,.09);border:1px solid #ff5c5c}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}
    .card{background:var(--panel);border:1px solid #23283a;border-radius:12px;min-height:220px;padding:10px 12px}
    .hd{font-weight:600;color:#c9d4ea;margin:4px 0 8px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;color:#b9c6e4}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#1a2030;border:1px solid #273047;border-radius:999px;padding:6px 10px;color:#cbd5e1}
    .pill strong{color:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .progress{height:8px;background:#1e2433;border-radius:6px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3b82f6,#22c55e)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted)}
    a {color:#93c5fd;text-decoration:underline}
  </style>

  <!-- Loader resiliente para XLSX -->
  <script>
    function loadScriptSeq(urls, labelEl){
      const tryOne = (i) => new Promise((resolve, reject)=>{
        if(i>=urls.length) return reject(new Error('Todas as fontes falharam'));
        const url = urls[i];
        if(labelEl) labelEl.textContent = 'Carregando XLSX: ' + url;
        const s = document.createElement('script');
        s.src = url;
        s.onload = () => setTimeout(()=> window.XLSX ? resolve(url) : tryOne(i+1).then(resolve).catch(reject), 0);
        s.onerror = () => tryOne(i+1).then(resolve).catch(reject);
        document.head.appendChild(s);
      });
      return tryOne(0);
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>

    <div class="bar">
      <span class="chip">.csv</span>
      <span class="chip">.xlsx / .xls</span>
      <span class="muted"> (Excel serial, <b>dd/mm/aaaa</b> ou <b>yyyy-mm-dd</b>. Se vier <b>data+hora</b>, eu extraio a <b>hora</b>.)</span>
      <div class="grow"></div>
      <input id="file" type="file" accept=".csv,.xlsx,.xls" />
      <button id="btnSave" class="btn" disabled>Salvar no banco</button>
      <button id="btnClear" class="btn sec">Limpar UI</button>
    </div>

    <div class="row" style="margin-top:8px;gap:8px">
      <span class="pill">Leitor Excel: <strong id="xlStatus">Carregando…</strong></span>
      <span class="pill">Fonte: <span id="xlSrc" class="muted">—</span></span>
      <span class="pill">Linhas <strong id="stat-lines">0</strong></span>
      <span class="pill">Válidas <strong id="stat-valid">0</strong></span>
      <span class="pill muted">Puladas (sem data) <strong id="stat-skip">0</strong></span>
    </div>

    <div id="banner"></div>

    <div id="progressWrap" class="msg" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div><b id="progLabel">Enviando...</b></div>
        <div class="muted" id="progNum">0/0</div>
      </div>
      <div class="progress" style="margin-top:8px"><i id="progBar"></i></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">Prévia (5 primeiras linhas válidas):</div>
        <pre id="preview">—</pre>
      </div>
      <div class="card">
        <div class="hd">Mapeamento escolhido:</div>
        <pre id="mapview">—</pre>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="hd">Ajuda rápida</div>
      <ul class="muted">
        <li>Se aparecer <code>"null value in column &quot;dia&quot;"</code>, alguma linha veio sem data. Eu pulo essas linhas no upload.</li>
        <li>Datas aceitas: Excel serial, <b>dd/mm/aaaa</b> ou <b>yyyy-mm-dd</b>. Se vier <b>data+hora</b>, eu extraio a <b>hora</b>.</li>
        <li>Se sua rede bloquear CDN, deixe o arquivo <code>xlsx.full.min.js</code> na <b>mesma pasta</b> deste HTML.</li>
      </ul>
    </div>
  </div>

<script>
/* ====== CONFIG DO SUPABASE ====== */
const SUPABASE_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== UI helpers ====== */
const $ = (sel) => document.querySelector(sel);
function showBanner(html, kind='ok'){
  const el = document.createElement('div');
  el.className = 'msg '+(kind==='ok'?'ok':kind==='warn'?'warn':'err');
  el.innerHTML = html;
  const b = $('#banner'); b.innerHTML=''; b.appendChild(el);
}
function setProgress(cur, total, label='Enviando...'){
  $('#progressWrap').style.display='block';
  $('#progLabel').textContent = label;
  $('#progNum').textContent = `${cur}/${total}`;
  const pct = total? Math.round((cur/total)*100):0;
  $('#progBar').style.width = pct+'%';
}
function hideProgress(){ $('#progressWrap').style.display='none' }

/* ====== Carrega XLSX de fontes múltiplas ====== */
const xlsSources = [
  './xlsx.full.min.js',
  '/xlsx.full.min.js',
  '/assets/xlsx.full.min.js',
  'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
  'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
];

document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    const used = await loadScriptSeq(xlsSources, $('#xlSrc'));
    $('#xlStatus').textContent = 'OK';
    $('#xlSrc').textContent = used;
  }catch(e){
    $('#xlStatus').textContent = 'Falhou';
    $('#xlSrc').textContent = '—';
    showBanner(
      `Falha ao carregar a biblioteca XLSX. Coloque <b>xlsx.full.min.js</b> na <b>mesma pasta</b> deste HTML ou libere a CDN.<br>
       Dica: abra <code>${location.origin}/xlsx.full.min.js</code> em outra aba; se der 404, mova o arquivo para a pasta do HTML.`,
      'warn'
    );
  }
});

/* ====== Hash FNV-1a 64-bit (síncrono, estável) ====== */
function fnv1a64(str){
  let hash = 14695981039346656037n;          // offset basis
  const prime = 1099511628211n;              // FNV prime
  for (let i=0;i<str.length;i++){
    hash ^= BigInt(str.charCodeAt(i));
    hash = (hash * prime) & 0xFFFFFFFFFFFFFFFFn;
  }
  return hash.toString(16).padStart(16,'0');
}

/* ====== Leitura e mapeamento ====== */
let parsedRows = [];    // linhas normalizadas
let sampleRows = [];    // prévia
let mappingChosen = {}; // mapeamento

$('#btnClear').addEventListener('click', ()=>{
  parsedRows = []; sampleRows=[]; mappingChosen={};
  $('#file').value = '';
  $('#stat-lines').textContent='0';
  $('#stat-valid').textContent='0';
  $('#stat-skip').textContent='0';
  $('#preview').textContent='—';
  $('#mapview').textContent='—';
  $('#btnSave').disabled=true;
  hideProgress();
  $('#banner').innerHTML='';
});

$('#file').addEventListener('change', async (e)=>{
  hideProgress();
  $('#btnSave').disabled = true;
  $('#preview').textContent='Lendo arquivo...';
  $('#mapview').textContent='—';
  parsedRows = []; sampleRows=[]; mappingChosen={};

  if(!window.XLSX){
    showBanner('O leitor XLSX ainda não foi carregado. Verifique o aviso acima e recarregue a página após corrigir.', 'warn');
    $('#preview').textContent='—';
    return;
  }

  try{
    const file = e.target.files?.[0];
    if(!file){ $('#preview').textContent='—'; return; }

    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array', cellDates:true, raw:false});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const data = XLSX.utils.sheet_to_json(ws, {defval:null});
    const total = data.length;

    const headers = Object.keys(data[0] || {});
    const map = chooseMapping(headers);
    mappingChosen = map;
    $('#mapview').textContent = JSON.stringify(map, null, 2);

    let valid = 0, skipped=0;
    const out = [];
    for (let i=0;i<data.length;i++){
      const row = data[i];
      const norm = normalizeRow(row, map);
      if(!norm.dia){ skipped++; continue; }
      norm.row_key = makeRowKey(norm);   // agora usa FNV-1a
      out.push(norm);
      if(sampleRows.length<5) sampleRows.push(norm);
      valid++;
    }

    parsedRows = out;
    $('#stat-lines').textContent = String(total);
    $('#stat-valid').textContent = String(valid);
    $('#stat-skip').textContent = String(skipped);
    $('#preview').textContent = sampleRows.length? sampleRows.map(x=>JSON.stringify(x,null,2)).join('\n_\n') : '—';
    $('#btnSave').disabled = parsedRows.length===0;

    if(!parsedRows.length){
      showBanner('Nenhuma linha válida (todas sem data). Veja “Ajuda rápida”.', 'warn');
    }else{
      showBanner('Pronto para enviar. Use <b>Salvar no banco</b>.', 'ok');
    }
  }catch(err){
    console.error(err);
    showBanner('Erro ao ler a planilha: '+ (err?.message||err), 'err');
    $('#preview').textContent='—';
  }
});

/* ====== Envio (upsert por row_key) ====== */
$('#btnSave').addEventListener('click', async ()=>{
  if(!parsedRows.length) return;
  const BATCH = 500;
  let ok=0, fail=0;
  setProgress(0, parsedRows.length, 'Enviando...');

  for (let i=0;i<parsedRows.length;i+=BATCH){
    const chunk = parsedRows.slice(i, i+BATCH);
    const { error } = await supa
      .from('vendas_xlsx')
      .upsert(chunk, { onConflict: 'row_key' });

    if(error){
      fail += chunk.length;
      hideProgress();
      alert(`Parte dos registros falhou.\nInseridos/Atualizados: ${ok}\nFalhas: ${fail}\n\nÚltimo erro:\n${error.message||error}`);
      return;
    }else{
      ok += chunk.length;
      setProgress(ok, parsedRows.length, 'Enviando...');
    }
  }
  hideProgress();
  showBanner(`✅ Envio concluído: <b>${ok}/${parsedRows.length}</b> inseridos/atualizados.`, 'ok');
});

/* ====== Normalização ====== */
function chooseMapping(headers){
  const hs = headers.map(h=>String(h||'').trim().toLowerCase());
  const find = (...alts)=> {
    for(const a of alts){
      const ix = hs.indexOf(a.toLowerCase());
      if(ix>=0) return headers[ix];
    }
    return null;
  };

  const dia = find('data da venda','data do pedido','data','dia','dt','data venda','data pedido','data/hora','data e hora','data hora');
  const hora = find('hora','horário','horario','time','hora venda');
  const unid = find('unidade','uni','filial','empresa','unid');
  const loja = find('código da loja','codigo da loja','código loja','codigo loja','loja','nome da loja');
  const canal= find('canal de venda','canal','origem');
  const pag  = find('pagamento','tipo de pagamento','pagamento_base','tipo pagamento');
  const canc = find('está cancelado','cancelado','cancelada','cancel','cancelada?','está cancelada');
  const ped  = find('itens','pedidos','qtd pedidos','qtd','quantidade');
  const fat  = find('valor entregador','fat','faturamento','valor total','valor');
  const des  = find('des','desconto');
  const fre  = find('fre','entrega','frete');
  const pedido_id = find('pedido','pedido id','id pedido','id');

  return { dia, hora, unid, loja, canal, pag, canc, ped, fat, des, fre, pedido_id };
}

function parseDiaHora(v){
  if(v==null || v==='') return {dia:null,hora:null};
  if(v instanceof Date){
    const d = v;
    return { dia: d.toISOString().slice(0,10), hora: d.getHours() };
  }
  if(typeof v==='number'){
    const epoch = new Date(Date.UTC(1899,11,30));
    const d = new Date(epoch.getTime()+v*24*3600*1000);
    return { dia: d.toISOString().slice(0,10), hora: d.getHours() };
  }
  const s = String(v).trim();
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::\d{2})?)?$/);
  if(m){
    const dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0');
    const yyyy = m[3].length===2 ? ('20'+m[3]) : m[3];
    const hh = m[4]!=null? Number(m[4]): null;
    return { dia: `${yyyy}-${mm}-${dd}`, hora: hh };
  }
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{1,2}):(\d{2})(?::\d{2})?)?$/);
  if(m2){
    const hh = m2[4]!=null? Number(m2[4]): null;
    return { dia:`${m2[1]}-${m2[2]}-${m2[3]}`, hora: hh };
  }
  const d = new Date(s);
  if(!isNaN(d)){
    return { dia: d.toISOString().slice(0,10), hora: d.getHours() };
  }
  return { dia:null, hora:null };
}

function toNum(x){
  if(x==null || x==='') return 0;
  if(typeof x==='number') return x;
  const s=String(x).replace(/\./g,'').replace(',','.');
  const v=parseFloat(s);
  return isNaN(v)?0:v;
}
function toInt(x){
  if(x==null || x==='') return 0;
  if(typeof x==='number') return Math.round(x);
  const v=parseInt(String(x).replace(/\D+/g,'')||'0',10);
  return isNaN(v)?0:v;
}
function normCancel(x){
  const s = String(x==null?'':x).toLowerCase();
  if(['sim','yes','y','true','1'].includes(s)) return 'Sim';
  if(['nao','não','no','n','false','0'].includes(s)) return 'Não';
  return s ? s[0].toUpperCase()+s.slice(1) : 'Não';
}

function normalizeRow(row, map){
  const {dia,hora} = parseDiaHora(row[map.dia]);
  const turno = hora==null? null : (hora<12?'Manhã':hora<18?'Dia':'Noite');

  return {
    dia, hora: hora==null? null: Number(hora),
    unidade: map.unid? String(row[map.unid]??'').trim() : null,
    loja: map.loja? String(row[map.loja]??'').trim() : null,
    canal: map.canal? String(row[map.canal]??'').trim() : null,
    pagamento_base: map.pag? String(row[map.pag]??'').trim() : null,
    cancelado: normCancel( map.canc? row[map.canc] : 'Não' ),
    pedidos: toInt( map.ped? row[map.ped] : 0 ),
    fat: toNum( map.fat? row[map.fat] : 0 ),
    des: toNum( map.des? row[map.des] : 0 ),
    fre: toNum( map.fre? row[map.fre] : 0 ),
    pedido_id: map.pedido_id? String(row[map.pedido_id]??'').trim() : null,
    turno
  };
}

function makeRowKey(o){
  const key = [
    o.dia??'', o.hora??'', o.unidade??'', o.loja??'', o.canal??'',
    o.pagamento_base??'', o.cancelado??'', o.pedido_id??'',
    String(o.pedidos??0), String(o.fat??0), String(o.des??0), String(o.fre??0)
  ].join('|');
  return fnv1a64(key);
}
</script>
</body>
</html>
