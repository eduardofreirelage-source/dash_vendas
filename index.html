<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Maestro Food — DB Healthcheck</title>
  <!-- favicon inline para evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="82" text-anchor="middle" font-family="Arial" font-size="72" fill="white">M</text></svg>'/>
  <style>
    body{font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto;margin:24px;background:#f7f8fb;color:#0f172a}
    .wrap{max-width:920px;margin:0 auto}
    .card{background:#fff;border:1px solid #e6eaf2;border-radius:12px;padding:16px;margin-top:14px}
    button{background:#1a73e8;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .muted{color:#667085}
    pre{background:#0f172a;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto;max-height:320px}
    .ok{color:#0d9488} .err{color:#dc2626}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:840px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food — Healthcheck do Banco</h1>
  <p class="muted">Teste mínimo para garantir leitura do Supabase (sem filtros/gráficos/importação).</p>

  <div class="card">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div>
        <div>Fonte detectada: <b id="fonte">—</b></div>
        <div>Intervalo no banco: <span id="range" class="muted">—</span></div>
        <div>Total (count exato): <b id="total">—</b></div>
      </div>
      <div>
        <button id="btnLoad">Carregar do Supabase</button>
      </div>
    </div>
    <div id="progress" class="muted" style="margin-top:8px">Pronto.</div>
  </div>

  <div class="row">
    <div class="card">
      <b>Sample (primeiras linhas)</b>
      <pre id="sample">[]</pre>
    </div>
    <div class="card">
      <b>Unidades / Canais / Pagamentos (amostra)</b>
      <pre id="uniques">[]</pre>
    </div>
  </div>

  <div class="card">
    <b>Erros</b>
    <pre id="errors" class="err">—</pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script>
(async function(){
  // ===== CONFIG =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const PREFER_TABLE  = "vendas_kpi_daily_v2_data";
  const FALLBACK_VIEW = "vendas_kpi_daily_v2";
  const SELECT_COLS   = 'dia,unidade,"Nome da loja","Canal de venda",pagamento,fat,des,fre,hora,turno,cancelado';

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:true,autoRefreshToken:true}});

  // ===== DOM =====
  const $ = (id)=>document.getElementById(id);
  const fonte=$("fonte"), range=$("range"), total=$("total"), progress=$("progress"),
        sample=$("sample"), uniques=$("uniques"), errors=$("errors"), btn=$("btnLoad");

  let TABLE=null, minISO=null, maxISO=null;

  // ===== helpers =====
  async function pickSource(){
    let r = await supa.from(PREFER_TABLE).select('dia').limit(1);
    if(!r.error){ TABLE=PREFER_TABLE; return; }
    r = await supa.from(FALLBACK_VIEW).select('dia').limit(1);
    if(!r.error){ TABLE=FALLBACK_VIEW; return; }
    TABLE=null; errors.textContent = JSON.stringify(r.error||'Sem fonte', null, 2);
  }
  async function fetchMinMax(){
    if(!TABLE){ minISO=maxISO=null; return; }
    const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    if(!a.error && a.data?.length && !b.error && b.data?.length){
      minISO = (a.data[0].dia||'').slice(0,10);
      maxISO = (b.data[0].dia||'').slice(0,10);
    }
  }
  async function countExact(){
    if(!TABLE) return null;
    const r = await supa.from(TABLE).select('dia', { count:'exact', head:true });
    return r.count ?? null;
  }
  async function fetchAllPaged(step=5000, hardCap=1_000_000){
    const out=[]; let from=0;
    while(true){
      const to=from+step-1;
      const { data, error } = await supa.from(TABLE).select(SELECT_COLS).range(from,to);
      if(error){ errors.textContent = JSON.stringify(error, null, 2); break; }
      if(!data || !data.length) break;
      out.push(...data);
      progress.textContent = `Baixando… ${out.length.toLocaleString('pt-BR')} linhas`;
      if(data.length<step || out.length>=hardCap) break;
      from+=step;
    }
    return out;
  }

  async function loadNow(){
    try{
      progress.textContent = "Detectando fonte…";
      await pickSource();
      fonte.innerHTML = TABLE ? `<span class="ok">${TABLE}</span>` : '<span class="err">—</span>';
      if(!TABLE){ progress.textContent = "Sem fonte."; return; }

      progress.textContent = "Lendo intervalo de datas…";
      await fetchMinMax();
      range.textContent = (minISO && maxISO) ? `${minISO} → ${maxISO}` : "—";

      progress.textContent = "Contando linhas (head)…";
      const cnt = await countExact();
      total.textContent = (cnt==null) ? "—" : cnt.toLocaleString('pt-BR');

      progress.textContent = "Baixando páginas… (sem limite de 1000)";
      const rows = await fetchAllPaged(5000, 1_000_000);

      // sample
      sample.textContent = JSON.stringify(rows.slice(0,10), null, 2);

      // alguns uniques
      const U = (key)=> [...new Set(rows.map(r=>r?.[key]).filter(Boolean))].slice(0,20);
      uniques.textContent = JSON.stringify({
        unidades: U('unidade'),
        canais:   U('Canal de venda'),
        pagamentos: U('pagamento')
      }, null, 2);

      progress.textContent = `Concluído. Baixadas ${rows.length.toLocaleString('pt-BR')} linhas.`;
    }catch(e){
      errors.textContent = JSON.stringify(String(e), null, 2);
      progress.textContent = "Erro.";
    }
  }

  btn.addEventListener('click', loadNow);

  // dispara 1x ao abrir, se quiser automático:
  // loadNow();
})();
</script>
</body>
</html>
