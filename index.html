<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Dashboard Vendas — Supabase (v17.2-MV-paged-fix3+loja)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--kbg:#f8fafc;--kbr:#eef2f7;--up:#16a34a;--down:#dc2626}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 4px}
  .muted{color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
  pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;white-space:pre-wrap;overflow:auto}
  /* Filtros (dropdown) */
  details.filtros{border:1px solid var(--brd);border-radius:12px;background:var(--card)}
  details.filtros>summary{list-style:none;cursor:pointer;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;font-weight:700}
  details.filtros>summary::-webkit-details-marker{display:none}
  .sumHint{font-size:12px;color:var(--muted)}
  .fbody{padding:12px 14px 16px;border-top:1px solid var(--brd)}
  .grid12{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px}
  .seg{display:flex;flex-direction:column;gap:6px;min-width:0}
  .seg .lbl{font-size:12px;color:var(--muted)}
  select,input[type="date"]{font:inherit;padding:10px 12px;border:1px solid var(--brd);border-radius:10px;background:#fff;width:100%;min-height:40px}
  .rightBar{display:flex;gap:8px;align-items:center}
  .subtle{background:#fff;border:1px solid var(--brd);border-radius:10px;padding:8px 12px;cursor:pointer;opacity:.95}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--brd);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px}
  .chip[aria-checked="true"]{background:#f1f5f9;border-color:#cbd5e1}
  .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}
  @media (max-width:980px){.grid12{grid-template-columns:repeat(6,1fr)}}
  @media (max-width:560px){.grid12{grid-template-columns:repeat(1,1fr)}.col-12,.col-6,.col-4,.col-3,.col-2{grid-column:span 1}}
  /* KPIs */
  .krow{display:grid;gap:12px;margin-top:12px}
  .krow.two{grid-template-columns:repeat(2,1fr)} .krow.four{grid-template-columns:repeat(4,1fr)}
  @media (max-width:980px){.krow.two{grid-template-columns:1fr}.krow.four{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.krow.four{grid-template-columns:1fr}}
  .kcard{background:var(--kbg);border:1px solid var(--kbr);border-radius:14px}
  .kcard .khead{display:flex;align-items:center;justify-content:space-between}
  .kcard .title{font-size:12px;color:var(--muted)} .kcard .val{font-size:22px;font-weight:700;margin-top:6px}
  .badge{font-size:12px;font-weight:700} .badge.up{color:var(--up)} .badge.down{color:var(--down)} .badge.flat{color:var(--muted)}
  /* Charts */
  .chartbox{position:relative;height:280px;width:100%} /* altura fixa -> sem infinito */
  .ctop{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .segSwitch{display:inline-flex;border:1px solid var(--brd);border-radius:10px;overflow:hidden}
  .segSwitch button{padding:6px 10px;border:0;background:#fff;cursor:pointer}
  .segSwitch button.active{background:#f1f5f9}
  .hidden{display:none}
  /* Assistente "Configurar loja" */
  .cfg{margin:12px 0;padding:10px 12px;border:1px dashed #cbd5e1;background:#f8fafc;border-radius:10px;display:none}
  .cfg .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .cfg select{min-width:220px}
  .link{color:#2563eb;cursor:pointer;text-decoration:underline}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:flex-end">
    <div>
      <h1>Dashboard Vendas — Supabase <span class="muted">(v17.2-MV-paged-fix3)</span></h1>
      <div class="muted">Fonte: <code>public.vendas_kpi_daily_v2</code> (paginado)</div>
      <div class="muted" id="periodo">Período: —</div>
      <div class="muted" id="limites">Limites no banco: —</div>
    </div>
    <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
  </div>

  <!-- Filtros -->
  <details id="fltBox" class="filtros" open>
    <summary>
      <span>FILTROS</span>
      <div class="rightBar">
        <span class="sumHint" id="sumHint">—</span>
        <button id="limpar" class="subtle">Limpar filtros</button>
      </div>
    </summary>
    <div class="fbody">
      <div class="grid12">
        <div class="seg col-6"><span class="lbl">Unidade</span><select id="uni"></select></div>
        <div class="seg col-6" id="segLoja"><span class="lbl">Nome da loja (Top 10 por faturamento)</span><div id="lojaChips" class="chips"></div></div>
      </div>
      <div class="grid12" style="margin-top:10px">
        <div class="seg col-3"><span class="lbl">De</span><input id="dini" type="date"/></div>
        <div class="seg col-3"><span class="lbl">Até</span><input id="dfim" type="date"/></div>
        <div class="seg col-2"><span class="lbl">Período rápido (dias)</span><select id="prapido"><option value="">—</option><option>7</option><option>15</option><option selected>30</option><option>90</option><option>180</option><option>360</option></select></div>
        <div class="seg col-2 hidden" id="segTurno"><span class="lbl">Turno</span><select id="turno"><option value="todos">Todos</option></select></div>
        <div class="seg col-2"><span class="lbl">Dia da semana</span>
          <select id="dow"><option value="todos" selected>Todos</option><option value="uteis">Úteis (Seg–Sex)</option><option value="fds">Fins de semana</option><option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option><option value="4">Qui</option><option value="5">Sex</option><option value="6">Sáb</option><option value="0">Dom</option></select>
        </div>
      </div>
      <div class="grid12" style="margin-top:10px">
        <div class="seg col-4 hidden" id="segCanal"><span class="lbl">Canal de venda</span><select id="canal"><option value="todos">Todos</option></select></div>
        <div class="seg col-4 hidden" id="segPagto"><span class="lbl">Pagamento</span><select id="pagto"><option value="todos">Todos</option></select></div>
        <div class="seg col-4 hidden" id="segCanc"><span class="lbl">Está cancelado</span><select id="canc"><option value="todos" selected>Todos</option><option value="sim">Somente cancelados</option><option value="nao">Somente não cancelados</option></select></div>
      </div>
      <div class="muted" style="margin-top:8px">Datas limitadas ao intervalo existente (âncora: último dia disponível por Unidade).</div>
    </div>
  </details>

  <!-- Assistente para definir a coluna de loja -->
  <div id="cfgLoja" class="cfg">
    <div class="row">
      <strong>Configurar loja:</strong>
      <span class="muted">Escolha qual coluna é o “Nome da Loja”.</span>
      <select id="cfgLojaSel"></select>
      <button id="cfgLojaSave" class="subtle">Salvar</button>
      <span class="link" id="cfgLojaReset">Resetar</span>
    </div>
    <div class="muted" id="cfgLojaHelp" style="margin-top:6px"></div>
  </div>

  <!-- KPIs -->
  <div class="krow two">
    <div class="card kcard"><div class="khead"><div class="title">Pedidos</div><div class="badge" id="k_ped_badge">—</div></div><div class="val" id="k_ped_val">…</div><div class="muted" id="k_ped_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Ticket médio</div><div class="badge" id="k_ticket_badge">—</div></div><div class="val" id="k_ticket_val">…</div><div class="muted" id="k_ticket_sub">—</div></div>
  </div>
  <div class="krow four">
    <div class="card kcard"><div class="khead"><div class="title">Faturamento</div><div class="badge" id="k_fat_badge">—</div></div><div class="val" id="k_fat_val">…</div><div class="muted" id="k_fat_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Faturamento médio (por dia)</div><div class="badge" id="k_fat_med_badge">—</div></div><div class="val" id="k_fat_med_val">…</div><div class="muted" id="k_fat_med_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Faturamento líquido</div><div class="badge" id="k_fatliq_badge">—</div></div><div class="val" id="k_fatliq_val">…</div><div class="muted" id="k_fatliq_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Faturamento líquido %</div><div class="badge" id="k_fatliq_pct_badge">—</div></div><div class="val" id="k_fatliq_pct_val">…</div><div class="muted" id="k_fatliq_pct_sub">—</div></div>
  </div>
  <div class="krow four">
    <div class="card kcard"><div class="khead"><div class="title">Incentivos</div><div class="badge" id="k_des_badge">—</div></div><div class="val" id="k_des_val">…</div><div class="muted" id="k_des_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Incentivos %</div><div class="badge" id="k_des_pct_badge">—</div></div><div class="val" id="k_des_pct_val">…</div><div class="muted" id="k_des_pct_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Frete</div><div class="badge" id="k_fre_badge">—</div></div><div class="val" id="k_fre_val">…</div><div class="muted" id="k_fre_sub">—</div></div>
    <div class="card kcard"><div class="khead"><div class="title">Frete médio</div><div class="badge" id="k_fre_med_badge">—</div></div><div class="val" id="k_fre_med_val">…</div><div class="muted" id="k_fre_med_sub">—</div></div>
  </div>

  <!-- GRÁFICOS -->
  <div class="card" style="margin-top:12px">
    <div class="ctop"><div class="title">Receita diária</div>
      <div class="segSwitch" data-target="gDaily"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média</button></div>
    </div><div class="chartbox"><canvas id="gDaily"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="ctop"><div class="title">Receita por dia da semana</div>
      <div class="segSwitch" data-target="gDOW"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média</button></div>
    </div><div class="chartbox"><canvas id="gDOW"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="ctop"><div class="title">Receita por mês</div>
      <div class="segSwitch" data-target="gMonth"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média diária</button></div>
    </div><div class="chartbox"><canvas id="gMonth"></canvas></div>
  </div>

  <div id="hourCard" class="card hidden" style="margin-top:12px">
    <div class="ctop"><div class="title">Receita por hora (oculta horas inativas)</div>
      <div class="segSwitch" data-target="gHour"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média</button></div>
    </div><div class="chartbox"><canvas id="gHour"></canvas></div>
  </div>

  <div id="dowPedCard" class="card" style="margin-top:12px">
    <div class="ctop"><div class="title">Pedidos por dia da semana</div>
      <div class="segSwitch" data-target="gDOWPed"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média</button></div>
    </div><div class="chartbox"><canvas id="gDOWPed"></canvas></div>
  </div>

  <div id="topLojasCard" class="card" style="margin-top:12px">
    <div class="ctop"><div class="title">Top 10 Lojas por faturamento</div>
      <div class="segSwitch" data-target="gTopLojas"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média diária</button></div>
    </div><div class="chartbox"><canvas id="gTopLojas"></canvas></div>
  </div>

  <div id="liqMesCard" class="card" style="margin-top:12px">
    <div class="ctop"><div class="title">Faturamento líquido por mês</div>
      <div class="segSwitch" data-target="gLiqMes"><button data-mode="total" class="active">Total</button><button data-mode="avg">Média diária</button></div>
    </div><div class="chartbox"><canvas id="gLiqMes"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="title">Status / Logs</div>
    <pre id="log">Iniciando…</pre>
  </div>
</div>

<script>
(function(){
  if(window.__DASH_BOOTED__) return; window.__DASH_BOOTED__=true;

  // ===== Credenciais
  const SUPABASE_URL="https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE="vendas_kpi_daily_v2";

  // ===== Supabase client (singleton)
  const supa = window.__SUPA__ || (window.__SUPA__ = window.supabase.createClient(
    SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:false}}
  ));

  // ===== UI helpers
  const elLog=document.getElementById("log"), elPeriodo=document.getElementById("periodo"), elLimites=document.getElementById("limites"), sumHint=document.getElementById("sumHint");
  const fltBox=document.getElementById("fltBox");
  const selUni=document.getElementById("uni"), dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), prapido=document.getElementById("prapido"), selDOW=document.getElementById("dow");
  const selTurno=document.getElementById("turno"), selCanal=document.getElementById("canal"), selPagto=document.getElementById("pagto"), selCanc=document.getElementById("canc");
  const segTurno=document.getElementById("segTurno"), segCanal=document.getElementById("segCanal"), segPagto=document.getElementById("segPagto"), segCanc=document.getElementById("segCanc");
  const lojaChips=document.getElementById("lojaChips"), segLoja=document.getElementById("segLoja");
  const cfg=document.getElementById("cfgLoja"), cfgSel=document.getElementById("cfgLojaSel"), cfgHelp=document.getElementById("cfgLojaHelp");

  function log(s){ elLog.textContent+="\n"+s; }
  const fmtBRL=n=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt=n=>new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const fmtPct=n=>(Number(n)||0).toFixed(1).replace('.',',')+"%";
  const toISO=d=>d.toISOString().slice(0,10);
  const addDays=(d,k)=>{const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t;}
  const sum=(a,k)=>a.reduce((s,r)=>s+Number(r[k]||0),0);
  function badge(el,pct){ el.className=pct>0?"badge up":(pct<0?"badge down":"badge flat"); el.textContent=(pct>0?"▲":pct<0?"▼":"•")+" "+pct.toFixed(1).replace('.',',')+"%"; }
  const debounce=(fn,w)=>{let t; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),w);}};

  let runId=0, dataMinISO=null, dataMaxISO=null;
  let schema={ turno:null, canal:null, pagamento:null, cancelado:null, cancelType:null, hora:null, loja:null, lojaUnsafe:false };
  let lojaSelSet=new Set();
  let _sample={}; // usado para inferir tipo de cancelado
  let _lastRows=[], _lastRowsPrev=[], _lastTop10=[];
  let chartDaily, chartDOW, chartMonth, chartHour, chartDOWPed, chartTopLojas, chartLiqMes;

  // ===== Helpers de filtros
  function getSelectedLojas(){ return [...lojaSelSet]; }
  function updateSummaryHint(){ const pr=prapido.value?prapido.value+"d":"—"; const uni=selUni.value||"Todas"; const nj=lojaSelSet.size; sumHint.textContent=`Unidade: ${uni} • PR: ${pr} • Lojas: ${nj>0?nj:"todas"}`; }
  const collapse=debounce(()=>{fltBox.open=false;},800);
  function touchFilters(){ updateSummaryHint(); collapse(); }
  function keyLoja(){ return schema.loja || null; }
  function renderLojaChips(list){
    const prev=new Set(lojaSelSet); lojaChips.innerHTML="";
    list.forEach(nome=>{
      const b=document.createElement("button"); b.type="button"; b.className="chip"; b.setAttribute("role","checkbox");
      b.setAttribute("aria-checked", prev.has(String(nome))?"true":"false"); b.dataset.value=String(nome); b.textContent=String(nome);
      b.onclick=function(){ const v=this.dataset.value; const on=this.getAttribute("aria-checked")==="true"; if(on){lojaSelSet.delete(v); this.setAttribute("aria-checked","false");} else {lojaSelSet.add(v); this.setAttribute("aria-checked","true");} recarregarDebounced(); };
      lojaChips.appendChild(b);
    });
    [...prev].forEach(v=>{ if(!list.includes(v)) lojaSelSet.delete(v); });
  }

  // ===== Assistente "Configurar loja"
  const LOJA_OVERRIDE_KEY="LOJA_COL_OVERRIDE";
  function showCfg(columns){
    cfg.style.display="block"; cfgSel.innerHTML="";
    columns.forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=c; cfgSel.appendChild(o); });
    const guess = columns.find(c=>/loja|store|estabelecimento|fantasia|ponto|pdv/i.test(c));
    if(guess) cfgSel.value=guess;
    cfgHelp.textContent="Dica: procure algo como “Nome da Loja”, “nome_loja”, “store_name”…";
  }
  function hideCfg(){ cfg.style.display="none"; }
  document.getElementById("cfgLojaSave").onclick=function(){
    const col=cfgSel.value; if(!col) return;
    localStorage.setItem(LOJA_OVERRIDE_KEY,col);
    log("[Setup] Coluna de loja definida: "+col);
    schema.loja=col; schema.lojaUnsafe=/[^A-Za-z0-9_]/.test(col);
    segLoja.style.display=""; hideCfg(); recarregarDebounced();
  };
  document.getElementById("cfgLojaReset").onclick=function(){
    localStorage.removeItem(LOJA_OVERRIDE_KEY);
    log("[Setup] Coluna de loja resetada.");
    schema.loja=null; lojaSelSet.clear(); segLoja.style.display="none"; recarregarDebounced();
  };

  // ===== Data bounds
  async function fetchUnidades(){
    const uniq={}, arr=["Todas"]; const push=l=>(l||[]).forEach(r=>{const u=(r.unidade||"").trim(); if(u&&!uniq[u]){uniq[u]=1; arr.push(u);}});
    const today=new Date(), endISO=toISO(new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate()))), startISO="2020-01-01";
    const r1=await supa.from(TABLE).select("unidade").gte("dia",startISO).lte("dia",endISO).order("unidade",{ascending:true}).range(0,9999); if(!r1.error) push(r1.data);
    const r2=await supa.from(TABLE).select("unidade").gte("dia",startISO).lte("dia",endISO).order("unidade",{ascending:false}).range(0,9999); if(!r2.error) push(r2.data);
    if(arr.length===1){arr.push("Uni. Raja","Uni.Savassi");} return arr;
  }
  async function getDateBounds(unidade){
    let qMax=supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    let qMin=supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    if(unidade && unidade!=="Todas"){ qMax=qMax.eq("unidade",unidade); qMin=qMin.eq("unidade",unidade); }
    const [rMax,rMin]=await Promise.all([qMax,qMin]); if(rMax.error) throw rMax.error; if(rMin.error) throw rMin.error;
    return {maxISO:(rMax.data&&rMax.data[0])?rMax.data[0].dia:null, minISO:(rMin.data&&rMin.data[0])?rMin.data[0].dia:null};
  }
  async function refreshBounds(unidade){
    const b=await getDateBounds(unidade); dataMinISO=b.minISO; dataMaxISO=b.maxISO;
    elLimites.textContent = (dataMinISO&&dataMaxISO) ? `Limites no banco: ${dataMinISO} → ${dataMaxISO}` : "Limites no banco: —";
    if(dataMinISO&&dataMaxISO){ dini.min=dataMinISO; dfim.min=dataMinISO; dini.max=dataMaxISO; dfim.max=dataMaxISO; }
  }

  // ===== Query builders
  function buildSelect(){
    const needsStar = schema.lojaUnsafe;
    let base = needsStar ? "*" : "dia,unidade,pedidos,fat,des,fre";
    if(!needsStar && schema.hora) base+=","+schema.hora;
    if(!needsStar && schema.loja) base+=","+schema.loja;
    return base;
  }
  function applyServerFilters(q){
    if(schema.turno && selTurno.value!=="todos") q=q.eq(schema.turno,selTurno.value);
    if(schema.canal && selCanal.value!=="todos") q=q.eq(schema.canal,selCanal.value);
    if(schema.pagamento && selPagto.value!=="todos") q=q.eq(schema.pagamento,selPagto.value);
    if(schema.cancelado && selCanc.value!=="todos"){
      const val=selCanc.value==="sim"; const v0=_sample?.[schema.cancelado];
      if(typeof v0==="boolean") q=q.eq(schema.cancelado,val);
      else if(v0===0||v0===1) q=q.eq(schema.cancelado,val?1:0);
      else q=q.in(schema.cancelado,val?["Sim","sim","S","1","true","TRUE"]:["Não","Nao","não","nao","N","0","false","FALSE"]);
    }
    if(schema.loja && !schema.lojaUnsafe){ const lojas=getSelectedLojas(); if(lojas.length>0) q=q.in(schema.loja,lojas); }
    return q;
  }
  async function fetchPaged(startISO,endISO,unidade){
    let page=1000,off=0,out=[];
    for(;;){
      let q=supa.from(TABLE).select(buildSelect()).gte("dia",startISO).lte("dia",endISO).order("dia",{ascending:true}).range(off,off+page-1);
      if(unidade && unidade!=="Todas") q=q.eq("unidade",unidade);
      q=applyServerFilters(q);
      const r=await q; if(r.error) throw r.error;
      const a=r.data||[]; out=out.concat(a);
      if(a.length<page) break; off+=page; if(off>500000){ log("[Warn] abort paginado."); break; }
    }
    return out;
  }

  // ===== Schema detection
  function normKey(s){return String(s).toLowerCase().replace(/[\s_\-]/g,"");}
  function pickByAliases(obj,aliases){
    const keys=Object.keys(obj||{});
    for(const k of keys){ if(aliases.includes(k)) return k; }
    const want=aliases.map(normKey);
    for(const k of keys){ if(want.includes(normKey(k))) return k; }
    return null;
  }
  async function inspectSchema(unidade){
    let q=supa.from(TABLE).select("*").limit(1); if(unidade && unidade!=="Todas") q=q.eq("unidade",unidade);
    const r=await q; if(r.error){ log("[Schema] falhou: "+r.error.message); return; }
    const row=(r.data&&r.data[0])?r.data[0]:{}; _sample=row;

    // override salvo?
    const saved = localStorage.getItem(LOJA_OVERRIDE_KEY);
    schema.loja = saved || null;

    // auto-detecção se não houver override
    if(!schema.loja || !(schema.loja in row)){
      schema.loja = pickByAliases(row,["Nome da Loja","nome da loja","nome_loja","nomeDaLoja","loja","loja_nome","estabelecimento","ponto_venda","pdv","store","store_name","fantasia","nome_fantasia"]);
    }

    schema.turno    = pickByAliases(row,["turno","periodo_turno","shift"]);
    schema.canal    = pickByAliases(row,["canal_venda","canal","origem","origem_pedido"]);
    schema.pagamento= pickByAliases(row,["pagamento","forma_pagamento","meio_pagamento","metodo_pagamento"]);
    schema.cancelado= pickByAliases(row,["cancelado","is_cancelado","cancel"]);
    schema.hora     = pickByAliases(row,["hora","hr","hora_pedido","hour","hora_venda","pedido_hora"]);

    schema.lojaUnsafe = !!(schema.loja && /[^A-Za-z0-9_]/.test(schema.loja));
    segLoja.style.display = schema.loja ? "" : "none";
    document.getElementById("hourCard").classList.toggle("hidden", !schema.hora);
    segTurno.classList.toggle("hidden", !schema.turno);
    segCanal.classList.toggle("hidden", !schema.canal);
    segPagto.classList.toggle("hidden", !schema.pagamento);
    segCanc.classList.toggle("hidden", !schema.cancelado);

    const cols=Object.keys(row||{});
    log("[Schema] loja="+(schema.loja||"(não encontrada)")+" | unsafe="+schema.lojaUnsafe);
    log("[Debug] Colunas detectadas: "+cols.join(", "));
    if(!schema.loja){ showCfg(cols); } else { hideCfg(); }
  }

  // ===== Agregações / KPIs / Gráficos
  function mapDOWSelectionToList(){ const v=selDOW.value||"todos"; if(v==="todos") return [0,1,2,3,4,5,6]; if(v==="uteis") return [1,2,3,4,5]; if(v==="fds") return [6,0]; return [Number(v)]; }
  const applyDOWClient=rows=>{const keep={}; mapDOWSelectionToList().forEach(d=>keep[d]=1); return rows.filter(r=> keep[new Date(r.dia+"T00:00:00Z").getUTCDay()]);};
  const applyLojaClient=rows=>{const col=keyLoja(); const sel=[...lojaSelSet]; if(!col||sel.length===0) return rows; return rows.filter(r=> sel.includes(String(r[col]||"")));};

  function badgePctChange(cur,prev){ return (prev>0)?((cur-prev)/prev*100):0; }
  function updateKPIs(rows,rowsAnt,daysCur,daysAnt){
    const ped=sum(rows,"pedidos"), fat=sum(rows,"fat"), des=sum(rows,"des"), fre=sum(rows,"fre");
    const pedA=sum(rowsAnt,"pedidos"), fatA=sum(rowsAnt,"fat"), desA=sum(rowsAnt,"des"), freA=sum(rowsAnt,"fre");
    const taxa=0.12*fat, taxaA=0.12*fatA;
    const fatliq=fat-des-fre-taxa, fatliqA=fatA-desA-freA-taxaA;
    const desPct=fat>0?(des/fat*100):0, desPctA=fatA>0?(desA/fatA*100):0;
    const ticket=ped>0?(fat/ped):0, ticketA=pedA>0?(fatA/pedA):0;
    const freMed=ped>0?(fre/ped):0, freMedA=pedA>0?(freA/pedA):0;
    const fatMed=daysCur>0?(fat/daysCur):0, fatMedA=daysAnt>0?(fatA/daysAnt):0;
    const fatliqPct=fat>0?(fatliq/fat*100):0, fatliqPctA=fatA>0?(fatliqA/fatA*100):0;

    function setK(v,sub,bad,cur,ant,fmt,asPct){
      document.getElementById(v).textContent = asPct? fmtPct(cur): fmt(cur);
      document.getElementById(sub).textContent = "ant: " + (asPct? fmtPct(ant): fmt(ant));
      badge(document.getElementById(bad), badgePctChange(cur,ant));
    }
    setK("k_ped_val","k_ped_sub","k_ped_badge",ped,pedA,fmtInt,false);
    setK("k_ticket_val","k_ticket_sub","k_ticket_badge",ticket,ticketA,fmtBRL,false);
    setK("k_fat_val","k_fat_sub","k_fat_badge",fat,fatA,fmtBRL,false);
    setK("k_fat_med_val","k_fat_med_sub","k_fat_med_badge",fatMed,fatMedA,fmtBRL,false);
    setK("k_fatliq_val","k_fatliq_sub","k_fatliq_badge",fatliq,fatliqA,fmtBRL,false);
    setK("k_fatliq_pct_val","k_fatliq_pct_sub","k_fatliq_pct_badge",fatliqPct,fatliqPctA,fmtPct,true);
    setK("k_des_val","k_des_sub","k_des_badge",des,desA,fmtBRL,false);
    setK("k_des_pct_val","k_des_pct_sub","k_des_pct_badge",desPct,desPctA,fmtPct,true);
    setK("k_fre_val","k_fre_sub","k_fre_badge",fre,freA,fmtBRL,false);
    setK("k_fre_med_val","k_fre_med_sub","k_fre_med_badge",freMed,freMedA,fmtBRL,false);
  }

  function buildDailyTotals(rows,key){const m={}; rows.forEach(r=>{const d=r.dia; m[d]=(m[d]||0)+Number(r[key]||0);}); const days=Object.keys(m).sort(); return {days, totals:days.map(d=>m[d])};}
  const groupDaily=rows=>{const d=buildDailyTotals(rows,"fat"); return {labels:d.days, totals:d.totals};};
  const groupDailyMetric=(rows,key)=>{const d=buildDailyTotals(rows,key); return {labels:d.days, totals:d.totals};}
  function groupDOW(rows){const d=buildDailyTotals(rows,"fat"), t=[0,0,0,0,0,0,0], c=[0,0,0,0,0,0,0]; d.days.forEach((day,i)=>{const dow=new Date(day+"T00:00:00Z").getUTCDay(); t[dow]+=d.totals[i]; c[dow]+=1;}); return {labels:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], totals:t, counts:c};}
  function groupDOWMetric(rows,key){const d=buildDailyTotals(rows,key), t=[0,0,0,0,0,0,0], c=[0,0,0,0,0,0,0]; d.days.forEach((day,i)=>{const dow=new Date(day+"T00:00:00Z").getUTCDay(); t[dow]+=d.totals[i]; c[dow]+=1;}); return {labels:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], totals:t, counts:c};}
  function groupMonth(rows){const d=buildDailyTotals(rows,"fat"), m={}; d.days.forEach((day,i)=>{const k=day.slice(0,7); if(!m[k]) m[k]={t:0,c:0}; m[k].t+=d.totals[i]; m[k].c+=1;}); const labels=Object.keys(m).sort(); return {labels, totals:labels.map(k=>m[k].t), counts:labels.map(k=>m[k].c)};}
  function groupMonthLiq(rows){
    const dFat=buildDailyTotals(rows,"fat"), dDes=buildDailyTotals(rows,"des"), dFre=buildDailyTotals(rows,"fre"), map={};
    dFat.days.forEach((day,i)=>{map[day]={fat:dFat.totals[i],des:0,fre:0};});
    dDes.days.forEach((day,i)=>{if(!map[day]) map[day]={fat:0,des:0,fre:0}; map[day].des=dDes.totals[i];});
    dFre.days.forEach((day,i)=>{if(!map[day]) map[day]={fat:0,des:0,fre:0}; map[day].fre=dFre.totals[i];});
    const m={}; Object.keys(map).sort().forEach(day=>{const v=map[day], taxa=0.12*v.fat, liq=v.fat-v.des-v.fre-taxa; const k=day.slice(0,7); if(!m[k]) m[k]={t:0,c:0}; m[k].t+=liq; m[k].c+=1;});
    const labels=Object.keys(m).sort(); return {labels, totals:labels.map(k=>m[k].t), counts:labels.map(k=>m[k].c)};
  }
  function groupHour(rows){
    if(!schema.hora) return {labels:[], totals:[], counts:[]};
    const byDayHour={}, totals=new Array(24).fill(0), daysByHour=[...Array(24)].map(()=>new Set());
    rows.forEach(r=>{const h=Number(r[schema.hora]); if(isNaN(h)||h<0||h>23) return; const key=r.dia+"|"+h; byDayHour[key]=(byDayHour[key]||0)+Number(r.fat||0);});
    Object.keys(byDayHour).forEach(k=>{const [d,h]=k.split("|"); const hh=Number(h); totals[hh]+=byDayHour[k]; daysByHour[hh].add(d);});
    const counts=daysByHour.map(s=>s.size), labels=totals.map((_,i)=>String(i).padStart(2,"0")+":00");
    const totalDays=new Set(Object.keys(byDayHour).map(k=>k.split("|")[0])).size||1;
    const keep=totals.map((_,i)=> counts[i]/totalDays>0.5 ); // >50% dos dias ativos ~ >30min
    const fL=[], fT=[], fC=[]; for(let i=0;i<24;i++){ if(keep[i]){ fL.push(labels[i]); fT.push(totals[i]); fC.push(counts[i]); } }
    return {labels:fL, totals:fT, counts:fC};
  }

  function makePrevSeries(curLabels, prevPack, mode){
    if(!prevPack) return null; let prevTotals=prevPack.totals.slice();
    if(mode==="avg" && prevPack.counts) prevTotals=prevTotals.map((v,i)=> prevPack.counts[i]>0? v/prevPack.counts[i]:0);
    return {labels:(prevPack.labels||curLabels), totals:prevTotals, counts:prevPack.counts||null};
  }
  function renderChart(id,type,labels,totals,mode,countsOpt,prevPack){
    const ctx=document.getElementById(id).getContext("2d");
    if(window[id]){ window[id].destroy(); window[id]=null; }
    const vals=(mode==="avg" && countsOpt)? totals.map((v,i)=> countsOpt[i]>0? v/countsOpt[i]:0): totals.slice();
    const datasets=[];
    if(prevPack){
      const prev=makePrevSeries(labels,prevPack,mode);
      if(prev){ datasets.push({type:"line",label:"Período anterior",data:prev.totals,borderColor:"rgba(0,0,0,.35)",backgroundColor:"rgba(0,0,0,.08)",pointRadius:0,tension:.25,fill:true,order:0}); }
    }
    datasets.push({type,label:(mode==="avg"?"Média":"Total"),data:vals,order:1});
    window[id]=new Chart(ctx,{type,data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
  }
  function align(labels,pack){ if(!pack||!pack.labels) return {totals:new Array(labels.length).fill(0), counts:null}; const idx={}; pack.labels.forEach((lb,i)=>idx[lb]=i); const t=labels.map(lb=> pack.totals[idx[lb]] ?? 0); const c=pack.counts? labels.map(lb=> pack.counts[idx[lb]] ?? 0):null; return {totals:t, counts:c}; }
  const days=rows=>[...new Set(rows.map(r=>r.dia))];

  document.querySelectorAll(".segSwitch").forEach(sw=> sw.addEventListener("click",e=>{ if(e.target.tagName!=="BUTTON")return; sw.querySelectorAll("button").forEach(b=>b.classList.remove("active")); e.target.classList.add("active"); drawAll(); }));

  function top10LojasByFat(rows){ const col=keyLoja(); if(!col) return []; const map={}; rows.forEach(r=>{const lj=String(r[col]||"").trim(); if(!lj) return; map[lj]=(map[lj]||0)+Number(r.fat||0);}); return Object.keys(map).map(k=>({k,v:map[k]})).sort((a,b)=>b.v-a.v).slice(0,10).map(x=>x.k); }

  function setDate(el,iso){ el.value=iso||""; if(dataMinISO) el.min=dataMinISO; if(dataMaxISO) el.max=dataMaxISO; }
  function getDate(el){ return el.value? new Date(el.value+"T00:00:00Z") : null; }

  async function recarregar(){
    const my=++runId;
    try{
      if(!dataMaxISO||!dataMinISO){ await refreshBounds(selUni.value||"Todas"); if(!dataMaxISO) return; }
      let ps=getDate(dini), pe=getDate(dfim), s,e;
      if(ps&&pe){ s=ps; e=pe; } else { e=new Date(dataMaxISO+"T00:00:00Z"); s=addDays(e,-29); const min=new Date(dataMinISO+"T00:00:00Z"); if(s<min) s=min; setDate(dini,toISO(s)); setDate(dfim,toISO(e)); }
      const startISO=toISO(s), endISO=toISO(e);

      const len=Math.max(1,Math.round((e-s)/(24*3600*1000))+1), prevEnd=addDays(s,-1), prevStart=addDays(prevEnd,-(len-1));
      elPeriodo.textContent=`Período: ${startISO} → ${endISO} (âncora: ${dataMaxISO})`;
      const uni=selUni.value||"Todas";

      const baseCur=await fetchPaged(startISO,endISO,uni==="Todas"?null:uni); if(my!==runId) return;
      let cur = applyDOWClient(baseCur); cur = applyLojaClient(cur);

      const basePrev=await fetchPaged(toISO(prevStart),toISO(prevEnd),uni==="Todas"?null:uni); if(my!==runId) return;
      let prv = applyDOWClient(basePrev); prv = applyLojaClient(prv);

      if(schema.loja){ const top10=top10LojasByFat(applyDOWClient(baseCur)); renderLojaChips(top10); _lastTop10=top10.slice(); }

      _lastRows=cur; _lastRowsPrev=prv;
      updateKPIs(cur,prv,len,len);
      drawAll(); updateSummaryHint();
    }catch(e){ if(my!==runId) return; console.error(e); log("[ERRO] "+(e.message||String(e))); }
  }
  const recarregarDebounced=debounce(recarregar,120);

  async function refreshFilterOptions(startISO,endISO,unidade){
    const loadDistinct=async (col,sel)=>{ const uniq={}, out=[], page=1000; let off=0; for(;;){ let q=supa.from(TABLE).select(col).gte("dia",startISO).lte("dia",endISO).order(col,{ascending:true}).range(off,off+page-1); if(unidade&&unidade!=="Todas") q=q.eq("unidade",unidade); const r=await q; if(r.error) break; const a=r.data||[]; a.forEach(x=>{const v=x[col]; if(v!=null&&v!=="") uniq[v]=1;}); if(a.length<page) break; off+=page; if(off>200000) break; } const vals=Object.keys(uniq); const prev=sel.value||"todos"; sel.innerHTML=""; const o0=document.createElement("option"); o0.value="todos"; o0.textContent="Todos"; sel.appendChild(o0); vals.forEach(v=>{const o=document.createElement("option"); o.value=String(v); o.textContent=String(v); sel.appendChild(o);}); sel.value=[...sel.options].some(o=>o.value===prev)?prev:"todos"; };
    const ps=dini.value||dataMinISO, pe=dfim.value||dataMaxISO, uni=selUni.value||"Todas";
    if(schema.turno) await loadDistinct(schema.turno,document.getElementById("turno"));
    if(schema.canal) await loadDistinct(schema.canal,document.getElementById("canal"));
    if(schema.pagamento) await loadDistinct(schema.pagamento,document.getElementById("pagto"));
  }

  async function boot(){
    log("[Boot] v17.2-MV-paged-fix3 — loja com assistente, sombra e média correta");
    const opts=await fetchUnidades(); selUni.innerHTML=""; opts.forEach(u=>{const o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o);}); selUni.value="Todas";
    await refreshBounds("Todas"); await inspectSchema("Todas");
    if(dataMaxISO&&dataMinISO){ const e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-29); const min=new Date(dataMinISO+"T00:00:00Z"); setDate(dini,toISO(s<min?min:s)); setDate(dfim,toISO(e)); await refreshFilterOptions(dini.value,dfim.value,selUni.value); }
    updateSummaryHint(); recarregar();
  }

  // eventos
  prapido.onchange=async function(){ if(!prapido.value) return; if(!dataMaxISO||!dataMinISO){ await refreshBounds(selUni.value||"Todas"); if(!dataMaxISO) return; } const d=Number(prapido.value), e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-(d-1)); const min=new Date(dataMinISO+"T00:00:00Z"); setDate(dini,toISO(s<min?min:s)); setDate(dfim,toISO(e)); await refreshFilterOptions(dini.value,dfim.value,selUni.value); touchFilters(); recarregarDebounced(); };
  [dini,dfim].forEach(el=> el.onchange=async ()=>{ prapido.value=""; await refreshFilterOptions(dini.value,dfim.value,selUni.value); touchFilters(); recarregarDebounced(); });
  selUni.onchange=async function(){ await refreshBounds(selUni.value||"Todas"); await inspectSchema(selUni.value||"Todas"); const d=Number(prapido.value||30), e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-(d-1)); const min=new Date(dataMinISO+"T00:00:00Z"); setDate(dini,toISO(s<min?min:s)); setDate(dfim,toISO(e)); await refreshFilterOptions(dini.value,dfim.value,selUni.value); touchFilters(); recarregarDebounced(); };
  [selDOW,selTurno,selCanal,selPagto,selCanc].forEach(el=> el && (el.onchange=()=>{touchFilters(); recarregarDebounced();}));
  document.getElementById("limpar").onclick=async function(){ fltBox.open=true; selUni.value="Todas"; prapido.value="30"; selDOW.value="todos"; if(selTurno) selTurno.value="todos"; if(selCanal) selCanal.value="todos"; if(selPagto) selPagto.value="todos"; if(selCanc) selCanc.value="todos"; lojaSelSet.clear(); await refreshBounds("Todas"); const e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-29); const min=new Date(dataMinISO+"T00:00:00Z"); setDate(dini,toISO(s<min?min:s)); setDate(dfim,toISO(e)); await refreshFilterOptions(dini.value,dfim.value,selUni.value); updateSummaryHint(); recarregarDebounced(); };

  boot();
})();
</script>
</body>
</html>
