<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Uploader de Vendas → Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tenta SheetJS local; se falhar, carrega via CDN -->
  <script src="./xlsx.full.min.js"
          onerror="var s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js'; document.head.appendChild(s);"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin-top: 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #9993; border-radius: 10px; padding: 16px; margin-top: 16px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #9996; cursor: pointer; background: #fafafa; }
    button.primary { background: #2563eb; color: #fff; border-color: #1d4ed8; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    input[type="file"] { padding: 8px; }
    progress { width: 240px; height: 14px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #00000008; padding: 12px; border-radius: 8px; border: 1px dashed #9995; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 13px; }
    .muted { opacity: .8; font-size: 12px; }
    .ok { color: #059669; }
    .warn { color: #ca8a04; }
    .err { color: #dc2626; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <h1>Uploader de Vendas → Supabase</h1>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".xlsx,.xls,.csv" />
      <button id="btn-validate">Validar arquivo</button>
      <button id="btn-upload" class="primary" disabled>Enviar ao banco</button>
      <label class="small">
        Lote:
        <input id="batch" type="number" min="200" step="200" value="2000" style="width:80px" />
      </label>
      <progress id="pg" max="100" value="0"></progress>
      <span id="pg-label" class="small"></span>
    </div>
    <div class="muted small">Suporta colunas: <code>Data e Hora</code> (ou <code>Data da venda</code>), <code>Unidade</code>, <code>Nome da loja</code> (ou <code>Consumidor</code>), <code>Canal de venda</code>, <code>Está cancelado</code>, <code>Itens</code>, <code>Total</code>, <code>Desconto</code>, <code>Entrega</code>, <code>Turno</code>, <code>Pagamento</code>.</div>
  </div>

  <div class="card">
    <strong>Resumo</strong>
    <div id="summary" class="small muted">Nenhum arquivo carregado.</div>
    <div style="margin-top:8px;">
      <table id="preview" style="display:none;">
        <thead><tr id="preview-head"></tr></thead>
        <tbody id="preview-body"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <strong>Debug</strong>
    <pre id="log">Pronto.</pre>
  </div>

  <script>
    /*** CONFIG SUPABASE ***/
    const SUPA_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
    const SUPA_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
    const TABLE     = 'vendas_import_csv_v2';

    const elFile = document.getElementById('file');
    const elValidate = document.getElementById('btn-validate');
    const elUpload = document.getElementById('btn-upload');
    const elSummary = document.getElementById('summary');
    const elPreview = document.getElementById('preview');
    const elPrevHead = document.getElementById('preview-head');
    const elPrevBody = document.getElementById('preview-body');
    const elLog = document.getElementById('log');
    const elPg = document.getElementById('pg');
    const elPgLabel = document.getElementById('pg-label');
    const elBatch = document.getElementById('batch');

    let parsedRows = []; // linhas brutas do XLSX (objetos)
    let mappedRows = []; // linhas mapeadas p/ colunas da tabela

    function log(msg, data) {
      const time = new Date().toISOString().slice(11,19);
      elLog.textContent += `\n[${time}] ${msg}` + (data ? `\n${JSON.stringify(data, null, 2)}` : '');
      elLog.scrollTop = elLog.scrollHeight;
      console.log(msg, data ?? '');
    }

    async function ping() {
      log('Verificando Supabase…');
      try {
        const r = await fetch(`${SUPA_URL}/rest/v1/?select=*`, {
          headers: { apikey: SUPA_ANON, Authorization: `Bearer ${SUPA_ANON}` }
        });
        if (r.ok) log('✅ Supabase client ok');
        else log('❌ Supabase erro', { status: r.status, text: await r.text() });
      } catch (e) {
        log('❌ Supabase erro', { error: String(e) });
      }
    }
    ping();

    /** ---------- PARSE EXCEL ---------- **/
    function readWorkbook(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(reader.error);
        reader.onload = () => {
          try {
            const data = new Uint8Array(reader.result);
            const wb = XLSX.read(data, { type: 'array' });
            const firstSheet = wb.SheetNames[0];
            const ws = wb.Sheets[firstSheet];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: null, raw: false });
            resolve({ sheet: firstSheet, rows });
          } catch (err) { reject(err); }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    /** ---------- HELPERS DE CONVERSÃO ---------- **/
    function parseDateTimeBRorISO(v) {
      if (!v) return null;
      if (v instanceof Date) return v.toISOString();
      const s = String(v).trim();
      if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
        const d = new Date(s);
        return isNaN(d) ? null : d.toISOString();
      }
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
      if (m) {
        const [_, dd, mm, yyyy, HH='00', MM='00', SS='00'] = m;
        const d = new Date(Number(yyyy), Number(mm)-1, Number(dd), Number(HH), Number(MM), Number(SS));
        return isNaN(d) ? null : d.toISOString();
      }
      const d = new Date(s);
      return isNaN(d) ? null : d.toISOString();
    }

    function hourFromISO(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      return isNaN(d) ? null : d.getUTCHours();
    }

    function parseNumberBR(v) {
      if (v === null || v === undefined || v === '') return null;
      if (typeof v === 'number') return v;
      const n = Number(String(v).replace(/\./g,'').replace(',', '.'));
      return isNaN(n) ? null : n;
    }

    function toBool(v) {
      if (typeof v === 'boolean') return v;
      const s = String(v ?? '').trim().toLowerCase();
      if (['sim','true','1','y','yes'].includes(s)) return true;
      if (['não','nao','false','0','n','no',''].includes(s)) return false;
      return false;
    }

    /** ---------- MAPEAMENTO XLS → TABELA ---------- **/
    function mapRowToDb(row) {
      const dt = row['Data e Hora'] ?? row['Data da venda'] ?? row['data_venda'] ?? row['datahora'];
      const iso = parseDateTimeBRorISO(dt);
      return {
        data_venda : iso,                                                 // timestamptz
        hora       : row['Hora'] ?? hourFromISO(iso),                     // int (opcional)
        unidade    : row['Unidade'] ?? row['unidade'] ?? null,            // text
        consumidor : row['Nome da loja'] ?? row['Consumidor'] ?? row['Nome da Loja'] ?? null,
        canal      : row['Canal de venda'] ?? row['canal'] ?? null,
        cancelado  : toBool(row['Está cancelado'] ?? row['cancelado']),
        itens      : (row['Itens'] ?? row['itens'] ?? 1) | 0,
        total      : parseNumberBR(row['Total'] ?? row['total']),
        des        : parseNumberBR(row['Desconto'] ?? row['des']),
        fre        : parseNumberBR(row['Entrega'] ?? row['fre']),
        turno      : row['Turno'] ?? row['turno'] ?? null,
        pagamento  : row['Pagamento'] ?? row['pagamento'] ?? null,
      };
    }

    function showPreview(rows) {
      if (!rows.length) {
        elPreview.style.display = 'none';
        elPrevHead.innerHTML = '';
        elPrevBody.innerHTML = '';
        return;
      }
      const cols = Object.keys(rows[0]);
      elPrevHead.innerHTML = cols.map(c => `<th>${c}</th>`).join('');
      elPrevBody.innerHTML = rows.slice(0, 5).map(r =>
        `<tr>${cols.map(c => `<td>${r[c] ?? ''}</td>`).join('')}</tr>`
      ).join('');
      elPreview.style.display = '';
    }

    function summarize(raw, mapped) {
      const dist = (arr, key) => {
        const s = new Set(arr.map(r => (r[key] ?? '').toString().trim()).filter(Boolean));
        return Array.from(s).sort();
      };
      const unids = dist(raw, 'Unidade');
      const lojas = dist(raw, 'Nome da loja').length ? dist(raw, 'Nome da loja') : dist(raw, 'Consumidor');
      const canais = dist(raw, 'Canal de venda');
      const turnos = dist(raw, 'Turno');
      const pags = dist(raw, 'Pagamento');

      elSummary.innerHTML =
        `Linhas lidas: <b>${raw.length}</b><br>` +
        `• unidade: ${unids.length} distintos ${unids.length? '['+unids.slice(0,8).join(', ')+(unids.length>8?'…]':']'): ''}<br>` +
        `• loja: ${lojas.length} distintos ${lojas.length? '['+lojas.slice(0,8).join(', ')+(lojas.length>8?'…]':']'): ''}<br>` +
        `• canal: ${canais.length} distintos ${canais.length? '['+canais.slice(0,8).join(', ')+(canais.length>8?'…]':']'): ''}<br>` +
        `• turno: ${turnos.length} distintos ${turnos.length? '['+turnos.slice(0,8).join(', ')+(turnos.length>8?'…]':']'): ''}<br>` +
        `• pagamento: ${pags.length} distintos ${pags.length? '['+pags.slice(0,8).join(', ')+(pags.length>8?'…]':']'): ''}<br>` +
        `<span class="muted">* Nomes exibidos são do arquivo, gravaremos normalizado nas colunas da tabela.</span>`;
    }

    /** ---------- INSERT EM LOTES ---------- **/
    async function bulkInsertVendas(rows, batchSize=2000) {
      const url = `${SUPA_URL}/rest/v1/${TABLE}`;
      let ok=0, fail=0;

      for (let i=0; i<rows.length; i+=batchSize) {
        const chunk = rows.slice(i, i+batchSize).map(mapRowToDb);
        // atualiza barra
        elPg.value = Math.round(((i+chunk.length)/rows.length)*100);
        elPgLabel.textContent = `${i+chunk.length}/${rows.length}`;

        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            apikey: SUPA_ANON,
            Authorization: `Bearer ${SUPA_ANON}`,
            'Content-Type': 'application/json',
            Prefer: 'return=minimal'
            // Para upsert por chave única, troque por:
            // Prefer: 'resolution=ignore-duplicates,return=minimal'
          },
          body: JSON.stringify(chunk)
        });

        if (resp.ok) {
          ok += chunk.length;
          log('✅ Lote inserido', {lote:[i, i+chunk.length]});
        } else {
          fail += chunk.length;
          const txt = await resp.text().catch(()=> '');
          log('❌ Erro no lote', {lote:[i, i+chunk.length], status: resp.status, body: txt});
          // Não para, continua os próximos lotes. Se quiser parar:
          // break;
        }
      }
      log('📦 Inserção concluída', {ok, fail});
      alert(`Concluído. OK: ${ok} | Falhas: ${fail}`);
    }

    /** ---------- UI HANDLERS ---------- **/
    elValidate.addEventListener('click', async () => {
      const f = elFile.files?.[0];
      if (!f) { alert('Selecione um arquivo .xlsx/.xls/.csv'); return; }
      elValidate.disabled = true; elUpload.disabled = true;
      elPg.value = 0; elPgLabel.textContent = '';

      try {
        const { sheet, rows } = await readWorkbook(f);
        parsedRows = rows;
        mappedRows = rows.map(mapRowToDb);
        log('📄 Arquivo lido', {nome: f.name, sheet, linhas: rows.length});
        showPreview(rows);
        summarize(rows, mappedRows);

        // checagem rápida de colunas mapeadas (evita PGRST204 por nomes errados)
        const sample = mappedRows[0] || {};
        log('🔧 Amostra mapeada (1ª linha)', sample);

        // teste rápido de tabela acessível:
        const head = await fetch(`${SUPA_URL}/rest/v1/${TABLE}?select=count`, {
          headers: { apikey: SUPA_ANON, Authorization: `Bearer ${SUPA_ANON}` }
        });
        if (!head.ok) {
          log('⚠️ Tabela inacessível', { status: head.status, text: await head.text() });
        } else {
          log('✅ Tabela acessível');
        }

        elUpload.disabled = !rows.length;
      } catch (err) {
        log('❌ Erro lendo arquivo', {erro: String(err)});
        alert('Erro ao ler o arquivo. Ver Console/Debug.');
      } finally {
        elValidate.disabled = false;
      }
    });

    elUpload.addEventListener('click', async () => {
      if (!parsedRows.length) { alert('Valide o arquivo primeiro.'); return; }
      const batchSize = Math.max(200, Number(elBatch.value) || 2000);
      elUpload.disabled = true; elValidate.disabled = true;
      elPg.value = 0; elPgLabel.textContent = '';
      try {
        await bulkInsertVendas(parsedRows, batchSize);
      } finally {
        elUpload.disabled = false; elValidate.disabled = false;
      }
    });
  </script>
</body>
</html>
