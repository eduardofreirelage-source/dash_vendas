<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — v16.1 (vendas_kpi_daily)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg:#f6f7fb; --txt:#0f172a; --muted:#6b7280; --card:#fff; --bd:#e5e7eb; }
      body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--muted);font-size:12px}
      .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
      .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
      .title{font-size:12px;color:var(--muted)}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      select,button,input{border:1px solid var(--bd);border-radius:8px;background:#fff;padding:8px 10px}
      button{cursor:pointer}
      .btns button{padding:6px 8px}
      .charts{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
      canvas{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:8px}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:520px){.grid{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <!-- Chart.js (confiável e sem CORS) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Build v16.1 (fonte: <code>public.vendas_kpi_daily</code>)</div>
          <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <!-- Filtros -->
      <div class="card" style="margin-top:12px">
        <div class="row">
          <div>
            <div class="title">Unidade</div>
            <select id="f_uni">
              <option>Todas</option>
            </select>
          </div>
          <div>
            <div class="title">Período rápido (dias)</div>
            <div class="btns">
              <button data-d="7">7</button>
              <button data-d="15">15</button>
              <button data-d="30">30</button>
              <button data-d="90">90</button>
              <button data-d="180">180</button>
              <button data-d="360">360</button>
            </div>
          </div>
          <div>
            <div class="title">Período entre datas</div>
            <div class="row">
              <input id="d_ini" placeholder="dd/mm/aaaa" size="12" />
              <input id="d_fim" placeholder="dd/mm/aaaa" size="12" />
              <button id="aplicar">Aplicar</button>
            </div>
            <div class="muted">Se preencher as datas, o “período rápido” é ignorado.</div>
          </div>
          <div style="margin-left:auto">
            <div class="title">&nbsp;</div>
            <button id="limpar">Limpar filtros</button>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="muted" id="k_ped_vs">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="muted" id="k_fat_vs">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="muted" id="k_des_vs">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="muted" id="k_fre_vs">—</div></div>
      </div>

      <!-- Gráficos -->
      <div class="charts">
        <canvas id="ch_daily" height="140"></canvas>
        <canvas id="ch_week"  height="140"></canvas>
      </div>

      <!-- Logs -->
      <div class="card" style="margin-top:12px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== CONFIG ======
      const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
      const TABLE         = "vendas_kpi_daily";   // fonte única e rápida
      const PAGE          = 2000;                 // paginação segura (view diária é pequena)
      const V             = "v161";

      // ====== HELPERS UI ======
      const el = (id)=>document.getElementById(id);
      const logEl = el("log");
      const log = (m)=>{ logEl.textContent += "\n" + m; };
      const fmtBRL = (n)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
      const fmtInt = (n)=> new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
      const toISO  = (d)=> d.toISOString().slice(0,10);
      const parseBR = (s)=>{ // dd/mm/aaaa -> yyyy-mm-dd
        if(!s) return null;
        const m = String(s).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if(!m) return null;
        return `${m[3]}-${m[2]}-${m[1]}`;
      };
      function pct(a,b){
        a=Number(a)||0; b=Number(b)||0;
        if(b===0) return 0;
        return (a-b)*100/b;
      }

      // ====== SUPABASE ======
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // ====== ESTADO & CONTROLE DE CONCORRÊNCIA ======
      let state = {
        uni: "Todas",
        days: 30,
        d1: null,
        d2: null,
      };
      let isLoading = false;   // evita rodar go() simultâneo
      let chDaily = null;
      let chWeek  = null;

      // ====== CARGA DE UNIDADES (distinct) ======
      async function loadUnidades(){
        log("[Boot] v16.1 — carregando unidades…");
        const { data, error } = await supa
          .from(TABLE)
          .select("unidade", { distinct:true })
          .not("unidade","is",null)
          .limit(1000);
        if(error){ log("[ERRO] unidades: "+error.message); return; }
        const sel = el("f_uni");
        sel.innerHTML = `<option>Todas</option>`;
        const list = [...new Set((data||[]).map(r=>r.unidade).filter(Boolean))].sort();
        for(const u of list){
          const opt = document.createElement("option");
          opt.textContent = u;
          sel.appendChild(opt);
        }
      }

      // ====== BUSCA PAGINADA (janela + unidade) ======
      async function fetchRange(dIniISO, dFimISO, uni){
        let acc = [];
        let off = 0;
        for(;;){
          let q = supa.from(TABLE)
            .select("dia,unidade,pedidos,fat,des,fre")
            .gte("dia", dIniISO)
            .lte("dia", dFimISO)
            .range(off, off+PAGE-1);
          if(uni && uni!=="Todas") q = q.eq("unidade", uni);
          const { data, error } = await q;
          if(error) throw error;
          const rows = data||[];
          acc = acc.concat(rows);
          if(rows.length < PAGE) break;
          off += PAGE;
        }
        return acc;
      }

      // ====== KPI + GRÁFICOS (com limpeza/replace) ======
      function updateKpis(cur, prev){
        const pedC = cur.reduce((s,r)=>s+(Number(r.pedidos)||0),0);
        const fatC = cur.reduce((s,r)=>s+(Number(r.fat)||0),0);
        const desC = cur.reduce((s,r)=>s+(Number(r.des)||0),0);
        const freC = cur.reduce((s,r)=>s+(Number(r.fre)||0),0);

        const pedP = prev.reduce((s,r)=>s+(Number(r.pedidos)||0),0);
        const fatP = prev.reduce((s,r)=>s+(Number(r.fat)||0),0);
        const desP = prev.reduce((s,r)=>s+(Number(r.des)||0),0);
        const freP = prev.reduce((s,r)=>s+(Number(r.fre)||0),0);

        el("k_ped").textContent = fmtInt(pedC);
        el("k_fat").textContent = fmtBRL(fatC);
        el("k_des").textContent = fmtBRL(desC);
        el("k_fre").textContent = fmtBRL(freC);

        el("k_ped_vs").textContent = (pct(pedC,pedP)>=0?"+":"") + pct(pedC,pedP).toFixed(1)+"% vs ant.";
        el("k_fat_vs").textContent = (pct(fatC,fatP)>=0?"+":"") + pct(fatC,fatP).toFixed(1)+"% vs ant.";
        el("k_des_vs").textContent = (pct(desC,desP)>=0?"+":"") + pct(desC,desP).toFixed(1)+"% vs ant.";
        el("k_fre_vs").textContent = (pct(freC,freP)>=0?"+":"") + pct(freC,freP).toFixed(1)+"% vs ant.";
      }

      function drawCharts(cur){
        // DESTROI gráficos antigos (evita “gráfico infinito”)
        if(chDaily){ chDaily.destroy(); chDaily = null; }
        if(chWeek){  chWeek.destroy();  chWeek  = null; }

        // Série diária
        const byDay = [...cur]
          .sort((a,b)=>a.dia.localeCompare(b.dia))
          .map(r=>({ x:r.dia, y:Number(r.fat)||0 }));

        const ctx1 = el("ch_daily").getContext("2d");
        chDaily = new Chart(ctx1, {
          type: "line",
          data: {
            labels: byDay.map(r=>r.x),
            datasets: [{ label:"Receita diária (R$)", data: byDay.map(r=>r.y) }]
          },
          options: {
            responsive:true,
            animation:false,
            plugins:{ legend:{ display:true } },
            scales:{ x:{ ticks:{ maxRotation:0 } }, y:{ beginAtZero:true } }
          }
        });

        // Totais por dia da semana
        const wmap = { 0:"Dom",1:"Seg",2:"Ter",3:"Qua",4:"Qui",5:"Sex",6:"Sáb" };
        const sums = { 0:0,1:0,2:0,3:0,4:0,5:0,6:0 };
        for(const r of cur){
          const d = new Date(r.dia+"T00:00:00");
          const w = d.getDay();
          sums[w] += Number(r.fat)||0;
        }
        const labels = [0,1,2,3,4,5,6].map(i=>wmap[i]);
        const vals   = [0,1,2,3,4,5,6].map(i=>sums[i]);

        const ctx2 = el("ch_week").getContext("2d");
        chWeek = new Chart(ctx2, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label:"Totais por dia da semana (R$)", data: vals }]
          },
          options: {
            responsive:true,
            animation:false,
            plugins:{ legend:{ display:true } },
            scales:{ y:{ beginAtZero:true } }
          }
        });
      }

      // ====== FLUXO PRINCIPAL ======
      async function go(){
        if(isLoading) return;     // evita chamadas paralelas
        isLoading = true;

        try{
          // Define janela
          let end = new Date();
          let start;
          if(state.d1 && state.d2){
            const a = parseBR(state.d1), b = parseBR(state.d2);
            if(!a || !b) throw new Error("Data inválida. Use dd/mm/aaaa.");
            start = new Date(a+"T00:00:00");
            end   = new Date(b+"T23:59:59");
          }else{
            end.setDate(end.getDate()-1);               // evita “hoje” parcial
            start = new Date(end); start.setDate(end.getDate()-(state.days-1));
          }
          const d1 = toISO(start), d2 = toISO(end);
          el("periodo").textContent = `Período: ${d1} → ${d2}`;

          // Período anterior (mesma duração)
          const days = Math.round((end - start)/86400000)+1;
          const p2 = new Date(start); p2.setDate(p2.getDate()-1);
          const p1 = new Date(p2);    p1.setDate(p2.getDate()-(days-1));
          const a1 = toISO(p1), a2 = toISO(p2);

          const uni = state.uni;

          log(`[Query] ${TABLE} | ${d1} → ${d2} | UNI=${uni}`);
          const cur = await fetchRange(d1, d2, uni);

          log(`[Query] anterior: ${a1} → ${a2} | UNI=${uni}`);
          const prev = await fetchRange(a1, a2, uni);

          updateKpis(cur, prev);
          drawCharts(cur);
          log("[OK] KPIs e gráficos atualizados.");
        }catch(e){
          console.error(e);
          log("[ERRO] "+(e.message||String(e)));
        }finally{
          isLoading = false;
        }
      }

      // ====== EVENTOS ======
      el("f_uni").addEventListener("change", ()=>{ state.uni = el("f_uni").value; go(); });
      document.querySelectorAll(".btns button").forEach(b=>{
        b.addEventListener("click", ()=>{
          state.days = Number(b.dataset.d)||30;
          state.d1 = state.d2 = null;
          el("d_ini").value = ""; el("d_fim").value="";
          go();
        });
      });
      el("aplicar").addEventListener("click", ()=>{
        state.d1 = el("d_ini").value;
        state.d2 = el("d_fim").value;
        go();
      });
      el("limpar").addEventListener("click", ()=>{
        state = { uni:"Todas", days:30, d1:null, d2:null };
        el("f_uni").value = "Todas";
        el("d_ini").value = ""; el("d_fim").value="";
        go();
      });

      // ====== BOOT ======
      (async function boot(){
        log("[Boot] v16.1 — sem regressão (limpa charts, sem duplicar listeners)");
        await loadUnidades();
        // defaults
        state.days = 30;
        await go();
      })();
    </script>
  </body>
</html>
