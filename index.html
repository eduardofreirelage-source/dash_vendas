<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v13.4 (vendas_kpi)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--b:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px} .muted{color:var(--muted);font-size:12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
    .ctrl{background:var(--card);border:1px solid var(--b);border-radius:10px;padding:10px}
    select,button{font:inherit;padding:8px 10px;border:1px solid var(--b);border-radius:8px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px}
    .title{font-size:12px;color:var(--muted)} .big{font-size:22px;font-weight:700;margin-top:4px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    canvas{width:100%;height:260px;display:block}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;white-space:pre-wrap;overflow:auto}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard Vendas — Supabase</h1>
    <div class="muted">Build v13.4 • fonte fixa: <b>public.vendas_kpi</b></div>

    <div class="controls">
      <div class="ctrl">
        <div class="title">Período</div>
        <select id="selPeriod">
          <option value="30">Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="180">Últimos 180 dias</option>
          <option value="365" selected>Últimos 365 dias</option>
        </select>
      </div>
      <div class="ctrl">
        <div class="title">UNIDADE</div>
        <select id="selUnit">
          <option value="__ALL__">Todas</option>
        </select>
      </div>
      <div class="ctrl">
        <div class="title">Ações</div>
        <div class="row">
          <button id="btnReload">Recarregar</button>
          <span class="muted" id="periodo">Período: —</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div class="title">Pedidos</div><div class="big" id="k_ped">…</div><div class="muted" id="k_ped_trend">+0,0% vs ant.</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="big" id="k_fat">…</div><div class="muted" id="k_fat_trend">+0,0% vs ant.</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="big" id="k_des">…</div><div class="muted" id="k_des_trend">+0,0% vs ant.</div></div>
      <div class="card"><div class="title">Frete</div><div class="big" id="k_fre">…</div><div class="muted" id="k_fre_trend">+0,0% vs ant.</div></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Receita diária (R$)</div>
      <canvas id="chartFat"></canvas>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
/** ====== CREDENCIAIS (as mesmas que você passou) ====== */
const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

/** ====== FONTE FIXA ====== */
const TABLE = "vendas_kpi";              // <<—— usamos SEMPRE esta view
const COLS  = "data_venda, unidade, valor_total, desconto, entrega";

const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** ====== UI helpers ====== */
const elLog = document.getElementById("log");
const elPeriod = document.getElementById("periodo");
const selPeriod = document.getElementById("selPeriod");
const selUnit = document.getElementById("selUnit");
const btnReload = document.getElementById("btnReload");

function log(s){ elLog.textContent += "\n" + s; elLog.scrollTop = elLog.scrollHeight; }
function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
function toNum(x){
  if (x==null || x==="") return 0;
  if (typeof x === "number") return x;
  const t = String(x).replace(/\./g,"").replace(/,/g,".");
  const n = Number(t);
  return isFinite(n) ? n : 0;
}
function toISO(d){ return d.toISOString().slice(0,10); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

/** ====== Paginação segura ====== */
async function fetchRows(table, fromISO, toISO, unidade){
  const page = 2000;
  let off = 0, acc = [];
  for(;;){
    let q = supa.from(table).select(COLS)
      .gte("data_venda", fromISO)
      .lte("data_venda", toISO);
    if (unidade && unidade !== "__ALL__") q = q.eq("unidade", unidade);
    q = q.range(off, off + page - 1);
    const r = await q;
    if (r.error){ throw r.error; }
    const rows = r.data || [];
    acc = acc.concat(rows);
    if (rows.length < page) break;
    off += page;
  }
  return acc;
}

/** ====== KPIs + tendências ====== */
async function loadAll(){
  try{
    const days = Number(selPeriod.value);
    const unit = selUnit.value;
    log(`[Boot] v13.4 — fonte fixa ${TABLE} • paginação 2k`);
    const end = addDays(new Date(), -1);
    const start = addDays(end, -(days-1));
    const prevEnd = addDays(start, -1);
    const prevStart = addDays(prevEnd, -(days-1));
    elPeriod.textContent = `Período: ${toISO(start)} → ${toISO(end)}`;

    // atual
    log(`[Query] ${TABLE} | janela ${days}d ${toISO(start)} → ${toISO(end)} | UNIDADE=${unit==="__ALL__"?"Todas":unit}`);
    const cur = await fetchRows(TABLE, toISO(start), toISO(end), unit);

    // popular unidades (a partir do período atual)
    if (selUnit.options.length <= 1){
      const set = new Set(cur.map(r => r.unidade).filter(Boolean));
      [...set].sort().forEach(u => {
        const opt = document.createElement("option");
        opt.value = u; opt.textContent = u;
        selUnit.appendChild(opt);
      });
    }

    // anterior
    const prev = await fetchRows(TABLE, toISO(prevStart), toISO(prevEnd), unit);

    // somatórios
    const sum = rows => rows.reduce((a,r)=>({
      ped: a.ped+1,
      fat: a.fat+toNum(r.valor_total),
      des: a.des+toNum(r.desconto),
      fre: a.fre+toNum(r.entrega)
    }),{ped:0,fat:0,des:0,fre:0});

    const A = sum(cur), B = sum(prev);
    const pct = (x,y)=> y>0 ? ((x-y)/y*100) : 0;

    // KPIs
    document.getElementById("k_ped").textContent = fmtInt(A.ped);
    document.getElementById("k_fat").textContent = fmtBRL(A.fat);
    document.getElementById("k_des").textContent = fmtBRL(A.des);
    document.getElementById("k_fre").textContent = fmtBRL(A.fre);

    document.getElementById("k_ped_trend").textContent = `${pct(A.ped,B.ped).toFixed(1)}% vs ant.`;
    document.getElementById("k_fat_trend").textContent = `${pct(A.fat,B.fat).toFixed(1)}% vs ant.`;
    document.getElementById("k_des_trend").textContent = `${pct(A.des,B.des).toFixed(1)}% vs ant.`;
    document.getElementById("k_fre_trend").textContent = `${pct(A.fre,B.fre).toFixed(1)}% vs ant.`;

    // gráfico simples (sem libs externas)
    drawLine(cur);

    log(`[OK] Linhas (atual): ${cur.length.toLocaleString("pt-BR")} • KPIs atualizados.`);
  }catch(e){
    log(`[ERRO] ${e.message||String(e)}`);
    console.error(e);
  }
}

/** ====== Gráfico minimalista em canvas ====== */
function drawLine(rows){
  const c = document.getElementById("chartFat");
  const g = c.getContext("2d");
  const W = c.width = c.clientWidth;
  const H = c.height = c.clientHeight;
  g.clearRect(0,0,W,H);

  if(!rows.length){ return; }

  // agrega por data (soma do valor_total)
  const map = new Map();
  for(const r of rows){
    const d = String(r.data_venda).slice(0,10);
    map.set(d, (map.get(d)||0) + toNum(r.valor_total));
  }
  const pts = [...map.entries()].sort((a,b)=>a[0]<b[0]?-1:1);

  const xs = pts.map((_,i)=>i);
  const ys = pts.map(p=>p[1]);
  const max = Math.max(...ys), min = Math.min(...ys);

  const pad = 20;
  const X = i => pad + (W-2*pad) * (i/(xs.length-1 || 1));
  const Y = v => H - pad - (H-2*pad) * ((v-min)/((max-min)||1));

  g.lineWidth = 2;
  g.strokeStyle = "#3b82f6";
  g.beginPath();
  g.moveTo(X(xs[0]), Y(ys[0]));
  for(let i=1;i<xs.length;i++){
    g.lineTo(X(xs[i]), Y(ys[i]));
  }
  g.stroke();
}

/** ====== Eventos ====== */
btnReload.onclick = loadAll;
selPeriod.onchange = loadAll;
selUnit.onchange = loadAll;

/** ====== Start ====== */
(async function(){ await loadAll(); })();
</script>
</body>
</html>
