<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — Filtros (v2.3.1 CFO — Light — Etapa 1)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%233b82f6"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --blue:#2563eb; --blue-100:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,0.04);margin-top:12px}
  .badge{display:inline-block;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px;color:#334155}
  .btn-link{color:#475569;text-decoration:underline;cursor:pointer;font-size:13px}
  .label{font-size:12px;color:#475569;margin-bottom:6px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid var(--line);color:#334155;font-size:12px}
  .status{font-size:13px;color:var(--muted)}
  pre{white-space:pre-wrap;background:#f8fafc;color:#111827;border-radius:10px;padding:12px;overflow:auto;border:1px solid var(--line);max-height:360px}

  /* ===== Multiselect (dropdown com checkboxes) ===== */
  .msel{position:relative}
  .msel-btn{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;text-align:left;cursor:pointer}
  .msel-btn:after{content:"▾";float:right;color:#334155}
  .msel-panel{position:absolute;z-index:50;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:8px}
  .msel-opt:hover{background:#f1f5f9}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Dashboard Vendas — Filtros <span class="badge">v2.3.1 CFO — Light — Etapa 1</span></h1>
      <div class="muted">Filtros automáticos, ordem solicitada e período rápido ancorado no último dia do banco.</div>
    </div>
    <div><a id="btnClear" class="btn-link">Limpar filtros</a></div>
  </header>

  <!-- ===== FILTROS (Etapa 1) ===== -->
  <div class="card">
    <!-- Linha 1: Unidade • Loja • Turno -->
    <div class="row cols-3">
      <div>
        <label class="label">Unidade(s)</label>
        <div id="ms-unidades" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Loja(s)</label>
        <div id="ms-lojas" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Turno(s)</label>
        <div id="ms-turnos" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
    </div>

    <!-- Linha 2: Período De/Até • Período Rápido -->
    <div class="row cols-4" style="margin-top:12px;">
      <div>
        <label class="label">Período (De)</label>
        <input id="fDe" type="date" style="width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827"/>
      </div>
      <div>
        <label class="label">Período (Até)</label>
        <input id="fAte" type="date" style="width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827"/>
      </div>
      <div>
        <label class="label">Período Rápido</label>
        <select id="periodo" class="msel-btn" style="border:1px solid var(--line);border-radius:10px;background:#fff;">
          <option value="7">Últimos 7 dias</option>
          <option value="15">Últimos 15 dias</option>
          <option value="30" selected>Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="120">Últimos 120 dias</option>
          <option value="semana">Última semana</option>
          <option value="mes">Último mês (calendário)</option>
          <option value="custom">Personalizado (usar datas)</option>
        </select>
        <div class="muted" id="periodoTexto" style="margin-top:4px;font-size:12px;">—</div>
      </div>
      <div style="display:flex;align-items:end;justify-content:flex-end;">
        <span id="status" class="status">—</span>
      </div>
    </div>

    <!-- Linha 3: Canal • Pagamento • Cancelado -->
    <div class="row cols-3" style="margin-top:12px;">
      <div>
        <label class="label">Canal(is)</label>
        <div id="ms-canais" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Pagamento(s)</label>
        <div id="ms-pags" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Cancelado</label>
        <div id="ms-cancel" class="msel">
          <button type="button" class="msel-btn">Não</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""  id="c_all"><label for="c_all">Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="Não" id="c_nao" checked><label for="c_nao">Não</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim" id="c_sim"><label for="c_sim">Sim</label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Saída de depuração leve (apenas para confirmar filtros na Etapa 1) -->
  <div class="card">
    <b>Resumo dos filtros aplicados</b>
    <pre id="out">(vazio)</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script>
/* ====== CONFIG ====== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);

/* ====== UTIL ====== */
function dateToISO(d){ return d.toISOString().slice(0,10); }
function addDays(iso, n){ const d = new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return dateToISO(d); }
function setStatus(t,cls){const el=$('status'); el.textContent=t; el.style.color = cls==='err'?'#dc2626':(cls==='ok'?'#16a34a':'#6b7280');}

/* ====== Multiselect (dropdown com checkboxes) ====== */
function MultiSelect(rootId, placeholder='Selecionar'){
  const root = $(rootId);
  const btn  = root.querySelector('.msel-btn');
  const panel= root.querySelector('.msel-panel');
  let options = [], selected = new Set(), filtered = [];

  function renderList(){
    panel.innerHTML = '';
    const inp = document.createElement('input'); inp.className='msel-search'; inp.placeholder='Filtrar…';
    inp.addEventListener('input', ()=>{ filtered = options.filter(v=>v.toLowerCase().includes(inp.value.toLowerCase())); draw(); });
    panel.appendChild(inp);
    draw();
  }
  function draw(){
    const list = document.createElement('div');
    (filtered.length?filtered:options).forEach((v,i)=>{
      const id = `${rootId}-${i}`;
      const row = document.createElement('div'); row.className='msel-opt';
      const cb  = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v; cb.checked=selected.has(v);
      const lb  = document.createElement('label'); lb.htmlFor=id; lb.textContent=v;
      cb.addEventListener('change', ()=>{ cb.checked?selected.add(v):selected.delete(v); refreshBtn(); applyFilters(); });
      row.appendChild(cb); row.appendChild(lb); list.appendChild(row);
    });
    const nodes = Array.from(panel.querySelectorAll('.msel-opt')); nodes.forEach(n=>n.remove());
    panel.appendChild(list);
  }
  function refreshBtn(){
    if(selected.size===0) btn.textContent = placeholder;
    else if(selected.size===options.length) btn.textContent = `Todos (${selected.size})`;
    else btn.textContent = `${selected.size} selecionado(s)`;
  }
  btn.addEventListener('click', ()=>{ root.classList.toggle('open'); });
  document.addEventListener('click', (ev)=>{ if(!root.contains(ev.target)) root.classList.remove('open'); });

  return {
    setOptions(list, preselected){
      options = (list||[]).filter(Boolean); filtered = options.slice();
      selected = new Set(preselected||[]);
      renderList(); refreshBtn();
    },
    get(){ return Array.from(selected); },
    set(vals){ selected = new Set(vals||[]); refreshBtn(); draw(); }
  };
}

/* ====== ESTADO/FILTROS ====== */
const ms = {
  unidades: MultiSelect('ms-unidades','Todas as unidades'),
  lojas:    MultiSelect('ms-lojas','Todas as lojas'),
  turnos:   MultiSelect('ms-turnos','Todos os turnos'),
  canais:   MultiSelect('ms-canais','Todos os canais'),
  pags:     MultiSelect('ms-pags','Todos os pagamentos'),
  cancel:   MultiSelect('ms-cancel','Todos'),
};
let firstDay='', lastDay='';

function buildParams(dini, dfim){
  // Cancelado: se incluir '', significa “Todos” → envia NULL (não filtra)
  const canc = ms.cancel.get();
  const p_cancelado = canc.includes('') ? null : (canc.length ? canc : null);

  return {
    p_dini: dini, p_dfim: dfim,
    p_unids: ms.unidades.get().length ? ms.unidades.get() : null,
    p_lojas: ms.lojas.get().length    ? ms.lojas.get()    : null,
    p_turnos:ms.turnos.get().length   ? ms.turnos.get()   : null,
    p_canais:ms.canais.get().length   ? ms.canais.get()   : null,
    p_pags:  ms.pags.get().length     ? ms.pags.get()     : null,
    p_cancelado
  };
}

/* ====== PERÍODO ====== */
const fDe = $('fDe'), fAte = $('fAte'), periodo = $('periodo'), periodoTexto=$('periodoTexto');
function rangeFromQuick(){
  const mode = periodo.value;
  const max = lastDay || dateToISO(new Date());
  let de=max, ate=max;
  if(['7','15','30','60','90','120'].includes(mode)){
    de = addDays(max, -(Number(mode)-1));
  }else if(mode==='semana'){
    const d=new Date(max+'T00:00:00'); const dow=(d.getDay()+6)%7; // segunda-anchored
    de = addDays(max, -dow); ate = max;
  }else if(mode==='mes'){
    const d=new Date(max+'T00:00:00'); d.setDate(1); de=dateToISO(d); d.setMonth(d.getMonth()+1); d.setDate(0); ate=dateToISO(d);
  }else if(mode==='custom'){
    // nada, datas manuais
    return null;
  }
  return {de, ate};
}
function labelPeriodo(de,ate){
  periodoTexto.textContent = `Período: ${de} → ${ate} (âncora no último dia do banco: ${lastDay||'—'})`;
}

/* Exclusividade:
   - Se usuário editar De/Até manualmente → periodo = 'custom' e desabilita quick? (apenas semântico; manteremos quick ativo, mas setado em custom)
   - Se usuário escolher Período Rápido → preenche De/Até e os desabilita visualmente.
*/
function activateCustomDates(){
  periodo.value='custom';
  fDe.disabled=false; fAte.disabled=false;
}
function applyQuick(){
  const r = rangeFromQuick();
  if(!r){ // custom
    fDe.disabled=false; fAte.disabled=false;
    if(!fDe.value) fDe.value = lastDay||dateToISO(new Date());
    if(!fAte.value) fAte.value = lastDay||dateToISO(new Date());
    labelPeriodo(fDe.value, fAte.value);
    applyFilters();
    return;
  }
  fDe.value = r.de; fAte.value = r.ate;
  fDe.disabled=true; fAte.disabled=true;
  labelPeriodo(r.de, r.ate);
  applyFilters();
}

/* ====== LOAD OPTIONS ====== */
async function loadOptions(){
  setStatus('Carregando opções…');
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro vw_vendas_daterange: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }

  const [u,l,t,c,p] = await Promise.all([
    supa.from('vw_vendas_unidades').select('unidade').order('unidade'),
    supa.from('vw_vendas_lojas').select('loja').order('loja'),
    supa.from('vw_vendas_turnos').select('turno').order('turno'),
    supa.from('vw_vendas_canais').select('canal').order('canal'),
    supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
  ]);

  if(u.error||l.error||t.error||c.error||p.error){
    console.warn(u.error||l.error||t.error||c.error||p.error);
    setStatus('Algumas opções não carregaram.','warn');
  } else {
    setStatus('Opções carregadas.','ok');
  }

  ms.unidades.setOptions((u.data||[]).map(r=>r.unidade));
  ms.lojas.setOptions((l.data||[]).map(r=>r.loja));
  ms.turnos.setOptions((t.data||[]).map(r=>r.turno));
  ms.canais.setOptions((c.data||[]).map(r=>r.canal));
  ms.pags.setOptions((p.data||[]).map(r=>r.pagamento_base));
  ms.cancel.setOptions(['','Não','Sim'], ['Não']); // default "Não"

  // aplica período rápido inicial (30d)
  periodo.value='30';
  applyQuick();
}

/* ====== APLICA (Etapa 1: somente exibe os filtros atuais) ====== */
async function applyFilters(){
  try{
    const de = fDe.value || firstDay; const ate = fAte.value || lastDay;
    const params = buildParams(de, ate);
    $('out').textContent = JSON.stringify({
      periodo:{de,ate,mode:periodo.value},
      filtros:{
        unidades: params.p_unids, lojas: params.p_lojas, turnos: params.p_turnos,
        canais: params.p_canais, pagamentos: params.p_pags, cancelado: params.p_cancelado
      }
    }, null, 2);
    // (Etapa 1 não consulta KPIs nem gráficos; isso virá na Etapa 2/3)
  }catch(e){
    console.error(e);
    setStatus('Erro ao aplicar filtros: '+(e.message||e),'err');
  }
}

/* ====== LIMPAR ====== */
$('btnClear').addEventListener('click', ()=>{
  ms.unidades.set([]); ms.lojas.set([]); ms.turnos.set([]);
  ms.canais.set([]); ms.pags.set([]);
  ms.cancel.set(['Não']); // volta para "Não"
  periodo.value='30'; applyQuick(); // repõe 30d e refaz
});

/* ====== EVENTS ====== */
['change'].forEach(ev=>{
  periodo.addEventListener(ev, applyQuick);
});
fDe.addEventListener('change', ()=>{ activateCustomDates(); labelPeriodo(fDe.value,fAte.value); applyFilters(); });
fAte.addEventListener('change', ()=>{ activateCustomDates(); labelPeriodo(fDe.value,fAte.value); applyFilters(); });

/* ====== BOOT ====== */
loadOptions();
</script>
</body>
</html>
