<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="%232563eb"/></svg>'/>
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}.toolbar{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}.muted{color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid{display:grid;gap:12px}.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:940px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.grid.cols-4,.grid.cols-2{grid-template-columns:1fr}}
    .kpi .title{font-size:12px;color:var(--muted)}.kpi .val{font-size:22px;font-weight:700;margin-top:4px}.delta{font-size:12px}
    select,button,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}input[type=date]{padding:7px 10px}button{cursor:pointer}
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;display:flex;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    .seg{display:flex;gap:6px;align-items:center}.seg .lbl{font-size:12px;color:var(--muted)}.seg .grow{width:100%}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}.pill button{border:0;padding:6px 10px}.pill button.active{background:var(--accent);color:#fff}
    .chartbox{position:relative;height:300px;width:100%}.status{font-size:12px;color:var(--muted);margin-left:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div><h1>Maestro Food</h1><div class="muted" id="periodo">Período: —</div></div>
    <div class="muted"><span id="who">—</span> <button id="btnLogout">Sair</button></div>
  </div>

  <details class="filterbox" id="fx" open>
    <summary>FILTROS <span class="muted" id="limpar" title="Limpar">Limpar</span></summary>
    <div class="body">
      <div class="filters-grid">
        <div class="col-6 seg"><span class="lbl">Unidade</span><select id="uni" class="grow"></select></div>
        <div class="col-6 seg"><span class="lbl">Nome da loja (Top 10)</span><select id="lojas" class="grow" multiple size="4"></select></div>
        <div class="col-3 seg"><span class="lbl">De</span><input type="date" id="dini" class="grow"/></div>
        <div class="col-3 seg"><span class="lbl">Até</span><input type="date" id="dfim" class="grow"/></div>
        <div class="col-3 seg"><span class="lbl">Período rápido</span>
          <select id="pr" class="grow"><option value="7">Últimos 7</option><option value="15">Últimos 15</option><option value="30" selected>Últimos 30</option><option value="90">Últimos 90</option></select>
        </div>
        <div class="col-3 seg"><span class="lbl">Turno</span><select id="turno" class="grow" multiple size="4"><option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option></select></div>
        <div class="col-4 seg"><span class="lbl">Canal de venda</span><select id="canal" class="grow" multiple size="4"></select></div>
        <div class="col-4 seg"><span class="lbl">Pagamento</span><select id="pag" class="grow" multiple size="4"></select></div>
        <div class="col-4 seg"><span class="lbl">Está cancelado?</span>
          <select id="canc" class="grow"><option value="Todos" selected>Todos</option><option value="Não">Não</option><option value="Sim">Sim</option></select>
        </div>
      </div>

      <div class="card" style="margin-top:10px;border-style:dashed">
        <b>Admin — Importar CSV (Pasta2.csv)</b>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
          <input type="file" id="csvfile" accept=".csv"/>
          <button id="btnImport">Importar CSV</button>
          <span class="status" id="impStatus"></span>
        </div>
        <div class="muted" style="margin-top:6px">Limpo apenas o intervalo de datas do arquivo, insiro deduplicando por chave composta (dia+unidade+loja+hora+pagamento+canal).</div>
      </div>
    </div>
  </details>

  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped"></div></div>
    <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm"></div></div>
    <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat"></div></div>
    <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd"></div></div>
  </div>
  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des"></div></div>
    <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp"></div></div>
    <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre"></div></div>
    <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem"></div></div>
  </div>
  <div class="grid cols-2" style="margin-top:12px">
    <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl"></div></div>
    <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp"></div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="title">Receita diária</div>
      <div class="pill" id="lineModePill"><button data-val="total" class="active">Total</button><button data-val="media">Média (7d)</button></div>
    </div>
    <div class="chartbox"><canvas id="cLine"></canvas></div>
  </div>
</div>

<script>
(function(){
  // ====== CONFIG ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const VIEW  = "vendas_kpi_daily_v2";
  const STAGE = "vendas_kpi_daily_v2_data";
  const FIELDS = 'dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{persistSession:true} });

  // ====== DOM ======
  const who=document.getElementById("who"), btnLogout=document.getElementById("btnLogout");
  const uni=document.getElementById("uni"), lojas=document.getElementById("lojas");
  const dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  const turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  const periodoTxt=document.getElementById("periodo"), limpar=document.getElementById("limpar");
  const csvfile=document.getElementById("csvfile"), btnImport=document.getElementById("btnImport"), impStatus=document.getElementById("impStatus");
  let chartLine=null, lineMode="total";
  let minISO=null, maxISO=null;

  // ====== UTILS ======
  const fmtBRL = n=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = n=>new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO   = d=>(new Date(d)).toISOString().slice(0,10);
  const todayISO= ()=>toISO(new Date());
  const addDays = (iso, k)=>{ const d=new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+k); return toISO(d); };
  const parseMaybeDateISO = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
    if(m){ const [_,dd,mm,yy]=m; return `${yy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`; }
    const t=new Date(s); return isNaN(t)?null:toISO(t);
  };
  const movingAvg = (arr,win)=>{const out=[];let acc=0;for(let i=0;i<arr.length;i++){acc+=arr[i];if(i>=win)acc-=arr[i-win];out.push(acc/Math.min(i+1,win));}return out;};
  const destroy = c=>{ if(c){try{c.destroy();}catch(e){}} return null; };

  // ====== AUTH HEADER ======
  (async()=>{ const {data:{user}}=await supa.auth.getUser(); who.textContent=user?.email||"—"; })();
  btnLogout.addEventListener("click", async()=>{ await supa.auth.signOut(); location.reload(); });

  // ====== BOUNDS E FILTROS ======
  async function fetchBounds(){
    const lo = await supa.from(VIEW).select("dia").order("dia",{ascending:true}).limit(1);
    const hi = await supa.from(VIEW).select("dia").order("dia",{ascending:false}).limit(1);
    minISO = lo.data?.[0]?.dia || null;
    maxISO = hi.data?.[0]?.dia || null;
    if(!minISO || !maxISO){
      const lo2 = await supa.from(STAGE).select("dia").order("dia",{ascending:true}).limit(1);
      const hi2 = await supa.from(STAGE).select("dia").order("dia",{ascending:false}).limit(1);
      minISO = minISO || lo2.data?.[0]?.dia || addDays(todayISO(),-29);
      maxISO = maxISO || hi2.data?.[0]?.dia || todayISO();
    }
  }
  async function fillStaticFilters(){
    const r = await supa.from(VIEW).select("unidade").order("unidade",{ascending:true}).limit(10000);
    const set = new Set((r.data||[]).map(x=>(x.unidade||"").trim()).filter(Boolean));
    uni.innerHTML = '<option value="Todas">Todas</option>' + [...set].map(u=>`<option>${u}</option>`).join("");

    const r2 = await supa.from(VIEW).select('"Canal de venda",pagamento').limit(200000);
    const sc=new Set((r2.data||[]).map(x=>x["Canal de venda"]).filter(Boolean));
    const sp=new Set((r2.data||[]).map(x=>x["pagamento"]).filter(Boolean));
    canal.innerHTML=[...sc].sort().map(v=>`<option>${v}</option>`).join("");
    pag.innerHTML  =[...sp].sort().map(v=>`<option>${v}</option>`).join("");

    const t = await supa.from(VIEW).select('"Nome da loja",fat').limit(300000);
    const acc=new Map(); (t.data||[]).forEach(r=>{const n=r["Nome da loja"];if(!n)return;acc.set(n,(acc.get(n)||0)+Number(r.fat||0));});
    const top=[...acc.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
    lojas.innerHTML=top.map(n=>`<option>${n}</option>`).join("");
  }
  function periodFromQuick(){
    const end=maxISO||todayISO(); const days=Number(pr.value)||30; const start=addDays(end,-(days-1));
    dini.value=start; dfim.value=end;
  }
  function attachFilterEvents(){
    [uni,lojas,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>{
      el.addEventListener("change", async ()=>{
        if(el===pr) periodFromQuick();
        document.getElementById("fx").open=false;
        await reload();
      });
    });
    limpar.addEventListener("click", async e=>{
      e.preventDefault(); uni.value="Todas"; lojas.selectedIndex=-1; pr.value="30"; periodFromQuick();
      turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value="Todos"; await reload();
    });
  }

  // ====== CONSULTA ======
  function setDelta(el,cur,prev){const pct=prev>0?(cur-prev)/prev*100:0; el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"%"; el.style.color=pct>=0?"var(--good)":"var(--bad)";}
  async function queryRange(startISO,endISO){
    let q=supa.from(VIEW).select(FIELDS).gte("dia",startISO).lte("dia",endISO).order("dia",{ascending:true});
    const unidade=uni.value; if(unidade&&unidade!=="Todas") q=q.eq("unidade",unidade);
    const selLojas=[...lojas.selectedOptions].map(o=>o.value); if(selLojas.length) q=q.in("Nome da loja",selLojas);
    const tsel=[...turno.selectedOptions].map(o=>o.value); if(tsel.length) q=q.in("turno",tsel);
    const csel=[...canal.selectedOptions].map(o=>o.value); if(csel.length) q=q.in("Canal de venda",csel);
    const psel=[...pag.selectedOptions].map(o=>o.value); if(psel.length) q=q.in("pagamento",psel);
    if(canc.value!=="Todos") q=q.eq("cancelado",canc.value);
    const r=await q; if(r.error) throw r.error; return r.data||[];
  }
  function drawLine(labels,vals,prev){
    chartLine=destroy(chartLine); const ctx=document.getElementById("cLine").getContext("2d");
    const main=lineMode==="media"?movingAvg(vals,7):vals;
    chartLine=new Chart(ctx,{type:"line",data:{labels,datasets:[
      {data:prev,fill:true,borderWidth:0,backgroundColor:"rgba(2,132,199,0.12)",pointRadius:0,tension:0.2},
      {data:main,borderWidth:2,pointRadius:0,tension:0.2}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }
  async function reload(){
    let sISO=parseMaybeDateISO(dini.value)||minISO||addDays(todayISO(),-29);
    let eISO=parseMaybeDateISO(dfim.value)||maxISO||todayISO();
    if(!sISO||!eISO){ // guard contra lte.null
      sISO=addDays(todayISO(),-29); eISO=todayISO();
    }
    periodoTxt.textContent="Período: "+sISO+" → "+eISO;

    const cur=await queryRange(sISO,eISO);
    const dCount=Math.max(1,Math.round((new Date(eISO)-new Date(sISO))/(24*3600*1000))+1);
    const prevEnd=addDays(sISO,-1), prevStart=addDays(prevEnd,-(dCount-1));
    const ant=await queryRange(prevStart,prevEnd);

    const ped = cur.reduce((s,r)=>s+Number(r.pedidos||0),0);
    const fat = cur.reduce((s,r)=>s+Number(r.fat||0),0);
    const des = cur.reduce((s,r)=>s+Number(r.des||0),0);
    const fre = cur.reduce((s,r)=>s+Number(r.fre||0),0);
    const pedA= ant.reduce((s,r)=>s+Number(r.pedidos||0),0);
    const fatA= ant.reduce((s,r)=>s+Number(r.fat||0),0);
    const desA= ant.reduce((s,r)=>s+Number(r.des||0),0);
    const freA= ant.reduce((s,r)=>s+Number(r.fre||0),0);

    const diasCur=(new Set(cur.map(r=>r.dia))).size||1, diasAnt=(new Set(ant.map(r=>r.dia))).size||1;
    const tkm=ped>0?fat/ped:0, tkmA=pedA>0?fatA/pedA:0;
    const fmd=fat/diasCur, fmdA=fatA/diasAnt;
    const fatL=fat-des-fre-0.12*fat, fatLA=fatA-desA-freA-0.12*fatA;
    const desP=fat>0?des/fat*100:0, desPA=fatA>0?desA/fatA*100:0;
    const freM=ped>0?fre/ped:0, freMA=pedA>0?freA/pedA:0;
    const fatLP=fat>0?fatL/fat*100:0, fatLPA=fatA>0?fatLA/fatA*100:0;

    k_ped.textContent=fmtInt(ped); k_tkm.textContent=fmtBRL(tkm); k_fat.textContent=fmtBRL(fat); k_fmd.textContent=fmtBRL(fmd);
    k_des.textContent=fmtBRL(des); k_desp.textContent=desP.toFixed(1)+"%"; k_fre.textContent=fmtBRL(fre); k_frem.textContent=fmtBRL(freM);
    k_fatl.textContent=fmtBRL(fatL); k_fatlp.textContent=fatLP.toFixed(1)+"%";
    setDelta(d_ped,ped,pedA); setDelta(d_tkm,tkm,tkmA); setDelta(d_fat,fat,fatA); setDelta(d_fmd,fmd,fmdA);
    setDelta(d_des,des,desA); setDelta(d_desp,desP,desPA); setDelta(d_fre,fre,freA); setDelta(d_frem,freM,freMA);
    setDelta(d_fatl,fatL,fatLA); setDelta(d_fatlp,fatLP,fatLPA);

    const byDay=(arr)=>{const m=new Map();arr.forEach(r=>m.set(r.dia,(m.get(r.dia)||0)+Number(r.fat||0)));const labels=[...m.keys()].sort();return{labels,values:labels.map(k=>m.get(k))};};
    const d1=byDay(cur), d2=byDay(ant); drawLine(d1.labels,d1.values,d2.values);
  }
  document.getElementById("lineModePill").querySelectorAll("button").forEach(b=>{
    b.addEventListener("click",()=>{document.querySelectorAll("#lineModePill button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); lineMode=b.dataset.val; reload();});
  });

  // ====== IMPORTAÇÃO ROBUSTA ======
  function normKey(s){
    return (s||"").toString().trim()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().replace(/[^a-z0-9]/g,"");
  }
  // mapa de sinônimos -> canônico
  const COLMAP = new Map(Object.entries({
    // datas
    dia:"dia", data:"dia", dt:"dia", date:"dia", datavenda:"dia", emissao:"dia",
    // unidade
    unidade:"unidade", unid:"unidade", filial:"unidade", loja:"unidade",
    // loja (nome)
    nomedaloja:"Nome da loja", lojanome:"Nome da loja", nome_loja:"Nome da loja", estabelecimento:"Nome da loja",
    // pedidos
    pedidos:"pedidos", qtd:"pedidos", quantidade:"pedidos", ped:"pedidos", qtdpedidos:"pedidos",
    // dinheiro
    fat:"fat", faturamento:"fat", total:"fat", receita:"fat", valortotal:"fat", valor:"fat", subtotal:"fat",
    des:"des", desconto:"des", incentivos:"des", desc:"des", promocao:"des",
    fre:"fre", frete:"fre", taxaentrega:"fre", entrega:"fre", delivery:"fre", taxa:"fre",
    // turno
    turno:"turno", periodo:"turno", shift:"turno",
    // canal
    canaldevenda:"Canal de venda", canal:"Canal de venda", origem:"Canal de venda", marketplace:"Canal de venda",
    // pagamento
    pagamento:"pagamento", forma:"pagamento", metodopagamento:"pagamento", meiopagamento:"pagamento", formapag:"pagamento",
    // cancelado
    cancelado:"cancelado", status:"cancelado", canceled:"cancelado", estacancelado:"cancelado",
    // hora
    hora:"hora", horario:"hora", hour:"hora", h:"hora", horavenda:"hora"
  }));
  function renamer(header){
    const nk = normKey(header);
    if(COLMAP.has(nk)) return COLMAP.get(nk);
    // tratamentos específicos
    if(nk==="nomedaloja"||nk==="nomedaloja1"||nk==="nomedloja") return "Nome da loja";
    return header; // devolve original se não reconhecer (talvez já esteja correto)
  }
  function parseNum(v){
    if(v===null||v===undefined||v==="") return 0;
    const s = String(v).replace(/\./g,"").replace(/,/g,".");
    const n = Number(s); return isNaN(n)?0:n;
  }

  btnImport.addEventListener("click", ()=>{
    const f=csvfile.files?.[0];
    if(!f){ impStatus.textContent="Selecione o arquivo."; return; }
    impStatus.textContent="Lendo arquivo…";
    Papa.parse(f,{
      header:true, skipEmptyLines:true, dynamicTyping:false,
      transformHeader:renamer,
      complete: async (res)=>{
        try{
          const raw=res.data||[];
          // mapeia registros
          const norm=[];
          for(const r of raw){
            const dia = parseMaybeDateISO(r["dia"]);
            const loja = r["Nome da loja"] ?? r["Nome da Loja"] ?? r["loja"] ?? null;
            if(!dia || !loja) continue; // precisa de data e loja
            norm.push({
              dia,
              unidade: r["unidade"]??r["filial"]??null,
              pedidos: parseNum(r["pedidos"]),
              fat:     parseNum(r["fat"]),
              des:     parseNum(r["des"]),
              fre:     parseNum(r["fre"]),
              "Nome da loja": loja,
              turno:   r["turno"]??null,
              "Canal de venda": r["Canal de venda"]??r["canal"]??null,
              pagamento: r["pagamento"]??null,
              cancelado: r["cancelado"]??null,
              hora: (r["hora"]===""||r["hora"]===null||r["hora"]===undefined)?null:Number(r["hora"])
            });
          }
          if(!norm.length){ impStatus.textContent="Nada para importar (colunas do arquivo não foram reconhecidas)."; return; }

          // intervalo do CSV
          const ord = [...new Set(norm.map(x=>x.dia))].sort();
          const minCsv = ord[0], maxCsv = ord[ord.length-1];

          // dedupe por chave composta
          const key = r => [r.dia, r.unidade||"", r["Nome da loja"]||"", (r.hora??""), r.pagamento||"", r["Canal de venda"]||""].join("|");
          const uniq = new Map(); for(const r of norm){ uniq.set(key(r), r); }
          const payload = [...uniq.values()];

          // limpa só o intervalo no STAGE e insere
          impStatus.textContent=`Limpando ${minCsv}→${maxCsv}…`;
          await supa.from(STAGE).delete().gte("dia", minCsv).lte("dia", maxCsv);

          impStatus.textContent=`Inserindo ${payload.length.toLocaleString("pt-BR")}…`;
          const CHUNK=1000;
          for(let i=0;i<payload.length;i+=CHUNK){
            const slice=payload.slice(i,i+CHUNK);
            const ins=await supa.from(STAGE).insert(slice);
            if(ins.error){ impStatus.textContent="Erro ao inserir: "+ins.error.message; return; }
          }
          impStatus.textContent="Importado. Atualizando…";
          await fetchBounds(); await reload();
          impStatus.textContent="Concluído.";
        }catch(e){ impStatus.textContent="Erro: "+(e.message||e); }
      },
      error:(err)=>{ impStatus.textContent="Erro de leitura: "+(err.message||err); }
    });
  });

  // ====== BOOT ======
  async function boot(){
    const {data:{user}}=await supa.auth.getUser(); who.textContent=user?.email||"—";
    await fetchBounds(); periodFromQuick();
    await fillStaticFilters(); attachFilterEvents();
    // modo do gráfico
    document.querySelectorAll("#lineModePill button").forEach(b=>{
      b.addEventListener("click",()=>{document.querySelectorAll("#lineModePill button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); lineMode=b.dataset.val; reload();});
    });
    await reload();
  }
  boot();
})();
</script>
</body>
</html>
