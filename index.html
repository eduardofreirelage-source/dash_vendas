<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Uploader Vendas + Smoke Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon embutido para evitar 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' fill='%230b5'/%3E%3Ctext x='50%25' y='55%25' font-size='36' text-anchor='middle' fill='white'%3E✓%3C/text%3E%3C/svg%3E" />
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <!-- Supabase -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; }
    h1 { margin-bottom: 8px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    legend { padding: 0 6px; color: #444; }
    label { display:block; font-size: 12px; color: #555; margin-top: 6px; }
    select, input[type="text"], input[type="date"], button { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .col { min-width: 220px; flex: 1; }
    #log { white-space: pre-wrap; background:#0b1220; color:#d7e1ff; padding:12px; border-radius:8px; max-height: 320px; overflow:auto; }
    .ok { color: #0a0; }
    .warn { color: #a60; }
    .err { color: #c00; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; margin-right:6px; font-size:12px; }
    .btn { background:#0b5; color:#fff; border:none; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-secondary { background:#456; }
  </style>
</head>
<body>
  <h1>Uploader & Debug (Supabase)</h1>

  <fieldset>
    <legend>Supabase</legend>
    <div class="row">
      <div class="col">
        <label>URL</label>
        <input id="url" type="text" value="https://uahmcfzerofhzjvlzrqc.supabase.co" />
      </div>
      <div class="col">
        <label>Anon key</label>
        <input id="key" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" />
      </div>
      <div class="col" style="align-self:end">
        <button id="btnPing" class="btn">Testar conexão</button>
      </div>
    </div>
    <div id="connBadge"></div>
  </fieldset>

  <fieldset>
    <legend>Upload Excel</legend>
    <div class="row">
      <div class="col">
        <input id="file" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="col">
        <button id="btnRead" class="btn">Ler arquivo</button>
      </div>
      <div class="col">
        <span id="fileInfo" class="pill"></span>
      </div>
    </div>

    <div class="row">
      <div class="col"><label>Coluna com Data+Hora (opcional)</label><select id="m_datahora"></select></div>
      <div class="col"><label>Data (yyyy-mm-dd)</label><select id="m_data_venda"></select></div>
      <div class="col"><label>Hora (0–23)</label><select id="m_hora"></select></div>
      <div class="col"><label>Unidade</label><select id="m_unidade"></select></div>
      <div class="col"><label><b>Loja</b></label><select id="m_loja"></select></div>
      <div class="col"><label>Canal</label><select id="m_canal"></select></div>
      <div class="col"><label>Cancelado (Sim/Não/true/false)</label><select id="m_cancelado"></select></div>
      <div class="col"><label>Itens</label><select id="m_itens"></select></div>
      <div class="col"><label>Total</label><select id="m_total"></select></div>
      <div class="col"><label>Desconto</label><select id="m_des"></select></div>
      <div class="col"><label>Frete</label><select id="m_fre"></select></div>
      <div class="col"><label>Turno</label><select id="m_turno"></select></div>
      <div class="col"><label>Pagamento</label><select id="m_pagamento"></select></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><button id="btnPreview" class="btn btn-secondary">Validar & Prévia (5 linhas)</button></div>
      <div class="col"><button id="btnInsert" class="btn">Inserir no banco (lotes de 2.000)</button></div>
      <div class="col"><span id="insInfo" class="pill"></span></div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Smoke tests</legend>
    <div class="row">
      <div class="col"><label>Data inicial</label><input type="date" id="dini" /></div>
      <div class="col"><label>Data final</label><input type="date" id="dfim" /></div>
      <div class="col" style="align-self:end"><button id="btnAutoRange" class="btn btn-secondary">Usar min/max da view</button></div>
      <div class="col" style="align-self:end"><button id="btnSmoke" class="btn">Rodar smoke test</button></div>
    </div>
    <div id="smk" class="pill"></div>
  </fieldset>

  <fieldset>
    <legend>Debug</legend>
    <pre id="log"></pre>
  </fieldset>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const $ = (sel) => document.querySelector(sel);
  function logAppend() {
    const el = $("#log");
    const parts = [];
    for (let i=0;i<arguments.length;i++) {
      const v = arguments[i];
      parts.push(typeof v === 'string' ? v : JSON.stringify(v, null, 2));
    }
    el.textContent += parts.join(' ') + "\n";
    el.scrollTop = el.scrollHeight;
  }
  const log = logAppend;
  const setPill = (id, txt, cls) => { const el = $(id); el.textContent = txt || ''; el.className = 'pill ' + (cls||''); };

  let SUPA = null;
  let XLS = window.XLSX;
  let rows = [];        // linhas cruas do Excel
  let mapped = [];      // linhas mapeadas p/ inserção

  const selects = ["m_datahora","m_data_venda","m_hora","m_unidade","m_loja","m_canal","m_cancelado","m_itens","m_total","m_des","m_fre","m_turno","m_pagamento"];

  // Helpers -------------------------------------------------------
  function parseDateLike(v) {
    // aceita: Excel serial, 'dd/mm/aaaa hh:mm', 'aaaa-mm-dd hh:mm', 'aaaa-mm-dd', etc.
    if (v === null || v === undefined || v === '') return { d:null, h:null };
    if (typeof v === 'number') {
      // Excel serial
      const epoch = new Date(Date.UTC(1899, 11, 30));
      const ms = v * 24 * 3600 * 1000;
      const dt = new Date(epoch.getTime() + ms);
      return { d: dt.toISOString().slice(0,10), h: dt.getUTCHours() };
    }
    const s = String(v).trim().replace('T',' ');
    // yyyy-mm-dd [hh[:mm]]
    let m = s.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})(?:\s+(\d{1,2})(?::(\d{2}))?)?/);
    if (m) {
      const Y = m[1], M = m[2], D = m[3];
      const H = m[4];
      return { d: (Y + "-" + M + "-" + D), h: (H !== undefined ? parseInt(H,10) : null) };
    }
    // dd/mm/yyyy [hh[:mm]]
    m = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})(?:\s+(\d{1,2})(?::(\d{2}))?)?/);
    if (m) {
      const D = m[1], M = m[2], Y = m[3];
      const H = m[4];
      return { d: (Y + "-" + M + "-" + D), h: (H !== undefined ? parseInt(H,10) : null) };
    }
    // só hora? "13" ou "13:45"
    m = s.match(/^(\d{1,2})(?::(\d{2}))?$/);
    if (m) { return { d:null, h: parseInt(m[1],10) }; }
    return { d:null, h:null };
  }

  function toBoolVal(v) {
    if (typeof v === 'boolean') return v;
    const s = String(v||'').trim().toLowerCase();
    if (s === 'sim' || s === 's' || s === 'true' || s === '1' || s === 'yes' || s === 'y') return true;
    if (s === 'não' || s === 'nao' || s === 'n' || s === 'false' || s === '0' || s === 'no') return false;
    return false;
  }

  function toNumber(v) {
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') return v;
    const s = String(v).trim().split('.').join('').replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function fillSelectOptions(cols) {
    for (let i=0;i<selects.length;i++) {
      const id = selects[i];
      const sel = $("#"+id);
      const opts = ['<option value="">-- (vazio) --</option>'];
      for (let j=0;j<cols.length;j++) opts.push('<option>'+cols[j]+'</option>');
      sel.innerHTML = opts.join('');
    }
    // sugestões padrão:
    suggest("#m_datahora", ["datahora","data e hora","data hora"]);
    suggest("#m_data_venda", ["data_venda","data","data da venda"]);
    suggest("#m_hora", ["hora"]);
    suggest("#m_unidade", ["unidade"]);
    suggest("#m_loja", ["loja","nome da loja","nome da Loja","Nome da loja","Nome da Loja"]);
    suggest("#m_canal", ["canal","canal de venda","Canal de venda"]);
    suggest("#m_cancelado", ["cancelado","está cancelado","Está cancelado"]);
    suggest("#m_itens", ["itens","Itens","pedidos"]);
    suggest("#m_total", ["total","Total","fat"]);
    suggest("#m_des", ["des","Desconto","desconto"]);
    suggest("#m_fre", ["fre","frete","entrega","Entrega"]);
    suggest("#m_turno", ["turno","Turno"]);
    suggest("#m_pagamento", ["pagamento","Pagamento","pagamento_base"]);
  }
  function suggest(sel, candidates){
    const el = $(sel);
    const opts = [];
    for (let i=0;i<el.options.length;i++) { opts.push(el.options[i].value.toLowerCase()); }
    for (let i=0;i<candidates.length;i++) {
      const c = String(candidates[i]).toLowerCase();
      const idx = opts.indexOf(c);
      if (idx >= 0) { el.selectedIndex = idx+1; break; }
    }
  }

  function getMap() {
    function g(id) { const v=$("#"+id).value; return v===''?null:v; }
    return {
      datahora: g('m_datahora'),
      data_venda: g('m_data_venda'),
      hora: g('m_hora'),
      unidade: g('m_unidade'),
      loja: g('m_loja'),
      canal: g('m_canal'),
      cancelado: g('m_cancelado'),
      itens: g('m_itens'),
      total: g('m_total'),
      des: g('m_des'),
      fre: g('m_fre'),
      turno: g('m_turno'),
      pagamento: g('m_pagamento')
    };
  }

  function mapRows(raw, map) {
    const out = [];
    for (let i=0;i<raw.length;i++) {
      const r = raw[i];
      let d=null, h=null;

      if (map.datahora && r[map.datahora] !== null && r[map.datahora] !== undefined) {
        const x = parseDateLike(r[map.datahora]);
        d = x.d; h = x.h;
      }
      if (!d && map.data_venda && r[map.data_venda] !== null && r[map.data_venda] !== undefined) {
        const x2 = parseDateLike(r[map.data_venda]);
        d = x2.d;
      }
      if (h === null && map.hora && r[map.hora] !== null && r[map.hora] !== undefined) {
        const hh = parseDateLike(r[map.hora]);
        h = (hh.h !== null) ? hh.h : toNumber(r[map.hora]);
      }

      const rec = {
        data_venda: d,
        hora: (h !== null ? parseInt(h,10) : null),
        unidade: map.unidade ? String(r[map.unidade]||'').trim() : null,
        loja: map.loja ? String(r[map.loja]||'').trim() : null,
        canal: map.canal ? String(r[map.canal]||'').trim() : null,
        cancelado: map.cancelado ? !!toBoolVal(r[map.cancelado]) : false,
        itens: map.itens ? parseInt(toNumber(r[map.itens]),10) : 1,
        total: map.total ? toNumber(r[map.total]) : 0,
        des: map.des ? toNumber(r[map.des]) : 0,
        fre: map.fre ? toNumber(r[map.fre]) : 0,
        turno: map.turno ? String(r[map.turno]||'').trim() : null,
        pagamento: map.pagamento ? String(r[map.pagamento]||'').trim() : null
      };
      out.push(rec);
    }
    return out;
  }

  // Supabase init -----------------------------------------------
  let supaLoaded = false;
  async function initClient() {
    if (supaLoaded) return SUPA;
    const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2?bundle");
    const url = $("#url").value.trim();
    const key = $("#key").value.trim();
    SUPA = createClient(url, key);
    supaLoaded = true;
    return SUPA;
  }

  async function ping() {
    try {
      await initClient();
      const { error } = await SUPA
        .from('vendas_import_csv_v2')
        .select('id', { count:'exact', head:true })
        .limit(1);
      if (error) throw error;
      setPill("#connBadge","✅ Supabase client ok","ok");
      log("✅ Supabase client ok");
    } catch (e) {
      setPill("#connBadge","❌ Erro Supabase","err");
      log("❌", e);
    }
  }

  // UI handlers --------------------------------------------------
  $("#btnPing").addEventListener("click", ping);

  $("#btnRead").addEventListener("click", async () => {
    try {
      const f = $("#file").files[0];
      if (!f) { alert("Escolha um .xlsx"); return; }
      const buf = await f.arrayBuffer();
      const wb = XLS.read(buf, {type:'array'});
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const json = XLS.utils.sheet_to_json(sheet, { defval: null });
      rows = json;
      setPill("#fileInfo", "Arquivo: " + f.name + " — Abas: " + wb.SheetNames.length + " — Linhas: " + rows.length);
      log("📄 Arquivo lido", { nome:f.name, sheet: sheetName, linhas: rows.length });
      const cols = Object.keys(rows[0] || {});
      fillSelectOptions(cols);
      log("🔧 1ª linha (amostra)", rows[0] || {});
    } catch (e) {
      log("❌ Erro lendo Excel", e);
      alert("Erro lendo o Excel (ver Debug).");
    }
  });

  $("#btnPreview").addEventListener("click", () => {
    if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
    const map = getMap();
    mapped = mapRows(rows.slice(0,5), map);
    log("✅ Prévia (5 linhas mapeadas):", mapped);
  });

  $("#btnInsert").addEventListener("click", async () => {
    try {
      if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
      await initClient();
      const map = getMap();
      mapped = mapRows(rows, map);

      let semData = 0;
      for (let i=0;i<mapped.length;i++) if (!mapped[i].data_venda) semData++;
      if (semData > 0) log("⚠️ Linhas sem data_venda:", semData);

      const chunk = 2000;
      let ok=0, fail=0;
      for (let i=0;i<mapped.length;i+=chunk){
        const lote = mapped.slice(i, i+chunk);
        const { error } = await SUPA.from('vendas_import_csv_v2').insert(lote);
        if (error) {
          fail += lote.length;
          log({ lote:[i, i+lote.length], error });
        } else {
          ok += lote.length;
          log("✅ Lote inserido", { lote:[i, i+lote.length] });
        }
      }
      setPill("#insInfo", "Inserção concluída — ok: " + ok + " / falhas: " + fail, (fail ? 'warn':'ok'));
      log("📦 Inserção concluída", { ok, fail });
    } catch (e) {
      log("❌ Erro inserindo", e);
      alert("Erro inserindo (ver Debug).");
    }
  });

  $("#btnAutoRange").addEventListener("click", async ()=>{
    try {
      await initClient();
      // pega min e max via ordenação (compatível com PostgREST)
      const a = await SUPA.from('vw_vendas').select('dia').order('dia',{ascending:true}).limit(1);
      const b = await SUPA.from('vw_vendas').select('dia').order('dia',{ascending:false}).limit(1);
      const minDia = (a.data && a.data[0] && a.data[0].dia) ? a.data[0].dia : '';
      const maxDia = (b.data && b.data[0] && b.data[0].dia) ? b.data[0].dia : '';
      $("#dini").value = minDia || '';
      $("#dfim").value = maxDia || '';
      log("🗓️ Intervalo auto", { minDia, maxDia });
    } catch(e){
      log("⚠️ AutoRange falhou", e);
    }
  });

  $("#btnSmoke").addEventListener("click", async ()=>{
    try{
      await initClient();
      const dini = $("#dini").value || '2025-01-01';
      const dfim = $("#dfim").value || '2025-12-31';
      const args = {
        p_dini: dini, p_dfim: dfim,
        p_unids: null, p_lojas: null, p_turnos: null, p_canais: null, p_pags: null, p_cancelado: null
      };

      // KPI
      const k = await SUPA.rpc('kpi_vendas_v2', args);
      if (k.error) throw k.error;
      const kpi = Array.isArray(k.data) ? k.data[0] : k.data;
      log("→ KPI params", args);
      log("✅ KPI", kpi);

      // DOW/MÊS/HORA
      const d = await SUPA.rpc('chart_vendas_dow_v2', args);
      const m = await SUPA.rpc('chart_vendas_mes_v2', args);
      const h = await SUPA.rpc('chart_vendas_hora_v2', args);
      if (d.error) throw d.error;
      if (m.error) throw m.error;
      if (h.error) throw h.error;

      function sum(arr, key) {
        let s = 0;
        if (arr && arr.length) {
          for (let i=0;i<arr.length;i++) { s += Number(arr[i][key] || 0); }
        }
        return s;
      }
      const sd = sum(d.data,'total');
      const sm = sum(m.data,'total');
      const sh = sum(h.data,'total');
      const fat = Number(kpi && kpi.fat ? kpi.fat : 0);

      const ok = Math.abs(sd - fat) < 0.0001 && Math.abs(sm - fat) < 0.0001 && Math.abs(sh - fat) < 0.0001;
      const msg = "DOW " + (Math.abs(sd - fat)<0.0001?'✅':'❌') + " soma=" + sd.toLocaleString('pt-BR',{minimumFractionDigits:2}) +
                  " vs KPI=" + fat.toLocaleString('pt-BR',{minimumFractionDigits:2}) +
                  "\nMÊS " + (Math.abs(sm - fat)<0.0001?'✅':'❌') + " soma=" + sm.toLocaleString('pt-BR',{minimumFractionDigits:2}) +
                  " vs KPI=" + fat.toLocaleString('pt-BR',{minimumFractionDigits:2}) +
                  "\nHORA " + (Math.abs(sh - fat)<0.0001?'✅':'❌') + " soma=" + sh.toLocaleString('pt-BR',{minimumFractionDigits:2}) +
                  " vs KPI=" + fat.toLocaleString('pt-BR',{minimumFractionDigits:2});
      $("#smk").textContent = msg;
      log("🧪 Smoke", { dow: sd, mes: sm, hora: sh, fat });

    } catch(e){
      $("#smk").textContent = "❌ Smoke test falhou (ver Debug)";
      log("❌ Smoke", e);
    }
  });

  // Inicial
  (async function start(){
    try { await ping(); } catch(_){}
  })();
</script>
</body>
</html>
