<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- favicon inline p/ evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50%" x="50%" dominant-baseline="middle" text-anchor="middle" font-size="48">üçΩÔ∏è</text></svg>'>
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .topbar{display:flex;gap:8px;align-items:center}
    button,select,input{font:inherit;border:1px solid var(--brd);border-radius:10px;background:#fff;padding:8px 10px}
    button{cursor:pointer}
    .ghost{background:#fff}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid{display:grid;gap:12px}
    .cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kpi{position:relative}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)}
    .chartbox{position:relative;height:300px}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff}
    .pill button.active{background:var(--accent);color:#fff}
    details.filterbox{border:1px solid var(--brd);border-radius:14px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;display:flex;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    .filters{padding:12px 14px}
    .fgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    .seg{display:flex;gap:6px;align-items:center}
    .seg .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{min-width:180px;width:100%}
    select[multiple]{height:38px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#eef2ff;border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    @media (max-width:940px){.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))} .fgrid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:560px){.cols-4,.cols-2{grid-template-columns:1fr} .fgrid{grid-template-columns:repeat(4,1fr)}}
    /* Gate (auth) */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:none;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso ‚Äî Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div class="field">
        <label for="authEmail">E-mail</label>
        <input id="authEmail" type="email" placeholder="voce@empresa.com">
      </div>
      <div class="field">
        <label for="authPass">Senha</label>
        <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="field" id="fieldNewPass" style="display:none">
        <label for="authNew">Nova senha</label>
        <input id="authNew" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="error" id="authErr"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="btnForgot" class="ghost">Esqueci a senha</button>
        <button id="btnSignup" style="display:none">Criar conta</button>
        <button id="btnLogin">Entrar</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <h1>Maestro Food</h1>
      <div class="topbar">
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <details class="filterbox" id="fx" open>
      <summary>FILTROS <span class="muted" id="limpar">Limpar</span></summary>
      <div class="filters">
        <div class="fgrid">
          <div class="col-6 seg">
            <span class="lbl">Unidade</span>
            <select id="uni" class="grow"></select>
          </div>
          <div class="col-6 seg">
            <span class="lbl">Nome da loja (Top 10)</span>
            <div id="lojas" class="chips"></div>
          </div>

          <div class="col-3 seg">
            <span class="lbl">De</span>
            <input id="dini" type="date" class="grow">
          </div>
          <div class="col-3 seg">
            <span class="lbl">At√©</span>
            <input id="dfim" type="date" class="grow">
          </div>
          <div class="col-3 seg">
            <span class="lbl">Per√≠odo r√°pido</span>
            <select id="pr" class="grow">
              <option value="7">√öltimos 7</option>
              <option value="15">√öltimos 15</option>
              <option value="30" selected>√öltimos 30</option>
              <option value="90">√öltimos 90</option>
              <option value="180">√öltimos 180</option>
              <option value="360">√öltimos 360</option>
            </select>
          </div>
          <div class="col-3 seg">
            <span class="lbl">Turno</span>
            <select id="turno" class="grow" multiple>
              <option>Manh√£</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>

          <div class="col-4 seg">
            <span class="lbl">Canal de venda</span>
            <select id="canal" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Pagamento</span>
            <select id="pag" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Est√° cancelado?</span>
            <select id="canc" class="grow">
              <option value="Todos" selected>Todos</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
            </select>
          </div>

          <div class="col-12 card" style="border-style:dashed">
            <b>Admin</b> ‚Äî Importar CSV (<i>Pasta2.csv</i>)
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <input type="file" id="csvfile" accept=".csv" />
              <button id="btnImport">Importar CSV</button>
              <progress id="prog" value="0" max="100" style="display:none;height:10px"></progress>
              <span class="muted">Ap√≥s importar, a MV √© atualizada automaticamente.</span>
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">‚Äî</div><div class="delta" id="d_ped">‚Äî</div></div>
      <div class="card kpi"><div class="title">Ticket M√©dio</div><div class="val" id="k_tkm">‚Äî</div><div class="delta" id="d_tkm">‚Äî</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">‚Äî</div><div class="delta" id="d_fat">‚Äî</div></div>
      <div class="card kpi"><div class="title">Faturamento M√©dio (dia)</div><div class="val" id="k_fmd">‚Äî</div><div class="delta" id="d_fmd">‚Äî</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">‚Äî</div><div class="delta" id="d_des">‚Äî</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">‚Äî</div><div class="delta" id="d_desp">‚Äî</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">‚Äî</div><div class="delta" id="d_fre">‚Äî</div></div>
      <div class="card kpi"><div class="title">Frete M√©dio</div><div class="val" id="k_frem">‚Äî</div><div class="delta" id="d_frem">‚Äî</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento L√≠quido</div><div class="val" id="k_fatl">‚Äî</div><div class="delta" id="d_fatl">‚Äî</div></div>
      <div class="card kpi"><div class="title">Faturamento L√≠quido %</div><div class="val" id="k_fatlp">‚Äî</div><div class="delta" id="d_fatlp">‚Äî</div></div>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita di√°ria</div>
        <div class="pill" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">M√©dia (7d)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana</div>
        <div class="pill" data-target="dowMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">M√©dia</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">M√©dia</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora</div>
        <div class="pill" data-target="hourMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">M√©dia</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por m√™s</div>
        <div class="pill" data-target="monMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">M√©dia</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas</div>
        <div class="pill" data-target="topMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">M√©dia</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Supabase =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2";
  const STAGING = "vendas_kpi_daily_v2_data";   // recebe o CSV
  const RPC_RESET = "staging_reset";             // TRUNCATE staging
  const RPC_REFRESH = "refresh_vendas";          // REFRESH MV (sem concurrently)

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } });

  // ===== Helpers UI =====
  const $ = (id)=>document.getElementById(id);
  const fmtBRL = (n)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = (n)=> new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = (d)=> (d && !isNaN(d.getTime())) ? d.toISOString().slice(0,10) : null;
  const parseISO = (s)=> new Date(s+"T00:00:00Z");
  const addDays = (d,k)=>{ const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; };
  const sum = (arr,k)=> arr.reduce((s,r)=>s+Number(r[k]||0),0);
  const avg = (v,c)=> c>0? v/c : 0;
  const debounce = (fn,wait)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };

  // ===== Auth (login / signup / forgot / recovery) =====
  const gate=$("gate"), app=$("app"), who=$("who");
  const tabLogin=$("tabLogin"), tabSignup=$("tabSignup"), authErr=$("authErr");
  const authEmail=$("authEmail"), authPass=$("authPass"), authNew=$("authNew"), fieldNew=$("fieldNewPass");
  $("btnLogout").onclick = async ()=>{ await supa.auth.signOut(); showGate(); };
  $("btnForgot").onclick = async ()=>{
    const email=(authEmail.value||"").trim();
    if(!email){ authErr.textContent="Informe o e-mail."; return; }
    const { error } = await supa.auth.resetPasswordForEmail(email,{ redirectTo: location.origin+location.pathname });
    authErr.textContent = error ? error.message : "Enviamos o link de redefini√ß√£o para seu e-mail.";
  };
  tabLogin.onclick = ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); $("btnLogin").style.display="inline-block"; $("btnSignup").style.display="none"; authErr.textContent=""; };
  tabSignup.onclick= ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); $("btnSignup").style.display="inline-block"; $("btnLogin").style.display="none"; authErr.textContent=""; };
  $("btnLogin").onclick = async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password:pass });
    if(error){ authErr.textContent=error.message; return; }
    hideGate(); afterLogin();
  };
  $("btnSignup").onclick = async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password:pass });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail se houver confirma√ß√£o.";
  };
  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }
  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    boot();
  }
  // modo recovery (link do e-mail abre aqui)
  supa.auth.onAuthStateChange(async (evt, session)=>{
    if(evt==="PASSWORD_RECOVERY"){ fieldNew.style.display="block"; authErr.textContent="Defina a nova senha e clique em Entrar."; }
  });

  // ===== Estado / refs =====
  const selUni=$("uni"), chipLojas=$("lojas");
  const dini=$("dini"), dfim=$("dfim"), pr=$("pr"), turno=$("turno"), canal=$("canal"), pag=$("pag"), canc=$("canc");
  let runId=0;
  let chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  let lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";
  let diasDisponiveis=new Set(), minDiaISO=null, maxDiaISO=null;

  // ===== Filtros UI =====
  $("limpar").onclick = (e)=>{ e.preventDefault(); selUni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos"; [...chipLojas.children].forEach(c=>c.classList.remove("active")); $("fx").open=false; recarregarDebounced(); };
  document.querySelectorAll('.pill').forEach(p=>{
    p.addEventListener('click', (ev)=>{
      const t=ev.target.closest('button'); if(!t) return;
      [...p.querySelectorAll('button')].forEach(b=>b.classList.remove('active')); t.classList.add('active');
      const val=t.getAttribute('data-val');
      const target=p.getAttribute('data-target');
      if(target==="lineMode") lineMode=val;
      if(target==="dowMode")  dowMode=val;
      if(target==="dowPedMode") dowPedMode=val;
      if(target==="hourMode") hourMode=val;
      if(target==="monMode")  monMode=val;
      if(target==="topMode")  topMode=val;
      recarregarDebounced();
    });
  });

  // ===== Data helpers =====
  async function fetchPaged(fields, startISO, endISO, unidade, lojas, filtros){
    const page=1000; let off=0, out=[];
    for(;;){
      let q = supa.from(TABLE).select(fields).order("dia",{ascending:true}).range(off, off+page-1);
      if(startISO) q = q.gte("dia", startISO);
      if(endISO)   q = q.lte("dia", endISO);
      if(unidade && unidade!=="Todas") q = q.eq("unidade", unidade);
      if(lojas && lojas.length) q = q.in("Nome da Loja", lojas);
      if(filtros.turno?.length) q = q.in("turno", filtros.turno);
      if(filtros.canal?.length) q = q.in("Canal de venda", filtros.canal);
      if(filtros.pag?.length)   q = q.in("pagamento", filtros.pag);
      if(filtros.canc && filtros.canc!=="Todos") q = q.eq("cancelado", filtros.canc==="Sim" ? "Sim" : "N√£o");
      const r = await q; if(r.error) throw r.error;
      const a=r.data||[]; out=out.concat(a);
      if(a.length<page) break;
      off+=page; if(off>500000) break;
    }
    return out;
  }
  async function fetchUnidades(){
    const uniq=new Set(); const arr=["Todas"];
    const r1 = await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).range(0,9999);
    (r1.data||[]).forEach(x=>{ const u=(x.unidade||"").trim(); if(u && !uniq.has(u)){ uniq.add(u); arr.push(u);} });
    if(arr.length===1){ arr.push("Uni. Raja","Uni.Savassi"); }
    return arr;
  }
  async function fetchLimites(){
    const rMin = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const rMax = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minDiaISO = rMin.data?.[0]?.dia || null;
    maxDiaISO = rMax.data?.[0]?.dia || null;

    diasDisponiveis = new Set();
    let off=0, page=1000;
    for(;;){
      const rs = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).range(off, off+page-1);
      (rs.data||[]).forEach(x=>diasDisponiveis.add(x.dia));
      if((rs.data||[]).length<page) break;
      off+=page; if(off>500000) break;
    }
    if(minDiaISO && maxDiaISO){ dini.min=minDiaISO; dfim.min=minDiaISO; dini.max=maxDiaISO; dfim.max=maxDiaISO; }
  }
  function snapToAvailable(iso){
    if(!iso || diasDisponiveis.has(iso)) return iso;
    const d=parseISO(iso);
    for(let k=1;k<60;k++){
      const a=toISO(addDays(d,-k)), b=toISO(addDays(d,k));
      if(a && diasDisponiveis.has(a)) return a;
      if(b && diasDisponiveis.has(b)) return b;
    }
    return null;
  }

  // ===== KPIs / Charts =====
  function setDelta(el, cur, prev){
    const pct = prev>0 ? ( (cur-prev)/prev*100 ) : 0;
    el.className="delta "+(pct>=0?"up":"down");
    el.textContent = (pct>=0?"+":"")+pct.toFixed(1)+"% "+(pct>=0?"‚ñ≤":"‚ñº");
  }
  function destroyChart(c){ if(c){ try{c.destroy();}catch{} } return null; }
  function movingAvg(arr,win){ const out=[], q=[]; let s=0; for(let i=0;i<arr.length;i++){ q.push(arr[i]); s+=arr[i]; if(q.length>win){ s-=q.shift(); } out.push(s/q.length); } return out; }
  function drawLine(days, vals, prevVals, mode){
    chartLine = destroyChart(chartLine);
    const ctx=$("cLine").getContext("2d");
    const main = (mode==="media") ? movingAvg(vals,7) : vals;
    chartLine = new Chart(ctx,{ type:"line",
      data:{ labels:days, datasets:[
        { data:prevVals, fill:true, borderWidth:0, backgroundColor:"rgba(37,99,235,0.12)", pointRadius:0, tension:0.25 },
        { data:main, borderWidth:2, pointRadius:0, tension:0.25 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }
  function drawBar(canvasId, labels, totals, counts, mode){
    const vals = (mode==="media") ? totals.map((v,i)=>avg(v, counts[i]||1)) : totals.slice();
    const ctx=$(canvasId).getContext("2d");
    const c = new Chart(ctx,{ type:"bar",
      data:{ labels, datasets:[{ data:vals }] },
      options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
    return c;
  }

  // ===== Recarregar (principal) =====
  async function recarregar(){
    const myRun=++runId;
    try{
      if(!maxDiaISO){ await fetchLimites(); }
      if(!maxDiaISO){ // sem dados no banco ainda
        ["k_ped","k_tkm","k_fat","k_fmd","k_des","k_desp","k_fre","k_frem","k_fatl","k_fatlp"].forEach(id=>$(id).textContent="‚Äî");
        return;
      }
      // datas
      let sISO=dini.value||"", eISO=dfim.value||"";
      if(sISO && eISO){
        const s0=snapToAvailable(sISO), e0=snapToAvailable(eISO);
        if(s0!==sISO){ dini.value=s0; sISO=s0; }
        if(e0!==eISO){ dfim.value=e0; eISO=e0; }
      }else{
        const end=parseISO(maxDiaISO), start=addDays(end, -(Number(pr.value||30)-1));
        sISO=toISO(start); eISO=toISO(end); dini.value=sISO; dfim.value=eISO;
      }

      const lojas=[...chipLojas.children].filter(c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      const filtros={
        turno:[...turno.selectedOptions].map(o=>o.value),
        canal:[...canal.selectedOptions].map(o=>o.value),
        pag:[...pag.selectedOptions].map(o=>o.value),
        canc:canc.value||"Todos"
      };
      const uniVal=selUni.value||"Todas";

      const fields='dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora';
      const cur = await fetchPaged(fields, sISO, eISO, uniVal==="Todas"?null:uniVal, lojas, filtros);
      if(myRun!==runId) return;

      // per√≠odo anterior (sombra)
      const daysLen=Math.max(1, Math.round((parseISO(eISO)-parseISO(sISO))/(24*3600*1000))+1);
      const prevEnd=addDays(parseISO(sISO),-1);
      const prevStart=addDays(prevEnd,-(daysLen-1));
      const ant = await fetchPaged(fields, toISO(prevStart), toISO(prevEnd), uniVal==="Todas"?null:uniVal, lojas, filtros);
      if(myRun!==runId) return;

      // popular selects (canal/pag) uma √∫nica vez
      if(canal.options.length===0 || pag.options.length===0){
        const all = await fetchPaged('"Canal de venda",pagamento', minDiaISO, maxDiaISO, null, null, {});
        const canals=[...new Set((all||[]).map(r=>r["Canal de venda"]).filter(Boolean))].sort();
        const pags  =[...new Set((all||[]).map(r=>r["pagamento"]).filter(Boolean))].sort();
        canals.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; canal.appendChild(o); });
        pags.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; pag.appendChild(o); });
      }

      // KPIs
      const ped=sum(cur,"pedidos"), fat=sum(cur,"fat"), des=sum(cur,"des"), fre=sum(cur,"fre");
      const pedA=sum(ant,"pedidos"), fatA=sum(ant,"fat"), desA=sum(ant,"des"), freA=sum(ant,"fre");
      const diasDist = new Set(cur.map(r=>r.dia)).size || 1;
      const diasDistA= new Set(ant.map(r=>r.dia)).size || 1;

      const tkm = ped>0? fat/ped : 0, tkmA = pedA>0? fatA/pedA : 0;
      const fmd = fat/diasDist,  fmdA = fatA/diasDistA;
      const fatL = fat - des - fre - (0.12*fat);
      const fatLA= fatA - desA - freA - (0.12*fatA);
      const desP = fat>0? des/fat*100 : 0;
      const desPA= fatA>0? desA/fatA*100 : 0;
      const freM = ped>0? fre/ped : 0, freMA= pedA>0? freA/pedA : 0;
      const fatLP= fat>0? fatL/fat*100 : 0, fatLPA= fatA>0? fatLA/fatA*100 : 0;

      $("k_ped").textContent = fmtInt(ped);
      $("k_tkm").textContent = fmtBRL(tkm);
      $("k_fat").textContent = fmtBRL(fat);
      $("k_fmd").textContent = fmtBRL(fmd);
      $("k_des").textContent = fmtBRL(des);
      $("k_desp").textContent = desP.toFixed(1)+"%";
      $("k_fre").textContent = fmtBRL(fre);
      $("k_frem").textContent = fmtBRL(freM);
      $("k_fatl").textContent = fmtBRL(fatL);
      $("k_fatlp").textContent = fatLP.toFixed(1)+"%";

      setDelta($("d_ped"), ped, pedA);
      setDelta($("d_tkm"), tkm, tkmA);
      setDelta($("d_fat"), fat, fatA);
      setDelta($("d_fmd"), fmd, fmdA);
      setDelta($("d_des"), des, desA);
      setDelta($("d_desp"), desP, desPA);
      setDelta($("d_fre"), fre, freA);
      setDelta($("d_frem"), freM, freMA);
      setDelta($("d_fatl"), fatL, fatLA);
      setDelta($("d_fatlp"), fatLP, fatLPA);

      // LINE + sombra
      const byDay = (()=>{ const m=new Map(); cur.forEach(r=>m.set(r.dia,(m.get(r.dia)||0)+Number(r.fat||0))); const lbl=[...m.keys()].sort(); return {labels:lbl, values:lbl.map(k=>m.get(k))}; })();
      const byDayPrev = (()=>{ const m=new Map(); ant.forEach(r=>m.set(r.dia,(m.get(r.dia)||0)+Number(r.fat||0))); const lbl=[...m.keys()].sort(); return {labels:lbl, values:lbl.map(k=>m.get(k))}; })();
      drawLine(byDay.labels, byDay.values, byDayPrev.values, lineMode);

      // DOW fat
      const dowFat=(()=>{ const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"]; const m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0]; const diasSet=new Set(cur.map(r=>r.dia)); [...diasSet].forEach(d=>cnt[parseISO(d).getUTCDay()]++); cur.forEach(r=>{ m[parseISO(r.dia).getUTCDay()]+=Number(r.fat||0); }); return {labels:lbl, totals:m, counts:cnt}; })();
      chartDowFat = destroyChart(chartDowFat);
      chartDowFat = drawBar("cDowFat", dowFat.labels, dowFat.totals, dowFat.counts, dowMode);

      // DOW ped
      const dowPed=(()=>{ const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"]; const m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0]; const diasSet=new Set(cur.map(r=>r.dia)); [...diasSet].forEach(d=>cnt[parseISO(d).getUTCDay()]++); cur.forEach(r=>{ m[parseISO(r.dia).getUTCDay()]+=Number(r.pedidos||0); }); return {labels:lbl, totals:m, counts:cnt}; })();
      chartDowPed = destroyChart(chartDowPed);
      chartDowPed = drawBar("cDowPed", dowPed.labels, dowPed.totals, dowPed.counts, dowPedMode);

      // HORA (oculta horas com baixa atividade)
      const hour=(()=>{ const m=Array(24).fill(0), cnt=Array(24).fill(0), daysByHour=Array(24).fill(0).map(()=>new Set()); cur.forEach(r=>{ if(r.hora==null) return; const h=+r.hora; if(h>=0 && h<=23){ m[h]+=Number(r.fat||0); daysByHour[h].add(r.dia); } }); const totalDays=new Set(cur.map(r=>r.dia)).size||1; const lbl=[], tot=[], c=[]; for(let h=0;h<24;h++){ const ad=daysByHour[h].size; const keep = ad >= Math.ceil(totalDays*0.5) && m[h]>0; if(keep){ lbl.push(String(h).padStart(2,"0")+":00"); tot.push(m[h]); c.push(ad); } } return {labels:lbl, totals:tot, counts:c}; })();
      chartHour = destroyChart(chartHour);
      chartHour = drawBar("cHour", hour.labels, hour.totals, hour.counts, hourMode);

      // M√äS
      const month=(()=>{ const m=new Map(), dpm=new Map(), cnt=new Map(); cur.forEach(r=>{ const ym=r.dia.slice(0,7); m.set(ym,(m.get(ym)||0)+Number(r.fat||0)); if(!dpm.has(ym)) dpm.set(ym,new Set()); dpm.get(ym).add(r.dia); }); [...dpm.keys()].forEach(ym=>cnt.set(ym, dpm.get(ym).size)); const lbl=[...m.keys()].sort(); return {labels:lbl, totals:lbl.map(x=>m.get(x)), counts:lbl.map(x=>cnt.get(x)||1)}; })();
      chartMonth = destroyChart(chartMonth);
      chartMonth = drawBar("cMonth", month.labels, month.totals, month.counts, monMode);

      // TOP 10 + chips (primeiro load)
      const byLoja={}; cur.forEach(r=>{ const n=r["Nome da Loja"]; if(!n) return; byLoja[n]=(byLoja[n]||0)+Number(r.fat||0); });
      const top = Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const topLabels=top.map(x=>x[0]), topTotals=top.map(x=>x[1]), topCounts=top.map(()=> (new Set(cur.map(r=>r.dia)).size) );
      chartTop = destroyChart(chartTop);
      (function(){ const ctx=$("cTop").getContext("2d"); const vals=(topMode==="media")? topTotals.map((v,i)=>avg(v, topCounts[i]||1)) : topTotals; chartTop=new Chart(ctx,{ type:"bar", data:{ labels:topLabels, datasets:[{ data:vals }] }, options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ x:{ beginAtZero:true } } }); })();
      if(chipLojas.children.length===0){
        chipLojas.innerHTML=""; topLabels.forEach(lbl=>{ const chip=document.createElement("span"); chip.className="chip"; chip.textContent=lbl; chip.setAttribute("data-v",lbl); chip.onclick=()=>{ chip.classList.toggle("active"); recarregarDebounced(); }; chipLojas.appendChild(chip); });
      }

    }catch(e){ console.error(e); }
  }
  const recarregarDebounced = debounce(recarregar, 120);

  // ===== Import CSV (staging -> refresh MV) =====
  $("btnImport").onclick = async ()=>{
    const f=$("csvfile").files[0];
    if(!f){ alert("Selecione o Pasta2.csv"); return; }
    const prog=$("prog"); prog.style.display="inline-block"; prog.value=0;

    // 1) TRUNCATE staging via RPC
    await supa.rpc(RPC_RESET);

    // 2) Parse + insert em lotes (aceita ; ou , e data dd/mm/aaaa)
    const parseDate=(s)=>{ if(!s) return null; const t=String(s).trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t; const m=t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m){ return `${m[3]}-${m[2]}-${m[1]}`; } return null; };
    await new Promise((resolve,reject)=>{
      Papa.parse(f,{ header:true, skipEmptyLines:true, dynamicTyping:false, delimiter:"auto",
        complete: async (res)=>{
          try{
            const rows=res.data||[]; const chunk=2000; let done=0;
            for(let i=0;i<rows.length;i+=chunk){
              const slice = rows.slice(i,i+chunk).map(r=>({
                dia: parseDate(r.dia) || parseDate(r["dia"]),
                unidade: r.unidade ?? r["unidade"] ?? null,
                pedidos: Number(r.pedidos||0),
                fat: Number(String(r.fat||"").replace(",",".")||0),
                des: Number(String(r.des||"").replace(",",".")||0),
                fre: Number(String(r.fre||"").replace(",",".")||0),
                "Nome da Loja": r["Nome da Loja"] ?? r["nome_da_loja"] ?? null,
                turno: r.turno ?? null,
                "Canal de venda": r["Canal de venda"] ?? r["canal"] ?? null,
                pagamento: r.pagamento ?? null,
                cancelado: r.cancelado ?? null,
                hora: r.hora===""||r.hora==null? null : Number(r.hora)
              }));
              const ins = await supa.from(STAGING).insert(slice);
              if(ins.error){ console.error(ins.error); throw new Error(ins.error.message); }
              done+=slice.length; prog.value=Math.round(done/rows.length*100);
            }
            resolve();
          }catch(err){ reject(err); }
        },
        error:(err)=>reject(err)
      });
    });

    // 3) REFRESH MV via RPC (sem CONCURRENTLY)
    const ref = await supa.rpc(RPC_REFRESH);
    if(ref.error){ alert("Erro ao atualizar a MV: "+ref.error.message); }

    prog.style.display="none";
    await fetchLimites(); await recarregar();
    alert("Importa√ß√£o conclu√≠da.");
  };

  // ===== Boot =====
  async function boot(){
    await fetchLimites();
    // datas padr√£o (se existir dado)
    if(maxDiaISO){
      const end=parseISO(maxDiaISO), start=addDays(end,-29);
      const s=toISO(start), e=toISO(end); if(s) dini.value=s; if(e) dfim.value=e;
    }
    const opts=await fetchUnidades(); selUni.innerHTML=""; opts.forEach(u=>{ const o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); }); selUni.value="Todas";
    [selUni,dini,dfim,pr,turno,canal,pag,canc].forEach(el=> el.addEventListener("change", ()=>{ $("fx").open=false; recarregarDebounced(); }) );
    await recarregar();
  }

  // start (gate vs app)
  (async ()=>{
    const { data:{ session } } = await supa.auth.getSession();
    if(session){ hideGate(); afterLogin(); } else { showGate(); }
  })();
})();
</script>
</body>
</html>
