<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food — Importador XLSX (1 pedido = 1 linha)</title>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

<style>
  :root{--bg:#0b1220;--card:#121a2b;--muted:#97a3b6;--text:#eaf0ff;--pri:#4f8cff;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--stroke:#1e2a44;--radius:14px}
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto}
  .container{max-width:1100px;margin:28px auto 80px;padding:0 16px}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px;margin-top:14px}
  .row{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .inline{display:flex;gap:10px;align-items:center}
  input,select,button{border:1px solid var(--stroke);background:#0f172a;color:var(--text);border-radius:10px;padding:10px 12px}
  button{background:var(--pri);border:none;cursor:pointer}
  button.ghost{background:#0f172a}
  code,pre{background:#0f172a;border:1px solid var(--stroke);border-radius:10px;padding:10px;display:block;overflow:auto;max-height:300px}
  .pill{border:1px solid var(--stroke);padding:4px 10px;border-radius:999px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .progress{height:16px;background:#0f172a;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#4f8cff,#60a5fa);width:0%}
  .mini{font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Maestro Food — Importador XLSX</h1>
  <div class="muted">1 pedido = 1 linha (sem agregação). Gera <b>dia</b> e <b>hora</b>, normaliza <b>cancelado</b>, e envia para <code>public.vendas_xlsx</code>.</div>

  <div class="card">
    <div class="row cols-2">
      <div>
        <label>Arquivo XLSX</label>
        <input id="file" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
      </div>
      <div>
        <label>Tabela de destino</label>
        <input id="table" type="text" value="vendas_xlsx"/>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:10px">
      <div>
        <label>Supabase URL</label>
        <input id="sbUrl" type="text" value="https://uahmcfzerofhzjvlzrqc.supabase.co"/>
      </div>
      <div>
        <label>Supabase anon key</label>
        <input id="sbKey" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU"/>
      </div>
    </div>

    <div class="inline" style="margin-top:12px;gap:8px;flex-wrap:wrap">
      <button id="btnMap">1) Validar & Mapear XLSX</button>
      <button id="btnImport" class="ghost">2) Importar para o banco</button>
      <button id="btnHealth" class="ghost">Healthcheck</button>
      <span id="status" class="pill mini muted">parado</span>
    </div>

    <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
  </div>

  <div class="card">
    <b>Identificador de colunas</b>
    <pre id="mapOut">—</pre>
  </div>

  <div class="card">
    <b>Preview normalizado (até 10 linhas)</b>
    <pre id="preview">—</pre>
  </div>

  <div class="card">
    <b>Healthcheck</b>
    <div id="hc" class="muted">—</div>
  </div>
</div>

<script>
(function(){
  // ---- helpers visuais
  const el = (id)=>document.getElementById(id);
  const statusEl = el('status'), barEl = el('bar'), mapOut = el('mapOut'), preOut = el('preview'), hcEl = el('hc');

  function setStatus(text, cls=''){
    statusEl.textContent = text;
    statusEl.className = 'pill mini ' + (cls || 'muted');
  }
  function setBar(pct){
    barEl.style.width = Math.max(0, Math.min(100, pct)) + '%';
  }

  // ---- normalizações
  const norm = s => String(s ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

  function parseBRNumber(v){
    if (v==null || v==='') return 0;
    if (typeof v === 'number') return v;
    const s = String(v).replace(/\./g,'').replace(',','.');
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }

  function ddmmyyyyToISO(s){
    if(!s) return null;
    const str = String(s).trim();
    // aceita "dd/mm/aaaa hh:mm" ou "dd/mm/aaaa"
    const [datePart, timePart] = str.split(' ');
    const m = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(!m) return null;
    const d = m[1].padStart(2,'0'), mo = m[2].padStart(2,'0'), y = m[3];
    const iso = `${y}-${mo}-${d}`;
    return timePart ? `${iso}T${timePart}:00` : `${iso}T00:00:00`;
  }

  function dateCellToISO(v){
    // Excel pode vir como Date serial -> SheetJS já converte para JS Date quando cellDates=true
    if (v instanceof Date && !isNaN(v)) {
      const y = v.getFullYear(), m = String(v.getMonth()+1).padStart(2,'0'), d = String(v.getDate()).padStart(2,'0');
      const hh = String(v.getHours()).padStart(2,'0'), mm = String(v.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${d}T${hh}:${mm}:00`;
    }
    // string "dd/mm/aaaa hh:mm" ou "dd/mm/aaaa"
    const s = String(v ?? '').trim();
    if (s.includes('/')) return ddmmyyyyToISO(s);
    // já ISO yyyy-mm-dd
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2}))?/);
    if (m) return `${m[1]}-${m[2]}-${m[3]}T${(m[4]||'00')}:${(m[5]||'00')}:00`;
    return null;
  }

  function hourFromISO(iso){
    if (!iso) return -1;
    const m = iso.match(/T(\d{2}):(\d{2})/);
    if (!m) return -1;
    const h = parseInt(m[1],10);
    return isFinite(h) ? h : -1;
  }

  function deriveTurno(h){
    if (h<0) return null;
    if (h>=6 && h<12) return 'Manhã';
    if (h>=12 && h<18) return 'Tarde';
    if (h>=18 && h<24) return 'Noite';
    return 'Madrugada';
  }

  function normCancel(v){
    const s = String(v ?? '').trim().toLowerCase();
    if (v === true || s==='sim' || s==='s' || s==='1' || s==='true') return 'Sim';
    return 'Não';
  }

  // ---- mapeamento de cabeçalhos
  const MAP = [
    {std:'Pedido',                        list:['pedido','id pedido','id','numero','nº pedido']},
    {std:'Código da loja',                list:['codigo da loja','código da loja','cod loja','codigo_loja','codigodal loja','id loja','loja id']},
    {std:'Nome da loja',                  list:['nome da loja','loja','nome_loja','nomedaloja']},
    {std:'Tipo do pedido',                list:['tipo do pedido','tipo pedido','tipo']},
    {std:'Turno',                         list:['turno','periodo','período','shift']},
    {std:'Canal de venda',                list:['canal de venda','canal','canal venda','canal_venda']},
    {std:'Número do pedido no parceiro',  list:['numero do pedido no parceiro','pedido parceiro','id parceiro','pedido_ifood','numero_ifood']},
    {std:'Data da venda',                 list:['data da venda','data','data venda','datadavenda']},
    {std:'Consumidor',                    list:['consumidor','cliente','nome do cliente']},
    {std:'Tem cupom',                     list:['tem cupom','cupom','possui cupom']},
    {std:'Pagamento',                     list:['pagamento','forma de pagamento','meio de pagamento','payment']},
    {std:'Está cancelado',                list:['esta cancelado','está cancelado','cancelado','cancelada','canceled','cancelled']},
    {std:'Motivo do cancelamento',        list:['motivo do cancelamento','motivo cancelamento']},
    {std:'Itens',                         list:['itens','qtd itens','quantidade itens']},
    {std:'Entrega',                       list:['entrega','frete','shipping','delivery']},
    {std:'Valor Entregador',              list:['valor entregador','repasse entregador']},
    {std:'Entregador',                    list:['entregador','nome do entregador']},
    {std:'Bairro',                        list:['bairro']},
    {std:'CEP',                           list:['cep']},
    {std:'Acréscimo',                     list:['acrescimo','acréscimo','acrescimos']},
    {std:'Motivo de acréscimo',           list:['motivo de acrescimo','motivo acrescimo']},
    {std:'Desconto',                      list:['desconto','descontos','incentivos']},
    {std:'Motivo do desconto',            list:['motivo do desconto']},
    {std:'Total',                         list:['total','faturamento','valor total','valor','total geral']},
    {std:'Total taxa de serviço',         list:['total taxa de servico','taxa de serviço','taxa servico']},
    // aceita também "unidade" se existir como coluna no Excel
    {std:'unidade',                       list:['unidade','filial','uni','unidades']}
  ];

  function buildIndexMap(headers){
    const idx = {};
    headers.forEach((h,i)=>{
      const k = norm(h);
      for (const m of MAP) if (m.list.includes(k)) { idx[m.std] = i; return; }
      // se não casou, tenta match exato pelo próprio nome
      idx[h] ??= i;
    });
    return idx;
  }

  function detectAndReport(headers){
    const idx = buildIndexMap(headers);
    // conjunto de padrões que vamos usar como origem
    const ALL = [
      'Pedido','Código da loja','Nome da loja','Tipo do pedido','Turno','Canal de venda',
      'Número do pedido no parceiro','Data da venda','Consumidor','Tem cupom','Pagamento',
      'Está cancelado','Motivo do cancelamento','Itens','Entrega','Valor Entregador','Entregador',
      'Bairro','CEP','Acréscimo','Motivo de acréscimo','Desconto','Motivo do desconto',
      'Total','Total taxa de serviço','unidade'
    ];
    const detectado = {};
    const faltando = [];
    for (const std of ALL){
      const i = idx[std];
      if (i!=null) detectado[std] = headers[i];
      else {
        // "unidade" pode ser derivada; só marca como faltando para informar
        if (std==='unidade') continue;
        faltando.push(std);
      }
    }
    mapOut.textContent = JSON.stringify({detectado, faltando}, null, 2);
    return {indexMap:idx, faltando};
  }

  // ---- Supabase client (instanciado sob demanda com os inputs)
  function getClient(){
    const url = el('sbUrl').value.trim();
    const key = el('sbKey').value.trim();
    return window.supabase.createClient(url, key, {auth:{persistSession:true,autoRefreshToken:true}});
  }

  // ---- Healthcheck
  async function healthcheck(){
    const sb = getClient();
    const table = el('table').value.trim();
    setStatus('healthcheck...', 'muted');
    try{
      const a = await sb.from(table).select('dia').order('dia',{ascending:true}).limit(1);
      const b = await sb.from(table).select('dia').order('dia',{ascending:false}).limit(1);
      // count exata (usa head:true e count:'exact' sem baixar linhas)
      const c = await sb.from(table).select('dia', {count:'exact', head:true});
      if (a.error && a.error.code==='42P01') {
        hcEl.innerHTML = `<span class="err">Tabela não encontrada:</span> <code>${table}</code>`;
        setStatus('tabela ausente', 'err'); return;
      }
      const min = a.data?.[0]?.dia || null;
      const max = b.data?.[0]?.dia || null;
      const total = c.count ?? 0;
      hcEl.innerHTML = `
        <div>Fonte: <code>${table}</code></div>
        <div>Intervalo no banco: <b>${min||'—'}</b> → <b>${max||'—'}</b></div>
        <div>Total (count exato): <b>${(total||0).toLocaleString('pt-BR')}</b></div>
      `;
      setStatus('ok', 'ok');
    }catch(e){
      console.error(e);
      setStatus('erro hc','err');
      hcEl.textContent = 'Erro no healthcheck: ' + e.message;
    }
  }

  // ---- Leitura do XLSX e normalização
  let previewRows = []; // primeiras 10 linhas normalizadas (para mostrar)
  let totalRows = 0;

  el('btnMap').addEventListener('click', async ()=>{
    const file = el('file').files?.[0];
    if (!file) { alert('Selecione um .xlsx'); return; }

    setBar(0); setStatus('lendo xlsx...', 'muted');
    previewRows = []; totalRows = 0;

    try{
      const data = await file.arrayBuffer();
      // lê workbook (cellDates:true preserva Date)
      const wb = XLSX.read(data, {type:'array', cellDates:true});
      const ws = wb.Sheets[wb.SheetNames[0]];
      // cabeçalhos (linha 1)
      const aoa = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false});
      if (!aoa.length){ setStatus('planilha vazia','warn'); return; }
      const headers = aoa[0].map(x=> String(x??'').trim());
      const {indexMap} = detectAndReport(headers);

      // Preview (primeiras até 10 linhas normalizadas)
      const MAX_PRE = Math.min(10, aoa.length-1);
      const rows = [];
      for (let r=1; r<=MAX_PRE; r++){
        const row = aoa[r] || [];
        rows.push( normalizeRow(row, indexMap) );
      }
      previewRows = rows;
      preOut.textContent = JSON.stringify(previewRows, null, 2);
      totalRows = aoa.length-1;
      setStatus(`mapeado (${totalRows.toLocaleString('pt-BR')} linhas)`, 'ok');
      setBar(15);
    }catch(e){
      console.error(e);
      setStatus('erro ao ler xlsx','err');
      alert('Erro ao ler XLSX: ' + e.message);
    }
  });

  function normalizeRow(row, idx){
    // Origem
    const v = (name)=> {
      const i = idx[name];
      return (i!=null) ? row[i] : '';
    };

    // Data/hora
    const iso = dateCellToISO( v('Data da venda') );
    const dia = iso ? iso.slice(0,10) : null;
    const hora = hourFromISO(iso);

    // Unidade: prioridade unidade -> Código da loja -> Nome da loja
    let unidade = String( v('unidade') || v('Código da loja') || v('Nome da loja') || '' ).trim();
    if (!unidade) unidade = 'UNDEF';

    // Turno: usa planilha, senão deriva pela hora
    let turn = String(v('Turno')||'').trim() || deriveTurno(hora);

    // Cancelado
    const cancelado = normCancel( v('Está cancelado') );

    // Campos numéricos
    const fat = parseBRNumber( v('Total') );
    const des = parseBRNumber( v('Desconto') );
    const fre = parseBRNumber( v('Entrega') );

    // Pagamento e Canal
    const pagamento = String( v('Pagamento') || '' ).trim();
    const canal = String( v('Canal de venda') || '' ).trim();

    // Nome da loja
    const loja = String( v('Nome da loja') || '' ).trim();

    return {
      dia, unidade, pedidos: 1,
      fat, des, fre,
      "Nome da loja": loja || null,
      turno: turn || null,
      "Canal de venda": canal || null,
      pagamento: pagamento || null,
      cancelado,
      hora
    };
  }

  // ---- Importação em lotes
  el('btnImport').addEventListener('click', async ()=>{
    const file = el('file').files?.[0];
    if (!file) { alert('Selecione um .xlsx'); return; }

    const sb = getClient();
    const table = el('table').value.trim();
    setStatus('lendo xlsx...', 'muted'); setBar(0);

    try{
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, {type:'array', cellDates:true});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false});

      if (aoa.length<=1){ setStatus('sem linhas','warn'); return; }
      const headers = aoa[0].map(x=> String(x??'').trim());
      const {indexMap} = detectAndReport(headers);

      const BATCH = 1000;           // tamanho do envio
      const STEPS = Math.ceil((aoa.length-1)/BATCH);
      let sent = 0, errs = 0;

      for (let step=0; step<STEPS; step++){
        const start = 1 + step*BATCH;
        const end   = Math.min(aoa.length-1, start+BATCH-1);
        const pack = [];
        for (let r=start; r<=end; r++){
          const row = aoa[r] || [];
          const n = normalizeRow(row, indexMap);
          // valida mínimos
          if (n.dia && n.unidade && isFinite(n.fat)) pack.push(n);
        }
        if (pack.length){
          const {error} = await sb.from(table).insert(pack);
          if (error) { console.error(error); errs += pack.length; }
          else sent += pack.length;
        }
        setStatus(`importando... ${sent.toLocaleString('pt-BR')} ok / ${errs} erros`, 'warn');
        setBar( Math.round((step+1)/STEPS*100) );
        // respiro
        await new Promise(r=>setTimeout(r, 10));
      }

      setStatus(`concluído: ${sent.toLocaleString('pt-BR')} ok, ${errs} erros`, errs? 'warn':'ok');
      await healthcheck();
    }catch(e){
      console.error(e);
      setStatus('falhou','err');
      alert('Erro durante importação: ' + e.message);
    }
  });

  // ---- Healthcheck botão
  el('btnHealth').addEventListener('click', healthcheck);
})();
</script>
</body>
</html>
