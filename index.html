<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — Filtros (v2.1 CFO — ETAPA 2)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="28" fill="%231a73e8"/><text x="64" y="80" text-anchor="middle" font-family="Arial" font-size="60" fill="white">CFO</text></svg>'/>
<style>
  :root{--bg:#0b1220;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--acc:#22c55e;--err:#ef4444;--warn:#f59e0b;--line:#1f2937}
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 4px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--text)}
  .btn{background:var(--acc);border:none;color:#0b1220;font-weight:600;cursor:pointer}
  .btn.ghost{background:#1f2937;color:#cbd5e1}
  .btn.warn{background:var(--warn);color:#0b1220}
  .btn.err{background:var(--err);color:#fff}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi .box{background:#0f172a;border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .big{font-size:18px;font-weight:700}
  pre{white-space:pre-wrap;background:#0f172a;color:#d6e3ff;border-radius:10px;padding:10px;overflow:auto;border:1px solid var(--line);max-height:320px}
  .ok{color:#22c55e}.warn{color:var(--warn)}.err{color:var(--err)}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid var(--line);color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Dashboard Vendas — Filtros <span class="badge">v2.1 CFO — ETAPA 2</span></h1>
  <div class="muted">Filtros rápidos + Quadro de Resumo (linhas brutas × canônicas × duplicatas) + KPIs por dia + Amostra e Top Duplicatas.</div>

  <div class="card" style="margin-top:12px;">
    <div class="row cols-4">
      <div>
        <label>Data Inicial</label>
        <input id="dini" type="date"/>
      </div>
      <div>
        <label>Data Final</label>
        <input id="dfim" type="date"/>
      </div>
      <div>
        <label>Unidade(s)</label>
        <select id="unidades" multiple size="4"></select>
      </div>
      <div>
        <label>Canal(is)</label>
        <select id="canais" multiple size="4"></select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px;">
      <div>
        <label>Pagamento(s)</label>
        <select id="pagamentos" multiple size="4"></select>
      </div>
      <div>
        <label>Cancelado</label>
        <select id="cancelado">
          <option value="">Todos</option>
          <option value="Não" selected>Não</option>
          <option value="Sim">Sim</option>
        </select>
      </div>
      <div>
        <label>Loja (texto contém)</label>
        <input id="loja" placeholder="ex.: Vista, Bistrô..."/>
      </div>
    </div>
    <div class="inline" style="margin-top:10px;">
      <button id="btnAplicar" class="btn">Aplicar filtros</button>
      <button id="btnAmostra" class="btn ghost">Ver amostra (20)</button>
      <button id="btnTopDups" class="btn ghost">Top duplicatas (30)</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <b>Quadro Resumo — Linhas filtradas</b>
    <div class="kpi" style="margin-top:8px;">
      <div class="box">
        <div class="label">Brutas</div>
        <div id="q_brutas" class="big">-</div>
      </div>
      <div class="box">
        <div class="label">Canônicas (DISTINCT)</div>
        <div id="q_canon" class="big">-</div>
      </div>
      <div class="box">
        <div class="label">Duplicatas (Brutas - Canon)</div>
        <div id="q_dups" class="big">-</div>
      </div>
      <div class="box">
        <div class="label">% Duplicatas</div>
        <div id="q_perc" class="big">-</div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="kpi">
      <div class="box">
        <div class="label">Pedidos (total)</div>
        <div id="k_ped" class="big">-</div>
      </div>
      <div class="box">
        <div class="label">Faturamento (total)</div>
        <div id="k_fat" class="big">-</div>
      </div>
      <div class="box">
        <div class="label">Descontos (total)</div>
        <div id="k_des" class="big">-</div>
      </div>
      <div class="box">
        <div class="label">Frete (total)</div>
        <div id="k_fre" class="big">-</div>
      </div>
    </div>
  </div>

  <div class="card">
    <b>Resultado (lista/Amostra/Top dups)</b>
    <pre id="out">(vazio)</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>

<script>
/** ====== CONFIG (ajuste se trocar credenciais) ====== **/
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);

/** ====== HELPERS ====== **/
function fmt(n,dec=0){
  if(n==null || !isFinite(n)) return '-';
  return Number(n).toLocaleString('pt-BR',{minimumFractionDigits:dec, maximumFractionDigits:dec});
}
function arr(sel){
  return Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
}
function saveState(){
  const S = {
    dini: $('dini').value, dfim: $('dfim').value,
    unids: arr($('unidades')),
    canais: arr($('canais')),
    pags: arr($('pagamentos')),
    cancelado: $('cancelado').value,
    loja: $('loja').value
  };
  localStorage.setItem('cfo_filtros_v21', JSON.stringify(S));
}
function loadState(){
  const raw = localStorage.getItem('cfo_filtros_v21');
  if(!raw) return;
  try{
    const S = JSON.parse(raw);
    $('dini').value = S.dini || $('dini').value;
    $('dfim').value = S.dfim || $('dfim').value;
    for(const id of ['unidades','canais','pagamentos']){
      const sel = $(id);
      for(const o of sel.options){ o.selected = (S[id==='unidades'?'unids':id].||[]).includes(o.value); }
    }
    $('cancelado').value = S.cancelado || $('cancelado').value;
    $('loja').value = S.loja || '';
  }catch(e){}
}
function setStatus(t,cls){ const el=$('status'); el.textContent=t; el.className=cls||'muted'; }

/** ====== LOAD OPTIONS ====== **/
async function loadOptions(){
  setStatus('Carregando opções…');
  // daterange
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  let min='2021-01-01', max=(new Date()).toISOString().slice(0,10);
  if(!dr.error && dr.data?.length){
    min = dr.data[0].min_dia; max = dr.data[0].max_dia;
  }
  $('dini').value = min;
  $('dfim').value = max;

  // listas
  const u = await supa.from('vw_vendas_unidades').select('unidade');
  const c = await supa.from('vw_vendas_canais').select('canal');
  const p = await supa.from('vw_vendas_pagamentos').select('pagamento_base');

  function fill(selId, rows, key){
    const sel = $(selId); sel.innerHTML='';
    (rows?.data||[]).forEach(r=>{
      const v = r[key]; if(!v) return;
      const opt = document.createElement('option'); opt.value=v; opt.textContent=v; sel.appendChild(opt);
    });
  }
  fill('unidades', u, 'unidade');
  fill('canais', c, 'canal');
  fill('pagamentos', p, 'pagamento_base');

  setStatus('Opções carregadas.','ok');
}

/** ====== PARAMS ====== **/
function params(){
  const p = {
    p_dini: $('dini').value,
    p_dfim: $('dfim').value,
    p_unids: arr($('unidades')),
    p_canais: arr($('canais')),
    p_pags: arr($('pagamentos')),
    p_loja: $('loja').value.trim() || null,
    p_cancelado: $('cancelado').value || null
  };
  if(!p.p_unids.length) p.p_unids = null;
  if(!p.p_canais.length) p.p_canais = null;
  if(!p.p_pags.length)   p.p_pags   = null;
  return p;
}

/** ====== AÇÕES ====== **/
async function aplicar(){
  try{
    setStatus('Consultando KPIs e Resumo…');
    saveState();

    const p = params();

    // Resumo (linhas brutas × canônicas × duplicatas)
    const rsum = await supa.rpc('resumo_vendas', p);
    if(rsum.error) throw rsum.error;
    const R = rsum.data?.[0] || {};
    $('q_brutas').textContent = fmt(R.brutas);
    $('q_canon').textContent  = fmt(R.canon);
    $('q_dups').textContent   = fmt(R.duplicatas);
    $('q_perc').textContent   = (R.perc_dup==null? '-' : (R.perc_dup.toFixed(2)+' %'));

    // KPI por dia → somatório
    const rkpi = await supa.rpc('kpi_vendas', p);
    if(rkpi.error) throw rkpi.error;
    let ped=0, fat=0, des=0, fre=0;
    for(const row of (rkpi.data||[])){ ped += Number(row.pedidos||0); fat += Number(row.fat||0); des += Number(row.des||0); fre += Number(row.fre||0); }
    $('k_ped').textContent = fmt(ped);
    $('k_fat').textContent = 'R$ '+fmt(fat,2);
    $('k_des').textContent = 'R$ '+fmt(des,2);
    $('k_fre').textContent = 'R$ '+fmt(fre,2);

    setStatus('OK. Use “Ver amostra” ou “Top duplicatas”.','ok');
    $('out').textContent = JSON.stringify((rkpi.data||[]).slice(-10), null, 2); // mostra os últimos 10 dias p/ referência
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

async function amostra(){
  try{
    setStatus('Buscando amostra…');
    const r = await supa.rpc('amostra_vendas', params());
    if(r.error) throw r.error;
    $('out').textContent = JSON.stringify(r.data||[], null, 2);
    setStatus('Amostra pronta.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

async function topdups(){
  try{
    setStatus('Buscando top duplicatas…');
    const p = params(); p.p_limit = 30;
    const r = await supa.rpc('top_dups_vendas', p);
    if(r.error) throw r.error;
    $('out').textContent = JSON.stringify(r.data||[], null, 2);
    setStatus('Top duplicatas pronto.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

/** ====== INIT ====== **/
document.getElementById('btnAplicar').addEventListener('click', aplicar);
document.getElementById('btnAmostra').addEventListener('click', amostra);
document.getElementById('btnTopDups').addEventListener('click', topdups);

loadOptions().then(()=>{ 
  // carrega estado salvo e aplica no primeiro load
  const raw = localStorage.getItem('cfo_filtros_v21');
  if(raw){ try{ const S = JSON.parse(raw); $('dini').value=S.dini||$('dini').value; $('dfim').value=S.dfim||$('dfim').value; }catch(e){} }
  aplicar();
});
</script>
</body>
</html>
