<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon inline (evita 404) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72"><rect width="72" height="72" rx="14" fill="%232563eb"/><path d="M22 40c10 0 10-8 20-8 6 0 8 4 8 8 0 8-8 16-18 16S14 52 14 44c0-8 6-12 8-12" fill="white" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>'>
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#f4f6fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --pri:#2563eb; --pri-600:#1d4ed8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
    h1{margin:0 0 2px;font-size:22px}
    .muted{color:var(--muted)}
    .toolbar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:10px}
    .filters{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px}
    .grid{display:grid;gap:10px}
    .g12{grid-template-columns:repeat(12,1fr)}
    .c12{grid-column:span 12}.c6{grid-column:span 6}.c4{grid-column:span 4}.c3{grid-column:span 3}.c2{grid-column:span 2}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    select,input{width:100%;padding:10px;border:1px solid var(--brd);background:#fff;border-radius:10px;font:inherit}
    .btn{border:0;background:var(--pri);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:#fff;color:var(--fg);border:1px solid var(--brd)}
    .right{margin-left:auto}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin-top:12px}
    .kpi .t{font-size:12px;color:var(--muted)} .kpi .v{font-size:22px;font-weight:700;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--brd);border-radius:999px;padding:6px 10px;background:#fff}
    .status{font-size:12px;color:var(--muted)}
    .chartbox{height:360px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .ok{color:#16a34a}.err{color:#b91c1c}
    @media (max-width:980px){ .kpis{grid-template-columns:repeat(2,1fr)} .g12{grid-template-columns:repeat(6,1fr)} }
    @media (max-width:560px){ .kpis{grid-template-columns:1fr} .g12{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <button id="btnClear" class="badge">Limpar</button>
    </div>

    <!-- FILTROS -->
    <div class="filters">
      <div class="grid g12">
        <div class="c6">
          <label>Unidade</label>
          <select id="uni"></select>
        </div>
        <div class="c6">
          <label>Nome da loja (Top 10)</label>
          <select id="loja"></select>
        </div>

        <div class="c3">
          <label>De</label>
          <input id="dini" type="date" />
        </div>
        <div class="c3">
          <label>Até</label>
          <input id="dfim" type="date" />
        </div>
        <div class="c3">
          <label>Período rápido</label>
          <select id="pr">
            <option value="7">Últimos 7</option>
            <option value="15">Últimos 15</option>
            <option value="30">Últimos 30</option>
            <option value="90" selected>Últimos 90</option>
            <option value="180">Últimos 180</option>
          </select>
        </div>
        <div class="c3">
          <label>Turno</label>
          <select id="turno">
            <option value="Todos" selected>Todos</option>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>

        <div class="c4">
          <label>Canal de venda</label>
          <select id="canal"></select>
        </div>
        <div class="c4">
          <label>Pagamento</label>
          <select id="pag"></select>
        </div>
        <div class="c4">
          <label>Está cancelado?</label>
          <select id="canc">
            <option value="Todos" selected>Todos</option>
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>

        <div class="c12 card" style="border-style:dashed">
          <b>Admin — Importar CSV (<i>Pasta2.csv</i>)</b>
          <div class="row" style="margin-top:8px">
            <input type="file" id="csv" accept=".csv" />
            <button class="btn" id="import">Importar CSV</button>
            <span class="status" id="status"></span>
          </div>
          <div class="hint">Importação é somativa com deduplicação por (dia, unidade, "Nome da loja", hora, pagamento, "Canal de venda").</div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="card kpi"><div class="t">Pedidos</div><div class="v" id="k_ped">—</div></div>
      <div class="card kpi"><div class="t">Ticket Médio</div><div class="v" id="k_tkm">—</div></div>
      <div class="card kpi"><div class="t">Faturamento</div><div class="v" id="k_fat">—</div></div>
      <div class="card kpi"><div class="t">Faturamento Médio (dia)</div><div class="v" id="k_fmd">—</div></div>
    </div>

    <!-- GRÁFICO -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="t" style="font-weight:600">Receita diária</div>
        <span class="badge" id="modeBtn">Total</span>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__MAESTRO_BOOT__) return; window.__MAESTRO_BOOT__ = true;

  // ====== CONFIG ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtINT = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Number(n)||0);

  // ====== UI refs ======
  const dini = document.getElementById("dini");
  const dfim = document.getElementById("dfim");
  const pr   = document.getElementById("pr");
  const uni  = document.getElementById("uni");
  const loja = document.getElementById("loja");
  const turno= document.getElementById("turno");
  const canal= document.getElementById("canal");
  const pag  = document.getElementById("pag");
  const canc = document.getElementById("canc");
  const statusEl = document.getElementById("status");
  const periodoEl = document.getElementById("periodo");
  const btnClear = document.getElementById("btnClear");

  // ====== Estado global ======
  let minISO = null, maxISO = null;
  let chartLine = null;
  let showAvg = false;

  // ====== Helpers ======
  const safeISO = d => { try{ if(!d) return null; const x = new Date(d+"T00:00:00"); if (isNaN(x)) return null; return x.toISOString().slice(0,10);}catch(_){return null;} };
  const addDays = (iso, d) => { const x = new Date(iso+"T00:00:00"); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); };
  const setStatus = (msg,ok) => { statusEl.textContent = msg||""; statusEl.className="status "+(ok===true?"ok":ok===false?"err":""); if(ok===true) setTimeout(()=>statusEl.textContent="",3000); };
  const numberFromBR = (s) => {
    if (s===undefined||s===null||s==="") return 0;
    if (typeof s === "number") return s;
    s = String(s).trim();
    // remove espaços e símbolos
    s = s.replace(/[R$\s]/g,"");
    // se tem vírgula como decimal
    if (s.indexOf(",") >= 0) {
      s = s.replace(/\./g,"").replace(",",".");
    }
    return Number(s)||0;
  };

  function sanitizeHeader(h){
    return String(h||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().trim()
      .replace(/\s+/g," ");
  }

  function guessCols(headers){
    const H = headers.map(sanitizeHeader);
    const find = (...alts)=> {
      for(const a of alts){ const i=H.indexOf(a); if(i>=0) return headers[i]; }
      return null;
    };
    // Map flexível
    return {
      dia: find("data da venda","data","dia","data do pedido"),
      hora: find("hora","horario","hora da venda"),
      unidade: find("unidade","filial"),
      loja: find("nome da loja","loja","pdv"),
      turno: find("turno","periodo"),
      canal: find("canal de venda","canal","origem"),
      pagamento: find("pagamento","forma de pagamento","meio de pagamento"),
      cancelado: find("esta cancelado","cancelado","status cancelado"),
      fat: find("total","valor total","faturamento","receita","valor"),
      des: find("desconto","descontos","incentivos","incentivo"),
      fre: find("entrega","frete","taxa de entrega"),
      pedidos: find("pedidos","quantidade","qtd")
    };
  }

  // ====== Importação CSV (somativa com dedup local) ======
  document.getElementById("import").addEventListener("click", async ()=>{
    const f = document.getElementById("csv").files[0];
    if(!f){ setStatus("Selecione o arquivo CSV.", false); return; }
    setStatus("Lendo arquivo…");
    Papa.parse(f, {
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        try{
          const rows = res.data || [];
          if(rows.length===0){ setStatus("Arquivo vazio.", false); return; }
          // Descobrir mapeamento
          const cols = guessCols(res.meta.fields||[]);
          if(!cols.dia || !cols.unidade || !cols.fat){
            setStatus("Colunas obrigatórias não encontradas (mínimo: data/unidade/total).", false); return;
          }
          // Agrega por chave para evitar ON CONFLICT twice
          const acc = new Map();
          let minFile=null, maxFile=null;
          const get = (r,c) => r[c] ?? r[c?.toLowerCase()] ?? r[c?.toUpperCase()];

          for(const r of rows){
            // Data e hora
            let iso=null, hour=null;
            const rawData = (get(r, cols.dia)||"").toString().trim();
            if (/^\d{2}\/\d{2}\/\d{4}/.test(rawData)) {
              const [dd,mm,yy] = rawData.slice(0,10).split("/");
              iso = safeISO(`${yy}-${mm}-${dd}`);
            } else {
              iso = safeISO(rawData);
            }
            // Hora (opcional)
            if (cols.hora) {
              const hv = String(get(r, cols.hora)||"").trim();
              const m = hv.match(/(\d{1,2})/);
              hour = m ? Math.min(23, Math.max(0, Number(m[1])||0)) : null;
            } else {
              hour = null;
            }
            if(!iso) continue; // pulo linhas sem data válida
            minFile = !minFile ? iso : (iso<minFile?iso:minFile);
            maxFile = !maxFile ? iso : (iso>maxFile?iso:maxFile);

            const out = {
              dia: iso,
              unidade: String(get(r, cols.unidade)||"").trim()||"—",
              pedidos: cols.pedidos ? (Number(get(r, cols.pedidos))||0) : 1,
              fat: numberFromBR(get(r, cols.fat)),
              des: cols.des ? numberFromBR(get(r, cols.des)) : 0,
              fre: cols.fre ? numberFromBR(get(r, cols.fre)) : 0,
              ["Nome da loja"]: cols.loja ? String(get(r, cols.loja)||"").trim() : null,
              turno: cols.turno ? String(get(r, cols.turno)||"").trim() : null,
              ["Canal de venda"]: cols.canal ? String(get(r, cols.canal)||"").trim() : null,
              pagamento: cols.pagamento ? String(get(r, cols.pagamento)||"").trim() : null,
              cancelado: (function(){
                if(!cols.cancelado) return "Não";
                const v = String(get(r, cols.cancelado)||"").toLowerCase();
                return /sim|true|1|cancel/i.test(v) ? "Sim" : "Não";
              })(),
              hora: hour
            };
            const key = [
              out.dia, out.unidade,
              out["Nome da loja"]||"", out.hora==null?"":out.hora,
              out.pagamento||"", out["Canal de venda"]||""
            ].join("§");
            if(!acc.has(key)){
              acc.set(key, {...out});
            }else{
              const a = acc.get(key);
              a.pedidos += out.pedidos;
              a.fat     += out.fat;
              a.des     += out.des;
              a.fre     += out.fre;
            }
          }

          const payload = Array.from(acc.values());
          if(payload.length===0){ setStatus("Nada para importar (linhas inválidas).", false); return; }

          // upsert em lotes
          setStatus("Enviando ("+payload.length.toLocaleString("pt-BR")+" linhas) …");
          const chunk = 1200;
          for(let i=0;i<payload.length;i+=chunk){
            const slice = payload.slice(i, i+chunk);
            const { error } = await supa.from(TABLE).upsert(slice, {
              onConflict: 'dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"'
            });
            if(error){ setStatus("Erro ao inserir: "+error.message, false); return; }
          }
          setStatus("Importado.", true);
          await refreshLimits(); // atualiza min/max
          await reload();        // recarrega dados
        }catch(err){
          setStatus("Erro: "+(err.message||err), false);
        }
      },
      error: (e)=> setStatus("Erro CSV: "+(e.message||e), false)
    });
  });

  // ====== Limpar ======
  btnClear.addEventListener("click", ()=>{
    uni.value="Todas"; loja.value="Todas"; turno.value="Todos"; canal.value="Todos"; pag.value="Todos"; canc.value="Todos";
    if (maxISO) {
      dfim.value = maxISO;
      dini.value = addDays(maxISO, - (Number(pr.value)||90) + 1);
    } else {
      dini.value=""; dfim.value="";
    }
    reload();
  });

  // ====== Listas de opções (paginado, tabela inteira) ======
  async function loadDistinct(col, targetSelect, includeAll=true){
    const set = new Set();
    let from = 0, page = 1000;
    for(;;){
      const { data, error } = await supa.from(TABLE).select(col).order(col, { ascending:true }).range(from, from+page-1);
      if(error) break;
      (data||[]).forEach(r=>{ const v=r[col]; if(v!==null && v!==undefined && String(v).trim()!=="") set.add(String(v)); });
      if(!data || data.length < page) break;
      from += page; if(from > 500000) break;
    }
    targetSelect.innerHTML = "";
    if(includeAll){
      const o = document.createElement("option"); o.value="Todos"; o.textContent="Todos"; targetSelect.appendChild(o);
    }
    Array.from(set).sort((a,b)=> a.localeCompare(b,'pt-BR')).forEach(v=>{
      const o = document.createElement("option"); o.value=v; o.textContent=v; targetSelect.appendChild(o);
    });
  }

  // ====== Limites de data ======
  async function refreshLimits(){
    const m1 = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const m2 = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO = (m1.data&&m1.data[0]&&m1.data[0].dia)||null;
    maxISO = (m2.data&&m2.data[0]&&m2.data[0].dia)||null;

    if (maxISO && !dfim.value) dfim.value = maxISO;
    if (maxISO && !dini.value) dini.value = addDays(maxISO, -(Number(pr.value)||90) + 1);

    if (minISO && maxISO) {
      dini.min=minISO; dfim.min=minISO; dini.max=maxISO; dfim.max=maxISO;
    }
  }

  // ====== Carrega filtros base ======
  async function bootFilters(){
    // opções
    await loadDistinct("unidade", uni, true);
    await loadDistinct('"Canal de venda"', canal, true);
    await loadDistinct("pagamento", pag, true);
    uni.value="Todas"; canal.value="Todos"; pag.value="Todos";

    // lojas — modo Top 10 do período atual (e com "Todas")
    loja.innerHTML = "";
    const oAll = document.createElement("option"); oAll.value="Todas"; oAll.textContent="Todas"; loja.appendChild(oAll);
    const top = await top10Lojas(dini.value || minISO || "2021-01-01", dfim.value || maxISO || "2099-12-31", uni.value);
    top.forEach(n=>{
      const o=document.createElement("option"); o.value=n; o.textContent=n; loja.appendChild(o);
    });
    loja.value = "Todas";
  }

  async function top10Lojas(startISO, endISO, unidadeVal){
    let from=0, page=2000, map=new Map();
    for(;;){
      let q = supa.from(TABLE).select('dia,fat,"Nome da loja",unidade').gte("dia", startISO).lte("dia", endISO).range(from, from+page-1);
      if(unidadeVal && unidadeVal!=="Todas") q = q.eq("unidade", unidadeVal);
      const { data, error } = await q;
      if(error) break;
      (data||[]).forEach(r=>{
        const n = r["Nome da loja"]; if(!n) return;
        map.set(n, (map.get(n)||0) + Number(r.fat||0));
      });
      if(!data || data.length<page) break;
      from += page; if(from>500000) break;
    }
    return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
  }

  // ====== Consulta principal ======
  async function fetchPaged(startISO, endISO){
    const fields = 'dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora';
    let from=0, page=2000, out=[];
    for(;;){
      let q = supa.from(TABLE).select(fields).order("dia", { ascending:true }).range(from, from+page-1);
      if (startISO) q = q.gte("dia", startISO);
      if (endISO)   q = q.lte("dia", endISO);

      if (uni.value && uni.value!=="Todas") q = q.eq("unidade", uni.value);
      if (loja.value && loja.value!=="Todas") q = q.eq("Nome da loja", loja.value);
      if (turno.value && turno.value!=="Todos") q = q.eq("turno", turno.value);
      if (canal.value && canal.value!=="Todos") q = q.eq("Canal de venda", canal.value);
      if (pag.value && pag.value!=="Todos")     q = q.eq("pagamento", pag.value);
      if (canc.value && canc.value!=="Todos")   q = q.eq("cancelado", canc.value);

      const { data, error } = await q;
      if(error){ throw error; }
      out = out.concat(data||[]);
      if(!data || data.length<page) break;
      from += page; if(from>500000) break;
    }
    return out;
  }

  function drawLine(labels, values){
    if (chartLine) { try{chartLine.destroy();}catch(_){ } }
    const ctx = document.getElementById("cLine").getContext("2d");
    chartLine = new window.Chart(ctx, {
      type:"line",
      data:{ labels, datasets:[ { data: values, borderWidth:2, pointRadius:0, tension:0.2 } ] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function computeAndRender(rows){
    // KPIs
    const byDay = new Map();
    let ped=0, fat=0, des=0, fre=0;
    rows.forEach(r=>{
      ped += Number(r.pedidos||0);
      fat += Number(r.fat||0);
      des += Number(r.des||0);
      fre += Number(r.fre||0);
      const d = r.dia;
      byDay.set(d, (byDay.get(d)||0) + Number(r.fat||0));
    });
    const days = Array.from(byDay.keys()).sort();
    const vals = days.map(d=>byDay.get(d)||0);

    // média 7d (toggle pelo “badge”)
    let line = vals;
    if (showAvg){
      let acc=0, out=[]; for(let i=0;i<vals.length;i++){ acc+=vals[i]; if(i>=7) acc-=vals[i-7]; out.push( acc / Math.min(i+1,7) ); }
      line = out;
    }

    // Render
    document.getElementById("k_ped").textContent = fmtINT(ped);
    document.getElementById("k_tkm").textContent = fmtBRL(ped>0? fat/ped : 0);
    document.getElementById("k_fat").textContent = fmtBRL(fat);
    const diasDistinct = days.length || 1;
    document.getElementById("k_fmd").textContent = fmtBRL(fat/diasDistinct);

    drawLine(days, line);
  }

  async function reload(){
    // datas seguras
    let s = safeISO(dini.value); let e = safeISO(dfim.value);
    if (!s || !e) {
      if (maxISO) {
        e = maxISO;
        s = addDays(maxISO, -(Number(pr.value)||90) + 1);
        dfim.value = e; dini.value = s;
      }
    }
    periodoEl.textContent = "Período: "+(s||"—")+" → "+(e||"—");
    try{
      const rows = await fetchPaged(s, e);
      computeAndRender(rows);
    }catch(err){
      setStatus("Falha ao carregar: "+(err.message||err), false);
    }
  }

  // ====== Eventos ======
  [dini, dfim, pr, uni, loja, turno, canal, pag, canc].forEach(el=>{
    el.addEventListener("change", async ()=>{
      if (el===pr && maxISO){ // ajustar período rápido
        dfim.value = maxISO;
        dini.value = addDays(maxISO, -(Number(pr.value)||90) + 1);
        // ao mudar o período, recarregar Top10 de lojas:
        await bootFilters(); // repopula loja com novo top10 mantendo “Todas”
      }
      reload();
    });
  });

  document.getElementById("modeBtn").addEventListener("click", ()=>{
    showAvg = !showAvg;
    document.getElementById("modeBtn").textContent = showAvg? "Média (7d)" : "Total";
    reload();
  });

  // ====== Init ======
  (async function init(){
    await refreshLimits();
    await bootFilters();
    await reload();
  })();

})();
</script>
</body>
</html>
