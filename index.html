<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dash Vendas – filtros (fix distinct + fallback)</title>
<style>
  :root{--bg:#0b0f14;--card:#121923;--muted:#94a3b8;--fg:#e2e8f0;--pri:#22c55e;--warn:#f59e0b;--err:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #1f2937;background:#0d141d;position:sticky;top:0;z-index:2}
  header h1{font-size:16px;margin:0;font-weight:600} header .ok{color:var(--pri)} header .bad{color:var(--err)}
  .wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px}
  .pad{padding:14px}
  .filters h3{margin:0 0 8px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  label{font-size:12px;color:var(--muted)}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #233042;background:#0f1722;color:var(--fg)}
  button{cursor:pointer} button.primary{background:var(--pri);border-color:#16a34a;color:#06220f;font-weight:600}
  .row{display:flex;gap:8px}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:12px}
  .kpi{padding:14px;border-radius:12px;background:#0e1620;border:1px solid #223047}
  .kpi .lab{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .kpi .val{font-size:22px;font-weight:700;margin-top:6px}
  .kpi small{color:var(--muted)}
  .charts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  canvas{width:100%;height:280px;background:#0b1018;border-radius:12px;border:1px solid #223047}
  details.debug{white-space:pre-wrap}
  .muted{color:var(--muted)}
  .note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Dashboard de Vendas</h1>
  <span id="ping" class="muted">Conectando…</span>
</header>

<div class="wrap">
  <!-- FILTROS -->
  <div class="card filters pad">
    <h3>Período</h3>
    <div class="grid2">
      <div><label>De</label><input type="date" id="dini"></div>
      <div><label>Até</label><input type="date" id="dfim"></div>
    </div>

    <h3 style="margin-top:16px">Filtros</h3>
    <div style="display:grid;gap:8px">
      <div><label>Unidades</label><select id="ms-unids" multiple size="6"></select></div>
      <div><label>Lojas</label><select id="ms-lojas" multiple size="8"></select></div>
      <div><label>Turnos</label><select id="ms-turnos" multiple size="5"></select></div>
      <div><label>Canais</label><select id="ms-canais" multiple size="6"></select></div>
      <div><label>Pagamentos</label><select id="ms-pags" multiple size="8"></select></div>
      <div><label>Cancelado</label>
        <select id="ms-cancel" multiple size="3">
          <option value="">Todos</option>
          <option>Não</option>
          <option>Sim</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="btn-aplicar" class="primary">Aplicar filtros</button>
      <button id="btn-limpar"  title="Limpa apenas seleções (mantém datas)">Limpar</button>
    </div>

    <p class="note" style="margin-top:12px">
      • <b>Lojas</b> usa a coluna <code>loja</code> da view <code>vw_vendas</code> (confirmado).<br/>
      • As listas abaixo são recarregadas pelo período (somente datas).
    </p>
  </div>

  <!-- KPI + GRÁFICOS + DEBUG -->
  <div class="col">
    <div class="card pad">
      <div class="kpis">
        <div class="kpi"><div class="lab">Pedidos</div><div id="k_ped" class="val">–</div></div>
        <div class="kpi"><div class="lab">Faturamento</div><div id="k_fat" class="val">–</div><small id="k_fat_sm"></small></div>
        <div class="kpi"><div class="lab">Descontos</div><div id="k_des" class="val">–</div></div>
        <div class="kpi"><div class="lab">Frete</div><div id="k_fre" class="val">–</div></div>
      </div>
    </div>

    <div class="charts">
      <div class="card pad"><h3>Faturamento por Dia da Semana</h3><canvas id="c_dow"></canvas></div>
      <div class="card pad"><h3>Faturamento por Mês</h3><canvas id="c_mes"></canvas></div>
      <div class="card pad"><h3>Faturamento por Hora</h3><canvas id="c_hora"></canvas></div>
      <div class="card pad"><h3>Faturamento por Turno</h3><canvas id="c_turno"></canvas></div>
    </div>

    <details class="card debug pad" style="margin-top:12px" open>
      <summary>Debug</summary>
      <pre id="dbg">Preparando…</pre>
    </details>
  </div>
</div>

<script type="module">
/** ====== CONFIG ====== **/
const SUPABASE_URL      = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const READ_VIEW = "vw_vendas";
const RPC = {
  kpi_v2:   "kpi_vendas_v2",
  dow_v2:   "chart_vendas_dow_v2",
  mes_v2:   "chart_vendas_mes_v2",
  hora_v3:  "chart_vendas_hora_v3",
  hora_v2:  "chart_vendas_hora_v2",
  turno_v2: "chart_vendas_turno_v2"
};

// ====== helpers ======
const $ = s => document.querySelector(s);
const dbg = (...a)=>{ const el=$("#dbg"); el.textContent += a.map(x=> typeof x==="string"? x: JSON.stringify(x,null,2)).join(" ")+"\n"; el.scrollTop=el.scrollHeight; };
const fmtMoney = v => (v??0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

// ====== supabase ======
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:false }});
(async ()=>{
  try{
    const ping = await supa.from(READ_VIEW).select('dia').limit(1);
    if(ping.error) throw ping.error;
    $("#ping").textContent="✅ Supabase client ok"; $("#ping").className="ok";
  }catch(e){
    $("#ping").textContent="❌ Supabase erro: "+e.message; $("#ping").className="bad";
  }
})();

// ====== datas padrão ======
const today = new Date();
const dfim  = today.toISOString().slice(0,10);
const diniD = new Date(today.getTime()-29*24*3600*1000);
const dini  = diniD.toISOString().slice(0,10);
$("#dini").value=dini; $("#dfim").value=dfim;

// ====== DISTINCT por período (com fallback) ======
function buildAnd(parts){ if(!parts?.length) return ""; return "&and=(" + parts.join(",") + ")"; }
function baseHeaders(){ return { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }; }

function distinctURL(col,de,ate){
  const base = `${SUPABASE_URL}/rest/v1/${READ_VIEW}?select=${encodeURIComponent(col)}&distinct=true`;
  const cond=[];
  if(de)  cond.push(`dia.gte.${de}`);
  if(ate) cond.push(`dia.lte.${ate}`);
  const and = buildAnd(cond);
  // order correto: .asc.nullslast (antes eu usava nullsFirst=false -> 400)
  return `${base}${and}&order=${encodeURIComponent(col)}.asc.nullslast`;
}
function simpleSelectURL(col,de,ate){
  const base = `${SUPABASE_URL}/rest/v1/${READ_VIEW}?select=${encodeURIComponent(col)}`;
  const cond=[];
  if(de)  cond.push(`dia.gte.${de}`);
  if(ate) cond.push(`dia.lte.${ate}`);
  const and = buildAnd(cond);
  return `${base}${and}&order=${encodeURIComponent(col)}.asc.nullslast`;
}
async function fetchDistinct(col,de,ate){
  const url = distinctURL(col,de,ate);
  const r = await fetch(url,{ headers: baseHeaders() });
  if(!r.ok) throw new Error(`distinct ${col} HTTP ${r.status}`);
  return await r.json();
}
async function fetchDistinctFallback(col,de,ate){
  const url = simpleSelectURL(col,de,ate);
  const r = await fetch(url,{ headers: baseHeaders() });
  if(!r.ok) throw new Error(`fallback ${col} HTTP ${r.status}`);
  const rows = await r.json();
  const seen=new Set(), out=[];
  for(const row of rows){
    const v=row[col];
    if(v===null || v===undefined || v==="") continue;
    const key=String(v);
    if(!seen.has(key)){ seen.add(key); out.push({[col]:v}); }
  }
  return out;
}
async function fetchCol(col,de,ate){
  try{
    const a = await fetchDistinct(col,de,ate);
    dbg(`• ${col}: distinct OK (${a.length})`);
    return a;
  }catch(e){
    dbg(`⚠️ distinct ${col} falhou (${e.message}); usando fallback (dedupe no client)…`);
    const b = await fetchDistinctFallback(col,de,ate);
    dbg(`• ${col}: fallback OK (${b.length})`);
    return b;
  }
}
async function loadFilters(){
  const de=$("#dini").value, ate=$("#dfim").value;
  const fill = async (selId,col)=>{
    const data = await fetchCol(col,de,ate);
    const sel=$(selId); sel.innerHTML="";
    for(const row of data){
      const v=row[col];
      if(v===null || v===undefined || v==="") continue;
      const opt=document.createElement('option');
      opt.value=String(v);
      opt.textContent=String(v);
      sel.appendChild(opt);
    }
  };
  try{
    await Promise.all([
      fill("#ms-unids","unidade"),
      fill("#ms-lojas","loja"),         // <- usa a COLUNA CORRETA
      fill("#ms-turnos","turno"),
      fill("#ms-canais","canal"),
      fill("#ms-pags","pagamento_base")
    ]);
  }catch(e){ dbg("⚠️ erro loadFilters:", e.message); }
}

// ====== coleta filtros ======
function getMulti(sel){ const a=[]; for(const o of sel.selectedOptions) a.push(o.value); return a.length? a:null; }
function paramsRPC(){
  const de=$("#dini").value, ate=$("#dfim").value;
  return {
    p_dini: de, p_dfim: ate,
    p_unids: getMulti($("#ms-unids")),
    p_lojas: getMulti($("#ms-lojas")),
    p_turnos: getMulti($("#ms-turnos")),
    p_canais: getMulti($("#ms-canais")),
    p_pags:  getMulti($("#ms-pags")),
    p_cancelado: (()=>{
      const c=getMulti($("#ms-cancel"));
      if(!c) return null;
      if(c.includes("Sim") && !c.includes("Não")) return "Sim";
      if(c.includes("Não") && !c.includes("Sim")) return "Não";
      return null;
    })()
  };
}

// ====== RPC helpers ======
async function rpc(name,args){ const {data,error}=await supa.rpc(name,args); if(error) throw error; return data||[]; }
async function rpcHora(args){ try{ return await rpc(RPC.hora_v3,args);}catch{ return await rpc(RPC.hora_v2,args);} }

// ====== gráficos simples ======
function drawBar(canvasId, labels, values){
  const c=$(canvasId), ctx=c.getContext('2d');
  const W=c.width=c.clientWidth, H=c.height=c.clientHeight;
  ctx.clearRect(0,0,W,H);
  const max=Math.max(1,...values.map(v=>+v||0));
  const pad=28, bw=(W-pad*2)/Math.max(1,values.length);
  labels.forEach((lab,i)=>{
    const v=+values[i]||0, h=(H-80)*(v/max), x=pad+i*bw+6, y=H-40-h;
    ctx.fillStyle="#22c55e"; ctx.fillRect(x,y,bw-12,h);
    ctx.fillStyle="#94a3b8"; ctx.font="12px system-ui"; ctx.fillText(String(lab), x, H-22);
  });
}

// ====== KPIs + Charts + Smoke ======
async function updateAll(){
  const args=paramsRPC();
  dbg("→ KPI params", JSON.stringify(args,null,2));

  const k=(await rpc(RPC.kpi_v2,args))[0]||{pedidos:0,fat:0,des:0,fre:0};
  $("#k_ped").textContent=(k.pedidos??0).toLocaleString('pt-BR');
  $("#k_fat").textContent=fmtMoney(k.fat);
  $("#k_des").textContent=fmtMoney(k.des);
  $("#k_fre").textContent=fmtMoney(k.fre);

  const dow=await rpc(RPC.dow_v2,args);
  const mes=await rpc(RPC.mes_v2,args);
  const hora=await rpcHora(args);
  const tur=await rpc(RPC.turno_v2,args);

  drawBar("#c_dow",  dow.map(r=>r.dow),   dow.map(r=>Number(r.total)||0));
  drawBar("#c_mes",  mes.map(r=>r.ym),    mes.map(r=>Number(r.total)||0));
  drawBar("#c_hora", hora.map(r=>r.h),    hora.map(r=>Number(r.total)||0));
  drawBar("#c_turno",tur.map(r=>r.turno), tur.map(r=>Number(r.total)||0));

  const sDow=dow.reduce((a,b)=>a+(+b.total||0),0);
  const sMes=mes.reduce((a,b)=>a+(+b.total||0),0);
  const sHora=hora.reduce((a,b)=>a+(+b.total||0),0);
  const sTur=tur.reduce((a,b)=>a+(+b.total||0),0);
  const eq=x=>Math.abs(x-(+k.fat||0))<0.01;

  $("#k_fat_sm").textContent=`DOW:${eq(sDow)?"ok":"x"} • MÊS:${eq(sMes)?"ok":"x"} • HORA:${eq(sHora)?"ok":"x"} • TURNO:${eq(sTur)?"ok":"x"}`;
  dbg(`${eq(sDow)?"✅":"❌"} DOW soma=${sDow.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} vs KPI.fat=${fmtMoney(k.fat)} ${eq(sDow)?"(ok)":"(mismatch)"}`);
  dbg(`${eq(sMes)?"✅":"❌"} MÊS soma=${sMes.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} vs KPI.fat=${fmtMoney(k.fat)} ${eq(sMes)?"(ok)":"(mismatch)"}`);
  dbg(`${eq(sHora)?"✅":"❌"} HORA soma=${sHora.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} vs KPI.fat=${fmtMoney(k.fat)} ${eq(sHora)?"(ok)":"(mismatch)"}`);
  dbg(`${eq(sTur)?"✅":"❌"} TURNO soma=${sTur.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} vs KPI.fat=${fmtMoney(k.fat)} ${eq(sTur)?"(ok)":"(mismatch)"}`);
}

// ====== ações ======
$("#btn-aplicar").addEventListener("click", updateAll);
$("#btn-limpar").addEventListener("click", ()=>{
  for (const id of ["#ms-unids","#ms-lojas","#ms-turnos","#ms-canais","#ms-pags","#ms-cancel"]){
    const sel=$(id); for(const o of sel.options){ o.selected=false; }
  }
  updateAll();
});

// Boot
await loadFilters();
await updateAll();
</script>
</body>
</html>
