<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas ‚Ä¢ Supabase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#9ca3af; --txt:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --pri:#6366f1;
      --chip:#1f2937; --chipb:#374151;
    }
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;}
    h1{font-size:18px;margin:16px 0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
    .w100{flex:1 1 100%}.w50{flex:1 1 520px}.w33{flex:1 1 340px}.w25{flex:1 1 250px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{
      background:#0b1220;color:var(--txt);border:1px solid #21314f;border-radius:10px;padding:10px 12px;
      outline:none;width:100%;
    }
    select[multiple]{height:120px}
    button{cursor:pointer;background:var(--pri);border-color:#4f46e5}
    button.ghost{background:#0b1220;border-color:#334155}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpi .item{background:#0b1220;border:1px solid #21314f;border-radius:10px;padding:12px}
    .kpi .item h3{margin:0 0 4px 0;font-size:12px;color:var(--muted)}
    .kpi .item .v{font-size:18px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);border:1px solid var(--chipb);padding:6px 10px;border-radius:999px;color:#cbd5e1}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid #21314f;border-radius:10px;padding:10px;max-height:280px;overflow:auto}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard ‚Ä¢ Vendas</h1>

    <!-- Filtros -->
    <div class="card w100">
      <div class="row">
        <div class="w25">
          <label>Data inicial</label>
          <input type="date" id="dini">
        </div>
        <div class="w25">
          <label>Data final</label>
          <input type="date" id="dfim">
        </div>
        <div class="w25">
          <label>Unidade</label>
          <select id="f-unid" multiple></select>
        </div>
        <div class="w25">
          <label>Loja</label>
          <select id="f-loja" multiple></select>
        </div>
        <div class="w25">
          <label>Turno</label>
          <select id="f-turno" multiple></select>
        </div>
        <div class="w25">
          <label>Canal</label>
          <select id="f-canal" multiple></select>
        </div>
        <div class="w25">
          <label>Pagamento</label>
          <select id="f-pag" multiple></select>
        </div>
        <div class="w25">
          <label>Cancelado</label>
          <select id="f-canc">
            <option value="">(todos)</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="flex">
          <button id="btn-reload" class="ghost">Recarregar listas</button>
          <button id="btn-kpi">Atualizar KPI</button>
          <span class="muted" id="lbl-listas"></span>
          <span class="chip">Smoke: <span id="smoke-ok" class="ok" style="margin-left:6px">‚Äî</span></span>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="card w100">
      <div class="kpi">
        <div class="item"><h3>Pedidos</h3><div class="v" id="k-ped">‚Äî</div></div>
        <div class="item"><h3>Faturamento</h3><div class="v" id="k-fat">‚Äî</div></div>
        <div class="item"><h3>Descontos</h3><div class="v" id="k-des">‚Äî</div></div>
        <div class="item"><h3>Frete</h3><div class="v" id="k-fre">‚Äî</div></div>
      </div>
    </div>

    <!-- Upload -->
    <div class="card w100">
      <div class="row">
        <div class="w50">
          <label>Arquivo Excel (.xlsx) ‚Äî aba ‚ÄúUNIFICADA‚Äù</label>
          <input type="file" id="file" accept=".xlsx" />
        </div>
        <div class="w50 flex">
          <button id="btn-validate" class="ghost">Validar arquivo</button>
          <button id="btn-insert">Carregar no banco</button>
          <span class="muted">Valida no navegador; ‚ÄúCarregar‚Äù insere em lotes na tabela <b>public.vendas_import_csv_v2</b>.</span>
        </div>
      </div>
      <div class="row">
        <div class="w100">
          <label>Pr√©via (5 linhas)</label>
          <pre id="preview">‚Äî</pre>
        </div>
      </div>
    </div>

    <!-- Debug -->
    <div class="card w100">
      <div class="flex">
        <span>Debug</span>
        <span id="ping" class="chip">‚Äî</span>
      </div>
      <pre id="log">Pronto.</pre>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- SheetJS (se a rede bloquear, baixe e sirva localmente) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>

  <script>
  // ====== CONFIG SUPABASE (seus dados) ======
  const SUPA_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

  const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY, {
    auth: { persistSession: false }
  });

  // ====== HELPERS ======
  const $ = s => document.querySelector(s);
  const log = (...a) => { const el = $("#log"); el.textContent += "\\n" + a.map(x => typeof x==="string"?x:JSON.stringify(x,null,2)).join(" "); el.scrollTop = el.scrollHeight; };
  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v; };
  const fmt = n => n==null? "‚Äî" : n.toLocaleString("pt-BR",{maximumFractionDigits:2});
  const todayISO = () => new Date().toISOString().slice(0,10);

  // remove acentos/espacos e min√∫sculas
  const canon = s => (s ?? "").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim().toLowerCase();
  // pega primeira chave poss√≠vel do objeto (varia√ß√µes aceit√°veis)
  const pick = (row, names) => {
    const map = new Map(Object.keys(row).map(k => [canon(k), k]));
    for (const n of names) {
      const got = map.get(canon(n));
      if (got) return row[got];
    }
    return undefined;
  };

  // parse "dd/mm/yyyy hh:mm" -> {data_venda, hora}
  function parseDataHora(txt) {
    if (!txt) return { data_venda:null, hora:null };
    const m = String(txt).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2})(?::(\d{2}))?)?$/);
    if (!m) return { data_venda:null, hora:null };
    const [_, d, mo, y, hh] = m;
    const iso = `${y}-${mo.padStart(2,"0")}-${d.padStart(2,"0")}`;
    return { data_venda: iso, hora: hh? Number(hh): null };
  }

  // ====== FILTROS (listas) ======
  async function autoRange() {
    const { data, error } = await supa.rpc("range_vendas");
    if (error || !data || !data.length) return { min: null, max: null };
    return { min: data[0].min_dia, max: data[0].max_dia };
  }

  function selVals(id) {
    const opts = Array.from($(id).selectedOptions).map(o => o.value);
    return opts.length ? opts : null;
  }
  function paramsFromUI() {
    const dini = $("#dini").value || null;
    const dfim = $("#dfim").value || null;
    return {
      p_dini: dini, p_dfim: dfim,
      p_unids: selVals("#f-unid"),
      p_lojas: selVals("#f-loja"),
      p_turnos: selVals("#f-turno"),
      p_canais: selVals("#f-canal"),
      p_pags:  selVals("#f-pag"),
      p_cancelado: $("#f-canc").value || null
    };
  }

  async function loadList(fn, params, elSel) {
    const { data, error } = await supa.rpc(fn, params);
    if (error) throw error;
    const arr = (data||[]).map(r => r.val).filter(Boolean).sort((a,b)=>a.localeCompare(b,"pt-BR"));
    const sel = $(elSel);
    sel.innerHTML = "";
    for (const v of arr) {
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      sel.appendChild(opt);
    }
    return arr.length;
  }

  async function reloadLists() {
    const r = await autoRange();
    if (r.min && r.max) {
      $("#dini").value = r.min;
      $("#dfim").value = r.max;
      log("üóìÔ∏è Intervalo auto", JSON.stringify({minDia:r.min, maxDia:r.max}));
    }
    const p = paramsFromUI();
    const counts = {};
    try {
      const n1 = await loadList("list_unids_v1", p, "#f-unid"); counts.unids = n1;
      const n2 = await loadList("list_lojas_v1", p, "#f-loja"); counts.lojas = n2;
      const n3 = await loadList("list_turnos_v1", p, "#f-turno"); counts.turnos = n3;
      const n4 = await loadList("list_canais_v1", p, "#f-canal"); counts.canais = n4;
      const n5 = await loadList("list_pags_v1",  p, "#f-pag");  counts.pags = n5;
      setText("#lbl-listas", `üîé Listas carregadas { unids: ${counts.unids}, lojas: ${counts.lojas}, turnos: ${counts.turnos}, canais: ${counts.canais}, pags: ${counts.pags} }`);
      log("‚úÖ Supabase client ok");
      log("üîé Listas carregadas", counts);
    } catch (e) {
      log("‚ö†Ô∏è loadFilters erro:", e);
    }
  }

  // ====== KPI + Smoke ======
  async function fetchKPI(p) {
    log("‚Üí KPI params", JSON.stringify(p, null, 2));
    const { data, error } = await supa.rpc("kpi_vendas_v2", p);
    if (error) { log("‚ùå erro conectar", error.message||error); throw error; }
    const d = Array.isArray(data) ? (data[0] ?? {}) : data;
    return { pedidos: d.pedidos ?? 0, fat: d.fat ?? 0, des: d.des ?? 0, fre: d.fre ?? 0 };
  }

  async function fetchSum(fn, p) {
    const { data, error } = await supa.rpc(fn, p);
    if (error) throw error;
    const total = (data||[]).reduce((a,r)=> a + Number(r.total||0), 0);
    return total;
  }

  async function updateKPI() {
    const p = paramsFromUI();
    const k = await fetchKPI(p);
    setText("#k-ped", fmt(k.pedidos));
    setText("#k-fat", "R$ " + fmt(k.fat));
    setText("#k-des", "R$ " + fmt(k.des));
    setText("#k-fre", "R$ " + fmt(k.fre));

    // Smoke: soma dos gr√°ficos == KPI.fat
    try {
      const sd = await fetchSum("chart_vendas_dow_v2",  p);
      const sm = await fetchSum("chart_vendas_mes_v2",  p);
      const sh = await fetchSum("chart_vendas_hora_v2", p);
      const ok = Math.abs(sd - k.fat) < 0.01 && Math.abs(sm - k.fat) < 0.01 && Math.abs(sh - k.fat) < 0.01;
      $("#smoke-ok").textContent = ok ? "ok" : "mismatch";
      $("#smoke-ok").className = ok ? "ok" : "err";
      log("üß™ Smoke", {dow:sd, mes:sm, hora:sh, fat:k.fat, ok});
    } catch(e) {
      $("#smoke-ok").textContent = "erro";
      $("#smoke-ok").className = "warn";
      log("üß™ Smoke erro", e);
    }
  }

  // ====== UPLOAD (Validar + Inserir) ======
  let parsedRows = []; // linhas normalizadas prontas p/ DB

  function normalizeRow(row) {
    // nomes candidatos por campo
    const vData = pick(row, ["Data","data","data da venda","data_venda"]);
    const vUnid = pick(row, ["Unidade","unidade"]);
    const vLoja = pick(row, ["loja","nome da loja","nome da loja "]); // com/sem espa√ßo
    const vCanal = pick(row, ["Canal","canal","canal de venda"]);
    const vCanc  = pick(row, ["Cancelado","Est√° cancelado","cancelado"]);
    const vItens = pick(row, ["Itens","itens","pedido_itens"]);
    const vTot   = pick(row, ["Total","total","fat","faturamento"]);
    const vDes   = pick(row, ["Desconto","desconto","des"]);
    const vFre   = pick(row, ["Entrega","entrega","frete","fre"]);
    const vTurno = pick(row, ["Turno","turno"]);
    const vPag   = pick(row, ["Pagamento","pagamento","pagamento_base"]);

    const { data_venda, hora } = parseDataHora(vData);
    const canc = (String(vCanc||"").toLowerCase().trim());
    const isCancel = ["s","sim","true","1","y"].includes(canc) ? true : ["n","nao","n√£o","false","0"].includes(canc) ? false : Boolean(vCanc)===true;

    const num = x => {
      if (x==null || x==="") return 0;
      if (typeof x === "number") return x;
      // aceita "1.234,56"
      const t = String(x).replace(/\./g,"").replace(",",".");
      const n = Number(t);
      return isFinite(n) ? n : 0;
    };

    return {
      data_venda: data_venda,                       // date (YYYY-MM-DD)
      hora: hora ?? null,                           // int
      unidade: vUnid ? String(vUnid).trim() : null,
      loja: vLoja ? String(vLoja).trim() : "",      // pode vir vazio
      canal: vCanal ? String(vCanal).trim() : null,
      cancelado: !!isCancel,                         // boolean
      itens: Math.round(num(vItens)),                // numeric -> int
      total: num(vTot),
      des: num(vDes),
      fre: num(vFre),
      turno: vTurno ? String(vTurno).trim() : null,
      pagamento: vPag ? String(vPag).trim() : null
    };
  }

  $("#btn-validate").addEventListener("click", async () => {
    const f = $("#file").files[0];
    if (!f) { alert("Selecione um .xlsx"); return; }
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });
    const ws = wb.Sheets["UNIFICADA"] || wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(ws, { defval:null, raw:true });

    parsedRows = raw.map(normalizeRow);

    // pr√©via
    const preview = parsedRows.slice(0,5);
    $("#preview").textContent = JSON.stringify(preview, null, 2);

    // intervalo auto
    const dates = parsedRows.map(r=>r.data_venda).filter(Boolean).sort();
    const minDia = dates[0] || "";
    const maxDia = dates[dates.length-1] || "";
    log("üìÑ Arquivo lido", { nome:f.name, sheet: wb.SheetNames[0], linhas: raw.length });
    log("üîß Amostra mapeada (1¬™ linha)", raw[0]);
    log("‚úÖ Pr√©via (5 linhas)", preview);
    log("üóìÔ∏è Intervalo auto", {minDia, maxDia});
    if (minDia && !$("#dini").value) $("#dini").value = minDia;
    if (maxDia && !$("#dfim").value) $("#dfim").value = maxDia;
  });

  $("#btn-insert").addEventListener("click", async () => {
    if (!parsedRows.length) { alert("Valide o arquivo primeiro."); return; }

    // checa acesso tabela
    const { error: tErr } = await supa.from("vendas_import_csv_v2").select("data_venda").limit(1);
    if (tErr) { log("‚ùå Acesso tabela erro", tErr); alert("Erro de acesso √† tabela."); return; }
    log("‚úÖ Tabela acess√≠vel");

    // insere em lotes de 2000
    const BATCH = 2000;
    let ok = 0, fail = 0;
    for (let i=0;i<parsedRows.length;i+=BATCH) {
      const chunk = parsedRows.slice(i, i+BATCH);
      const { error } = await supa.from("vendas_import_csv_v2").insert(chunk, { returning:"minimal" });
      if (error) { fail += chunk.length; log("‚ùå Lote erro", {lote:[i, i+chunk.length], error}); }
      else { ok += chunk.length; log("‚úÖ Lote inserido", { lote:[i, i+chunk.length] }); }
    }
    log("üì¶ Inser√ß√£o conclu√≠da", { ok, fail });
    // recarrega listas e KPI
    await reloadLists();
    await updateKPI();
  });

  // Bot√µes principais
  $("#btn-reload").addEventListener("click", reloadLists);
  $("#btn-kpi").addEventListener("click", updateKPI);

  // Inicializa√ß√£o
  (async function init(){
    try {
      // ping simples
      const { error } = await supa.from("vendas_import_csv_v2").select("id").limit(1);
      if (!error) { $("#ping").textContent = "‚úÖ Supabase client ok"; }
      else { $("#ping").textContent = "‚ö†Ô∏è ping erro"; log(error); }
    } catch(e) { $("#ping").textContent = "‚ö†Ô∏è ping erro"; log(e); }

    // se houver range na base, usa
    const r = await autoRange();
    if (r.min) $("#dini").value = r.min;
    if (r.max) $("#dfim").value = r.max;

    await reloadLists();
    await updateKPI();
  })();
  </script>
</body>
</html>
