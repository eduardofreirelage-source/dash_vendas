<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Dashboard de Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">
  <!-- Supabase e SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    h1 { margin: 0 0 8px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; margin: 8px 0; }
    .card { border:1px solid #ddd; border-radius:8px; padding:12px; }
    .col { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; color:#333; }
    select, input[type="date"] { padding:6px; min-width:200px; }
    button { padding:8px 12px; cursor:pointer; }
    pre { background:#0d1117; color:#c9d1d9; padding:10px; border-radius:6px; overflow:auto; max-height:260px; }
    table { border-collapse: collapse; }
    td, th { border:1px solid #ddd; padding:6px 8px; }
    .kpis { display:flex; gap:12px; }
    .kpi { padding:8px 12px; background:#f5f5f5; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Dashboard de Vendas</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Data inicial</label>
        <input type="date" id="dini">
      </div>
      <div class="col">
        <label>Data final</label>
        <input type="date" id="dfim">
      </div>
      <div class="col">
        <label>Unidades</label>
        <select id="unids" multiple size="6"></select>
      </div>
      <div class="col">
        <label>Lojas (coluna <b>loja</b>)</label>
        <select id="lojas" multiple size="6"></select>
      </div>
      <div class="col">
        <label>Turnos</label>
        <select id="turnos" multiple size="6"></select>
      </div>
      <div class="col">
        <label>Canais</label>
        <select id="canais" multiple size="6"></select>
      </div>
      <div class="col">
        <label>Pagamentos</label>
        <select id="pags" multiple size="6"></select>
      </div>
      <div class="col">
        <label>Cancelado</label>
        <select id="cancelado">
          <option value="">(todos)</option>
          <option value="sim">Sim</option>
          <option value="n√£o">N√£o</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button id="btnListas">Recarregar listas</button>
      <button id="btnKPI">Rodar KPI</button>
      <span class="kpis" id="kpis"></span>
    </div>
  </div>

  <div class="card">
    <h3>Carregar Excel ‚Üí banco (public.vendas_import_csv_v2)</h3>
    <div class="row">
      <input type="file" id="file" accept=".xlsx,.xls" />
      <button id="btnValidar">Validar arquivo</button>
      <button id="btnCarregar">Carregar no banco</button>
    </div>
    <div class="row">
      <table id="preview"></table>
    </div>
  </div>

  <div class="card">
    <h3>Debug</h3>
    <pre id="debug"></pre>
  </div>

<script>
const SUPABASE_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const el = id => document.getElementById(id);
const log = (...a) => { el('debug').textContent += a.map(x => typeof x==='string'? x : JSON.stringify(x,null,2)).join(' ') + "\n"; };

function getSelections(sel) {
  return [...sel.selectedOptions].map(o => o.value).filter(Boolean);
}
function buildParams(ignoreKind=null) {
  const p = {
    p_dini: el('dini').value || null,
    p_dfim: el('dfim').value || null,
    p_unids: getSelections(el('unids')).length? getSelections(el('unids')) : null,
    p_lojas: getSelections(el('lojas')).length? getSelections(el('lojas')) : null,
    p_turnos: getSelections(el('turnos')).length? getSelections(el('turnos')) : null,
    p_canais: getSelections(el('canais')).length? getSelections(el('canais')) : null,
    p_pags: getSelections(el('pags')).length? getSelections(el('pags')) : null,
    p_cancelado: el('cancelado').value || null,
  };
  if (ignoreKind === 'unid') p.p_unids = null;
  if (ignoreKind === 'loja') p.p_lojas = null;
  if (ignoreKind === 'turno') p.p_turnos = null;
  if (ignoreKind === 'canal') p.p_canais = null;
  if (ignoreKind === 'pag')   p.p_pags = null;
  return p;
}
function fillSelect(sel, values) {
  sel.innerHTML = '';
  values.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v; opt.textContent = v;
    sel.appendChild(opt);
  });
}

async function ensureDates() {
  if (el('dini').value && el('dfim').value) return;
  const { data, error } = await sb.rpc('range_vendas');
  if (error) { log('‚ö†Ô∏è range_vendas erro', error); return; }
  if (data && data.length) {
    const { min_dia, max_dia } = data[0];
    if (min_dia) el('dini').value = min_dia;
    if (max_dia) el('dfim').value = max_dia;
    log('üóìÔ∏è Intervalo auto', { minDia: min_dia || '', maxDia: max_dia || '' });
  }
}

async function loadLists() {
  await ensureDates();
  log('‚úÖ Supabase client ok');
  const [unids, lojas, turnos, canais, pags] = await Promise.all([
    sb.rpc('list_unids_v1',  buildParams('unid')),
    sb.rpc('list_lojas_v1',  buildParams('loja')),
    sb.rpc('list_turnos_v1', buildParams('turno')),
    sb.rpc('list_canais_v1', buildParams('canal')),
    sb.rpc('list_pags_v1',   buildParams('pag')),
  ]);
  const wrap = (res, name) => {
    if (res.error) { log(`‚ö†Ô∏è ${name} erro:`, res.error); return []; }
    return (res.data||[]).map(r => r.val);
  };
  const vsUnids  = wrap(unids,  'list_unids_v1');
  const vsLojas  = wrap(lojas,  'list_lojas_v1');
  const vsTurnos = wrap(turnos, 'list_turnos_v1');
  const vsCanais = wrap(canais, 'list_canais_v1');
  const vsPags   = wrap(pags,   'list_pags_v1');

  fillSelect(el('unids'),  vsUnids);
  fillSelect(el('lojas'),  vsLojas);
  fillSelect(el('turnos'), vsTurnos);
  fillSelect(el('canais'), vsCanais);
  fillSelect(el('pags'),   vsPags);

  log('üîé Listas carregadas', {
    unids: vsUnids.length, lojas: vsLojas.length,
    turnos: vsTurnos.length, canais: vsCanais.length, pags: vsPags.length
  });
}

async function runKPI() {
  const p = buildParams();
  log('‚Üí KPI params', p);
  const { data, error } = await sb.rpc('kpi_vendas_v2', p);
  if (error) { log('‚ùå KPI erro', error); return; }
  const row = Array.isArray(data) ? data[0] : data;
  const kEl = el('kpis');
  kEl.innerHTML = '';
  const add = (label, val) => {
    const d = document.createElement('div');
    d.className = 'kpi';
    d.textContent = `${label}: ${val}`;
    kEl.appendChild(d);
  };
  add('Pedidos', row.pedidos ?? 0);
  add('Faturamento', (row.fat ?? 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
  add('Descontos', (row.des ?? 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
  add('Fretes', (row.fre ?? 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));

  // Smoke: somat√≥rios dos charts
  const sums = await Promise.all([
    sb.rpc('chart_vendas_dow_v2',  p),
    sb.rpc('chart_vendas_mes_v2',  p),
    sb.rpc('chart_vendas_hora_v2', p),
  ]);
  const sumVal = i => (sums[i].data||[]).reduce((a,r)=>a + Number(r.total||0), 0);
  const dow = sumVal(0), mes = sumVal(1), hora = sumVal(2), fat = Number(row.fat||0);
  log('üß™ Smoke', { dow, mes, hora, fat, ok: Math.abs(dow-fat)<1e-6 && Math.abs(mes-fat)<1e-6 && Math.abs(hora-fat)<1e-6 });
}

/* =======================
   Ingest√£o de arquivo XLSX
======================= */
let parsedRows = [];

function normalizeHeader(h) {
  return String(h||'').trim()
    .replace(/\s+/g,' ')
    .replace(/\u00A0/g,' ')       // NBSP
    .replace(/[()[\]]/g,'')
    .toLowerCase();
}

function mapRow(obj) {
  // Aceita cabe√ßalhos como no seu arquivo (UNIFICADA)
  // Campos esperados na tabela: data_venda, hora, unidade, loja, canal, cancelado, itens, total, des, fre, turno, pagamento
  const o = {};
  // normaliza chaves para procurar
  const lower = {};
  Object.keys(obj).forEach(k => { lower[normalizeHeader(k)] = obj[k]; });

  const lojaRaw = lower['loja'] ?? lower[' loja'] ?? ''; // lida com poss√≠vel espa√ßo √† esquerda
  const dataTxt = lower['data'] ?? lower['data da venda'] ?? null; // "01/05/2025 11:01"
  let data_venda = null, hora = null;
  if (typeof dataTxt === 'string') {
    const m = dataTxt.match(/(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{1,2}))?/);
    if (m) {
      data_venda = `${m[3]}-${m[2]}-${m[1]}`;
      hora = m[4] ? parseInt(m[4],10) : null;
    }
  }

  const cancelRaw = lower['cancelado'] ?? lower['est√° cancelado'] ?? lower['esta cancelado'] ?? 'N';
  const cancelado = typeof cancelRaw === 'boolean' ? cancelRaw :
                    /^(s|sim|true|1)$/i.test(String(cancelRaw||'').trim()) ? true : false;

  const turno = lower['turno'] ?? null;
  const pagamento = lower['pagamento'] ?? lower['pagamento base'] ?? null;
  const unidade = lower['unidade'] ?? null;
  const canal   = lower['canal'] ?? lower['canal de venda'] ?? null;

  const itens = Number(lower['itens'] ?? 1) || 1;
  const total = Number(lower['total'] ?? 0) || 0;
  const des   = Number(lower['desconto'] ?? lower['des'] ?? 0) || 0;
  const fre   = Number(lower['entrega'] ?? lower['fre'] ?? 0) || 0;

  return {
    data_venda,
    hora,
    unidade,
    loja: lojaRaw || null,
    canal,
    cancelado,
    itens,
    total,
    des,
    fre,
    turno,
    pagamento
  };
}

function renderPreview(rows) {
  const tbl = el('preview');
  tbl.innerHTML = '';
  if (!rows.length) return;
  const cols = Object.keys(rows[0]);
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(c => { const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
  thead.appendChild(trh);
  const tbody = document.createElement('tbody');
  rows.slice(0,5).forEach(r=>{
    const tr = document.createElement('tr');
    cols.forEach(c => { const td=document.createElement('td'); td.textContent = r[c]; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
  tbl.appendChild(thead); tbl.appendChild(tbody);
}

el('btnValidar').onclick = async () => {
  try {
    log('‚úÖ Supabase client ok');
    const file = el('file').files[0];
    if (!file) { log('‚ö†Ô∏è selecione um arquivo'); return; }
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const sh = wb.Sheets[sheetName];
    const raw = XLSX.utils.sheet_to_json(sh, { defval: null });
    log('üìÑ Arquivo lido', { nome: file.name, sheet: sheetName, linhas: raw.length });

    parsedRows = raw.map(mapRow).filter(r => r.data_venda);
    renderPreview(parsedRows);
  } catch (e) {
    log('‚ùå', e.message || e);
  }
};

el('btnCarregar').onclick = async () => {
  if (!parsedRows.length) { log('‚ö†Ô∏è valide o arquivo antes'); return; }
  // checa acesso √† tabela
  const chk = await sb.from('vendas_import_csv_v2').select('id').limit(1);
  if (chk.error) { log('‚ùå acesso tabela', chk.error); return; }
  // insere em lotes de 2000
  const BATCH = 2000;
  let ok=0, fail=0;
  for (let i=0; i<parsedRows.length; i+=BATCH) {
    const slice = parsedRows.slice(i, i+BATCH);
    const { error } = await sb.from('vendas_import_csv_v2').insert(slice);
    if (error) { fail += slice.length; log('‚ö†Ô∏è lote erro', { range:[i, i+slice.length], error }); }
    else { ok += slice.length; log('‚úÖ Lote inserido', { lote:[i, Math.min(i+BATCH, parsedRows.length)] }); }
  }
  log('üì¶ Inser√ß√£o conclu√≠da', { ok, fail });
  await loadLists();
  await runKPI();
};

/* Eventos */
el('btnListas').onclick = loadLists;
el('btnKPI').onclick     = runKPI;

/* Boot */
(async () => {
  await ensureDates();
  await loadLists();
})();
</script>
</body>
</html>
