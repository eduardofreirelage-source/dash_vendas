<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Produtos & Fichas Técnicas</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">FT</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb;
      --wine:#7b1e3a; --wine-2:#9e3a59; --ok:#059669; --warn:#b45309; --err:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1250px;margin:28px auto;padding:0 16px}
    h1{margin:0;font-size:28px}
    h2{margin:0 0 10px}
    h3{margin:0 0 10px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    .status{font-size:13px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
    .tab.active{background:#f1f5f9;font-weight:700}
    .section{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
    textarea{min-height:80px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.pri{background:var(--wine);color:#fff;border-color:var(--wine)}
    .btn.warn{background:#fff7ed;border-color:#fed7aa}
    .btn.ghost{background:#f8fafc}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .hint{color:#64748b;font-size:12px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
    th{background:#f8fafc}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .empty{padding:16px;border:1px dashed var(--line);border-radius:12px;background:#fafafa;color:#64748b}
    .list{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
    .list-item{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:8px;align-items:center}
    .list-item:hover{background:#f8fafc}
    .list-item.active{background:#f1f5f9}
    .search{display:flex;gap:8px}
    .titlebar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;color:#fff;padding:10px 14px;border-radius:12px;opacity:.96;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .inline-form{display:grid;grid-template-columns:1.2fr 1fr .8fr .7fr auto;gap:10px;align-items:end}
    @media (max-width:1024px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Produtos & Fichas Técnicas</h1>
      <div id="status" class="status">Carregando…</div>
    </div>

    <div class="tabs">
      <button type="button" class="tab active" data-tab="tab-pratos">Pratos</button>
      <button type="button" class="tab" data-tab="tab-prato-rec">Componentes do Prato</button>
      <button type="button" class="tab" data-tab="tab-rec">Receitas</button>
      <button type="button" class="tab" data-tab="tab-ing">Ingredientes</button>
    </div>

    <!-- PRATOS -->
    <div class="section" id="tab-pratos">
      <div class="grid cols-2">
        <div>
          <div class="titlebar">
            <h2>Pratos cadastrados</h2>
            <div class="search">
              <input id="prato-q" placeholder="Buscar prato"/>
              <button id="btnNewPrato" class="btn">+ Novo prato</button>
            </div>
          </div>
          <div class="list" id="listPratos"></div>
        </div>
        <div>
          <div class="titlebar">
            <h2>Pratos do Dashboard</h2>
            <div class="search">
              <input id="dash-q" placeholder="Buscar no dashboard"/>
              <button id="btnSyncAll" class="btn">Sincronizar todos que faltam</button>
            </div>
          </div>
          <div class="hint">Fonte: <code>vendas_pratos_pratos</code> (coluna <code>prato</code>)</div>
          <div class="list" id="listDashPratos" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- COMPONENTES DO PRATO (MASTER–DETAIL) -->
    <div class="section" id="tab-prato-rec" style="display:none">
      <div class="grid cols-2">
        <!-- Master -->
        <div>
          <div class="titlebar">
            <h2>Pratos</h2>
            <input id="pr-m-q" placeholder="Buscar"/>
          </div>
          <div class="list" id="listPratosMD"></div>
        </div>

        <!-- Detail -->
        <div>
          <div class="titlebar">
            <h2>Componentes do Prato</h2>
            <div class="pill" id="pratoSelPill">Nenhum prato selecionado</div>
          </div>

          <div id="prDetailEmpty" class="empty">Selecione um prato na lista ao lado para visualizar e editar seus componentes.</div>

          <div id="prDetailBox" style="display:none">
            <div class="inline-form">
              <div>
                <label>Receita</label>
                <select id="pr-receita"></select>
              </div>
              <div>
                <label>Qtd por prato</label>
                <input id="pr-qtd" inputmode="decimal" placeholder="Ex.: 220">
              </div>
              <div>
                <label>Unidade</label>
                <select id="pr-und">
                  <option value="g" selected>g</option><option value="kg">kg</option>
                  <option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option>
                </select>
              </div>
              <div>
                <label>Observações</label>
                <input id="pr-obs" placeholder="Opcional">
              </div>
              <div style="align-self:center">
                <button id="btnAddPrComp" class="btn pri">Adicionar</button>
              </div>
            </div>

            <div class="sep"></div>
            <div style="overflow:auto">
              <table id="tblPrComp">
                <thead><tr><th>Receita</th><th style="width:120px">Qtd</th><th style="width:80px">Un</th><th style="width:130px">Ações</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RECEITAS (MASTER–DETAIL) -->
    <div class="section" id="tab-rec" style="display:none">
      <div class="grid cols-2">
        <!-- Master -->
        <div>
          <div class="titlebar">
            <h2>Receitas</h2>
            <div class="search">
              <input id="rec-q" placeholder="Buscar receita">
              <button id="btnNewRec" class="btn">+ Nova receita</button>
            </div>
          </div>
          <div class="list" id="listReceitas"></div>
        </div>

        <!-- Detail -->
        <div>
          <div class="titlebar">
            <h2 id="recDetailTitle">Detalhe da Receita</h2>
            <div class="pill" id="recModePill">Selecione uma receita</div>
          </div>

          <!-- Estado vazio -->
          <div id="recEmpty" class="empty">Selecione uma receita para editar, ou clique em “+ Nova receita”.</div>

          <!-- Cabeçalho -->
          <div id="recHead" style="display:none">
            <div class="grid cols-3">
              <div><label>Nome da receita</label><input id="rec-nome"></div>
              <div><label>Rendimento (quantidade)</label><input id="rec-rend-qtd" inputmode="decimal"></div>
              <div><label>Unidade do rendimento</label>
                <select id="rec-rend-und"><option value="g" selected>g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
              </div>
            </div>
            <div class="grid cols-3" style="margin-top:10px">
              <div><label>Perda global (%)</label><input id="rec-perda" inputmode="decimal" value="0"></div>
              <div><label>Observações</label><input id="rec-obs" placeholder="Opcional"></div>
              <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
                <button id="btnSaveRec" class="btn pri" style="display:none">Salvar nova receita</button>
                <button id="btnUpdateRec" class="btn" style="display:none">Salvar alterações</button>
                <button id="btnCancelRec" class="btn ghost" style="display:none">Cancelar</button>
              </div>
            </div>
          </div>

          <!-- Itens -->
          <div id="recItensBox" style="display:none">
            <div class="sep"></div>
            <h3 style="margin-bottom:6px">Itens da receita</h3>

            <!-- Adição de item -->
            <div class="inline-form">
              <div>
                <label>Tipo</label>
                <select id="ri-tipo"><option value="INGREDIENTE" selected>Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
              </div>
              <div>
                <label>Referência</label>
                <select id="ri-ref"></select>
              </div>
              <div>
                <label>Qtd</label>
                <input id="ri-qtd" inputmode="decimal" placeholder="Ex.: 300">
              </div>
              <div>
                <label>Unidade</label>
                <select id="ri-und"><option value="g" selected>g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
              </div>
              <div style="align-self:center">
                <button id="btnAddRi" class="btn">Adicionar</button>
              </div>
            </div>

            <!-- Grade -->
            <div style="overflow:auto;margin-top:8px">
              <table id="tblRi">
                <thead><tr><th>Tipo</th><th>Nome</th><th style="width:120px">Qtd</th><th style="width:90px">Un</th><th style="width:90px">Perda%</th><th style="width:140px">Ações</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- INGREDIENTES -->
    <div class="section" id="tab-ing" style="display:none">
      <div class="grid cols-2">
        <div>
          <div class="titlebar">
            <h2>Ingredientes</h2>
            <div class="search"><input id="ing-q" placeholder="Buscar"></div>
          </div>
          <div class="list" id="listIng"></div>
        </div>
        <div>
          <div class="titlebar">
            <h2 id="ingFormTitle">Cadastrar ingrediente</h2>
            <div class="pill" id="ingModePill">Novo</div>
          </div>
          <div class="grid cols-3">
            <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"></div>
            <div><label>Unidade</label>
              <select id="ing-und"><option value="g">g</option><option value="kg" selected>kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
            </div>
            <div><label>Custo unitário</label><input id="ing-custo" inputmode="decimal" placeholder="Ex.: 0,0123"></div>
          </div>
          <div class="grid" style="margin-top:10px">
            <div><label>Observações</label><input id="ing-obs" placeholder="Opcional"></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnSaveIng" class="btn pri">Salvar</button>
            <button id="btnCancelIng" class="btn ghost" style="display:none">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lib Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ================== CONFIG ================== */
    const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const DASHBOARD_PRATOS_SOURCE = 'vendas_pratos_pratos'; // deve ter coluna 'prato'

    /* ================== HELPERS ================== */
    const $ = (id)=> document.getElementById(id);
    const setStatus=(msg,cls)=>{ const el=$('status'); if(!el) return; el.textContent=msg; el.className='status'+(cls?(' '+cls):''); };
    const toast=(msg)=>{ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 2200); };
    const fmt = (n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
    const toNum = (v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
    const confirmX = (msg)=> window.confirm(msg);

    /* ================== TABS ================== */
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.section').forEach(sec=>sec.style.display='none');
        $(btn.dataset.tab).style.display='block';
      });
    });

    /* ============= STATE (ids selecionados) ============= */
    let currentPratoId = null;
    let currentRecId   = null;
    let currentIngId   = null;

    /* ================== PRATOS ================== */
    async function loadPratosList(){
      const q = $('prato-q').value.trim().toLowerCase();
      const box = $('listPratos'); box.innerHTML = '';
      const { data, error } = await supa.from('pratos').select('id,nome,categoria,ativo').order('nome');
      if(error){ box.innerHTML = '<div class="empty">Tabela <b>pratos</b> não encontrada.</div>'; return; }
      const items = (data||[]).filter(p => !q || p.nome.toLowerCase().includes(q));
      if(!items.length){ box.innerHTML = '<div class="empty">Nenhum prato.</div>'; return; }
      items.forEach(p=>{
        const row=document.createElement('div'); row.className='list-item';
        row.innerHTML = `<div><b>${p.nome}</b> <span class="pill">${p.categoria||'PRATOS'}</span></div>
                         <div class="row-actions">
                           <button class="btn" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
                           <button class="btn" data-act="del" data-id="${p.id}">Excluir</button>
                         </div>`;
        box.appendChild(row);
      });
    }
    $('prato-q').addEventListener('input', loadPratosList);

    $('listPratos').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=b.dataset.id, act=b.dataset.act;
      if(act==='del'){ if(!confirmX('Excluir prato?')) return; const {error}=await supa.from('pratos').delete().eq('id',id); if(error) return alert(error.message); }
      if(act==='toggle'){ const {data}=await supa.from('pratos').select('ativo').eq('id',id).single(); await supa.from('pratos').update({ativo:!data.ativo}).eq('id',id); }
      await loadPratosList(); await loadPratosMaster();
    });

    $('btnNewPrato').addEventListener('click', async ()=>{
      const nome = prompt('Nome do novo prato:'); if(!nome) return;
      const { error } = await supa.from('pratos').insert({ nome, categoria:'PRATOS' });
      if(error && !String(error.message||'').includes('duplicate')) return alert(error.message);
      toast('Prato criado');
      await loadPratosList(); await loadPratosMaster(); await loadDashPratos();
    });

    async function loadDashPratos(){
      const q = $('dash-q').value.trim().toLowerCase();
      const box = $('listDashPratos'); box.innerHTML='';
      const { data:dash, error:err1 } = await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato');
      if(err1){ box.innerHTML = `<div class="empty">Não foi possível ler <b>${DASHBOARD_PRATOS_SOURCE}</b>.</div>`; return; }
      const nomesDash = Array.from(new Set((dash||[]).map(r=>r.prato).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      const names = nomesDash.filter(n => !q || n.toLowerCase().includes(q));
      const { data:pr } = await supa.from('pratos').select('nome');
      const setExist = new Set((pr||[]).map(p=>p.nome));
      if(!names.length){ box.innerHTML = '<div class="empty">Nenhum prato.</div>'; return; }
      names.forEach(n=>{
        const exists = setExist.has(n);
        const row=document.createElement('div'); row.className='list-item';
        row.innerHTML = `<div>${n}</div>
                         <div class="row-actions">
                           ${exists?'<span class="pill">Já existe</span>':'<button class="btn" data-act="import" data-nome="'+n.replace(/"/g,'&quot;')+'">Importar</button>'}
                         </div>`;
        box.appendChild(row);
      });
    }
    $('dash-q').addEventListener('input', loadDashPratos);

    $('listDashPratos').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.dataset.act==='import'){
        await supa.from('pratos').insert({ nome:b.dataset.nome, categoria:'PRATOS' }).catch(()=>{});
        toast('Importado'); await loadPratosList(); await loadPratosMaster(); await loadDashPratos();
      }
    });
    $('btnSyncAll').addEventListener('click', async ()=>{
      const { data:dash } = await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato');
      const nomes = Array.from(new Set((dash||[]).map(r=>r.prato).filter(Boolean)));
      const { data:pr } = await supa.from('pratos').select('nome');
      const exist = new Set((pr||[]).map(x=>x.nome));
      for(const n of nomes){ if(!exist.has(n)) await supa.from('pratos').insert({nome:n,categoria:'PRATOS'}).catch(()=>{}); }
      toast('Sincronização concluída'); await loadPratosList(); await loadPratosMaster(); await loadDashPratos();
    });

    /* =========== MASTER LIST PARA COMPONENTES DO PRATO =========== */
    async function loadPratosMaster(){
      const box = $('listPratosMD'); const q=$('pr-m-q').value.trim().toLowerCase();
      box.innerHTML='';
      const { data, error } = await supa.from('pratos').select('id,nome,ativo').order('nome');
      if(error){ box.innerHTML='<div class="empty">Crie a tabela <b>pratos</b>.</div>'; return; }
      const items=(data||[]).filter(p=>!q||p.nome.toLowerCase().includes(q));
      if(!items.length){ box.innerHTML='<div class="empty">Nenhum prato.</div>'; return; }
      items.forEach(p=>{
        const row=document.createElement('div'); row.className='list-item'+(p.id===currentPratoId?' active':'');
        row.innerHTML = `<div>${p.nome}</div><div>${p.ativo?'<span class="pill">Ativo</span>':'<span class="pill">Inativo</span>'}</div>`;
        row.addEventListener('click', ()=>{ currentPratoId=p.id; renderPratoDetail(); document.querySelectorAll('#listPratosMD .list-item').forEach(n=>n.classList.remove('active')); row.classList.add('active'); });
        box.appendChild(row);
      });
    }
    $('pr-m-q').addEventListener('input', loadPratosMaster);

    async function renderPratoDetail(){
      const box = $('prDetailBox'), empty=$('prDetailEmpty'), pill=$('pratoSelPill');
      if(!currentPratoId){ empty.style.display='block'; box.style.display='none'; pill.textContent='Nenhum prato selecionado'; return; }
      const { data:prato } = await supa.from('pratos').select('nome').eq('id',currentPratoId).single();
      pill.textContent = `Prato: ${prato?.nome||'#'+currentPratoId}`;
      empty.style.display='none'; box.style.display='block';
      await fillOptionsFrom('pr-receita','receitas','id','nome',{ativo:true});
      await loadPratoCompTable();
    }

    async function loadPratoCompTable(){
      const tb = $('tblPrComp').querySelector('tbody'); tb.innerHTML='';
      const { data, error } = await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id', currentPratoId);
      if(error){ tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>'; return; }
      if(!data?.length){ tb.innerHTML='<tr><td colspan="4"><div class="empty">Nenhuma receita vinculada.</div></td></tr>'; return; }
      for(const row of data){
        const { data: rec } = await supa.from('receitas').select('nome').eq('id', row.receita_id).single();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rec?.nome||'(receita removida)'}</td>
          <td><input data-k="qtd" data-id="${row.id}" value="${row.qtd}" style="width:110px"></td>
          <td>
            <select data-k="unidade" data-id="${row.id}" style="width:80px">
              ${['g','kg','ml','L','porcao'].map(u=>`<option value="${u}" ${u===row.unidade?'selected':''}>${u}</option>`).join('')}
            </select>
          </td>
          <td class="row-actions">
            <button class="btn" data-act="save" data-id="${row.id}">Salvar</button>
            <button class="btn warn" data-act="del" data-id="${row.id}">Remover</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    $('tblPrComp').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=b.dataset.id, act=b.dataset.act;
      if(act==='del'){ if(!confirmX('Remover receita do prato?')) return; const {error}=await supa.from('prato_receitas').delete().eq('id',id); if(error) return alert(error.message); toast('Removido'); await loadPratoCompTable(); }
      if(act==='save'){
        const inputs = Array.from($('tblPrComp').querySelectorAll(`[data-id="${id}"]`)).reduce((acc,el)=>{acc[el.dataset.k]=el.value;return acc;},{});
        const payload = { qtd: toNum(inputs.qtd), unidade: inputs.unidade };
        const { error } = await supa.from('prato_receitas').update(payload).eq('id',id);
        if(error) return alert(error.message); toast('Atualizado');
      }
    });

    $('btnAddPrComp').addEventListener('click', async ()=>{
      if(!currentPratoId) return;
      const receita_id = $('pr-receita').value; const qtd=toNum($('pr-qtd').value); const unidade=$('pr-und').value; const obs=$('pr-obs').value.trim()||null;
      if(!receita_id || !qtd){ return alert('Selecione a receita e informe a quantidade'); }
      // evita duplicado: se existir mesmo par prato+receita, atualiza qtd/un
      const { data:exists } = await supa.from('prato_receitas').select('id').eq('prato_id',currentPratoId).eq('receita_id',receita_id).maybeSingle();
      if(exists?.id){
        await supa.from('prato_receitas').update({qtd,unidade,obs}).eq('id',exists.id);
      }else{
        const { error } = await supa.from('prato_receitas').insert({ prato_id:currentPratoId, receita_id, qtd, unidade, obs });
        if(error) return alert(error.message);
      }
      $('pr-qtd').value=''; $('pr-obs').value='';
      toast('Componente adicionado'); await loadPratoCompTable();
    });

    /* ================== RECEITAS ================== */
    async function loadReceitasList(){
      const q = $('rec-q').value.trim().toLowerCase();
      const box = $('listReceitas'); box.innerHTML='';
      const { data, error } = await supa.from('receitas').select('id,nome,ativo').order('nome');
      if(error){ box.innerHTML='<div class="empty">Crie a tabela <b>receitas</b>.</div>'; return; }
      const items=(data||[]).filter(r=>!q||r.nome.toLowerCase().includes(q));
      if(!items.length){ box.innerHTML='<div class="empty">Nenhuma receita.</div>'; return; }
      items.forEach(r=>{
        const row=document.createElement('div'); row.className='list-item'+(r.id===currentRecId?' active':'');
        row.innerHTML = `<div>${r.nome}</div>
                         <div class="row-actions">
                           <button class="btn" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
                           <button class="btn" data-act="del" data-id="${r.id}">Excluir</button>
                         </div>`;
        row.addEventListener('click', async (ev)=>{
          if(ev.target.closest('button')) return; // não trocar seleção ao clicar nas ações
          currentRecId=r.id; await enterRecEditMode();
          document.querySelectorAll('#listReceitas .list-item').forEach(n=>n.classList.remove('active')); row.classList.add('active');
        });
        box.appendChild(row);
      });
    }
    $('rec-q').addEventListener('input', loadReceitasList);

    $('listReceitas').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=b.dataset.id, act=b.dataset.act;
      if(act==='del'){ if(!confirmX('Excluir receita e seus itens?')) return; const {error}=await supa.from('receitas').delete().eq('id',id); if(error) return alert(error.message); if(currentRecId==id){ currentRecId=null; exitRecMode(); } }
      if(act==='toggle'){ const {data}=await supa.from('receitas').select('ativo').eq('id',id).single(); await supa.from('receitas').update({ativo:!data.ativo}).eq('id',id); }
      await loadReceitasList(); await fillOptionsFrom('pr-receita','receitas','id','nome',{ativo:true});
    });

    function exitRecMode(){
      $('recEmpty').style.display='block'; $('recHead').style.display='none'; $('recItensBox').style.display='none';
      $('recModePill').textContent='Selecione uma receita';
      $('recDetailTitle').textContent='Detalhe da Receita';
      $('btnSaveRec').style.display='none'; $('btnUpdateRec').style.display='none'; $('btnCancelRec').style.display='none';
    }

    async function enterRecEditMode(){
      if(!currentRecId){ exitRecMode(); return; }
      $('recEmpty').style.display='none'; $('recHead').style.display='block'; $('recItensBox').style.display='block';
      $('btnSaveRec').style.display='none'; $('btnUpdateRec').style.display='inline-flex'; $('btnCancelRec').style.display='inline-flex';
      $('recModePill').textContent='Editando';
      const { data:rec } = await supa.from('receitas').select('*').eq('id',currentRecId).single();
      $('recDetailTitle').textContent = `Receita: ${rec?.nome||'#'+currentRecId}`;
      $('rec-nome').value=rec?.nome||''; $('rec-rend-qtd').value=rec?.rendimento_qtd||''; $('rec-rend-und').value=rec?.unidade_rendimento||'g';
      $('rec-perda').value=rec?.perda_pct||0; $('rec-obs').value=rec?.obs||'';
      await loadRiOptionsForTipo(); await loadReceitaItensTable();
    }

    $('btnNewRec').addEventListener('click', ()=>{
      currentRecId=null; $('recEmpty').style.display='none'; $('recHead').style.display='block'; $('recItensBox').style.display='none';
      $('btnSaveRec').style.display='inline-flex'; $('btnUpdateRec').style.display='none'; $('btnCancelRec').style.display='inline-flex';
      $('recModePill').textContent='Nova'; $('recDetailTitle').textContent='Nova Receita';
      $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs').value='';
    });
    $('btnCancelRec').addEventListener('click', ()=>{ exitRecMode(); });

    $('btnSaveRec').addEventListener('click', async ()=>{
      const nome=$('rec-nome').value.trim(); const rendimento_qtd=toNum($('rec-rend-qtd').value); const unidade_rendimento=$('rec-rend-und').value;
      const perda_pct=toNum($('rec-perda').value); const obs=$('rec-obs').value.trim()||null;
      if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
      const { data:ins, error } = await supa.from('receitas').insert({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).select('id').single();
      if(error) return alert(error.message);
      toast('Receita criada'); currentRecId=ins.id; await loadReceitasList(); await enterRecEditMode();
      await fillOptionsFrom('pr-receita','receitas','id','nome',{ativo:true});
    });

    $('btnUpdateRec').addEventListener('click', async ()=>{
      const nome=$('rec-nome').value.trim(); const rendimento_qtd=toNum($('rec-rend-qtd').value); const unidade_rendimento=$('rec-rend-und').value;
      const perda_pct=toNum($('rec-perda').value); const obs=$('rec-obs').value.trim()||null;
      if(!currentRecId) return; if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
      const { error } = await supa.from('receitas').update({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).eq('id',currentRecId);
      if(error) return alert(error.message); toast('Receita atualizada'); await loadReceitasList();
    });

    async function loadRiOptionsForTipo(){
      const tipo = $('ri-tipo').value;
      if(tipo==='INGREDIENTE'){
        await fillOptionsFrom('ri-ref','ingredientes','id','nome',{ativo:true});
      }else{
        await fillOptionsFrom('ri-ref','receitas','id','nome',{ativo:true});
      }
    }
    $('ri-tipo').addEventListener('change', loadRiOptionsForTipo);

    $('btnAddRi').addEventListener('click', async ()=>{
      if(!currentRecId) return alert('Selecione uma receita (modo edição).');
      const tipo=$('ri-tipo').value; const ref_id=$('ri-ref').value; const qtd=toNum($('ri-qtd').value); const unidade=$('ri-und').value;
      if(!ref_id||!qtd) return alert('Selecione a referência e informe a quantidade');
      // evitar duplicado (mesma receita + tipo + ref + unidade) → soma/atualiza quantidade
      const { data:exists } = await supa.from('receita_itens')
        .select('id,qtd').eq('receita_id',currentRecId).eq('tipo',tipo).eq('ref_id',ref_id).eq('unidade',unidade).maybeSingle();
      if(exists?.id){
        await supa.from('receita_itens').update({ qtd: toNum(exists.qtd)+qtd }).eq('id', exists.id);
      }else{
        const { error } = await supa.from('receita_itens').insert({ receita_id:currentRecId, tipo, ref_id, qtd, unidade, perda_pct:0 });
        if(error) return alert(error.message);
      }
      $('ri-qtd').value=''; toast('Item adicionado'); await loadReceitaItensTable();
    });

    async function loadReceitaItensTable(){
      const tb=$('tblRi').querySelector('tbody'); tb.innerHTML='';
      if(!currentRecId){ tb.innerHTML='<tr><td colspan="6">—</td></tr>'; return; }
      const { data, error } = await supa.from('receita_itens').select('*').eq('receita_id', currentRecId).order('tipo');
      if(error){ tb.innerHTML='<tr><td colspan="6">Erro ao listar</td></tr>'; return; }
      if(!data?.length){ tb.innerHTML='<tr><td colspan="6"><div class="empty">Nenhum item.</div></td></tr>'; return; }
      for(const it of data){
        let nome='—';
        if(it.tipo==='INGREDIENTE'){ const {data:i}=await supa.from('ingredientes').select('nome').eq('id',it.ref_id).single(); nome=i?.nome||'(ingrediente removido)'; }
        else{ const {data:r}=await supa.from('receitas').select('nome').eq('id',it.ref_id).single(); nome=r?.nome||'(receita removida)'; }
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.tipo}</td>
          <td>${nome}</td>
          <td><input data-k="qtd" data-id="${it.id}" value="${it.qtd}" style="width:110px"></td>
          <td>
            <select data-k="unidade" data-id="${it.id}" style="width:80px">
              ${['g','kg','ml','L','un'].map(u=>`<option value="${u}" ${u===it.unidade?'selected':''}>${u}</option>`).join('')}
            </select>
          </td>
          <td><input data-k="perda_pct" data-id="${it.id}" value="${it.perda_pct||0}" style="width:90px"></td>
          <td class="row-actions">
            <button class="btn" data-act="save" data-id="${it.id}">Salvar</button>
            <button class="btn warn" data-act="del" data-id="${it.id}">Remover</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    $('tblRi').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=b.dataset.id, act=b.dataset.act;
      if(act==='del'){ if(!confirmX('Remover item da receita?')) return; const {error}=await supa.from('receita_itens').delete().eq('id',id); if(error) return alert(error.message); toast('Removido'); await loadReceitaItensTable(); }
      if(act==='save'){
        const inputs = Array.from($('tblRi').querySelectorAll(`[data-id="${id}"]`)).reduce((acc,el)=>{acc[el.dataset.k]=el.value;return acc;},{});
        const payload = { qtd: toNum(inputs.qtd), unidade: inputs.unidade, perda_pct: toNum(inputs.perda_pct) };
        const { error } = await supa.from('receita_itens').update(payload).eq('id',id);
        if(error) return alert(error.message); toast('Atualizado');
      }
    });

    /* ================== INGREDIENTES ================== */
    async function loadIngList(){
      const q=$('ing-q').value.trim().toLowerCase(); const box=$('listIng'); box.innerHTML='';
      const { data, error } = await supa.from('ingredientes').select('id,nome,unidade,custo_unitario,ativo').order('nome');
      if(error){ box.innerHTML='<div class="empty">Crie a tabela <b>ingredientes</b>.</div>'; return; }
      const items=(data||[]).filter(i=>!q||i.nome.toLowerCase().includes(q));
      if(!items.length){ box.innerHTML='<div class="empty">Nenhum ingrediente.</div>'; return; }
      items.forEach(i=>{
        const row=document.createElement('div'); row.className='list-item'+(i.id===currentIngId?' active':'');
        row.innerHTML = `<div><b>${i.nome}</b> <span class="pill">${i.unidade}</span> <span class="pill">R$ ${fmt(i.custo_unitario)}</span></div>
                         <div class="row-actions">
                           <button class="btn" data-act="edit" data-id="${i.id}">Editar</button>
                           <button class="btn" data-act="toggle" data-id="${i.id}">${i.ativo?'Desativar':'Ativar'}</button>
                           <button class="btn" data-act="del" data-id="${i.id}">Excluir</button>
                         </div>`;
        box.appendChild(row);
      });
    }
    $('ing-q').addEventListener('input', loadIngList);

    $('listIng').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=b.dataset.id, act=b.dataset.act;
      if(act==='del'){ if(!confirmX('Excluir ingrediente?')) return; const {error}=await supa.from('ingredientes').delete().eq('id',id); if(error) return alert(error.message); if(currentIngId==id) resetIngForm(); }
      if(act==='toggle'){ const {data}=await supa.from('ingredientes').select('ativo').eq('id',id).single(); await supa.from('ingredientes').update({ativo:!data.ativo}).eq('id',id); }
      if(act==='edit'){ const {data}=await supa.from('ingredientes').select('*').eq('id',id).single(); currentIngId=id; $('ingFormTitle').textContent='Editar ingrediente'; $('ingModePill').textContent='Editando'; $('ing-nome').value=data?.nome||''; $('ing-und').value=data?.unidade||'kg'; $('ing-custo').value=data?.custo_unitario??''; $('ing-obs').value=data?.obs||''; $('btnCancelIng').style.display='inline-flex'; }
      await loadIngList();
    });

    function resetIngForm(){
      currentIngId=null; $('ingFormTitle').textContent='Cadastrar ingrediente'; $('ingModePill').textContent='Novo';
      $('ing-nome').value=''; $('ing-und').value='kg'; $('ing-custo').value=''; $('ing-obs').value=''; $('btnCancelIng').style.display='none';
    }
    $('btnCancelIng').addEventListener('click', resetIngForm);

    $('btnSaveIng').addEventListener('click', async ()=>{
      const nome=$('ing-nome').value.trim(); const unidade=$('ing-und').value; const custo=toNum($('ing-custo').value); const obs=$('ing-obs').value.trim()||null;
      if(!nome) return alert('Informe o nome');
      if(currentIngId){ const {error}=await supa.from('ingredientes').update({nome,unidade,custo_unitario:custo,obs}).eq('id',currentIngId); if(error) return alert(error.message); toast('Atualizado'); }
      else{ const {error}=await supa.from('ingredientes').insert({nome,unidade,custo_unitario:custo,obs}); if(error) return alert(error.message); toast('Salvo'); }
      await loadIngList(); resetIngForm();
    });

    /* ================== UTIL: OPTIONS ================== */
    async function fillOptionsFrom(selectId, table, valKey, labelKey, whereEq){
      const sel=$(selectId); if(!sel) return; let q=supa.from(table).select(`${valKey},${labelKey}`).order(labelKey);
      if(whereEq) Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v));
      const { data } = await q; sel.innerHTML=''; (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
    }

    /* ================== INIT ================== */
    async function init(){
      try{
        await Promise.all([
          loadPratosList(), loadDashPratos(), loadPratosMaster(),
          loadReceitasList(), loadIngList()
        ]);
        await fillOptionsFrom('pr-receita','receitas','id','nome',{ativo:true});
        await loadRiOptionsForTipo();
        setStatus('Pronto','ok');
      }catch(e){ setStatus(e.message,'err'); }
    }
    init();
  });
  </script>
</body>
</html>
