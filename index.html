<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — Filtros (v2.3.2 CFO — Light)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%233b82f6"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --blue:#2563eb; --blue-100:#eef2ff; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
  .badge{display:inline-block;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px;color:#334155}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .btn{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--blue);background:var(--blue);color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{border-color:var(--line);background:#fff;color:#334155}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .status{margin-left:6px;font-size:13px}
  .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .box{background:var(--blue-100);border:1px solid var(--line);border-radius:12px;padding:12px}
  .label{font-size:12px;color:#475569}
  .big{font-size:20px;font-weight:800}
  .delta{font-size:12px;margin-left:6px}
  .up{color:var(--ok)} .down{color:var(--err)} .flat{color:#64748b}
  pre{white-space:pre-wrap;background:#f8fafc;color:#111827;border-radius:10px;padding:12px;overflow:auto;border:1px solid var(--line);max-height:360px}

  /* ===== Multiselect ===== */
  .msel{position:relative}
  .msel-btn{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;text-align:left;cursor:pointer}
  .msel-btn:after{content:"▾";float:right;color:#334155}
  .msel-panel{position:absolute;z-index:50;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:8px}
  .msel-opt:hover{background:#f1f5f9}
</style>
</head>
<body>
<div class="container">
  <h1>Dashboard Vendas — Filtros <span class="badge">v2.3.2 CFO — Light</span></h1>
  <div class="muted">Período rápido ancorado no último dia do banco. Filtros estáveis; KPIs iguais à versão aprovada.</div>

  <div class="card" style="margin-top:12px;">
    <div class="row cols-4">
      <div>
        <label class="label">Período rápido</label>
        <select id="periodo" class="msel-btn" style="border:1px solid var(--line);border-radius:10px;background:#fff;">
          <option value="7">Últimos 7 dias</option>
          <option value="15">Últimos 15 dias</option>
          <option value="30" selected>Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="120">Últimos 120 dias</option>
        </select>
        <div class="muted" id="periodoTexto" style="margin-top:4px;font-size:12px;">—</div>
      </div>

      <div>
        <label class="label">Unidade(s)</label>
        <div id="ms-unidades" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>

      <div>
        <label class="label">Loja(s)</label>
        <div id="ms-lojas" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>

      <div>
        <label class="label">Turno(s)</label>
        <div id="ms-turnos" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
    </div>

    <div class="row cols-4" style="margin-top:12px;">
      <div>
        <label class="label">Canal(is)</label>
        <div id="ms-canais" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Pagamento(s)</label>
        <div id="ms-pags" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Cancelado</label>
        <div id="ms-cancel" class="msel">
          <button type="button" class="msel-btn">Não</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""  id="c_all"><label for="c_all">Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="Não" id="c_nao" checked><label for="c_nao">Não</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim" id="c_sim"><label for="c_sim">Sim</label></div>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:end;">
        <button id="btnAplicar" class="btn">Aplicar filtros</button>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:12px;">
      <div class="muted" id="status">—</div>
      <div></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="btnAmostra" class="btn ghost">Ver amostra (20)</button>
        <button id="btnTopDups" class="btn ghost">Top duplicatas (30)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <b>Quadro Resumo — Linhas filtradas</b>
    <div class="row cols-4" style="margin-top:8px;">
      <div class="box"><div class="label">Brutas</div><div id="q_brutas" class="big">-</div></div>
      <div class="box"><div class="label">Canônicas (DISTINCT)</div><div id="q_canon" class="big">-</div></div>
      <div class="box"><div class="label">Duplicatas (Brutas−Canon)</div><div id="q_dups" class="big">-</div></div>
      <div class="box"><div class="label">% Duplicatas</div><div id="q_perc" class="big">-</div></div>
    </div>

    <div class="sep"></div>
    <b>KPIs (com comparativo do período anterior)</b>
    <div class="kpi" style="margin-top:8px;">
      <div class="box"><div class="label">Pedidos</div><div class="big" id="k_ped">-</div><div id="d_ped" class="delta flat">—</div></div>
      <div class="box"><div class="label">Faturamento</div><div class="big" id="k_fat">-</div><div id="d_fat" class="delta flat">—</div></div>
      <div class="box"><div class="label">Descontos</div><div class="big" id="k_des">-</div><div id="d_des" class="delta flat">—</div></div>
      <div class="box"><div class="label">Frete</div><div class="big" id="k_fre">-</div><div id="d_fre" class="delta flat">—</div></div>
      <div class="box"><div class="label">Ticket médio</div><div class="big" id="k_tkt">-</div><div id="d_tkt" class="delta flat">—</div></div>
    </div>
    <div class="row cols-4" style="margin-top:8px;">
      <div class="box"><div class="label">Faturamento Líquido (fat − des − fre)</div><div class="big" id="k_fatliq">-</div><div id="d_fatliq" class="delta flat">—</div></div>
    </div>
  </div>

  <div class="card">
    <b>Resultado (lista / Amostra / Top dups)</b>
    <pre id="out">(vazio)</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script>
/* ====== CONFIG ====== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);

/* ====== UTIL ====== */
const fmt = (n,dec=0)=> (n==null||!isFinite(+n))?'-':(+n).toLocaleString('pt-BR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
function pctDelta(curr, prev){
  if(prev==null || !isFinite(prev) || prev===0) return {txt:'(—)', cls:'flat', arrow:''};
  const p = ((curr-prev)/prev)*100;
  const arrow = p>=0 ? '↑' : '↓';
  const cls   = p>=0 ? 'up' : 'down';
  return {txt:`${arrow} ${Math.abs(p).toFixed(1)}%`, cls, arrow};
}
function setDelta(elId, curr, prev){
  const d = pctDelta(curr, prev);
  const el = $(elId); el.textContent = d.txt; el.className = `delta ${d.cls}`;
}
function setStatus(t,cls){const el=$('status'); el.textContent=t; el.className=`status ${cls||'muted'}`}

function dateToISO(d){ return d.toISOString().slice(0,10); }
function addDays(iso, n){
  const d = new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return dateToISO(d);
}

/* ====== Multiselect ====== */
function MultiSelect(rootId, placeholder='Selecionar'){
  const root = $(rootId);
  const btn  = root.querySelector('.msel-btn');
  const panel= root.querySelector('.msel-panel');
  let options = [], selected = new Set(), filtered = [];

  function renderList(){
    panel.innerHTML = '';
    const inp = document.createElement('input'); inp.className='msel-search'; inp.placeholder='Filtrar…';
    inp.addEventListener('input', ()=>{ filtered = options.filter(v=>v.toLowerCase().includes(inp.value.toLowerCase())); draw(); });
    panel.appendChild(inp);
    draw();
  }
  function draw(){
    const list = document.createElement('div');
    (filtered.length?filtered:options).forEach((v,i)=>{
      const id = `${rootId}-${i}`;
      const row = document.createElement('div'); row.className='msel-opt';
      const cb  = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v; cb.checked=selected.has(v);
      const lb  = document.createElement('label'); lb.htmlFor=id; lb.textContent=v;
      cb.addEventListener('change', ()=>{ cb.checked?selected.add(v):selected.delete(v); refreshBtn(); saveState(); });
      row.appendChild(cb); row.appendChild(lb); list.appendChild(row);
    });
    const nodes = Array.from(panel.querySelectorAll('.msel-opt')); nodes.forEach(n=>n.remove());
    panel.appendChild(list);
  }
  function refreshBtn(){
    if(selected.size===0) btn.textContent = placeholder;
    else if(selected.size===options.length) btn.textContent = `Todos (${selected.size})`;
    else btn.textContent = `${selected.size} selecionado(s)`;
  }
  btn.addEventListener('click', ()=>{ root.classList.toggle('open'); });
  document.addEventListener('click', (ev)=>{ if(!root.contains(ev.target)) root.classList.remove('open'); });

  return {
    setOptions(list, preselected){
      options = (list||[]).filter(Boolean); filtered = options.slice();
      selected = new Set(preselected||[]);
      renderList(); refreshBtn();
    },
    get(){ return Array.from(selected); },
    set(vals){ selected = new Set(vals||[]); refreshBtn(); draw(); }
  };
}

/* ====== ESTADO ====== */
const ms = {
  unidades: MultiSelect('ms-unidades','Todas as unidades'),
  lojas:    MultiSelect('ms-lojas','Todas as lojas'),
  turnos:   MultiSelect('ms-turnos','Todos os turnos'),
  canais:   MultiSelect('ms-canais','Todos os canais'),
  pags:     MultiSelect('ms-pags','Todos os pagamentos'),
  cancel:   MultiSelect('ms-cancel','Todos')
};
function saveState(){
  const S = {
    periodo: $('periodo').value,
    unids: ms.unidades.get(),
    lojas: ms.lojas.get(),
    turnos: ms.turnos.get(),
    canais: ms.canais.get(),
    pags: ms.pags.get(),
    cancel: ms.cancel.get()
  };
  localStorage.setItem('cfo_light_v232', JSON.stringify(S));
}
function loadState(){
  const raw = localStorage.getItem('cfo_light_v232');
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

/* ====== OPÇÕES + PERÍODO ====== */
let lastDay=''; let firstDay='';
async function loadOptionsAndPeriod(){
  setStatus('Carregando opções…');
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro ao carregar datas: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }

  const u = await supa.from('vw_vendas_unidades').select('unidade');
  const l = await supa.from('vw_vendas_lojas').select('loja');
  const t = await supa.from('vw_vendas_turnos').select('turno');
  const c = await supa.from('vw_vendas_canais').select('canal');
  const p = await supa.from('vw_vendas_pagamentos').select('pagamento_base');

  ms.unidades.setOptions((u.data||[]).map(r=>r.unidade));
  ms.lojas.setOptions((l.data||[]).map(r=>r.loja));
  ms.turnos.setOptions((t.data||[]).map(r=>r.turno));
  ms.canais.setOptions((c.data||[]).map(r=>r.canal));
  ms.pags.setOptions((p.data||[]).map(r=>r.pagamento_base));
  ms.cancel.setOptions(['','Não','Sim'], ['Não']); // default "Não"

  const S = loadState();
  if(S){
    $('periodo').value = S.periodo || '30';
    ms.unidades.set(S.unids||[]);
    ms.lojas.set(S.lojas||[]);
    ms.turnos.set(S.turnos||[]);
    ms.canais.set(S.canais||[]);
    ms.pags.set(S.pags||[]);
    ms.cancel.set(S.cancel||['Não']);
  }

  updatePeriodoTexto();
  setStatus('Opções carregadas.','ok');
}

function rangeFromPeriodo(){
  const n = parseInt($('periodo').value,10)||30;
  const dfim = lastDay;
  let dini = addDays(dfim, -(n-1));
  if(dini < firstDay) dini = firstDay;
  return {dini, dfim, n};
}
function rangePrev(dini, n){
  const dfimPrev = addDays(dini, -1);
  const diniPrev = addDays(dfimPrev, -(n-1));
  return {dini:diniPrev, dfim:dfimPrev};
}
function updatePeriodoTexto(){
  const {dini, dfim, n} = rangeFromPeriodo();
  $('periodoTexto').textContent = `Período: ${dini} → ${dfim} (${n} dias). Último dia do banco: ${lastDay}.`;
}

/* ====== PARAMS ====== */
function buildParams(dini, dfim){
  const canc = ms.cancel.get();
  const p_cancelado = canc.includes('') ? null : (canc.length? canc[0] : null);
  const p = {
    p_dini: dini, p_dfim: dfim,
    p_unids:  ms.unidades.get().length ? ms.unidades.get() : null,
    p_lojas:  ms.lojas.get().length    ? ms.lojas.get()    : null,
    p_turnos: ms.turnos.get().length   ? ms.turnos.get()   : null,
    p_canais: ms.canais.get().length   ? ms.canais.get()   : null,
    p_pags:   ms.pags.get().length     ? ms.pags.get()     : null,
    p_cancelado
  };
  return p;
}

/* ====== APLICAÇÃO ====== */
async function aplicar(){
  try{
    setStatus('Consultando…');
    saveState();

    const {dini, dfim, n} = rangeFromPeriodo();
    const prev = rangePrev(dini, n);

    const rsum = await supa.rpc('resumo_vendas', buildParams(dini, dfim));
    if(rsum.error) throw rsum.error;
    const R = rsum.data?.[0] || {};
    $('q_brutas').textContent = fmt(R.brutas);
    $('q_canon').textContent  = fmt(R.canon);
    $('q_dups').textContent   = fmt(R.duplicatas);
    $('q_perc').textContent   = (R.perc_dup==null? '-' : (Number(R.perc_dup).toFixed(2)+' %'));

    const kNow = await supa.rpc('kpi_vendas', buildParams(dini, dfim));
    if(kNow.error) throw kNow.error;
    let ped=0,fat=0,des=0,fre=0;
    for(const r of (kNow.data||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; }
    const tkt = ped>0 ? (fat/ped) : 0;
    const fatliq = fat - des - fre;

    const kPrev = await supa.rpc('kpi_vendas', buildParams(prev.dini, prev.dfim));
    if(kPrev.error) throw kPrev.error;
    let p_ped=0,p_fat=0,p_des=0,p_fre=0;
    for(const r of (kPrev.data||[])){ p_ped+=+r.pedidos||0; p_fat+=+r.fat||0; p_des+=+r.des||0; p_fre+=+r.fre||0; }
    const p_tkt = p_ped>0 ? (p_fat/p_ped) : 0;
    const p_fatliq = p_fat - p_des - p_fre;

    $('k_ped').textContent = fmt(ped);
    $('k_fat').textContent = 'R$ '+fmt(fat,2);
    $('k_des').textContent = 'R$ '+fmt(des,2);
    $('k_fre').textContent = 'R$ '+fmt(fre,2);
    $('k_tkt').textContent = 'R$ '+fmt(tkt,2);
    $('k_fatliq').textContent = 'R$ '+fmt(fatliq,2);

    setDelta('d_ped', ped, p_ped);
    setDelta('d_fat', fat, p_fat);
    setDelta('d_des', des, p_des);
    setDelta('d_fre', fre, p_fre);
    setDelta('d_tkt', tkt, p_tkt);
    setDelta('d_fatliq', fatliq, p_fatliq);

    $('out').textContent = JSON.stringify((kNow.data||[]).slice(-10), null, 2);
    setStatus('OK.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

/* ====== Amostra / Top Duplicatas ====== */
async function amostra(){
  try{
    setStatus('Amostrando…');
    const {dini, dfim} = rangeFromPeriodo();
    const r = await supa.rpc('amostra_vendas', buildParams(dini, dfim));
    if(r.error) throw r.error;
    $('out').textContent = JSON.stringify(r.data||[], null, 2);
    setStatus('Amostra pronta.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}
async function topdups(){
  try{
    setStatus('Consultando duplicatas…');
    const {dini, dfim} = rangeFromPeriodo();
    const p = buildParams(dini, dfim); p.p_limit = 30;
    const r = await supa.rpc('top_dups_vendas', p);
    if(r.error) throw r.error;
    $('out').textContent = JSON.stringify(r.data||[], null, 2);
    setStatus('Top duplicatas pronto.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

/* ====== INIT ====== */
$('periodo').addEventListener('change', ()=>{ updatePeriodoTexto(); });
document.getElementById('btnAplicar').addEventListener('click', aplicar);
document.getElementById('btnAmostra').addEventListener('click', amostra);
document.getElementById('btnTopDups').addEventListener('click', topdups);

loadOptionsAndPeriod().then(aplicar);
</script>
</body>
</html>
