<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Supabase (v10.1 fixo: vendas)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--card:#fff;--bd:#e5e7eb;}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:980px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--muted);font-size:12px}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
      .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .title{font-size:12px;color:var(--muted)}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      code{background:#eef2ff;padding:0 4px;border-radius:4px}
      label{font-size:12px;color:#374151}
      input,select,button{font:inherit}
      input[type=text], select{
        width:100%;padding:8px 10px;border:1px solid var(--bd);border-radius:8px;background:#fff;color:#111827
      }
      .row{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
      .row > div{display:flex;flex-direction:column;gap:6px}
      .btn{padding:8px 12px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer}
      .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
      .btn:disabled{opacity:.6;cursor:not-allowed}
      .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:560px){.grid{grid-template-columns:1fr}.row{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Build v10.1 (GitHub Pages) • mapeamento padrão fixo: <code>vendas</code></div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title" style="margin-bottom:8px">Credenciais em uso</div>
        <div class="row" style="margin-bottom:8px">
          <div>
            <label>URL</label>
            <input id="in_url" type="text" />
          </div>
          <div style="grid-column: span 5">
            <label>Anon key</label>
            <input id="in_key" type="text" />
          </div>
        </div>

        <div class="title" style="margin:8px 0;">Tabela & Mapeamento de Colunas</div>
        <div class="row">
          <div>
            <label>Tabela</label>
            <input id="in_tbl" type="text" />
          </div>
          <div>
            <label>Coluna de Data</label>
            <input id="in_dt" type="text" />
          </div>
          <div>
            <label>Valor Total</label>
            <input id="in_total" type="text" />
          </div>
          <div>
            <label>Desconto</label>
            <input id="in_desc" type="text" />
          </div>
          <div>
            <label>Entrega</label>
            <input id="in_ent" type="text" />
          </div>
          <div>
            <label>Unidade (opcional)</label>
            <input id="in_uni" type="text" placeholder="unidade" />
          </div>
        </div>

        <div class="toolbar" style="margin-top:10px">
          <button id="bt_test" class="btn">Testar tabela & listar colunas</button>
          <button id="bt_load" class="btn primary">Carregar KPIs (30 dias)</button>
          <button id="bt_save" class="btn">Salvar mapeamento</button>
          <div class="muted" id="cols" style="margin-left:auto">Colunas: —</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="toolbar" style="gap:12px">
          <div class="title">Filtro: UNIDADE</div>
          <select id="sel_uni" style="min-width:220px">
            <option value="__ALL__">Todas</option>
          </select>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== CREDENCIAIS (fixas — as que você forneceu) ======
      const DEFAULTS = {
        url: "https://uahmcfzerofhzjvlzrqc.supabase.co",
        key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU",
        tbl: "vendas",
        col_dt: "data_venda",
        col_total: "valor_total",
        col_desc: "desconto",
        col_ent: "entrega",
        col_uni: "unidade" // opcional; se não existir, tudo roda sem filtro
      };
      const LSKEY = "dash_map_v1";

      // ====== UI refs ======
      const el = {
        url:  document.getElementById("in_url"),
        key:  document.getElementById("in_key"),
        tbl:  document.getElementById("in_tbl"),
        dt:   document.getElementById("in_dt"),
        tot:  document.getElementById("in_total"),
        des:  document.getElementById("in_desc"),
        ent:  document.getElementById("in_ent"),
        uni:  document.getElementById("in_uni"),
        btTest: document.getElementById("bt_test"),
        btLoad: document.getElementById("bt_load"),
        btSave: document.getElementById("bt_save"),
        cols: document.getElementById("cols"),
        log:  document.getElementById("log"),
        ped:  document.getElementById("k_ped"),
        fat:  document.getElementById("k_fat"),
        dsc:  document.getElementById("k_desc"),
        fre:  document.getElementById("k_fre"),
        periodo: document.getElementById("periodo"),
        selUni: document.getElementById("sel_uni"),
      };

      // ====== helpers ======
      function log(m){ el.log.textContent += "\\n" + m; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toNum(x){
        if(x==null||x==="")return 0;
        if(typeof x==="number")return x;
        const s=String(x).trim();
        if(!s)return 0;
        const t=s.replace(/\\./g,"").replace(/,/g,".");
        const n=Number(t);
        return isFinite(n)?n:0;
      }
      function toISO(d){ return d.toISOString().slice(0,10); }
      function loadMapFromLS(){
        try{
          const s=localStorage.getItem(LSKEY);
          if(!s) return null;
          return JSON.parse(s);
        }catch{ return null; }
      }
      function saveMapToLS(map){
        try{ localStorage.setItem(LSKEY, JSON.stringify(map)); }catch{}
      }
      function getMap(){
        return {
          url: el.url.value.trim(),
          key: el.key.value.trim(),
          tbl: el.tbl.value.trim(),
          col_dt: el.dt.value.trim(),
          col_total: el.tot.value.trim(),
          col_desc: el.des.value.trim(),
          col_ent: el.ent.value.trim(),
          col_uni: el.uni.value.trim(),
        };
      }
      function setMap(map){
        el.url.value = map.url || DEFAULTS.url;
        el.key.value = map.key || DEFAULTS.key;
        el.tbl.value = map.tbl || DEFAULTS.tbl;
        el.dt.value  = map.col_dt || DEFAULTS.col_dt;
        el.tot.value = map.col_total || DEFAULTS.col_total;
        el.des.value = map.col_desc || DEFAULTS.col_desc;
        el.ent.value = map.col_ent || DEFAULTS.col_ent;
        el.uni.value = map.col_uni || DEFAULTS.col_uni;
      }

      // ====== Supabase client (dinâmico por mapeamento) ======
      let supa = null;
      function createClient(url,key){ return window.supabase.createClient(url,key); }

      // ====== Estado de dados carregados ======
      let ROWS_ALL = [];
      let UNIQUES = [];

      // ====== Testar tabela: pega 1 linha e lista colunas ======
      async function testTable(){
        const map = getMap();
        if(!map.tbl){ log("[ERRO-Teste] Informe o nome da tabela."); return; }
        supa = createClient(map.url, map.key);
        log(`[Test] Buscando 1 linha de ${map.tbl} (sem ORDER, sem casts) …`);
        const r = await supa.from(map.tbl).select("*").limit(1);
        if(r.error){
          el.cols.textContent = "Colunas: erro";
          log("[ERRO-Teste] " + r.error.message);
          return;
        }
        if(!r.data || !r.data.length){
          el.cols.textContent = "Colunas: vazia ou bloqueada por RLS";
          log("[ERRO-Teste] Tabela vazia ou sem permissão (RLS).");
          return;
        }
        const cols = Object.keys(r.data[0]);
        el.cols.textContent = "Colunas: " + cols.join(", ");
        log("[OK] Colunas listadas. Ajuste os campos acima se necessário.");
      }

      // ====== Última data por ORDER (sem max()) com fallback ======
      async function getLastDate(map){
        // tenta ordenar desc na coluna de data
        const q = await supa.from(map.tbl).select(map.col_dt).not(map.col_dt,"is",null).order(map.col_dt,{ascending:false}).limit(1);
        if(q.error || !q.data || !q.data.length){
          if(q.error) log("[Warn] Falhou ORDER por data: " + q.error.message);
          // fallback: usa hoje (pode dar 0 linhas se base não tem hoje, mas o pedido é não usar max())
          const end = new Date();
          end.setHours(23,59,59,999);
          return end;
        }
        const v = q.data[0][map.col_dt];
        // v pode ser "YYYY-MM-DD" ou "DD/MM/YYYY"
        let d = null;
        if(typeof v === "string"){
          const s = v.trim();
          if(/^\\d{4}-\\d{2}-\\d{2}/.test(s)){ d = new Date(s+"T12:00:00"); }
          else if(/^\\d{2}\\/\\d{2}\\/\\d{4}/.test(s)){
            const [dd,mm,yyyy] = s.split("/").map(n=>parseInt(n,10));
            d = new Date(yyyy, mm-1, dd, 12, 0, 0);
          }else{
            d = new Date(s);
          }
        }else{
          d = new Date(v);
        }
        if(!(d instanceof Date) || isNaN(d)) d = new Date();
        d.setHours(23,59,59,999);
        return d;
      }

      // ====== Busca paginada ======
      async function fetchRange(map, fromISO, toISO){
        const page=10000; let acc=[], off=0;
        const cols = [map.col_dt, map.col_total, map.col_desc, map.col_ent].filter(Boolean);
        if(map.col_uni) cols.push(map.col_uni);
        const sel = cols.join(",");
        for(;;){
          const qr = await supa.from(map.tbl)
            .select(sel, { count:"estimated" })
            .gte(map.col_dt, fromISO)
            .lte(map.col_dt, toISO)
            .range(off, off+page-1);
          if(qr.error) throw qr.error;
          const arr = qr.data||[];
          acc = acc.concat(arr);
          if(arr.length < page) break;
          off += page;
        }
        return acc;
      }

      function fillUnits(map, rows){
        const set = new Set();
        if(map.col_uni){
          for(const r of rows){ const u = r[map.col_uni]; if(u!=null && String(u).trim()!=="") set.add(String(u)); }
        }
        const list = ["__ALL__", ...Array.from(set).sort((a,b)=>a.localeCompare(b,"pt-BR"))];
        el.selUni.innerHTML = "";
        for(const u of list){
          const opt = document.createElement("option");
          opt.value = u; opt.textContent = (u==="__ALL__" ? "Todas" : u);
          el.selUni.appendChild(opt);
        }
        UNIQUES = list;
      }

      function renderKPIs(map, rows){
        const uni = el.selUni.value || "__ALL__";
        const data = (uni==="__ALL__" || !map.col_uni) ? rows : rows.filter(r => String(r[map.col_uni])===uni);

        let pedidos = data.length, fat=0, des=0, fre=0;
        for(const r of data){
          fat += toNum(r[map.col_total]);
          des += toNum(r[map.col_desc]);
          fre += toNum(r[map.col_ent]);
        }
        el.ped.textContent = fmtInt(pedidos);
        el.fat.textContent = fmtBRL(fat);
        el.dsc.textContent = fmtBRL(des);
        el.fre.textContent = fmtBRL(fre);
      }

      async function loadKPIs(){
        const map = getMap();
        if(!map.tbl || !map.col_dt || !map.col_total){
          log("[ERRO-Carregar] Informe ao menos: tabela, coluna de data e valor total.");
          return;
        }
        supa = createClient(map.url, map.key);

        log(`[Query] ${map.tbl} → localizando última data por ORDER em '${map.col_dt}' …`);
        const end = await getLastDate(map);
        const start = new Date(end); start.setDate(end.getDate()-29); start.setHours(0,0,0,0);
        el.periodo.textContent = "Período: " + toISO(start) + " → " + toISO(end);
        log("[Query] Janela " + toISO(start) + " → " + toISO(end));

        try{
          const rows = await fetchRange(map, toISO(start), toISO(end));
          ROWS_ALL = rows;
          log("[OK] Linhas retornadas: " + rows.length.toLocaleString("pt-BR"));
          fillUnits(map, rows);
          renderKPIs(map, rows);
          log("[OK] KPIs calculados.");
        }catch(e){
          log("[ERRO] " + (e.message||String(e)));
        }
      }

      // ====== Eventos ======
      el.btTest.onclick = testTable;
      el.btLoad.onclick = loadKPIs;
      el.btSave.onclick = () => { saveMapToLS( getMap() ); log("[OK] Mapeamento salvo no navegador."); };
      el.selUni.onchange = () => { if(ROWS_ALL.length){ renderKPIs(getMap(), ROWS_ALL); } };

      // ====== Boot ======
      (function boot(){
        log("[Boot] v10.1 — mapeamento fixo padrão para 'vendas' (sem max())");
        const saved = loadMapFromLS();
        setMap( saved || DEFAULTS );
        // Auto-teste na primeira carga (não trava se falhar)
        testTable().then(()=>{}).catch(()=>{});
      })();
    </script>
  </body>
</html>
