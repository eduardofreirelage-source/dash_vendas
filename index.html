<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v17.2-MV-paged-fix3+chips-loja)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--up:#16a34a;--down:#dc2626}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}

    /* Filtros dropdown */
    details.filtros{border:1px solid var(--brd);border-radius:12px;background:var(--card);overflow:hidden}
    details.filtros>summary{list-style:none;cursor:pointer;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
    details.filtros>summary::-webkit-details-marker{display:none}
    .sumTitle{font-size:14px}
    .sumHint{font-size:12px;color:var(--muted)}
    .fbody{padding:12px 14px 16px;border-top:1px solid var(--brd)}
    .grid12{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:12px}
    .seg{display:flex;flex-direction:column;gap:6px;min-width:0}
    .seg .lbl{font-size:12px;color:var(--muted)}
    select,input[type="date"]{font:inherit;padding:10px 12px;border:1px solid var(--brd);border-radius:10px;background:#fff;width:100%;min-height:40px}
    .rightBar{display:flex;gap:8px;align-items:center}
    .subtle{background:#fff;border:1px solid var(--brd);border-radius:10px;padding:8px 12px;cursor:pointer;opacity:.95}
    .subtle:hover{opacity:1}

    /* Chips (lojas) */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid var(--brd);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;user-select:none;font-size:13px}
    .chip[aria-checked="true"]{background:#f1f5f9;border-color:#cbd5e1}
    .chip:focus{outline:2px solid #cbd5e1;outline-offset:2px}

    /* Col spans */
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}

    /* Responsivo */
    @media (max-width:980px){.grid12{grid-template-columns:repeat(6,minmax(0,1fr))}}
    @media (max-width:560px){.grid12{grid-template-columns:repeat(1,minmax(0,1fr))}.col-12,.col-6,.col-4,.col-3,.col-2{grid-column:span 1}}

    /* KPIs */
    .krow{display:grid;gap:12px;margin-top:12px}
    .krow.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .krow.four{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:980px){.krow.two{grid-template-columns:1fr}.krow.four{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.krow.four{grid-template-columns:1fr}}
    .kcard .khead{display:flex;align-items:center;justify-content:space-between}
    .kcard .title{font-size:12px;color:var(--muted)}
    .kcard .val{font-size:22px;font-weight:700;margin-top:6px}
    .kcard .sub{margin-top:6px}
    .badge{font-size:12px;font-weight:700;white-space:nowrap}
    .badge.up{color:var(--up)} .badge.down{color:var(--down)} .badge.flat{color:var(--muted)}

    /* Charts */
    .chartbox{position:relative;height:280px;width:100%}
    .ctop{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .segSwitch{display:inline-flex;border:1px solid var(--brd);border-radius:10px;overflow:hidden}
    .segSwitch button{padding:6px 10px;border:0;background:#fff;cursor:pointer}
    .segSwitch button.active{background:#f1f5f9}
    .hidden{display:none}
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:flex-end">
      <div>
        <h1>Dashboard Vendas — Supabase <span class="muted">(v17.2-MV-paged-fix3)</span></h1>
        <div class="muted">Fonte: <code>public.vendas_kpi_daily_v2</code> (paginado)</div>
        <div class="muted" id="periodo">Período: —</div>
        <div class="muted" id="limites">Limites no banco: —</div>
      </div>
      <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
    </div>

    <!-- ===== FILTROS (dropdown) ===== -->
    <details id="fltBox" class="filtros" open>
      <summary>
        <span class="sumTitle">FILTROS</span>
        <div class="rightBar">
          <span class="sumHint" id="sumHint">—</span>
          <button id="limpar" class="subtle">Limpar filtros</button>
        </div>
      </summary>
      <div class="fbody">
        <!-- Linha 1: Unidade (6) + Nome da loja (6, chips) -->
        <div class="grid12">
          <div class="seg col-6">
            <span class="lbl">Unidade</span>
            <select id="uni"></select>
          </div>
          <div class="seg col-6 hidden" id="segLoja">
            <span class="lbl">Nome da loja (Top 10 por faturamento)</span>
            <div id="lojaChips" class="chips"></div>
          </div>
        </div>

        <!-- Linha 2: De(3) Até(3) PR(2) Turno(2) DOW(2) -->
        <div class="grid12" style="margin-top:10px">
          <div class="seg col-3"><span class="lbl">De</span><input id="dini" type="date"/></div>
          <div class="seg col-3"><span class="lbl">Até</span><input id="dfim" type="date"/></div>
          <div class="seg col-2">
            <span class="lbl">Período rápido (dias)</span>
            <select id="prapido">
              <option value="">—</option><option value="7">7</option><option value="15">15</option>
              <option value="30" selected>30</option><option value="90">90</option><option value="180">180</option><option value="360">360</option>
            </select>
          </div>
          <div class="seg col-2 hidden" id="segTurno"><span class="lbl">Turno</span><select id="turno"><option value="todos">Todos</option></select></div>
          <div class="seg col-2" id="segDOW">
            <span class="lbl">Dia da semana</span>
            <select id="dow">
              <option value="todos" selected>Todos</option><option value="uteis">Úteis (Seg–Sex)</option><option value="fds">Fins de semana</option>
              <option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option><option value="4">Qui</option><option value="5">Sex</option><option value="6">Sáb</option><option value="0">Dom</option>
            </select>
          </div>
        </div>

        <!-- Linha 3: Canal(4) Pagamento(4) Cancelado(4) -->
        <div class="grid12" style="margin-top:10px">
          <div class="seg col-4 hidden" id="segCanal"><span class="lbl">Canal de venda</span><select id="canal"><option value="todos">Todos</option></select></div>
          <div class="seg col-4 hidden" id="segPagto"><span class="lbl">Pagamento</span><select id="pagto"><option value="todos">Todos</option></select></div>
          <div class="seg col-4 hidden" id="segCanc">
            <span class="lbl">Está cancelado</span>
            <select id="canc"><option value="todos" selected>Todos</option><option value="sim">Somente cancelados</option><option value="nao">Somente não cancelados</option></select>
          </div>
        </div>

        <div class="muted" style="margin-top:8px">Datas limitadas ao intervalo existente (âncora: último dia disponível).</div>
      </div>
    </details>

    <!-- ===== KPIs (ordem aprovada) ===== -->
    <div class="krow two">
      <div class="card kcard"><div class="khead"><div class="title">Pedidos</div><div class="badge" id="k_ped_badge">—</div></div><div class="val" id="k_ped_val">…</div><div class="muted sub" id="k_ped_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Ticket médio</div><div class="badge" id="k_ticket_badge">—</div></div><div class="val" id="k_ticket_val">…</div><div class="muted sub" id="k_ticket_sub">—</div></div>
    </div>
    <div class="krow four">
      <div class="card kcard"><div class="khead"><div class="title">Faturamento</div><div class="badge" id="k_fat_badge">—</div></div><div class="val" id="k_fat_val">…</div><div class="muted sub" id="k_fat_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Faturamento médio (por dia)</div><div class="badge" id="k_fat_med_badge">—</div></div><div class="val" id="k_fat_med_val">…</div><div class="muted sub" id="k_fat_med_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Faturamento líquido</div><div class="badge" id="k_fatliq_badge">—</div></div><div class="val" id="k_fatliq_val">…</div><div class="muted sub" id="k_fatliq_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Faturamento líquido %</div><div class="badge" id="k_fatliq_pct_badge">—</div></div><div class="val" id="k_fatliq_pct_val">…</div><div class="muted sub" id="k_fatliq_pct_sub">—</div></div>
    </div>
    <div class="krow four">
      <div class="card kcard"><div class="khead"><div class="title">Incentivos</div><div class="badge" id="k_des_badge">—</div></div><div class="val" id="k_des_val">…</div><div class="muted sub" id="k_des_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Incentivos %</div><div class="badge" id="k_des_pct_badge">—</div></div><div class="val" id="k_des_pct_val">…</div><div class="muted sub" id="k_des_pct_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Frete</div><div class="badge" id="k_fre_badge">—</div></div><div class="val" id="k_fre_val">…</div><div class="muted sub" id="k_fre_sub">—</div></div>
      <div class="card kcard"><div class="khead"><div class="title">Frete médio</div><div class="badge" id="k_fre_med_badge">—</div></div><div class="val" id="k_fre_med_val">…</div><div class="muted sub" id="k_fre_med_sub">—</div></div>
    </div>

    <!-- ===== Gráficos (Total ⇄ Média) ===== -->
    <div class="card" style="margin-top:12px">
      <div class="ctop">
        <div class="title">Receita diária</div>
        <div class="segSwitch" data-target="gDaily">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="avg">Média (período)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="gDaily"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="ctop">
        <div class="title">Receita por dia da semana</div>
        <div class="segSwitch" data-target="gDOW">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="avg">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="gDOW"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="ctop">
        <div class="title">Receita por mês</div>
        <div class="segSwitch" data-target="gMonth">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="avg">Média diária</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="gMonth"></canvas></div>
    </div>

    <div id="hourCard" class="card hidden" style="margin-top:12px">
      <div class="ctop">
        <div class="title">Receita por hora</div>
        <div class="segSwitch" data-target="gHour">
          <button data-mode="total" class="active">Total</button>
          <button data-mode="avg">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="gHour"></canvas></div>
    </div>

    <!-- Logs -->
    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  var SUPABASE_URL="https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var TABLE="vendas_kpi_daily_v2";

  var elLog=document.getElementById("log"), elPeriodo=document.getElementById("periodo"), elLimites=document.getElementById("limites"), sumHint=document.getElementById("sumHint");
  var fltBox=document.getElementById("fltBox");
  var selUni=document.getElementById("uni"), dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), prapido=document.getElementById("prapido"), selDOW=document.getElementById("dow");
  var segTurno=document.getElementById("segTurno"), segCanal=document.getElementById("segCanal"), segPagto=document.getElementById("segPagto"), segCanc=document.getElementById("segCanc");
  var selTurno=document.getElementById("turno"), selCanal=document.getElementById("canal"), selPagto=document.getElementById("pagto"), selCanc=document.getElementById("canc");
  var segLoja=document.getElementById("segLoja"), lojaChips=document.getElementById("lojaChips");
  var hourCard=document.getElementById("hourCard");

  function log(s){ elLog.textContent+="\n"+s; }
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function fmtPct(n){ return (Number(n)||0).toFixed(1).replace('.', ',')+"%"; }
  function toISO(d){ return d.toISOString().slice(0,10); }
  function addDays(d,k){ var t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function sum(arr,key){ var s=0; for(var i=0;i<arr.length;i++) s+=Number(arr[i][key]||0); return s; }
  function debounce(fn,wait){ var t; return function(){ var a=arguments,c=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(c,a); },wait); }; }
  function getDateFromInput(el){ if(!el.value) return null; return new Date(el.value+"T00:00:00Z"); }
  function setDateInput(el,iso){ el.value=iso||""; if(dataMinISO) el.min=dataMinISO; if(dataMaxISO) el.max=dataMaxISO; }
  function badge(el,pct){ var cls=pct>0?"badge up":(pct<0?"badge down":"badge flat"); var arrow=pct>0?"▲":(pct<0?"▼":"•"); el.className=cls; el.textContent=arrow+" "+pct.toFixed(1).replace('.',',')+"%"; }
  var collapse=debounce(function(){ fltBox.open=false; },800);
  function touchFilters(){ updateSummaryHint(); collapse(); }

  var supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON,{auth:{persistSession:false}});

  var chartDaily=null, chartDOW=null, chartMonth=null, chartHour=null, runId=0, dataMinISO=null, dataMaxISO=null;
  var schema={ turno:null, canal:null, pagamento:null, cancelado:null, cancelType:null, hora:null, loja:null };

  // ===== estado de seleção das lojas (chips) =====
  var lojaSelSet = new Set();

  // ===== build select dinâmico =====
  function buildSelect(){
    var base="dia,unidade,pedidos,fat,des,fre";
    if(schema.hora) base+=","+schema.hora;
    if(schema.loja) base+=","+schema.loja;
    return base;
  }

  // ===== filtros server-side (com opção de pular loja p/ montar Top10) =====
  function getSelectedLojas(){
    return Array.from(lojaSelSet);
  }
  function applyServerFilters(q, opts){
    opts=opts||{};
    if(schema.turno && selTurno.value!=="todos") q=q.eq(schema.turno,selTurno.value);
    if(schema.canal && selCanal.value!=="todos") q=q.eq(schema.canal,selCanal.value);
    if(schema.pagamento && selPagto.value!=="todos") q=q.eq(schema.pagamento,selPagto.value);
    if(schema.cancelado && selCanc.value!=="todos"){
      var val=selCanc.value==="sim";
      if(schema.cancelType==="bool"){ q=q.eq(schema.cancelado,val); }
      else if(schema.cancelType==="num"){ q=q.eq(schema.cancelado,val?1:0); }
      else if(schema.cancelType==="str"){ q=q.in(schema.cancelado,val?["Sim","sim","S","1","true","TRUE"]:["Não","Nao","não","nao","N","0","false","FALSE"]); }
      else { q=q.eq(schema.cancelado,val); }
    }
    if(schema.loja && !opts.skipLoja){
      var lojas=getSelectedLojas();
      if(lojas.length>0){ q=q.in(schema.loja, lojas); }
    }
    return q;
  }

  async function fetchPaged(startISO,endISO,unidade,opts){
    var page=1000,off=0,out=[];
    for(;;){
      var q=supa.from(TABLE).select(buildSelect()).gte("dia",startISO).lte("dia",endISO).order("dia",{ascending:true}).range(off,off+page-1);
      if(unidade && unidade!=="Todas") q=q.eq("unidade",unidade);
      q=applyServerFilters(q,opts);
      var r=await q; if(r.error) throw r.error;
      var a=r.data||[]; out=out.concat(a);
      if(a.length<page) break; off+=page;
      if(off>500000){ log("[Warn] abort paginado."); break; }
    }
    return out;
  }

  // ===== unidades e limites =====
  async function fetchUnidades(){
    var uniq={}, arr=["Todas"];
    function push(list){ (list||[]).forEach(r=>{ var u=(r.unidade||"").trim(); if(!u) return; if(!uniq[u]){ uniq[u]=1; arr.push(u);} }); }
    var today=new Date(), endISO=toISO(new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate()))), startISO="2020-01-01";
    var r1=await supa.from(TABLE).select("unidade").gte("dia",startISO).lte("dia",endISO).order("unidade",{ascending:true}).range(0,9999); if(!r1.error) push(r1.data);
    var r2=await supa.from(TABLE).select("unidade").gte("dia",startISO).lte("dia",endISO).order("unidade",{ascending:false}).range(0,9999); if(!r2.error) push(r2.data);
    if(arr.length===1){ arr.push("Uni. Raja","Uni.Savassi"); }
    return arr;
  }
  async function getDateBounds(unidade){
    var qMax=supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    var qMin=supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    if(unidade && unidade!=="Todas"){ qMax=qMax.eq("unidade",unidade); qMin=qMin.eq("unidade",unidade); }
    var [rMax,rMin]=await Promise.all([qMax,qMin]); if(rMax.error) throw rMax.error; if(rMin.error) throw rMin.error;
    return {maxISO:(rMax.data&&rMax.data[0])?rMax.data[0].dia:null, minISO:(rMin.data&&rMin.data[0])?rMin.data[0].dia:null};
  }
  async function refreshBounds(unidade){
    var b=await getDateBounds(unidade); dataMinISO=b.minISO; dataMaxISO=b.maxISO;
    if(!dataMaxISO||!dataMinISO){ elLimites.textContent="Limites no banco: — (sem dados)"; return; }
    elLimites.textContent="Limites no banco: "+dataMinISO+" → "+dataMaxISO+(unidade&&unidade!=="Todas"?" • Unidade: "+unidade:" • Todas");
    setDateInput(dini,dataMinISO); setDateInput(dfim,dataMaxISO);
  }

  // ===== schema (inclui hora + loja) =====
  async function inspectSchema(unidade){
    var q=supa.from(TABLE).select("*").limit(1); if(unidade && unidade!=="Todas") q=q.eq("unidade",unidade);
    var r=await q; if(r.error){ log("[Schema] falhou: "+r.error.message); return; }
    var row=(r.data&&r.data[0])?r.data[0]:{};
    function pick(keys){ for(var i=0;i<keys.length;i++){ if(keys[i] in row) return keys[i]; } return null; }
    schema.turno=pick(["turno","periodo_turno","shift"]);
    schema.canal=pick(["canal_venda","canal","origem","origem_pedido"]);
    schema.pagamento=pick(["pagamento","forma_pagamento","meio_pagamento","metodo_pagamento"]);
    schema.cancelado=pick(["cancelado","is_cancelado","cancel"]);
    schema.hora=pick(["hora","hr","hora_pedido","hour"]);
    schema.loja=pick(["nome_loja","loja","loja_nome","estabelecimento","nome_da_loja"]);
    schema.cancelType=null; if(schema.cancelado){ var v=row[schema.cancelado]; if(typeof v==="boolean") schema.cancelType="bool"; else if(v===0||v===1) schema.cancelType="num"; else if(typeof v==="string") schema.cancelType="str"; }
    segTurno.classList.toggle("hidden",!schema.turno);
    segCanal.classList.toggle("hidden",!schema.canal);
    segPagto.classList.toggle("hidden",!schema.pagamento);
    segCanc.classList.toggle("hidden",!schema.cancelado);
    segLoja.classList.toggle("hidden",!schema.loja);
  }

  // ===== chips de loja (Top 10) =====
  function renderLojaChips(list){
    // preserva seleção anterior
    var prevSel = new Set(lojaSelSet);
    lojaChips.innerHTML="";
    (list||[]).forEach(nome=>{
      var b=document.createElement("button");
      b.type="button";
      b.className="chip";
      b.setAttribute("role","checkbox");
      b.setAttribute("aria-checked", prevSel.has(String(nome)) ? "true" : "false");
      b.dataset.value=String(nome);
      b.textContent=String(nome);
      b.addEventListener("click", function(){
        var val=this.dataset.value;
        var isOn = this.getAttribute("aria-checked")==="true";
        if(isOn){ lojaSelSet.delete(val); this.setAttribute("aria-checked","false"); }
        else{ lojaSelSet.add(val); this.setAttribute("aria-checked","true"); }
        updateSummaryOnChange();
      });
      lojaChips.appendChild(b);
    });
    // remove marcas que não existem mais
    Array.from(prevSel).forEach(v=>{ if(!(list||[]).includes(v)) lojaSelSet.delete(v); });
  }
  function top10LojasByFat(rows){
    if(!schema.loja) return [];
    var map={}; rows.forEach(r=>{
      var lj=String(r[schema.loja]||"").trim(); if(!lj) return;
      map[lj]=(map[lj]||0)+Number(r.fat||0);
    });
    var arr=Object.keys(map).map(k=>({k,v:map[k]}));
    arr.sort((a,b)=>b.v-a.v);
    return arr.slice(0,10).map(x=>x.k);
  }

  // ===== DOW/datas =====
  function mapDOWSelectionToList(){ var v=selDOW.value||"todos"; if(v==="todos") return [0,1,2,3,4,5,6]; if(v==="uteis") return [1,2,3,4,5]; if(v==="fds") return [6,0]; return [Number(v)]; }
  function clampDateWithinBounds(d){ if(!d) return null; if(!dataMinISO||!dataMaxISO) return d; var min=new Date(dataMinISO+"T00:00:00Z"), max=new Date(dataMaxISO+"T00:00:00Z"); if(d<min) return min; if(d>max) return max; return d; }
  function validateInputsOrWarn(){
    if(!dataMinISO||!dataMaxISO) return true;
    var ps=getDateFromInput(dini), pe=getDateFromInput(dfim);
    if(ps&&pe){ var s=clampDateWithinBounds(ps), e=clampDateWithinBounds(pe); if(s>e){ log("[Erro] 'De' > 'Até'"); return false; } setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e)); }
    return true;
  }

  // ===== KPIs =====
  function badgePctChange(cur,prev){ return (prev>0)?((cur-prev)/prev*100):0; }
  function updateKPIs(rows,rowsAnt,daysCur,daysAnt){
    var ped=sum(rows,"pedidos"), fat=sum(rows,"fat"), des=sum(rows,"des"), fre=sum(rows,"fre");
    var pedA=sum(rowsAnt,"pedidos"), fatA=sum(rowsAnt,"fat"), desA=sum(rowsAnt,"des"), freA=sum(rowsAnt,"fre");
    var taxa=0.12*fat, taxaA=0.12*fatA;
    var fatliq=fat-des-fre-taxa, fatliqA=fatA-desA-freA-taxaA;
    var desPct = fat>0 ? (des/fat*100):0, desPctA=fatA>0?(desA/fatA*100):0;
    var ticket = ped>0? (fat/ped):0, ticketA=pedA>0?(fatA/pedA):0;
    var freMed = ped>0? (fre/ped):0, freMedA=pedA>0?(freA/pedA):0;
    var fatMed = daysCur>0? (fat/daysCur):0, fatMedA=daysAnt>0?(fatA/daysAnt):0;
    var fatliqPct = fat>0? (fatliq/fat*100):0, fatliqPctA=fatA>0?(fatliqA/fatA*100):0;

    function setK(idVal,idSub,idBadge,cur,prev,fmt,asPct){
      document.getElementById(idVal).textContent = asPct? fmtPct(cur) : fmt(cur);
      document.getElementById(idSub).textContent = "ant: " + (asPct? fmtPct(prev) : fmt(prev));
      badge(document.getElementById(idBadge), badgePctChange(cur,prev));
    }
    setK("k_ped_val","k_ped_sub","k_ped_badge",ped,pedA,fmtInt,false);
    setK("k_ticket_val","k_ticket_sub","k_ticket_badge",ticket,ticketA,fmtBRL,false);
    setK("k_fat_val","k_fat_sub","k_fat_badge",fat,fatA,fmtBRL,false);
    setK("k_fat_med_val","k_fat_med_sub","k_fat_med_badge",fatMed,fatMedA,fmtBRL,false);
    setK("k_fatliq_val","k_fatliq_sub","k_fatliq_badge",fatliq,fatliqA,fmtBRL,false);
    setK("k_fatliq_pct_val","k_fatliq_pct_sub","k_fatliq_pct_badge",fatliqPct,fatliqPctA,fmtPct,true);
    setK("k_des_val","k_des_sub","k_des_badge",des,desA,fmtBRL,false);
    setK("k_des_pct_val","k_des_pct_sub","k_des_pct_badge",desPct,desPctA,fmtPct,true);
    setK("k_fre_val","k_fre_sub","k_fre_badge",fre,freA,fmtBRL,false);
    setK("k_fre_med_val","k_fre_med_sub","k_fre_med_badge",freMed,freMedA,fmtBRL,false);
  }

  // ===== Agregações p/ gráficos (média REAL) =====
  function buildDailyTotals(rows){ var m={}; rows.forEach(r=>{ var d=r.dia; m[d]=(m[d]||0)+Number(r.fat||0); }); var days=Object.keys(m).sort(); return {days, totals:days.map(d=>m[d])}; }
  function groupDaily(rows){ var d=buildDailyTotals(rows); return {labels:d.days, totals:d.totals}; }
  function groupDOW(rows){ var d=buildDailyTotals(rows), totals=[0,0,0,0,0,0,0], counts=[0,0,0,0,0,0,0]; d.days.forEach((day,i)=>{ var dow=new Date(day+"T00:00:00Z").getUTCDay(); totals[dow]+=d.totals[i]; counts[dow]+=1; }); return {labels:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], totals, counts}; }
  function groupMonth(rows){ var d=buildDailyTotals(rows), map={}; d.days.forEach((day,i)=>{ var key=day.slice(0,7); if(!map[key]) map[key]={t:0,c:0}; map[key].t+=d.totals[i]; map[key].c+=1; }); var labels=Object.keys(map).sort(); return {labels, totals:labels.map(k=>map[k].t), counts:labels.map(k=>map[k].c)}; }
  function groupHour(rows){
    if(!schema.hora) return {labels:[], totals:[], counts:[]};
    var byDayHour={}, totals=new Array(24).fill(0), counts=new Array(24).fill(0), daysByHour=[...Array(24)].map(()=>new Set());
    rows.forEach(r=>{ var h=Number(r[schema.hora]); if(isNaN(h)||h<0||h>23) return; var key=r.dia+"|"+h; byDayHour[key]=(byDayHour[key]||0)+Number(r.fat||0); });
    Object.keys(byDayHour).forEach(k=>{ var [d,h]=k.split("|"); h=Number(h); totals[h]+=byDayHour[k]; daysByHour[h].add(d); });
    for(var i=0;i<24;i++) counts[i]=daysByHour[i].size;
    return {labels:totals.map((_,i)=>String(i).padStart(2,"0")+":00"), totals, counts};
  }

  function renderChart(canvasId,type,labels,totals,mode,countsOpt){
    var ctx=document.getElementById(canvasId).getContext("2d");
    var ref = canvasId==="gDaily"?chartDaily:canvasId==="gDOW"?chartDOW:canvasId==="gMonth"?chartMonth:chartHour;
    if(ref){ ref.destroy(); ref=null; }
    var dataVals;
    if(mode==="avg"){
      if(canvasId==="gDaily"){
        var sumT=totals.reduce((a,b)=>a+b,0), n=labels.length||1, avg=sumT/(n||1);
        dataVals = labels.map(()=>avg); // linha plana na média diária
      }else if(countsOpt){
        dataVals = totals.map((v,i)=> (countsOpt[i]>0? v/countsOpt[i] : 0));
      }else{
        dataVals = totals.slice();
      }
    }else{
      dataVals = totals.slice();
    }
    var c=new window.Chart(ctx,{type:type,data:{labels:labels,datasets:[{label:(mode==="avg"?"Média":"Total"),data:dataVals}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
    if(canvasId==="gDaily") chartDaily=c; else if(canvasId==="gDOW") chartDOW=c; else if(canvasId==="gMonth") chartMonth=c; else chartHour=c;
  }

  var _lastRows=[]; // guarda amostra atual p/ toggles
  function drawAllCharts(rows){
    _lastRows = rows.slice();
    var d=groupDaily(rows);        renderChart("gDaily","line", d.labels, d.totals, "total");
    var w=groupDOW(rows);          renderChart("gDOW","bar",   w.labels, w.totals, "total", w.counts);
    var m=groupMonth(rows);        renderChart("gMonth","bar", m.labels, m.totals, "total", m.counts);
    if(schema.hora){
      var h=groupHour(rows);       renderChart("gHour","bar",  h.labels, h.totals, "total", h.counts);
      hourCard.classList.remove("hidden");
    }else{
      hourCard.classList.add("hidden");
    }
  }

  document.querySelectorAll(".segSwitch").forEach(sw=>{
    sw.addEventListener("click",function(e){
      if(e.target.tagName!=="BUTTON") return;
      sw.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
      e.target.classList.add("active");
      var mode=e.target.getAttribute("data-mode"), target=sw.getAttribute("data-target");
      if(!_lastRows.length) return;
      if(target==="gDaily"){ var d=groupDaily(_lastRows); renderChart("gDaily","line", d.labels, d.totals, mode); }
      if(target==="gDOW"){   var w=groupDOW(_lastRows);   renderChart("gDOW","bar",   w.labels, w.totals, mode, w.counts); }
      if(target==="gMonth"){ var m=groupMonth(_lastRows); renderChart("gMonth","bar", m.labels, m.totals, mode, m.counts); }
      if(target==="gHour" && schema.hora){ var h=groupHour(_lastRows); renderChart("gHour","bar", h.labels, h.totals, mode, h.counts); }
    });
  });

  function applyDOWClient(rows){
    var keep={}; mapDOWSelectionToList().forEach(d=>keep[d]=1);
    return rows.filter(r=> keep[new Date(r.dia+"T00:00:00Z").getUTCDay()]);
  }

  function updateSummaryHint(){
    var pr=prapido.value?prapido.value+"d":"—"; var uni=selUni.value||"Todas";
    var nj=schema.loja? lojaSelSet.size : 0;
    sumHint.textContent="Unidade: "+uni+" • PR: "+pr+(schema.loja?(" • Lojas: "+(nj>0?nj:"todas")):"");
  }

  async function recarregar(){
    const myRun=++runId;
    try{
      if(!dataMaxISO||!dataMinISO){ await refreshBounds(selUni.value||"Todas"); if(!dataMaxISO||!dataMinISO){ elPeriodo.textContent="Período: —"; return; } }
      if(!validateInputsOrWarn()) return;

      var ps=getDateFromInput(dini), pe=getDateFromInput(dfim), s,e;
      if(ps&&pe){ s=clampDateWithinBounds(ps); e=clampDateWithinBounds(pe); }
      else{ e=new Date(dataMaxISO+"T00:00:00Z"); s=addDays(e,-29); var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate; setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e)); }

      var startISO=toISO(s), endISO=toISO(e);
      var daysLen=Math.max(1,Math.round((e-s)/(24*3600*1000))+1);
      var prevEnd=addDays(s,-1), prevStart=addDays(prevEnd,-(daysLen-1));
      var prevStartISO=toISO(prevStart), prevEndISO=toISO(prevEnd);
      var prevDaysLen=Math.max(1,Math.round((prevEnd-prevStart)/(24*3600*1000))+1);

      elPeriodo.textContent="Período: "+startISO+" → "+endISO+" (âncora: "+dataMaxISO+")";
      var uniVal=selUni.value||"Todas";

      // 1) Base atual sem filtro de loja -> montar Top10
      var baseCur=await fetchPaged(startISO,endISO,uniVal==="Todas"?null:uniVal,{skipLoja:true}); if(myRun!==runId) return;
      var baseCurDOW=applyDOWClient(baseCur);

      // monta chips Top10
      if(schema.loja){
        var top10 = top10LojasByFat(baseCurDOW);
        renderLojaChips(top10);
      }

      // aplica loja (cliente)
      var lojasSel = getSelectedLojas();
      var curF = (!schema.loja || lojasSel.length===0) ? baseCurDOW
                 : baseCurDOW.filter(r => lojasSel.includes(String(r[schema.loja])));

      // 2) Período anterior (com loja já aplicada no servidor se selecionada)
      var ant = await fetchPaged(prevStartISO,prevEndISO,uniVal==="Todas"?null:uniVal,{skipLoja:false}); if(myRun!==runId) return;
      var antF = applyDOWClient(ant);

      updateKPIs(curF,antF,daysLen,prevDaysLen);
      drawAllCharts(curF);
      updateSummaryHint();
    }catch(e){ if(myRun!==runId) return; console.error(e); log("[ERRO] "+(e.message||String(e))); }
  }
  var recarregarDebounced=debounce(recarregar,120);

  async function refreshFilterOptions(startISO,endISO,unidade){
    var tasks=[];
    if(schema.turno) tasks.push(loadDistinct(schema.turno,document.getElementById("turno"),startISO,endISO,unidade));
    if(schema.canal) tasks.push(loadDistinct(schema.canal,document.getElementById("canal"),startISO,endISO,unidade));
    if(schema.pagamento) tasks.push(loadDistinct(schema.pagamento,document.getElementById("pagto"),startISO,endISO,unidade));
    await Promise.all(tasks);
  }
  function setOptionsWithTodos(sel,items){ var prev=sel.value||"todos"; sel.innerHTML=""; var o0=document.createElement("option"); o0.value="todos"; o0.textContent="Todos"; sel.appendChild(o0); (items||[]).forEach(v=>{ var o=document.createElement("option"); o.value=String(v); o.textContent=String(v); sel.appendChild(o); }); sel.value=[...sel.options].some(o=>o.value===prev)?prev:"todos"; }
  async function loadDistinct(col,sel,startISO,endISO,unidade){
    var uniq={}, out=[], page=1000, off=0;
    for(;;){
      var q=supa.from(TABLE).select(col).gte("dia",startISO).lte("dia",endISO).order(col,{ascending:true}).range(off,off+page-1);
      if(unidade&&unidade!=="Todas") q=q.eq("unidade",unidade);
      var r=await q; if(r.error) break; var a=r.data||[];
      for(var i=0;i<a.length;i++){ var v=a[i][col]; if(v==null||v==="") continue; if(!uniq[v]){ uniq[v]=1; out.push(v);} }
      if(a.length<page) break; off+=page; if(off>200000) break;
    }
    setOptionsWithTodos(sel,out);
  }

  function updateSummaryOnChange(){ touchFilters(); recarregarDebounced(); }

  // ===== Boot =====
  async function boot(){
    log("[Boot] v17.2-MV-paged-fix3 — chips de loja + média real nos gráficos");
    var opts=await fetchUnidades(); selUni.innerHTML=""; opts.forEach(u=>{ var o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); }); selUni.value="Todas";
    await refreshBounds("Todas"); await inspectSchema("Todas");
    if(dataMaxISO&&dataMinISO){ var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-29); var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate; setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e)); }
    if(dataMaxISO&&dataMinISO){ await refreshFilterOptions(dini.value,dfim.value,selUni.value); }
    updateSummaryHint();
    recarregar();
  }

  // ===== Eventos =====
  prapido.addEventListener("change",async function(){
    if(!prapido.value) return;
    if(!dataMaxISO||!dataMinISO){ await refreshBounds(selUni.value||"Todas"); if(!dataMaxISO) return; }
    var d=Number(prapido.value), e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-(d-1));
    var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate;
    setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
    await refreshFilterOptions(dini.value, dfim.value, selUni.value);
    updateSummaryOnChange();
  });
  [dini,dfim].forEach(el=>el.addEventListener("change",async function(){
    if(!validateInputsOrWarn()) return; prapido.value="";
    await refreshFilterOptions(dini.value, dfim.value, selUni.value);
    updateSummaryOnChange();
  }));
  selUni.addEventListener("change",async function(){
    await refreshBounds(selUni.value||"Todas"); await inspectSchema(selUni.value||"Todas");
    var d=Number(prapido.value||30);
    if(dataMaxISO&&dataMinISO){ var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-(d-1)); var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate; setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e)); await refreshFilterOptions(dini.value, dfim.value, selUni.value); }
    updateSummaryOnChange();
  });
  [selDOW,selTurno,selCanal,selPagto,selCanc].forEach(function(el){ if(!el) return; el.addEventListener("change",updateSummaryOnChange); });
  document.getElementById("limpar").addEventListener("click",async function(){
    fltBox.open=true; selUni.value="Todas"; prapido.value="30"; selDOW.value="todos";
    if(schema.turno) selTurno.value="todos"; if(schema.canal) selCanal.value="todos"; if(schema.pagamento) selPagto.value="todos"; if(schema.cancelado) selCanc.value="todos";
    lojaSelSet.clear(); // limpa seleção de lojas
    await refreshBounds("Todas");
    if(dataMaxISO&&dataMinISO){ var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-29); var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate; setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e)); await refreshFilterOptions(dini.value, dfim.value, selUni.value); }
    updateSummaryHint(); recarregarDebounced();
  });

  boot();
})();
</script>
</body>
</html>
