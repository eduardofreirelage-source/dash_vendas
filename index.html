<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Supabase (v9 manual mapping)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --bg:#f6f7fb; --ink:#0f172a; --mut:#6b7280; --card:#fff; --brd:#e5e7eb; --ok:#059669; --err:#dc2626; }
      html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--mut);font-size:12px}
      .row{display:flex;gap:10px;flex-wrap:wrap}
      .card{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
      .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
      .title{font-size:12px;color:var(--mut)}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap;max-height:260px}
      code{background:#eef2ff;padding:0 4px;border-radius:4px}
      input,select,button{padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff;color:var(--ink);font:13px}
      button{cursor:pointer}
      button.primary{background:#2563eb;border-color:#2563eb;color:#fff}
      .chip{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:2px 8px;border-radius:999px;font-size:12px;margin:2px;cursor:pointer}
      .ok{color:var(--ok)} .err{color:var(--err)}
      @media (max-width:820px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:520px){.grid4,.grid2{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Build v9 (mapeamento manual, sem <code>max()</code>) • GitHub Pages</div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <!-- Config -->
      <div class="card" style="margin-top:14px">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="title">Credenciais</div>
          <div class="muted">Usei a URL e a anon key que você forneceu</div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <input id="inp_url"  type="text" placeholder="SUPABASE_URL" value="https://uahmcfzerofhzjvlzrqc.supabase.co" />
          <input id="inp_key"  type="text" placeholder="SUPABASE_ANON_KEY" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" />
        </div>
      </div>

      <!-- Tabela & Mapeamento -->
      <div class="card" style="margin-top:12px">
        <div class="title">Tabela & Mapeamento de Colunas</div>
        <div class="row" style="margin-top:8px">
          <input id="inp_table" type="text" style="flex:1" placeholder="Nome da tabela (ex.: vendas_import_csv ou vendas)" />
          <button id="btn_detect" class="primary">Testar tabela & listar colunas</button>
          <button id="btn_load"   class="">Carregar KPIs (30 dias)</button>
        </div>
        <div class="grid4" style="margin-top:8px">
          <div><div class="title">Coluna de Data</div><input id="col_date"     type="text" placeholder="ex.: data_venda / Data / created_at"></div>
          <div><div class="title">Valor Total</div>   <input id="col_total"    type="text" placeholder="ex.: valor_total / Total"></div>
          <div><div class="title">Desconto</div>      <input id="col_desc"     type="text" placeholder="ex.: desconto"></div>
          <div><div class="title">Entrega</div>       <input id="col_frete"    type="text" placeholder="ex.: entrega / frete"></div>
          <div><div class="title">Unidade (opcional)</div><input id="col_unid" type="text" placeholder="ex.: unidade / UNIDADE"></div>
          <div><div class="title">Hora (opcional)</div>   <input id="col_hora" type="text" placeholder="ex.: hora / horario"></div>
        </div>
        <div id="cols_box" class="muted" style="margin-top:8px">Colunas detectadas: —</div>
      </div>

      <!-- KPIs -->
      <div class="grid4" style="margin-top:12px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <!-- Logs -->
      <div class="card" style="margin-top:12px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ===== Helpers UI =====
      const $ = (id)=>document.getElementById(id);
      const logEl = $("log");
      function log(m){ logEl.textContent += "\\n" + m; }
      function clearKPIs(){ $("k_ped").textContent = $("k_fat").textContent = $("k_desc").textContent = $("k_fre").textContent = "—"; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toISO(d){ return d.toISOString().slice(0,10); }
      function toNum(x){
        if(x==null||x==="")return 0;
        if(typeof x==="number")return x;
        const s=String(x).trim();
        if(!s)return 0;
        const t=s.replace(/\./g,"").replace(/,/g,".");
        const n=Number(t);
        return isFinite(n)?n:0;
      }
      // Quote identifier for PostgREST select strings
      function qi(name){
        if(!name) return "";
        const simple=/^[a-z0-9_]+$/.test(name);
        return simple ? name : '"'+String(name).replace(/"/g,'""')+'"';
      }

      // ===== Supabase client (lazy) =====
      let supa=null;
      function getClient(){
        const url=$("inp_url").value.trim();
        const key=$("inp_key").value.trim();
        if(!url || !key){ throw new Error("Preencha URL e anon key."); }
        if(!supa || supa._url!==url){ supa = window.supabase.createClient(url, key); supa._url=url; }
        return supa;
      }

      // ===== Detect columns (from first row) =====
      async function testAndListColumns(){
        try{
          clearKPIs();
          const table=$("inp_table").value.trim();
          if(!table) throw new Error("Informe o nome da tabela.");
          const sb=getClient();
          log("[Test] Buscando 1 linha de "+table+" (sem ORDER, sem casts) …");
          const r = await sb.from(table).select("*").range(0,0); // nenhuma ordenação/cast
          if(r.error){ throw r.error; }
          const row = (r.data && r.data[0]) || null;
          if(!row){ $("cols_box").innerHTML="Colunas detectadas: <span class='err'>vazia ou bloqueada por RLS</span>"; throw new Error("Tabela vazia ou sem permissão (RLS)."); }
          const keys = Object.keys(row);
          $("cols_box").innerHTML = "Colunas detectadas: " + keys.map(k=>`<span class="chip" data-col="${k}">${k}</span>`).join(" ");

          // Heurística para preencher campos
          const lc=(s)=>String(s).toLowerCase();
          const guess=(alts)=>keys.find(k=>alts.some(a=>lc(k).includes(a)))||"";
          $("col_date").value  = guess(["data_venda","data venda","data","date","dt"]);
          $("col_total").value = guess(["valor_total","total","valor total","amount","price"]);
          $("col_desc").value  = guess(["desconto","discount","incentivo"]);
          $("col_frete").value = guess(["entrega","frete","delivery","shipping"]);
          $("col_unid").value  = guess(["unidade","loja","unit","filial"]);
          $("col_hora").value  = guess(["hora","horario","time","hr"]);

          // click-to-fill
          document.querySelectorAll(".chip").forEach(ch=>{
            ch.onclick=()=>{
              const c=ch.getAttribute("data-col");
              const target = prompt(`Atribuir a qual campo?\nOpções: date,total,desconto,entrega,unidade,hora\n\nColuna selecionada: ${c}`);
              const map = {date:"col_date", total:"col_total", desconto:"col_desc", entrega:"col_frete", unidade:"col_unid", hora:"col_hora"};
              const id = map[(target||"").trim().toLowerCase()];
              if(id){ $(id).value = c; }
            };
          });

          log("[OK] Colunas listadas. Ajuste os campos acima se necessário.");
        }catch(e){
          log("[ERRO-Teste] "+(e.message||String(e)));
        }
      }

      // ===== Load KPIs =====
      async function loadKPIs(){
        try{
          clearKPIs();
          const table=$("inp_table").value.trim();
          const cDate = $("col_date").value.trim();
          const cTot  = $("col_total").value.trim();
          const cDes  = $("col_desc").value.trim();
          const cFre  = $("col_frete").value.trim();
          if(!table||!cDate||!cTot) throw new Error("Informe ao menos: tabela, coluna de data e valor total.");
          const sb=getClient();

          // Descobrir última data (sem max): tenta com ORDER desc; se falhar, cai no fallback
          let lastISO=null;
          try{
            const r1 = await sb.from(table).select(qi(cDate)).order(cDate,{ascending:false}).range(0,0);
            if(r1.error) throw r1.error;
            const v=r1.data && r1.data[0] ? r1.data[0][cDate] : null;
            if(v) lastISO = String(v).slice(0,10);
          }catch(e){
            log("[Warn] ORDER por data falhou, tentando fallback varredura 1 página…");
            const r2 = await sb.from(table).select(qi(cDate)).range(0,9999);
            if(r2.error) throw r2.error;
            const vals = (r2.data||[]).map(x=>x[cDate]).filter(Boolean).map(x=>new Date(x));
            if(vals.length){ lastISO = toISO(new Date(Math.max.apply(null, vals))); }
          }
          if(!lastISO) throw new Error("Não consegui determinar a última data. Verifique a coluna de data.");

          const end = new Date(lastISO+"T23:59:59");
          const start = new Date(end); start.setDate(end.getDate()-29);
          $("periodo").textContent = "Período: "+toISO(start)+" → "+toISO(end);
          log(`[Query] ${table} | janela ${toISO(start)} → ${toISO(end)}`);

          // paginação
          const page=10000; let off=0; let rowsTotal=0;
          let pedidos=0, fat=0, des=0, fre=0;
          const sel = [qi(cDate), qi(cTot)];
          if(cDes) sel.push(qi(cDes));
          if(cFre) sel.push(qi(cFre));

          for(;;){
            const r = await sb.from(table)
              .select(sel.join(","))
              .gte(cDate, toISO(start))
              .lte(cDate, toISO(end))
              .range(off, off+page-1);
            if(r.error) throw r.error;
            const data = r.data||[];
            rowsTotal += data.length;
            pedidos  += data.length;
            for(const x of data){
              fat += toNum(x[cTot]);
              if(cDes) des += toNum(x[cDes]);
              if(cFre) fre += toNum(x[cFre]);
            }
            if(data.length<page) break;
            off += page;
          }

          $("k_ped").textContent = fmtInt(pedidos);
          $("k_fat").textContent = fmtBRL(fat);
          $("k_desc").textContent = fmtBRL(des);
          $("k_fre").textContent  = fmtBRL(fre);
          log(`[OK] KPIs preenchidos. Linhas consideradas: ${rowsTotal.toLocaleString("pt-BR")}`);
        }catch(e){
          log("[ERRO-Carregar] "+(e.message||String(e)));
        }
      }

      // ===== Eventos =====
      $("btn_detect").onclick=testAndListColumns;
      $("btn_load").onclick=loadKPIs;

      // Mensagem inicial
      log("[Boot] v9 — mapeamento manual, sem max()/casts; use os botões acima.");
      log("Dica: Se aparecer 'vazia', é provável que a tabela esteja com RLS sem política de SELECT para 'anon'.");
      log("Para liberar somente leitura, rode no SQL do Supabase:");
      log("  alter table public.<tabela> enable row level security;");
      log("  create policy if not exists anon_can_select on public.<tabela> for select to anon using (true);");
    </script>
  </body>
</html>
