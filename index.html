<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — Filtros (v2.2 CFO — ETAPA 2 • hotfix)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="28" fill="%231a73e8"/><text x="64" y="80" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{--bg:#0b1220;--panel:#0e1625;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--acc:#22c55e;--err:#ef4444;--warn:#f59e0b;--line:#1f2937}
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 4px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--text)}
  select[multiple]{height:96px}
  .btn{background:var(--acc);border:none;color:#0b1220;font-weight:700;cursor:pointer}
  .btn.ghost{background:#1f2937;color:#cbd5e1}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .box{background:#0f172a;border:1px solid var(--line);border-radius:12px;padding:12px}
  .label{font-size:12px;color:var(--muted)}
  .big{font-size:18px;font-weight:800}
  .sep{height:1px;background:var(--line);margin:12px 0}
  pre{white-space:pre-wrap;background:#0f172a;color:#d6e3ff;border-radius:10px;padding:10px;overflow:auto;border:1px solid var(--line);max-height:340px}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid var(--line);color:#cbd5e1;font-size:12px}
  .ok{color:#22c55e}.err{color:#ef4444}
</style>
</head>
<body>
<div class="container">
  <h1>Dashboard Vendas — Filtros <span class="badge">v2.2 CFO — ETAPA 2 • hotfix</span></h1>
  <div class="muted">Filtros rápidos + Quadro de Resumo (brutas × canônicas × duplicatas) + KPIs por dia + Amostra + Top Duplicatas.</div>

  <div class="card" style="margin-top:12px;">
    <div class="row cols-4">
      <div>
        <label>Data Inicial</label>
        <input id="dini" type="date"/>
      </div>
      <div>
        <label>Data Final</label>
        <input id="dfim" type="date"/>
      </div>
      <div>
        <label>Unidade(s)</label>
        <select id="unidades" multiple></select>
      </div>
      <div>
        <label>Canal(is)</label>
        <select id="canais" multiple></select>
      </div>
    </div>
    <div class="row cols-3" style="margin-top:10px;">
      <div>
        <label>Pagamento(s)</label>
        <select id="pagamentos" multiple></select>
      </div>
      <div>
        <label>Cancelado</label>
        <select id="cancelado">
          <option value="">Todos</option>
          <option value="Não" selected>Não</option>
          <option value="Sim">Sim</option>
        </select>
      </div>
      <div>
        <label>Loja (texto contém)</label>
        <input id="loja" placeholder="ex.: Vista, Bistrô…"/>
      </div>
    </div>
    <div class="inline" style="margin-top:10px;">
      <button id="btnAplicar" class="btn">Aplicar filtros</button>
      <button id="btnAmostra" class="btn ghost">Ver amostra (20)</button>
      <button id="btnTopDups" class="btn ghost">Top duplicatas (30)</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <b>Quadro Resumo — Linhas filtradas</b>
    <div class="kpi" style="margin-top:8px;">
      <div class="box"><div class="label">Brutas</div><div id="q_brutas" class="big">-</div></div>
      <div class="box"><div class="label">Canônicas (DISTINCT)</div><div id="q_canon" class="big">-</div></div>
      <div class="box"><div class="label">Duplicatas</div><div id="q_dups" class="big">-</div></div>
      <div class="box"><div class="label">% Duplicatas</div><div id="q_perc" class="big">-</div></div>
    </div>
    <div class="sep"></div>
    <div class="kpi">
      <div class="box"><div class="label">Pedidos (total)</div><div id="k_ped" class="big">-</div></div>
      <div class="box"><div class="label">Faturamento (total)</div><div id="k_fat" class="big">-</div></div>
      <div class="box"><div class="label">Descontos (total)</div><div id="k_des" class="big">-</div></div>
      <div class="box"><div class="label">Frete (total)</div><div id="k_fre" class="big">-</div></div>
    </div>
  </div>

  <div class="card">
    <b>Resultado (lista / Amostra / Top dups)</b>
    <pre id="out">(vazio)</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);

/** ====== HELPERS ====== **/
function fmt(n,dec=0){ if(n==null || !isFinite(+n)) return '-'; return (+n).toLocaleString('pt-BR',{minimumFractionDigits:dec,maximumFractionDigits:dec}); }
function selectedArray(sel){ return Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean); }
function setStatus(t,cls){ const el=$('status'); el.textContent=t; el.className=cls||'muted'; }
function saveState(){
  const S = {
    dini:$('dini').value, dfim:$('dfim').value,
    unids:selectedArray($('unidades')),
    canais:selectedArray($('canais')),
    pags:selectedArray($('pagamentos')),
    cancelado:$('cancelado').value, loja:$('loja').value
  };
  localStorage.setItem('cfo_filtros_v22', JSON.stringify(S));
}
function loadState(){
  const raw = localStorage.getItem('cfo_filtros_v22');
  if(!raw) return;
  try{
    const S = JSON.parse(raw);
    $('dini').value = S.dini || $('dini').value;
    $('dfim').value = S.dfim || $('dfim').value;

    // HOTFIX: nada de ".||" — aplica arrays salvos corretamente
    const applyMulti = (id, arrVals)=>{
      const sel = $(id); const vals = Array.isArray(arrVals)? arrVals : [];
      for(const opt of sel.options){ opt.selected = vals.includes(opt.value); }
    };
    applyMulti('unidades',  S.unids);
    applyMulti('canais',    S.canais);
    applyMulti('pagamentos',S.pags);

    $('cancelado').value = S.cancelado || '';
    $('loja').value = S.loja || '';
  }catch(e){}
}

/** ====== LOAD OPTIONS ====== **/
async function loadOptions(){
  setStatus('Carregando opções…');
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  let min = '2021-01-01', max = new Date().toISOString().slice(0,10);
  if(!dr.error && dr.data?.length){ min = dr.data[0].min_dia; max = dr.data[0].max_dia; }
  $('dini').value=min; $('dfim').value=max;

  const u = await supa.from('vw_vendas_unidades').select('unidade');
  const c = await supa.from('vw_vendas_canais').select('canal');
  const p = await supa.from('vw_vendas_pagamentos').select('pagamento_base');

  function fill(selId, res, key){
    const sel=$(selId); sel.innerHTML='';
    (res?.data||[]).forEach(r=>{
      const v=r[key]; if(!v) return;
      const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);
    });
  }
  fill('unidades', u, 'unidade');
  fill('canais',   c, 'canal');
  fill('pagamentos', p, 'pagamento_base');

  // Restaurar seleção salva (agora que já existem options)
  loadState();

  setStatus('Opções carregadas.','ok');
}

/** ====== PARAMS ====== **/
function params(){
  const p = {
    p_dini: $('dini').value,
    p_dfim: $('dfim').value,
    p_unids: selectedArray($('unidades')),
    p_canais: selectedArray($('canais')),
    p_pags: selectedArray($('pagamentos')),
    p_loja: $('loja').value.trim() || null,
    p_cancelado: $('cancelado').value || null
  };
  if(!p.p_unids.length) p.p_unids = null;
  if(!p.p_canais.length) p.p_canais = null;
  if(!p.p_pags.length)   p.p_pags   = null;
  return p;
}

/** ====== AÇÕES ====== **/
async function aplicar(){
  try{
    setStatus('Consultando KPIs e Resumo…');
    saveState();
    const p = params();

    // Resumo (brutas x canônicas x duplicatas)
    const rsum = await supa.rpc('resumo_vendas', p);
    if(rsum.error) throw rsum.error;
    const R = rsum.data?.[0] || {};
    $('q_brutas').textContent = fmt(R.brutas);
    $('q_canon').textContent  = fmt(R.canon);
    $('q_dups').textContent   = fmt(R.duplicatas);
    $('q_perc').textContent   = (R.perc_dup==null? '-' : (Number(R.perc_dup).toFixed(2)+' %'));

    // KPI por dia → somatório (mostra últimos 10 dias no painel de saída)
    const rkpi = await supa.rpc('kpi_vendas', p);
    if(rkpi.error) throw rkpi.error;
    let ped=0,fat=0,des=0,fre=0;
    for(const r of (rkpi.data||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; }
    $('k_ped').textContent = fmt(ped);
    $('k_fat').textContent = 'R$ '+fmt(fat,2);
    $('k_des').textContent = 'R$ '+fmt(des,2);
    $('k_fre').textContent = 'R$ '+fmt(fre,2);
    $('out').textContent   = JSON.stringify((rkpi.data||[]).slice(-10), null, 2);

    setStatus('OK. Você pode ver Amostra ou Top Duplicatas.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

async function amostra(){
  try{
    setStatus('Buscando amostra…');
    const r = await supa.rpc('amostra_vendas', params());
    if(r.error) throw r.error;
    $('out').textContent = JSON.stringify(r.data||[], null, 2);
    setStatus('Amostra pronta.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

async function topdups(){
  try{
    setStatus('Buscando top duplicatas…');
    const p = params(); p.p_limit = 30;
    const r = await supa.rpc('top_dups_vendas', p);
    if(r.error) throw r.error;
    $('out').textContent = JSON.stringify(r.data||[], null, 2);
    setStatus('Top duplicatas pronto.','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e), 'err');
  }
}

/** ====== INIT ====== **/
document.getElementById('btnAplicar').addEventListener('click', aplicar);
document.getElementById('btnAmostra').addEventListener('click', amostra);
document.getElementById('btnTopDups').addEventListener('click', topdups);

loadOptions().then(aplicar);
</script>
</body>
</html>
