<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard — CFO (v2.7 Light)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%232f6ef7"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb;
    --accent:#2f6ef7; --ok:#10b981; --down:#ef4444; --chip:#eef2ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{margin:0;font-size:28px;letter-spacing:.2px}
  .row{display:grid;gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
  .card h3{margin:0 0 10px;font-size:16px;display:flex;align-items:center;gap:8px}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{background:#fff}
  .btn-chip{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--chip);cursor:pointer}
  .btn-chip.active{background:#2f6ef7;color:#fff;border-color:#2f6ef7}
  .right{display:flex;gap:8px;align-items:center}
  .space{height:8px}
  input[type="date"], select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .grid-line{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
  /* Multiselect */
  .msel{position:relative}
  .msel-btn{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;text-align:left;cursor:pointer}
  .msel-btn:after{content:"▾";float:right;color:#475569}
  .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
  .msel-opt:hover{background:#f3f4f6}
  /* KPI cards */
  .kpi{position:relative;border:1px solid var(--line);border-radius:14px;background:#fff;padding:14px 14px 12px 14px;display:flex;flex-direction:column;gap:4px}
  .kpi .bar{position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:14px 0 0 14px;background:var(--accent)}
  .kpi h4{margin:0;font-size:12px;color:#475569}
  .kpi .val{font-size:22px;font-weight:800}
  .kpi .sub{font-size:12px;color:#667085}
  .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-weight:700}
  .delta.up{color:var(--ok);border-color:var(--ok + 10%)}
  .delta.down{color:var(--down)}
  .delta.flat{color:#64748b}
  /* helpers */
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>DASHBOARD</h1>
      <div class="right">
        <button id="btnUpload" class="btn ghost">📤 Carregar Excel</button>
        <button id="btnClear" class="btn">✖ Limpar Filtros</button>
      </div>
    </div>

    <!-- Filtros de Data -->
    <div class="card">
      <h3>🧪 Filtros de Data</h3>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Intervalo (início)</div>
          <input type="date" id="fDe">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Intervalo (fim)</div>
          <input type="date" id="fAte">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Período rápido</div>
          <div class="right" style="flex-wrap:wrap;justify-content:flex-start">
            <button class="btn-chip" data-quick="7">07d</button>
            <button class="btn-chip" data-quick="15">15d</button>
            <button class="btn-chip active" data-quick="30">30d</button>
            <button class="btn-chip" data-quick="60">60d</button>
            <button class="btn-chip" data-quick="90">90d</button>
            <button class="btn-chip" data-quick="120">120d</button>
          </div>
          <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">—</div>
        </div>
      </div>
    </div>

    <!-- Demais Filtros -->
    <div class="card">
      <h3>🧩 Demais Filtros</h3>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Nome da Loja</div>
          <div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Canal de Venda</div>
          <div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Turno da Venda</div>
          <div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div>
        </div>
      </div>
      <div class="space"></div>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Tipo de Pagamento</div>
          <div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Cancelado</div>
          <div id="ms-cancel" class="msel">
            <button class="msel-btn">Não</button>
            <div class="msel-panel">
              <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
              <div class="msel-opt"><input type="checkbox" value="Não" checked><label>Não</label></div>
              <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
            </div>
          </div>
        </div>
        <div><div class="muted"> </div><div id="status" class="muted">—</div></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row cols-3">
      <div class="kpi card"><span class="bar"></span>
        <h4>Pedidos <span id="d_ped" class="delta flat">—</span></h4>
        <div class="val" id="k_ped">—</div>
        <div class="sub">Anterior: <span id="p_ped">—</span></div>
      </div>
      <div class="kpi card"><span class="bar"></span>
        <h4>Faturamento <span id="d_fat" class="delta flat">—</span></h4>
        <div class="val" id="k_fat">—</div>
        <div class="sub">Anterior: <span id="p_fat">—</span></div>
      </div>
      <div class="kpi card"><span class="bar"></span>
        <h4>Incentivos <span id="d_des" class="delta flat">—</span></h4>
        <div class="val" id="k_des">—</div>
        <div class="sub">Anterior: <span id="p_des">—</span></div>
      </div>
    </div>

    <div class="row cols-3">
      <div class="kpi card"><span class="bar"></span>
        <h4>% de Incentivos <span id="d_desperc" class="delta flat">—</span></h4>
        <div class="val" id="k_desperc">—</div>
        <div class="sub">Anterior: <span id="p_desperc">—</span></div>
      </div>
      <div class="kpi card"><span class="bar"></span>
        <h4>Ticket Médio (Total ÷ pedidos) <span id="d_tkt" class="delta flat">—</span></h4>
        <div class="val" id="k_tkt">—</div>
        <div class="sub">Anterior: <span id="p_tkt">—</span></div>
      </div>
      <div class="kpi card"><span class="bar"></span>
        <h4>Faturamento Médio (Total ÷ dias) <span id="d_fatmed" class="delta flat">—</span></h4>
        <div class="val" id="k_fatmed">—</div>
        <div class="sub">Anterior: <span id="p_fatmed">—</span></div>
      </div>
    </div>

    <div class="row cols-2">
      <div class="kpi card"><span class="bar"></span>
        <h4>Pedidos Cancelados (Qtd.) <span id="d_canc_ped" class="delta flat">—</span></h4>
        <div class="val" id="k_canc_ped">—</div>
        <div class="sub">Participação: <span id="k_canc_part">—</span> (Anterior: <span id="p_canc_part">—</span>)</div>
      </div>
      <div class="kpi card"><span class="bar"></span>
        <h4>Valor de Cancelados <span id="d_canc_val" class="delta flat">—</span></h4>
        <div class="val" id="k_canc_val">—</div>
        <div class="sub">Anterior: <span id="p_canc_val">—</span></div>
      </div>
    </div>

    <div class="space"></div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script>
  // ===== CONFIG
  const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const $ = (id)=>document.getElementById(id);
  const setStatus = (t,kind)=>{ const el=$('status'); el.textContent=t; el.style.color = kind==='err'?'#ef4444':(kind==='ok'?'#10b981':'#667085'); };

  // ===== UTIL
  const money=v=> (v==null||!isFinite(+v))?'R$ 0,00':'R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const num=v=> (v==null||!isFinite(+v))?'0':(+v).toLocaleString('pt-BR');
  const pct=(v)=> (v==null||!isFinite(+v))?'0,0%':((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
  function deltaBadge(el,curr,prev){
    if(!isFinite(prev)||+prev===0){ el.textContent='—'; el.className='delta flat'; return; }
    const p=((curr-prev)/prev)*100;
    el.textContent=(p>=0?'↑ ':'↓ ')+Math.abs(p).toFixed(1)+'%';
    el.className='delta '+(p>=0?'up':'down');
  }
  const iso=d=>d.toISOString().slice(0,10);
  function addDaysISO(isoStr,n){const d=new Date(isoStr+'T00:00:00'); d.setDate(d.getDate()+n); return iso(d);}

  // ===== Multiselect
  function MultiSelect(rootId, placeholder){
    const root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
    let options=[], selected=new Set(), filtered=[];
    function render(){ panel.innerHTML=''; const q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar…'; q.addEventListener('input',()=>{filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase())); draw();}); panel.appendChild(q); draw();}
    function draw(){ const box=document.createElement('div'); (filtered.length?filtered:options).forEach((v,i)=>{const id=rootId+'-'+i; const row=document.createElement('div'); row.className='msel-opt'; const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=selected.has(v); const lb=document.createElement('label'); lb.textContent=v; cb.addEventListener('change',()=>{cb.checked?selected.add(v):selected.delete(v); refresh(); applyAll();}); row.appendChild(cb); row.appendChild(lb); box.appendChild(row);}); const olds=[...panel.querySelectorAll('.msel-opt')]; olds.forEach(n=>n.remove()); panel.appendChild(box);}
    function refresh(){ if(selected.size===0) btn.textContent=placeholder; else btn.textContent=`${selected.size} selecionado(s)`; }
    btn.addEventListener('click',()=>root.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) root.classList.remove('open'); });
    return { setOptions(list){options=(list||[]).filter(Boolean); filtered=options.slice(); selected=new Set(); render(); refresh();}, get(){return [...selected];}, set(vals){selected=new Set(vals||[]); refresh(); draw();} };
  }

  // ===== Estado / Período
  let firstDay='', lastDay='';
  const fDe=$('fDe'), fAte=$('fAte'); const chips=[...document.querySelectorAll('[data-quick]')];
  const periodoInfo=$('periodoInfo');
  const ms={ lojas:MultiSelect('ms-lojas','Todas as lojas'), canais:MultiSelect('ms-canais','Todos os canais'), turnos:MultiSelect('ms-turnos','Todos os turnos'), pags:MultiSelect('ms-pags','Todos os tipos'), cancel:MultiSelect('ms-cancel','Todos')};

  function setActiveChip(val){ chips.forEach(c=>c.classList.toggle('active', c.dataset.quick===String(val))); }
  function applyQuick(val){
    setActiveChip(val);
    // intervalo ancorado no último dia do banco
    const ate=lastDay||iso(new Date()); const de=addDaysISO(ate,-(Number(val)-1));
    fDe.value=de; fAte.value=ate;
    periodoInfo.textContent=`${de} → ${ate} (âncora: ${lastDay})`;
    applyAll();
  }

  function buildParams(de,ate,overrideCancel=null){
    const canc = overrideCancel!=null ? [overrideCancel] : ms.cancel.get();
    let p_cancelado = null;
    if (canc.length===1 && (canc[0]==='Não' || canc[0]==='Sim')) p_cancelado = canc[0];
    return {
      p_dini: de, p_dfim: ate,
      p_unids: null,              // (não exibimos Unidades aqui; se precisar, adicione MS)
      p_canais: ms.canais.get().length? ms.canais.get(): null,
      p_pags:   ms.pags.get().length  ? ms.pags.get()  : null,
      p_loja:   ms.lojas.get().length ? null /*texto contém*/ : null, // manter compatível
      p_cancelado
    };
  }

  async function loadOptions(){
    setStatus('Carregando…');
    const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
    if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
    if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }

    const [lojas,canais,turnos,pags] = await Promise.all([
      supa.from('vw_vendas_lojas').select('loja').order('loja'),
      supa.from('vw_vendas_canais').select('canal').order('canal'),
      supa.from('vw_vendas_turnos').select('turno').order('turno'),
      supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
    ]);
    ms.lojas.setOptions((lojas.data||[]).map(r=>r.loja));
    ms.canais.setOptions((canais.data||[]).map(r=>r.canal));
    ms.turnos.setOptions((turnos.data||[]).map(r=>r.turno));
    ms.pags.setOptions((pags.data||[]).map(r=>r.pagamento_base));
    ms.cancel.setOptions(['','Não','Sim']); ms.cancel.set(['Não']);

    applyQuick('30');
    setStatus('Pronto','ok');
  }

  // ===== KPIs (Ticket Médio e Faturamento Médio inclusos)
  function agg(rows){ let ped=0,fat=0,des=0,fre=0; for(const r of (rows||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; } return {ped,fat,des,fre}; }
  function daysLen(de,ate){ const d1=new Date(de+'T00:00:00'), d2=new Date(ate+'T00:00:00'); return Math.round((d2-d1)/(1000*60*60*24))+1; }

  async function applyAll(){
    try{
      const de=fDe.value||firstDay, ate=fAte.value||lastDay;
      const len=daysLen(de,ate);
      // anterior com mesmo tamanho imediatamente antes
      const atePrevISO=new Date(new Date(de+'T00:00:00').getTime() - 24*60*60*1000);
      const dePrevISO=new Date(atePrevISO.getTime() - (len-1)*24*60*60*1000);
      const dePrev=iso(dePrevISO), atePrev=iso(atePrevISO);

      setStatus('Consultando…');
      const [now, prev, cancNow, cancPrev] = await Promise.all([
        supa.rpc('kpi_vendas', buildParams(de,ate)),
        supa.rpc('kpi_vendas', buildParams(dePrev,atePrev)),
        supa.rpc('kpi_vendas', buildParams(de,ate,'Sim')),
        supa.rpc('kpi_vendas', buildParams(dePrev,atePrev,'Sim')),
      ]);
      if(now.error) throw now.error; if(prev.error) throw prev.error;
      if(cancNow.error) throw cancNow.error; if(cancPrev.error) throw cancPrev.error;

      const N=agg(now.data), P=agg(prev.data);
      const CN=agg(cancNow.data), CP=agg(cancPrev.data);

      // principais
      const tktN = N.ped>0 ? (N.fat/N.ped) : 0;
      const tktP = P.ped>0 ? (P.fat/P.ped) : 0;

      const fatMedN = len>0 ? (N.fat/len) : 0;
      const fatMedP = len>0 ? (P.fat/len) : 0; // mesmo tamanho

      const desPercN = N.fat>0 ? (N.des/N.fat) : 0;
      const desPercP = P.fat>0 ? (P.des/P.fat) : 0;

      // pintar
      $('k_ped').textContent=num(N.ped); $('p_ped').textContent=num(P.ped); deltaBadge($('d_ped'),N.ped,P.ped);
      $('k_fat').textContent=money(N.fat); $('p_fat').textContent=money(P.fat); deltaBadge($('d_fat'),N.fat,P.fat);
      $('k_des').textContent=money(N.des); $('p_des').textContent=money(P.des); deltaBadge($('d_des'),N.des,P.des);

      $('k_desperc').textContent=pct(desPercN); $('p_desperc').textContent=pct(desPercP); deltaBadge($('d_desperc'),desPercN,desPercP);

      $('k_tkt').textContent=money(tktN); $('p_tkt').textContent=money(tktP); deltaBadge($('d_tkt'),tktN,tktP);
      $('k_fatmed').textContent=money(fatMedN); $('p_fatmed').textContent=money(fatMedP); deltaBadge($('d_fatmed'),fatMedN,fatMedP);

      // cancelados
      $('k_canc_ped').textContent=num(CN.ped);
      $('k_canc_val').textContent=money(CN.fat);
      $('p_canc_val').textContent=money(CP.fat);
      const partN = N.ped>0 ? (CN.ped/N.ped) : 0;
      const partP = P.ped>0 ? (CP.ped/P.ped) : 0;
      $('k_canc_part').textContent=pct(partN);
      $('p_canc_part').textContent=pct(partP);
      deltaBadge($('d_canc_ped'),CN.ped,CP.ped);
      deltaBadge($('d_canc_val'),CN.fat,CP.fat);

      setStatus('OK','ok');
    }catch(e){ console.error(e); setStatus('Erro: '+(e.message||e),'err'); }
  }

  // eventos
  chips.forEach(b=> b.addEventListener('click', ()=>applyQuick(b.dataset.quick)));
  $('btnClear').addEventListener('click', ()=>{
    ms.lojas.set([]); ms.canais.set([]); ms.turnos.set([]); ms.pags.set([]); ms.cancel.set(['Não']); applyQuick('30');
  });
  fDe.addEventListener('change', ()=>{ // datas manuais anulam “rápido”
    chips.forEach(c=>c.classList.remove('active'));
    periodoInfo.textContent=`${fDe.value} → ${fAte.value} (âncora: ${lastDay})`;
    applyAll();
  });
  fAte.addEventListener('change', ()=>{ chips.forEach(c=>c.classList.remove('active')); periodoInfo.textContent=`${fDe.value} → ${fAte.value} (âncora: ${lastDay})`; applyAll(); });

  // boot
  (async function init(){
    // datas + opções
    const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
    if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
    if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }
    await loadOptions();
  })();
  </script>
</body>
</html>
