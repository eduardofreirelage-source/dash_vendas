<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Supabase (v7.1 COM FONTE FIXA)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--border:#e5e7eb;--ink:#0f172a}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:1024px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--muted);font-size:12px}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
      .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .title{font-size:12px;color:var(--muted)}
      .val{font-size:22px;font-weight:700;margin-top:6px}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      code{background:#eef2ff;padding:0 4px;border-radius:4px}
      @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:520px){.grid{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">
            <strong>FONTE FIXA:</strong> <code>public.vendas_import_csv</code> •
            <strong>Coluna de data:</strong> <code>data_venda</code> •
            <strong>Build:</strong> v7.1 (sem <code>max()</code>)
          </div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== CREDENCIAIS (as que você me passou) ======
      const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      // ====== PARÂMETROS FIXOS DA SUA BASE ======
      const TABLE  = "vendas_import_csv";   // nome EXATO da tabela carregada
      const COL_DT = "data_venda";          // nome EXATO da coluna de data (YYYY-MM-DD)
      const SEL    = [COL_DT, "valor_total", "desconto", "entrega", "unidade"].join(",");

      // ====== UI helpers ======
      const elLog = document.getElementById("log");
      function log(msg){ elLog.textContent += "\n" + msg; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toNum(x){
        if(x==null||x==="")return 0;
        if(typeof x==="number")return x;
        const s=String(x).trim();
        if(!s)return 0;
        const n=Number(s.replace(/\./g,"").replace(/,/g,"."));
        return isFinite(n)?n:0;
      }
      function toISO(d){ return d.toISOString().slice(0,10); }

      // ====== Supabase client ======
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // (A) pega última data por ORDER DESC + limit 1 (sem max())
      async function getLastDate(){
        // sanity ping
        const ping = await supa.from(TABLE).select(COL_DT).limit(1);
        if(ping.error){
          throw new Error("Tabela/coluna indisponível: " + ping.error.message + " (TABLE=" + TABLE + ", COL=" + COL_DT + ")");
        }
        const r = await supa.from(TABLE).select(COL_DT).order(COL_DT, { ascending:false }).limit(1);
        if(r.error){ throw new Error("ORDER DESC falhou: " + r.error.message); }
        const v = r.data && r.data[0] && r.data[0][COL_DT];
        if(!v){ throw new Error("Tabela sem linhas (ou RLS bloqueou)."); }
        return String(v).slice(0,10);
      }

      // (B) pagina (sem ORDER, pra não pesar/expirar)
      async function fetchRange(fromISO, toISO){
        const page = 10000; let acc = [], off = 0;
        for(;;){
          const qr = await supa.from(TABLE)
            .select(SEL)
            .gte(COL_DT, fromISO)
            .lte(COL_DT, toISO)
            .range(off, off+page-1);
          if(qr.error){
            throw new Error("Erro REST: " + qr.error.message + " (range " + off + "-" + (off+page-1) + ")");
          }
          const arr = qr.data || [];
          acc = acc.concat(arr);
          if(arr.length < page) break;
          off += page;
        }
        return acc;
      }

      // (C) fluxo principal
      (async function main(){
        try{
          log("[Boot] Iniciando… build v7.1 (fonte fixa, sem max())");
          log("[Info] TABLE=" + TABLE + " • COL_DT=" + COL_DT);

          const lastISO = await getLastDate();
          const end = new Date(lastISO + "T23:59:59");
          const start = new Date(end); start.setDate(end.getDate()-29);
          document.getElementById("periodo").textContent = "Período: " + toISO(start) + " → " + toISO(end);
          log("[Query] Intervalo: " + toISO(start) + " → " + toISO(end));

          const rows = await fetchRange(toISO(start), toISO(end));
          log("[Query] Linhas retornadas: " + rows.length.toLocaleString("pt-BR"));

          let pedidos = rows.length, fat = 0, desc = 0, fre = 0;
          for(const r of rows){
            fat  += toNum(r.valor_total);
            desc += toNum(r.desconto);
            fre  += toNum(r.entrega);
          }
          document.getElementById("k_ped").textContent = fmtInt(pedidos);
          document.getElementById("k_fat").textContent = fmtBRL(fat);
          document.getElementById("k_desc").textContent = fmtBRL(desc);
          document.getElementById("k_fre").textContent = fmtBRL(fre);
          log("[OK] KPIs preenchidos.");
          log("[Próximo] Confirmado? Aí adiciono filtro por UNIDADE mantendo este mesmo arquivo.");
        }catch(e){
          log("[ERRO] " + (e.message || String(e)));
        }
      })();
    </script>
  </body>
</html>
