<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maestro Food</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#667085;--text:#0f172a;--blue:#1a73e8;--stroke:#e6eaf2;--radius:14px}
    body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .container{max-width:1200px;margin:24px auto 64px;padding:0 16px}
    h1{font-size:24px;font-weight:700;margin:6px 0 0}
    small.muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:14px}
    .card.dashed{border-style:dashed}
    summary{cursor:pointer}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button,textarea{appearance:none;border:1px solid var(--stroke);background:#fff;color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    select[multiple]{height:140px}
    .inline{display:flex;gap:10px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#eef3ff;color:#1747b7}
    .grid-kpi{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .kpi h3{font-size:12px;color:var(--muted);margin:0 0 8px}
    .kpi b{font-size:22px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef3ff;color:#1747b7;font-weight:600}
    .right{text-align:right}
    .hint{color:var(--muted);font-size:12px}
    #srcInfo{font-weight:700}
    #srcInfo.ok{color:#0f974d}
    #srcInfo.err{color:#c0392b}
    #importStatus{font-size:12px}
    .debug-btn{position:fixed;top:10px;right:10px;z-index:9999;font-size:10px;padding:4px 8px;}
    @media (max-width:960px){.grid-kpi{grid-template-columns:repeat(2,1fr)}.cols-4,.cols-3,.cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Maestro Food</h1>
    <div class="inline" style="justify-content:space-between;margin-top:4px;">
      <small id="periodo" class="muted">PerÃ­odo: â€”</small>
      <small id="srcInfo" class="muted">Fonte: â€”</small>
    </div>
    <button class="btn ghost debug-btn" onclick="debugInfo()">Debug</button>

    <details id="fx" class="card" open>
      <summary class="inline" style="justify-content:space-between;">
        <b>FILTROS</b>
        <button id="btnLimpar" class="btn ghost" type="button">Limpar</button>
      </summary>

      <div class="row cols-2" style="margin-top:12px;">
        <div><label>Unidade</label><select id="fUnidade"></select></div>
        <div><label>Nome da loja (Top 10)</label><select id="fLoja"></select></div>
      </div>

      <div class="row cols-4" style="margin-top:8px;">
        <div><label>De</label><input id="fDini" type="date"/></div>
        <div><label>AtÃ©</label><input id="fDfim" type="date"/></div>
        <div>
          <label>PerÃ­odo rÃ¡pido</label>
          <select id="fQuick">
            <option>Ãšltimos 30</option>
            <option>Ãšltimos 60</option>
            <option selected>Ãšltimos 90</option>
            <option>Este mÃªs</option>
            <option>Ãšltimo mÃªs</option>
            <option>Este ano</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="fTurno" multiple>
            <option>ManhÃ£</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px;">
        <div><label>Canal de venda</label><select id="fCanal" multiple></select></div>
        <div><label>Pagamento</label><select id="fPag" multiple></select></div>
        <div>
          <label>EstÃ¡ cancelado?</label>
          <select id="fCanc"><option>Todos</option><option>NÃ£o</option><option>Sim</option></select>
        </div>
      </div>

      <div class="card dashed" style="margin-top:12px;">
        <div class="row cols-2">
          <div class="inline"><label style="margin:0;">Admin â€” Importar CSV (<b>Pasta2.csv</b>)</label></div>
          <div class="right"><span id="importStatus" class="muted">Selecione um arquivo CSV</span></div>
        </div>
        <div class="inline" style="margin-top:8px;">
          <input id="csv" type="file" accept=".csv,text/csv"/>
          <button id="btnImport" class="btn" type="button">Importar CSV (incremental)</button>
        </div>
        <p class="hint" style="margin-top:8px;">
          ImportaÃ§Ã£o Ã© somativa com <b>deduplicaÃ§Ã£o por chave</b> (dia, unidade, "Nome da loja", hora, pagamento, "Canal de venda").  
          ObrigatÃ³rio no CSV: <b>Data da venda</b> (dia) â€¢ <b>unidade</b> â€¢ <b>Total</b> (fat). Aceita "Entrega", "Desconto", etc.
        </p>
      </div>
    </details>

    <div class="grid-kpi" style="margin-top:14px;">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">â€”</b></div>
      <div class="card kpi"><h3>Ticket MÃ©dio</h3><b id="kTicket">â€”</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">â€”</b></div>
      <div class="card kpi"><h3>Faturamento MÃ©dio (dia)</h3><b id="kFatDia">â€”</b></div>
      <div class="card kpi"><h3>Incentivos</h3><b id="kDes">â€”</b></div>
      <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">â€”</b></div>
      <div class="card kpi"><h3>Frete</h3><b id="kFre">â€”</b></div>
      <div class="card kpi"><h3>Faturamento LÃ­quido</h3><b id="kFatLiq">â€”</b></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="inline" style="justify-content:space-between;">
        <b>Receita diÃ¡ria (R$)</b>
        <div class="inline"><span class="pill">Total</span></div>
      </div>
      <div style="height:220px;margin-top:8px;"><canvas id="chart"></canvas></div>
    </div>
  </div>

  <!-- libs ANTES do seu cÃ³digo -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
  // Aguardar carregamento das bibliotecas
  (function waitForLibraries() {
    if (typeof supabase === 'undefined' || typeof Papa === 'undefined' || typeof Chart === 'undefined') {
      console.log('Aguardando bibliotecas...');
      setTimeout(waitForLibraries, 100);
      return;
    }
    
    console.log('ðŸš€ Iniciando Maestro Food Dashboard...');
    
    // ====== CONFIG ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const TABLE = "vendas_kpi_daily_v2_data";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth:{persistSession:true,autoRefreshToken:true}});

    // ====== DOM ======
    const $ = (id)=>document.getElementById(id);
    const periodoEl = $("periodo"), srcInfo = $("srcInfo"), fx=$("fx");
    const uni=$("fUnidade"), loja=$("fLoja"), dini=$("fDini"), dfim=$("fDfim"),
          pr=$("fQuick"), turno=$("fTurno"), canal=$("fCanal"), pag=$("fPag"), canc=$("fCanc");
    const btnLimpar=$("btnLimpar"), csv=$("csv"), btnImport=$("btnImport"), importStatus=$("importStatus");
    const kPedidos=$("kPedidos"), kTicket=$("kTicket"), kFat=$("kFat"), kFatDia=$("kFatDia"),
          kDes=$("kDes"), kDesPct=$("kDesPct"), kFre=$("kFre"), kFatLiq=$("kFatLiq");
    const chartEl=$("chart"); let chart;

    // ====== STATE ======
    let minISO = null, maxISO = null;

    // ====== UTILS ======
    const fmtBRL = (v)=> isFinite(v) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "â€”";
    const fmtPct = (v)=> isFinite(v) ? (v*100).toFixed(1).replace('.',',')+'%' : "â€”";
    const onlyDate = (iso)=> iso && iso.length>=10 ? iso.slice(0,10) : iso;
    
    const parseBR = (x)=> {
      if (x==null || x==='') return 0;
      if (typeof x === 'number') return x;
      const s = String(x).trim().replace(/\./g,'').replace(',','.');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    };
    
    const norm = (s) => {
      return String(s ?? "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    };
    
    const stripBOM = (str) => {
      return str.charCodeAt(0) === 0xFEFF ? str.slice(1) : str;
    };
    
    const normCancel = (v)=>{
      const s = String(v??"").trim().toLowerCase();
      if (v===true || s==="sim" || s==="s" || s==="1" || s==="true") return "Sim";
      return "NÃ£o";
    };

    function ddmmyyyyToISO(s){
      if(!s) return null;
      const str = String(s).trim();
      const [datePart, timePart] = str.split(' ');
      
      if (!datePart) return null;
      
      const [d, m, y] = datePart.split('/');
      
      const day = parseInt(d, 10);
      const month = parseInt(m, 10);
      const year = parseInt(y, 10);
      
      if (!day || !month || !year || 
          day < 1 || day > 31 || 
          month < 1 || month > 12 || 
          year < 1900 || year > 2100) {
        console.warn(`Data invÃ¡lida: ${s}`);
        return null;
      }
      
      const isoDate = `${year.toString().padStart(4,'0')}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      
      const testDate = new Date(isoDate);
      if (testDate.getFullYear() !== year || 
          testDate.getMonth() + 1 !== month || 
          testDate.getDate() !== day) {
        console.warn(`Data invÃ¡lida apÃ³s conversÃ£o: ${s}`);
        return null;
      }
      
      return `${isoDate}${timePart ? 'T' + timePart + ':00' : 'T00:00:00'}`;
    }

    function hourFromDateText(s){
      const str = String(s??'');
      const parts = str.split(' ');
      if(parts[1] && parts[1].includes(':')){
        const [hh] = parts[1].split(':');
        const h = parseInt(hh,10);
        return isFinite(h)? h : -1;
      }
      return -1;
    }

    function applyQuickDate(){
      const opt = pr.value;
      const today = new Date();
      let start, end = new Date();
      if(opt.startsWith("Ãšltimos ")){
        const n = parseInt(opt.split(' ')[1],10);
        start = new Date();
        start.setDate(end.getDate()- (n-1));
      } else if(opt==="Este mÃªs"){
        start = new Date(end.getFullYear(), end.getMonth(), 1);
      } else if(opt==="Ãšltimo mÃªs"){
        start = new Date(end.getFullYear(), end.getMonth()-1, 1);
        end = new Date(end.getFullYear(), end.getMonth(), 0);
      } else if(opt==="Este ano"){
        start = new Date(end.getFullYear(), 0, 1);
      } else {
        start = new Date(end.getFullYear(), end.getMonth(), end.getDate()-29);
      }
      dini.value = onlyDate(start.toISOString());
      dfim.value = onlyDate(end.toISOString());
    }

    // ====== DATA SOURCE ======
    async function fetchMinMax(){
      try {
        const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
        const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
        if(!a.error && a.data?.length && !b.error && b.data?.length){
          minISO = onlyDate(a.data[0].dia);
          maxISO = onlyDate(b.data[0].dia);
          console.log('PerÃ­odo disponÃ­vel:', minISO, 'â†’', maxISO);
          srcInfo.textContent = 'Fonte: Supabase';
          srcInfo.className = 'muted ok';
        } else {
          minISO = maxISO = null;
          srcInfo.textContent = 'Fonte: Sem dados';
          srcInfo.className = 'muted err';
        }
      } catch (error) {
        console.error('Erro ao buscar min/max:', error);
        minISO = maxISO = null;
        srcInfo.textContent = 'Fonte: Erro';
        srcInfo.className = 'muted err';
      }
    }

    async function buildOptions(){
      console.log('ðŸ”„ Carregando opÃ§Ãµes dos filtros...');
      
      // Unidade
      try {
        const r=await supa.from(TABLE).select('unidade').not('unidade','is',null).order('unidade',{ascending:true}).range(0,9999);
        const arr=[...new Set((r.data||[]).map(x=>x.unidade).filter(v=>v!=='' && v!=null))];
        uni.innerHTML = `<option>Todas</option>` + arr.map(v=>`<option>${v}</option>`).join('');
        console.log('âœ… Unidades carregadas:', arr.length);
      } catch (error) {
        console.error('Erro ao carregar unidades:', error);
      }
      
      // Pagamento
      try {
        const r=await supa.from(TABLE).select('pagamento').not('pagamento','is',null).order('pagamento',{ascending:true}).range(0,9999);
        const arr=[...new Set((r.data||[]).map(x=>x.pagamento).filter(Boolean))];
        pag.innerHTML = arr.map(v=>`<option>${v}</option>`).join('');
        console.log('âœ… Pagamentos carregados:', arr.length);
      } catch (error) {
        console.error('Erro ao carregar pagamentos:', error);
      }
      
      // Canal (com aspas)
      try {
        const r=await supa.from(TABLE).select('"Canal de venda"').order('Canal de venda',{ascending:true}).range(0,9999);
        const arr=[...new Set((r.data||[]).map(x=>x["Canal de venda"]).filter(Boolean))];
        canal.innerHTML = arr.map(v=>`<option>${v}</option>`).join('');
        console.log('âœ… Canais carregados:', arr.length);
      } catch (error) {
        console.error('Erro ao carregar canais:', error);
      }
      
      // Lojas Top 10
      try {
        const q=await supa.from(TABLE).select('"Nome da loja",fat').not('fat','is',null).not('Nome da loja','is',null).range(0,20000);
        const acc=new Map(); 
        (q.data||[]).forEach(r=>{ 
          const k=r["Nome da loja"]; 
          acc.set(k,(acc.get(k)||0)+(Number(r.fat)||0)); 
        });
        const top=Array.from(acc.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
        loja.innerHTML = `<option>Todos</option>` + top.map(v=>`<option>${v}</option>`).join('');
        console.log('âœ… Top 10 lojas carregadas:', top.length);
      } catch (error) {
        console.error('Erro ao carregar lojas:', error);
      }
    }

    // ====== RELOAD (filtra no servidor) ======
    async function reload(){
      console.log('ðŸ”„ Recarregando dados...');
      
      if(!minISO||!maxISO){ 
        periodoEl.textContent='Sem dados.'; 
        console.warn('Sem dados disponÃ­veis');
        return; 
      }
      
      const a = dini.value || minISO;
      const b = dfim.value || maxISO;
      const uniSel  = uni.value || 'Todas';
      const lojaSel = loja.value || 'Todos';
      const turnSel = Array.from(turno.selectedOptions).map(o=>o.value);
      const canSel  = Array.from(canal.selectedOptions).map(o=>o.value);
      const pagSel  = Array.from(pag.selectedOptions).map(o=>o.value);
      const cancSel = canc.value || 'Todos';

      console.log('Filtros aplicados:', {
        periodo: `${a} â†’ ${b}`,
        unidade: uniSel,
        loja: lojaSel,
        turnos: turnSel,
        canais: canSel,
        pagamentos: pagSel,
        cancelado: cancSel
      });

      let q = supa.from(TABLE)
        .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
        .gte('dia', a).lte('dia', b)
        .order('dia',{ascending:true});

      if(uniSel !== 'Todas') q = q.eq('unidade', uniSel);
      if(lojaSel !== 'Todos') q = q.eq('Nome da loja', lojaSel);
      if(turnSel.length) q = q.in('turno', turnSel);
      if(canSel.length)  q = q.in('Canal de venda', canSel);
      if(pagSel.length)  q = q.in('pagamento', pagSel);
      if(cancSel !== 'Todos') q = q.eq('cancelado', cancSel);

      try {
        // Carregar todos os dados usando paginaÃ§Ã£o
        console.log('ðŸ”„ Carregando todos os dados...');
        let allRows = [];
        let page = 0;
        const pageSize = 1000;
        let hasMore = true;
        
        while (hasMore) {
          const start = page * pageSize;
          const end = start + pageSize - 1;
          
          console.log(`ðŸ“„ Carregando pÃ¡gina ${page + 1} (registros ${start}-${end})...`);
          
          const r = await q.range(start, end);
          if(r.error){ 
            console.error('Erro na query:', r.error); 
            periodoEl.textContent='Erro ao carregar dados'; 
            return; 
          }
          
          if (!r.data || r.data.length === 0) {
            hasMore = false;
            break;
          }
          
          allRows = allRows.concat(r.data);
          
          // Se retornou menos que o pageSize, chegamos ao fim
          if (r.data.length < pageSize) {
            hasMore = false;
          } else {
            page++;
          }
          
          // Limite de seguranÃ§a para evitar loop infinito
          if (page > 100) {
            console.warn('Limite de pÃ¡ginas atingido (100 pÃ¡ginas = 100k registros)');
            hasMore = false;
          }
        }
        
        console.log(`âœ… Total de registros carregados: ${allRows.length}`);
        
        const rows = allRows.map(x=>({
          ...x,
          dia: onlyDate(x.dia),
          cancelado: normCancel(x.cancelado),
          fat: Number(x.fat)||0, 
          des:Number(x.des)||0, 
          fre:Number(x.fre)||0, 
          pedidos:Number(x.pedidos)||0
        }));

        console.log(`âœ… Dados carregados: ${rows.length} registros`);
        periodoEl.textContent = `PerÃ­odo: ${a} â†’ ${b} Â· registros filtrados: ${rows.length}`;

        // KPIs
        const pedidos = rows.reduce((s,r)=>s+r.pedidos,0);
        const fat     = rows.reduce((s,r)=>s+r.fat,0);
        const des     = rows.reduce((s,r)=>s+r.des,0);
        const fre     = rows.reduce((s,r)=>s+r.fre,0);
        const dias    = new Set(rows.map(r=>r.dia)).size || 1;

        kPedidos.textContent = pedidos.toLocaleString('pt-BR');
        kFat.textContent     = fmtBRL(fat);
        kTicket.textContent  = fmtBRL(pedidos? fat/pedidos : 0);
        kFatDia.textContent  = fmtBRL(fat/dias);
        kDes.textContent     = fmtBRL(des);
        kDesPct.textContent  = fmtPct(fat? des/fat : 0);
        kFre.textContent     = fmtBRL(fre);
        kFatLiq.textContent  = fmtBRL(fat-des-fre);

        // GrÃ¡fico
        const byDay=new Map(); 
        rows.forEach(r=>byDay.set(r.dia,(byDay.get(r.dia)||0)+r.fat));
        const labels=Array.from(byDay.keys()).sort(); 
        const values=labels.map(d=>byDay.get(d));
        
        if(chart) chart.destroy();
        chart=new Chart(chartEl.getContext('2d'), {
          type:'line',
          data:{labels,datasets:[{label:'Receita',data:values,tension:0.2,pointRadius:0}]},
          options:{
            animation:false,
            responsive:true,
            maintainAspectRatio:false,
            parsing:false,
            plugins:{decimation:{enabled:true,algorithm:'lttb'}},
            scales:{y:{beginAtZero:true}}
          }
        });
        
      } catch (error) {
        console.error('Erro durante reload:', error);
        periodoEl.textContent = 'Erro ao processar dados';
      }
    }

    // ====== IMPORT CSV (incremental) ======
    function mapHeader(h){
      h = stripBOM(String(h||''));
      const key = norm(h);
      const cand = [
        {std:'dia', list:['dia','data','data da venda','data de venda','data_venda','datadavenda','date']},
        {std:'unidade', list:['unidade','filial','unidades','uni','store']},
        {std:'pedidos', list:['pedidos','pedido','qtd','qtde','quantidade','orders','qty']},
        {std:'fat', list:['fat','faturamento','total','valor total','valor','total geral','revenue','sales']},
        {std:'des', list:['des','desconto','discount']},
        {std:'fre', list:['fre','frete','entrega','delivery','shipping']},
        {std:'turno', list:['turno','shift','periodo','perÃ­odo']},
        {std:'Nome da loja', list:['nome da loja','nome loja','loja','nomedaloja','nome_da_loja','store_name']},
        {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda','channel','sales_channel']},
        {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento','payment','payment_method']},
        {std:'cancelado', list:['esta cancelado','estÃ¡ cancelado','cancelado','cancelada','cancelled','canceled']},
        {std:'hora', list:['hora','horario','horÃ¡rio','hour','time']},
        // campos da Pasta2.csv
        {std:'Data da venda', list:['data da venda']},
        {std:'Entrega', list:['entrega']},
        {std:'Desconto', list:['desconto']},
        {std:'Total', list:['total']},
      ];
      for (const c of cand) {
        if (c.list.includes(key)) {
          console.log(`Mapeando header: "${h}" -> "${c.std}"`);
          return c.std;
        }
      }
      console.log(`Header nÃ£o mapeado: "${h}"`);
      return stripBOM(h);
    }

    // ValidaÃ§Ã£o de arquivo CSV
    csv.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
          importStatus.textContent = 'Selecione um arquivo CSV vÃ¡lido';
          importStatus.style.color = '#c0392b';
          this.value = '';
          return;
        }
        if (file.size > 50 * 1024 * 1024) {
          importStatus.textContent = 'Arquivo muito grande (mÃ¡ximo 50MB)';
          importStatus.style.color = '#c0392b';
          this.value = '';
          return;
        }
        importStatus.textContent = `Arquivo selecionado: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`;
        importStatus.style.color = '#0f974d';
      }
    });

    btnImport.addEventListener('click', async ()=>{
      const file=csv.files?.[0];
      if(!file){ 
        importStatus.textContent='Selecione um CSV.'; 
        importStatus.style.color='#c0392b'; 
        return; 
      }
      
      btnImport.disabled = true;
      importStatus.textContent='Lendo arquivoâ€¦'; 
      importStatus.style.color='#667085';

      Papa.parse(file,{
        header:true, 
        skipEmptyLines:'greedy', 
        delimiter:"", 
        transformHeader: mapHeader,
        complete: async (res)=>{
          console.log('Parse completo:', res.meta);
          
          if (res.errors && res.errors.length > 0) {
            console.warn('Erros durante parse:', res.errors);
          }
          
          const raw=res.data||[];
          console.log(`Linhas lidas: ${raw.length}`);
          
          if (!raw.length) {
            importStatus.textContent = 'Arquivo CSV vazio';
            importStatus.style.color = '#c0392b';
            btnImport.disabled = false;
            return;
          }
          
          const headers=Object.keys(raw[0]||{});
          console.log('Headers detectados:', headers);
          
          const hasDia = headers.includes('dia') || headers.includes('Data da venda');
          const hasUni = headers.includes('unidade');
          const hasFat = headers.includes('fat') || headers.includes('Total');
          
          console.log('ValidaÃ§Ã£o colunas:', { hasDia, hasUni, hasFat });
          
          if(!hasDia || !hasUni || !hasFat){
            const missing = [];
            if (!hasDia) missing.push('Data/Dia');
            if (!hasUni) missing.push('Unidade');
            if (!hasFat) missing.push('Faturamento/Total');
            
            importStatus.textContent=`Colunas obrigatÃ³rias nÃ£o encontradas: ${missing.join(', ')}`;
            importStatus.style.color='#c0392b'; 
            btnImport.disabled = false;
            return;
          }

          importStatus.textContent='Processando dadosâ€¦'; 
          importStatus.style.color='#667085';

          const normRows = raw.map((r,idx)=>{
            try {
              let dval = r.dia ?? r['Data da venda'];
              let iso  = null;
              if(dval){ 
                iso = (String(dval).includes('/')) ? ddmmyyyyToISO(dval) : dval; 
              }
              if(!iso) {
                console.warn(`Linha ${idx + 1}: Data invÃ¡lida - ${dval}`);
                return null;
              }

              const hora = ('hora' in r) ? (parseInt(r.hora,10)||-1) : hourFromDateText(dval);
              const fat  = parseBR(r.fat ?? r.Total ?? 0);
              const des  = parseBR(r.des ?? r['Desconto'] ?? 0);
              const fre  = parseBR(r.fre ?? r['Entrega']  ?? 0);
              const unidade = String(r.unidade||'').trim();

              if(!unidade || !isFinite(fat) || fat < 0) {
                console.warn(`Linha ${idx + 1}: Dados invÃ¡lidos - unidade: "${unidade}", fat: ${fat}`);
                return null;
              }

              return {
                dia: onlyDate(iso),
                unidade,
                pedidos: Math.max(1, Number(r.pedidos)||1),
                fat, des, fre,
                turno: r.turno ?? null,
                pagamento: r.pagamento ?? null,
                "Canal de venda": r["Canal de venda"] ?? r.Canal ?? null,
                "Nome da loja": r["Nome da loja"] ?? r.Loja ?? null,
                cancelado: normCancel(r.cancelado ?? r['EstÃ¡ cancelado']),
                hora: isFinite(hora)?hora:-1
              };
            } catch (error) {
              console.error(`Erro processando linha ${idx + 1}:`, error, r);
              return null;
            }
          }).filter(Boolean);

          console.log(`Processadas ${normRows.length} linhas vÃ¡lidas de ${raw.length} total`);

          if(!normRows.length){ 
            importStatus.textContent='Nenhuma linha vÃ¡lida encontrada'; 
            importStatus.style.color='#c0392b'; 
            btnImport.disabled = false;
            return; 
          }

          importStatus.textContent='Deduplicando dadosâ€¦'; 
          importStatus.style.color='#667085';

          // agrega por chave para evitar 409 em linha duplicada dentro do prÃ³prio arquivo
          const acc=new Map();
          for(const r of normRows){
            const key=[r.dia,r.unidade,r["Nome da loja"],r.hora,r.pagamento,r["Canal de venda"]].join('|');
            const v=acc.get(key)||{...r};
            v.pedidos=(v.pedidos||0)+(r.pedidos||0);
            v.fat=(v.fat||0)+(r.fat||0);
            v.des=(v.des||0)+(r.des||0);
            v.fre=(v.fre||0)+(r.fre||0);
            v.cancelado=r.cancelado||v.cancelado;
            acc.set(key,v);
          }
          const rows=[...acc.values()];
          
          importStatus.textContent=`Enviando ${rows.length.toLocaleString('pt-BR')} registrosâ€¦`; 
          importStatus.style.color='#667085';

          try {
            // upsert em lotes
            const onC='dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"';
            const chunk=1000;
            for(let i=0;i<rows.length;i+=chunk){
              const part=rows.slice(i,i+chunk);
              const r=await supa.from(TABLE).upsert(part,{onConflict:onC});
              if(r.error){ 
                console.error('Erro no upsert:', r.error); 
                importStatus.textContent='Erro ao inserir dados no banco'; 
                importStatus.style.color='#c0392b'; 
                btnImport.disabled = false;
                return; 
              }
            }

            importStatus.textContent=`âœ… ${rows.length} registros importados com sucesso!`; 
            importStatus.style.color='#0f974d';
            
            console.log('âœ… ImportaÃ§Ã£o concluÃ­da, atualizando dashboard...');
            await fetchMinMax(); 
            await buildOptions(); 
            await reload();
            
          } catch (error) {
            console.error('Erro durante upsert:', error);
            importStatus.textContent = 'Erro ao salvar no banco de dados';
            importStatus.style.color = '#c0392b';
          }
          
          btnImport.disabled = false;
        },
        error: err => { 
          console.error('Erro no parse:', err); 
          importStatus.textContent='Erro ao ler CSV.'; 
          importStatus.style.color='#c0392b'; 
          btnImport.disabled = false;
        }
      });
    });

    // ====== DEBUG FUNCTION ======
    window.debugInfo = function() {
      console.log('=== DEBUG INFO ===');
      console.log('TABLE:', TABLE);
      console.log('minISO:', minISO);
      console.log('maxISO:', maxISO);
      console.log('Filtros atuais:', {
        unidade: uni.value,
        loja: loja.value,
        periodo: `${dini.value} â†’ ${dfim.value}`,
        cancelado: canc.value
      });
      console.log('Supabase client:', supa);
      console.log('==================');
    };

    // ====== LISTENERS ======
    pr.addEventListener("change", ()=>{ applyQuickDate(); reload(); fx.open=false; });
    [uni,dini,dfim,turno,canal,pag,canc,loja].forEach(e=> e.addEventListener("change", ()=>{ reload(); fx.open=false; }));
    btnLimpar.addEventListener('click', ()=>{ 
      uni.value='Todas'; 
      loja.value='Todos'; 
      turno.selectedIndex=-1; 
      canal.selectedIndex=-1; 
      pag.selectedIndex=-1; 
      canc.value='Todos'; 
      applyQuickDate(); 
      reload(); 
    });

    // ====== BOOT ======
    (async function boot(){
      console.log('ðŸš€ Iniciando boot sequence...');
      await fetchMinMax();
      applyQuickDate();
      await buildOptions();
      await reload();
      console.log('âœ… Dashboard inicializado com sucesso!');
    })();

  })();
  </script>
</body>
</html>

