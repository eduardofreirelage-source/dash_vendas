<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='22' fill='%232f6ef7'/><text x='64' y='78' text-anchor='middle' font-family='Arial' font-size='56' fill='white'>DV</text></svg>"/>
<style>
:root{--bg:#f6f8fb;--card:#fff;--line:#e6e7eb;--ink:#0b1220;--mut:#667085;--pri:#2f6ef7}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
h1{margin:0 0 14px;font-size:28px}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
.row{display:grid;gap:10px}.cols-3{grid-template-columns:repeat(3,1fr)}.cols-2{grid-template-columns:repeat(2,1fr)}
label{display:block;color:var(--mut);font-size:12px;margin:4px 0}
input[type=date],.ms,.btn{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.btn{cursor:pointer}.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.chip.active{background:var(--pri);border-color:var(--pri);color:#fff}
.krow{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi h4{margin:0 0 6px;color:#475569}.kpi .val{font-size:22px;font-weight:800}
.chart{height:280px}
.status{color:#64748b}
@media(max-width:1024px){.cols-3{grid-template-columns:repeat(2,1fr)}.krow{grid-template-columns:repeat(2,1fr)}}
@media(max-width:640px){.cols-3,.cols-2,.krow{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>DASHBOARD</h1>

  <div class="section">
    <div class="row cols-3">
      <div><label>Intervalo (inÃ­cio)</label><input type="date" id="dini"/></div>
      <div><label>Intervalo (fim)</label><input type="date" id="dfim"/></div>
      <div>
        <label>PerÃ­odo rÃ¡pido</label>
        <div class="chips">
          <button class="chip" data-q="7">07</button>
          <button class="chip" data-q="15">15</button>
          <button class="chip active" data-q="30">30</button>
          <button class="chip" data-q="60">60</button>
          <button class="chip" data-q="90">90</button>
          <button class="chip" data-q="120">120</button>
        </div>
        <div id="ultimo" class="status" style="margin-top:6px">Ãšltimo dia carregado: â€”</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="row cols-3">
      <div><label>Unidade</label><input class="ms" id="unids" placeholder="(todas)" /></div>
      <div><label>Loja</label><input class="ms" id="lojas" placeholder="(todas)" /></div>
      <div><label>Turno</label><input class="ms" id="turnos" placeholder="(todos)" /></div>
    </div>
    <div class="row cols-3" style="margin-top:8px">
      <div><label>Canal</label><input class="ms" id="canais" placeholder="(todos)" /></div>
      <div><label>Pagamento</label><input class="ms" id="pags" placeholder="(todos)" /></div>
      <div><label>Cancelado</label>
        <select id="cancel" class="ms">
          <option value="">Todos</option>
          <option value="NÃ£o" selected>NÃ£o</option>
          <option value="Sim">Sim</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
      <button id="btnUpload" class="btn">ðŸ“¤ Carregar Excel</button>
      <input id="fileExcel" type="file" accept=".xlsx,.xls" style="display:none"/>
      <div id="status" class="status">â€”</div>
      <div id="diag" class="status"></div>
    </div>
  </div>

  <div class="krow">
    <div class="kpi"><h4>Pedidos</h4><div class="val" id="k_ped">â€”</div><div>Anterior: <span id="p_ped">â€”</span></div></div>
    <div class="kpi"><h4>Ticket MÃ©dio</h4><div class="val" id="k_tkt">â€”</div><div>Anterior: <span id="p_tkt">â€”</span></div></div>
    <div class="kpi"><h4>Faturamento</h4><div class="val" id="k_fat">â€”</div><div>Anterior: <span id="p_fat">â€”</span></div></div>
  </div>

  <div class="section">
    <div class="row cols-2">
      <div><canvas id="ch_dow" class="chart"></canvas></div>
      <div><canvas id="ch_month" class="chart"></canvas></div>
      <div><canvas id="ch_hour" class="chart"></canvas></div>
      <div><canvas id="ch_turno" class="chart"></canvas></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const money=(v)=>'R$ '+(+v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const num=(v)=>(+v||0).toLocaleString('pt-BR');

const $=id=>document.getElementById(id);
const setStatus=(t,k)=>{$('status').textContent=t; $('status').style.color=k==='err'?'#ef4444':k==='ok'?'#10b981':'#64748b';};
const setDiag=(t)=>{$('diag').textContent=t||'';};

let firstDay='', lastDay='';
const dini=$('dini'), dfim=$('dfim');

async function discoverRange(){
  const minQ=await supa.from('vendas_xlsx').select('dia').order('dia',{ascending:true}).limit(1);
  const maxQ=await supa.from('vendas_xlsx').select('dia').order('dia',{ascending:false}).limit(1);
  firstDay=minQ?.data?.[0]?.dia || new Date().toISOString().slice(0,10);
  lastDay =maxQ?.data?.[0]?.dia || new Date().toISOString().slice(0,10);
  $('ultimo').textContent='Ãšltimo dia carregado: '+lastDay;
  if(!dini.value) dini.value=addDaysISO(lastDay,-29);
  if(!dfim.value) dfim.value=lastDay;
}

function addDaysISO(iso,n){const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10);}
document.querySelectorAll('.chip').forEach(b=>b.onclick=()=>{document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));b.classList.add('active');dini.value=addDaysISO(lastDay,-(Number(b.dataset.q)-1));dfim.value=lastDay;applyAll();});
[dini,dfim,$('cancel')].forEach(el=>el.addEventListener('change',applyAll));

/* ---------- RPC fallback robusto ---------- */
async function rpcFallback(baseName, params){
  // Ordem de tentativas: v2 -> v1 -> sem sufixo, e inclui o 'kpi_vendas' explicitamente
  const names = [baseName, baseName.replace(/_v2$/,'_v1'), baseName.replace(/_v2$/,'')];
  if(baseName==='kpi_vendas_v2'){ names.splice(1,0,'kpi_vendas'); } // garante wrapper
  for(const fn of names){
    try{
      const { data, error } = await supa.rpc(fn, params);
      if(error) throw error;
      if(Array.isArray(data)) return data;
    }catch(e){
      // se 404, tenta o prÃ³ximo nome
      if((e?.message||'').includes('404') || (e?.code||'').toString().includes('PGRST')) continue;
      // outro erro: propaga
      throw e;
    }
  }
  throw new Error('Nenhuma RPC encontrada para '+baseName);
}

/* ---------- KPIs ---------- */
function daysLen(a,b){const d1=new Date(a+'T00:00:00'),d2=new Date(b+'T00:00:00');return Math.round((d2-d1)/(1000*60*60*24))+1;}
function prevRange(a,b){const d1=new Date(a+'T00:00:00');const len=daysLen(a,b);const atePrev=new Date(d1.getTime()-24*60*60*1000);const dePrev=new Date(atePrev.getTime()-(len-1)*24*60*60*1000);return {de:dePrev.toISOString().slice(0,10), ate:atePrev.toISOString().slice(0,10)};}

function agg(rows){let p=0,f=0;for(const r of rows||[]){p+=+r.pedidos||0;f+=+r.fat||0;}return {p,f};}

async function loadKPIs(){
  const de=dini.value, ate=dfim.value;
  const pr=prevRange(de,ate);
  const base={ p_dini:de, p_dfim:ate,
    p_unids:null, p_lojas:null, p_turnos:null, p_canais:null, p_pags:null, p_cancelado:$('cancel').value||null
  };
  const basePrev={...base, p_dini:pr.de, p_dfim:pr.ate};
  const now = await rpcFallback('kpi_vendas_v2', base).catch(()=>[]);
  const prv = await rpcFallback('kpi_vendas_v2', basePrev).catch(()=>[]);
  const N=agg(now), P=agg(prv);
  $('k_ped').textContent=num(N.p);
  $('p_ped').textContent=num(P.p);
  $('k_fat').textContent=money(N.f);
  $('p_fat').textContent=money(P.f);
  $('k_tkt').textContent=money(N.p?N.f/N.p:0);
  $('p_tkt').textContent=money(P.p?P.f/P.p:0);
}

/* ---------- GrÃ¡ficos ---------- */
let C={};
function ensureChart(id,labels,data){ if(C[id]){C[id].destroy();} C[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels,datasets:[{label:'Atual',data,backgroundColor:'rgba(47,110,247,.85)'}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}}); }

async function loadCharts(){
  const de=dini.value, ate=dfim.value;
  const p={ p_dini:de, p_dfim:ate, p_unids:null, p_lojas:null, p_turnos:null, p_canais:null, p_pags:null, p_cancelado:$('cancel').value||null };
  const [dow, mon, hor, tur] = await Promise.all([
    rpcFallback('chart_vendas_dow_v2', p).catch(()=>[]),
    rpcFallback('chart_vendas_mes_v2', p).catch(()=>[]),
    rpcFallback('chart_vendas_hora_v2', p).catch(()=>[]),
    rpcFallback('chart_vendas_turno_v2', p).catch(()=>[]),
  ]);
  // DOW
  const lblDow=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
  const arrDow=Array(7).fill(0); (dow||[]).forEach(r=>{arrDow[r.dow]=+r.total||0}); ensureChart('ch_dow',lblDow,arrDow);
  // MÃŠS
  const ymAll=(mon||[]).map(r=>r.ym); const lblM=ymAll.map(ym=>{const[a,b]=ym.split('-');return b+'/'+a.slice(2)}); ensureChart('ch_month',lblM,(mon||[]).map(r=>+r.total||0));
  // HORA
  const lblH=Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+'h'); const arrH=Array(24).fill(0); (hor||[]).forEach(r=>{arrH[r.h]=+r.total||0}); ensureChart('ch_hour',lblH,arrH);
  // TURNO
  const ord=['ManhÃ£','Tarde','Noite','Madrugada','Dia']; const m=new Map((tur||[]).map(r=>[r.turno,+r.total||0])); const lblT=ord.filter(x=>m.has(x)); ensureChart('ch_turno',lblT,lblT.map(x=>m.get(x)||0));
}

/* ---------- Upload Excel (com DEDUPE) ---------- */
$('btnUpload').onclick=()=>$('fileExcel').click();
$('fileExcel').addEventListener('change', async (ev)=>{
  const file=ev.target.files?.[0]; if(!file) return;
  setStatus('Lendo arquivoâ€¦');
  try{
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{raw:false,defval:null});
    // mapeamento mÃ­nimo (ajuste se precisar)
    const norm=(s)=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    const cols=rows.length?Object.keys(rows[0]):[];
    const col=(alts)=>{ for(const a of alts){ const c=cols.find(h=>norm(h).includes(a)); if(c) return c; } return null; };
    const kDia=col(['data','data da venda','dia','date']);
    const kHora=col(['hora','hour']); const kUni=col(['unidade','filial']); const kLoja=col(['loja']); const kCan=col(['canal']); const kPag=col(['pagamento']); const kCanc=col(['cancelado']); const kFat=col(['fat','faturamento']); const kDes=col(['desc','desconto']); const kFre=col(['fre','frete']); const kPed=col(['ped','qtd','itens']); const kPid=col(['pedido','order']);
    const parseDate=(v)=>{ if(v instanceof Date) return v.toISOString().slice(0,10); const s=String(v||'').trim(); const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/); if(m){const[_,d,mn,y]=m;const dt=new Date(+y,+mn-1,+d); return dt.toISOString().slice(0,10);} if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10); if(!isNaN(+s)){const base=new Date(Date.UTC(1899,11,30)); const dt=new Date(base.getTime()+(+s)*86400000); return dt.toISOString().slice(0,10);} return null; };
    const toNum=(v)=>{ if(v==null) return 0; if(typeof v==='number') return v; let s=String(v).replace(/[^\d,.\-]/g,''); const li=Math.max(s.lastIndexOf(','),s.lastIndexOf('.')); if(li>-1){ const dec=s[li]; s=s.replace(/[^0-9]/g,''); if(dec===',') s=s.replace(/(\d{2})$/g,'.$1'); else s=s.replace(/(\d{2})$/g,'.$1'); } return +(+s||0); };
    const normCanc=(v)=>{const s=String(v||'').toLowerCase(); if(['sim','s','true','1'].includes(s)) return 'Sim'; return 'NÃ£o';};

    const mapped = rows.map(r=>{
      const dia=parseDate(r[kDia]);
      const obj={
        dia,
        hora: (r[kHora]!=null?parseInt(r[kHora],10):null),
        unidade: (r[kUni]||'UNID_ND'),
        loja: (r[kLoja]||'LOJA_DESCONHECIDA'),
        canal: (r[kCan]||'CANAL_ND'),
        pagamento_base: (r[kPag]||null),
        cancelado: normCanc(r[kCanc]),
        pedidos: r[kPed]!=null? parseInt(r[kPed],10): 1,
        fat: toNum(r[kFat]), des: toNum(r[kDes]), fre: toNum(r[kFre]),
        pedido_id: r[kPid]||null,
        turno: r['turno']||null,
        created_at: new Date().toISOString()
      };
      obj.row_key = [
        obj.dia||'', obj.hora??'', obj.unidade||'', obj.loja||'', obj.canal||'',
        obj.pagamento_base||'', obj.pedido_id||'', obj.pedidos??'', obj.cancelado||'', obj.turno||''
      ].map(x=>String(x).toLowerCase().trim()).join('|');
      return obj;
    }).filter(x=>x.dia);

    // DEDUPLICA por row_key para evitar "cannot affect row a second time"
    const map=new Map(); for(const r of mapped){ map.set(r.row_key, r); }
    const dedup=[...map.values()];

    setStatus(`Enviando ${dedup.length} linha(s)â€¦`);
    // upsert em lotes
    for(let i=0;i<dedup.length;i+=500){
      const slice=dedup.slice(i,i+500);
      const { error } = await supa.from('vendas_xlsx').upsert(slice,{onConflict:'row_key'});
      if(error) throw error;
    }
    setStatus('Upload concluÃ­do','ok');
    await discoverRange();
    await applyAll();
  }catch(e){
    console.error(e);
    setStatus('Erro ao ler/enviar Excel: '+(e.message||e),'err');
  }finally{
    $('fileExcel').value='';
  }
});

/* ---------- fluxo principal ---------- */
async function applyAll(){
  try{
    setStatus('Consultandoâ€¦');
    await loadKPIs();
    await loadCharts();
    setStatus('OK','ok');
  }catch(e){
    console.error(e);
    setStatus('OK (parcial)','ok');
    setDiag('');
  }
}

(async function init(){
  await discoverRange();
  if(!dini.value) dini.value=addDaysISO(lastDay,-29);
  if(!dfim.value) dfim.value=lastDay;
  applyAll();
})();
</script>
</body>
</html>
