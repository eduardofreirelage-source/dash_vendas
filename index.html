<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DASHBOARD — CFO (v2.22.0 — schema dinâmico + KPI realmente dirige os gráficos)</title>
<style>
:root{--bg:#f6f8fb;--card:#fff;--ink:#0b1220;--muted:#667085;--line:#e6e7eb;--c-now:#7b1e3a;--c-prev:#94a3b8}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:28px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px}
.sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
.row{display:grid;gap:12px}.cols-3{grid-template-columns:repeat(3,1fr)}.cols-2{grid-template-columns:repeat(2,1fr)}
input[type="date"],.msel-btn{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:44px;font-size:16px}
.chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
.chip{padding:10px 0;border:1px solid #efd5db;border-radius:10px;background:#f7e9ed;cursor:pointer;text-align:center;font-weight:800;color:#7b1e3a}
.chip.active{background:var(--c-now);border-color:var(--c-now);color:#fff}
.msel{position:relative}.msel-btn{cursor:pointer;text-align:left}.msel-btn:after{content:"▾";float:right;color:#475569}
.msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
.msel.open .msel-panel{display:block}.msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
.msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}.msel-opt:hover{background:#f3f4f6}
.krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05);cursor:pointer}
.kpi.active{border-color:var(--c-now);box-shadow:0 0 0 4px rgba(123,30,58,.06)}
.kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
.kpi .val{font-size:22px;font-weight:800}.accent{height:2px;background:#7b1e3a;border-radius:999px;margin:6px 0}
.delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:12px;margin-left:12px;background:rgba(148,163,184,.15);color:#64748b}
.delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:#7b1e3a}
.chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
.chart-box{height:280px;position:relative}.chart-box canvas{display:block;width:100%;height:100%}
.chart-card.wide{grid-column:span 2}.chart-card.wide .chart-box{height:360px}
.seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:800}
.seg button.active{background:#7b1e3a;color:#fff}
.center-link{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.92);border:1px solid var(--line);padding:4px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;white-space:nowrap}
@media (max-width:1024px){.cols-3{grid-template-columns:repeat(2,1fr)}.cols-2{grid-template-columns:1fr}.krow{grid-template-columns:repeat(2,1fr)}.chart-card.wide{grid-column:span 1}}
@media (max-width:640px){.cols-3,.krow{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>DASHBOARD</h1>
    <div class="upload-bar">
      <button id="btnUpload" class="btn">📤 Carregar Excel</button>
      <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
    </div>
  </div>

  <div id="secDatas" class="section">
    <div class="sec-head">
      <div>Filtros de Data</div>
      <button id="btnClear" class="btn">✖ Limpar filtros</button>
    </div>
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px;">Início</div><input type="date" id="fDe"></div>
      <div><div class="muted" style="margin-bottom:6px;">Fim</div><input type="date" id="fAte"></div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Período rápido</div>
        <div class="chips">
          <button class="chip" data-q="7">07</button>
          <button class="chip" data-q="15">15</button>
          <button class="chip active" data-q="30">30</button>
          <button class="chip" data-q="60">60</button>
          <button class="chip" data-q="90">90</button>
          <button class="chip" data-q="120">120</button>
        </div>
        <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">—</div>
      </div>
    </div>
  </div>

  <div id="secFiltros" class="section">
    <div class="sec-head">
      <div>Filtros</div>
      <div><span id="status" class="muted">—</span> <span id="diag" class="muted"></span></div>
    </div>
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px;">Unidade</div><div id="ms-unids" class="msel"><button class="msel-btn">Todas</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Loja</div><div id="ms-lojas" class="msel"><button class="msel-btn">Todas</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Turno</div><div id="ms-turnos" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div></div>
    </div>
    <div class="row cols-3" style="margin-top:10px;">
      <div><div class="muted" style="margin-bottom:6px;">Canal</div><div id="ms-canais" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Pagamento</div><div id="ms-pags" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Cancelado</div><div id="ms-cancel" class="msel"><button class="msel-btn">Não</button><div class="msel-panel"><div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div><div class="msel-opt"><input type="checkbox" value="Não" checked><label>Não</label></div><div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div></div></div></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="krow">
    <div class="kpi" data-kpi="ped"><h4>Pedidos <span id="d_ped" class="delta">—</span></h4><div class="val" id="k_ped">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_ped">—</span></div></div>
    <div class="kpi" data-kpi="tkt"><h4>Ticket Médio <span id="d_tkt" class="delta">—</span></h4><div class="val" id="k_tkt">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_tkt">—</span></div></div>
    <div class="kpi active" data-kpi="fat"><h4>Faturamento <span id="d_fat" class="delta">—</span></h4><div class="val" id="k_fat">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fat">—</span></div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi" data-kpi="fatmed"><h4>Faturamento Médio <span id="d_fatmed" class="delta">—</span></h4><div class="val" id="k_fatmed">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fatmed">—</span></div></div>
    <div class="kpi" data-kpi="des"><h4>Incentivos <span id="d_des" class="delta">—</span></h4><div class="val" id="k_des">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_des">—</span></div></div>
    <div class="kpi" data-kpi="desperc"><h4>% de Incentivos <span id="d_desperc" class="delta">—</span></h4><div class="val" id="k_desperc">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_desperc">—</span></div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi" data-kpi="fre"><h4>Frete <span id="d_fre" class="delta">—</span></h4><div class="val" id="k_fre">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fre">—</span></div></div>
    <div class="kpi" data-kpi="fremed"><h4>Frete Médio <span id="d_fremed" class="delta">—</span></h4><div class="val" id="k_fremed">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fremed">—</span></div></div>
    <div class="kpi" data-kpi="canc_ped"><h4>Pedidos Cancelados <span id="d_canc_ped" class="delta">—</span></h4><div class="val" id="k_canc_ped">—</div><div class="accent"></div><div class="sub">Participação: <span id="k_canc_part">—</span> (Anterior: <span id="p_canc_part">—</span>)</div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi" data-kpi="canc_val"><h4>Valor de Cancelados <span id="d_canc_val" class="delta">—</span></h4><div class="val" id="k_canc_val">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_canc_val">—</span></div></div>
    <div class="kpi" data-kpi="roi"><h4>ROI <span id="d_roi" class="delta">—</span></h4><div class="val" id="k_roi">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_roi">—</span></div></div>
    <div></div>
  </div>

  <div class="section">
    <div class="sec-head">
      <div>Gráficos</div>
      <div id="segGlobal" class="seg"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">Média</button></div>
    </div>
    <div class="row cols-2">
      <div class="chart-card wide"><div class="muted" id="title_month">Vendas por mês — últimos 12M vs. 12M anteriores</div><div class="chart-box"><canvas id="ch_month"></canvas></div></div>
      <div class="chart-card"><div class="muted" id="title_dow">Vendas por dia da semana</div><div class="chart-box"><canvas id="ch_dow"></canvas></div></div>
      <div class="chart-card"><div class="muted" id="title_hour">Vendas por hora</div><div class="chart-box"><canvas id="ch_hour"></canvas></div></div>
      <div class="chart-card"><div class="muted" id="title_turno">Vendas por turno</div><div class="chart-box"><canvas id="ch_turno"></canvas></div></div>
      <div class="chart-card"><div class="muted" id="title_top6">Participação por loja — Top 6</div><div class="chart-box"><canvas id="ch_top6"></canvas><button id="top6Center" class="center-link">Total: R$ 0,00</button></div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ====== CONFIG ====== */
const READ_VIEW='vendas_canon';
const SUPABASE_URL='https://msmyfxgrnuusnvoqyeuo.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U';
const supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

/* ====== THEME / CHART ====== */
Chart.defaults.font.family='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
Chart.defaults.color='#334155';
Chart.defaults.plugins.legend.position='top';
Chart.defaults.plugins.tooltip.backgroundColor='rgba(15,23,42,.95)';
Chart.defaults.plugins.tooltip.titleColor='#e2e8f0';
Chart.defaults.plugins.tooltip.bodyColor='#e2e8f0';
Chart.defaults.plugins.tooltip.borderColor='rgba(148,163,184,.25)';
Chart.defaults.plugins.tooltip.borderWidth=1;
Chart.defaults.datasets.bar.borderRadius=6;
Chart.defaults.datasets.bar.borderSkipped=false;
Chart.defaults.datasets.bar.maxBarThickness=42;
Chart.defaults.devicePixelRatio=Math.max(1,window.devicePixelRatio||1);
function gradNow(ctx){const g=ctx.createLinearGradient(0,0,0,240);g.addColorStop(0,'rgba(123,30,58,.95)');g.addColorStop(1,'rgba(156,53,84,.55)');return g;}
function gradPrev(ctx){const g=ctx.createLinearGradient(0,0,0,240);g.addColorStop(0,'rgba(148,163,184,.85)');g.addColorStop(1,'rgba(203,213,225,.45)');return g;}

/* ====== HELPERS ====== */
const $=id=>document.getElementById(id);
const setStatus=(t,k)=>{const el=$('status');el.textContent=t;el.style.color=(k==='err'?'#ef4444':k==='ok'?'#10b981':'#667085');};
const setDiag=(t)=>$('diag').textContent=t||'';
const money=v=>(v==null||!isFinite(+v))?'R$ 0,00':'R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const num=v=>(v==null||!isFinite(+v))?'0':(+v).toLocaleString('pt-BR');
const pctf=v=>(v==null||!isFinite(+v))?'0,0%':((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
function iso(d){return d.toISOString().slice(0,10);}function addDaysISO(s,n){const d=new Date(s+'T00:00:00');d.setDate(d.getDate()+n);return iso(d);}
function daysLen(de,ate){const d1=new Date(de+'T00:00:00'),d2=new Date(ate+'T00:00:00');return Math.round((d2-d1)/86400000)+1;}
function monthStartISO(s){const d=new Date(s+'T00:00:00');d.setDate(1);return iso(d);}function monthEndISO(s){const d=new Date(s+'T00:00:00');d.setMonth(d.getMonth()+1,0);return iso(d);}
function addMonthsISO(s,delta){const d=new Date(s+'T00:00:00');const day=d.getDate();d.setDate(1);d.setMonth(d.getMonth()+delta);const last=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();d.setDate(Math.min(day,last));return iso(d);}
function formatYM(s){const d=new Date(s+'T00:00:00');const m=d.getMonth();const y=String(d.getFullYear()).slice(-2);const n=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];return `${n[m]}/${y}`;}

/* ====== MULTISELECT ====== */
function MultiSelect(rootId, placeholder){
  const root=$(rootId),btn=root.querySelector('.msel-btn'),panel=root.querySelector('.msel-panel');
  let options=[],selected=new Set(),filtered=[];
  function render(){panel.innerHTML='';const q=document.createElement('input');q.className='msel-search';q.placeholder='Filtrar…';q.addEventListener('input',()=>{filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase()));draw();});panel.appendChild(q);draw();}
  function draw(){const box=document.createElement('div');(filtered.length?filtered:options).forEach(v=>{const row=document.createElement('div');row.className='msel-opt';const cb=document.createElement('input');cb.type='checkbox';cb.value=v;cb.checked=selected.has(v);const lb=document.createElement('label');lb.textContent=v;cb.addEventListener('change',()=>{cb.checked?selected.add(v):selected.delete(v);refresh();applyAll();});row.appendChild(cb);row.appendChild(lb);box.appendChild(row);});panel.querySelectorAll('.msel-opt').forEach(n=>n.remove());panel.appendChild(box);}
  function refresh(){btn.textContent=selected.size===0?placeholder:`${selected.size} selecionado(s)`;}
  btn.addEventListener('click',()=>root.classList.toggle('open'));document.addEventListener('click',(e)=>{if(!root.contains(e.target))root.classList.remove('open');});
  return {setOptions(list,keep=false){options=(list||[]).filter(v=>v!=null).map(String);if(!keep)options.sort((a,b)=>a.localeCompare(b,'pt-BR'));filtered=options.slice();selected=new Set([...selected].filter(v=>options.includes(v)));render();refresh();},get(){return [...selected];},set(vals){selected=new Set((vals||[]).map(String));refresh();draw();}};
}

/* ====== ESTADO ====== */
let firstDay='', lastDay='';
const chips=[...document.querySelectorAll('.chip')];
const fDe=$('fDe'), fAte=$('fAte'); const periodoInfo=$('periodoInfo');
const ms={unids:MultiSelect('ms-unids','Todas as unidades'),lojas:MultiSelect('ms-lojas','Todas as lojas'),canais:MultiSelect('ms-canais','Todos os canais'),turnos:MultiSelect('ms-turnos','Todos os turnos'),pags:MultiSelect('ms-pags','Todos os tipos'),cancel:MultiSelect('ms-cancel','Todos')};
function setActiveChip(val){chips.forEach(c=>c.classList.toggle('active',c.dataset.q===String(val))); }
function applyQuick(val){setActiveChip(val);const ate=lastDay||iso(new Date());const de=addDaysISO(ate,-(Number(val)-1));fDe.value=de;fAte.value=ate;periodoInfo.textContent=`Último dia carregado: ${lastDay}`;applyAll();}
$('btnClear').addEventListener('click',()=>{ms.unids.set([]);ms.lojas.set([]);ms.canais.set([]);ms.turnos.set([]);ms.pags.set([]);ms.cancel.set(['Não']);applyQuick('30');});
chips.forEach(b=>b.addEventListener('click',()=>applyQuick(b.dataset.q)));
[fDe,fAte].forEach(inp=>inp.addEventListener('change',()=>{chips.forEach(c=>c.classList.remove('active'));periodoInfo.textContent=`Último dia carregado: ${lastDay}`;applyAll();}));

/* ====== KPI defs ====== */
let selectedKPI='fat';
const KPI_META={fat:{label:'Faturamento',fmt:'money',forceMode:null,needsCancel:null},ped:{label:'Pedidos',fmt:'count',forceMode:null,needsCancel:null},tkt:{label:'Ticket médio',fmt:'money',forceMode:'media',needsCancel:null},des:{label:'Incentivos',fmt:'money',forceMode:null,needsCancel:null},desperc:{label:'% de incentivos',fmt:'percent',forceMode:'media',needsCancel:null},fre:{label:'Frete',fmt:'money',forceMode:null,needsCancel:null},fremed:{label:'Frete médio',fmt:'money',forceMode:'media',needsCancel:null},fatmed:{label:'Faturamento médio',fmt:'money',forceMode:'media',needsCancel:null},canc_ped:{label:'Pedidos cancelados',fmt:'count',forceMode:null,needsCancel:'Sim'},canc_val:{label:'Valor de cancelados',fmt:'money',forceMode:null,needsCancel:'Sim'},roi:{label:'ROI',fmt:'percent',forceMode:'media',needsCancel:null}};
function effectiveMode(){return (KPI_META[selectedKPI]?.forceMode)||chartModeGlobal;}
function updateChartTitles(){const m=KPI_META[selectedKPI]||KPI_META.fat;const mode=effectiveMode()==='media'?' (média)':'';$('title_month').textContent=`${m.label}${mode} por mês — últimos 12M vs. 12M anteriores`;$('title_dow').textContent=`${m.label}${mode} por dia da semana`;$('title_hour').textContent=`${m.label}${mode} por hora`;$('title_turno').textContent=`${m.label}${mode} por turno`;$('title_top6').textContent=`Participação por loja — Top 6 (${m.label}${mode})`; }
function bindKPIClick(){document.querySelectorAll('.kpi[data-kpi]').forEach(card=>card.addEventListener('click',()=>{selectedKPI=card.dataset.kpi;document.querySelectorAll('.kpi[data-kpi]').forEach(k=>k.classList.toggle('active',k===card));updateChartTitles();updateMonth12x12();updateChartsServer();updateTop6();}));}

/* ====== RPC (KPIs principais) ====== */
function buildParams(de,ate,overrideCancel=null){const canc=overrideCancel!=null?[overrideCancel]:ms.cancel.get();let p_cancelado=null;if(canc.length===1&&(canc[0]==='Não'||canc[0]==='Sim'))p_cancelado=canc[0];return{p_dini:de,p_dfim:ate,p_unids:ms.unids.get().length?ms.unids.get():null,p_lojas:ms.lojas.get().length?ms.lojas.get():null,p_turnos:ms.turnos.get().length?ms.turnos.get():null,p_canais:ms.canais.get().length?ms.canais.get():null,p_pags:ms.pags.get().length?ms.pags.get():null,p_cancelado};}
function rpcName(p){return p.p_unids?'kpi_vendas_v2':'kpi_vendas';}
function prepareArgs(name,p){if(name==='kpi_vendas'){const {p_unids,...rest}=p;return rest;}return p;}
function agg(rows){let ped=0,fat=0,des=0,fre=0;for(const r of (rows||[])){ped+=+r.pedidos||0;fat+=+r.fat||0;des+=+r.des||0;fre+=+r.fre||0;}return {ped,fat,des,fre};}
function upSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>';}
function downSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>';}
function deltaBadge(el,curr,prev){if(!isFinite(prev)||+prev===0){el.textContent='—';el.className='delta';return;}const p=((curr-prev)/prev)*100;el.innerHTML=(p>=0?upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%';el.className='delta '+(p>=0?'up':'');}
async function updateKPIs(de,ate,dePrev,atePrev){
  const pNow=buildParams(de,ate), pPrev=buildParams(dePrev,atePrev);
  const [now,prev,cNow,cPrev]=await Promise.all([supa.rpc(rpcName(pNow),prepareArgs(rpcName(pNow),pNow)),supa.rpc(rpcName(pPrev),prepareArgs(rpcName(pPrev),pPrev)),supa.rpc(rpcName(pNow),prepareArgs(rpcName(pNow),{...pNow,p_cancelado:'Sim'})),supa.rpc(rpcName(pPrev),prepareArgs(rpcName(pPrev),{...pPrev,p_cancelado:'Sim'}))]);
  if(now.error)throw now.error;if(prev.error)throw prev.error;
  const N=agg(now.data||[]), P=agg(prev.data||[]), CN=agg((cNow.data)||[]), CP=agg((cPrev.data)||[]);
  const len=daysLen(de,ate);
  const tktN=N.ped?N.fat/N.ped:0, tktP=P.ped?P.fat/P.ped:0;
  const fatMedN=len?N.fat/len:0, fatMedP=len?P.fat/len:0;
  const desPercN=N.fat?N.des/N.fat:0, desPercP=P.fat?P.des/P.fat:0;
  const freMedN=N.ped?N.fre/N.ped:0, freMedP=P.ped?P.fre/P.ped:0;
  const partCancN=N.ped?CN.ped/N.ped:0, partCancP=P.ped?CP.ped/P.ped:0;
  $('k_ped').textContent=num(N.ped);$('p_ped').textContent=num(P.ped);deltaBadge($('d_ped'),N.ped,P.ped);
  $('k_tkt').textContent=money(tktN);$('p_tkt').textContent=money(tktP);deltaBadge($('d_tkt'),tktN,tktP);
  $('k_fat').textContent=money(N.fat);$('p_fat').textContent=money(P.fat);deltaBadge($('d_fat'),N.fat,P.fat);
  $('k_fatmed').textContent=money(fatMedN);$('p_fatmed').textContent=money(fatMedP);deltaBadge($('d_fatmed'),fatMedN,fatMedP);
  $('k_des').textContent=money(N.des);$('p_des').textContent=money(P.des);deltaBadge($('d_des'),N.des,P.des);
  $('k_desperc').textContent=pctf(desPercN);$('p_desperc').textContent=pctf(desPercP);deltaBadge($('d_desperc'),desPercN,desPercP);
  $('k_fre').textContent=money(N.fre);$('p_fre').textContent=money(P.fre);deltaBadge($('d_fre'),N.fre,P.fre);
  $('k_fremed').textContent=money(freMedN);$('p_fremed').textContent=money(freMedP);deltaBadge($('d_fremed'),freMedN,freMedP);
  $('k_canc_ped').textContent=num(CN.ped);deltaBadge($('d_canc_ped'),CN.ped,CP.ped);
  $('k_canc_val').textContent=money(CN.fat);$('p_canc_val').textContent=money(CP.fat);deltaBadge($('d_canc_val'),CN.fat,CP.fat);
  $('k_canc_part').textContent=pctf(partCancN);$('p_canc_part').textContent=pctf(partCancP);
  const roiN=N.des>0?(N.fat-N.des)/N.des:NaN, roiP=P.des>0?(P.fat-P.des)/P.des:NaN;
  $('k_roi').textContent=Number.isFinite(roiN)?pctf(roiN):'—';$('p_roi').textContent=Number.isFinite(roiP)?pctf(roiP):'—';deltaBadge($('d_roi'),Number.isFinite(roiN)?roiN:0,Number.isFinite(roiP)?roiP:0);
}

/* ====== SCHEMA DINÂMICO para REST ====== */
let SCHEMA=null;
async function ensureSchema(){
  if(SCHEMA) return SCHEMA;
  const {data,error}=await supa.from(READ_VIEW).select('*').limit(1);
  const cols=(error||!data||!data.length)?[]:Object.keys(data[0]);
  const pick=(...names)=>names.find(n=>cols.includes(n))||null;
  SCHEMA={
    dateCol:pick('dia','data','dt','date','data_venda','data_pedido','datahora'),
    hourCol:pick('hora','hr','hour','horario','time_hour','hora_venda'),
    turnoCol:pick('turno','periodo','shift'),
    fatCol:pick('fat','faturamento','valor_total','valor','total','vl_total','vlr_total','valor_liquido','faturamento_liquido','fat_liq','fat_total','vl_faturamento','vl_liquido','valor_venda','vl_venda','total_nota'),
    desCol:pick('des','desconto','incentivo','incentivos','vl_desconto'),
    freCol:pick('fre','frete','taxa_entrega','taxa','entrega'),
    pedidosCol:pick('pedidos','qtd_pedidos','qtde','qtd','quantidade','qtd_pedido','qtd_vendas'),
    pedidoIdCol:pick('pedido_id','id_pedido','numero_pedido','order_id'),
    canceladoCol:pick('cancelado','st_cancelado','cancelada','canceled','is_cancel'),
    lojaCol:pick('loja','nome_loja','loja_nome','loja_fantasia','nome da loja'),
    unidadeCol:pick('unidade','filial','empresa','cod_unidade'),
    canalCol:pick('canal','canal_venda','origem'),
    pagamentoCol:pick('pagamento_base','tipo_pagamento','forma_pagamento','meio_pgto','meio_pagamento')
  };
  return SCHEMA;
}
function parseHour(h){if(h==null)return null;if(typeof h==='number')return Math.max(0,Math.min(23,Math.floor(h)));const m=String(h).match(/(\d{1,2})/);if(!m)return null;const hh=+m[1];return (hh>=0&&hh<=23)?hh:null;}
function normRow(r){const s=SCHEMA;return {
  dia: s.dateCol? r[s.dateCol] : null,
  hora: s.hourCol? parseHour(r[s.hourCol]) : null,
  turno: s.turnoCol? r[s.turnoCol] : null,
  fat: s.fatCol? (+r[s.fatCol]||0) : 0,
  des: s.desCol? (+r[s.desCol]||0) : 0,
  fre: s.freCol? (+r[s.freCol]||0) : 0,
  pedidos: s.pedidosCol? (+r[s.pedidosCol]||0) : null,
  pedido_id: s.pedidoIdCol? (r[s.pedidoIdCol]==null?null:String(r[s.pedidoIdCol])) : null,
  cancelado: s.canceladoCol? (r[s.canceladoCol]==null?null:String(r[s.canceladoCol])) : null,
  loja: s.lojaCol? String(r[s.lojaCol]) : '—',
  unidade: s.unidadeCol? (r[s.unidadeCol]==null?null:String(r[s.unidadeCol])) : null,
  canal: s.canalCol? (r[s.canalCol]==null?null:String(r[s.canalCol])) : null,
  pagamento_base: s.pagamentoCol? (r[s.pagamentoCol]==null?null:String(r[s.pagamentoCol])) : null,
};}

/* ====== REST base (normaliza campos) ====== */
async function baseQuery(de,ate,forcedCancel=null){
  await ensureSchema(); const s=SCHEMA;
  const sel = [s.dateCol,s.hourCol,s.turnoCol,s.fatCol,s.desCol,s.freCol,s.pedidosCol,s.pedidoIdCol,s.canceladoCol,s.lojaCol,s.unidadeCol,s.canalCol,s.pagamentoCol].filter(Boolean).join(',');
  let q=supa.from(READ_VIEW).select(sel).gte(s.dateCol,de).lte(s.dateCol,ate).order(s.dateCol,{ascending:true}).range(0,199999);
  const unids=ms.unids.get(); if(unids.length && s.unidadeCol) q=q.in(s.unidadeCol,unids);
  const lojas=ms.lojas.get(); if(lojas.length && s.lojaCol)   q=q.in(s.lojaCol,lojas);
  const turns=ms.turnos.get(); if(turns.length && s.turnoCol) q=q.in(s.turnoCol,turns);
  const cans =ms.canais.get(); if(cans.length && s.canalCol)  q=q.in(s.canalCol,cans);
  const pags =ms.pags.get();   if(pags.length && s.pagamentoCol) q=q.in(s.pagamentoCol,pags);
  const canc = forcedCancel ? [forcedCancel] : ms.cancel.get();
  if(s.canceladoCol && canc.length===1 && (canc[0]==='Sim'||canc[0]==='Não')) q=q.eq(s.canceladoCol,canc[0]);
  else if(s.canceladoCol && canc.length>1) q=q.in(s.canceladoCol,canc);
  const {data,error}=await q;
  if(error){console.error('[REST baseQuery]',error);throw error;}
  return (data||[]).map(normRow);
}

/* ====== BUCKET/AGREGAÇÃO ====== */
function bucketKey(type,row){
  if(type==='dow'){return (new Date(row.dia+'T00:00:00')).getDay();}
  if(type==='hour'){return row.hora ?? null;}
  if(type==='turno'){return row.turno ?? null;}
  if(type==='month'){const d=new Date(row.dia+'T00:00:00');return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
  return null;
}
function computeByBucket(rows,type,metric,mode){
  const map=new Map(), daySetByKey=new Map();
  rows.forEach(r=>{
    const key=bucketKey(type,r); if(key==null) return;
    if(!map.has(key)) map.set(key,{fat:0,des:0,fre:0,rowCount:0,pedSoma:0,orderIds:new Set(),days:0});
    const acc=map.get(key);
    acc.fat+=+r.fat||0; acc.des+=+r.des||0; acc.fre+=+r.fre||0; acc.rowCount++;
    if(r.pedidos!=null) acc.pedSoma+= +r.pedidos || 0;
    if(r.pedido_id!=null) acc.orderIds.add(r.pedido_id);
    if(!daySetByKey.has(key)) daySetByKey.set(key,new Set());
    daySetByKey.get(key).add(r.dia);
  });
  const keys=[...map.keys()].sort((a,b)=> (type==='dow'||type==='hour')? a-b : String(a).localeCompare(String(b),'pt-BR'));
  return keys.map(k=>{
    const a=map.get(k); a.days=(daySetByKey.get(k)?.size)||1;
    const pedBase = a.pedSoma>0 ? a.pedSoma : (a.orderIds.size>0 ? a.orderIds.size : a.rowCount);
    function val(){
      switch(metric){
        case 'fat':     return mode==='media'? a.fat/Math.max(1,a.days) : a.fat;
        case 'ped':     return mode==='media'? pedBase/Math.max(1,a.days) : pedBase;
        case 'tkt':     return pedBase>0? a.fat/pedBase : 0;
        case 'des':     return mode==='media'? a.des/Math.max(1,a.days) : a.des;
        case 'desperc': return a.fat>0? a.des/a.fat : 0;
        case 'fre':     return mode==='media'? a.fre/Math.max(1,a.days) : a.fre;
        case 'fremed':  return pedBase>0? a.fre/pedBase : 0;
        case 'fatmed':  return a.fat/Math.max(1,a.days);
        case 'roi':     return a.des>0? ((a.fat-a.des)/a.des) : 0;
        default:        return a.fat;
      }
    }
    return {key:k,value:val()};
  });
}

/* ====== GRÁFICOS ====== */
let chartModeGlobal='total';
document.getElementById('segGlobal').addEventListener('click',(e)=>{const btn=e.target.closest('.seg-btn');if(!btn)return;chartModeGlobal=btn.dataset.mode;document.querySelectorAll('#segGlobal .seg-btn').forEach(b=>b.classList.toggle('active',b===btn));updateMonth12x12();updateChartsServer();updateTop6();});
function formatCurrencyTick(v){const n=Number(v)||0;if(Math.abs(n)>=1_000_000)return'R$ '+(n/1_000_000).toFixed(1).replace('.',',')+' mi';if(Math.abs(n)>=1_000)return'R$ '+(n/1_000).toFixed(1).replace('.',',')+' mil';return'R$ '+n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,'.');}
function formatTickBy(fmt,v){if(fmt==='count')return (Number(v)||0).toLocaleString('pt-BR'); if(fmt==='percent'){const n=Number(v)||0;return (n*100).toFixed(0)+'%';} return formatCurrencyTick(v);}
function formatValueBy(fmt,v){if(fmt==='count')return (Number(v)||0).toLocaleString('pt-BR'); if(fmt==='percent'){const n=Number(v)||0;return (n*100).toFixed(1)+'%';} return money(v);}
function ensureChart(canvasId, labels, nowArr, prevArr, tooltipExtra='', fmt='money'){
  const canvas=$(canvasId); if(!canvas) return; if(canvas.__chart){try{canvas.__chart.destroy();}catch{} canvas.__chart=null;}
  const ctx=canvas.getContext('2d');
  canvas.__chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Atual',data:nowArr.map(v=>+v||0),backgroundColor:gradNow(ctx)},{label:'Anterior',data:prevArr.map(v=>+v||0),backgroundColor:gradPrev(ctx)}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{x:{grid:{display:false}},y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'},ticks:{callback:v=>formatTickBy(fmt,v)}}},plugins:{legend:{position:'top'},tooltip:{mode:'index',intersect:false,callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${formatValueBy(fmt, ctx.parsed.y||0)}`,footer:()=>tooltipExtra}}}});}

/* ====== RPC para dow/hour/turno quando possível ====== */
const RPC_FN={dow:'chart_vendas_dow_v1',month:'chart_vendas_mes_v1',hour:'chart_vendas_hora_v1',turno:'chart_vendas_turno_v1'};
async function fetchChartRPC(kind,de,ate){
  const params={p_dini:de,p_dfim:ate,p_unids:ms.unids.get().length?ms.unids.get():null,p_lojas:ms.lojas.get().length?ms.lojas.get():null,p_turnos:ms.turnos.get().length?ms.turnos.get():null,p_canais:ms.canais.get().length?ms.canais.get():null,p_pags:ms.pags.get().length?ms.pags.get():null,p_cancelado:(ms.cancel.get().length===1&&(ms.cancel.get()[0]==='Sim'||ms.cancel.get()[0]==='Não'))?ms.cancel.get()[0]:null};
  const {data,error}=await supa.rpc(RPC_FN[kind],params); if(error) throw error; return data||[];
}

/* ====== updateChartsServer: usa RPC só para 'fat' sem override; caso contrário usa REST normalizado ====== */
async function updateChartsServer(){
  const de=fDe.value||firstDay, ate=fAte.value||lastDay;
  const {dePrev,atePrev}=computePrevRangeISO(de,ate);
  const meta=KPI_META[selectedKPI]||KPI_META.fat; const mode=effectiveMode();
  const forcedCancel = KPI_META[selectedKPI]?.needsCancel||null;
  const useRPC = (selectedKPI==='fat' && !forcedCancel);
  const tip=`Período anterior: ${dePrev} → ${atePrev}`;

  try{
    if(useRPC){
      const [nowD,prevD,nowH,prevH,nowT,prevT]=await Promise.all([fetchChartRPC('dow',de,ate),fetchChartRPC('dow',dePrev,atePrev),fetchChartRPC('hour',de,ate),fetchChartRPC('hour',dePrev,atePrev),fetchChartRPC('turno',de,ate),fetchChartRPC('turno',dePrev,atePrev)]);
      // DOW
      {const labels=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];const nArr=Array(7).fill(0),pArr=Array(7).fill(0),nMed=Array(7).fill(0),pMed=Array(7).fill(0);nowD.forEach(r=>{nArr[r.dow]=+r.total||0;nMed[r.dow]=+r.media||0;});prevD.forEach(r=>{pArr[r.dow]=+r.total||0;pMed[r.dow]=+r.media||0;});ensureChart('ch_dow',labels,mode==='media'?nMed:nArr,mode==='media'?pMed:pArr,tip,meta.fmt);}
      // HOUR
      {const all=[...Array(24)].map((_,h)=>h);const nArr=Array(24).fill(0),pArr=Array(24).fill(0),nMed=Array(24).fill(0),pMed=Array(24).fill(0);nowH.forEach(r=>{nArr[r.h]=+r.total||0;nMed[r.h]=+r.media||0;});prevH.forEach(r=>{pArr[r.h]=+r.total||0;pMed[r.h]=+r.media||0;});const useN=mode==='media'?nMed:nArr, useP=mode==='media'?pMed:pArr;const hours=all.filter(h=>useN[h]||useP[h]);ensureChart('ch_hour',hours.map(h=>String(h).padStart(2,'0')+'h'),hours.map(h=>useN[h]||0),hours.map(h=>useP[h]||0),tip,meta.fmt);}
      // TURNO
      {const order=['Dia','Noite'];const n=new Map(nowT.map(r=>[r.turno,mode==='media'?(+r.media||0):(+r.total||0)]));const p=new Map(prevT.map(r=>[r.turno,mode==='media'?(+r.media||0):(+r.total||0)]));const labels=order.filter(x=>n.has(x)||p.has(x));ensureChart('ch_turno',labels,labels.map(l=>n.get(l)||0),labels.map(l=>p.get(l)||0),tip,meta.fmt);}
    }else{
      const [rowsNow,rowsPrev]=await Promise.all([baseQuery(de,ate,forcedCancel),baseQuery(dePrev,atePrev,forcedCancel)]);
      // DOW
      {const lab=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];const cur=computeByBucket(rowsNow,'dow',selectedKPI,mode),prv=computeByBucket(rowsPrev,'dow',selectedKPI,mode);const nArr=Array(7).fill(0),pArr=Array(7).fill(0);cur.forEach(o=>nArr[o.key]=o.value);prv.forEach(o=>pArr[o.key]=o.value);ensureChart('ch_dow',lab,nArr,pArr,tip,meta.fmt);}
      // HOUR
      {const all=[...Array(24)].map((_,h)=>h);const cur=computeByBucket(rowsNow,'hour',selectedKPI,mode),prv=computeByBucket(rowsPrev,'hour',selectedKPI,mode);const mN=new Map(cur.map(o=>[o.key,o.value])), mP=new Map(prv.map(o=>[o.key,o.value]));const hours=all.filter(h=>mN.has(h)||mP.has(h));ensureChart('ch_hour',hours.map(h=>String(h).padStart(2,'0')+'h'),hours.map(h=>mN.get(h)||0),hours.map(h=>mP.get(h)||0),tip,meta.fmt);}
      // TURNO
      {const ord=['Dia','Noite'];const cur=computeByBucket(rowsNow,'turno',selectedKPI,mode),prv=computeByBucket(rowsPrev,'turno',selectedKPI,mode);const mN=new Map(cur.map(o=>[o.key,o.value])), mP=new Map(prv.map(o=>[o.key,o.value]));const labels=ord.filter(k=>mN.has(k)||mP.has(k));ensureChart('ch_turno',labels,labels.map(k=>mN.get(k)||0),labels.map(k=>mP.get(k)||0),tip,meta.fmt);}
    }
    setStatus('OK — gráficos atualizados','ok');
  }catch(e){console.error(e);setStatus('OK (sem gráficos — REST/RPC indisponível)','ok');}
}

/* ====== MÊS 12×12 ====== */
async function updateMonth12x12(){
  try{
    const end=lastDay||iso(new Date());const endStart=monthStartISO(end);
    const last12Start=addMonthsISO(endStart,-11), prev12Start=addMonthsISO(endStart,-23);
    const last12End=monthEndISO(end), prev12End=monthEndISO(addMonthsISO(endStart,-12));
    const meta=KPI_META[selectedKPI]||KPI_META.fat; const mode=effectiveMode();
    const forcedCancel=KPI_META[selectedKPI]?.needsCancel||null;
    const useRPC=(selectedKPI==='fat' && !forcedCancel);
    const labels=[];let cur=last12Start;for(let i=0;i<12;i++){labels.push(formatYM(cur));cur=addMonthsISO(cur,1);}
    if(useRPC){
      const common={p_unids:ms.unids.get().length?ms.unids.get():null,p_lojas:ms.lojas.get().length?ms.lojas.get():null,p_turnos:ms.turnos.get().length?ms.turnos.get():null,p_canais:ms.canais.get().length?ms.canais.get():null,p_pags:ms.pags.get().length?ms.pags.get():null,p_cancelado:(ms.cancel.get().length===1&&(ms.cancel.get()[0]==='Sim'||ms.cancel.get()[0]==='Não'))?ms.cancel.get()[0]:null};
      const [{data:nData,error:nErr},{data:pData,error:pErr}]=await Promise.all([supa.rpc('chart_vendas_mes_v1',{p_dini:last12Start,p_dfim:last12End,...common}),supa.rpc('chart_vendas_mes_v1',{p_dini:prev12Start,p_dfim:prev12End,...common})]); if(nErr)throw nErr;if(pErr)throw pErr;
      const toMap=arr=>new Map((arr||[]).map(r=>[r.ym,mode==='media'?(+r.media||0):(+r.total||0)]));
      const mNow=toMap(nData), mPrev=toMap(pData);
      const ymsNow=[];cur=last12Start;for(let i=0;i<12;i++){const d=new Date(cur+'T00:00:00');ymsNow.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);cur=addMonthsISO(cur,1);}
      const ymsPrev=ymsNow.map(ym=>{const [yy,mm]=ym.split('-').map(Number);const p=new Date(yy,mm-1-12,1);return `${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,'0')}`;});
      ensureChart('ch_month',labels,ymsNow.map(ym=>mNow.get(ym)||0),ymsPrev.map(ym=>mPrev.get(ym)||0),`Comparação fixa: ${formatYM(last12Start)}→${formatYM(endStart)} vs ${formatYM(prev12Start)}→${formatYM(addMonthsISO(endStart,-1))}`,meta.fmt);
    }else{
      const [rowsNow,rowsPrev]=await Promise.all([baseQuery(last12Start,last12End,forcedCancel),baseQuery(prev12Start,prev12End,forcedCancel)]);
      const curNow=computeByBucket(rowsNow,'month',selectedKPI,mode), curPrv=computeByBucket(rowsPrev,'month',selectedKPI,mode);
      const mNow=new Map(curNow.map(o=>[o.key,o.value])), mPrev=new Map(curPrv.map(o=>[o.key,o.value]));
      const ymsNow=[];cur=last12Start;for(let i=0;i<12;i++){const d=new Date(cur+'T00:00:00');ymsNow.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);cur=addMonthsISO(cur,1);}
      const ymsPrev=ymsNow.map(ym=>{const [yy,mm]=ym.split('-').map(Number);const p=new Date(yy,mm-1-12,1);return `${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,'0')}`;});
      ensureChart('ch_month',labels,ymsNow.map(ym=>mNow.get(ym)||0),ymsPrev.map(ym=>mPrev.get(ym)||0),`Comparação fixa: ${formatYM(last12Start)}→${formatYM(endStart)} vs ${formatYM(prev12Start)}→${formatYM(addMonthsISO(endStart,-1))}`,meta.fmt);
    }
    setStatus('OK — gráfico mensal 12x12','ok');
  }catch(e){console.error(e);setStatus('OK (mensal 12x12 indisponível)','ok');}
}

/* ====== TOP 6 LOJAS ====== */
const wine=["#7b1e3a","#8c2947","#9c3554","#ad4061","#bd4c6e","#ce577b"];
function ensureDonutTop6(labels,values,centerText,fmt='money'){
  const cvs=$('ch_top6');if(!cvs)return; if(cvs.__chart){try{cvs.__chart.destroy();}catch{} cvs.__chart=null;}
  const ctx=cvs.getContext('2d'); const total=(values||[]).reduce((a,b)=>a+(+b||0),0);
  $('top6Center').textContent = centerText!=null ? centerText : 'Total: '+(fmt==='money'? money(total) : fmt==='count'? num(total) : formatValueBy(fmt,total));
  cvs.__chart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:wine,hoverBackgroundColor:wine,borderColor:'#fff',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'right',labels:{usePointStyle:true,pointStyle:'circle',boxWidth:10,padding:16,color:'#334155'}},tooltip:{callbacks:{label:(ctx)=>{const label=ctx.label||'';const val=ctx.parsed||0;const ds=ctx.chart.data.datasets[0];const tt=(ds.data||[]).reduce((a,b)=>a+(+b||0),0);const perc=tt?((val/tt)*100).toFixed(1):0;return `${label}: ${formatValueBy(KPI_META[selectedKPI]?.fmt||'money',val)} (${perc}%)`;}}}}});
}
async function updateTop6(){
  try{
    await ensureSchema(); const s=SCHEMA;
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    const fmt=(KPI_META[selectedKPI]||KPI_META.fat).fmt;
    const forcedCancel=KPI_META[selectedKPI]?.needsCancel||null;
    const sel=[s.lojaCol,s.fatCol,s.desCol,s.freCol,s.pedidosCol,s.pedidoIdCol,s.canceladoCol,s.dateCol].filter(Boolean).join(',');
    let q=supa.from(READ_VIEW).select(sel).gte(s.dateCol,de).lte(s.dateCol,ate).order(s.lojaCol||s.dateCol,{ascending:true}).range(0,119999);
    const u=ms.unids.get(); if(u.length&&s.unidadeCol) q=q.in(s.unidadeCol,u);
    const l=ms.lojas.get(); if(l.length&&s.lojaCol) q=q.in(s.lojaCol,l);
    const t=ms.turnos.get(); if(t.length&&s.turnoCol) q=q.in(s.turnoCol,t);
    const c=ms.canais.get(); if(c.length&&s.canalCol) q=q.in(s.canalCol,c);
    const p=ms.pags.get();   if(p.length&&s.pagamentoCol) q=q.in(s.pagamentoCol,p);
    const canc = forcedCancel ? [forcedCancel] : ms.cancel.get();
    if(s.canceladoCol && canc.length===1 && (canc[0]==='Sim'||canc[0]==='Não')) q=q.eq(s.canceladoCol,canc[0]); else if(s.canceladoCol && canc.length>1) q=q.in(s.canceladoCol,canc);
    const {data,error}=await q; if(error) throw error;
    const rows=(data||[]).map(normRow);
    const m=new Map();
    rows.forEach(r=>{
      const k=r.loja||'—'; if(!m.has(k)) m.set(k,{fat:0,des:0,fre:0,rowCount:0,pedSoma:0,orderIds:new Set(),days:new Set()});
      const a=m.get(k); a.fat+=+r.fat||0; a.des+=+r.des||0; a.fre+=+r.fre||0; a.rowCount++; if(r.pedidos!=null) a.pedSoma+= +r.pedidos||0; if(r.pedido_id!=null) a.orderIds.add(r.pedido_id); a.days.add(r.dia);
    });
    function metricVal(a){
      const days=a.days.size||1; const pedBase=a.pedSoma>0?a.pedSoma:(a.orderIds.size>0?a.orderIds.size:a.rowCount);
      switch(selectedKPI){
        case 'fat':     return effectiveMode()==='media'? a.fat/days : a.fat;
        case 'ped':     return effectiveMode()==='media'? pedBase/days : pedBase;
        case 'tkt':     return pedBase>0? a.fat/pedBase : 0;
        case 'des':     return effectiveMode()==='media'? a.des/days : a.des;
        case 'desperc': return a.fat>0? a.des/a.fat : 0;
        case 'fre':     return effectiveMode()==='media'? a.fre/days : a.fre;
        case 'fremed':  return pedBase>0? a.fre/pedBase : 0;
        case 'fatmed':  return a.fat/days;
        case 'roi':     return a.des>0? ((a.fat-a.des)/a.des) : 0;
        default:        return a.fat;
      }
    }
    const arr=[...m.entries()].map(([loja,a])=>[loja,metricVal(a)]).sort((A,B)=>B[1]-A[1]).slice(0,6);
    ensureDonutTop6(arr.map(a=>a[0]),arr.map(a=>a[1]),null,fmt);
    setStatus('OK — Top 6','ok');
  }catch(e){console.warn('top6 erro:',e);ensureDonutTop6([],[],'Total: R$ 0,00','money');}
}

/* ====== Comparativo de período ====== */
function lastDayOfMonth(y,m){return new Date(y,m+1,0).getDate();}
function isFullYear(d1,d2){return d1.getMonth()===0&&d1.getDate()===1&&d2.getMonth()===11&&d2.getDate()===31&&d1.getFullYear()===d2.getFullYear();}
function isFullMonthsAligned(d1,d2){return d1.getDate()===1&&d2.getDate()=== lastDayOfMonth(d2.getFullYear(),d2.getMonth());}
function shiftYear(date,delta){const d=new Date(date);d.setFullYear(d.getFullYear()+delta);const ld=lastDayOfMonth(d.getFullYear(),d.getMonth());if(d.getDate()>ld)d.setDate(ld);return d;}
function computePrevRangeISO(deISO,ateISO){const d1=new Date(deISO+'T00:00:00'),d2=new Date(ateISO+'T00:00:00');if(isFullYear(d1,d2)||isFullMonthsAligned(d1,d2)){const p1=shiftYear(d1,-1),p2=shiftYear(d2,-1);return {dePrev:iso(p1),atePrev:iso(p2)};}const len=daysLen(deISO,ateISO);const atePrev=new Date(d1.getTime()-86400000);const dePrev=new Date(atePrev.getTime()-(len-1)*86400000);return {dePrev:iso(dePrev),atePrev:iso(atePrev)};}

/* ====== Init / Loop ====== */
function updateChartTitlesAndBind(){updateChartTitles();bindKPIClick();}
async function reloadStaticOptions(){
  // simples: pega listas distintas pré-calculadas (ajuste se não existir)
  try{
    const [u,l,c,p]=await Promise.allSettled([
      supa.from('vw_vendas_unidades').select('unidade').order('unidade'),
      supa.from('vw_vendas_lojas').select('loja').order('loja'),
      supa.from('vw_vendas_canais').select('canal').order('canal'),
      supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
    ]);
    const ok=r=>r.status==='fulfilled'&&!r.value.error&&Array.isArray(r.value.data);
    ms.unids.setOptions(ok(u)?u.value.data.map(r=>r.unidade).filter(Boolean):[]);
    ms.lojas.setOptions(ok(l)?l.value.data.map(r=>r.loja).filter(Boolean):[]);
    ms.canais.setOptions(ok(c)?c.value.data.map(r=>r.canal).filter(Boolean):[]);
    ms.pags.setOptions(ok(p)?p.value.data.map(r=>r.pagamento_base).filter(Boolean):[]);
    ms.turnos.setOptions(['Dia','Noite'],true);
  }catch{}
}
async function applyAll(){
  try{
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    const {dePrev,atePrev}=computePrevRangeISO(de,ate);
    setStatus('Consultando…');
    let kpiOk=true; await updateKPIs(de,ate,dePrev,atePrev).catch(e=>{console.error(e);kpiOk=false;});
    await Promise.all([updateChartsServer(),updateMonth12x12(),updateTop6()]);
    if(!kpiOk) setStatus('OK (sem KPIs — RPC indisponível)'); else setStatus('OK','ok');
  }catch(e){console.error(e);setStatus('Erro: '+(e.message||e),'err');}
}
document.getElementById('top6Center').addEventListener('click',()=>setStatus('Top 6 — total clicado','ok'));

(async function init(){
  try{
    setStatus('Carregando…');
    // Range inicial
    try{const dr=await supa.from('vw_vendas_daterange').select('*').limit(1);if(!dr.error&&dr.data?.length){firstDay=dr.data[0].min_dia;lastDay=dr.data[0].max_dia;}}catch{}
    await ensureSchema();         // >>> carrega schema real
    await reloadStaticOptions();
    ms.cancel.setOptions(['','Não','Sim']); ms.cancel.set(['Não']);
    $('periodoInfo').textContent=`Último dia carregado: ${lastDay}`;
    updateChartTitlesAndBind();
    applyQuick('30');
  }catch(e){console.error(e);setStatus('Erro ao iniciar: '+(e.message||e),'err');}
})();
</script>
</body>
</html>
