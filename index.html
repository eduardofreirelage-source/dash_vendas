<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Uploader Vendas + Smoke Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS (CDN). Se falhar, coloque xlsx.full.min.js ao lado deste HTML -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"
          onerror="console.warn('CDN SheetJS falhou. Coloque xlsx.full.min.js no mesmo diretório.');"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; }
    h1 { margin-bottom: 8px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    legend { padding: 0 6px; color: #444; }
    label { display:block; font-size: 12px; color: #555; margin-top: 6px; }
    select, input[type="text"], input[type="date"], button { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .col { min-width: 200px; flex: 1; }
    #log { white-space: pre-wrap; background:#0b1220; color:#d7e1ff; padding:12px; border-radius:8px; max-height: 300px; overflow:auto; }
    .ok { color: #0a0; }
    .warn { color: #a60; }
    .err { color: #c00; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; margin-right:6px; font-size:12px; }
    .btn { background:#0b5; color:#fff; border:none; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-secondary { background:#456; }
  </style>
</head>
<body>
  <h1>Uploader & Debug (Supabase)</h1>

  <fieldset>
    <legend>Supabase</legend>
    <div class="row">
      <div class="col">
        <label>URL</label>
        <input id="url" type="text" value="https://uahmcfzerofhzjvlzrqc.supabase.co" />
      </div>
      <div class="col">
        <label>Anon key</label>
        <input id="key" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" />
      </div>
      <div class="col" style="align-self:end">
        <button id="btnPing" class="btn">Testar conexão</button>
      </div>
    </div>
    <div id="connBadge"></div>
  </fieldset>

  <fieldset>
    <legend>Upload Excel</legend>
    <div class="row">
      <div class="col">
        <input id="file" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="col">
        <button id="btnRead" class="btn">Ler arquivo</button>
      </div>
      <div class="col">
        <span id="fileInfo" class="pill"></span>
      </div>
    </div>

    <div class="row">
      <div class="col"><label>Coluna com Data+Hora (opcional)</label><select id="m_datahora"></select></div>
      <div class="col"><label>Data (yyyy-mm-dd)</label><select id="m_data_venda"></select></div>
      <div class="col"><label>Hora (0–23)</label><select id="m_hora"></select></div>
      <div class="col"><label>Unidade</label><select id="m_unidade"></select></div>
      <div class="col"><label><b>Loja</b></label><select id="m_loja"></select></div>
      <div class="col"><label>Canal</label><select id="m_canal"></select></div>
      <div class="col"><label>Cancelado (Sim/Não/true/false)</label><select id="m_cancelado"></select></div>
      <div class="col"><label>Itens</label><select id="m_itens"></select></div>
      <div class="col"><label>Total</label><select id="m_total"></select></div>
      <div class="col"><label>Desconto</label><select id="m_des"></select></div>
      <div class="col"><label>Frete</label><select id="m_fre"></select></div>
      <div class="col"><label>Turno</label><select id="m_turno"></select></div>
      <div class="col"><label>Pagamento</label><select id="m_pagamento"></select></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><button id="btnPreview" class="btn btn-secondary">Validar & Prévia (5 linhas)</button></div>
      <div class="col"><button id="btnInsert" class="btn">Inserir no banco (lotes de 2.000)</button></div>
      <div class="col"><span id="insInfo" class="pill"></span></div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Smoke tests</legend>
    <div class="row">
      <div class="col"><label>Data inicial</label><input type="date" id="dini" /></div>
      <div class="col"><label>Data final</label><input type="date" id="dfim" /></div>
      <div class="col" style="align-self:end"><button id="btnAutoRange" class="btn btn-secondary">Usar min/max da view</button></div>
      <div class="col" style="align-self:end"><button id="btnSmoke" class="btn">Rodar smoke test</button></div>
    </div>
    <div id="smk" class="pill"></div>
  </fieldset>

  <fieldset>
    <legend>Debug</legend>
    <pre id="log"></pre>
  </fieldset>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const $ = (sel) => document.querySelector(sel);
  const log = (...a) => { const el = $("#log"); el.textContent += a.map(x => typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + "\\n"; el.scrollTop = el.scrollHeight; };
  const setPill = (id, txt, cls='') => { const el = $(id); el.textContent = txt || ''; el.className = 'pill ' + cls; };

  let SUPA = null;
  let XLS = window.XLSX;
  let rows = [];        // linhas cruas do Excel
  let mapped = [];      // linhas mapeadas p/ inserção

  const selects = ["m_datahora","m_data_venda","m_hora","m_unidade","m_loja","m_canal","m_cancelado","m_itens","m_total","m_des","m_fre","m_turno","m_pagamento"];

  // Helpers -------------------------------------------------------
  function parseDateLike(v) {
    // suporta: Excel serial, 'dd/mm/aaaa hh:mm', 'aaaa-mm-dd hh:mm', 'aaaa-mm-dd', etc.
    if (v == null || v === '') return { d:null, h:null };
    if (typeof v === 'number') {
      // Excel serial
      const epoch = new Date(Date.UTC(1899, 11, 30));
      const ms = v * 24 * 3600 * 1000;
      const dt = new Date(epoch.getTime() + ms);
      return { d: dt.toISOString().slice(0,10), h: dt.getUTCHours() };
    }
    const s = String(v).trim().replace('T',' ');
    // tenta yyyy-mm-dd hh:mm[:ss]
    let m = s.match(/^(\\d{4})[-\\/](\\d{2})[-\\/](\\d{2})(?:\\s+(\\d{1,2})(?::(\\d{2}))?)?/);
    if (m) {
      const [_,Y,M,D,H] = m;
      return { d: \`\${Y}-\${M}-\${D}\`, h: H!=null? parseInt(H,10): null };
    }
    // tenta dd/mm/yyyy hh:mm
    m = s.match(/^(\\d{2})[-\\/](\\d{2})[-\\/](\\d{4})(?:\\s+(\\d{1,2})(?::(\\d{2}))?)?/);
    if (m) {
      const [_,D,M,Y,H] = m;
      return { d: \`\${Y}-\${M}-\${D}\`, h: H!=null? parseInt(H,10): null };
    }
    // só hora?
    m = s.match(/^(\\d{1,2})[:h](\\d{2})?/i);
    if (m) return { d:null, h: parseInt(m[1],10) };
    return { d:null, h:null };
  }

  function toBoolVal(v) {
    if (typeof v === 'boolean') return v;
    const s = String(v||'').trim().toLowerCase();
    if (['sim','s','true','1','yes','y'].includes(s)) return true;
    if (['não','nao','n','false','0','no'].includes(s)) return false;
    return false;
  }

  function toNumber(v) {
    if (v == null || v === '') return 0;
    if (typeof v === 'number') return v;
    const s = String(v).trim().replace(/\./g,'').replace(',','.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function fillSelectOptions(cols) {
    for (const id of selects) {
      const sel = $("#"+id);
      sel.innerHTML = '<option value="">-- (vazio) --</option>' + cols.map(c=>\`<option>\${c}</option>\`).join('');
    }
    // sugestões padrão:
    setIfExists("#m_datahora", ["datahora","data e hora","data hora"]);
    setIfExists("#m_data_venda", ["data_venda","data"]);
    setIfExists("#m_hora", ["hora"]);
    setIfExists("#m_unidade", ["unidade"]);
    setIfExists("#m_loja", ["loja","nome da loja"]);
    setIfExists("#m_canal", ["canal","canal de venda"]);
    setIfExists("#m_cancelado", ["cancelado","está cancelado"]);
    setIfExists("#m_itens", ["itens","pedidos"]);
    setIfExists("#m_total", ["total","fat"]);
    setIfExists("#m_des", ["des","desconto"]);
    setIfExists("#m_fre", ["fre","entrega","frete"]);
    setIfExists("#m_turno", ["turno"]);
    setIfExists("#m_pagamento", ["pagamento","pagamento_base"]);
  }
  function setIfExists(sel, candidates){
    const el = $(sel);
    const opts = [...el.options].map(o => o.value.toLowerCase());
    for (const c of candidates) {
      const idx = opts.indexOf(c);
      if (idx >= 0) { el.selectedIndex = idx+1; break; }
    }
  }

  function getMap() {
    const g = o => { const v=$("#"+o).value; return v===''?null:v; };
    return {
      datahora: g('m_datahora'),
      data_venda: g('m_data_venda'),
      hora: g('m_hora'),
      unidade: g('m_unidade'),
      loja: g('m_loja'),
      canal: g('m_canal'),
      cancelado: g('m_cancelado'),
      itens: g('m_itens'),
      total: g('m_total'),
      des: g('m_des'),
      fre: g('m_fre'),
      turno: g('m_turno'),
      pagamento: g('m_pagamento'),
    };
  }

  function mapRows(raw, map) {
    const out = [];
    for (const r of raw) {
      // data/hora
      let d=null, h=null;
      if (map.datahora && r[map.datahora]!=null) {
        const x = parseDateLike(r[map.datahora]);
        d = x.d; h = x.h;
      }
      if (!d && map.data_venda && r[map.data_venda]!=null) {
        d = parseDateLike(r[map.data_venda]).d;
      }
      if (h==null && map.hora && r[map.hora]!=null) {
        const hh = parseDateLike(r[map.hora]);
        h = hh.h != null ? hh.h : toNumber(r[map.hora]);
      }

      const rec = {
        data_venda: d,                                   // <- usado pela view
        hora: h!=null ? parseInt(h,10) : null,          // <- usado pela view
        unidade: map.unidade ? String(r[map.unidade]||'').trim() : null,
        loja: map.loja ? String(r[map.loja]||'').trim() : null,     // <- loja real
        canal: map.canal ? String(r[map.canal]||'').trim() : null,
        cancelado: map.cancelado ? !!toBoolVal(r[map.cancelado]) : false,
        itens: map.itens ? parseInt(toNumber(r[map.itens]),10) : 1,
        total: map.total ? toNumber(r[map.total]) : 0,
        des: map.des ? toNumber(r[map.des]) : 0,
        fre: map.fre ? toNumber(r[map.fre]) : 0,
        turno: map.turno ? String(r[map.turno]||'').trim() : null,
        pagamento: map.pagamento ? String(r[map.pagamento]||'').trim() : null,
      };
      out.push(rec);
    }
    return out;
  }

  // Supabase init -----------------------------------------------
  function initClient() {
    const url = $("#url").value.trim();
    const key = $("#key").value.trim();
    SUPA = createClient(url, key);
    return SUPA;
  }

  async function ping() {
    try {
      initClient();
      // Checa se a tabela staging é visível
      const { error } = await SUPA
        .from('vendas_import_csv_v2')
        .select('id', { count:'exact', head:true })
        .limit(1);
      if (error) throw error;
      setPill("#connBadge","✅ Supabase client ok","ok");
      log("✅ Supabase client ok");
    } catch (e) {
      setPill("#connBadge","❌ Erro Supabase","err");
      log("❌", e);
    }
  }

  // UI handlers --------------------------------------------------
  $("#btnPing").addEventListener("click", ping);

  $("#btnRead").addEventListener("click", async () => {
    try {
      const f = $("#file").files[0];
      if (!f) { alert("Escolha um .xlsx"); return; }
      const buf = await f.arrayBuffer();
      const wb = XLS.read(buf, {type:'array'});
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const json = XLS.utils.sheet_to_json(sheet, { defval: null });
      rows = json;
      setPill("#fileInfo", `Arquivo: ${f.name} — Abas: ${wb.SheetNames.length} — Linhas: ${rows.length}`);
      log("📄 Arquivo lido", { nome:f.name, sheet: sheetName, linhas: rows.length });
      // Preenche selects com colunas detectadas
      const cols = Object.keys(rows[0] || {});
      fillSelectOptions(cols);
      // Mostra amostra
      log("🔧 1ª linha (amostra)", rows[0] || {});
    } catch (e) {
      log("❌ Erro lendo Excel", e);
      alert("Erro lendo o Excel (ver Debug).");
    }
  });

  $("#btnPreview").addEventListener("click", () => {
    if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
    const map = getMap();
    mapped = mapRows(rows.slice(0,5), map);
    log("✅ Prévia (5 linhas mapeadas):", mapped);
  });

  $("#btnInsert").addEventListener("click", async () => {
    try {
      if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
      initClient();
      const map = getMap();
      mapped = mapRows(rows, map);
      // valida minima: precisa de data_venda
      const semData = mapped.filter(r => !r.data_venda).length;
      if (semData > 0) log("⚠️ Algumas linhas sem data_venda. Serão inseridas, mas não entram nos filtros por data.");

      const chunk = 2000;
      let ok=0, fail=0;
      for (let i=0;i<mapped.length;i+=chunk){
        const lote = mapped.slice(i, i+chunk);
        const { error } = await SUPA.from('vendas_import_csv_v2').insert(lote);
        if (error) {
          fail += lote.length;
          log({ lote:[i, i+lote.length], error });
        } else {
          ok += lote.length;
          log("✅ Lote inserido", { lote:[i, i+lote.length] });
        }
      }
      setPill("#insInfo", `Inserção concluída — ok: ${ok} / falhas: ${fail}`, fail? 'warn':'ok');
      // recarrega schema para expor a view e RPCs direitinho
      await SUPA.rpc('pg_notify', { channel: 'pgrst', payload: 'reload schema' }).catch(()=>{});
      log("📦 Inserção concluída", { ok, fail });
    } catch (e) {
      log("❌ Erro inserindo", e);
      alert("Erro inserindo (ver Debug).");
    }
  });

  $("#btnAutoRange").addEventListener("click", async ()=>{
    try {
      initClient();
      // usa a VIEW
      const { data, error } = await SUPA
        .from('vw_vendas')
        .select('min:dia,min:dia,max:dia', { head:false })
        .limit(1);
      if (error) throw error;
      // PostgREST retorna como array de objetos com min/max agregados
      const row = (data && data[0]) || null;
      // fallback via SQL RPC (se necessário, você pode criar um RPC minmax)
      const { data: d2 } = await SUPA.from('vw_vendas').select('dia').order('dia',{ascending:true}).limit(1);
      const { data: d3 } = await SUPA.from('vw_vendas').select('dia').order('dia',{ascending:false}).limit(1);
      const minDia = (d2 && d2[0] && d2[0].dia) || '';
      const maxDia = (d3 && d3[0] && d3[0].dia) || '';
      $("#dini").value = minDia || '';
      $("#dfim").value = maxDia || '';
      log("🗓️ Intervalo auto", { minDia, maxDia });
    } catch(e){
      log("⚠️ AutoRange falhou", e);
    }
  });

  $("#btnSmoke").addEventListener("click", async ()=>{
    try{
      initClient();
      const dini = $("#dini").value || '2025-01-01';
      const dfim = $("#dfim").value || '2025-12-31';
      const args = { p_dini: dini, p_dfim: dfim,
        p_unids: null, p_lojas: null, p_turnos: null, p_canais: null, p_pags: null, p_cancelado: null };

      // KPI
      const k = await SUPA.rpc('kpi_vendas_v2', args);
      if (k.error) throw k.error;
      const kpi = Array.isArray(k.data) ? k.data[0] : k.data;
      log("→ KPI params", args);
      log("✅ KPI", kpi);

      // DOW/MÊS/HORA
      const d = await SUPA.rpc('chart_vendas_dow_v2', args);
      const m = await SUPA.rpc('chart_vendas_mes_v2', args);
      const h = await SUPA.rpc('chart_vendas_hora_v2', args);
      if (d.error) throw d.error;
      if (m.error) throw m.error;
      if (h.error) throw h.error;

      const sum = (arr, key) => (arr||[]).reduce((a,b)=> a + Number(b[key]||0), 0);
      const sd = sum(d.data,'total');
      const sm = sum(m.data,'total');
      const sh = sum(h.data,'total');
      const fat = Number(kpi?.fat || 0);

      const ok = (x,y)=> Math.abs(Number(x)-Number(y)) < 0.0001;
      const msg = `DOW ${ok(sd,fat)?'✅':'❌'} soma=${sd.toLocaleString('pt-BR',{minimumFractionDigits:2})} vs KPI=${fat.toLocaleString('pt-BR',{minimumFractionDigits:2})}
MÊS ${ok(sm,fat)?'✅':'❌'} soma=${sm.toLocaleString('pt-BR',{minimumFractionDigits:2})} vs KPI=${fat.toLocaleString('pt-BR',{minimumFractionDigits:2})}
HORA ${ok(sh,fat)?'✅':'❌'} soma=${sh.toLocaleString('pt-BR',{minimumFractionDigits:2})} vs KPI=${fat.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
      $("#smk").textContent = msg;
      log("🧪 Smoke", { dow: sd, mes: sm, hora: sh, fat });

    } catch(e){
      $("#smk").textContent = "❌ Smoke test falhou (ver Debug)";
      log("❌ Smoke", e);
    }
  });

  // Inicial
  (async ()=>{
    await ping();
  })();
</script>
</body>
</html>
