<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v15.1 (filtros em cascata / fallback seguro)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --line:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpiSub{font-size:11px;color:var(--muted);margin-top:2px}
    select,button,input[type="date"]{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .section{margin-top:14px}
    .charts{display:grid;grid-template-columns:1fr; gap:12px}
    canvas{width:100%; height:280px; display:block; background:#fff; border:1px solid var(--line); border-radius:10px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    .btns{display:flex;gap:6px;flex-wrap:wrap}
    .btn{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
    .btn.active{background:#111827;color:#fff;border-color:#111827}
    .col{display:flex;flex-direction:column;gap:6px}
    .badge{padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#374151}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">Build v15.1 • fonte preferida: <span class="badge" id="srcTag">public.vendas_kpi_daily_dims</span> (fallback: vendas_kpi_daily)</div>
        <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
      </div>
      <div class="muted" id="periodo">Período: —</div>
    </div>

    <!-- Filtros -->
    <div class="section card">
      <div class="row">
        <div class="col" style="min-width:200px;flex:1">
          <div class="title">Unidade</div>
          <select id="f_unidade"><option>Carregando…</option></select>
        </div>

        <div class="col" style="min-width:240px;flex:2">
          <div class="title">Período rápido</div>
          <div class="btns" id="quick">
            <button class="btn" data-d="7">7</button>
            <button class="btn" data-d="15">15</button>
            <button class="btn active" data-d="30">30</button>
            <button class="btn" data-d="90">90</button>
            <button class="btn" data-d="180">180</button>
            <button class="btn" data-d="360">360</button>
          </div>
        </div>

        <div class="col" style="min-width:280px;flex:2">
          <div class="title">Período entre datas</div>
          <div class="row" style="gap:6px">
            <input type="date" id="d_ini">
            <input type="date" id="d_fim">
            <button id="b_aplicar" class="btn">Aplicar</button>
          </div>
          <div class="muted">Se preencher as datas acima, o período rápido é ignorado.</div>
        </div>
      </div>

      <!-- filtros “extras” (somem no fallback) -->
      <div id="extraFilters" class="row" style="margin-top:10px">
        <div class="col" style="min-width:160px;flex:1">
          <div class="title">Turno</div>
          <select id="f_turno"><option value="__ALL__">Todos</option></select>
        </div>
        <div class="col" style="min-width:200px;flex:1.2">
          <div class="title">Canal de venda</div>
          <select id="f_canal"><option value="__ALL__">Todos</option></select>
        </div>
        <div class="col" style="min-width:140px;flex:1">
          <div class="title">Com cupom</div>
          <select id="f_cupom">
            <option value="__ALL__">Todos</option>
            <option value="S">S</option>
            <option value="N">N</option>
          </select>
        </div>
        <div class="col" style="min-width:200px;flex:1.2">
          <div class="title">Pagamento</div>
          <select id="f_pgto"><option value="__ALL__">Todos</option></select>
        </div>
        <div class="col" style="min-width:160px;flex:1">
          <div class="title">Está cancelado</div>
          <select id="f_cancel">
            <option value="__ALL__">Todos</option>
            <option value="S">S</option>
            <option value="N">N</option>
          </select>
        </div>
        <div class="col" style="min-width:200px;flex:1.2">
          <div class="title">Entregador</div>
          <select id="f_entregador"><option value="__ALL__">Todos</option></select>
        </div>
        <div class="col" style="align-self:flex-end">
          <button id="b_recarregar">Recarregar</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid section">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="kpiSub" id="k_ped_sub">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="kpiSub" id="k_fat_sub">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="kpiSub" id="k_des_sub">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="kpiSub" id="k_fre_sub">—</div></div>
    </div>

    <!-- Gráficos -->
    <div class="section charts">
      <div class="title">Receita diária (R$)</div>
      <canvas id="c_daily"></canvas>
      <div class="title">Totais por dia da semana (R$)</div>
      <canvas id="c_dow"></canvas>
    </div>

    <div class="card section">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const T_DIM  = "vendas_kpi_daily_dims";   // preferida (todas dimensões)
const T_BASE = "vendas_kpi_daily";        // fallback (unidade+data)

const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);
const logEl = $("log"); function log(m){ logEl.textContent += "\n" + m }
function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0) }
function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)) }
function addDays(d, delta){ const x=new Date(d); x.setDate(x.getDate()+delta); return x }
function toISO(d){ return d.toISOString().slice(0,10) }
function pct(cur, prev){ if(!prev) return "—"; const d=((cur-prev)/prev)*100; return ((d>=0?"+":"")+d.toFixed(1).replace(".",",")+"% vs ant.") }

const f_unidade=$("f_unidade"), f_turno=$("f_turno"), f_canal=$("f_canal"), f_cupom=$("f_cupom"),
      f_pgto=$("f_pgto"), f_cancel=$("f_cancel"), f_entregador=$("f_entregador"),
      quickDiv=$("quick"), d_ini=$("d_ini"), d_fim=$("d_fim");

let TABLE=T_DIM, HAS_DIMS=true, quickDays=30;

/* ===== CANVAS CHARTS ===== */
function clearCanvas(cv){ const ctx=cv.getContext("2d"); ctx.clearRect(0,0,cv.width,cv.height) }
function lineChart(cv, data){
  const dpi=window.devicePixelRatio||1, W=cv.clientWidth, H=cv.clientHeight;
  cv.width=Math.floor(W*dpi); cv.height=Math.floor(H*dpi);
  const ctx=cv.getContext("2d"); ctx.setTransform(dpi,0,0,dpi,0,0);
  const padL=40,padR=10,padT=10,padB=24, plotW=W-padL-padR, plotH=H-padT-padB;
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1;
  const ys=data.map(d=>d.y), maxY=Math.max(1, Math.max(...ys,0));
  const n=data.length||0; const xPos=i=> padL + (n<=1? 0.5*plotW : (i/(n-1))*plotW);
  const yPos=v=> padT + plotH - ( (v)/(maxY) )*plotH;
  ctx.beginPath(); for(let t=0;t<=3;t++){ const y=padT+(t/3)*plotH; ctx.moveTo(padL,y); ctx.lineTo(W-padR,y);} ctx.stroke();
  ctx.fillStyle="#6b7280"; ctx.font="12px system-ui";
  for(let t=0;t<=3;t++){ const v=(t/3)*maxY, y=padT+plotH-(t/3)*plotH; ctx.fillText(fmtBRL(v), 6, y+4); }
  if(n>0){ ctx.strokeStyle="#2563eb"; ctx.lineWidth=2; ctx.beginPath();
    data.forEach((d,i)=>{ const x=xPos(i), y=yPos(d.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
    ctx.stroke();
  }
  ctx.fillStyle="#6b7280"; ctx.font="11px system-ui";
  const ticks = Math.min(4, Math.max(1,n));
  for(let t=0;t<ticks;t++){ const i=Math.round((t/(ticks-1))*(n-1)); if(i<0||i>=n) continue;
    const x=xPos(i), y=H-padB+14; ctx.fillText(String(data[i].x).slice(5), x-16,y); }
}
function barChart(cv, data){
  const dpi=window.devicePixelRatio||1, W=cv.clientWidth, H=cv.clientHeight;
  cv.width=Math.floor(W*dpi); cv.height=Math.floor(H*dpi);
  const ctx=cv.getContext("2d"); ctx.setTransform(dpi,0,0,dpi,0,0);
  const padL=40,padR=10,padT=10,padB=24, plotW=W-padL-padR, plotH=H-padT-padB;
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1;
  const ys=data.map(d=>d.y), maxY=Math.max(1, Math.max(...ys,0));
  const n=data.length||1, gap=8, bw=(plotW-gap*(n+1))/n;
  ctx.beginPath(); for(let t=0;t<=3;t++){ const y=padT+(t/3)*plotH; ctx.moveTo(padL,y); ctx.lineTo(W-padR,y);} ctx.stroke();
  ctx.fillStyle="#6b7280"; ctx.font="12px system-ui";
  for(let t=0;t<=3;t++){ const v=(t/3)*maxY, y=padT+plotH-(t/3)*plotH; ctx.fillText(fmtBRL(v), 6, y+4); }
  data.forEach((d,i)=>{
    const x=padL+gap+i*(bw+gap), h=plotH*(d.y/maxY), y=padT+plotH-h;
    ctx.fillStyle="#10b981"; ctx.fillRect(x,y,bw,h);
    ctx.fillStyle="#6b7280"; ctx.font="11px system-ui"; ctx.fillText(d.x, x+bw/2-12, H-padB+14);
  });
}

/* ===== HELPERS ===== */
function dateWindow(){
  if(d_ini.value && d_fim.value){
    const start = new Date(d_ini.value+"T00:00:00");
    const end   = new Date(d_fim.value+"T23:59:59");
    return {start, end, label:`${toISO(start)} → ${toISO(end)}`, used:'custom'};
  }
  const end=new Date(); const start=addDays(end, -(quickDays-1));
  return {start,end,label:`${toISO(start)} → ${toISO(end)}`, used:'quick'};
}
async function tableOK(name){
  const r = await supa.from(name).select("*").limit(1);
  return !r.error;
}
function fillSelect(sel, values, withAll=true){
  const old = sel.value;
  sel.innerHTML = "";
  if(withAll){ const o=document.createElement("option"); o.value="__ALL__"; o.textContent="Todos"; sel.appendChild(o); }
  values.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  if([...sel.options].some(o=>o.value===old)) sel.value=old;
}

/* ===== DATA FETCH ===== */
async function fetchDistinct(col, baseFilters){
  // se estiver no fallback, NÃO tente buscar colunas que não existem
  if(!HAS_DIMS) return [];
  let q = supa.from(TABLE).select(col)
    .gte("dia", baseFilters.d0).lte("dia", baseFilters.d1).range(0,4999);
  if(baseFilters.unidade && baseFilters.unidade!=="Todas") q = q.eq("unidade", baseFilters.unidade);
  if(baseFilters.turno   && baseFilters.turno!=="__ALL__") q = q.eq("turno", baseFilters.turno);
  if(baseFilters.canal   && baseFilters.canal!=="__ALL__") q = q.eq("canal", baseFilters.canal);
  if(baseFilters.cupom   && baseFilters.cupom!=="__ALL__") q = q.eq("cupom", baseFilters.cupom);
  if(baseFilters.pgto    && baseFilters.pgto!=="__ALL__")  q = q.eq("pagamento", baseFilters.pgto);
  if(baseFilters.cancel  && baseFilters.cancel!=="__ALL__")q = q.eq("cancelado", baseFilters.cancel);
  if(baseFilters.entregador && baseFilters.entregador!=="__ALL__") q = q.eq("entregador", baseFilters.entregador);
  const r = await q;
  if(r.error){ log("[ERRO-Distinct] "+r.error.message); return [] }
  const set = new Set();
  (r.data||[]).forEach(x=>{ const v=x[col]; if(v!==null && v!==undefined && String(v).trim()!=="") set.add(String(v)); });
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
}

async function loadCascata(){
  if(!HAS_DIMS){ // fallback: só unidade já estará preenchida; nada a fazer aqui
    return;
  }
  const {start,end} = dateWindow();
  const base = { d0: toISO(start), d1: toISO(end), unidade: f_unidade.value };

  const turnos = await fetchDistinct("turno", base);
  fillSelect(f_turno, turnos, true);

  const canais = await fetchDistinct("canal", {...base, turno:f_turno.value});
  fillSelect(f_canal, canais, true);

  const pg = await fetchDistinct("pagamento", {...base, turno:f_turno.value, canal:f_canal.value});
  fillSelect(f_pgto, pg, true);

  const ents = await fetchDistinct("entregador", {...base, turno:f_turno.value, canal:f_canal.value, pgto:f_pgto.value, cupom:f_cupom.value, cancel:f_cancel.value});
  fillSelect(f_entregador, ents, true);
}

async function fetchDaily(filters){
  const {start,end} = filters;
  $("periodo").textContent = "Período: "+toISO(start)+" → "+toISO(end);

  // SELECT seguro: depende se estamos com dims ou fallback
  const sel = HAS_DIMS
    ? "dia,unidade,turno,canal,cupom,pagamento,cancelado,entregador,pedidos,fat,des,fre"
    : "dia,unidade,pedidos,fat,des,fre";

  let q = supa.from(TABLE).select(sel)
    .gte("dia", toISO(start)).lte("dia", toISO(end))
    .order("dia",{ascending:true})
    .range(0, 100000);

  if(filters.unidade && filters.unidade!=="Todas") q = q.eq("unidade", filters.unidade);

  if(HAS_DIMS){
    if(filters.turno   && filters.turno!=="__ALL__") q = q.eq("turno", filters.turno);
    if(filters.canal   && filters.canal!=="__ALL__") q = q.eq("canal", filters.canal);
    if(filters.cupom   && filters.cupom!=="__ALL__") q = q.eq("cupom", filters.cupom);
    if(filters.pgto    && filters.pgto!=="__ALL__")  q = q.eq("pagamento", filters.pgto);
    if(filters.cancel  && filters.cancel!=="__ALL__")q = q.eq("cancelado", filters.cancel);
    if(filters.entregador && filters.entregador!=="__ALL__") q = q.eq("entregador", filters.entregador);
  }

  const r = await q;
  if(r.error){ log("[ERRO-Query] "+r.error.message); throw r.error }
  return r.data||[];
}

/* ===== AGG ===== */
function aggKPIs(rows){
  let ped=0,fat=0,des=0,fre=0;
  for(const r of rows){ ped+=Number(r.pedidos)||0; fat+=Number(r.fat)||0; des+=Number(r.des)||0; fre+=Number(r.fre)||0; }
  return {ped,fat,des,fre};
}
function seriesByDay(rows){
  const map=new Map();
  for(const r of rows){ const d=r.dia; const v=Number(r.fat)||0; map.set(d,(map.get(d)||0)+v); }
  return Array.from(map.keys()).sort().map(d=>({x:d,y:map.get(d)}));
}
function seriesByDOW(rows){
  const acc=[0,0,0,0,0,0,0];
  for(const r of rows){ const d = new Date(r.dia+"T00:00:00").getDay(); acc[d] += Number(r.fat)||0; }
  const nomes=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
  return nomes.map((n,i)=>({x:n,y:acc[i]}));
}

/* ===== GO ===== */
async function go(){
  const {start,end} = dateWindow();
  const filters = {
    start,end,
    unidade: f_unidade.value || "Todas",
    turno: HAS_DIMS ? (f_turno.value || "__ALL__") : "__ALL__",
    canal: HAS_DIMS ? (f_canal.value || "__ALL__") : "__ALL__",
    cupom: HAS_DIMS ? (f_cupom.value || "__ALL__") : "__ALL__",
    pgto:  HAS_DIMS ? (f_pgto.value  || "__ALL__") : "__ALL__",
    cancel:HAS_DIMS ? (f_cancel.value|| "__ALL__") : "__ALL__",
    entregador: HAS_DIMS ? (f_entregador.value||"__ALL__") : "__ALL__"
  };

  log(`[Query] ${TABLE} | ${toISO(start)} → ${toISO(end)} | UNI=${filters.unidade}${HAS_DIMS?` | TUR=${filters.turno} | CAN=${filters.canal} | CUP=${filters.cupom} | PG=${filters.pgto} | CANCL=${filters.cancel} | ENT=${filters.entregador}`:""}`);

  const cur = await fetchDaily(filters);
  const win = Math.round( (end - start) / (1000*60*60*24) ) + 1;
  const prevEnd = addDays(start, -1), prevStart = addDays(prevEnd, -(win-1));
  const prev = await fetchDaily({...filters, start: prevStart, end: prevEnd});

  const K1=aggKPIs(cur), K0=aggKPIs(prev);
  $("k_ped").textContent = fmtInt(K1.ped);     $("k_ped_sub").textContent = (K0.ped?pct(K1.ped,K0.ped):"—");
  $("k_fat").textContent = fmtBRL(K1.fat);     $("k_fat_sub").textContent = (K0.fat?pct(K1.fat,K0.fat):"—");
  $("k_des").textContent = fmtBRL(K1.des);     $("k_des_sub").textContent = (K0.des?pct(K1.des,K0.des):"—");
  $("k_fre").textContent = fmtBRL(K1.fre);     $("k_fre_sub").textContent = (K0.fre?pct(K1.fre,K0.fre):"—");

  const cv1=$("c_daily"), cv2=$("c_dow");
  clearCanvas(cv1); clearCanvas(cv2);
  lineChart(cv1, seriesByDay(cur));
  barChart(cv2, seriesByDOW(cur));

  log("[OK] KPIs e gráficos atualizados.");
}

/* ===== BOOT ===== */
async function boot(){
  log("[Boot] v15.1 — checando view completa…");
  const dimOK = await tableOK(T_DIM);  // se 500/404, cai pro fallback
  if(!dimOK){
    TABLE=T_BASE; HAS_DIMS=false; $("srcTag").textContent="public.vendas_kpi_daily (fallback)";
    log("[Info] Usando fallback (vendas_kpi_daily). Filtros extras ocultados.");
    document.getElementById("extraFilters").style.display="none";
  }

  // Unidades (últimos 365d)
  const end=new Date(), start=addDays(end,-365);
  const r = await supa.from(TABLE).select("unidade").gte("dia", toISO(start)).lte("dia", toISO(end)).range(0,4999);
  const set=new Set(); (r.data||[]).forEach(x=>{ if(x.unidade) set.add(x.unidade) });
  const units = ["Todas", ...Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'))];
  f_unidade.innerHTML = units.map(u=>`<option value="${u}">${u}</option>`).join("");

  // listeners
  document.getElementById("b_aplicar").onclick=()=>{ if(d_ini.value && d_fim.value){ quickDiv.querySelectorAll(".btn").forEach(b=>b.classList.remove("active")); loadCascata().then(go); } };
  document.getElementById("b_recarregar").onclick=()=> go();
  quickDiv.querySelectorAll(".btn").forEach(btn=>{
    btn.onclick=()=>{
      quickDiv.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      quickDays = Number(btn.dataset.d)||30;
      d_ini.value=""; d_fim.value="";
      loadCascata().then(go);
    };
  });

  // cascata: só dispara se tiver dims
  f_unidade.onchange = ()=> loadCascata().then(go);
  if(HAS_DIMS){
    f_turno.onchange   = ()=> loadCascata().then(go);
    f_canal.onchange   = ()=> loadCascata().then(go);
    f_cupom.onchange   = ()=> loadCascata().then(go);
    f_pgto.onchange    = ()=> loadCascata().then(go);
    f_cancel.onchange  = ()=> loadCascata().then(go);
    f_entregador.onchange = ()=> go();
  }

  await loadCascata();
  await go();

  // redimensiona = redesenha (sem “gráfico infinito”)
  let t=null; window.onresize=()=>{ clearTimeout(t); t=setTimeout(go,120); };
}
boot();
</script>
</body>
</html>
