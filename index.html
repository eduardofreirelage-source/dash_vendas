<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — Filtros + KPIs (v2.3.2 CFO — Light — Etapa 2 hotfix)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%233b82f6"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --blue:#2563eb; --ok:#16a34a; --err:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:12px}
  .badge{display:inline-block;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px;color:#334155}
  .btn-link{color:#475569;text-decoration:underline;cursor:pointer;font-size:13px}
  .label{font-size:12px;color:#475569;margin-bottom:6px}
  .status{font-size:13px}
  /* multiselect */
  .msel{position:relative}
  .msel-btn{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;text-align:left;cursor:pointer}
  .msel-btn:after{content:"▾";float:right;color:#334155}
  .msel-panel{position:absolute;z-index:50;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:8px}
  .msel-opt:hover{background:#f1f5f9}
  /* KPIs */
  .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  .kpi{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
  .kpi .t{font-size:12px;color:#475569;margin-bottom:6px}
  .kpi .v{font-size:20px;font-weight:800}
  .kpi .p{font-size:12px;color:#64748b}
  .delta{font-size:12px;margin-left:6px}
  .up{color:var(--ok)} .down{color:var(--err)} .flat{color:#64748b}
  pre{white-space:pre-wrap;background:#f8fafc;color:#111827;border-radius:10px;padding:12px;overflow:auto;border:1px solid var(--line);max-height:360px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Dashboard Vendas — Filtros <span class="badge">v2.3.2 CFO — Light — Etapa 2 hotfix</span></h1>
      <div class="muted">Filtros automáticos, ordem solicitada e período rápido ancorado no último dia do banco.</div>
    </div>
    <div>
      <a id="btnClear" class="btn-link">Limpar filtros</a>
      <span id="status" class="status muted" style="margin-left:8px;">—</span>
    </div>
  </header>

  <!-- ===== FILTROS ===== -->
  <div class="card">
    <div class="row cols-3">
      <div>
        <label class="label">Unidade(s)</label>
        <div id="ms-unidades" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Loja(s)</label>
        <div id="ms-lojas" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Turno(s)</label>
        <div id="ms-turnos" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
    </div>

    <div class="row cols-4" style="margin-top:12px;">
      <div>
        <label class="label">Período (De)</label>
        <input id="fDe" type="date" style="width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827"/>
      </div>
      <div>
        <label class="label">Período (Até)</label>
        <input id="fAte" type="date" style="width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827"/>
      </div>
      <div>
        <label class="label">Período Rápido</label>
        <select id="periodo" class="msel-btn" style="border:1px solid var(--line);border-radius:10px;background:#fff;">
          <option value="7">Últimos 7 dias</option>
          <option value="15">Últimos 15 dias</option>
          <option value="30" selected>Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="120">Últimos 120 dias</option>
          <option value="semana">Última semana</option>
          <option value="mes">Último mês</option>
          <option value="custom">Personalizado (usar datas)</option>
        </select>
        <div class="muted" id="periodoTexto" style="margin-top:4px;font-size:12px;">—</div>
      </div>
      <div></div>
    </div>

    <div class="row cols-3" style="margin-top:12px;">
      <div>
        <label class="label">Canal(is)</label>
        <div id="ms-canais" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Pagamento(s)</label>
        <div id="ms-pags" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Cancelado</label>
        <div id="ms-cancel" class="msel">
          <button type="button" class="msel-btn">Não</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""  id="c_all"><label for="c_all">Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="Não" id="c_nao" checked><label for="c_nao">Não</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim" id="c_sim"><label for="c_sim">Sim</label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== KPIs (Etapa 2) ===== -->
  <div class="card" id="kpiCard" style="display:none;">
    <b>KPIs (comparados ao período anterior)</b>
    <div class="kpis" style="margin-top:8px;">
      <div class="kpi"><div class="t">Pedidos</div><div class="v" id="k_ped">—</div><div class="p">Anterior: <span id="p_ped">—</span> <span id="d_ped" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Ticket Médio (líquido)</div><div class="v" id="k_tkt">—</div><div class="p">Anterior: <span id="p_tkt">—</span> <span id="d_tkt" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Faturamento (bruto)</div><div class="v" id="k_fat">—</div><div class="p">Anterior: <span id="p_fat">—</span> <span id="d_fat" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Faturamento Médio (por pedido)</div><div class="v" id="k_fatmed">—</div><div class="p">Anterior: <span id="p_fatmed">—</span> <span id="d_fatmed" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Incentivos (descontos)</div><div class="v" id="k_des">—</div><div class="p">Anterior: <span id="p_des">—</span> <span id="d_des" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Incentivos Média (% do faturamento)</div><div class="v" id="k_desperc">—</div><div class="p">Anterior: <span id="p_desperc">—</span> <span id="d_desperc" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Frete (total)</div><div class="v" id="k_fre">—</div><div class="p">Anterior: <span id="p_fre">—</span> <span id="d_fre" class="delta flat">—</span></div></div>
      <div class="kpi"><div class="t">Frete Médio (por pedido)</div><div class="v" id="k_fremed">—</div><div class="p">Anterior: <span id="p_fremed">—</span> <span id="d_fremed" class="delta flat">—</span></div></div>
    </div>
  </div>

  <!-- ===== DEBUG (igual Etapa 1) ===== -->
  <div class="card">
    <b>Resumo dos filtros aplicados</b>
    <pre id="out">{ }</pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script>
/* ====== CONFIG ====== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);
const setStatus = (t,kind)=>{ const el=$('status'); el.textContent=t; el.style.color = kind==='err'?'#dc2626':(kind==='ok'?'#16a34a':'#6b7280'); };

/* ====== UTIL ====== */
const money = v => (v==null||!isFinite(+v)) ? 'R$ 0,00' : ('R$ ' + (+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}));
const num   = v => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
const pct   = v => (v==null||!isFinite(+v)) ? '0,0%' : ((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
function deltaTxt(curr, prev){ if(!isFinite(prev) || +prev===0) return {txt:'(—)', cls:'flat'}; const p=((curr-prev)/prev)*100; return {txt:`${p>=0?'↑':'↓'} ${Math.abs(p).toFixed(1)}%`, cls:(p>=0?'up':'down')}; }
function setDelta(el, curr, prev){ const d=deltaTxt(curr,prev); el.textContent=d.txt; el.className='delta '+d.cls; }
const dateISO = d => d.toISOString().slice(0,10);
function addDays(iso,n){ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return dateISO(d); }

/* ====== multiselect ====== */
function MultiSelect(rootId, placeholder='Selecionar'){
  const root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
  let options=[], selected=new Set(), filtered=[];
  function render(){
    panel.innerHTML=''; const q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar…';
    q.addEventListener('input',()=>{ filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase())); draw(); });
    panel.appendChild(q); draw();
  }
  function draw(){
    const box=document.createElement('div');
    (filtered.length?filtered:options).forEach((v,i)=>{
      const id=`${rootId}-${i}`; const row=document.createElement('div'); row.className='msel-opt';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v; cb.checked=selected.has(v);
      const lb=document.createElement('label'); lb.htmlFor=id; lb.textContent=v;
      cb.addEventListener('change',()=>{ cb.checked?selected.add(v):selected.delete(v); refresh(); applyAll(); });
      row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
    });
    const olds = Array.from(panel.querySelectorAll('.msel-opt')); olds.forEach(n=>n.remove());
    panel.appendChild(box);
  }
  function refresh(){
    btn.textContent = selected.size===0 ? placeholder :
                      selected.size===options.length ? `Todos (${selected.size})` :
                      `${selected.size} selecionado(s)`;
  }
  btn.addEventListener('click', ()=> root.classList.toggle('open'));
  document.addEventListener('click', (ev)=>{ if(!root.contains(ev.target)) root.classList.remove('open'); });

  return {
    setOptions(list, pre){ options=(list||[]).filter(Boolean); filtered=options.slice(); selected=new Set(pre||[]); render(); refresh(); },
    get(){ return Array.from(selected); },
    set(vals){ selected=new Set(vals||[]); refresh(); draw(); }
  };
}

/* ====== estado e período ====== */
const ms = {
  unidades: MultiSelect('ms-unidades','Todas as unidades'),
  lojas:    MultiSelect('ms-lojas','Todas as lojas'),
  turnos:   MultiSelect('ms-turnos','Todos os turnos'),
  canais:   MultiSelect('ms-canais','Todos os canais'),
  pags:     MultiSelect('ms-pags','Todos os pagamentos'),
  cancel:   MultiSelect('ms-cancel','Todos'),
};
let firstDay='', lastDay='';
const fDe=$('fDe'), fAte=$('fAte'), periodo=$('periodo'), periodoTexto=$('periodoTexto');

function rangeQuick(){
  const md=periodo.value, max=lastDay||dateISO(new Date()); let de=max, ate=max;
  if(['7','15','30','60','90','120'].includes(md)) de=addDays(max, -(Number(md)-1));
  else if(md==='semana'){ const d=new Date(max+'T00:00:00'); const dow=(d.getDay()+6)%7; de=addDays(max,-dow); }
  else if(md==='mes'){ const d=new Date(max+'T00:00:00'); d.setDate(1); de=dateISO(d); d.setMonth(d.getMonth()+1); d.setDate(0); ate=dateISO(d); }
  else if(md==='custom'){ return null; }
  return {de,ate};
}
function labelPeriodo(de,ate){ periodoTexto.textContent=`Período: ${de} → ${ate} (âncora no último dia do banco: ${lastDay||'—'})`; }

/* Só envia os parâmetros aceitos pelo seu RPC (sem retroceder) */
function buildParams(de,ate){
  const canc = ms.cancel.get();
  let p_cancelado = null;
  if (canc.length===1 && (canc[0]==='Não' || canc[0]==='Sim')) p_cancelado = canc[0];
  // se marcar "Todos" ('') ou combinar Sim+Não => null
  return {
    p_dini: de, p_dfim: ate,
    p_unids: ms.unidades.get().length ? ms.unidades.get() : null,
    p_canais:ms.canais.get().length   ? ms.canais.get()   : null,
    p_pags:  ms.pags.get().length     ? ms.pags.get()     : null,
    p_loja:  null,           // mantemos compatível (se RPC não usa, não quebra)
    p_cancelado
  };
}

/* ====== carregar opções ====== */
async function loadOptions(){
  setStatus('Carregando…');
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }

  const [u,l,t,c,p] = await Promise.all([
    supa.from('vw_vendas_unidades').select('unidade').order('unidade'),
    supa.from('vw_vendas_lojas').select('loja').order('loja'),
    supa.from('vw_vendas_turnos').select('turno').order('turno'),
    supa.from('vw_vendas_canais').select('canal').order('canal'),
    supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
  ]);
  ms.unidades.setOptions((u.data||[]).map(r=>r.unidade));
  ms.lojas.setOptions((l.data||[]).map(r=>r.loja));
  ms.turnos.setOptions((t.data||[]).map(r=>r.turno));
  ms.canais.setOptions((c.data||[]).map(r=>r.canal));
  ms.pags.setOptions((p.data||[]).map(r=>r.pagamento_base));
  ms.cancel.setOptions(['','Não','Sim'], ['Não']);

  periodo.value='30'; applyQuick(); // inicial
  setStatus('Opções carregadas.','ok');
}

/* ====== KPIs ====== */
function paintKPIs(now, prev){
  const agg = rows=>{
    let ped=0,fat=0,des=0,fre=0;
    for(const r of (rows||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; }
    const tktLiq = ped>0 ? ((fat-des-fre)/ped) : 0;
    const fatMed = ped>0 ? (fat/ped) : 0;
    const desPerc= fat>0 ? (des/fat) : 0;
    const freMed = ped>0 ? (fre/ped) : 0;
    return {ped,fat,des,fre,tktLiq,fatMed,desPerc,freMed};
  };
  const N=agg(now), P=agg(prev);

  $('kpiCard').style.display='block';

  $('k_ped').textContent   = num(N.ped);
  $('k_tkt').textContent   = money(N.tktLiq);
  $('k_fat').textContent   = money(N.fat);
  $('k_fatmed').textContent= money(N.fatMed);
  $('k_des').textContent   = money(N.des);
  $('k_desperc').textContent = pct(N.desPerc);
  $('k_fre').textContent   = money(N.fre);
  $('k_fremed').textContent= money(N.freMed);

  $('p_ped').textContent   = num(P.ped);
  $('p_tkt').textContent   = money(P.tktLiq);
  $('p_fat').textContent   = money(P.fat);
  $('p_fatmed').textContent= money(P.fatMed);
  $('p_des').textContent   = money(P.des);
  $('p_desperc').textContent = pct(P.desPerc);
  $('p_fre').textContent   = money(P.fre);
  $('p_fremed').textContent= money(P.freMed);

  setDelta($('d_ped'), N.ped, P.ped);
  setDelta($('d_tkt'), N.tktLiq, P.tktLiq);
  setDelta($('d_fat'), N.fat, P.fat);
  setDelta($('d_fatmed'), N.fatMed, P.fatMed);
  setDelta($('d_des'), N.des, P.des);
  setDelta($('d_desperc'), N.desPerc, P.desPerc);
  setDelta($('d_fre'), N.fre, P.fre);
  setDelta($('d_fremed'), N.freMed, P.freMed);
}

/* ====== aplicar ====== */
function applyQuick(){
  const r=rangeQuick();
  if(!r){ fDe.disabled=false; fAte.disabled=false; if(!fDe.value) fDe.value=lastDay; if(!fAte.value) fAte.value=lastDay; labelPeriodo(fDe.value,fAte.value); applyAll(); return; }
  fDe.value=r.de; fAte.value=r.ate; fDe.disabled=true; fAte.disabled=true; labelPeriodo(r.de,r.ate); applyAll();
}
function activateCustom(){ periodo.value='custom'; fDe.disabled=false; fAte.disabled=false; labelPeriodo(fDe.value,fAte.value); applyAll(); }

async function applyAll(){
  try{
    const de = fDe.value || firstDay; const ate = fAte.value || lastDay;

    // debug resumo filtros
    const debug = {
      periodo:{ de, ate, mode: periodo.value },
      filtros:{
        unidades: ms.unidades.get().length? ms.unidades.get(): null,
        lojas:    ms.lojas.get().length   ? ms.lojas.get()   : null,
        turnos:   ms.turnos.get().length  ? ms.turnos.get()  : null,
        canais:   ms.canais.get().length  ? ms.canais.get()  : null,
        pagamentos: ms.pags.get().length ? ms.pags.get()    : null,
        cancelado: ms.cancel.get()
      }
    };
    $('out').textContent = JSON.stringify(debug, null, 2);

    const paramsNow = buildParams(de, ate);

    // período anterior com mesmo tamanho
    const dtDe = new Date(de+'T00:00:00'); const dtAte = new Date(ate+'T00:00:00');
    const len = Math.round((dtAte-dtDe)/(1000*60*60*24))+1;
    const atePrevISO = new Date(dtDe.getTime() - 24*60*60*1000);
    const dePrevISO  = new Date(atePrevISO.getTime() - (len-1)*24*60*60*1000);
    const paramsPrev = buildParams(dateISO(dePrevISO), dateISO(atePrevISO));

    setStatus('Consultando KPIs…');
    const [now, prev] = await Promise.all([
      supa.rpc('kpi_vendas', paramsNow),
      supa.rpc('kpi_vendas', paramsPrev)
    ]);
    if(now.error) throw now.error;
    if(prev.error) throw prev.error;

    paintKPIs(now.data||[], prev.data||[]);
    setStatus('OK','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e),'err');
  }
}

/* ====== eventos ====== */
$('btnClear').addEventListener('click', ()=>{
  ms.unidades.set([]); ms.lojas.set([]); ms.turnos.set([]);
  ms.canais.set([]); ms.pags.set([]); ms.cancel.set(['Não']);
  periodo.value='30'; applyQuick();
});
periodo.addEventListener('change', applyQuick);
fDe.addEventListener('change', activateCustom);
fAte.addEventListener('change', activateCustom);

/* ====== boot ====== */
(async function init(){
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }
  await loadOptions();
})();
</script>
</body>
</html>
