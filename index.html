<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard11</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#0b1220;--muted:#667085;--line:#e6e7eb;--pri:#2f6ef7;--ok:#10b981;--bad:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:24px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;text-decoration:none;color:inherit}
  .section{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-top:12px}
  .row{display:grid;gap:10px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .chips{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .chip{padding:8px;border:1px solid var(--line);border-radius:10px;background:#eef2ff;cursor:pointer;text-align:center;font-weight:700}
  .chip.active{background:var(--pri);border-color:var(--pri);color:#fff}
  input[type=date], .msel-btn{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .msel{position:relative}
  .msel-btn{cursor:pointer;text-align:left}
  .msel-btn:after{content:"â–¾";float:right;color:#475569}
  .msel-panel{position:absolute;z-index:40;top:108%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
  .msel-opt:hover{background:#f3f4f6}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
  .kpi .val{font-size:22px;font-weight:800}
  .kpi .sub{font-size:12px;color:#667085;margin-top:4px}
  .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-weight:800;font-size:12px;margin-left:10px}
  .delta.up{color:#10b981;border-color:#86efac}
  .delta.down{color:#ef4444;border-color:#fecaca}
  .delta.flat{color:#64748b}
  .chart-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
  .chart-box{height:280px}
  .chart-box canvas{width:100% !important;height:100% !important}
  #status{font-weight:700}
  @media (max-width:1024px){.krow{grid-template-columns:repeat(2,1fr)} .cols-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.krow{grid-template-columns:1fr} .cols-3{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>DASHBOARD</h1>
    <div>
      <label for="fileExcel" class="btn" id="btnUploadLabel">ðŸ“¤ Carregar Excel</label>
      <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" hidden>
    </div>
  </div>

  <div class="section">
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px">Intervalo (inÃ­cio)</div><input type="date" id="fDe"></div>
      <div><div class="muted" style="margin-bottom:6px">Intervalo (fim)</div><input type="date" id="fAte"></div>
      <div>
        <div class="muted" style="margin-bottom:6px">PerÃ­odo rÃ¡pido</div>
        <div class="chips">
          <button class="chip" data-q="7">07</button>
          <button class="chip" data-q="15">15</button>
          <button class="chip active" data-q="30">30</button>
          <button class="chip" data-q="60">60</button>
          <button class="chip" data-q="90">90</button>
          <button class="chip" data-q="120">120</button>
        </div>
        <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px">â€”</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div>Filtros</div>
      <div><span id="status" class="muted">â€”</span> <span id="diag" class="muted" style="margin-left:8px;font-size:12px"></span></div>
    </div>
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px">Unidade</div><div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px">Nome da Loja</div><div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px">Turno da Venda</div><div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div></div>
    </div>
    <div class="row cols-3" style="margin-top:10px">
      <div><div class="muted" style="margin-bottom:6px">Canal de Venda</div><div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px">Tipo de Pagamento</div><div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div></div>
      <div>
        <div class="muted" style="margin-bottom:6px">Cancelado</div>
        <div id="ms-cancel" class="msel">
          <button class="msel-btn">NÃ£o</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="NÃ£o" checked><label>NÃ£o</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="krow">
    <div class="kpi"><div style="display:flex;justify-content:space-between"><div>Pedidos</div><span class="delta flat" id="d_ped">â€”</span></div><div class="val" id="k_ped">â€”</div><div class="sub">Anterior: <span id="p_ped">â€”</span></div></div>
    <div class="kpi"><div style="display:flex;justify-content:space-between"><div>Ticket MÃ©dio</div><span class="delta flat" id="d_tkt">â€”</span></div><div class="val" id="k_tkt">â€”</div><div class="sub">Anterior: <span id="p_tkt">â€”</span></div></div>
    <div class="kpi"><div style="display:flex;justify-content:space-between"><div>Faturamento</div><span class="delta flat" id="d_fat">â€”</span></div><div class="val" id="k_fat">â€”</div><div class="sub">Anterior: <span id="p_fat">â€”</span></div></div>
  </div>

  <div class="section">
    <div style="margin-bottom:6px">GrÃ¡ficos</div>
    <div class="row cols-3">
      <div class="chart-card"><div class="chart-box"><canvas id="ch_dow"></canvas></div></div>
      <div class="chart-card"><div class="chart-box"><canvas id="ch_month"></canvas></div></div>
      <div class="chart-card"><div class="chart-box"><canvas id="ch_hour"></canvas></div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===== CONFIG ===== */
var SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
var SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
var DEST_INSERT_TABLE = 'vendas_xlsx';

function $(id){ return document.getElementById(id); }
function setStatus(t,kind){ var el=$('status'); el.textContent=t; el.className = kind==='ok'?'ok':(kind==='bad'?'bad':'muted'); }
function iso(d){ return d.toISOString().slice(0,10); }
function addDaysISO(isoStr,n){ var d=new Date(isoStr+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+n); return iso(d); }
function money(v){ v=+v||0; return 'R$ '+v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function num(v){ v=+v||0; return v.toLocaleString('pt-BR'); }

/* ===== MultiSelect simples ===== */
function MultiSelect(rootId, placeholder){
  var root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
  var options=[], selected=new Set(), filtered=[];
  function render(){
    panel.innerHTML='';
    var q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar...';
    q.addEventListener('input', function(){ filtered=options.filter(function(v){return v.toLowerCase().indexOf(q.value.toLowerCase())>-1}); draw(); });
    panel.appendChild(q); draw();
  }
  function draw(){
    var box=document.createElement('div');
    (filtered.length?filtered:options).forEach(function(v){
      var row=document.createElement('div'); row.className='msel-opt';
      var cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=selected.has(v);
      var lb=document.createElement('label'); lb.textContent=v;
      cb.addEventListener('change', function(){
        if(rootId==='ms-cancel'){
          if(v==='' && cb.checked){ selected = new Set(['']); }
          else if(v!=='' && cb.checked){ selected.delete(''); selected.add(v); }
          else if(!cb.checked && selected.size===0){ selected.add('NÃ£o'); }
        }else{
          if(cb.checked) selected.add(v); else selected.delete(v);
        }
        refresh(); applyAll(); draw();
      });
      row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
    });
    panel.querySelectorAll('.msel-opt').forEach(function(n){ n.remove(); });
    panel.appendChild(box);
  }
  function refresh(){ btn.textContent = selected.size===0? placeholder : (selected.size+' selecionado(s)'); }
  btn.addEventListener('click', function(){ root.classList.toggle('open'); });
  document.addEventListener('click', function(e){ if(!root.contains(e.target)) root.classList.remove('open'); });
  return { setOptions:function(list){ options=(list||[]).map(String).filter(Boolean).sort(function(a,b){return a.localeCompare(b,'pt-BR')}); filtered=options.slice(); selected=new Set([...selected].filter(function(v){return options.indexOf(v)>-1})); render(); refresh(); }, get:function(){ return [...selected]; }, set:function(vals){ selected=new Set((vals||[]).map(String)); refresh(); draw(); } };
}

var fDe=$('fDe'), fAte=$('fAte'), chips=[].slice.call(document.querySelectorAll('.chip'));
var ms={ unids:MultiSelect('ms-unids','Todas as unidades'), lojas:MultiSelect('ms-lojas','Todas as lojas'), canais:MultiSelect('ms-canais','Todos os canais'), turnos:MultiSelect('ms-turnos','Todos os turnos'), pags:MultiSelect('ms-pags','Todos os tipos'), cancel:MultiSelect('ms-cancel','Todos') };
var firstDay='', lastDay='';

function setActiveChip(val){ chips.forEach(function(c){ c.classList.toggle('active', c.dataset.q===String(val)); }); }
function applyQuick(val){
  setActiveChip(val);
  var ate=lastDay || (new Date()).toISOString().slice(0,10);
  var de=addDaysISO(ate, -(Number(val)-1));
  fDe.value=de; fAte.value=ate;
  $('periodoInfo').textContent='Ãšltimo dia carregado: '+(lastDay||'â€”');
  applyAll();
}
chips.forEach(function(b){ b.addEventListener('click', function(){ applyQuick(b.dataset.q); }); });
[fDe,fAte].forEach(function(inp){ inp.addEventListener('change', function(){ chips.forEach(function(c){c.classList.remove('active')}); applyAll(); }); });

/* ===== Upload Excel robusto (serial, data+hora, validaÃ§Ã£o) ===== */
$('fileExcel').addEventListener('change', function(ev){
  var file = ev.target.files && ev.target.files[0];
  if(!file){ return; }
  setStatus('Lendo arquivo...', 'muted');
  file.arrayBuffer().then(function(buf){
    var wb = XLSX.read(buf, { type:'array' });
    var ws = wb.Sheets[wb.SheetNames[0]];
    var json = XLSX.utils.sheet_to_json(ws, { raw:false, defval:null });
    if(!json.length){ setStatus('Planilha vazia', 'bad'); return; }

    function H(s){ return String(s||'').toLowerCase().trim(); }
    var cols = Object.keys(json[0]).reduce(function(a,h){ a[H(h)]=h; return a; },{});
    function col(cands){ for(var i=0;i<cands.length;i++){ var key=H(cands[i]); if(cols[key]) return cols[key]; } return null; }

    // nomes possÃ­veis para data e data+hora
    var kDia   = col(['dia','data','data da venda','data da compra','data do pedido','date','data_venda','data_pedido','emissÃ£o']);
    var kDH    = col(['data hora','data/hora','datahora','data e hora','horÃ¡rio','datetime']); // quando vem junto
    var kHora  = col(['hora','hr','hour','horario','time','hora venda','hora do pedido']);

    var kTurn  = col(['turno','periodo','perÃ­odo','shift']);
    var kFat   = col(['fat','faturamento','valor total','valor_total','valor','total','total nota','valor_venda','vlr_total']);
    var kDes   = col(['des','desconto','incentivo','incentivos']);
    var kFre   = col(['fre','frete','entrega','taxa entrega','taxa_entrega']);
    var kPed   = col(['pedidos','qtd pedidos','qtd_pedidos','qtde','qtd','qtd_pedido','itens','qtd_itens']);
    var kUni   = col(['unidade','unid','filial','cod_unidade','empresa']);
    var kLoja  = col(['loja','nome da loja','nome loja','loja fantasia','nome_loja']);
    var kCan   = col(['canal','canal de venda','canal venda','origem','meio','canal_venda']);
    var kPag   = col(['pagamento base','pagamento_base','tipo pagamento','tipo_pagamento','pagamento','forma pagamento','forma_pagamento']);
    var kCanc  = col(['cancelado','cancel','st cancelado','cancelada']);
    var kPid   = col(['pedido id','pedido_id','id pedido','id_pedido','order id','order_id']);

    // conversÃµes
    var EXCEL_EPOCH = Date.UTC(1899,11,30); // 1899-12-30
    function excelSerialToDate(n){
      // n inteiro = dias; fraÃ§Ã£o = hora/min/seg
      var ms = EXCEL_EPOCH + Math.round(n*86400000);
      return new Date(ms);
    }
    function normDate(v){
      if(v==null || v==='') return null;
      if(v instanceof Date) return iso(v);
      if(typeof v==='number') return iso(excelSerialToDate(v));
      var s=String(v).trim();
      // "dd/mm/aaaa hh:mm[:ss]" -> pega sÃ³ a data
      var m1=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
      if(m1){ var d=new Date(Date.UTC(+m1[3],+m1[2]-1,+m1[1])); return iso(d); }
      // "aaaa-mm-dd ..."
      if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
      // Ãºltimo recurso: Date()
      var t=new Date(s); return isNaN(t.getTime())? null : iso(t);
    }
    function parseHour(v){
      if(v==null || v==='') return null;
      if(v instanceof Date) return v.getUTCHours();
      if(typeof v==='number'){
        // serial excel: fraÃ§Ã£o do dia vira hora
        var frac = v % 1;
        if(frac===0) return 0;
        var hh = Math.floor(frac*24 + 1e-6);
        if(hh<0) hh=0; if(hh>23) hh=23; return hh;
      }
      var s=String(v);
      var m=s.match(/(\d{1,2})(?::|h)/); return m? Math.max(0,Math.min(23, +m[1])) : null;
    }
    function br(v){
      if(v==null) return 0;
      if(typeof v==='number') return v;
      var s=String(v).replace(/[^\d,.\-]/g,'').trim();
      var lastC=s.lastIndexOf(','), lastD=s.lastIndexOf('.');
      if(lastD>lastC){ s=s.replace(/,/g,''); } else { s=s.replace(/\./g,''); s=s.replace(',', '.'); }
      var n=Number(s); return isFinite(n)?n:0;
    }
    function toInt(v){ var n=br(v); return isFinite(n)?Math.round(n):0; }
    function nstr(v){ v=String(v||'').trim(); return v||null; }
    function nCancel(v){ var s=String(v||'').trim().toLowerCase(); if(['sim','true','1','s','y','yes'].indexOf(s)>-1) return 'Sim'; return 'NÃ£o'; }
    function turnoPorHora(h){ if(h==null) return null; return (h>=6 && h<12)? 'ManhÃ£' : (h>=12 && h<18)? 'Dia' : 'Noite'; }

    function rowKey(x){
      return [x.dia||'', x.hora==null?'':x.hora, x.unidade||'', x.loja||'', x.canal||'', x.pagamento_base||'', x.pedido_id||'', x.cancelado||'', x.turno||''].join('|').toLowerCase();
    }

    var mapped = json.map(function(r){
      // prioriza Data+Hora se existir
      var dia=null, hora=null;
      if(kDH && r[kDH]!=null){
        var v=r[kDH];
        if(v instanceof Date){ dia=iso(v); hora=v.getUTCHours(); }
        else if(typeof v==='number'){ var d=excelSerialToDate(v); dia=iso(d); hora=d.getUTCHours(); }
        else { dia=normDate(v); hora=parseHour(v); }
      }
      if(!dia && kDia){ dia = normDate(r[kDia]); }
      if(hora==null && kHora){ hora = parseHour(r[kHora]); }

      var o = {
        dia: dia,
        hora: hora,
        unidade: nstr(kUni? r[kUni]: null) || 'UNID_ND',
        loja:    nstr(kLoja? r[kLoja]: null) || 'LOJA_DESCONHECIDA',
        canal:   nstr(kCan? r[kCan]: null) || 'CANAL_ND',
        pagamento_base: nstr(kPag? r[kPag]: null),
        cancelado: nCancel(kCanc? r[kCanc]: null),
        pedidos: toInt(kPed? r[kPed]: 1),
        fat: br(kFat? r[kFat]: 0),
        des: br(kDes? r[kDes]: 0),
        fre: br(kFre? r[kFre]: 0),
        pedido_id: nstr(kPid? r[kPid]: null),
        turno: nstr(kTurn? r[kTurn]: null),
        created_at: new Date().toISOString()
      };
      if(!o.turno && o.hora!=null) o.turno = turnoPorHora(o.hora);
      o.row_key = rowKey(o);
      return o;
    })
    // 1) sÃ³ mantÃ©m registros com data vÃ¡lida YYYY-MM-DD
    .filter(function(x){ return typeof x.dia==='string' && /^\d{4}-\d{2}-\d{2}$/.test(x.dia); });

    if(!mapped.length){
      setStatus('Nenhuma linha com data vÃ¡lida encontrada. Verifique cabeÃ§alho da planilha.', 'bad');
      console.warn('CabeÃ§alhos lidos:', Object.keys(cols));
      return;
    }

    // dedupe por row_key
    var map=new Map(); mapped.forEach(function(x){ map.set(x.row_key,x); });
    var rows=[].concat(map.values());
    setStatus('Enviando '+rows.length+' linhas...', 'muted');

    var chunk=500, i=0;
    function sendNext(){
      if(i>=rows.length){
        setStatus('Upload concluÃ­do', 'ok');
        initAndRefresh();
        return;
      }
      var slice=rows.slice(i,i+chunk); i+=chunk;
      supa.from(DEST_INSERT_TABLE).upsert(slice, { onConflict:'row_key' }).then(function(r){
        if(r.error){ console.error(r.error); setStatus('Erro: '+r.error.message, 'bad'); }
        else{ sendNext(); }
      });
    }
    sendNext();
  });
});

/* ===== RPCs ===== */
function buildParams(de,ate){
  var p_cancelado=null;
  var canc = ms.cancel.get();
  if(canc.length===1 && (canc[0]==='NÃ£o' || canc[0]==='Sim')) p_cancelado=canc[0];
  return {
    p_dini:de, p_dfim:ate,
    p_unids: ms.unids.get().length? ms.unids.get(): null,
    p_lojas: ms.lojas.get().length? ms.lojas.get(): null,
    p_turnos:ms.turnos.get().length?ms.turnos.get():null,
    p_canais:ms.canais.get().length?ms.canais.get():null,
    p_pags:  ms.pags.get().length?  ms.pags.get():  null,
    p_cancelado:p_cancelado
  };
}
function rpcFirst(fn, params){ return supa.rpc(fn, params).then(function(r){ if(r.error) return Promise.reject(r.error); return r.data||[]; }); }
function rpcCharts(kind, de, ate){
  var p=buildParams(de,ate);
  return rpcFirst('chart_vendas_'+kind+'_v2', p).catch(function(){
    var p1=Object.assign({},p); delete p1.p_unids;
    return rpcFirst('chart_vendas_'+kind+'_v1', p1).catch(function(){
      var p2=Object.assign({},p1); delete p2.p_pags;
      return rpcFirst('chart_vendas_'+kind+'_v1', p2);
    });
  });
}
function rpcKpi(de,ate){ var p=buildParams(de,ate); var fn = p.p_unids? 'kpi_vendas_v2' : 'kpi_vendas'; return rpcFirst(fn,p); }

function ensureChart(id, labels, nowArr, prevArr){
  var ctx=$(id).getContext('2d');
  if($(id).__chart){ try{$(id).__chart.destroy();}catch(e){} }
  var ch=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[
    {label:'Atual',data:nowArr,backgroundColor:'rgba(47,110,247,0.85)'},
    {label:'Anterior',data:prevArr,backgroundColor:'rgba(2,132,199,0.6)'}
  ]},options:{responsive:true,maintainAspectRatio:false,animation:false}});
  $(id).__chart=ch;
}

/* ===== APLICA ===== */
function applyAll(){
  var de=fDe.value, ate=fAte.value;
  if(!de || !ate){ setStatus('Defina o perÃ­odo', 'muted'); return; }
  setStatus('Consultando...', 'muted');

  rpcKpi(de,ate).then(function(k){
    var ped=0,fat=0;
    (k||[]).forEach(function(r){ ped+=+r.pedidos||0; fat+=+r.fat||0; });
    $('k_ped').textContent=num(ped);
    $('k_fat').textContent=money(fat);
    $('k_tkt').textContent=money(ped>0? fat/ped : 0);
    deltaBadge($('d_ped'), ped, 0);
    deltaBadge($('d_fat'), fat, 0);
    deltaBadge($('d_tkt'), ped>0? fat/ped:0, 0);
    setStatus('OK','ok');
  }).catch(function(e){ setStatus('Erro KPIs: '+e.message,'bad'); });

  Promise.all([rpcCharts('dow',de,ate), rpcCharts('month',de,ate), rpcCharts('hour',de,ate)]).then(function(arr){
    var dow=arr[0]||[]; var lab=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b']; var nA=Array(7).fill(0); dow.forEach(function(r){ nA[r.dow]=+r.total||0; });
    ensureChart('ch_dow', lab, nA, Array(7).fill(0));
    var mo=arr[1]||[]; var labm=mo.map(function(r){return r.ym}); var nM=mo.map(function(r){return +r.total||0}); ensureChart('ch_month', labm, nM, nM.map(function(){return 0}));
    var ho=arr[2]||[]; var labh=Array.from({length:24},function(_,h){return (h<10?'0':'')+h+'h'}); var nH=Array(24).fill(0); ho.forEach(function(r){ nH[r.h]=+r.total||0; }); ensureChart('ch_hour', labh, nH, Array(24).fill(0));
  }).catch(function(e){ setStatus('Erro grÃ¡ficos: '+e.message,'bad'); });
}

/* ===== INIT ===== */
var firstDay='', lastDay='';
function reloadStaticOptions(){
  return Promise.all([
    supa.from(DEST_INSERT_TABLE).select('unidade').not('unidade','is',null),
    supa.from(DEST_INSERT_TABLE).select('loja').not('loja','is',null),
    supa.from(DEST_INSERT_TABLE).select('canal').not('canal','is',null),
    supa.from(DEST_INSERT_TABLE).select('turno').not('turno','is',null),
    supa.from(DEST_INSERT_TABLE).select('pagamento_base').not('pagamento_base','is',null)
  ]).then(function(rs){
    function toOpt(r,key){ return (r.data||[]).map(function(x){return x[key]}).filter(Boolean).filter(function(v,i,a){return a.indexOf(v)===i}).sort(function(a,b){return a.localeCompare(b,'pt-BR')}); }
    ms.unids.setOptions(toOpt(rs[0],'unidade'));
    ms.lojas.setOptions(toOpt(rs[1],'loja'));
    ms.canais.setOptions(toOpt(rs[2],'canal'));
    ms.turnos.setOptions(toOpt(rs[3],'turno'));
    ms.pags.setOptions(toOpt(rs[4],'pagamento_base'));
  });
}
function initAndRefresh(){
  supa.from(DEST_INSERT_TABLE).select('min(dia),max(dia)').limit(1).single().then(function(r){
    if(!r.error){ firstDay=r.data.min; lastDay=r.data.max; $('periodoInfo').textContent='Ãšltimo dia carregado: '+(lastDay||'â€”'); }
    ms.cancel.set(['NÃ£o']);
    if(lastDay){ applyQuick('30'); } else { setStatus('Sem dados','muted'); }
  });
}
reloadStaticOptions().then(initAndRefresh);

/* helpers delta */
function deltaBadge(el,curr,prev){
  if(!isFinite(prev)||+prev===0){ el.textContent='â€”'; el.className='delta flat'; return; }
  var p=((curr-prev)/prev)*100;
  el.textContent=(p>=0?'â–² ':'â–¼ ')+Math.abs(p).toFixed(1)+'%';
  el.className='delta '+(p>=0?'up':'down');
}
</script>
</body>
</html>
