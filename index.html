<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Vendas – Upload, Filtros & Smoke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' fill='%230b5'/%3E%3Ctext x='50%25' y='55%25' font-size='36' text-anchor='middle' fill='white'%3E✓%3C/text%3E%3C/svg%3E" />
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#0b1220;--fg:#d7e1ff;--green:#0b5;}
    body{font-family:system-ui,Arial,sans-serif;margin:18px}
    h1{margin:0 0 8px}
    fieldset{border:1px solid #ddd;border-radius:8px;padding:12px;margin:14px 0}
    legend{padding:0 6px;color:#444}
    label{display:block;font-size:12px;color:#555;margin:6px 0 4px}
    select,input[type="text"],input[type="date"],button{padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
    select[multiple]{min-height:180px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{min-width:220px;flex:1}
    .btn{background:var(--green);color:#fff;border:none;cursor:pointer;padding:8px 12px;border-radius:6px}
    .btn-secondary{background:#456;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;margin-right:6px;font-size:12px}
    .ok{color:#0a0}.warn{color:#a60}.err{color:#c00}
    #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;max-height:420px;overflow:auto}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <h1>Vendas – Upload, Filtros & Smoke</h1>

  <!-- SUPABASE -->
  <fieldset>
    <legend>Supabase</legend>
    <div class="row">
      <div class="col">
        <label>URL</label>
        <input id="url" type="text" value="https://uahmcfzerofhzjvlzrqc.supabase.co" />
      </div>
      <div class="col">
        <label>Anon key</label>
        <input id="key" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" />
      </div>
      <div class="col" style="align-self:end">
        <button id="btnPing" class="btn">Testar conexão</button>
      </div>
    </div>
    <div id="connBadge" class="pill"></div>
  </fieldset>

  <!-- UPLOAD -->
  <fieldset>
    <legend>Upload Excel</legend>
    <div class="row">
      <div class="col"><input id="file" type="file" accept=".xlsx,.xls" /></div>
      <div class="col" style="max-width:260px"><button id="btnRead" class="btn">Ler arquivo</button></div>
      <div class="col"><span id="fileInfo" class="pill"></span></div>
    </div>

    <!-- MAPA DE COLUNAS -->
    <div class="row">
      <div class="col"><label>Data+Hora (se tiver)</label><select id="m_datahora"></select></div>
      <div class="col"><label>Data (yyyy-mm-dd)</label><select id="m_data_venda"></select></div>
      <div class="col"><label>Hora (0–23)</label><select id="m_hora"></select></div>
      <div class="col"><label>Unidade</label><select id="m_unidade"></select></div>
      <div class="col"><label><b>Loja</b></label><select id="m_loja"></select></div>
      <div class="col"><label>Canal</label><select id="m_canal"></select></div>
      <div class="col"><label>Cancelado (Sim/Não/true/false)</label><select id="m_cancelado"></select></div>
      <div class="col"><label>Itens</label><select id="m_itens"></select></div>
      <div class="col"><label>Total</label><select id="m_total"></select></div>
      <div class="col"><label>Desconto</label><select id="m_des"></select></div>
      <div class="col"><label>Frete</label><select id="m_fre"></select></div>
      <div class="col"><label>Turno</label><select id="m_turno"></select></div>
      <div class="col"><label>Pagamento</label><select id="m_pagamento"></select></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><button id="btnPreview" class="btn btn-secondary">Validar & Prévia (5 linhas)</button></div>
      <div class="col"><button id="btnInsert" class="btn">Inserir no banco (lotes de 2.000)</button></div>
      <div class="col"><span id="insInfo" class="pill"></span></div>
    </div>
  </fieldset>

  <!-- FILTROS -->
  <fieldset>
    <legend>Filtros (por período)</legend>
    <div class="row">
      <div class="col"><label>Data inicial</label><input type="date" id="dini" /></div>
      <div class="col"><label>Data final</label><input type="date" id="dfim" /></div>
      <div class="col" style="align-self:end"><button id="btnAutoRange" class="btn btn-secondary">Min/Max automáticos</button></div>
      <div class="col" style="align-self:end"><button id="btnLoadLists" class="btn btn-secondary">Carregar listas</button></div>
    </div>
    <div class="row">
      <div class="col"><label>Unidade (multi)</label><select id="f_unids" multiple></select></div>
      <div class="col"><label><b>Loja (multi)</b></label><select id="f_lojas" multiple></select></div>
      <div class="col"><label>Turno (multi)</label><select id="f_turnos" multiple></select></div>
      <div class="col"><label>Canal (multi)</label><select id="f_canais" multiple></select></div>
      <div class="col"><label>Pagamento (multi)</label><select id="f_pags" multiple></select></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col" style="max-width:260px"><button id="btnSmoke" class="btn">KPI + Charts (com filtros)</button></div>
      <div class="col"><span id="smk" class="pill mono"></span></div>
    </div>
  </fieldset>

  <!-- DEBUG -->
  <fieldset>
    <legend>Debug</legend>
    <pre id="log"></pre>
  </fieldset>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

    const $ = (sel) => document.querySelector(sel);
    function log(...args){
      const el = $("#log");
      const parts = args.map(v => (typeof v === "string" ? v : JSON.stringify(v,null,2)));
      el.textContent += parts.join(" ") + "\n";
      el.scrollTop = el.scrollHeight;
    }
    const setPill = (id, txt, cls) => { const el=$(id); el.textContent = txt||""; el.className = "pill " + (cls||""); };

    let SB = null;
    let rows = [];

    const picks = ["m_datahora","m_data_venda","m_hora","m_unidade","m_loja","m_canal","m_cancelado","m_itens","m_total","m_des","m_fre","m_turno","m_pagamento"];

    function sanitizeHeader(k){ return String(k).replace(/\s+/g," ").trim(); }
    function sanitizeRows(json){
      return json.map(r=>{
        const o={};
        for (const k of Object.keys(r)) o[sanitizeHeader(k)] = r[k];
        return o;
      });
    }
    function fillSelectOptions(cols){
      for (const id of picks) {
        const el = $("#"+id);
        el.innerHTML = ['<option value="">-- (vazio) --</option>', ...cols.map(c=>`<option>${c}</option>`)].join("");
      }
      suggest("#m_datahora", ["datahora","Data hora","Data","data"]);
      suggest("#m_data_venda", ["data_venda","Data","data"]);
      suggest("#m_hora", ["hora","Hora"]);
      suggest("#m_unidade", ["unidade","Unidade"]);
      suggest("#m_loja", ["loja","Loja","Nome da loja","Nome da Loja"]);
      suggest("#m_canal", ["canal","Canal de venda","Canal"]);
      suggest("#m_cancelado", ["cancelado","Cancelado","Está cancelado","está cancelado"]);
      suggest("#m_itens", ["itens","Itens","pedidos","Pedidos"]);
      suggest("#m_total", ["total","Total","fat","Fat"]);
      suggest("#m_des", ["des","Desconto","desconto"]);
      suggest("#m_fre", ["fre","Frete","frete","Entrega"]);
      suggest("#m_turno", ["turno","Turno"]);
      suggest("#m_pagamento", ["pagamento","Pagamento","pagamento_base"]);
    }
    function suggest(sel, list){
      const el = $(sel);
      const vals = Array.from(el.options).map(o => o.value.toLowerCase());
      for (const c of list) {
        const i = vals.indexOf(String(c).toLowerCase());
        if (i >= 0) { el.selectedIndex = i + 1; break; }
      }
    }
    function getMap(){
      const g = id => { const v=$("#"+id).value; return v===""?null:v; };
      return {
        datahora: g("m_datahora"),
        data_venda: g("m_data_venda"),
        hora: g("m_hora"),
        unidade: g("m_unidade"),
        loja: g("m_loja"),
        canal: g("m_canal"),
        cancelado: g("m_cancelado"),
        itens: g("m_itens"),
        total: g("m_total"),
        des: g("m_des"),
        fre: g("m_fre"),
        turno: g("m_turno"),
        pagamento: g("m_pagamento")
      };
    }

    // Parsers
    function parseDateLike(v){
      if (v === null || v === undefined || v === "") return { d:null, h:null };
      if (typeof v === "number") { // Excel serial
        const epoch = new Date(Date.UTC(1899,11,30));
        const dt = new Date(epoch.getTime() + v*86400000);
        return { d: dt.toISOString().slice(0,10), h: dt.getUTCHours() };
      }
      const s = String(v).trim().replace("T"," ");
      let m = s.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})(?:\s+(\d{1,2})(?::\d{2})?)?/);
      if (m) return { d:`${m[1]}-${m[2]}-${m[3]}`, h: m[4]?parseInt(m[4],10):null };
      m = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})(?:\s+(\d{1,2})(?::\d{2})?)?/);
      if (m) return { d:`${m[3]}-${m[2]}-${m[1]}`, h: m[4]?parseInt(m[4],10):null };
      m = s.match(/^(\d{1,2})(?::\d{2})?$/);
      if (m) return { d:null, h: parseInt(m[1],10) };
      return { d:null, h:null };
    }
    function toBoolVal(v){
      if (typeof v === "boolean") return v;
      const s = String(v||"").trim().toLowerCase();
      if (["sim","s","true","1","yes","y"].includes(s)) return true;
      if (["nao","não","n","false","0","no"].includes(s)) return false;
      return false;
    }
    function toNumber(v){
      if (v === null || v === undefined || v === "") return 0;
      if (typeof v === "number") return v;
      const n = Number(String(v).trim().split(".").join("").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }
    function mapRows(raw, map){
      const out = [];
      for (const r of raw) {
        let d=null, h=null;
        if (map.datahora && r[map.datahora] != null) { const x = parseDateLike(r[map.datahora]); d=x.d; h=x.h; }
        if (!d && map.data_venda && r[map.data_venda] != null) { const x = parseDateLike(r[map.data_venda]); d=x.d; }
        if (h==null && map.hora && r[map.hora] != null) {
          const x = parseDateLike(r[map.hora]); h = (x.h!=null?x.h:toNumber(r[map.hora]));
        }
        out.push({
          data_venda: d,
          hora: (h!=null?parseInt(h,10):null),
          unidade: map.unidade ? String(r[map.unidade]||"").trim() : null,
          loja: map.loja ? String(r[map.loja]||"").trim() : null,
          canal: map.canal ? String(r[map.canal]||"").trim() : null,
          cancelado: map.cancelado ? !!toBoolVal(r[map.cancelado]) : false,
          itens: map.itens ? parseInt(toNumber(r[map.itens]),10) : 1,
          total: map.total ? toNumber(r[map.total]) : 0,
          des: map.des ? toNumber(r[map.des]) : 0,
          fre: map.fre ? toNumber(r[map.fre]) : 0,
          turno: map.turno ? String(r[map.turno]||"").trim() : null,
          pagamento: map.pagamento ? String(r[map.pagamento]||"").trim() : null
        });
      }
      return out;
    }

    function normalizeInputDate(s){
      if (!s) return "";
      s = String(s).trim();
      let m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      m = s.match(/^(\d{4,5})-(\d{2})-(\d{2})$/);
      if (m) {
        let y = m[1];
        if (y.length===5 && y.startsWith("20")) y = y.slice(0,4);
        return `${y}-${m[2]}-${m[3]}`;
      }
      const p = parseDateLike(s).d;
      return p || "";
    }
    function clampRange(dini, dfim){
      if (dini && dfim && dfim < dini) return { dini, dfim: dini };
      return { dini, dfim };
    }

    async function initClient(){
      if (SB) return SB;
      SB = createClient($("#url").value.trim(), $("#key").value.trim());
      return SB;
    }
    async function ping(){
      try {
        await initClient();
        const tryCols = ["data_venda","loja","unidade","turno","*"];
        let ok=false, lastErr=null;
        for (const col of tryCols) {
          const { error } = await SB.from("vendas_import_csv_v2").select(col).limit(1);
          if (!error) { ok=true; break; }
          lastErr=error;
        }
        if (ok) { setPill("#connBadge","✅ Supabase client ok","ok"); log("✅ Supabase client ok"); }
        else { setPill("#connBadge","❌ Erro Supabase","err"); log("❌", lastErr||{message:"Erro desconhecido"}); }
      } catch (e) { setPill("#connBadge","❌ Erro Supabase","err"); log("❌", e); }
    }

    // Distinct (cliente) via vw_vendas por período – dedup no cliente
    async function distinctValues(col, dini, dfim){
      try{
        const q = SB.from("vw_vendas")
          .select(col)
          .not(col,"is",null)
          .neq(col,"")
          .gte("dia", dini)
          .lte("dia", dfim)
          .order(col,{ascending:true})
          .limit(100000); // suficiente p/ listas
        const { data, error } = await q;
        if (error) { log("⚠️ distinct "+col, error); return []; }
        const vals = [...new Set((data||[]).map(r => (r[col]??"").toString().trim()).filter(Boolean))]
          .sort((a,b)=>a.localeCompare(b,"pt-BR",{sensitivity:"base"}));
        return vals;
      }catch(e){ log("⚠️ distinct "+col+" exceção", e); return []; }
    }
    function fillMulti(id, arr){
      const el = $("#"+id);
      el.innerHTML = arr.map(v => `<option>${v}</option>`).join("");
    }
    function selectedMulti(id){
      return Array.from($("#"+id).selectedOptions).map(o=>o.value).filter(Boolean);
    }

    // Eventos
    $("#btnPing").addEventListener("click", ping);

    $("#btnRead").addEventListener("click", async () => {
      try {
        const f = $("#file").files[0];
        if (!f) { alert("Escolha um .xlsx"); return; }
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const sheetName = wb.SheetNames.find(n => /UNIFICADA/i.test(n)) || wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];
        const jsonRaw = XLSX.utils.sheet_to_json(sheet, { defval: null });
        rows = sanitizeRows(jsonRaw);
        $("#fileInfo").textContent = `Arquivo: ${f.name} — Aba: ${sheetName} — Linhas: ${rows.length}`;
        log("📄 Arquivo lido", { nome:f.name, sheet: sheetName, linhas: rows.length });
        const cols = Object.keys(rows[0] || {});
        fillSelectOptions(cols);
        log("🔧 Amostra mapeada (1ª linha)", rows[0] || {});
      } catch (e) { log("❌ Erro lendo Excel", e); alert("Erro lendo o Excel (ver Debug)."); }
    });

    $("#btnPreview").addEventListener("click", () => {
      if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
      const map = getMap();
      const prev = mapRows(rows.slice(0,5), map);
      log("✅ Prévia (5 linhas)", prev);
    });

    $("#btnInsert").addEventListener("click", async () => {
      try {
        if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
        await initClient();
        const map = getMap();
        const data = mapRows(rows, map);

        let semData = 0;
        for (const r of data) if (!r.data_venda) semData++;
        if (semData) log("⚠️ Linhas sem data_venda:", semData);

        const chunk = 2000;
        let ok=0, fail=0;
        for (let i=0;i<data.length;i+=chunk){
          const lote = data.slice(i, i+chunk);
          const { error } = await SB.from("vendas_import_csv_v2").insert(lote);
          if (error) { fail += lote.length; log({ lote:[i, i+lote.length], error }); }
          else { ok += lote.length; log("✅ Lote inserido", { lote:[i, i+lote.length] }); }
        }
        setPill("#insInfo", `Inserção concluída — ok: ${ok} / falhas: ${fail}`, fail?"warn":"ok");
        log("📦 Inserção concluída", { ok, fail });
      } catch (e) { log("❌ Erro inserindo", e); alert("Erro inserindo (ver Debug)."); }
    });

    $("#btnAutoRange").addEventListener("click", async ()=>{
      try {
        await initClient();
        let minDia="", maxDia="";
        {
          const a = await SB.from("vw_vendas").select("dia").order("dia",{ascending:true}).limit(1);
          const b = await SB.from("vw_vendas").select("dia").order("dia",{ascending:false}).limit(1);
          if (!a.error && a.data?.length) minDia = a.data[0].dia;
          if (!b.error && b.data?.length) maxDia = a.data?.length ? b.data[0].dia : "";
        }
        if (!minDia || !maxDia) {
          const a = await SB.from("vendas_import_csv_v2").select("data_venda").not("data_venda","is",null).order("data_venda",{ascending:true}).limit(1);
          const b = await SB.from("vendas_import_csv_v2").select("data_venda").not("data_venda","is",null).order("data_venda",{ascending:false}).limit(1);
          if (!minDia && !a.error && a.data?.length) minDia = a.data[0].data_venda;
          if (!maxDia && !b.error && b.data?.length) maxDia = b.data[0].data_venda;
        }
        $("#dini").value = minDia || "";
        $("#dfim").value = maxDia || "";
        log("🗓️ Intervalo auto", { minDia, maxDia });
      } catch(e){ log("⚠️ AutoRange falhou", e); }
    });

    $("#btnLoadLists").addEventListener("click", async ()=>{
      try{
        await initClient();
        let dini = normalizeInputDate($("#dini").value);
        let dfim = normalizeInputDate($("#dfim").value);
        if (!dini || !dfim) { await $("#btnAutoRange").click(); dini=$("#dini").value; dfim=$("#dfim").value; }
        const [unids, lojas, turnos, canais, pags] = await Promise.all([
          distinctValues("unidade", dini, dfim),
          distinctValues("loja", dini, dfim),          // <- loja REAL
          distinctValues("turno", dini, dfim),
          distinctValues("canal", dini, dfim),
          distinctValues("pagamento_base", dini, dfim),
        ]);
        fillMulti("f_unids", unids);
        fillMulti("f_lojas", lojas);
        fillMulti("f_turnos", turnos);
        fillMulti("f_canais", canais);
        fillMulti("f_pags",   pags);
        log("🔎 Listas carregadas", {
          unids: unids.length, lojas: lojas.length, turnos: turnos.length, canais: canais.length, pags: pags.length
        });
      }catch(e){ log("⚠️ loadLists erro", e); }
    });

    $("#btnSmoke").addEventListener("click", async ()=>{
      try{
        await initClient();
        let dini = normalizeInputDate($("#dini").value) || "2025-01-01";
        let dfim = normalizeInputDate($("#dfim").value) || dini;
        ({dini, dfim} = clampRange(dini, dfim));

        const p_unids = selectedMulti("f_unids");
        const p_lojas = selectedMulti("f_lojas");
        const p_turnos = selectedMulti("f_turnos");
        const p_canais = selectedMulti("f_canais");
        const p_pags  = selectedMulti("f_pags");

        const args = {
          p_dini: dini, p_dfim: dfim,
          p_unids: p_unids.length? p_unids : null,
          p_lojas: p_lojas.length? p_lojas : null,
          p_turnos: p_turnos.length? p_turnos : null,
          p_canais: p_canais.length? p_canais : null,
          p_pags:  p_pags.length?  p_pags  : null,
          p_cancelado: null
        };

        // KPI
        const k = await SB.rpc("kpi_vendas_v2", args);
        if (k.error) { log("⚠️ KPI erro", k.error); $("#smk").textContent = "⚠️ KPI indisponível"; return; }
        const kpi = Array.isArray(k.data) ? k.data[0] : k.data;
        log("→ KPI params", args); log("✅ KPI", kpi);

        // Charts
        const [d, m, h] = await Promise.all([
          SB.rpc("chart_vendas_dow_v2", args),
          SB.rpc("chart_vendas_mes_v2", args),
          SB.rpc("chart_vendas_hora_v2", args),
        ]);
        if (d.error || m.error || h.error) {
          log("⚠️ chart erros", { dow:d.error, mes:m.error, hora:h.error });
          $("#smk").textContent = "⚠️ Charts indisponíveis"; return;
        }
        const sum = (arr, key) => (arr||[]).reduce((s,x)=>s+Number(x[key]||0),0);
        const sd = sum(d.data,"total"), sm = sum(m.data,"total"), sh = sum(h.data,"total");
        const fat = Number(kpi?.fat || 0);

        const fmt = (x)=>Number(x).toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2});
        const ok = Math.abs(sd-fat)<1e-6 && Math.abs(sm-fat)<1e-6 && Math.abs(sh-fat)<1e-6;
        $("#smk").textContent = `DOW ${Math.abs(sd-fat)<1e-6?"✅":"❌"} soma=${fmt(sd)} vs KPI=${fmt(fat)}  | `+
                                `MÊS ${Math.abs(sm-fat)<1e-6?"✅":"❌"} soma=${fmt(sm)} vs KPI=${fmt(fat)}  | `+
                                `HORA ${Math.abs(sh-fat)<1e-6?"✅":"❌"} soma=${fmt(sh)} vs KPI=${fmt(fat)}  -> ${ok?"OK":"MISMATCH"}`;
        log("🧪 Smoke", { dow:sd, mes:sm, hora:sh, fat, ok });
      } catch(e){ $("#smk").textContent = "❌ Smoke test falhou (ver Debug)"; log("❌ Smoke", e); }
    });

    // start
    (async function start(){ try { await ping(); } catch(_){}})();
  </script>
</body>
</html>
