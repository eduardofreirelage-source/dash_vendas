<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maestro Food — XLSX (sem gráfico)</title>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#e5e7eb;--ink2:#cbd5e1;--brand:#3b82f6}
  *{box-sizing:border-box} body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .row{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px}
  label{display:block;color:var(--ink2);margin-bottom:6px}
  select,input[type=date]{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:var(--ink)}
  button{padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#1f2937;color:#fff;cursor:pointer}
  button.primary{background:var(--brand)}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi .t{color:var(--ink2);font-size:12px}
  .kpi .v{font-size:22px;font-weight:700}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left;white-space:nowrap}
  th{color:var(--ink2);font-weight:600}
  .progress{height:10px;background:#111827;border-radius:10px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#10b981,#22c55e);transition:width .2s}
  .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #1f2937;margin-right:6px}
  .hr{height:1px;background:#1f2937;margin:12px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food — KPIs & Auditoria (XLSX)</h1>

  <!-- Health -->
  <div class="card">
    <div class="row g3">
      <div>
        <button id="btnHealth" class="primary">Executar healthcheck</button>
        <div id="health" class="muted" style="margin-top:8px">—</div>
      </div>
      <div>
        <div class="pill" id="source">Fonte: vendas_xlsx</div>
        <div class="pill" id="periodo">Intervalo: —</div>
        <div class="pill" id="total">Total: —</div>
      </div>
      <div>
        <div class="pill">URL: uahmcfzerofhzjvlzrqc.supabase.co</div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card">
    <div class="row g4">
      <div>
        <label>De</label>
        <input type="date" id="dini">
      </div>
      <div>
        <label>Até</label>
        <input type="date" id="dfim">
      </div>
      <div>
        <label>Unidade</label>
        <select id="unidade"><option value="">Todas</option></select>
      </div>
      <div>
        <label>Loja (sem vazias/“Loja Centro”)</label>
        <select id="loja"><option value="">Todas</option></select>
      </div>
      <div>
        <label>Canal</label>
        <select id="canal"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Pagamento</label>
        <select id="pag"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Cancelado?</label>
        <select id="canc">
          <option value="Todos">Todos</option>
          <option value="Não" selected>Não</option>
          <option value="Sim">Sim</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button class="primary" id="apply">Aplicar</button>
        <button id="clear">Limpar</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g4">
    <div class="card kpi"><div class="t">Pedidos</div><div id="k_ped" class="v">—</div></div>
    <div class="card kpi"><div class="t">Faturamento</div><div id="k_fat" class="v">—</div></div>
    <div class="card kpi"><div class="t">Ticket Médio</div><div id="k_tick" class="v">—</div></div>
    <div class="card kpi"><div class="t">Faturamento Líquido</div><div id="k_fatl" class="v">—</div></div>
  </div>
  <div class="row g3" style="margin-top:12px">
    <div class="card kpi"><div class="t">Incentivos (Descontos)</div><div id="k_des" class="v">—</div></div>
    <div class="card kpi"><div class="t">Frete</div><div id="k_fre" class="v">—</div></div>
    <div class="card kpi"><div class="t">Período aplicado</div><div id="k_per" class="v muted">—</div></div>
  </div>

  <!-- Resumo + Prévia -->
  <div class="card">
    <div id="resumo" class="muted">Resumo do filtro aparecerá aqui…</div>
    <div class="hr"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
      <div class="muted" id="paginainfo">página 1</div>
      <div style="display:flex;gap:8px">
        <button id="prev">&lt;</button>
        <button id="next">&gt;</button>
      </div>
    </div>
    <div style="overflow:auto; max-height:420px">
      <table id="tprev">
        <thead>
          <tr>
            <th>dia</th><th>hora</th><th>unidade</th><th>Nome da loja</th><th>Canal</th><th>pagamento</th>
            <th>cancelado</th><th>pedidos</th><th>fat</th><th>des</th><th>fre</th><th>turno</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Import XLSX -->
  <div class="card">
    <div class="row g3">
      <div>
        <label>Arquivo .xlsx</label>
        <input type="file" id="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button class="primary" id="import">Importar XLSX (upsert)</button>
        <div id="istatus" class="muted">—</div>
      </div>
      <div>
        <div class="progress"><div class="bar" id="ibar"></div></div>
      </div>
    </div>
    <div class="muted" style="margin-top:8px">
      Dedup: <code>row_key</code> (upsert). Lojas vazias e “Loja Centro” **não** entram nos KPIs/linhas.
    </div>
  </div>
</div>

<script>
/* ==========================
   CONFIG SUPABASE
========================== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const TABLE = 'vendas_xlsx';

/* ==========================
   HELPERS
========================== */
const sel = id => document.getElementById(id);
function brMoney(n){ return 'R$ ' + Number(n||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmt(d){ if(!d) return ''; const [y,m,dd] = String(d).split('-'); return `${dd}/${m}/${y}`; }
function parseNum(v){ if(v==null||v==='') return 0; if(typeof v==='number') return v; const s=String(v).replace(/\./g,'').replace(',','.'); const n=Number(s); return isFinite(n)?n:0; }
function normStr(s){ return String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }
function safe(v){ return (v==null?'':String(v)).trim(); }
function onlyHour(hhmm){ const m=String(hhmm||'').match(/(\d{1,2})/); return m?Math.max(0,Math.min(23,parseInt(m[1],10))):null; }
function toISOFromBR(s){ // "dd/mm/aaaa hh:mm"
  if(!s) return null;
  const m = String(s).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
  if(!m) return null;
  const [_,d,mo,y,h='00',mi='00'] = m;
  const iso = `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}T${String(h).padStart(2,'0')}:${mi}:00`;
  return { dia: iso.slice(0,10), hora: Number(h) };
}
function turnoFromHour(h){
  if(h==null) return null;
  if(h>=6 && h<12) return 'Manhã';
  if(h>=12 && h<18) return 'Tarde';
  if(h>=18 && h<24) return 'Noite';
  return 'Madrugada';
}
function basePayment(p){
  const s = normStr(p).toLowerCase();
  if(!s) return null;
  if(s.includes('pix')) return 'PIX';
  if(s.includes('dinheiro')) return 'Dinheiro';
  if(s.includes('cartao') || s.includes('cartão')) return 'Cartão';
  if(s.includes('online')) return 'Pago Online';
  if(s.includes('consumo funcionario')||s.includes('consumo funcionario')) return 'Consumo Funcionário';
  if(s.includes('nao cadastrado')||s.includes('não cadastrado')) return 'Pagamento não cadastrado';
  return p;
}
function makeRowKey(n){
  const base = [
    n.dia, n.unidade, safe(n["Nome da loja"]), n.hora,
    safe(n.pagamento), safe(n["Canal de venda"]), n.pedidos,
    n.fat.toFixed(2), n.des.toFixed(2), n.fre.toFixed(2), safe(n.cancelado)
  ].join('|');
  let h=0; for(let i=0;i<base.length;i++){ h=(h*31+base.charCodeAt(i))|0; }
  return 'rk_' + (h>>>0).toString(16);
}

/* ==========================
   HEALTH + OPÇÕES
========================== */
async function loadOptionsAndHealth(){
  // opções
  const op = await sb.rpc('dash_options_xlsx_v1');
  if(op.error){ sel('health').textContent = 'Erro ao ler opções: '+op.error.message; return; }
  const data = op.data || {};
  fillSelect('unidade', data.unidades||[]);
  fillSelect('loja', (data.lojas||[]));
  fillSelect('canal', data.canais||[]);
  fillSelect('pag', data.pagamentos||[]);
  if(data.periodo){
    sel('periodo').textContent = `Intervalo: ${data.periodo.min||'—'} → ${data.periodo.max||'—'}`;
    sel('total').textContent = `Total: ${data.periodo.total||0}`;
    if(data.periodo.min) sel('dini').value = data.periodo.min;
    if(data.periodo.max) sel('dfim').value = data.periodo.max;
  }
  // health
  await runHealth();
}
function fillSelect(id, arr){
  const el = sel(id);
  const cur = el.value;
  el.innerHTML = `<option value="">${id==='pag'?'Todos':'Todas'}</option>`;
  (arr||[]).forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v; opt.textContent=v; el.appendChild(opt);
  });
  if(cur) el.value=cur;
}
async function runHealth(){
  const h = await sb.rpc('dash_health_xlsx_v1');
  if(h.error){ sel('health').textContent = 'Erro: '+h.error.message; return; }
  const row = (h.data||[])[0]||{};
  sel('health').innerHTML =
    `Total (count exato): <b>${row.total||0}</b><br/>`+
    `Cancelado normalizado — Sim: <b>${row.cancelado_sim||0}</b>, Não: <b>${row.cancelado_nao||0}</b>`;
}

/* ==========================
   APLICAR / LIMPAR / PÁGINA
========================== */
let page=0, LIMIT=200;
sel('apply').onclick = ()=>{ page=0; applyFilters(); };
sel('clear').onclick = ()=>{
  ['unidade','loja','canal','pag'].forEach(id=> sel(id).value='');
  sel('canc').value='Não';
  page=0; applyFilters();
};
sel('prev').onclick = ()=>{ if(page>0){ page--; applyFilters(); } };
sel('next').onclick = ()=>{ page++; applyFilters(); };

async function applyFilters(){
  const f = currentFilters();
  // KPIs
  const k = await sb.rpc('dash_kpis_xlsx_v1', f);
  if(k.error){ console.error(k.error); return; }
  const d = (k.data||[])[0]||{};
  sel('k_ped').textContent = (d.pedidos||0).toLocaleString('pt-BR');
  sel('k_fat').textContent = brMoney(d.fat||0);
  sel('k_tick').textContent = brMoney(d.ticket_medio||0);
  sel('k_fatl').textContent = brMoney(d.fat_liquido||0);
  sel('k_des').textContent = brMoney(d.descontos||0);
  sel('k_fre').textContent = brMoney(d.fretes||0);
  sel('k_per').textContent = `${fmt(f._dini)} → ${fmt(f._dfim)}`;
  // Resumo
  sel('resumo').textContent =
    `Período: ${fmt(f._dini)} → ${fmt(f._dfim)} | Unidade: ${f._unidade||'Todas'} | `+
    `Loja: ${f._loja||'Todas'} | Canal: ${f._canais?f._canais.join(', '):'Todos'} | `+
    `Pagamento: ${f._pagamentos?f._pagamentos.join(', '):'Todos'} | Cancelado: ${f._cancelado||'Todos'}`;
  // Linhas (prévia paginada)
  await loadRows();
}
async function loadRows(){
  const f = currentFilters();
  const r = await sb.rpc('dash_rows_xlsx_v1', { ...f, _limit: LIMIT, _offset: page*LIMIT });
  const tb = sel('tprev').querySelector('tbody');
  tb.innerHTML='';
  (r.data||[]).forEach(x=>{
    const tr=document.createElement('tr');
    const cells=[x.dia,x.hora,x.unidade,x["Nome da loja"],x["Canal de venda"],x.pagamento,x.cancelado,x.pedidos,Number(x.fat).toFixed(2),Number(x.des).toFixed(2),Number(x.fre).toFixed(2),x.turno];
    cells.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
    tb.appendChild(tr);
  });
  sel('paginainfo').textContent = `página ${page+1}${(r.data||[]).length<LIMIT?' (fim)':''}`;
}
function currentFilters(){
  const getA = id=>{ const v=sel(id).value; return v? [v] : null; }
  return {
    _dini: sel('dini').value||null,
    _dfim: sel('dfim').value||null,
    _unidade: sel('unidade').value||null,
    _loja: sel('loja').value||null,
    _canais: sel('canal').value? [sel('canal').value] : null,
    _pagamentos: sel('pag').value? [sel('pag').value] : null,
    _cancelado: sel('canc').value||'Todos'
  };
}

/* ==========================
   IMPORTAÇÃO XLSX (UPSERT)
========================== */
sel('import').onclick = importXLSX;
sel('btnHealth').onclick = runHealth;

async function importXLSX(){
  const file = sel('file').files[0];
  if(!file){ sel('istatus').textContent='Selecione um .xlsx'; return; }
  sel('istatus').textContent='Lendo planilha…';
  const bar = sel('ibar'); bar.style.width='0%';

  // 1) Ler planilha
  const wb = await file.arrayBuffer().then(buf => XLSX.read(buf, {type:'array'}));
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, {defval:''}); // array de objetos
  if(rows.length===0){ sel('istatus').textContent='Planilha vazia.'; return; }

  // 2) Normalizar e enviar por lotes com upsert
  const BATCH = 1000;
  let ok=0, err=0;

  for(let i=0;i<rows.length;i+=BATCH){
    const batchRaw = rows.slice(i, i+BATCH);
    const pack = [];
    for(const r of batchRaw){
      const n = normalizeRow(r);
      if(n) { n.row_key = makeRowKey(n); pack.push(n); }
      else err++;
    }
    if(pack.length){
      const up = await sb.from(TABLE).upsert(pack, { onConflict: 'row_key' });
      if(up.error){ console.error('Upsert error:', up.error); err += pack.length; }
      else ok += pack.length;
    }
    const p = Math.min(100, Math.round(((i+BATCH)/rows.length)*100));
    bar.style.width = p+'%';
    sel('istatus').textContent = `Enviando… ${Math.min(i+BATCH,rows.length)} / ${rows.length} (ok: ${ok}, erros: ${err})`;
    await new Promise(r=>setTimeout(r,0)); // yield
  }

  sel('istatus').textContent = `Concluído. OK: ${ok}, Erros: ${err}`;
  await loadOptionsAndHealth();
  await applyFilters();
}

// mapa de headers -> campos
const HEADER = {
  dia: ['Data da venda','data','dia'],
  unidade: ['Unidade','unidade','Código da loja','Codigo da loja','cod loja'],
  loja: ['Nome da loja','Loja','nome da loja'],
  canal: ['Canal de venda','canal','Canal'],
  pagamento: ['Pagamento','Forma de pagamento','pagamento'],
  cancelado: ['Está cancelado','esta cancelado','Cancelado','cancelado'],
  total: ['Total','Valor Total','total'],
  desconto: ['Desconto','desconto'],
  entrega: ['Entrega','Frete','frete','Taxa de entrega'],
  turno: ['Turno','turno'],
  hora: ['Hora','horario','horário']
};
function getByHeader(row, keys){
  for(const k of keys){ if(k in row && String(row[k]).trim()!=='') return row[k]; }
  return '';
}
function unidadeFrom(row){
  const u = getByHeader(row, HEADER.unidade);
  if(u) return String(u).trim();
  const loja = getByHeader(row, HEADER.loja);
  const s = normStr(loja).toLowerCase();
  if(!s) return null;
  if(s.includes('savassi')) return 'Uni.Savassi';
  if(s.includes('raja')) return 'Uni.Raja';
  if(s.includes('centro')) return 'Uni.Raja'; // fallback
  return null;
}
function normalizeRow(r){
  // dia + hora
  const dsrc = getByHeader(r, HEADER.dia);
  const iso = toISOFromBR(String(dsrc));
  if(!iso) return null;
  const dia = iso.dia;
  const hora = onlyHour(iso.hora);
  // loja / filtros de exclusão
  const loja = safe(getByHeader(r, HEADER.loja)) || null;
  if(loja===null || loja==='' || loja==='Loja Centro') return null; // exclui na ingestão também
  // unidade
  const unidade = unidadeFrom(r) || null;
  // monetários
  const fat = parseNum(getByHeader(r, HEADER.total));
  const des = parseNum(getByHeader(r, HEADER.desconto));
  const fre = parseNum(getByHeader(r, HEADER.entrega));
  // outros
  const pagamento = safe(getByHeader(r, HEADER.pagamento)) || null;
  const pagamento_base = basePayment(pagamento);
  let cancelado = safe(getByHeader(r, HEADER.cancelado));
  cancelado = cancelado ? (/(^s|sim|true|1)/i.test(cancelado)?'Sim':'Não') : 'Não';
  const turn = safe(getByHeader(r, HEADER.turno)) || turnoFromHour(iso.hora) || null;

  return {
    dia, hora: iso.hora, unidade,
    "Nome da loja": loja,
    "Canal de venda": safe(getByHeader(r, HEADER.canal)) || null,
    pagamento, pagamento_base,
    cancelado, pedidos: 1,
    fat, des, fre, turno: turn
  };
}

/* ==========================
   BOOT
========================== */
(async function(){
  await loadOptionsAndHealth();
  await applyFilters();
})();
</script>
</body>
</html>
