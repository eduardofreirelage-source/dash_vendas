<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- evita 404 do favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%232563eb'/%3E%3Ctext x='32' y='41' font-size='32' text-anchor='middle' fill='white'%3EM%3C/text%3E%3C/svg%3E">

  <style>
    :root{
      --bg:#f6f7fb; --fg:#0f172a; --mut:#64748b; --card:#fff; --brd:#e5e7eb;
      --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0}
    .muted{color:var(--mut);font-size:12px}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}

    .grid{display:grid;gap:12px}
    .cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:960px){ .cols-4{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:560px){ .cols-4,.cols-3,.cols-2{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--mut)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)}

    details.filter{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filter>summary{padding:12px 14px;list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-weight:700}
    details.filter[open]>summary{border-bottom:1px solid var(--brd)}
    .fbody{padding:12px 14px}
    .fgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .c12{grid-column:span 12}.c6{grid-column:span 6}.c4{grid-column:span 4}.c3{grid-column:span 3}
    @media (max-width:960px){ .fgrid{grid-template-columns:repeat(6,1fr)} .c6{grid-column:span 6}.c4{grid-column:span 6}.c3{grid-column:span 3} }
    @media (max-width:560px){ .fgrid{grid-template-columns:repeat(4,1fr)} .c3,.c4,.c6{grid-column:span 4} }

    .seg{display:flex;gap:8px;align-items:center}
    .lbl{font-size:12px;color:var(--mut);white-space:nowrap}
    select,input,button{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    input[type="date"]{padding:7px 10px}
    button{cursor:pointer}
    .ghost{background:#fff}
    .right{margin-left:auto}

    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 12px;background:#fff}
    .pill button.active{background:var(--accent);color:#fff}

    .chartbox{position:relative;height:300px;width:100%}
    .hint{font-size:12px;color:var(--mut);margin-top:6px}

    /* AUTH */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--mut);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>
  <!-- ========= AUTH ========= -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Entrar no Maestro Food</h3>
      <div class="tabs">
        <button id="tLogin" class="active">Entrar</button>
        <button id="tSign">Criar conta</button>
      </div>
      <div class="field">
        <label for="aEmail">E-mail</label>
        <input id="aEmail" type="email" autocomplete="email" placeholder="voce@empresa.com">
      </div>
      <div class="field">
        <label for="aPass">Senha</label>
        <input id="aPass" type="password" autocomplete="current-password" placeholder="••••••••">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="bLogin">Entrar</button>
        <button id="bSign" style="display:none">Criar conta</button>
      </div>
      <div class="error" id="authMsg"></div>
      <div class="muted" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <span>Ao criar conta você concorda com o uso autorizado.</span>
        <button id="bForgot" class="ghost" style="padding:4px 6px">Esqueci a senha</button>
      </div>
    </div>
  </div>

  <!-- ========= APP ========= -->
  <div class="wrap" id="app" style="display:none">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <div class="topbar">
        <span class="muted" id="who"></span>
        <button id="bLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filter" id="fx">
      <summary>
        FILTROS
        <button class="ghost right" id="bClear" title="Limpar filtros">Limpar</button>
      </summary>
      <div class="fbody">
        <div class="fgrid">
          <div class="c6 seg"><span class="lbl">Unidade</span><select id="fUni" class="grow"><option>Todas</option></select></div>
          <div class="c6 seg"><span class="lbl">Nome da loja (Top 10)</span><select id="fLoja" class="grow"><option value="">Todas</option></select></div>

          <div class="c3 seg"><span class="lbl">De</span><input type="date" id="fDe" class="grow"></div>
          <div class="c3 seg"><span class="lbl">Até</span><input type="date" id="fAte" class="grow"></div>
          <div class="c3 seg">
            <span class="lbl">Período rápido</span>
            <select id="fPr" class="grow">
              <option value="7">Últimos 7</option>
              <option value="15">Últimos 15</option>
              <option value="30" selected>Últimos 30</option>
              <option value="90">Últimos 90</option>
              <option value="180">Últimos 180</option>
            </select>
          </div>
          <div class="c3 seg">
            <span class="lbl">Turno</span>
            <select id="fTurno" class="grow">
              <option value="">Todos</option>
              <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>

          <div class="c4 seg"><span class="lbl">Canal de venda</span><select id="fCanal" class="grow"><option value="">Todos</option></select></div>
          <div class="c4 seg"><span class="lbl">Pagamento</span><select id="fPag" class="grow"><option value="">Todos</option></select></div>
          <div class="c4 seg">
            <span class="lbl">Está cancelado?</span>
            <select id="fCanc" class="grow">
              <option>Todos</option><option>Sim</option><option selected>Não</option>
            </select>
          </div>

          <div class="c12 card" style="border-style:dashed">
            <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>) · não sobrescreve, **soma** e remove duplicados automaticamente
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
              <input type="file" id="csv" accept=".csv" />
              <button id="bImport">Importar CSV</button>
              <progress id="prog" value="0" max="100" style="display:none"></progress>
              <span class="muted" id="impTag" style="display:none">Importado.</span>
              <span class="muted" id="impWarn" style="color:#b91c1c"></span>
            </div>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
    </div>

    <!-- GRÁFICO diário -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária (R$) — sombra = período anterior</div>
        <div class="pill" id="mLine">
          <button class="active" data-v="total">Total</button>
          <button data-v="media">Média (7d)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>
  </div>

<script>
(function(){
  // ===== Credenciais =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2";       // leitura
  const STAGE = "vendas_kpi_daily_v2_data";  // escrita (append + dedupe)

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{persistSession:true} });

  // ===== Helpers =====
  const $ = (s)=>document.querySelector(s);
  const fmtBRL = (n)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = (n)=> new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = (d)=> d.toISOString().slice(0,10);
  const addDays = (iso, k)=>{ const d=new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+k); return toISO(d); };
  const uniq = (a)=>Array.from(new Set(a));
  const sum = (arr,k)=>arr.reduce((s,r)=>s+Number(r[k]||0),0);
  const parseBR = (s)=>{ if(s==null||s==="") return 0; return Number(String(s).replace(/\./g,"").replace(",",".")); };
  function setDelta(el,cur,ant){ const p = ant>0 ? ((cur-ant)/ant*100) : 0; el.className="delta "+(p>=0?"up":"down"); el.textContent=(p>=0?"+":"")+p.toFixed(1)+"%"; }
  async function sha1(s){ const buf = await crypto.subtle.digest("SHA-1", new TextEncoder().encode(s)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }

  // ===== Auth =====
  const gate=$("#gate"), app=$("#app"), who=$("#who");
  const tLogin=$("#tLogin"), tSign=$("#tSign"), bLogin=$("#bLogin"), bSign=$("#bSign"), bForgot=$("#bForgot");
  const aEmail=$("#aEmail"), aPass=$("#aPass"), authMsg=$("#authMsg");
  const bLogout=$("#bLogout");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function showApp(){ gate.style.display="none"; app.style.display="block"; }

  tLogin.onclick=()=>{ tLogin.classList.add("active"); tSign.classList.remove("active"); bLogin.style.display="inline-block"; bSign.style.display="none"; authMsg.textContent=""; };
  tSign.onclick =()=>{ tSign.classList.add("active"); tLogin.classList.remove("active"); bSign.style.display="inline-block"; bLogin.style.display="none"; authMsg.textContent=""; };

  bLogin.onclick=async ()=>{ authMsg.textContent=""; const {error}=await supa.auth.signInWithPassword({email:aEmail.value, password:aPass.value}); if(error){authMsg.textContent=error.message;return;} afterLogin(); };
  bSign.onclick =async ()=>{ authMsg.textContent=""; const {error}=await supa.auth.signUp({email:aEmail.value, password:aPass.value}); authMsg.textContent = error? error.message : "Conta criada. Verifique seu e-mail (se necessário)."; };
  bForgot.onclick=async ()=>{ authMsg.textContent=""; if(!aEmail.value){authMsg.textContent="Informe o e-mail.";return;} const {error}=await supa.auth.resetPasswordForEmail(aEmail.value,{redirectTo:location.href}); authMsg.textContent = error? error.message : "Se o e-mail existir, enviarei o link de redefinição."; };
  bLogout.onclick=async ()=>{ await supa.auth.signOut(); showGate(); };

  supa.auth.onAuthStateChange((_e,s)=>{ if(s){ afterLogin(); } else { showGate(); } });

  async function afterLogin(){ const {data:{user}}=await supa.auth.getUser(); who.textContent=user?.email||""; showApp(); boot(); }

  // ===== Filtros / elementos =====
  const fUni=$("#fUni"), fLoja=$("#fLoja"), fDe=$("#fDe"), fAte=$("#fAte"), fPr=$("#fPr"), fTurno=$("#fTurno"), fCanal=$("#fCanal"), fPag=$("#fPag"), fCanc=$("#fCanc");
  const periodo=$("#periodo");
  const csv=$("#csv"), bImport=$("#bImport"), prog=$("#prog"), tag=$("#impTag"), warn=$("#impWarn");
  let maxISO=null, chartLine=null, lineMode="total";

  $("#mLine").addEventListener("click",(e)=>{
    if(e.target.tagName!=="BUTTON") return;
    Array.from($("#mLine").children).forEach(b=>b.classList.remove("active"));
    e.target.classList.add("active");
    lineMode=e.target.getAttribute("data-v");
    refresh();
  });

  $("#bClear").onclick=function(){
    fUni.value="Todas"; fLoja.value=""; fTurno.value=""; fCanal.value=""; fPag.value="";
    fCanc.value="Não"; fPr.value="30"; fDe.value=""; fAte.value="";
    $("#fx").open=false; refresh();
  };

  [fUni,fLoja,fDe,fAte,fPr,fTurno,fCanal,fPag,fCanc].forEach(el=> el.addEventListener("change",()=>{
    if(el===fPr && maxISO){ fAte.value=maxISO; fDe.value=addDays(maxISO, -(Number(fPr.value||30)-1)); }
    $("#fx").open=false; refresh();
  }));

  // ===== Boot (limites + opções) =====
  async function boot(){
    const r1=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r1.error||r2.error){ periodo.textContent="Período: —"; return; }
    const minISO=r1.data[0]?.dia||null; maxISO=r2.data[0]?.dia||null;
    if(maxISO){ fAte.value=maxISO; fDe.value=addDays(maxISO,-29); periodo.textContent=`Período: ${fDe.value} → ${fAte.value}`; }
    if(minISO){ fDe.min=minISO; fAte.min=minISO; fDe.max=maxISO; fAte.max=maxISO; }

    const u=await supa.from(TABLE).select("unidade").limit(50000);
    const UU=uniq((u.data||[]).map(x=>(x.unidade||"").trim()).filter(Boolean)).sort();
    fUni.innerHTML=`<option>Todas</option>${UU.map(v=>`<option>${v}</option>`).join("")}`;

    const cp=await supa.from(TABLE).select('"Canal de venda",pagamento').limit(100000);
    const canals=uniq((cp.data||[]).map(x=>x["Canal de venda"]).filter(Boolean)).sort();
    const pags  =uniq((cp.data||[]).map(x=>x.pagamento).filter(Boolean)).sort();
    fCanal.innerHTML=`<option value="">Todos</option>${canals.map(v=>`<option>${v}</option>`).join("")}`;
    fPag.innerHTML  =`<option value="">Todos</option>${pags.map(v=>`<option>${v}</option>`).join("")}`;

    const t=await supa.from(TABLE).select('"Nome da loja",fat').limit(200000);
    const agg={}; (t.data||[]).forEach(r=>{ const n=r["Nome da loja"]; if(!n) return; agg[n]=(agg[n]||0)+Number(r.fat||0); });
    const top10=Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
    fLoja.innerHTML = `<option value="">Todas</option>${top10.map(v=>`<option>${v}</option>`).join("")}`;

    refresh();
  }

  // ===== Query principal =====
  async function fetchRange(startISO,endISO){
    let q = supa.from(TABLE).select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
      .gte("dia",startISO).lte("dia",endISO).order("dia",{ascending:true});
    if(fUni.value && fUni.value!=="Todas") q=q.eq("unidade", fUni.value);
    if(fLoja.value)  q=q.eq("Nome da loja", fLoja.value);
    if(fTurno.value) q=q.eq("turno", fTurno.value);
    if(fCanal.value) q=q.eq("Canal de venda", fCanal.value);
    if(fPag.value)   q=q.eq("pagamento", fPag.value);
    if(fCanc.value!=="Todos") q=q.eq("cancelado", fCanc.value);
    const r = await q.range(0,499999);
    if(r.error) throw r.error;
    return r.data||[];
  }

  function movingAvg(a,n){ const out=[]; let acc=0; for(let i=0;i<a.length;i++){ acc+=a[i]; if(i>=n) acc-=a[i-n]; out.push(acc/Math.min(i+1,n)); } return out; }
  function drawLine(labels,vals,prev){
    if(chartLine){ try{chartLine.destroy();}catch(e){} }
    const ctx=$("#cLine").getContext("2d");
    const data = (lineMode==="media") ? movingAvg(vals,7) : vals;
    chartLine = new Chart(ctx,{type:"line",data:{labels:labels,datasets:[
      {data:prev,fill:true,borderWidth:0,backgroundColor:"rgba(2,132,199,.12)",pointRadius:0,tension:.25},
      {data:data,borderWidth:2,pointRadius:0,tension:.25}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}});
  }

  async function refresh(){
    if(!fDe.value||!fAte.value){ if(maxISO){ fAte.value=maxISO; fDe.value=addDays(maxISO,-29); } }
    periodo.textContent=`Período: ${fDe.value} → ${fAte.value}`;
    const cur = await fetchRange(fDe.value,fAte.value);

    const span = Math.max(1, Math.round((new Date(fAte.value)-new Date(fDe.value))/86400000)+1);
    const prevEnd = addDays(fDe.value,-1);
    const prevStart = addDays(prevEnd, -(span-1));
    const ant = await fetchRange(prevStart, prevEnd);

    const ped=sum(cur,"pedidos"), pedA=sum(ant,"pedidos");
    const fat=sum(cur,"fat"),      fatA=sum(ant,"fat");
    const des=sum(cur,"des"),      desA=sum(ant,"des");
    const fre=sum(cur,"fre"),      freA=sum(ant,"fre");
    const dias=uniq(cur.map(r=>r.dia)).length||1;
    const diasA=uniq(ant.map(r=>r.dia)).length||1;
    const tkm= ped>0?fat/ped:0,      tkmA= pedA>0?fatA/pedA:0;
    const fmd= fat/dias,            fmdA= fatA/diasA;
    const fatL= fat - des - fre - (0.12*fat);
    const fatLA= fatA- desA- freA- (0.12*fatA);
    const desP= fat>0? des/fat*100:0, desPA= fatA>0? desA/fatA*100:0;
    const freM= ped>0? fre/ped:0,     freMA= pedA>0? freA/pedA:0;
    const fatLP= fat>0? fatL/fat*100:0, fatLPA= fatA>0? fatLA/fatA*100:0;

    $("#k_ped").textContent=fmtInt(ped); setDelta($("#d_ped"),ped,pedA);
    $("#k_tkm").textContent=fmtBRL(tkm); setDelta($("#d_tkm"),tkm,tkmA);
    $("#k_fat").textContent=fmtBRL(fat); setDelta($("#d_fat"),fat,fatA);
    $("#k_fmd").textContent=fmtBRL(fmd); setDelta($("#d_fmd"),fmd,fmdA);
    $("#k_des").textContent=fmtBRL(des); setDelta($("#d_des"),des,desA);
    $("#k_desp").textContent=desP.toFixed(1)+"%"; setDelta($("#d_desp"),desP,desPA);
    $("#k_fre").textContent=fmtBRL(fre); setDelta($("#d_fre"),fre,freA);
    $("#k_frem").textContent=fmtBRL(freM); setDelta($("#d_frem"),freM,freMA);
    $("#k_fatl").textContent=fmtBRL(fatL); setDelta($("#d_fatl"),fatL,fatLA);
    $("#k_fatlp").textContent=fatLP.toFixed(1)+"%"; setDelta($("#d_fatlp"),fatLP,fatLPA);

    // linha diária + sombra do período anterior
    const byDay=(list)=>{ const m=new Map(); list.forEach(r=>m.set(r.dia,(m.get(r.dia)||0)+Number(r.fat||0))); const lbl=[...m.keys()].sort(); return {lbl,vals:lbl.map(k=>m.get(k))}; };
    const C=byDay(cur), P=byDay(ant);
    drawLine(C.lbl, C.vals, P.vals);
  }

  // ===== Import CSV (append + dedupe) =====
  bImport.onclick = async function(){
    warn.textContent=""; tag.style.display="none";
    const file = csv.files && csv.files[0];
    if(!file){ alert("Selecione o Pasta2.csv"); return; }
    prog.style.display="inline-block"; prog.value=0;

    // lê CSV
    const rows = await new Promise((ok,ko)=> Papa.parse(file,{header:true,skipEmptyLines:true,dynamicTyping:false,complete:r=>ok(r.data||[]),error:ko}));

    // normalização
    function parseDateParts(s){
      if(!s) return {dia:null,hora:null};
      const m=String(s).match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
      if(!m) return {dia:null,hora:null};
      return {dia:`${m[3]}-${m[2]}-${m[1]}`, hora:Number(m[4])||0};
    }
    const norm=(s)=> (s==null?"":String(s).trim());
    const mapped = rows.map(r=>{
      const dt = parseDateParts(r["Data da venda"]);
      const cancel = (norm(r["Está cancelado"]).toUpperCase()==="S" || norm(r["Está cancelado"])==="Sim") ? "Sim":"Não";
      return {
        dia: dt.dia,
        unidade: norm(r["unidade"]),
        pedidos: 1,
        fat: parseBR(r["Total"]),
        des: parseBR(r["Desconto"]),
        fre: parseBR(r["Entrega"]) + parseBR(r["Valor Entregador"]),
        "Nome da loja": norm(r["Nome da loja"]),
        turno: norm(r["Turno"]),
        "Canal de venda": norm(r["Canal de venda"]),
        pagamento: norm(r["Pagamento"]) || norm(r["Forma de pagamento"]),
        cancelado: cancel,
        hora: dt.hora,
        _np: norm(r["Número do pedido no parceiro"]||"")
      };
    }).filter(r=>r.dia);

    if(mapped.length===0){ prog.style.display="none"; alert("Arquivo sem linhas válidas."); return; }

    // UID forte
    async function makeUID(r){
      const key=[r.dia, r.hora??"", r.unidade, r["Nome da loja"], r["Canal de venda"], r.pagamento, r._np||"", (r.fat??0).toFixed(2), r.cancelado]
        .map(v=>String(v||"").toLowerCase().trim()).join("|");
      return sha1(key);
    }

    // remove duplicados DENTRO do arquivo
    const seen=new Set(); const staged=[];
    for(let i=0;i<mapped.length;i++){
      const u=await makeUID(mapped[i]);
      if(seen.has(u)) continue;
      seen.add(u);
      staged.push({...mapped[i], _uid:u});
    }

    // confere duplicados JÁ NO BANCO (staging) no intervalo do arquivo
    const days=uniq(staged.map(r=>r.dia)).sort(); const sISO=days[0], eISO=days[days.length-1];
    const existQ = await supa.from(STAGE).select('dia,unidade,fat,des,fre,"Nome da loja","Canal de venda",pagamento,cancelado,hora').gte("dia",sISO).lte("dia",eISO).limit(500000);
    const existUID = new Set();
    if(!existQ.error){
      for(const r of (existQ.data||[])){ const u=await makeUID({...r,_np:""}); existUID.add(u); }
    }

    // somente novos
    const final = staged.filter(r=>!existUID.has(r._uid)).map(r=>{ const o={...r}; delete o._uid; delete o._np; return o; });

    // insere em lotes (append)
    const CHUNK=2000; let done=0;
    for(let i=0;i<final.length;i+=CHUNK){
      const slice=final.slice(i,i+CHUNK);
      const ins=await supa.from(STAGE).insert(slice);
      if(ins.error){ warn.textContent="Lote falhou: "+ins.error.message; break; }
      done+=slice.length; prog.value=Math.round(done/final.length*100)||100;
    }

    prog.style.display="none"; tag.style.display="inline"; csv.value="";
    // recarrega limites e dados
    await refresh();
  };

  // start
  (async function init(){
    const {data:{session}} = await supa.auth.getSession();
    if(session){ afterLogin(); } else { showGate(); }
  })();
})();
</script>
</body>
</html>
