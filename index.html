<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Supabase • v10 (filtro por UNIDADE)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb}
      body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--muted);font-size:12px}
      .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
      .card{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .title{font-size:12px;color:var(--muted)}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      .form{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
      .form .cell{display:flex;flex-direction:column;gap:4px}
      label{font-size:12px;color:#374151}
      input,select,button{
        font:inherit;border:1px solid var(--brd);border-radius:8px;padding:8px 10px;background:#fff;outline:none
      }
      button.primary{background:#2563eb;color:#fff;border-color:#2563eb;cursor:pointer}
      button.secondary{background:#fff;color:#111827;cursor:pointer}
      button:disabled{opacity:.55;cursor:not-allowed}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      code{background:#eef2ff;padding:0 4px;border-radius:4px}
      @media (max-width:1000px){.form{grid-template-columns:repeat(3,minmax(0,1fr))}}
      @media (max-width:640px){.form{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">
            Build <b>v10</b> (GitHub Pages) • mapeamento manual • sem <code>max(...)</code>
          </div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <!-- Credenciais (somente exibição) -->
      <div class="card" style="margin-top:12px">
        <div class="title">Credenciais em uso</div>
        <div class="row" style="margin-top:6px;gap:8px">
          <div><b>URL:</b> <code id="cred_url">—</code></div>
          <div><b>Anon key:</b> <code id="cred_key">—</code></div>
        </div>
      </div>

      <!-- Mapeamento manual -->
      <div class="card" style="margin-top:12px">
        <div class="title">Tabela & Mapeamento de Colunas</div>
        <div class="form" style="margin-top:10px">
          <div class="cell">
            <label>Nome da tabela (ex.: <code>vendas</code>)</label>
            <input id="i_tbl" placeholder="vendas" value="vendas" />
          </div>

          <div class="cell">
            <label>Coluna de Data (ex.: <code>data_venda</code>)</label>
            <input id="i_dt" placeholder="data_venda" value="data_venda" />
          </div>

          <div class="cell">
            <label>Valor Total (ex.: <code>valor_total</code>)</label>
            <input id="i_total" placeholder="valor_total" value="valor_total" />
          </div>

          <div class="cell">
            <label>Desconto (ex.: <code>desconto</code>)</label>
            <input id="i_desc" placeholder="desconto" value="desconto" />
          </div>

          <div class="cell">
            <label>Entrega (ex.: <code>entrega</code>)</label>
            <input id="i_frete" placeholder="entrega" value="entrega" />
          </div>

          <div class="cell">
            <label>Unidade (opcional, ex.: <code>unidade</code>)</label>
            <input id="i_unid" placeholder="unidade" value="unidade" />
          </div>

          <div class="cell">
            <label>Hora (opcional, ex.: <code>hora</code>)</label>
            <input id="i_hora" placeholder="hora" />
          </div>

          <div class="cell">
            <label>&nbsp;</label>
            <button id="b_test" class="secondary">Testar tabela & listar colunas</button>
          </div>

          <div class="cell">
            <label>&nbsp;</label>
            <button id="b_load" class="primary">Carregar KPIs (30 dias)</button>
          </div>

          <div class="cell">
            <label>Filtro: UNIDADE</label>
            <select id="sel_unid" disabled>
              <option value="__ALL__">Todas</option>
            </select>
          </div>
        </div>

        <div class="muted" style="margin-top:8px">Colunas detectadas: <span id="det_cols">—</span></div>
      </div>

      <!-- KPIs -->
      <div class="grid" style="margin-top:12px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <!-- Logs -->
      <div class="card" style="margin-top:12px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== (1) CREDENCIAIS (as suas) ======
      var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      // ====== (2) UI refs ======
      var elLog = document.getElementById("log");
      var elCols = document.getElementById("det_cols");
      var elPer = document.getElementById("periodo");
      var elUnid = document.getElementById("sel_unid");

      document.getElementById("cred_url").textContent = SUPABASE_URL;
      document.getElementById("cred_key").textContent = SUPABASE_ANON.slice(0,32) + "…";

      // ====== (3) helpers ======
      function log(m){ elLog.textContent += "\\n" + m; elLog.scrollTop = elLog.scrollHeight; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toNum(x){
        if(x==null||x==="")return 0;
        if(typeof x==="number")return x;
        var s=String(x).trim(); if(!s)return 0;
        var n=Number(s.replace(/\./g,"").replace(/,/g,"."));
        return isFinite(n)?n:0;
      }
      function toISO(d){ return d.toISOString().slice(0,10); }

      // ====== (4) supabase client ======
      var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // ====== (5) pegas de inputs ======
      function getMap(){
        return {
          table: document.getElementById("i_tbl").value.trim(),
          cDate: document.getElementById("i_dt").value.trim(),
          cTot : document.getElementById("i_total").value.trim(),
          cDesc: document.getElementById("i_desc").value.trim(),
          cFre : document.getElementById("i_frete").value.trim(),
          cUnid: document.getElementById("i_unid").value.trim(),
          cHora: document.getElementById("i_hora").value.trim(),
        };
      }

      // ====== (6) testar tabela e listar colunas (sem casts, sem order) ======
      async function testTable(){
        const m = getMap();
        if(!m.table){ log("[ERRO-Teste] Informe o nome da tabela."); return; }
        log("[Test] Buscando 1 linha de "+m.table+" (sem ORDER, sem casts) …");
        const r = await supa.from(m.table).select("*").limit(1);
        if(r.error){ elCols.textContent = "erro: "+r.error.message; log("[ERRO-Teste] "+r.error.message); return; }
        const cols = (r.data && r.data[0]) ? Object.keys(r.data[0]) : [];
        elCols.textContent = cols.length? cols.join(", ") : "vazia ou bloqueada por RLS";
        if(!cols.length){ log("[ERRO-Teste] Tabela vazia ou sem permissão (RLS)."); return; }
        log("[OK] Colunas listadas. Ajuste os campos acima se necessário.");
      }

      // ====== (7) obter última data via ORDER (sem max()) ======
      async function getLastDate(table, cDate){
        const r = await supa.from(table).select(cDate).order(cDate,{ascending:false}).limit(1);
        if(r.error) throw r.error;
        const arr = r.data||[];
        if(!arr.length) throw new Error("Tabela sem linhas.");
        const v = arr[0][cDate];
        if(!v) throw new Error("Última data não encontrada (coluna '"+cDate+"').");
        return String(v).slice(0,10);
      }

      // ====== (8) paginação segura (com filtro opcional de UNIDADE) ======
      async function fetchRange(table, cDate, cTot, cDesc, cFre, cUnid, cHora, fromISO, toISO, unidadeSel){
        const page=10000; let acc=[], off=0;
        for(;;){
          let sel = [cDate,cTot,cDesc,cFre].filter(Boolean).join(",");
          if(cUnid) sel += ","+cUnid;
          if(cHora) sel += ","+cHora;
          let q = supa.from(table).select(sel,{count:"estimated"}).gte(cDate,fromISO).lte(cDate,toISO);
          if(unidadeSel && cUnid && unidadeSel!=="__ALL__") q = q.eq(cUnid, unidadeSel);
          q = q.range(off, off+page-1);
          const r = await q;
          if(r.error) throw r.error;
          const arr = r.data||[];
          acc = acc.concat(arr);
          if(arr.length<page) break;
          off += page;
        }
        return acc;
      }

      // ====== (9) carregar KPIs (últimos 30 dias), povoar UNIDADES e aplicar filtro ======
      async function loadKPIs(){
        const m = getMap();
        if(!m.table || !m.cDate || !m.cTot){ log("[ERRO-Carregar] Informe ao menos: tabela, coluna de data e valor total."); return; }

        // descobrir última data
        log("[Query] "+m.table+" → localizando última data por ORDER em '"+m.cDate+"' …");
        const lastISO = await getLastDate(m.table, m.cDate);
        const end = new Date(lastISO+"T23:59:59");
        const start = new Date(end); start.setDate(end.getDate()-29);
        elPer.textContent = "Período: "+toISO(start)+" → "+toISO(end);

        // obter seleção atual de unidade
        const unidadeSel = elUnid.value || "__ALL__";

        // buscar linhas do período (com/sem unidade)
        log("[Query] Janela "+toISO(start)+" → "+toISO(end)+(unidadeSel!=="__ALL__"?" • Filtro UNIDADE = '"+unidadeSel+"'":""));
        const rows = await fetchRange(m.table, m.cDate, m.cTot, m.cDesc, m.cFre, m.cUnid, m.cHora, toISO(start), toISO(end), unidadeSel);

        log("[OK] Linhas retornadas: "+rows.length.toLocaleString("pt-BR"));

        // KPIs
        let ped=rows.length, fat=0, des=0, fre=0;
        for(const r of rows){
          fat += toNum(r[m.cTot]);
          des += toNum(r[m.cDesc]);
          fre += toNum(r[m.cFre]);
        }
        document.getElementById("k_ped").textContent = fmtInt(ped);
        document.getElementById("k_fat").textContent = fmtBRL(fat);
        document.getElementById("k_desc").textContent = fmtBRL(des);
        document.getElementById("k_fre").textContent = fmtBRL(fre);
        log("[OK] KPIs calculados.");

        // povoar dropdown de UNIDADE (se existir coluna), a partir das linhas do período
        if(m.cUnid){
          const set = new Set(); for(const r of rows){ const u = r[m.cUnid]; if(u!=null && String(u).trim()!=="") set.add(String(u)); }
          const arr = Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
          // reconstruir <select>
          elUnid.innerHTML = "";
          const optAll = document.createElement("option"); optAll.value="__ALL__"; optAll.textContent="Todas"; elUnid.appendChild(optAll);
          for(const u of arr){ const o=document.createElement("option"); o.value=u; o.textContent=u; elUnid.appendChild(o); }
          // manter seleção anterior se existir
          if(unidadeSel!=="__ALL__" && arr.includes(unidadeSel)) elUnid.value = unidadeSel;
          elUnid.disabled = arr.length===0;
          log("[OK] UNIDADES disponíveis: "+arr.length);
        }else{
          elUnid.innerHTML = "<option>Todas</option>";
          elUnid.disabled = true;
          log("[Info] Coluna de UNIDADE não informada — filtro desativado.");
        }
      }

      // ====== (10) eventos ======
      document.getElementById("b_test").addEventListener("click", async ()=>{
        try{ await testTable(); }catch(e){ log("[ERRO-Teste] "+(e.message||String(e))); }
      });

      document.getElementById("b_load").addEventListener("click", async ()=>{
        try{
          document.getElementById("k_ped").textContent="…";
          document.getElementById("k_fat").textContent="…";
          document.getElementById("k_desc").textContent="…";
          document.getElementById("k_fre").textContent="…";
          await loadKPIs();
        }catch(e){ log("[ERRO-Carregar] "+(e.message||String(e))); }
      });

      // quando escolher uma UNIDADE, recarrega KPIs
      elUnid.addEventListener("change", async ()=>{
        try{ await loadKPIs(); }catch(e){ log("[ERRO-Carregar] "+(e.message||String(e))); }
      });

      // ====== (11) boot ======
      (function boot(){
        log("[Boot] v10 — mapeamento manual + filtro por UNIDADE (sem max())");
        log("Dica: 1) clique 'Testar' para listar colunas;  2) 'Carregar KPIs (30 dias)';  3) use o filtro de UNIDADE.");
      })();
    </script>
  </body>
</html>
