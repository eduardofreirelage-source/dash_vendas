<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Maestro Food — KPIs & Auditoria</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#667085;--text:#0f172a;--blue:#1a73e8;--stroke:#e6eaf2;--radius:14px}
    body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:1200px;margin:24px auto 64px;padding:0 16px}
    .row{display:grid;gap:10px}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:var(--radius);padding:12px}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 8px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:9px 10px;border:1px solid var(--stroke);border-radius:10px;background:#fff}
    .btn{background:var(--blue);color:#fff;border:none;cursor:pointer}
    .btn.ghost{background:#eef3ff;color:#1747b7}
    .muted{color:var(--muted)}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
    .kpi h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
    .kpi b{font-size:20px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid var(--stroke);padding:6px 8px}
    th{background:#f3f6fc;text-align:left}
    .status{font-size:12px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{justify-content:flex-end}
    @media (max-width:960px){.cols-4,.cols-3,.cols-2,.kpis{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Maestro Food — KPIs & Auditoria</h1>
    <div id="status" class="status muted">Conectando…</div>

    <!-- FILTROS -->
    <div class="card" style="margin-top:10px">
      <div class="row cols-4">
        <div><label>De</label><input type="date" id="dini"></div>
        <div><label>Até</label><input type="date" id="dfim"></div>
        <div>
          <label>Período rápido</label>
          <select id="quick">
            <option value="30">Últimos 30</option>
            <option value="60">Últimos 60</option>
            <option value="90" selected>Últimos 90</option>
            <option value="mes">Este mês</option>
            <option value="mesant">Último mês</option>
          </select>
        </div>
        <div class="flex right">
          <button id="aplicar" class="btn">Aplicar</button>
          <button id="limpar" class="btn ghost">Limpar</button>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px">
        <div><label>Unidade</label><select id="fUni"><option value="">Todas</option></select></div>
        <div><label>Loja (sem “Loja Centro”/vazias)</label><select id="fLoja"><option value="">Todas</option></select></div>
        <div><label>Cancelado?</label>
          <select id="fCanc">
            <option value="Todos">Todos</option>
            <option value="Não" selected>Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px">
        <div><label>Canal</label><select id="fCanal"><option value="">Todos</option></select></div>
        <div><label>Pagamento</label><select id="fPag"><option value="">Todos</option></select></div>
        <div><label>&nbsp;</label><small id="periodo" class="muted">Período: —</small></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" style="margin-top:10px">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
      <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
      <div class="card kpi"><h3>Fat. Líquido</h3><b id="kFatLiq">—</b></div>
      <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
      <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
      <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
      <div class="card kpi"><h3>Fat. Médio/Dia</h3><b id="kFatDia">—</b></div>
    </div>

    <!-- RESUMO DO FILTRO -->
    <div class="card" style="margin-top:10px">
      <h2>Resumo do filtro</h2>
      <div id="resumo" class="muted">—</div>
    </div>

    <!-- PRÉVIA DAS LINHAS FILTRADAS -->
    <div class="card" style="margin-top:10px">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h2>Linhas filtradas (prévia)</h2>
        <div class="flex">
          <button id="prevPage" class="btn ghost">◀</button>
          <span id="pageInfo" class="muted">página 1</span>
          <button id="nextPage" class="btn ghost">▶</button>
          <button id="exportCsv" class="btn">Exportar CSV (filtrado)</button>
        </div>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table id="grid"><thead></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- HEALTHCHECK / COLUNAS -->
    <div class="row cols-2" style="margin-top:10px">
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h2>Healthcheck</h2>
          <button id="btnTestes" class="btn ghost">Executar testes</button>
        </div>
        <pre id="health" class="muted" style="white-space:pre-wrap;word-break:break-word;margin-top:8px">—</pre>
      </div>
      <div class="card">
        <h2>Identificador de colunas</h2>
        <pre id="cols" class="muted" style="white-space:pre-wrap;word-break:break-word;margin-top:8px">—</pre>
      </div>
    </div>
  </div>

  <!-- libs ANTES do seu script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
  (function(){
    // ====== CONFIG ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const TABLE = "vendas_kpi_daily_v2_data";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ====== DOM ======
    const S = id => document.getElementById(id);
    const statusEl=S('status'), periodoEl=S('periodo');
    const dini=S('dini'), dfim=S('dfim'), quick=S('quick');
    const fUni=S('fUni'), fLoja=S('fLoja'), fCanal=S('fCanal'), fPag=S('fPag'), fCanc=S('fCanc');
    const kPedidos=S('kPedidos'), kTicket=S('kTicket'), kFat=S('kFat'), kFatLiq=S('kFatLiq'),
          kDes=S('kDes'), kDesPct=S('kDesPct'), kFre=S('kFre'), kFatDia=S('kFatDia');
    const resumoEl=S('resumo'), grid=S('grid'), pageInfo=S('pageInfo'), btnPrev=S('prevPage'), btnNext=S('nextPage'), btnExport=S('exportCsv');
    const healthEl=S('health'), colsEl=S('cols');

    // ====== STATE ======
    let minISO=null, maxISO=null;
    let page=1, pageSize=200; // prévia paginada

    // ====== UTILS ======
    const fmtBRL = v => isFinite(v) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—";
    const fmtPct = v => isFinite(v) ? (v*100).toFixed(1).replace('.',',')+'%' : "—";
    const onlyISO = s => (s||'').slice(0,10);
    const norm = s => String(s??'').trim().toLowerCase();
    const isLojaBloqueada = name => { const n=norm(name); return !n || n==='loja centro'; };
    function toISO(d){ const x=new Date(d); if(isNaN(x))return null; return x.toISOString().slice(0,10); }
    function setQuick(range){
      const end = maxISO ? new Date(maxISO) : new Date();
      let start = new Date(end);
      if(range==='mes'){ start = new Date(end.getFullYear(), end.getMonth(), 1); }
      else if(range==='mesant'){ start = new Date(end.getFullYear(), end.getMonth()-1, 1); end.setDate(0); }
      else { const n=parseInt(range||'90',10); start.setDate(end.getDate()-(n-1)); }
      dini.value = toISO(start); dfim.value = toISO(end);
    }
    const normCancel = v => {
      const s = String(v??'').trim().toLowerCase();
      if(v===true || s==='sim' || s==='s' || s==='1' || s==='true') return 'Sim';
      return 'Não';
    };

    // ====== MIN/MAX + OPTIONS ======
    async function findMinMax(){
      const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
      const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
      if(!a.error && a.data?.length) minISO = onlyISO(a.data[0].dia);
      if(!b.error && b.data?.length) maxISO = onlyISO(b.data[0].dia);
      statusEl.textContent = minISO && maxISO
        ? `Fonte: ${TABLE} | Intervalo: ${minISO} → ${maxISO}`
        : 'Sem dados na fonte.';
    }
    async function buildOptions(){
      // Unidades
      const u = await supa.from(TABLE).select('unidade').not('unidade','is',null).order('unidade',{ascending:true}).range(0,99999);
      if(!u.error){
        const arr=[...new Set((u.data||[]).map(r=>r.unidade).filter(Boolean))];
        fUni.innerHTML = '<option value="">Todas</option>'+arr.map(v=>`<option>${v}</option>`).join('');
      }
      // Canal
      const c = await supa.from(TABLE).select('"Canal de venda"').order('Canal de venda',{ascending:true}).range(0,99999);
      if(!c.error){
        const arr=[...new Set((c.data||[]).map(r=>r["Canal de venda"]).filter(Boolean))];
        fCanal.innerHTML = '<option value="">Todos</option>'+arr.map(v=>`<option>${v}</option>`).join('');
      }
      // Pagamento
      const p = await supa.from(TABLE).select('pagamento').order('pagamento',{ascending:true}).range(0,99999);
      if(!p.error){
        const arr=[...new Set((p.data||[]).map(r=>r.pagamento).filter(Boolean))];
        fPag.innerHTML = '<option value="">Todos</option>'+arr.map(v=>`<option>${v}</option>`).join('');
      }
      // Lojas Top10 (sem vazias/“Loja Centro”)
      const pageSizeTop=20000; let from=0, done=false; const acc=new Map();
      while(!done){
        const l = await supa.from(TABLE).select('"Nome da loja",fat').not('fat','is',null).not('Nome da loja','is',null).range(from,from+pageSizeTop-1);
        if(l.error) break;
        (l.data||[]).forEach(r=>{
          const k=r["Nome da loja"]; if(isLojaBloqueada(k)) return;
          acc.set(k,(acc.get(k)||0)+(Number(r.fat)||0));
        });
        if(!l.data || l.data.length<pageSizeTop) done=true;
        from+=pageSizeTop; if(from>200000) done=true;
      }
      const top=Array.from(acc.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
      fLoja.innerHTML = '<option value="">Todas</option>'+top.map(v=>`<option>${v}</option>`).join('');
    }

    // ====== RPC HELPERS ======
    function lojaParam(){
      const v=fLoja.value||''; if(isLojaBloqueada(v)) return null; return v||null;
    }
    function arrOrNull(v){ return v ? [v] : null; }
    async function rpcKPIs(d1,d2,uni,loja,canal,pag,canc){
      return supa.rpc('dash_kpis',{ _dini:d1,_dfim:d2,_unidade:uni||null,_loja:loja,_canais:arrOrNull(canal),_pagamentos:arrOrNull(pag),_cancelado:canc||'Todos' });
    }

    // ====== FALLBACK KPI (paginado) ======
    async function fallbackKPIs(d1,d2,uni,loja,canal,pag,canc, hardLimitPages=50){
      let from=0, step=5000, pageNo=0;
      let rows=0, fat=0, des=0, fre=0, sumPedidos=0;
      let minDay=null, maxDay=null; const uniqDays=new Set();
      while(true){
        let q = supa.from(TABLE)
          .select('dia, pedidos, fat, des, fre, unidade, "Nome da loja", "Canal de venda", pagamento, cancelado')
          .gte('dia', d1).lte('dia', d2)
          .range(from, from+step-1);
        if(uni) q=q.eq('unidade',uni);
        const lojaSend = lojaParam(); if(lojaSend) q=q.eq('Nome da loja',lojaSend);
        if(canal) q=q.eq('Canal de venda', canal);
        if(pag) q=q.eq('pagamento', pag);

        const r = await q;
        if(r.error){ console.error('fallbackKPIs error', r.error); break; }
        const data=r.data||[];
        if(data.length===0) break;

        for(const it of data){
          const day=onlyISO(it.dia); if(!day) continue;
          const cancNorm = normCancel(it.cancelado);
          if(canc==='Sim' && cancNorm!=='Sim') continue;
          if(canc==='Não' && cancNorm!=='Não') continue;

          rows+=1;
          sumPedidos += Number(it.pedidos)||0;
          fat += Number(it.fat)||0;
          des += Number(it.des)||0;
          fre += Number(it.fre)||0;
          uniqDays.add(day);
          if(!minDay||day<minDay) minDay=day;
          if(!maxDay||day>maxDay) maxDay=day;
        }

        from+=step; pageNo++;
        if(pageNo>=hardLimitPages) break; // guarda-chuva de segurança
        if(data.length<step) break;
      }
      const dias = uniqDays.size||1;
      const ticket = rows? (fat/rows) : 0;
      const fatLiq = fat - des - fre;
      return { pedidos: rows, fat, descontos: des, fretes: fre, fat_liquido: fatLiq, ticket_medio: ticket, dias, sumPedidos };
    }

    // ====== RENDER ======
    function renderKPIs(row, d1, d2){
      const pedidos = Number(row?.pedidos)||0;
      const fat = Number(row?.fat)||0;
      const des = Number(row?.descontos)||0;
      const fre = Number(row?.fretes)||0;
      const fatliq = isFinite(Number(row?.fat_liquido)) ? Number(row?.fat_liquido) : (fat-des-fre);
      const ticket = pedidos? fat/pedidos : 0;
      const dias = Number(row?.dias) || (()=>{ if(!d1||!d2) return 0; const a=new Date(d1), b=new Date(d2); return Math.floor((b-a)/86400000)+1; })();
      const fatDia = dias>0? fat/dias : 0;
      const desPct = fat? des/fat : 0;

      kPedidos.textContent = pedidos.toLocaleString('pt-BR');
      kTicket.textContent  = fmtBRL(ticket);
      kFat.textContent     = fmtBRL(fat);
      kFatLiq.textContent  = fmtBRL(fatliq);
      kDes.textContent     = fmtBRL(des);
      kDesPct.textContent  = fmtPct(desPct);
      kFre.textContent     = fmtBRL(fre);
      kFatDia.textContent  = fmtBRL(fatDia);
    }

    function resumoFiltroText(info){
      const {d1,d2,uni,loja,canal,pag,canc,countRows,sumPedidos,fat,uniqDays,topLojas} = info;
      let txt = `Período: ${d1} → ${d2}\n`;
      txt += `Unidade: ${uni||'Todas'} | Loja: ${loja||'Todas'} | Canal: ${canal||'Todos'} | Pagamento: ${pag||'Todos'} | Cancelado: ${canc}\n`;
      txt += `Linhas filtradas: ${countRows.toLocaleString('pt-BR')} | sum(pedidos): ${sumPedidos.toLocaleString('pt-BR')}\n`;
      if (countRows !== sumPedidos) txt += `⚠️ Divergência: sum(pedidos) - linhas = ${(sumPedidos-countRows).toLocaleString('pt-BR')}\n`;
      txt += `Faturamento (Σ fat): ${fmtBRL(fat)} | Dias únicos: ${uniqDays}\n`;
      if(topLojas?.length){
        txt += `Top 5 Lojas (Σ fat):\n`;
        topLojas.slice(0,5).forEach(([nome,v],i)=> txt += `  ${i+1}. ${nome}: ${fmtBRL(v)}\n`);
      }
      return txt;
    }

    function renderPreviewHeader(cols){
      grid.querySelector('thead').innerHTML =
        '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
    }
    function renderPreviewRows(cols, rows){
      grid.querySelector('tbody').innerHTML =
        rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('');
    }

    // ====== PREVIEW PAGE FETCH ======
    async function fetchPreview(d1,d2,uni,loja,canal,pag,canc, page, pageSize){
      let from=(page-1)*pageSize, to=from+pageSize-1;
      let q = supa.from(TABLE)
        .select('dia,unidade,"Nome da loja","Canal de venda",pagamento,pedidos,fat,des,fre,cancelado,hora,turno')
        .gte('dia', d1).lte('dia', d2)
        .order('dia',{ascending:true})
        .range(from,to);
      if(uni) q=q.eq('unidade',uni);
      const lojaSend = lojaParam(); if(lojaSend) q=q.eq('Nome da loja',lojaSend);
      if(canal) q=q.eq('Canal de venda', canal);
      if(pag) q=q.eq('pagamento', pag);

      const r = await q;
      if(r.error){ console.error('fetchPreview error', r.error); return []; }

      // aplica cancelado no cliente (para cobrir valores inconsistentes)
      let data=(r.data||[]).filter(x=>{
        const c=normCancel(x.cancelado);
        if(canc==='Sim') return c==='Sim';
        if(canc==='Não') return c==='Não';
        return true;
      });

      // filtra lojas bloqueadas (segurança)
      data = data.filter(x=> !isLojaBloqueada(x["Nome da loja"]));

      return data;
    }

    // ====== EXPORT CSV (multiplas páginas) ======
    async function exportCSV(d1,d2,uni,loja,canal,pag,canc, maxRows=50000){
      const cols = ['dia','unidade','Nome da loja','Canal de venda','pagamento','pedidos','fat','des','fre','cancelado','hora','turno'];
      let out = cols.join(';')+'\n';
      let fetched=0; let localPage=1;
      while(fetched<maxRows){
        const data = await fetchPreview(d1,d2,uni,loja,canal,pag,canc, localPage, 1000);
        if(!data.length) break;
        for(const r of data){
          const row = cols.map(c=>{
            let v = r[c]??'';
            if(typeof v==='string' && v.includes(';')) v='"'+v.replace(/"/g,'""')+'"';
            return v;
          }).join(';');
          out += row+'\n';
          fetched++;
          if(fetched>=maxRows) break;
        }
        if(data.length<1000) break;
        localPage++;
        if(localPage>100) break; // guarda-chuva
      }
      const blob=new Blob([out],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`maestro_food_filtrado_${d1}_a_${d2}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ====== HEALTHCHECK / COLUNAS ======
    async function runHealth(d1,d2){
      let txt='';
      // total exato
      const head = await supa.from(TABLE).select('*', {count:'exact', head:true});
      txt += `Total (count exato): ${isFinite(head.count)? head.count : '—'}\n`;

      // cancelado normalizado
      let from=0, step=5000, sim=0, nao=0, outros=0, pages=0;
      while(true){
        const r = await supa.from(TABLE).select('cancelado').range(from,from+step-1);
        if(r.error || !r.data?.length) break;
        for(const it of r.data){
          const c=normCancel(it.cancelado);
          if(c==='Sim') sim++; else if(c==='Não') nao++; else outros++;
        }
        from+=step; pages++;
        if(pages>40 || r.data.length<step) break;
      }
      txt += `Cancelado normalizado — Sim: ${sim}, Não: ${nao}${outros?`, Outros: ${outros}`:''}\n`;

      // exemplo de dia “quente” (dif count vs sum(pedidos))
      if(d1 && d2){
        let countRows=0, sumPed=0, sumFat=0;
        let pf=0; let from2=0, step2=5000;
        while(true){
          const r = await supa.from(TABLE).select('dia,pedidos,fat').gte('dia',d1).lte('dia',d2).range(from2,from2+step2-1);
          if(r.error || !r.data?.length) break;
          for(const it of r.data){ countRows++; sumPed+=(Number(it.pedidos)||0); sumFat+=(Number(it.fat)||0); }
          from2+=step2; pf++; if(pf>40 || r.data.length<step2) break;
        }
        txt += `Janela atual — linhas: ${countRows}, sum(pedidos): ${sumPed}, Σ fat: ${fmtBRL(sumFat)}\n`;
        if(countRows !== sumPed) txt += `⚠️ Divergência detectada (sum(pedidos) != linhas)\n`;
      }

      healthEl.textContent = txt || '—';
    }

    async function identifyColumns(){
      // tentativa 1: informação por amostra
      const r = await supa.from(TABLE).select('*').limit(1);
      if(r.error){ colsEl.textContent = 'Erro ao ler amostra de colunas.'; return; }
      const row = (r.data||[])[0] || {};
      const keys = Object.keys(row);
      const sampleTypes = {};
      keys.forEach(k=>{
        const v=row[k];
        let t=typeof v;
        if(t==='string' && /^\d{4}-\d{2}-\d{2}/.test(v)) t='date';
        sampleTypes[k]=t;
      });
      colsEl.textContent = JSON.stringify(
        keys.map(k=>({ coluna:k, tipo_estimado:sampleTypes[k]||'desconhecido' })), null, 2
      );
    }

    // ====== RELOAD ======
    async function reload(){
      const d1 = dini.value || minISO;
      const d2 = dfim.value || maxISO;
      const uni = fUni.value || null;
      const loja = lojaParam();
      const canal = fCanal.value || null;
      const pag = fPag.value || null;
      const canc = fCanc.value || 'Todos';

      periodoEl.textContent = `Período: ${d1??'—'} → ${d2??'—'}`;

      // KPIs por RPC, com fallback paginado
      let row=null, used='rpc';
      const k = await rpcKPIs(d1,d2,uni,loja,canal,pag,canc);
      if(k.error || !(k.data&&k.data.length)){
        console.warn('RPC falhou/vazio, usando fallback...', k.error);
        row = await fallbackKPIs(d1,d2,uni,loja,canal,pag,canc);
        used='fallback';
      }else{
        row = k.data[0];
        // garante campos que a RPC pode não retornar
        if(row){ row.dias = row.dias ?? undefined; row.ticket_medio = row.ticket_medio ?? (row.pedidos? row.fat/row.pedidos : 0); }
      }
      renderKPIs(row, d1, d2);

      // Resumo + top 5 lojas do período filtrado
      let from=0, step=5000, countRows=0, sumPedidos=0, sumFat=0;
      const accLoja=new Map(); const uniqDays=new Set(); let stops=0;
      while(true){
        let q = supa.from(TABLE).select('dia,"Nome da loja",fat,pedidos').gte('dia',d1).lte('dia',d2).range(from,from+step-1);
        if(uni) q=q.eq('unidade',uni);
        const lojaSend = lojaParam(); if(lojaSend) q=q.eq('Nome da loja',lojaSend);
        if(canal) q=q.eq('Canal de venda', canal);
        if(pag) q=q.eq('pagamento', pag);
        const r = await q;
        if(r.error || !r.data?.length) break;
        for(const it of r.data){
          const day=onlyISO(it.dia); if(day) uniqDays.add(day);
          countRows++; sumPedidos+=(Number(it.pedidos)||0); sumFat+=(Number(it.fat)||0);
          const lj = it["Nome da loja"]; if(!isLojaBloqueada(lj)){ accLoja.set(lj,(accLoja.get(lj)||0)+(Number(it.fat)||0)); }
        }
        from+=step; stops++; if(stops>40 || r.data.length<step) break;
      }
      const topLojas = Array.from(accLoja.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
      resumoEl.textContent = resumoFiltroText({d1,d2,uni,loja,canal,pag,canc,countRows,sumPedidos,fat:sumFat,uniqDays:uniqDays.size,topLojas});

      // Prévia (página atual)
      const cols = ['dia','unidade','Nome da loja','Canal de venda','pagamento','pedidos','fat','des','fre','cancelado','hora','turno'];
      renderPreviewHeader(cols);
      const dataPage = await fetchPreview(d1,d2,uni,loja,canal,pag,canc, page, pageSize);
      renderPreviewRows(cols, dataPage);
      pageInfo.textContent = `página ${page}`;
    }

    // ====== EVENTS ======
    S('aplicar').addEventListener('click', ()=>{ page=1; reload(); });
    S('limpar').addEventListener('click', ()=>{
      fUni.value=""; fLoja.value=""; fCanal.value=""; fPag.value=""; fCanc.value="Não";
      setQuick(quick.value); page=1; reload();
    });
    quick.addEventListener('change', ()=>{ setQuick(quick.value); page=1; reload(); });
    btnPrev.addEventListener('click', ()=>{ if(page>1){page--; reload();} });
    btnNext.addEventListener('click', ()=>{ page++; reload(); });
    btnExport.addEventListener('click', async ()=>{
      const d1=dini.value||minISO, d2=dfim.value||maxISO, uni=fUni.value||null, loja=lojaParam(), canal=fCanal.value||null, pag=fPag.value||null, canc=fCanc.value||'Todos';
      await exportCSV(d1,d2,uni,loja,canal,pag,canc, 50000);
    });
    S('btnTestes').addEventListener('click', async ()=>{
      await runHealth(dini.value||minISO, dfim.value||maxISO);
      await identifyColumns();
    });

    // ====== BOOT ======
    (async function boot(){
      await findMinMax();
      if(!minISO || !maxISO){ statusEl.textContent = 'Sem dados.'; return; }
      dini.value=minISO; dfim.value=maxISO; setQuick(quick.value);
      await buildOptions();
      await runHealth(minISO, maxISO);
      await identifyColumns();
      await reload();
    })();
  })();
  </script>
</body>
</html>
