<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Produtos & Fichas Técnicas</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">FT</text></svg>'/>
  <style>
    :root{ --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --wine:#7b1e3a; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{margin:0;font-size:28px}
    h3{margin:0 0 10px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.pri{background:var(--wine);color:#fff;border-color:var(--wine)}
    .btn.ghost{background:#fff}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active{background:#f1f5f9;font-weight:700}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .muted{color:var(--muted)}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
    textarea{min-height:80px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
    th{background:#f8fafc}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .ok{color:#059669}
    .err{color:#dc2626}
    .sep{height:1px;background:var(--line);margin:10px 0}
    @media (max-width:900px){.cols-2,.cols-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Produtos & Fichas Técnicas</h1>
      <div id="status" class="muted">—</div>
    </div>

    <div class="section">
      <div class="tabs">
        <button type="button" class="tab active" data-tab="tab-ing">Ingredientes</button>
        <button type="button" class="tab" data-tab="tab-rec">Receitas</button>
        <button type="button" class="tab" data-tab="tab-pratos">Pratos</button>
        <button type="button" class="tab" data-tab="tab-prato-rec">Componentes do Prato</button>
      </div>
    </div>

    <!-- INGREDIENTES -->
    <div class="section" id="tab-ing">
      <h3>Cadastro de Ingredientes</h3>
      <div class="grid cols-3">
        <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"></div>
        <div><label>Unidade</label>
          <select id="ing-und">
            <option value="g">g</option><option value="kg" selected>kg</option>
            <option value="ml">ml</option><option value="L">L</option>
            <option value="un">un</option>
          </select>
        </div>
        <div><label>Custo unitário</label><input id="ing-custo" type="number" step="0.0001" min="0" placeholder="Ex.: 0.0123"></div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div><label>Observações</label><textarea id="ing-obs" placeholder="Opcional"></textarea></div>
      </div>
      <div style="margin-top:10px"><button type="button" id="btnSaveIng" class="btn pri">Salvar Ingrediente</button></div>

      <div class="sep"></div>
      <div class="muted">Ingredientes cadastrados</div>
      <div style="overflow:auto">
        <table id="tblIng">
          <thead><tr><th>Nome</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RECEITAS -->
    <div class="section" id="tab-rec" style="display:none">
      <h3>Cadastro de Receitas (com componentes)</h3>

      <!-- NOVA RECEITA COM ITENS EM MEMÓRIA -->
      <div class="grid cols-3">
        <div><label>Nome da receita</label><input id="rec-nome" placeholder="Ex.: Arroz Branco pronto"></div>
        <div><label>Rendimento (quantidade)</label><input id="rec-rend-qtd" type="number" step="0.001" min="0.001" placeholder="Ex.: 1000"></div>
        <div><label>Unidade do rendimento</label>
          <select id="rec-rend-und"><option value="g" selected>g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Perda global (%)</label><input id="rec-perda" type="number" step="0.01" min="0" max="100" value="0"></div>
        <div class="muted" style="align-self:end">A perda é aplicada ao rendimento total.</div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div><label>Observações</label><textarea id="rec-obs" placeholder="Opcional"></textarea></div>
      </div>

      <div class="sep"></div>
      <div class="muted" style="font-weight:700">Adicionar componentes à NOVA receita (grade temporária)</div>
      <div class="grid cols-3">
        <div><label>Tipo</label>
          <select id="draft-tipo"><option value="INGREDIENTE" selected>Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
        </div>
        <div><label>Referência</label><select id="draft-ref"></select></div>
        <div><label>Qtd</label><input id="draft-qtd" type="number" step="0.001" min="0.001" placeholder="Ex.: 300"></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Unidade</label>
          <select id="draft-und"><option value="g" selected>g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
        </div>
        <div><label>Perda da linha (%)</label><input id="draft-perda" type="number" step="0.01" min="0" max="100" value="0"></div>
        <div style="align-self:end"><button type="button" id="btnDraftAdd" class="btn">Adicionar à grade</button></div>
      </div>

      <div style="overflow:auto;margin-top:8px">
        <table id="tblDraft">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button type="button" id="btnSaveRec" class="btn pri">Salvar Receita + Componentes</button>
        <button type="button" id="btnDraftClear" class="btn ghost">Limpar grade</button>
      </div>

      <div class="sep"></div>
      <h3>Receitas existentes</h3>
      <div class="grid cols-3">
        <div><label>Selecionar receita para editar</label><select id="ri-receita"></select></div>
        <div style="align-self:end"><span class="muted">Você pode adicionar novos componentes abaixo</span></div>
      </div>

      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Tipo</label>
          <select id="ri-tipo"><option value="INGREDIENTE" selected>Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
        </div>
        <div><label>Referência</label><select id="ri-ref"></select></div>
        <div><label>Quantidade</label><input id="ri-qtd" type="number" step="0.001" min="0.001"></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Unidade</label>
          <select id="ri-und"><option value="g" selected>g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
        </div>
        <div><label>Perda da linha (%)</label><input id="ri-perda" type="number" step="0.01" min="0" max="100" value="0"></div>
        <div style="align-self:end"><button type="button" id="btnAddRi" class="btn">Adicionar à receita</button></div>
      </div>

      <div style="overflow:auto;margin-top:8px">
        <table id="tblRi">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div class="muted">Resumo</div>
      <div style="overflow:auto">
        <table id="tblRec">
          <thead><tr><th>Nome</th><th>Rendimento</th><th>Perda %</th><th>Itens</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- PRATOS -->
    <div class="section" id="tab-pratos" style="display:none">
      <h3>Cadastro de Pratos</h3>
      <div class="grid cols-3">
        <div><label>Nome</label><input id="p-nome" placeholder="Ex.: Strogonoff de frango"></div>
        <div><label>Categoria</label>
          <select id="p-cat">
            <option value="PRATOS" selected>PRATOS</option>
            <option value="BEBIDAS">BEBIDAS</option>
            <option value="ACOMPANHAMENTOS">ACOMPANHAMENTOS</option>
            <option value="SOBREMESA">SOBREMESA</option>
            <option value="OUTROS">OUTROS</option>
          </select>
        </div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div><label>Observações</label><textarea id="p-obs" placeholder="Opcional"></textarea></div>
      </div>
      <div style="margin-top:10px"><button type="button" id="btnSavePrato" class="btn pri">Salvar Prato</button></div>

      <div class="sep"></div>
      <div class="muted">Pratos cadastrados</div>
      <div style="overflow:auto">
        <table id="tblPrato">
          <thead><tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- COMPONENTES DO PRATO -->
    <div class="section" id="tab-prato-rec" style="display:none">
      <h3>Componentes do Prato</h3>
      <div class="grid cols-3">
        <div><label>Prato</label><select id="pr-prato"></select></div>
        <div><label>Receita</label><select id="pr-receita"></select></div>
        <div><label>Quantidade por prato</label><input id="pr-qtd" type="number" step="0.001" min="0.001" placeholder="Ex.: 220"></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Unidade</label>
          <select id="pr-und"><option value="g" selected>g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
        </div>
        <div><label>Observações</label><input id="pr-obs" placeholder="Opcional"></div>
        <div style="align-self:end"><button type="button" id="btnAddPrComp" class="btn pri">Adicionar Receita ao Prato</button></div>
      </div>

      <div style="overflow:auto;margin-top:8px">
        <table id="tblPrComp">
          <thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ============== SUPABASE ============== */
    const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ============== HELPERS ============== */
    const $ = (id)=> document.getElementById(id);
    const setStatus=(t,k)=>{ const el=$('status'); if(!el) return; el.textContent=t; el.className = k ? k : 'muted'; };
    const fmt = (n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
    const on = (id, evt, fn)=>{ const el=$(id); if(el) el.addEventListener(evt, fn); };

    function bindTabs(){
      document.querySelectorAll('.tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          const id = btn.dataset.tab;
          document.querySelectorAll('.section[id^="tab-"]').forEach(sec=>sec.style.display='none');
          $(id).style.display='block';
        });
      });
    }

    /* ============== INGREDIENTES ============== */
    async function loadIngredientes(){
      const { data, error } = await supa.from('ingredientes').select('*').order('nome',{ascending:true});
      if(error){ setStatus('Erro ao listar ingredientes','err'); return; }
      const tb = $('#tblIng')?.querySelector('tbody'); if(tb){
        tb.innerHTML='';
        (data||[]).forEach(row=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${row.nome}</td>
            <td>${row.unidade}</td>
            <td>R$ ${fmt(row.custo_unitario)}</td>
            <td>${row.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill">Inativo</span>'}</td>
            <td class="row-actions">
              <button type="button" class="btn" data-act="toggle" data-id="${row.id}">${row.ativo?'Desativar':'Ativar'}</button>
              <button type="button" class="btn" data-act="del" data-id="${row.id}">Excluir</button>
            </td>`;
          tb.appendChild(tr);
        });
      }
      // popular referências: ingredientes
      fillOptions('draft-ref', data, 'id','nome');
      if($('#ri-tipo')?.value==='INGREDIENTE') fillOptions('ri-ref', data, 'id','nome');
    }

    async function saveIngrediente(){
      const nome = $('#ing-nome').value.trim();
      const unidade = $('#ing-und').value;
      const custo = parseFloat($('#ing-custo').value||'0');
      const obs = $('#ing-obs').value.trim();
      if(!nome){ alert('Informe o nome do ingrediente'); return; }
      const { error } = await supa.from('ingredientes').insert({ nome, unidade, custo_unitario:custo, obs });
      if(error){ alert('Erro: '+(error.message||error)); return; }
      $('#ing-nome').value=''; $('#ing-custo').value=''; $('#ing-obs').value='';
      await loadIngredientes();
      setStatus('Ingrediente salvo', 'ok');
    }
    on('btnSaveIng','click', saveIngrediente);

    const tblIng = $('#tblIng');
    if (tblIng){
      tblIng.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;
        if(act==='del'){
          if(!confirm('Excluir ingrediente? (não pode ter vínculo em receita)')) return;
          const { error } = await supa.from('ingredientes').delete().eq('id', id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
        } else if (act==='toggle'){
          const { data } = await supa.from('ingredientes').select('ativo').eq('id', id).single();
          const { error } = await supa.from('ingredientes').update({ ativo: !data.ativo }).eq('id', id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
        }
        await loadIngredientes();
      });
    }

    /* ============== RECEITAS: LISTAGEM BASE ============== */
    async function loadReceitas(){
      const { data, error } = await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true});
      if(error){ setStatus('Erro ao listar receitas','err'); return;}
      const tb = $('#tblRec')?.querySelector('tbody'); if(tb){
        tb.innerHTML='';
        (data||[]).forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${r.nome}</td>
            <td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td>
            <td>${fmt(r.perda_pct)}%</td>
            <td>${r.itens}</td>
            <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill">Inativo</span>'}</td>
            <td class="row-actions">
              <button type="button" class="btn" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
              <button type="button" class="btn" data-act="del" data-id="${r.id}">Excluir</button>
            </td>`;
          tb.appendChild(tr);
        });
      }
      // popular selects de receita (edição)
      fillOptionsFromQuery('ri-receita', 'receitas', 'id','nome', {ativo:true});
      // popular selects de receita pro prato
      fillOptionsFromQuery('pr-receita', 'receitas', 'id','nome', {ativo:true});
    }

    const tblRec = $('#tblRec');
    if (tblRec){
      tblRec.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;
        if(act==='del'){
          if(!confirm('Excluir receita? (exclui também seus componentes)')) return;
          const { error } = await supa.from('receitas').delete().eq('id', id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
        } else if (act==='toggle'){
          const { data } = await supa.from('receitas').select('ativo').eq('id', id).single();
          const { error } = await supa.from('receitas').update({ ativo: !data.ativo }).eq('id', id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
        }
        await loadReceitas(); await loadReceitaItensTable();
      });
    }

    /* ============== RECEITAS: DRAFT (NOVA) ============== */
    let draftItems = []; // {tipo, ref_id, nome, qtd, unidade, perda_pct}

    function renderDraft(){
      const tb = $('#tblDraft')?.querySelector('tbody'); if(!tb) return;
      tb.innerHTML='';
      draftItems.forEach((it, idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.tipo}</td>
          <td>${it.nome}</td>
          <td>${fmt(it.qtd)}</td>
          <td>${it.unidade}</td>
          <td>${fmt(it.perda_pct)}%</td>
          <td class="row-actions">
            <button type="button" class="btn" data-idx="${idx}">Remover</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    const tblDraft = $('#tblDraft');
    if (tblDraft){
      tblDraft.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const idx = +btn.dataset.idx;
        draftItems.splice(idx,1);
        renderDraft();
      });
    }

    async function fillOptions(selectId, items, valKey, labelKey){
      const sel = $(selectId); if(!sel) return;
      sel.innerHTML='';
      (items||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
    }
    async function fillOptionsFromQuery(selectId, table, valKey, labelKey, whereEq){
      const sel = $(selectId); if(!sel) return;
      let q = supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true});
      if(whereEq){ Object.entries(whereEq).forEach(([k,v]) => q = q.eq(k, v)); }
      const { data } = await q;
      sel.innerHTML='';
      (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
    }

    async function refreshDraftRefs(){
      const tipo = $('#draft-tipo')?.value;
      if(!tipo) return;
      if(tipo==='INGREDIENTE'){
        const { data } = await supa.from('ingredientes').select('id,nome').eq('ativo',true).order('nome');
        fillOptions('draft-ref', data, 'id','nome');
      } else {
        const { data } = await supa.from('receitas').select('id,nome').eq('ativo',true).order('nome');
        fillOptions('draft-ref', data, 'id','nome');
      }
    }
    on('draft-tipo','change', refreshDraftRefs);

    on('btnDraftAdd','click', async ()=>{
      const tipo = $('#draft-tipo').value;
      const ref_id = $('#draft-ref').value;
      const qtd = parseFloat($('#draft-qtd').value||'0');
      const unidade = $('#draft-und').value;
      const perda_pct = parseFloat($('#draft-perda').value||'0');
      if(!ref_id || !qtd){ alert('Selecione a referência e informe a quantidade'); return; }
      // pega nome
      let nome = '';
      if(tipo==='INGREDIENTE'){
        const { data } = await supa.from('ingredientes').select('nome').eq('id', ref_id).single(); nome = data?.nome||'';
      }else{
        const { data } = await supa.from('receitas').select('nome').eq('id', ref_id).single(); nome = data?.nome||'';
      }
      draftItems.push({ tipo, ref_id, nome, qtd, unidade, perda_pct });
      $('#draft-qtd').value=''; $('#draft-perda').value='0';
      renderDraft();
    });

    on('btnDraftClear','click', ()=>{ draftItems=[]; renderDraft(); });

    async function saveReceitaDraft(){
      const nome = $('#rec-nome').value.trim();
      const rendimento_qtd = parseFloat($('#rec-rend-qtd').value||'0');
      const unidade_rendimento = $('#rec-rend-und').value;
      const perda_pct = parseFloat($('#rec-perda').value||'0');
      const obs = $('#rec-obs').value.trim();
      if(!nome || !rendimento_qtd){ alert('Informe nome e rendimento'); return; }
      // cria receita
      const { data:ins, error } = await supa.from('receitas').insert({ nome, rendimento_qtd, unidade_rendimento, perda_pct, obs }).select('id').single();
      if(error){ alert('Erro ao salvar receita: '+(error.message||error)); return; }
      const receita_id = ins.id;
      // insere itens em lote
      if(draftItems.length){
        const payload = draftItems.map(d => ({ receita_id, tipo:d.tipo, ref_id:d.ref_id, qtd:d.qtd, unidade:d.unidade, perda_pct:d.perda_pct }));
        const { error:err2 } = await supa.from('receita_itens').insert(payload);
        if(err2){ alert('Receita salva, mas houve erro ao salvar componentes: '+(err2.message||err2)); }
      }
      // limpa
      $('#rec-nome').value=''; $('#rec-rend-qtd').value=''; $('#rec-perda').value='0'; $('#rec-obs').value='';
      draftItems=[]; renderDraft();
      await loadReceitas();
      setStatus('Receita e componentes salvos', 'ok');
    }
    on('btnSaveRec','click', saveReceitaDraft);

    /* ============== RECEITAS: EDIÇÃO (EXISTENTE) ============== */
    async function loadRefOptionsForTipo(){
      const tipo = $('#ri-tipo')?.value;
      if(!tipo) return;
      if(tipo==='INGREDIENTE'){
        const { data } = await supa.from('ingredientes').select('id,nome').eq('ativo',true).order('nome');
        fillOptions('ri-ref', data, 'id','nome');
      } else {
        const { data } = await supa.from('receitas').select('id,nome').eq('ativo',true).order('nome');
        fillOptions('ri-ref', data, 'id','nome');
      }
    }
    on('ri-tipo','change', loadRefOptionsForTipo);

    async function loadReceitaItensTable(){
      const receitaId = $('#ri-receita')?.value;
      const tb = $('#tblRi')?.querySelector('tbody'); if(!tb) return;
      tb.innerHTML='';
      if(!receitaId) return;
      const { data, error } = await supa.from('receita_itens').select('*').eq('receita_id', receitaId);
      if(error){ setStatus('Erro ao listar itens da receita','err'); return; }
      for(const it of (data||[]).sort((a,b)=>a.tipo.localeCompare(b.tipo))){
        let nome='—';
        if(it.tipo==='INGREDIENTE'){
          const { data:ing } = await supa.from('ingredientes').select('nome').eq('id', it.ref_id).single();
          nome = ing?.nome || '(ingrediente removido)';
        } else {
          const { data:rec } = await supa.from('receitas').select('nome').eq('id', it.ref_id).single();
          nome = rec?.nome || '(receita removida)';
        }
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.tipo}</td>
          <td>${nome}</td>
          <td>${fmt(it.qtd)}</td>
          <td>${it.unidade}</td>
          <td>${fmt(it.perda_pct)}%</td>
          <td class="row-actions"><button type="button" class="btn" data-act="del" data-id="${it.id}">Remover</button></td>`;
        tb.appendChild(tr);
      }
    }
    on('ri-receita','change', loadReceitaItensTable);

    async function addReceitaItem(){
      const receita_id = $('#ri-receita').value;
      const tipo = $('#ri-tipo').value;
      const ref_id = $('#ri-ref').value;
      const qtd = parseFloat($('#ri-qtd').value||'0');
      const unidade = $('#ri-und').value;
      const perda_pct = parseFloat($('#ri-perda').value||'0');
      if(!receita_id || !ref_id || !qtd){ alert('Selecione receita, referência e informe quantidade'); return; }
      const { error } = await supa.from('receita_itens').insert({ receita_id, tipo, ref_id, qtd, unidade, perda_pct });
      if(error){ alert('Erro: '+(error.message||error)); return; }
      $('#ri-qtd').value=''; $('#ri-perda').value='0';
      await loadReceitaItensTable();
      setStatus('Componente adicionado à receita', 'ok');
    }
    on('btnAddRi','click', addReceitaItem);

    const tblRi = $('#tblRi');
    if (tblRi){
      tblRi.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.act==='del'){
          if(!confirm('Remover este componente da receita?')) return;
          const { error } = await supa.from('receita_itens').delete().eq('id', btn.dataset.id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
          await loadReceitaItensTable();
        }
      });
    }

    /* ============== PRATOS ============== */
    async function loadPratos(){
      const { data, error } = await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true});
      if(error){ setStatus('Erro ao listar pratos','err'); return; }
      const tb = $('#tblPrato')?.querySelector('tbody'); if(tb){
        tb.innerHTML='';
        (data||[]).forEach(p=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${p.nome}</td>
            <td>${p.categoria}</td>
            <td>${p.receitas}</td>
            <td>${p.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill">Inativo</span>'}</td>
            <td class="row-actions">
              <button type="button" class="btn" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
              <button type="button" class="btn" data-act="del" data-id="${p.id}">Excluir</button>
            </td>`;
          tb.appendChild(tr);
        });
      }
      // popular select de prato
      fillOptionsFromQuery('pr-prato', 'pratos', 'id','nome', {ativo:true});
    }

    async function savePrato(){
      const nome = $('#p-nome').value.trim();
      const categoria = $('#p-cat').value;
      const obs = $('#p-obs').value.trim();
      if(!nome){ alert('Informe o nome do prato'); return; }
      const { error } = await supa.from('pratos').insert({ nome, categoria, obs });
      if(error){ alert('Erro: '+(error.message||error)); return; }
      $('#p-nome').value=''; $('#p-obs').value='';
      await loadPratos();
      setStatus('Prato salvo', 'ok');
    }
    on('btnSavePrato','click', savePrato);

    const tblPrato = $('#tblPrato');
    if (tblPrato){
      tblPrato.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;
        if(act==='del'){
          if(!confirm('Excluir prato? (exclui suas vinculações de receitas)')) return;
          const { error } = await supa.from('pratos').delete().eq('id', id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
        } else if (act==='toggle'){
          const { data } = await supa.from('pratos').select('ativo').eq('id', id).single();
          const { error } = await supa.from('pratos').update({ ativo: !data.ativo }).eq('id', id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
        }
        await loadPratos(); await loadPratoCompTable();
      });
    }

    /* ============== PRATO: RECEITAS ============== */
    async function addPratoComp(){
      const prato_id = $('#pr-prato').value;
      const receita_id = $('#pr-receita').value;
      const qtd = parseFloat($('#pr-qtd').value||'0');
      const unidade = $('#pr-und').value;
      const obs = $('#pr-obs').value?.trim() || null;
      if(!prato_id || !receita_id || !qtd){ alert('Selecione prato/receita e informe quantidade'); return; }
      const { error } = await supa.from('prato_receitas').insert({ prato_id, receita_id, qtd, unidade, obs });
      if(error){
        if (error.message && error.message.includes('duplicate key')) {
          alert('Esta receita já está vinculada ao prato. Edite/remova a linha existente.');
        } else { alert('Erro: '+(error.message||error)); }
        return;
      }
      $('#pr-qtd').value=''; $('#pr-obs').value='';
      await loadPratoCompTable();
      setStatus('Receita adicionada ao prato', 'ok');
    }
    on('btnAddPrComp','click', addPratoComp);

    async function loadPratoCompTable(){
      const prato_id = $('#pr-prato')?.value;
      const tb = $('#tblPrComp')?.querySelector('tbody'); if(!tb) return;
      tb.innerHTML='';
      if(!prato_id) return;
      const { data, error } = await supa.from('prato_receitas').select('id, receita_id, qtd, unidade').eq('prato_id', prato_id);
      if(error){ setStatus('Erro ao listar componentes do prato','err'); return; }
      for(const row of (data||[])){
        const { data: rec } = await supa.from('receitas').select('nome').eq('id', row.receita_id).single();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${rec?.nome || '(receita removida)'}</td>
          <td>${fmt(row.qtd)}</td>
          <td>${row.unidade}</td>
          <td class="row-actions">
            <button type="button" class="btn" data-act="del" data-id="${row.id}">Remover</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
    on('pr-prato','change', loadPratoCompTable);

    const tblPrComp = $('#tblPrComp');
    if (tblPrComp){
      tblPrComp.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.act==='del'){
          if(!confirm('Remover esta receita do prato?')) return;
          const { error } = await supa.from('prato_receitas').delete().eq('id', btn.dataset.id);
          if(error){ alert('Erro: '+(error.message||error)); return; }
          await loadPratoCompTable();
        }
      });
    }

    /* ============== INIT ============== */
    async function init(){
      bindTabs();
      setStatus('Carregando...');
      await loadIngredientes();
      await loadReceitas();
      await refreshDraftRefs();
      await loadRefOptionsForTipo();
      await loadPratos();
      await loadPratoCompTable();
      setStatus('Pronto', 'ok');
    }
    init();
  });
  </script>
</body>
</html>
