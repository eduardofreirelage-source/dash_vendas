<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — CFO v2.6 Light</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='26' fill='%23f2f5fb'/><text x='64' y='80' text-anchor='middle' font-family='Arial' font-size='64' fill='%231a73e8'>MF</text></svg>"/>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#6a768a; --text:#0e1320;
    --stroke:#e4e8f1; --acc:#1a73e8; --good:#1aa36a; --bad:#e5484d;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 14px}
  .version{font-size:12px;color:var(--muted);padding:2px 6px;border:1px solid var(--stroke);border-radius:999px;margin-left:8px;background:#fff}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .clean{font-size:13px;color:var(--muted);cursor:pointer}
  .grid{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
  .card h3{font-size:13px;color:var(--muted);margin:0 0 8px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#fff;color:var(--text);appearance:none}
  select[multiple]{height:120px}
  .kpi{display:flex;align-items:flex-end;gap:8px}
  .kpi .big{font-size:20px;font-weight:700}
  .kpi .sub{font-size:12px;color:var(--muted)}
  .trend{font-size:12px;font-weight:600;padding:2px 6px;border-radius:8px;display:inline-flex;gap:4px;align-items:center;border:1px solid var(--stroke);background:#fff}
  .up{color:var(--good)} .down{color:var(--bad)}
  .muted{color:var(--muted)}
  canvas{background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:8px}
  .row{display:grid;gap:12px}
  .right{justify-self:end}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <h1>Dashboard Vendas — CFO <span class="version">v2.6 Light</span></h1>
    <a id="btnClear" class="clean">Limpar filtros</a>
  </div>

  <!-- FILTROS -->
  <div class="grid cols-3 card">
    <div>
      <label>Unidade(s)</label>
      <select id="fUnidade" multiple></select>
    </div>
    <div>
      <label>Loja(s)</label>
      <select id="fLoja" multiple></select>
    </div>
    <div>
      <label>Turno(s)</label>
      <select id="fTurno" multiple></select>
    </div>

    <div>
      <label>Período (De)</label>
      <input id="fDe" type="date"/>
    </div>
    <div>
      <label>Período (Até)</label>
      <input id="fAte" type="date"/>
    </div>
    <div>
      <label>Período Rápido</label>
      <select id="fRapido">
        <option value="30">Último mês (30d)</option>
        <option value="7">Últimos 7 dias</option>
        <option value="15">Últimos 15 dias</option>
        <option value="60">Últimos 60 dias</option>
        <option value="90">Últimos 90 dias</option>
        <option value="120">Últimos 120 dias</option>
        <option value="custom">Período personalizado</option>
      </select>
    </div>

    <div>
      <label>Canal(is)</label>
      <select id="fCanal" multiple></select>
    </div>
    <div>
      <label>Pagamento(s)</label>
      <select id="fPag" multiple></select>
    </div>
    <div>
      <label>Cancelado</label>
      <select id="fCanc">
        <option value="Todos">Todos</option>
        <option value="Não" selected>Não</option>
        <option value="Sim">Sim</option>
      </select>
    </div>
  </div>

  <!-- QUADRO RESUMO -->
  <div class="grid cols-4" style="margin-top:12px;">
    <div class="card">
      <h3>Brutas</h3>
      <div class="kpi"><div id="kBrutas" class="big">—</div></div>
      <div class="sub muted">—</div>
    </div>
    <div class="card">
      <h3>Canônicas (DISTINCT)</h3>
      <div class="kpi"><div id="kCanon" class="big">—</div></div>
      <div class="sub muted">—</div>
    </div>
    <div class="card">
      <h3>Duplicatas (Brutas–Canon)</h3>
      <div class="kpi"><div id="kDup" class="big">—</div></div>
      <div class="sub muted">—</div>
    </div>
    <div class="card">
      <h3>% Duplicatas</h3>
      <div class="kpi"><div id="kDupPct" class="big">—</div></div>
      <div class="sub muted">—</div>
    </div>
  </div>

  <!-- KPIs PRINCIPAIS (com comparação) -->
  <div class="grid cols-3" style="margin-top:12px;">
    <div class="card">
      <h3>Pedidos</h3>
      <div class="kpi">
        <div id="kPedidos" class="big">—</div>
        <span id="tPedidos" class="trend">—</span>
      </div>
      <div class="sub muted" id="aPedidos">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Ticket Médio (líquido)</h3>
      <div class="kpi">
        <div id="kTicket" class="big">—</div>
        <span id="tTicket" class="trend">—</span>
      </div>
      <div class="sub muted" id="aTicket">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Faturamento (bruto)</h3>
      <div class="kpi">
        <div id="kFat" class="big">—</div>
        <span id="tFat" class="trend">—</span>
      </div>
      <div class="sub muted" id="aFat">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Faturamento Médio (por pedido)</h3>
      <div class="kpi">
        <div id="kFatMed" class="big">—</div>
        <span id="tFatMed" class="trend">—</span>
      </div>
      <div class="sub muted" id="aFatMed">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Incentivos (descontos)</h3>
      <div class="kpi">
        <div id="kDes" class="big">—</div>
        <span id="tDes" class="trend">—</span>
      </div>
      <div class="sub muted" id="aDes">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Incentivos Média (% do faturamento)</h3>
      <div class="kpi">
        <div id="kDesPct" class="big">—</div>
        <span id="tDesPct" class="trend">—</span>
      </div>
      <div class="sub muted" id="aDesPct">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Frete</h3>
      <div class="kpi">
        <div id="kFre" class="big">—</div>
        <span id="tFre" class="trend">—</span>
      </div>
      <div class="sub muted" id="aFre">Anterior: —</div>
    </div>

    <div class="card">
      <h3>Frete Médio (por pedido)</h3>
      <div class="kpi">
        <div id="kFreMed" class="big">—</div>
        <span id="tFreMed" class="trend">—</span>
      </div>
      <div class="sub muted" id="aFreMed">Anterior: —</div>
    </div>
  </div>

  <!-- GRÁFICO POR HORA -->
  <div class="card" style="margin-top:12px;">
    <h3>Receita por hora</h3>
    <canvas id="chartHora" height="140"></canvas>
  </div>
</div>

<script>
dayjs.extend(window.dayjs_plugin_utc);
dayjs.extend(window.dayjs_plugin_customParseFormat);

/** ====== CONFIG ====== **/
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** Use a VIEW numérica para evitar 400/22P02 */
const CANON_TABLE = 'vendas_canon_num';

/** ====== DOM ====== **/
const $ = (id)=>document.getElementById(id);
const fUnidade=$('fUnidade'), fLoja=$('fLoja'), fTurno=$('fTurno'),
      fDe=$('fDe'), fAte=$('fAte'), fRapido=$('fRapido'),
      fCanal=$('fCanal'), fPag=$('fPag'), fCanc=$('fCanc'),
      btnClear=$('btnClear');

/** ====== STATE ====== **/
let minDia=null, maxDia=null, chartHora=null;

/** ====== UTILS ====== **/
const fmtBRL = (n)=> (isFinite(n)? n : 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtPct = (n)=> (isFinite(n)? (n*100).toFixed(2).replace('.',',')+' %' : '—');
function parseSel(sel){
  return Array.from(sel.selectedOptions||[]).map(o=>o.value).filter(v=>v && v!=='Todos');
}
function setMulti(selectEl, arr){
  selectEl.innerHTML = arr.map(v=>`<option>${v}</option>`).join('');
}
function trend(now, prev){
  if(!prev || prev===0) return {txt:'—', cls:''};
  const d = now - prev;
  const pct = (d/prev)*100;
  const arrow = d>=0 ? '▲' : '▼';
  const cls = d>=0 ? 'up' : 'down';
  return {txt:`${arrow} ${isFinite(pct)? Math.abs(pct).toFixed(1).replace('.',',')+'%':'—'}`, cls};
}
function daysBetween(a,b){
  const da = dayjs(a), db = dayjs(b);
  return Math.max(1, db.diff(da,'day')+1);
}

/** ====== CARREGAR OPÇÕES & DATA RANGE ====== **/
async function loadRangesAndOptions(){
  // min/max (um único hit com agregadores)
  const r = await supa.from(CANON_TABLE).select('min:min(dia), max:max(dia)').single();
  if(r.error){ console.error(r.error); return; }
  minDia = r.data.min; maxDia = r.data.max;

  // default: último mês (30d) a partir do maxDia
  setQuickRange('30');

  // opções (dedup no cliente para evitar distinct issues)
  const [u,l,t,c,p] = await Promise.all([
    supa.from(CANON_TABLE).select('unidade').not('unidade','is',null).order('unidade'),
    supa.from(CANON_TABLE).select('loja').not('loja','is',null).order('loja'),
    supa.from(CANON_TABLE).select('turno').not('turno','is',null).order('turno'),
    supa.from(CANON_TABLE).select('canal').not('canal','is',null).order('canal'),
    supa.from(CANON_TABLE).select('pagamento_base').not('pagamento_base','is',null).order('pagamento_base'),
  ]);

  setMulti(fUnidade, [...new Set((u.data||[]).map(x=>x.unidade))]);
  setMulti(fLoja,     [...new Set((l.data||[]).map(x=>x.loja))]);
  setMulti(fTurno,    [...new Set((t.data||[]).map(x=>x.turno))]);
  setMulti(fCanal,    [...new Set((c.data||[]).map(x=>x.canal))]);
  setMulti(fPag,      [...new Set((p.data||[]).map(x=>x.pagamento_base))]);
}

/** ====== RANGE HELPERS ====== **/
function setQuickRange(val){
  fRapido.value = val;
  const end = dayjs(maxDia);
  if(val==='custom'){
    fDe.disabled=false; fAte.disabled=false;
    return;
  }
  const days = parseInt(val,10);
  const start = end.subtract(days-1,'day');
  fDe.value = start.format('YYYY-MM-DD');
  fAte.value = end.format('YYYY-MM-DD');
  fDe.disabled=true; fAte.disabled=true;
}

/** ====== QUERY BUILDER ====== **/
function applyFilters(q, startISO, endISO){
  q = q.gte('dia', startISO).lte('dia', endISO);

  const u = parseSel(fUnidade); if(u.length) q = q.in('unidade', u);
  const l = parseSel(fLoja);    if(l.length) q = q.in('loja', l);
  const t = parseSel(fTurno);   if(t.length) q = q.in('turno', t);
  const c = parseSel(fCanal);   if(c.length) q = q.in('canal', c);
  const p = parseSel(fPag);     if(p.length) q = q.in('pagamento_base', p);

  const canc = fCanc.value;
  if(canc!=='Todos') q = q.eq('cancelado', canc);

  return q;
}

/** ====== KPI FETCH ====== **/
async function fetchAgg(startISO, endISO){
  let q = supa.from(CANON_TABLE).select('ped:sum(pedidos),fat:sum(fat),des:sum(des),fre:sum(fre)');
  q = applyFilters(q, startISO, endISO);
  const r = await q.single();
  if(r.error){ console.error('Agg error', r.error); return {ped:0,fat:0,des:0,fre:0}; }
  const d = r.data||{};
  return {
    ped: Number(d.ped)||0,
    fat: Number(d.fat)||0,
    des: Number(d.des)||0,
    fre: Number(d.fre)||0
  };
}

/** ====== RESUMO (brutas/canon/dup) ====== **
 * Observação: como a base canon já é dedupe, reportamos brutas = canônicas para não retroceder.
 * Se quisermos brutas “reais”, mapeamos os filtros para public.vendas_xlsx (nomes com espaço).
 */
async function fillResumo(startISO, endISO){
  const cur = await fetchAgg(startISO, endISO);
  const brutas = cur.ped;     // mantendo igual para não retroceder
  const canon  = cur.ped;
  const dups   = Math.max(0, brutas - canon);
  const pct    = brutas? (dups/brutas) : 0;

  $('kBrutas').textContent = brutas.toLocaleString('pt-BR');
  $('kCanon').textContent  = canon.toLocaleString('pt-BR');
  $('kDup').textContent    = dups.toLocaleString('pt-BR');
  $('kDupPct').textContent = (pct*100).toFixed(2).replace('.',',')+' %';
}

/** ====== KPIs com comparação ====== **/
function putKPI(valEl, trendEl, antEl, now, prev, format='money'){
  const isMoney = format==='money';
  const showNow = isMoney? fmtBRL(now) : (isFinite(now)? now.toLocaleString('pt-BR'): '—');
  const showPrev = isMoney? fmtBRL(prev) : (isFinite(prev)? prev.toLocaleString('pt-BR'): '—');
  valEl.textContent = showNow;
  antEl.textContent = 'Anterior: '+ showPrev;
  const t = trend(now, prev);
  trendEl.textContent = t.txt;
  trendEl.className = 'trend ' + (t.cls||'');
}

async function fillKPIs(startISO, endISO, prevStartISO, prevEndISO){
  const [cur, prev] = await Promise.all([
    fetchAgg(startISO, endISO),
    fetchAgg(prevStartISO, prevEndISO)
  ]);

  // Derivados
  const ticketNow   = cur.ped? (cur.fat - cur.des - cur.fre)/cur.ped : 0; // Ticket líquido
  const ticketPrev  = prev.ped? (prev.fat - prev.des - prev.fre)/prev.ped : 0;
  const fatMedNow   = cur.ped? cur.fat/cur.ped : 0;                       // Faturamento por pedido (bruto)
  const fatMedPrev  = prev.ped? prev.fat/prev.ped : 0;
  const desPctNow   = cur.fat? (cur.des/cur.fat) : 0;
  const desPctPrev  = prev.fat? (prev.des/prev.fat) : 0;
  const freMedNow   = cur.ped? cur.fre/cur.ped : 0;
  const freMedPrev  = prev.ped? prev.fre/prev.ped : 0;

  // KPIs
  putKPI($('kPedidos'), $('tPedidos'), $('aPedidos'), cur.ped, prev.ped, 'int');
  putKPI($('kTicket'),  $('tTicket'),  $('aTicket'),  ticketNow, ticketPrev, 'money');
  putKPI($('kFat'),     $('tFat'),     $('aFat'),     cur.fat, prev.fat, 'money');
  putKPI($('kFatMed'),  $('tFatMed'),  $('aFatMed'),  fatMedNow, fatMedPrev, 'money');
  putKPI($('kDes'),     $('tDes'),     $('aDes'),     cur.des, prev.des, 'money');
  // % (mostra no formato 0,0%)
  const tDesPct = trend(desPctNow, desPctPrev);
  $('kDesPct').textContent = (desPctNow*100).toFixed(2).replace('.',',')+' %';
  $('aDesPct').textContent = 'Anterior: '+(desPctPrev*100).toFixed(2).replace('.',',')+' %';
  $('tDesPct').textContent = tDesPct.txt; $('tDesPct').className = 'trend '+(tDesPct.cls||'');
  putKPI($('kFre'),     $('tFre'),     $('aFre'),     cur.fre, prev.fre, 'money');
  putKPI($('kFreMed'),  $('tFreMed'),  $('aFreMed'),  freMedNow, freMedPrev, 'money');
}

/** ====== Gráfico por hora ====== **/
async function renderHora(startISO, endISO){
  // soma(fat) por hora
  let q = supa.from(CANON_TABLE).select('hora, val:sum(fat)').order('hora', {ascending:true});
  q = applyFilters(q, startISO, endISO);
  const r = await q;
  if(r.error){ console.error(r.error); return; }
  const rows = r.data||[];
  const labels = Array.from({length:24},(_,h)=>h); // 0..23
  const values = labels.map(h=>{
    const row = rows.find(x=> Number(x.hora)===h);
    return row? Number(row.val)||0 : 0;
  });

  if(chartHora) chartHora.destroy();
  const ctx = $('chartHora').getContext('2d');
  chartHora = new Chart(ctx,{
    type:'bar',
    data:{labels, datasets:[{label:'Receita (R$)', data: values}]},
    options:{
      responsive:true,
      scales:{
        x:{ticks:{callback:(v)=>labels[v]}},
        y:{ticks:{callback:(v)=> 'R$ '+Number(v).toLocaleString('pt-BR')}}
      }
    }
  });
}

/** ====== APLICAÇÃO (auto-aplicar filtros) ====== **/
function currentRanges(){
  const startISO = dayjs(fDe.value||maxDia).format('YYYY-MM-DD');
  const endISO   = dayjs(fAte.value||maxDia).format('YYYY-MM-DD');
  const span = daysBetween(startISO, endISO);
  const prevEndISO   = dayjs(startISO).subtract(1,'day').format('YYYY-MM-DD');
  const prevStartISO = dayjs(prevEndISO).subtract(span-1,'day').format('YYYY-MM-DD');
  return {startISO,endISO,prevStartISO,prevEndISO};
}

async function applyAll(){
  const {startISO,endISO,prevStartISO,prevEndISO} = currentRanges();
  await Promise.all([
    fillResumo(startISO, endISO),
    fillKPIs(startISO, endISO, prevStartISO, prevEndISO),
    renderHora(startISO, endISO)
  ]);
}

/** ====== EVENTOS ====== **/
fRapido.addEventListener('change', ()=>{
  setQuickRange(fRapido.value);
  applyAll();
});
[fDe,fAte].forEach(el=>{
  el.addEventListener('change', ()=>{
    fRapido.value='custom';
    fDe.disabled=false; fAte.disabled=false;
    applyAll();
  });
});
[fUnidade,fLoja,fTurno,fCanal,fPag,fCanc].forEach(el=>{
  el.addEventListener('change', applyAll);
});
btnClear.addEventListener('click', ()=>{
  // limpa seleções
  [fUnidade,fLoja,fTurno,fCanal,fPag].forEach(sel=> sel.selectedIndex=-1);
  fCanc.value='Não';
  setQuickRange('30');
  applyAll();
});

/** ====== BOOT ====== **/
(async function init(){
  await loadRangesAndOptions();
  await applyAll();
})();
</script>
</body>
</html>
