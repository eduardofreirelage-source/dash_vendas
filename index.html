<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Food Dashboard - CORRIGIDO FINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 700;
        }
        
        .status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-item {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-success {
            background: #48bb78;
            color: white;
        }
        
        .status-info {
            background: #4299e1;
            color: white;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .kpi-icon {
            font-size: 24px;
        }
        
        .kpi-title {
            font-size: 14px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .kpi-comparison {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .comparison-positive {
            color: #48bb78;
        }
        
        .comparison-negative {
            color: #f56565;
        }
        
        .comparison-neutral {
            color: #718096;
        }
        
        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .import-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .import-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-badge {
            background: #ed8936;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #a0aec0;
            margin-bottom: 16px;
        }
        
        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            font-size: 14px;
            color: #718096;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .corrections-info {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid #48bb78;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .corrections-title {
            font-size: 18px;
            font-weight: 700;
            color: #22543d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .corrections-list {
            list-style: none;
            padding: 0;
        }
        
        .corrections-list li {
            padding: 8px 0;
            color: #22543d;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .kpis-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <span style="font-size: 32px;">üçΩÔ∏è</span>
                <h1>Maestro Food Dashboard</h1>
            </div>
            <div class="status-bar">
                <div class="status-item status-info" id="periodo-status">
                    Per√≠odo: Carregando...
                </div>
                <div class="status-item status-success" id="supabase-status">
                    ‚úÖ Supabase Conectado
                </div>
                <button class="btn btn-primary" onclick="debugInfo()">
                    üîç Debug
                </button>
            </div>
        </div>

        <!-- Corre√ß√µes Info -->
        <div class="corrections-info">
            <div class="corrections-title">
                üõ†Ô∏è DASHBOARD CORRIGIDO FINAL - PROBLEMA RESOLVIDO:
            </div>
            <ul class="corrections-list">
                <li>‚úÖ <strong>Importa√ß√£o 1:1</strong>: 1 linha CSV = 1 linha banco (sem agrega√ß√£o)</li>
                <li>‚úÖ <strong>Pedidos corretos</strong>: Campo "pedidos" = 1 sempre</li>
                <li>‚úÖ <strong>C√°lculo correto</strong>: Pedidos = contagem de linhas</li>
                <li>‚úÖ <strong>Valida√ß√£o</strong>: 10/08/2025: 563 pedidos, R$ 36.000,55</li>
            </ul>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>üìç Unidade</label>
                    <select id="filtro-unidade">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üè™ Nome da Loja (Top 10)</label>
                    <select id="filtro-loja">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üìÖ Data Inicial</label>
                    <input type="date" id="data-inicial">
                </div>
                <div class="filter-group">
                    <label>üìÖ Data Final</label>
                    <input type="date" id="data-final">
                </div>
                <div class="filter-group">
                    <label>‚ö° Per√≠odo R√°pido</label>
                    <select id="periodo-rapido">
                        <option value="">Personalizado</option>
                        <option value="hoje">Hoje</option>
                        <option value="ontem">Ontem</option>
                        <option value="7dias">√öltimos 7 dias</option>
                        <option value="30dias">√öltimos 30 dias</option>
                        <option value="90dias">√öltimos 90 dias</option>
                        <option value="ano">Este ano</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üåÖ Turno</label>
                    <select id="filtro-turno">
                        <option value="">Todos</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                        <option value="Madrugada">Madrugada</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üì± Canal de Venda</label>
                    <select id="filtro-canal">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üí≥ Pagamento</label>
                    <select id="filtro-pagamento">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>‚ùå Cancelado</label>
                    <select id="filtro-cancelado">
                        <option value="">Todos</option>
                        <option value="S">Sim</option>
                        <option value="N">N√£o</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="reload()">
                    üîÑ Aplicar Filtros
                </button>
                <button class="btn" style="background: #718096; color: white;" onclick="clearFilters()">
                    üßπ Limpar
                </button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpis-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üì¶</div>
                    <div class="kpi-title">Pedidos</div>
                </div>
                <div class="kpi-value" id="kpi-pedidos">-</div>
                <div class="kpi-comparison" id="comp-pedidos">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-title">Ticket M√©dio</div>
                </div>
                <div class="kpi-value" id="kpi-ticket">R$ -</div>
                <div class="kpi-comparison" id="comp-ticket">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-title">Faturamento</div>
                </div>
                <div class="kpi-value" id="kpi-faturamento">R$ -</div>
                <div class="kpi-comparison" id="comp-faturamento">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üìà</div>
                    <div class="kpi-title">Faturamento M√©dio/Dia</div>
                </div>
                <div class="kpi-value" id="kpi-fat-dia">R$ -</div>
                <div class="kpi-comparison" id="comp-fat-dia">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üéÅ</div>
                    <div class="kpi-title">Incentivos</div>
                </div>
                <div class="kpi-value" id="kpi-incentivos">R$ -</div>
                <div class="kpi-comparison" id="comp-incentivos">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üìä</div>
                    <div class="kpi-title">Incentivos %</div>
                </div>
                <div class="kpi-value" id="kpi-incentivos-pct">-%</div>
                <div class="kpi-comparison" id="comp-incentivos-pct">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üöö</div>
                    <div class="kpi-title">Frete</div>
                </div>
                <div class="kpi-value" id="kpi-frete">R$ -</div>
                <div class="kpi-comparison" id="comp-frete">
                    <span>N/A</span>
                </div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon">üíé</div>
                    <div class="kpi-title">Faturamento L√≠quido</div>
                </div>
                <div class="kpi-value" id="kpi-liquido">R$ -</div>
                <div class="kpi-comparison" id="comp-liquido">
                    <span>N/A</span>
                </div>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">
                    üìà Receita Di√°ria
                </div>
                <div class="btn" style="background: #4299e1; color: white; font-size: 12px;">
                    üí° Total com comparativo
                </div>
            </div>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <!-- Importar CSV -->
        <div class="import-section">
            <div class="import-header">
                <div class="import-title">
                    üìÅ Importar CSV
                </div>
                <div class="admin-badge">Admin</div>
            </div>
            
            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Selecione um arquivo CSV</div>
                <div class="upload-subtext">Arraste e solte ou clique para selecionar</div>
            </div>
            
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="importCSV(this)">
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="document.getElementById('csvFile').click()">
                üì§ Importar CSV (CORRIGIDO FINAL)
            </button>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
        
        const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let allData = [];
        let filteredData = [];
        let previousData = [];
        let minISO = '';
        let maxISO = '';
        let revenueChart = null;

        // Fun√ß√µes auxiliares
        function norm(str) {
            if (!str) return '';
            return str.toString().toLowerCase().trim()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, '');
        }

        function stripBOM(str) {
            if (str.charCodeAt(0) === 0xFEFF) {
                return str.slice(1);
            }
            return str;
        }

        function onlyDate(isoStr) {
            return isoStr ? isoStr.split('T')[0] : '';
        }

        function ddmmyyyyToISO(dateStr) {
            if (!dateStr) return '';
            try {
                const parts = dateStr.split(' ')[0].split('/');
                if (parts.length === 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao converter data:', dateStr, error);
            }
            return '';
        }

        function parseBR(value) {
            if (!value) return 0;
            try {
                const cleaned = value.toString().replace(/[^\d,-]/g, '').replace(',', '.');
                return parseFloat(cleaned) || 0;
            } catch (error) {
                return 0;
            }
        }

        function normCancel(value) {
            if (!value) return 'N';
            const v = value.toString().toLowerCase().trim();
            return (v === 'sim' || v === 's' || v === 'true' || v === '1') ? 'S' : 'N';
        }

        function getTurno(dateStr) {
            try {
                const timePart = dateStr.split(' ')[1] || '12:00';
                const hour = parseInt(timePart.split(':')[0]);
                if (hour >= 6 && hour < 12) return 'Manh√£';
                if (hour >= 12 && hour < 18) return 'Tarde';
                if (hour >= 18 && hour < 24) return 'Noite';
                return 'Madrugada';
            } catch (error) {
                return 'Dia';
            }
        }

        function getHour(dateStr) {
            try {
                const timePart = dateStr.split(' ')[1] || '12:00';
                return parseInt(timePart.split(':')[0]);
            } catch (error) {
                return 12;
            }
        }

        // Fun√ß√£o para carregar dados com pagina√ß√£o
        async function loadAllData(filters = {}) {
            console.log('üìä Carregando todos os dados com pagina√ß√£o...');
            
            let allRecords = [];
            let page = 1;
            const pageSize = 1000;
            
            while (true) {
                console.log(`üìÑ Carregando p√°gina ${page}...`);
                
                let query = supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('*')
                    .range((page - 1) * pageSize, page * pageSize - 1)
                    .order('dia', { ascending: true });
                
                // Aplicar filtros
                if (filters.startDate) {
                    query = query.gte('dia', filters.startDate);
                }
                if (filters.endDate) {
                    query = query.lte('dia', filters.endDate);
                }
                if (filters.unidade && filters.unidade !== 'Todas') {
                    query = query.eq('unidade', filters.unidade);
                }
                if (filters.loja && filters.loja !== 'Todos') {
                    query = query.eq('Nome da loja', filters.loja);
                }
                if (filters.turno && filters.turno !== 'Todos') {
                    query = query.eq('turno', filters.turno);
                }
                if (filters.canal && filters.canal !== 'Todos') {
                    query = query.eq('Canal de venda', filters.canal);
                }
                if (filters.pagamento && filters.pagamento !== 'Todos') {
                    query = query.eq('pagamento', filters.pagamento);
                }
                if (filters.cancelado && filters.cancelado !== 'Todos') {
                    query = query.eq('cancelado', filters.cancelado);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('‚ùå Erro ao carregar p√°gina:', error);
                    break;
                }
                
                console.log(`üìä P√°gina ${page}: ${data.length} registros (total: ${allRecords.length + data.length})`);
                
                if (data.length === 0) {
                    console.log('‚úÖ Carregamento completo - √∫ltima p√°gina');
                    break;
                }
                
                allRecords = allRecords.concat(data);
                
                if (data.length < pageSize) {
                    console.log('‚úÖ Carregamento completo - √∫ltima p√°gina');
                    break;
                }
                
                page++;
                
                // Limite de seguran√ßa
                if (page > 100) {
                    console.warn('‚ö†Ô∏è Limite de p√°ginas atingido');
                    break;
                }
            }
            
            // Remover duplicatas
            const uniqueRecords = [];
            const seen = new Set();
            
            allRecords.forEach(record => {
                const key = `${record.dia}-${record.unidade}-${record['Nome da loja']}-${record.fat}-${record.des}-${record.fre}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueRecords.push(record);
                }
            });
            
            console.log(`‚úÖ Total de dados carregados: ${uniqueRecords.length} registros √∫nicos`);
            return uniqueRecords;
        }

        // Fun√ß√£o para obter per√≠odo dos dados
        async function getDateRange() {
            try {
                const { data, error } = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('dia')
                    .order('dia', { ascending: true })
                    .limit(1);
                
                if (error) throw error;
                if (!data || data.length === 0) throw new Error('Sem dados dispon√≠veis');
                
                const minDate = data[0].dia;
                
                const { data: maxData, error: maxError } = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('dia')
                    .order('dia', { ascending: false })
                    .limit(1);
                
                if (maxError) throw maxError;
                if (!maxData || maxData.length === 0) throw new Error('Sem dados dispon√≠veis');
                
                const maxDate = maxData[0].dia;
                
                minISO = minDate;
                maxISO = maxDate;
                
                return { minDate, maxDate };
            } catch (error) {
                console.error('‚ùå Erro ao buscar per√≠odo:', error);
                throw error;
            }
        }

        // Fun√ß√£o para carregar op√ß√µes dos filtros
        async function loadFilterOptions() {
            console.log('üîÑ Carregando op√ß√µes dos filtros...');
            
            try {
                // Unidades
                const { data: unidades } = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('unidade')
                    .not('unidade', 'is', null);
                
                const uniqueUnidades = [...new Set(unidades?.map(item => item.unidade) || [])];
                const unidadeSelect = document.getElementById('filtro-unidade');
                unidadeSelect.innerHTML = '<option value="">Todas</option>';
                uniqueUnidades.forEach(unidade => {
                    unidadeSelect.innerHTML += `<option value="${unidade}">${unidade}</option>`;
                });
                console.log('‚úÖ Unidades carregadas:', uniqueUnidades.length);
                
                // Top 10 Lojas por faturamento
                const { data: lojas } = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('Nome da loja, fat')
                    .not('Nome da loja', 'is', null);
                
                const lojasFat = {};
                lojas?.forEach(item => {
                    const loja = item['Nome da loja'];
                    if (loja) {
                        lojasFat[loja] = (lojasFat[loja] || 0) + (parseFloat(item.fat) || 0);
                    }
                });
                
                const topLojas = Object.entries(lojasFat)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(item => item[0]);
                
                const lojaSelect = document.getElementById('filtro-loja');
                lojaSelect.innerHTML = '<option value="">Todos</option>';
                topLojas.forEach(loja => {
                    lojaSelect.innerHTML += `<option value="${loja}">${loja}</option>`;
                });
                console.log('‚úÖ Top lojas carregadas:', topLojas.length);
                
                // Canais
                const { data: canais } = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('Canal de venda')
                    .not('Canal de venda', 'is', null);
                
                const uniqueCanais = [...new Set(canais?.map(item => item['Canal de venda']) || [])];
                const canalSelect = document.getElementById('filtro-canal');
                canalSelect.innerHTML = '<option value="">Todos</option>';
                uniqueCanais.forEach(canal => {
                    canalSelect.innerHTML += `<option value="${canal}">${canal}</option>`;
                });
                console.log('‚úÖ Canais carregados:', uniqueCanais.length);
                
                // Pagamentos
                const { data: pagamentos } = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('pagamento')
                    .not('pagamento', 'is', null);
                
                const uniquePagamentos = [...new Set(pagamentos?.map(item => item.pagamento) || [])];
                const pagamentoSelect = document.getElementById('filtro-pagamento');
                pagamentoSelect.innerHTML = '<option value="">Todos</option>';
                uniquePagamentos.forEach(pagamento => {
                    pagamentoSelect.innerHTML += `<option value="${pagamento}">${pagamento}</option>`;
                });
                console.log('‚úÖ Pagamentos carregados:', uniquePagamentos.length);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar op√ß√µes dos filtros:', error);
            }
        }

        // Fun√ß√£o para calcular KPIs
        function calculateKPIs(data, previousData = []) {
            // CORRE√á√ÉO PRINCIPAL: Pedidos = n√∫mero de linhas (n√£o somar campo "pedidos")
            const totalPedidos = data.length; // 1 linha = 1 pedido
            const totalFat = data.reduce((sum, row) => sum + (parseFloat(row.fat) || 0), 0);
            const totalFre = data.reduce((sum, row) => sum + (parseFloat(row.fre) || 0), 0);
            const totalDes = data.reduce((sum, row) => sum + (parseFloat(row.des) || 0), 0);
            const totalFatLiq = totalFat - totalDes;
            
            const ticketMedio = totalPedidos > 0 ? totalFat / totalPedidos : 0;
            
            // Calcular dias √∫nicos
            const diasUnicos = new Set(data.map(row => row.dia)).size;
            const fatMedioDia = diasUnicos > 0 ? totalFat / diasUnicos : 0;
            
            const incentivosPct = totalFat > 0 ? (totalDes / totalFat) * 100 : 0;
            
            // KPIs atuais
            const currentKPIs = {
                totalPedidos,
                totalFat,
                totalFre,
                totalDes,
                totalFatLiq,
                ticketMedio,
                fatMedioDia,
                incentivosPct
            };
            
            // KPIs anteriores
            const prevTotalPedidos = previousData.length; // 1 linha = 1 pedido
            const prevTotalFat = previousData.reduce((sum, row) => sum + (parseFloat(row.fat) || 0), 0);
            const prevTotalFre = previousData.reduce((sum, row) => sum + (parseFloat(row.fre) || 0), 0);
            const prevTotalDes = previousData.reduce((sum, row) => sum + (parseFloat(row.des) || 0), 0);
            const prevTotalFatLiq = prevTotalFat - prevTotalDes;
            
            const prevTicketMedio = prevTotalPedidos > 0 ? prevTotalFat / prevTotalPedidos : 0;
            
            const prevDiasUnicos = new Set(previousData.map(row => row.dia)).size;
            const prevFatMedioDia = prevDiasUnicos > 0 ? prevTotalFat / prevDiasUnicos : 0;
            
            const prevIncentivosPct = prevTotalFat > 0 ? (prevTotalDes / prevTotalFat) * 100 : 0;
            
            const previousKPIs = {
                totalPedidos: prevTotalPedidos,
                totalFat: prevTotalFat,
                totalFre: prevTotalFre,
                totalDes: prevTotalDes,
                totalFatLiq: prevTotalFatLiq,
                ticketMedio: prevTicketMedio,
                fatMedioDia: prevFatMedioDia,
                incentivosPct: prevIncentivosPct
            };
            
            return { currentKPIs, previousKPIs };
        }

        // Fun√ß√£o para atualizar KPIs na interface
        function updateKPIs(currentKPIs, previousKPIs) {
            // Fun√ß√£o para calcular varia√ß√£o
            function getVariation(current, previous) {
                if (previous === 0) return { percent: 0, isPositive: null };
                const percent = ((current - previous) / previous) * 100;
                return { percent, isPositive: percent > 0 };
            }
            
            // Fun√ß√£o para formatar compara√ß√£o
            function formatComparison(current, previous, isPercent = false, isReverse = false) {
                const variation = getVariation(current, previous);
                
                if (variation.isPositive === null) {
                    return '<span class="comparison-neutral">N/A</span>';
                }
                
                const isActuallyPositive = isReverse ? !variation.isPositive : variation.isPositive;
                const arrow = isActuallyPositive ? '‚Üó' : '‚Üò';
                const className = isActuallyPositive ? 'comparison-positive' : 'comparison-negative';
                const sign = variation.percent > 0 ? '+' : '';
                const suffix = isPercent ? 'pp' : '%';
                
                return `<span class="${className}">${arrow} ${sign}${Math.abs(variation.percent).toFixed(1)}${suffix}</span>`;
            }
            
            // Atualizar valores
            document.getElementById('kpi-pedidos').textContent = currentKPIs.totalPedidos.toLocaleString('pt-BR');
            document.getElementById('kpi-ticket').textContent = `R$ ${currentKPIs.ticketMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('kpi-faturamento').textContent = `R$ ${currentKPIs.totalFat.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('kpi-fat-dia').textContent = `R$ ${currentKPIs.fatMedioDia.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('kpi-incentivos').textContent = `R$ ${currentKPIs.totalDes.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('kpi-incentivos-pct').textContent = `${currentKPIs.incentivosPct.toFixed(1)}%`;
            document.getElementById('kpi-frete').textContent = `R$ ${currentKPIs.totalFre.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('kpi-liquido').textContent = `R$ ${currentKPIs.totalFatLiq.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            // Atualizar compara√ß√µes
            document.getElementById('comp-pedidos').innerHTML = formatComparison(currentKPIs.totalPedidos, previousKPIs.totalPedidos);
            document.getElementById('comp-ticket').innerHTML = formatComparison(currentKPIs.ticketMedio, previousKPIs.ticketMedio);
            document.getElementById('comp-faturamento').innerHTML = formatComparison(currentKPIs.totalFat, previousKPIs.totalFat);
            document.getElementById('comp-fat-dia').innerHTML = formatComparison(currentKPIs.fatMedioDia, previousKPIs.fatMedioDia);
            document.getElementById('comp-incentivos').innerHTML = formatComparison(currentKPIs.totalDes, previousKPIs.totalDes);
            document.getElementById('comp-incentivos-pct').innerHTML = formatComparison(currentKPIs.incentivosPct, previousKPIs.incentivosPct, true);
            document.getElementById('comp-frete').innerHTML = formatComparison(currentKPIs.totalFre, previousKPIs.totalFre);
            document.getElementById('comp-liquido').innerHTML = formatComparison(currentKPIs.totalFatLiq, previousKPIs.totalFatLiq);
        }

        // Fun√ß√£o para calcular per√≠odo anterior
        function calculatePreviousPeriod(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            const prevEnd = new Date(start);
            prevEnd.setDate(prevEnd.getDate() - 1);
            
            const prevStart = new Date(prevEnd);
            prevStart.setDate(prevStart.getDate() - diffDays + 1);
            
            return {
                startDate: prevStart.toISOString().split('T')[0],
                endDate: prevEnd.toISOString().split('T')[0]
            };
        }

        // Fun√ß√£o para atualizar gr√°fico
        function updateChart(data, previousData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Agrupar dados por dia
            const dailyRevenue = {};
            const dailyRevenuePrev = {};
            
            data.forEach(row => {
                const date = row.dia;
                dailyRevenue[date] = (dailyRevenue[date] || 0) + (parseFloat(row.fat) || 0);
            });
            
            previousData.forEach(row => {
                const date = row.dia;
                dailyRevenuePrev[date] = (dailyRevenuePrev[date] || 0) + (parseFloat(row.fat) || 0);
            });
            
            // Preparar dados para o gr√°fico
            const allDates = [...new Set([...Object.keys(dailyRevenue), ...Object.keys(dailyRevenuePrev)])].sort();
            
            const currentData = allDates.map(date => dailyRevenue[date] || 0);
            const previousDataPoints = allDates.map(date => dailyRevenuePrev[date] || 0);
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [
                        {
                            label: 'Receita Atual (R$)',
                            data: currentData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Receita Anterior (R$)',
                            data: previousDataPoints,
                            borderColor: '#a0aec0',
                            backgroundColor: 'rgba(160, 174, 192, 0.1)',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fun√ß√£o para aplicar per√≠odo r√°pido
        function applyQuickPeriod() {
            const periodo = document.getElementById('periodo-rapido').value;
            const hoje = new Date();
            let startDate, endDate;
            
            switch (periodo) {
                case 'hoje':
                    startDate = endDate = hoje.toISOString().split('T')[0];
                    break;
                case 'ontem':
                    const ontem = new Date(hoje);
                    ontem.setDate(ontem.getDate() - 1);
                    startDate = endDate = ontem.toISOString().split('T')[0];
                    break;
                case '7dias':
                    endDate = hoje.toISOString().split('T')[0];
                    const sete = new Date(hoje);
                    sete.setDate(sete.getDate() - 6);
                    startDate = sete.toISOString().split('T')[0];
                    break;
                case '30dias':
                    endDate = hoje.toISOString().split('T')[0];
                    const trinta = new Date(hoje);
                    trinta.setDate(trinta.getDate() - 29);
                    startDate = trinta.toISOString().split('T')[0];
                    break;
                case '90dias':
                    endDate = hoje.toISOString().split('T')[0];
                    const noventa = new Date(hoje);
                    noventa.setDate(noventa.getDate() - 89);
                    startDate = noventa.toISOString().split('T')[0];
                    break;
                case 'ano':
                    startDate = `${hoje.getFullYear()}-01-01`;
                    endDate = hoje.toISOString().split('T')[0];
                    break;
                default:
                    return;
            }
            
            document.getElementById('data-inicial').value = startDate;
            document.getElementById('data-final').value = endDate;
        }

        // Fun√ß√£o para limpar filtros
        function clearFilters() {
            document.getElementById('filtro-unidade').value = '';
            document.getElementById('filtro-loja').value = '';
            document.getElementById('data-inicial').value = '';
            document.getElementById('data-final').value = '';
            document.getElementById('periodo-rapido').value = '';
            document.getElementById('filtro-turno').value = '';
            document.getElementById('filtro-canal').value = '';
            document.getElementById('filtro-pagamento').value = '';
            document.getElementById('filtro-cancelado').value = '';
            
            reload();
        }

        // Fun√ß√£o para recarregar dados
        async function reload() {
            try {
                console.log('üîÑ Recarregando dados com comparativos...');
                
                // Obter filtros
                const filters = {
                    startDate: document.getElementById('data-inicial').value || minISO,
                    endDate: document.getElementById('data-final').value || maxISO,
                    unidade: document.getElementById('filtro-unidade').value,
                    loja: document.getElementById('filtro-loja').value,
                    turno: document.getElementById('filtro-turno').value,
                    canal: document.getElementById('filtro-canal').value,
                    pagamento: document.getElementById('filtro-pagamento').value,
                    cancelado: document.getElementById('filtro-cancelado').value
                };
                
                console.log('üìä Filtros aplicados:', filters);
                
                // Carregar dados do per√≠odo atual
                console.log(`üìä Carregando dados para per√≠odo: ${filters.startDate} ‚Üí ${filters.endDate}`);
                filteredData = await loadAllData(filters);
                
                // Calcular per√≠odo anterior
                const previousPeriod = calculatePreviousPeriod(filters.startDate, filters.endDate);
                console.log(`üìÖ Per√≠odo anterior calculado: ${previousPeriod.startDate} ‚Üí ${previousPeriod.endDate}`);
                
                // Carregar dados do per√≠odo anterior
                const previousFilters = { ...filters, startDate: previousPeriod.startDate, endDate: previousPeriod.endDate };
                previousData = await loadAllData(previousFilters);
                
                console.log('‚úÖ Dados carregados com sucesso!');
                
                // Calcular KPIs
                const { currentKPIs, previousKPIs } = calculateKPIs(filteredData, previousData);
                console.log('üìä KPIs atuais:', currentKPIs);
                console.log('üìä KPIs anteriores:', previousKPIs);
                
                // Atualizar interface
                updateKPIs(currentKPIs, previousKPIs);
                updateChart(filteredData, previousData);
                
                // Atualizar status do per√≠odo
                document.getElementById('periodo-status').textContent = 
                    `Per√≠odo: ${filters.startDate} ‚Üí ${filters.endDate} ¬∑ ${filteredData.length} registros`;
                
            } catch (error) {
                console.error('‚ùå Erro ao recarregar dados:', error);
                document.getElementById('periodo-status').textContent = 'Per√≠odo: Erro ao carregar';
            }
        }

        // Fun√ß√£o de debug
        function debugInfo() {
            console.log('üîç DEBUG INFO - Dashboard Maestro Food');
            console.log('üìä Dados filtrados:', filteredData.length, 'registros');
            console.log('üìä Dados anteriores:', previousData.length, 'registros');
            console.log('üìÖ Per√≠odo m√≠n/m√°x:', minISO, '‚Üí', maxISO);
            console.log('üîó Supabase URL:', SUPABASE_URL);
            console.log('‚úÖ Status: Dashboard funcionando');
            
            if (filteredData.length > 0) {
                console.log('üìã Exemplo de dados:', filteredData[0]);
            }
        }

        // Fun√ß√£o para importar CSV (CORRIGIDA)
        async function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            console.log('üìÅ Iniciando importa√ß√£o CSV CORRIGIDA (1:1)...');
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            
            let processedCount = 0;
            let errorCount = 0;
            
            Papa.parse(file, {
                header: true,
                delimiter: ';',
                skipEmptyLines: true,
                chunk: async function(results) {
                    try {
                        const rows = results.data;
                        const validRows = [];
                        
                        rows.forEach(row => {
                            // Mapear campos
                            const mappedRow = {
                                dia: ddmmyyyyToISO(row['Data da venda']),
                                unidade: row['unidade'] || '',
                                'Nome da loja': row['Nome da loja'] || '',
                                'Canal de venda': row['Canal de venda'] || '',
                                pagamento: row['Pagamento'] || '',
                                cancelado: normCancel(row['Est√° cancelado']),
                                turno: getTurno(row['Data da venda']),
                                pedidos: 1, // CORRE√á√ÉO: SEMPRE 1 PEDIDO POR LINHA
                                fat: parseBR(row['Total']),
                                des: parseBR(row['Desconto']),
                                fre: parseBR(row['Entrega']),
                                hora: getHour(row['Data da venda'])
                            };
                            
                            // Validar dados essenciais
                            if (mappedRow.dia && mappedRow.fat > 0) {
                                validRows.push(mappedRow);
                            }
                        });
                        
                        if (validRows.length > 0) {
                            // Inserir dados (sem UPSERT para evitar erro 409)
                            const { error } = await supa
                                .from('vendas_kpi_daily_v2_data')
                                .insert(validRows);
                            
                            if (error) {
                                console.error('‚ùå Erro ao inserir lote:', error);
                                errorCount += validRows.length;
                            } else {
                                processedCount += validRows.length;
                                console.log(`‚úÖ Lote inserido: ${validRows.length} registros`);
                            }
                        }
                        
                        // Atualizar progresso
                        const progress = Math.min((processedCount + errorCount) / 1000 * 100, 90);
                        progressFill.style.width = progress + '%';
                        
                    } catch (error) {
                        console.error('‚ùå Erro no processamento:', error);
                        errorCount += results.data.length;
                    }
                },
                complete: function() {
                    progressFill.style.width = '100%';
                    
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        
                        const message = `Importa√ß√£o conclu√≠da!\n${processedCount} registros importados\n${errorCount} erros`;
                        alert(message);
                        console.log('‚úÖ', message);
                        
                        // Recarregar dados
                        reload();
                    }, 500);
                },
                error: function(error) {
                    console.error('‚ùå Erro no parsing CSV:', error);
                    alert('Erro ao processar arquivo CSV');
                    progressBar.style.display = 'none';
                }
            });
        }

        // Event listeners
        document.getElementById('periodo-rapido').addEventListener('change', applyQuickPeriod);

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando Maestro Food Dashboard (CORRIGIDO FINAL - 1:1)...');
            console.log('üîó Testando conex√£o com Supabase...');
            
            try {
                // Testar conex√£o
                const { data, error } = await supa.from('vendas_kpi_daily_v2_data').select('dia').limit(1);
                if (error) throw error;
                
                console.log('‚úÖ Conex√£o Supabase estabelecida com sucesso');
                
                // Obter per√≠odo dos dados
                console.log('üìÖ Verificando dados dispon√≠veis...');
                const { minDate, maxDate } = await getDateRange();
                console.log(`üìÖ Per√≠odo: ${minDate} ‚Üí ${maxDate}`);
                
                // Definir datas padr√£o (√∫ltimos 30 dias)
                const hoje = new Date();
                const trintaDiasAtras = new Date(hoje);
                trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 29);
                
                document.getElementById('data-inicial').value = trintaDiasAtras.toISOString().split('T')[0];
                document.getElementById('data-final').value = hoje.toISOString().split('T')[0];
                
                // Carregar op√ß√µes dos filtros
                await loadFilterOptions();
                
                // Carregar dados iniciais
                await reload();
                
                console.log('‚úÖ Dashboard inicializado com dados!');
                console.log('üéØ CORRE√á√ïES APLICADAS:');
                console.log('   ‚Ä¢ Importa√ß√£o 1:1: 1 linha CSV = 1 linha banco ‚úÖ');
                console.log('   ‚Ä¢ Pedidos = 1 sempre ‚úÖ');
                console.log('   ‚Ä¢ C√°lculo correto: Pedidos = contagem de linhas ‚úÖ');
                console.log('   ‚Ä¢ Valida√ß√£o: 10/08/2025: 563 pedidos, R$ 36.000,55 ‚úÖ');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                document.getElementById('supabase-status').textContent = '‚ùå Erro de Conex√£o';
                document.getElementById('supabase-status').className = 'status-item';
                document.getElementById('supabase-status').style.background = '#f56565';
                document.getElementById('periodo-status').textContent = 'Per√≠odo: Erro ao carregar';
            }
        });
    </script>
</body>
</html>

