<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Dash Vendas – Smoke Test v2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:24px;line-height:1.35}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px}
    label{font-size:12px;color:#555;display:block;margin-bottom:6px}
    input,button,textarea{padding:8px 10px;border:1px solid #ccc;border-radius:8px}
    input[type=date]{padding:6px 8px}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
    .kpi{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:12px}
    .ok{color:#0a7d33;font-weight:600}
    .fail{color:#b00020;font-weight:600}
    pre{white-space:pre-wrap;background:#0b1020;color:#d6e2ff;border-radius:10px;padding:12px;max-height:360px;overflow:auto}
    small{color:#666}
  </style>
</head>
<body>
  <h2>Dash Vendas – Smoke Test (KPI × Charts v2)</h2>

  <div class="row">
    <div class="card">
      <label>Supabase URL</label>
      <input id="sb-url" size="48" value="https://uahmcfzerofhzjvlzrqc.supabase.co"/>
      <label>Anon Key</label>
      <input id="sb-key" size="80" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU"/>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <label>Data inicial</label>
      <input type="date" id="dini"/>
    </div>
    <div class="card">
      <label>Data final</label>
      <input type="date" id="dfim"/>
    </div>
    <div class="card">
      <label>Unidades (vírgula)</label>
      <input id="unids" placeholder="ex: uni.raja,uni.savassi"/>
      <small>Deixe vazio para todas</small>
    </div>
    <div class="card">
      <label>Lojas (vírgula)</label>
      <input id="lojas" placeholder="ex: loja a,loja b"/>
    </div>
    <div class="card">
      <label>Turnos (vírgula)</label>
      <input id="turnos" placeholder="Manhã,Dia,Noite"/>
    </div>
    <div class="card">
      <label>Canais (vírgula)</label>
      <input id="canais" placeholder="ex: ifood,telefone"/>
    </div>
    <div class="card">
      <label>Pagamentos (vírgula)</label>
      <input id="pags" placeholder="ex: pix,pago online"/>
    </div>
    <div class="card">
      <label>Cancelado (Sim/Não ou vazio)</label>
      <input id="cancel" placeholder="Sim | Não"/>
    </div>
  </div>

  <div class="row">
    <button id="btn-kpi">Aplicar filtros & carregar KPI</button>
    <button id="btn-test">Rodar TESTES (comparar KPI × DOW/MÊS/HORA/TURNO)</button>
  </div>

  <div class="kpis" id="kpis">
    <div class="kpi"><div><b>Pedidos</b></div><div id="kpi-ped">–</div></div>
    <div class="kpi"><div><b>Faturamento</b></div><div id="kpi-fat">–</div></div>
    <div class="kpi"><div><b>Descontos</b></div><div id="kpi-des">–</div></div>
    <div class="kpi"><div><b>Frete</b></div><div id="kpi-fre">–</div></div>
  </div>

  <p><b>Resultado dos testes:</b> <span id="res" class=""></span></p>
  <pre id="log"></pre>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
  <script>
    let supa = null;
    const $ = sel => document.querySelector(sel);
    const log = (...a) => { const pre = $('#log'); pre.textContent += a.map(x => typeof x==='object'? JSON.stringify(x,null,2): String(x)).join(' ') + "\n"; pre.scrollTop = pre.scrollHeight; };

    const money = (x)=> {
      const n = Number(x||0);
      return n.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    };
    const arrOrNull = (s) => {
      if(!s) return null;
      const arr = s.split(',').map(x=>x.trim()).filter(Boolean);
      return arr.length ? arr : null;
    };

    function buildParams(){
      const p = {
        p_dini: $('#dini').value ? $('#dini').value : null,
        p_dfim: $('#dfim').value ? $('#dfim').value : null,
        p_unids: arrOrNull($('#unids').value),
        p_lojas: arrOrNull($('#lojas').value),
        p_turnos: arrOrNull($('#turnos').value),
        p_canais: arrOrNull($('#canais').value),
        p_pags: arrOrNull($('#pags').value),
        p_cancelado: $('#cancel').value ? $('#cancel').value : null,
      };
      return p;
    }

    async function ensureClient(){
      const url = $('#sb-url').value.trim();
      const key = $('#sb-key').value.trim();
      if(!supa || supa.restUrl !== url){
        supa = window.supabase.createClient(url, key, { auth: { persistSession: false } });
        log('✅ Supabase client ok');
      }
    }

    async function getKPI(){
      await ensureClient();
      const params = buildParams();
      log('→ KPI params', params);
      const { data, error } = await supa.rpc('kpi_vendas_v2', params);
      if(error){ log('❌ KPI error', error); throw error; }
      const row = (data && data[0]) || { pedidos:0, fat:0, des:0, fre:0 };
      $('#kpi-ped').textContent = row.pedidos ?? 0;
      $('#kpi-fat').textContent = money(row.fat);
      $('#kpi-des').textContent = money(row.des);
      $('#kpi-fre').textContent = money(row.fre);
      log('✅ KPI', row);
      return row;
    }

    async function chart(kind){
      const fname = `chart_vendas_${kind}_v2`;
      const params = buildParams();
      const { data, error } = await supa.rpc(fname, params);
      if(error){ log(`❌ ${fname} error`, error); throw error; }
      log(`✅ ${fname}`, data);
      return data||[];
    }

    async function runTests(){
      try{
        $('#res').className=''; $('#res').textContent='rodando…';
        const k = await getKPI();

        const d = await chart('dow');   const somaD = d.reduce((a,x)=>a+Number(x.total||0),0);
        const m = await chart('mes');   const somaM = m.reduce((a,x)=>a+Number(x.total||0),0);
        const h = await chart('hora');  const somaH = h.reduce((a,x)=>a+Number(x.total||0),0);
        const t = await chart('turno'); const somaT = t.reduce((a,x)=>a+Number(x.total||0),0);

        const fat = Number(k.fat||0);
        const dif = (a,b)=> Math.abs(Number(a)-Number(b));
        const tol = 0.0001;

        const okD = dif(somaD,fat) < tol;
        const okM = dif(somaM,fat) < tol;
        const okH = dif(somaH,fat) < tol;
        const okT = dif(somaT,fat) < tol;

        log('— Resumo —');
        log({ KPI_fat: fat, soma_dow: somaD, soma_mes: somaM, soma_hora: somaH, soma_turno: somaT });

        const allOk = okD && okM && okH && okT;
        $('#res').className = allOk ? 'ok' : 'fail';
        $('#res').textContent = allOk
          ? '✔ Todos os gráficos batem com o KPI (fat).'
          : `✖ Divergência: DOW=${okD?'OK':'NOK'} | MÊS=${okM?'OK':'NOK'} | HORA=${okH?'OK':'NOK'} | TURNO=${okT?'OK':'NOK'}`;
      }catch(e){
        $('#res').className='fail';
        $('#res').textContent='Erro nos testes (ver log abaixo)';
        log(e.message||e);
      }
    }

    // defaults de data (últimos 30 dias)
    (function initDates(){
      const today = new Date();
      const df = today.toISOString().slice(0,10);
      const di = new Date(Date.now()-29*86400e3).toISOString().slice(0,10);
      $('#dini').value = di;
      $('#dfim').value = df;
    })();

    // eventos
    $('#btn-kpi').addEventListener('click', getKPI);
    $('#btn-test').addEventListener('click', runTests);
  </script>
</body>
</html>
