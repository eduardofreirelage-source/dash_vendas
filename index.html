<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard + Upload (Supabase)</title>
<style>
  :root { --bg:#0b1320; --card:#121a2b; --muted:#94a3b8; --text:#e2e8f0; --pri:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:20px auto;padding:0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:12px;padding:12px}
  .kpi{flex:1 1 200px}
  .kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
  .kpi .v{font-size:22px;font-weight:700}
  .filters .f{display:flex;flex-direction:column;gap:6px;min-width:180px}
  select, input[type="date"], input[type="text"], button{background:#0f172a;border:1px solid #334155;color:var(--text);border-radius:8px;padding:8px}
  button{cursor:pointer}
  .muted{color:var(--muted)}
  .log{white-space:pre-wrap;font-family:ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;max-height:220px;overflow:auto;background:#0a1020;padding:8px;border-radius:8px;border:1px solid #1f2937}
  canvas{background:#0a1020;border:1px solid #1f2937;border-radius:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;background:#0b1222;font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .progress{height:10px;background:#0a1020;border:1px solid #1f2937;border-radius:8px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--pri),#60a5fa)}
  details summary{cursor:pointer}
  .map{display:grid;grid-template-columns:200px 1fr;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row" style="align-items:center;gap:8px;">
      <div><strong>Supabase:</strong></div>
      <input id="url" type="text" style="min-width:360px" placeholder="SUPABASE_URL" />
      <input id="key" type="text" style="min-width:520px" placeholder="SUPABASE_ANON_KEY" />
      <button id="btnConnect">Conectar</button>
      <span id="connStatus" class="pill muted">desconectado</span>
    </div>
    <div class="muted" style="margin-top:6px">JÃ¡ preenchido com seu projeto.</div>
  </div>

  <div class="card filters">
    <div class="row">
      <div class="f"><label>De</label><input id="dini" type="date" /></div>
      <div class="f"><label>AtÃ©</label><input id="dfim" type="date" /></div>
      <div class="f"><label>Unidades</label><select id="ms-unids" multiple size="6" title="unidade"></select></div>
      <div class="f"><label>Lojas (<code>vw_vendas.loja</code>)</label><select id="ms-lojas" multiple size="6" title="loja"></select></div>
      <div class="f"><label>Turnos</label><select id="ms-turnos" multiple size="6" title="turno"></select></div>
      <div class="f"><label>Canais</label><select id="ms-canais" multiple size="6" title="canal"></select></div>
      <div class="f"><label>Pagamentos</label><select id="ms-pags" multiple size="6" title="pagamento_base"></select></div>
      <div class="f"><label>Cancelado</label>
        <select id="sel-cancel"><option value="">Todos</option><option>NÃ£o</option><option>Sim</option></select>
      </div>
      <div class="f" style="align-self:flex-end;gap:8px">
        <button id="btnApply">Aplicar</button>
        <button id="btnClear">Limpar</button>
      </div>
    </div>
    <div class="muted" style="margin-top:4px">Se `vw_vendas` nÃ£o estiver na cache, o app usa RPCs `list_*`.</div>
  </div>

  <div class="row">
    <div class="card kpi"><h3>Pedidos</h3><div id="k-ped" class="v">â€“</div></div>
    <div class="card kpi"><h3>Faturamento</h3><div id="k-fat" class="v">â€“</div></div>
    <div class="card kpi"><h3>Descontos</h3><div id="k-des" class="v">â€“</div></div>
    <div class="card kpi"><h3>Frete/Entrega</h3><div id="k-fre" class="v">â€“</div></div>
  </div>

  <div class="grid-2" style="margin-top:12px">
    <div class="card"><h3>Faturamento por dia da semana</h3><canvas id="c-dow" height="220"></canvas></div>
    <div class="card"><h3>Faturamento por mÃªs</h3><canvas id="c-month" height="220"></canvas></div>
  </div>
  <div class="card" style="margin-top:12px"><h3>Faturamento por hora</h3><canvas id="c-hour" height="220"></canvas></div>

  <div class="card" style="margin-top:12px">
    <h3>Upload Excel â†’ banco</h3>
    <div class="row" style="align-items:center">
      <input id="file" type="file" accept=".xlsx,.xls" />
      <button id="btnValidate">Validar arquivo</button>
      <button id="btnSave" disabled>Salvar no banco</button>
      <span id="sheetStatus" class="pill muted">SheetJSâ€¦</span>
    </div>

    <details id="mapBox" class="hidden" style="margin-top:12px">
      <summary><strong>Mapeamento de colunas</strong></summary>
      <div class="map" style="margin-top:8px">
        <div>Data da venda â†’ <code>data_venda</code></div><select id="m-data"></select>
        <div>Hora (0â€“23) â†’ <code>hora</code></div><select id="m-hora"></select>
        <div>Unidade â†’ <code>unidade</code></div><select id="m-unid"></select>
        <div>Nome da loja â†’ <code>"Nome da loja"</code></div><select id="m-loja"></select>
        <div>Canal â†’ <code>canal</code> / <code>"Canal de venda"</code></div><select id="m-canal"></select>
        <div>Pagamento â†’ <code>pagamento</code> / <code>"Pagamento"</code></div><select id="m-pag"></select>
        <div>Cancelado â†’ <code>cancelado</code> / <code>"EstÃ¡ cancelado"</code></div><select id="m-canc"></select>
        <div>Turno â†’ <code>turno</code> / <code>"Turno"</code></div><select id="m-turno"></select>
        <div>Itens/Pedidos â†’ <code>itens</code> / <code>"Itens"</code></div><select id="m-itens"></select>
        <div>Total (fat) â†’ <code>total</code> / <code>"Total"</code></div><select id="m-fat"></select>
        <div>Desconto â†’ <code>desconto</code> / <code>"Desconto"</code></div><select id="m-des"></select>
        <div>Entrega (frete) â†’ <code>entrega</code> / <code>"Entrega"</code></div><select id="m-fre"></select>
        <div>Consumidor â†’ <code>consumidor</code></div><select id="m-cons"></select>
      </div>
    </details>

    <div class="progress" style="margin-top:10px"><div id="bar" class="bar"></div></div>
    <div id="upInfo" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Debug</h3>
      <div>
        <button id="btnPing">Smoke test (KPI bruto)</button>
        <button id="btnReloadLists">Recarregar listas</button>
        <span id="sumCheck" class="pill">â€”</span>
      </div>
    </div>
    <div id="log" class="log" style="margin-top:8px"></div>
  </div>

</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
(async()=>{ // SheetJS com fallback
  function add(src,cb){const s=document.createElement('script');s.src=src;s.onload=cb;s.onerror=cb;document.head.appendChild(s);}
  await new Promise(r=>add('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',r));
  if(!window.XLSX){await new Promise(r=>add('https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',r));}
  const badge=document.getElementById('sheetStatus');
  badge.textContent = window.XLSX ? 'SheetJS OK' : 'SheetJS indisponÃ­vel';
  badge.className = 'pill ' + (window.XLSX?'ok':'warn');
})();
</script>

<script>
const $ = id=>document.getElementById(id);
const log = (...a)=>{ const t=a.map(x=> typeof x==='string'? x : JSON.stringify(x,null,2)).join(' '); $('log').textContent += t + '\n'; $('log').scrollTop = $('log').scrollHeight; };
const fmt = n => (typeof n==='number') ? n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}) : n;

let supa=null, charts={}, parsed={headers:[],rows:[]};

$('url').value = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
$('key').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';

async function connect(){
  try{
    supa = window.supabase.createClient($('url').value.trim(), $('key').value.trim());
    $('connStatus').textContent = 'conectado';
    $('connStatus').className = 'pill ok';
    log('Pronto.\nâœ… Supabase client ok');
    await initDates();
    await loadLists();
    await applyAll();
  }catch(e){
    $('connStatus').textContent = 'erro';
    $('connStatus').className = 'pill err';
    log('âŒ erro conectar', e.message||e);
  }
}

async function initDates(){
  const df = new Date(); const de = new Date(df); de.setDate(df.getDate()-29);
  $('dini').value = de.toISOString().slice(0,10);
  $('dfim').value = df.toISOString().slice(0,10);
}

async function distinctViaView(field, de, ate){
  const { data, error } = await supa
    .from('vw_vendas')
    .select(field)
    .gte('dia', de).lte('dia', ate)
    .not(field,'is',null).neq(field,'')
    .order(field,{ascending:true})
    .limit(10000);
  if(error) throw error;
  const set = new Set((data||[]).map(r=>(r[field]||'').toString()));
  return Array.from(set);
}
async function distinctViaRPC(fn, de, ate){
  const { data, error } = await supa.rpc(fn, { p_dini: de, p_dfim: ate });
  if(error) throw error;
  return (data||[]).map(r=>r.val).filter(Boolean);
}
async function loadLists(){
  const de = $('dini').value || '2025-01-01';
  const ate= $('dfim').value || new Date().toISOString().slice(0,10);

  async function tryBoth(field, fn){
    try{
      return await distinctViaView(field,de,ate);
    }catch(e){
      log('âš ï¸ loadFilters erro:', e);
      return await distinctViaRPC(fn,de,ate);
    }
  }

  const [unids, lojas, turnos, canais, pags] = await Promise.all([
    tryBoth('unidade','list_unidades'),
    tryBoth('loja','list_lojas'),
    tryBoth('turno','list_turnos'),
    tryBoth('canal','list_canais'),
    tryBoth('pagamento_base','list_pags'),
  ]);

  function fill(selId, arr){
    const sel=$(selId); sel.innerHTML='';
    for(const v of arr){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }
  }
  fill('ms-unids', unids);
  fill('ms-lojas', lojas);
  fill('ms-turnos', turnos);
  fill('ms-canais', canais);
  fill('ms-pags',  pags);

  log('ðŸ”Ž Listas carregadas:', {unids:unids.length, lojas:lojas.length, turnos:turnos.length, canais:canais.length, pags:pags.length});
}

function collectParams(){
  const pick = sel=> Array.from($(sel).selectedOptions).map(o=>o.value);
  return {
    p_dini: $('dini').value,
    p_dfim: $('dfim').value,
    p_unids: (pick('ms-unids').length? pick('ms-unids'): null),
    p_lojas: (pick('ms-lojas').length? pick('ms-lojas'): null),
    p_turnos:(pick('ms-turnos').length? pick('ms-turnos'): null),
    p_canais:(pick('ms-canais').length? pick('ms-canais'): null),
    p_pags:  (pick('ms-pags').length? pick('ms-pags'): null),
    p_cancelado: $('sel-cancel').value || null,
  };
}

async function fetchKPI(p){
  const candidates = ['kpi_vendas_v3','kpi_vendas_v2'];
  let lastErr = null;
  for(const fn of candidates){
    const { data, error } = await supa.rpc(fn, p);
    if(!error && data){ const row = Array.isArray(data)? data[0]: data; if(row) return row; }
    lastErr = error;
  }
  throw lastErr || new Error('Nenhum RPC KPI disponÃ­vel');
}

async function fetchChart(kind, p){
  const map = {
    dow:   ['chart_vendas_dow_v3','chart_vendas_dow_v2'],
    mes:   ['chart_vendas_mes_v3','chart_vendas_mes_v2','chart_vendas_month_v3','chart_vendas_month_v2'],
    hora:  ['chart_vendas_hora_v3','chart_vendas_hora_v2','chart_vendas_hour_v3','chart_vendas_hour_v2'],
  };
  const cands = map[kind] || [];
  let lastErr = null;
  for(const fn of cands){
    const { data, error } = await supa.rpc(fn, p);
    if(!error && data) return data;
    lastErr = error;
  }
  throw lastErr || new Error(`Nenhum RPC chart para ${kind}`);
}

function setKPI(k){ $('k-ped').textContent = (k.pedidos??0).toLocaleString('pt-BR'); $('k-fat').textContent = (k.fat??0).toLocaleString('pt-BR',{minimumFractionDigits:2}); $('k-des').textContent = (k.des??0).toLocaleString('pt-BR',{minimumFractionDigits:2}); $('k-fre').textContent = (k.fre??0).toLocaleString('pt-BR',{minimumFractionDigits:2}); }

function drawChart(id, labels, values, title){
  if(charts[id]) charts[id].destroy();
  const ctx = $(id).getContext('2d');
  charts[id] = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:title, data: values }] },
    options:{ responsive:true, scales:{ x:{ ticks:{ color:'#cbd5e1'} }, y:{ ticks:{ color:'#cbd5e1'} } }, plugins:{ legend:{ labels:{ color:'#cbd5e1'} } } }
  });
}

async function applyAll(){
  const p = collectParams();
  log('â†’ KPI params', JSON.stringify(p,null,2));
  const k = await fetchKPI(p);
  setKPI(k);

  const dow = await fetchChart('dow', p);
  drawChart('c-dow', dow.map(r=>['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'][r.dow]), dow.map(r=>Number(r.total||0)), 'Faturamento');

  const mon = await fetchChart('mes', p);
  drawChart('c-month', mon.map(r=>r.ym), mon.map(r=>Number(r.total||0)), 'Faturamento');

  let hor = [];
  try{ hor = await fetchChart('hora', p); drawChart('c-hour', hor.map(r=>r.h), hor.map(r=>Number(r.total||0)), 'Faturamento'); }
  catch(e){ log('âš ï¸ hora RPC', e?.message||e); drawChart('c-hour', [], [], 'Faturamento'); }

  const sumD = (dow||[]).reduce((a,b)=>a+Number(b.total||0),0);
  const sumM = (mon||[]).reduce((a,b)=>a+Number(b.total||0),0);
  const sumH = (hor||[]).reduce((a,b)=>a+Number(b.total||0),0);
  const ok1 = Math.abs(sumD - Number(k.fat||0)) < 0.01;
  const ok2 = Math.abs(sumM - Number(k.fat||0)) < 0.01;
  const ok3 = Math.abs(sumH - Number(k.fat||0)) < 0.01;
  $('sumCheck').textContent = `DOW ${ok1?'OK':'NOK'} | MÃŠS ${ok2?'OK':'NOK'} | HORA ${ok3?'OK':'NOK'}`;
  $('sumCheck').className = 'pill ' + (ok1&&ok2&&ok3?'ok':'warn');
  log(`âœ… DOW soma=${fmt(sumD)} vs KPI.fat=${fmt(k.fat)} (${ok1?'ok':'mismatch'})`);
  log(`âœ… MÃŠS soma=${fmt(sumM)} vs KPI.fat=${fmt(k.fat)} (${ok2?'ok':'mismatch'})`);
  log(`âœ… HORA soma=${fmt(sumH)} vs KPI.fat=${fmt(k.fat)} (${ok3?'ok':'mismatch'})`);
}

/* === Upload Excel === */
function autoGuess(headers){
  const h = headers.map(s=>s.toString().trim().toLowerCase());
  const pick = (...cands)=>{ for(const c of cands){ const i=h.indexOf(c.toLowerCase()); if(i>=0) return headers[i]; } return ''; };
  return {
    data: pick('data da venda','data','dia','data_venda'),
    hora: pick('hora','hr','hour','time'),
    unid: pick('unidade','filial','empresa'),
    loja: pick('nome da loja','loja','cliente','consumidor'),
    canal: pick('canal','canal de venda','origem'),
    pag: pick('pagamento','pagamento_base','forma de pagamento','pagamento online','pagamento online, voucher parceiro desconto'),
    canc: pick('estÃ¡ cancelado','cancelado'),
    turno: pick('turno','perÃ­odo','periodo','shift'),
    itens: pick('itens','pedidos','qtd'),
    fat: pick('total','valor total','vl_total'),
    des: pick('desconto'),
    fre: pick('entrega','frete'),
    cons: pick('consumidor','cliente'),
  };
}
function fillMapSelects(headers){
  const ids = ['m-data','m-hora','m-unid','m-loja','m-canal','m-pag','m-canc','m-turno','m-itens','m-fat','m-des','m-fre','m-cons'];
  for(const id of ids){
    const sel=$(id); sel.innerHTML='';
    const o0=document.createElement('option'); o0.value=''; o0.textContent='â€” (ignorar)'; sel.appendChild(o0);
    for(const h of headers){ const o=document.createElement('option'); o.value=h; o.textContent=h; sel.appendChild(o); }
  }
  const g = autoGuess(headers);
  $('m-data').value=g.data; $('m-hora').value=g.hora; $('m-unid').value=g.unid; $('m-loja').value=g.loja;
  $('m-canal').value=g.canal; $('m-pag').value=g.pag; $('m-canc').value=g.canc; $('m-turno').value=g.turno;
  $('m-itens').value=g.itens; $('m-fat').value=g.fat; $('m-des').value=g.des; $('m-fre').value=g.fre; $('m-cons').value=g.cons;
}
function numBR(v){ if(v==null||v==='') return null; const s=(v+'').replace(/\./g,'').replace(',','.'); const n=Number(s); return Number.isFinite(n)? n : null; }
function toInt(v){ const n=Number((v??'').toString().replace(/\D+/g,'')); return Number.isFinite(n)? n : null; }
function normBool(v){
  if(v===true) return true; if(v===false) return false;
  const s=(v??'').toString().trim().toLowerCase();
  if(['sim','s','true','1','y','yes'].includes(s)) return true;
  if(['nÃ£o','nao','n','false','0','no'].includes(s)) return false;
  return null;
}

$('btnValidate').addEventListener('click', async()=>{
  const f = $('file').files[0];
  if(!f){ alert('Escolha um arquivo .xlsx'); return; }
  if(!window.XLSX){ alert('SheetJS indisponÃ­vel nesta rede.'); return; }
  const ab = await f.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  const sh = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sh, {defval:null});
  const headers = Object.keys(rows[0]||{});
  parsed = { headers, rows };
  $('mapBox').classList.remove('hidden');
  fillMapSelects(headers);
  $('btnSave').disabled = false;
  log(`ðŸ“„ Selecionado: ${f.name}\nâœ… Lido: ${rows.length} linhas (apenas validaÃ§Ã£o local)`);
});

async function getTableCols(tbl){
  const { data, error } = await supa
    .from('information_schema.columns')
    .select('column_name')
    .eq('table_schema','public')
    .eq('table_name',tbl);
  if(error) return [];
  return (data||[]).map(x=>x.column_name);
}

$('btnSave').addEventListener('click', async()=>{
  if(!supa){ alert('Conecte ao Supabase.'); return; }
  if(!parsed.rows.length){ alert('Valide um arquivo primeiro.'); return; }

  let target = 'vendas_import_csv_v2';
  let cols = await getTableCols(target);
  if(!cols.length){ alert('Tabela alvo vendas_import_csv_v2 nÃ£o existe. Rode o SQL de criaÃ§Ã£o e recarregue.'); return; }

  const m = {
    data: $('m-data').value, hora:$('m-hora').value, unid:$('m-unid').value, loja:$('m-loja').value,
    canal:$('m-canal').value, pag:$('m-pag').value, canc:$('m-canc').value, turno:$('m-turno').value,
    itens:$('m-itens').value, fat:$('m-fat').value, des:$('m-des').value, fre:$('m-fre').value, cons:$('m-cons').value
  };

  const BATCH=500; let ok=0, fail=0;
  for(let i=0;i<parsed.rows.length;i+=BATCH){
    const chunk = parsed.rows.slice(i,i+BATCH).map(r=>{
      const o={};
      const set=(name,val)=>{ if(cols.includes(name)) o[name]=val; };

      if(m.data){ const d=new Date(r[m.data]); if(!isNaN(d)) set('data_venda', d.toISOString().slice(0,10)); }
      if(m.hora){ const h=toInt(r[m.hora]); if(h!=null) set('hora', h); }

      if(m.unid) set('unidade', r[m.unid]);
      if(m.turno){ set('turno', r[m.turno]); if(cols.includes('Turno') && !o.turno) o['Turno']=r[m.turno]; }
      if(m.canal){ set('canal', r[m.canal]); if(cols.includes('Canal de venda') && !o.canal) o['Canal de venda']=r[m.canal]; }
      if(m.pag)  { set('pagamento', r[m.pag]); if(cols.includes('Pagamento') && !o.pagamento) o['Pagamento']=r[m.pag]; }
      if(m.loja && cols.includes('Nome da loja')) o['Nome da loja']=r[m.loja];
      if(m.cons && cols.includes('consumidor'))   o['consumidor']=r[m.cons];

      if(m.canc){
        const b=normBool(r[m.canc]);
        if(b===true||b===false){
          if(cols.includes('cancelado')) o['cancelado']=b;
          if(cols.includes('EstÃ¡ cancelado')) o['EstÃ¡ cancelado']= b?'Sim':'NÃ£o';
        }
      }
      if(m.itens){ const n=toInt(r[m.itens]); if(n!=null){ if(cols.includes('itens')) o.itens=n; if(cols.includes('Itens')) o['Itens']=n; } }
      if(m.fat)  { const n=numBR(r[m.fat]); if(n!=null){ if(cols.includes('total')) o.total=n; if(cols.includes('Total')) o['Total']=r[m.fat]; } }
      if(m.des)  { const n=numBR(r[m.des]); if(n!=null){ if(cols.includes('desconto')) o.desconto=n; if(cols.includes('Desconto')) o['Desconto']=r[m.des]; } }
      if(m.fre)  { const n=numBR(r[m.fre]); if(n!=null){ if(cols.includes('entrega')) o.entrega=n; if(cols.includes('Entrega')) o['Entrega']=r[m.fre]; } }

      return o;
    });

    const { error } = await supa.from(target).insert(chunk, { returning:'minimal' });
    if(error){ fail+=chunk.length; log('âŒ insert', error.message||error); }
    else{ ok+=chunk.length; }
    const pct = Math.round(100*Math.min(i+BATCH, parsed.rows.length)/parsed.rows.length);
    $('bar').style.width = pct + '%';
    $('upInfo').textContent = `Inseridos: ${ok} | Falharam: ${fail} | Tabela: ${target}`;
  }

  // Recarrega listas e grÃ¡ficos
  await loadLists();
  await applyAll();
  log('âœ… Upload concluÃ­do.', { ok, fail, target });
});

/* Eventos */
$('btnConnect').addEventListener('click', connect);
$('btnApply').addEventListener('click', async()=>{ await loadLists(); await applyAll(); });
$('btnClear').addEventListener('click', ()=>{ ['ms-unids','ms-lojas','ms-turnos','ms-canais','ms-pags'].forEach(id=>$(id).selectedIndex=-1); $('sel-cancel').value=''; });
$('btnReloadLists').addEventListener('click', loadLists);

$('btnPing').addEventListener('click', async()=>{
  if(!supa) return;
  const p = { p_dini:$('dini').value, p_dfim:$('dfim').value, p_unids:null, p_lojas:null, p_turnos:null, p_canais:null, p_pags:null, p_cancelado:null };
  for(const fn of ['kpi_vendas_v3','kpi_vendas_v2']){
    const { data, error } = await supa.rpc(fn, p);
    if(!error){ log('Smoke test (KPI bruto)', data); return; }
  }
  log('Smoke test (KPI) erro', 'Nenhum RPC disponÃ­vel');
});

connect(); // conecta ao abrir
</script>
</body>
</html>
