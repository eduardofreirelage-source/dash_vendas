<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Maestro Food — Importador XLSX → Supabase</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--blue:#60a5fa;--green:#34d399;--red:#f87171;--border:#1f2937}
  body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0;padding:24px}
  .wrap{max-width:940px;margin:0 auto}
  h1{margin:0 0 4px;font-size:24px}
  p.muted{color:var(--muted);margin:0 0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0}
  .row{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  input[type=file],button,progress{width:100%}
  input[type=file],button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  button.primary{background:var(--blue);border:none;color:#0b1220;font-weight:700;cursor:pointer}
  .ok{color:var(--green)} .warn{color:#fbbf24} .err{color:var(--red)}
  pre{background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:10px;white-space:pre-wrap;max-height:260px;overflow:auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .k{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food — Importador XLSX</h1>
  <p class="muted">Lê planilhas <b>.xlsx</b> no navegador e envia em lotes para <code>public.vendas_upload</code>. Depois roda <code>ingest_upload()</code> e preenche <code>public.vendas_xlsx</code> com <b>dia</b> e <b>hora</b> separados.</p>

  <div class="card">
    <div class="row cols-2">
      <div>
        <label class="k">Supabase URL</label>
        <input id="sbUrl" value="https://uahmcfzerofhzjvlzrqc.supabase.co">
      </div>
      <div>
        <label class="k">Supabase anon key</label>
        <input id="sbKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU">
      </div>
    </div>
    <div class="row cols-2">
      <div>
        <label class="k">Arquivo .xlsx</label>
        <input id="file" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      </div>
      <div>
        <label class="k">Tamanho do lote (linhas por envio)</label>
        <input id="batch" type="number" min="100" max="2000" value="500">
      </div>
    </div>
    <div class="row cols-2">
      <button id="btnStart" class="primary">Validar & Enviar XLSX → vendas_upload</button>
      <button id="btnIngest">Executar ingest_upload() → preencher vendas_xlsx</button>
    </div>
    <div class="row">
      <progress id="pb" max="100" value="0"></progress>
      <div id="status" class="muted">Aguardando arquivo…</div>
    </div>
  </div>

  <div class="card">
    <b>Identificador de colunas (detectadas → staging)</b>
    <pre id="headers">—</pre>
    <div class="grid">
      <div>
        <b>Preview (5 linhas)</b>
        <pre id="preview">—</pre>
      </div>
      <div>
        <b>Resumo</b>
        <pre id="resume">—</pre>
      </div>
    </div>
  </div>

  <div class="card">
    <b>Healthcheck do banco</b>
    <pre id="db">—</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<script>
(() => {
  // ---------- Config ----------
  const REQUIRED = [
    'Data da venda','unidade','Nome da loja','Canal de venda',
    'Pagamento','Está cancelado','Total','Desconto','Entrega'
  ];
  const pb = document.getElementById('pb');
  const statusEl = document.getElementById('status');
  const headersEl = document.getElementById('headers');
  const previewEl = document.getElementById('preview');
  const resumeEl = document.getElementById('resume');
  const dbEl = document.getElementById('db');
  let supa = null;

  // ---------- Helpers ----------
  const norm = s => String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const fmt = n => n.toLocaleString('pt-BR');

  function mapHeader(h){
    const k = norm(h);
    const M = [
      {std:'Data da venda', list:['data da venda','data','data venda','datadavenda']},
      {std:'unidade', list:['unidade','filial','uni','unidades']},
      {std:'Nome da loja', list:['nome da loja','loja','nomedaloja','nome_loja']},
      {std:'Canal de venda', list:['canal de venda','canal','canal venda','canal_venda']},
      {std:'Pagamento', list:['pagamento','forma de pagamento','meio de pagamento']},
      {std:'Está cancelado', list:['esta cancelado','está cancelado','cancelado','cancelada','canceled','cancelled']},
      {std:'Total', list:['total','faturamento','valor total','valor','total geral']},
      {std:'Desconto', list:['desconto','descontos','incentivos']},
      {std:'Entrega', list:['entrega','frete','shipping','delivery']}
    ];
    for (const m of M) if (m.list.includes(k)) return m.std;
    return h; // mantém desconhecido
  }

  function formatDateBRfromXLSX(v){
    // Gera "dd/mm/yyyy hh:mm" a partir de Date, número Excel ou string
    try{
      if (v instanceof Date){
        const d = v, dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear();
        const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }
      if (typeof v === 'number'){ // serial Excel
        return XLSX.SSF.format('dd/mm/yyyy hh:mm', v);
      }
      const s = String(v??'').trim();
      if (!s) return '';
      // já no formato dd/mm/yyyy?
      if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){
        // garante hh:mm
        if (/\d{1,2}:\d{2}/.test(s)) return s;
        return s + ' 00:00';
      }
      // ISO -> dd/mm/yyyy hh:mm
      const d = new Date(s);
      if (!isNaN(d.getTime())){
        const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear();
        const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }
      return '';
    }catch{ return ''; }
  }

  function buildRowStaging(r, map){
    // Monta exatamente as colunas de public.vendas_upload (tudo texto)
    const out = {};
    for (const std of REQUIRED){
      const src = map[std]; // nome original da coluna que mapeia pra std
      let val = src ? r[src] : '';
      if (std === 'Data da venda') val = formatDateBRfromXLSX(val);
      if (val == null) val = '';
      out[std] = String(val);
    }
    return out;
  }

  function show(obj, el){
    el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
  }

  async function health(){
    if (!supa) return;
    try{
      const a = await supa.from('vendas_xlsx').select('dia').order('dia',{ascending:true}).limit(1);
      const b = await supa.from('vendas_xlsx').select('dia').order('dia',{ascending:false}).limit(1);
      const c = await supa.from('vendas_xlsx').select('*',{count:'exact',head:true});
      const min = (!a.error && a.data?.[0]?.dia) ? a.data[0].dia : null;
      const max = (!b.error && b.data?.[0]?.dia) ? b.data[0].dia : null;
      const total = c.count ?? 0;
      show({ tabela:'vendas_xlsx', intervalo:`${min??'—'} → ${max??'—'}`, total }, dbEl);
    }catch(e){
      show({erro:String(e)}, dbEl);
    }
  }

  // ---------- XLSX -> staging ----------
  async function start(){
    const file = document.getElementById('file').files?.[0];
    const url  = document.getElementById('sbUrl').value.trim();
    const key  = document.getElementById('sbKey').value.trim();
    const batchSize = Math.max(100, Math.min(2000, Number(document.getElementById('batch').value)||500));

    if (!file){ statusEl.innerHTML = 'Selecione um <b>.xlsx</b>.'; return; }
    if (!url || !key){ statusEl.innerHTML = '<span class="err">Configure URL/anon key.</span>'; return; }
    supa = window.supabase.createClient(url, key, {auth:{persistSession:true,autoRefreshToken:true}});

    statusEl.textContent = 'Lendo planilha…';
    pb.value = 0;

    // Ler arquivo
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:'array', cellDates:true});
    const wsname = wb.SheetNames[0];
    const ws = wb.Sheets[wsname];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:'', raw:true});

    if (!rows.length){ statusEl.innerHTML = '<span class="err">Planilha vazia.</span>'; return; }

    // Mapear cabeçalhos
    const rawHeaders = Object.keys(rows[0]);
    const headerMap = {};
    for (const h of rawHeaders){
      const std = mapHeader(h);
      if (!headerMap[std]) headerMap[std] = h; // 1ª ocorrência
    }

    // Verificar obrigatórias
    const missing = REQUIRED.filter(k => !headerMap[k]);
    show({detectado: headerMap, faltando: missing}, headersEl);
    if (missing.length){
      statusEl.innerHTML = `<span class="err">Colunas obrigatórias ausentes: ${missing.join(', ')}</span>`;
      return;
    }

    // Montar linhas para staging
    const staging = rows.map(r => buildRowStaging(r, headerMap));

    // Preview/Resumo
    show(staging.slice(0,5), previewEl);
    show({linhas_total: staging.length, sheet: wsname, arquivo: file.name, lote: batchSize}, resumeEl);

    // Enviar em lotes
    statusEl.innerHTML = 'Enviando para <code>public.vendas_upload</code>…';
    let ok=0, fail=0;
    for (let i=0;i<staging.length;i+=batchSize){
      const chunk = staging.slice(i, i+batchSize);
      const { error } = await supa.from('vendas_upload').insert(chunk);
      if (error){ fail += chunk.length; console.error('Lote com erro:', error); }
      else ok += chunk.length;
      const pct = Math.round(((i+chunk.length)/staging.length)*100);
      pb.value = pct; statusEl.textContent = `Upload: ${fmt(i+chunk.length)} / ${fmt(staging.length)} (${pct}%)`;
    }

    statusEl.innerHTML = `Upload concluído: <span class="ok">${fmt(ok)} ok</span>${fail?`, <span class="err">${fmt(fail)} erros</span>`:''}`;
    await health();
  }

  async function runIngest(){
    const url  = document.getElementById('sbUrl').value.trim();
    const key  = document.getElementById('sbKey').value.trim();
    if (!supa) supa = window.supabase.createClient(url, key, {auth:{persistSession:true,autoRefreshToken:true}});
    statusEl.textContent = 'Executando ingest_upload()…';
    const r = await supa.rpc('ingest_upload');
    if (r.error){ statusEl.innerHTML = `<span class="err">Erro na ingestão: ${r.error.message}</span>`; console.error(r.error); }
    else { statusEl.innerHTML = `<span class="ok">Ingestão concluída.</span>`; }
    await health();
  }

  document.getElementById('btnStart').addEventListener('click', start);
  document.getElementById('btnIngest').addEventListener('click', runIngest);
})();
</script>
</body>
</html>
