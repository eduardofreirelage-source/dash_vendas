<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dash Vendas — com Diagnóstico</title>
<style>
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:20px;color:#111}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  .kpi{min-width:220px}
  .btn{padding:10px 14px;border:1px solid #222;background:#111;color:#fff;border-radius:10px;cursor:pointer}
  .btn.secondary{background:#f9fafb;color:#111;border:1px solid #d1d5db}
  pre{background:#0b1021;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto;max-height:280px}
  label{font-size:12px;color:#374151}
  input,select{padding:8px;border:1px solid #d1d5db;border-radius:8px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(320px,1fr));gap:16px}
  .full{grid-column:1/-1}
</style>
</head>
<body>

<h2>Dash Vendas (RPC v2/v3) • Diagnóstico embutido</h2>

<div class="row card">
  <div>
    <label>Data início</label><br/>
    <input type="date" id="dini"/>
  </div>
  <div>
    <label>Data fim</label><br/>
    <input type="date" id="dfim"/>
  </div>
  <div>
    <label>Unidades (lower-case, separadas por vírgula)</label><br/>
    <input id="unids" placeholder="ex.: uni.raja"/>
  </div>
  <div>
    <label>Lojas (lower-case, separadas por vírgula)</label><br/>
    <input id="lojas" placeholder="ex.: loja xyz"/>
  </div>
  <div>
    <label>Turnos</label><br/>
    <input id="turnos" placeholder="manhã,dia,noite"/>
  </div>
  <div>
    <label>Canais</label><br/>
    <input id="canais" placeholder="ifood,telefone,..."/>
  </div>
  <div>
    <label>Pagamentos</label><br/>
    <input id="pags" placeholder="pago online,pix,..."/>
  </div>
  <div>
    <label>Cancelado</label><br/>
    <select id="cancel">
      <option value="">Todos</option>
      <option>Sim</option>
      <option>Não</option>
    </select>
  </div>
  <div>
    <button class="btn" id="btn-run">Atualizar KPIs + Gráficos</button>
    <button class="btn secondary" id="btn-diag">Rodar Diagnóstico</button>
  </div>
</div>

<div class="grid">
  <div class="card kpi"><h3>KPI</h3><pre id="out-kpi">—</pre></div>
  <div class="card kpi"><h3>DOW</h3><pre id="out-dow">—</pre></div>
  <div class="card kpi"><h3>MÊS</h3><pre id="out-mes">—</pre></div>
  <div class="card kpi"><h3>HORA</h3><pre id="out-hora">—</pre></div>
  <div class="card full"><h3>Diagnóstico</h3><pre id="out-diag">—</pre></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPA_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

const RPC = {
  kpi:   'kpi_vendas_v2',
  dow:   'chart_vendas_dow_v2',
  mes:   'chart_vendas_mes_v2',
  turno: 'chart_vendas_turno_v2',
  hora:  'chart_vendas_hora_v3' // <- versão rápida (usa MV)
};

function val(id){ return (document.getElementById(id).value||'').trim(); }
function arrLower(id){
  const raw = val(id);
  if(!raw) return null;
  const a = raw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
  return a.length? a : null;
}
function normCancel(v){
  if(!v) return null;
  v = v.toLowerCase();
  if(['sim','s','true','1'].includes(v)) return 'Sim';
  if(['nao','não','n','false','0','nao'].includes(v)) return 'Não';
  return null;
}
function params(){
  const p = {
    p_dini: val('dini') || null,
    p_dfim: val('dfim') || null,
    p_unids: arrLower('unids'),
    p_lojas: arrLower('lojas'),
    p_turnos: arrLower('turnos'),
    p_canais: arrLower('canais'),
    p_pags:  arrLower('pags'),
    p_cancelado: normCancel(val('cancel'))
  };
  // datas padrão (últimos 30 dias)
  if(!p.p_dini || !p.p_dfim){
    const dfim = new Date();
    const dini = new Date(); dini.setDate(dfim.getDate()-30);
    p.p_dini = p.p_dini || dini.toISOString().slice(0,10);
    p.p_dfim = p.p_dfim || dfim.toISOString().slice(0,10);
  }
  return p;
}
function setPre(id,obj){ document.getElementById(id).textContent = typeof obj === 'string' ? obj : JSON.stringify(obj,null,2); }

async function rpc(name, p){
  const { data, error } = await supa.rpc(name, p);
  if(error) throw error;
  return data;
}

async function runAll(){
  const p = params();
  setPre('out-kpi','…'); setPre('out-dow','…'); setPre('out-mes','…'); setPre('out-hora','…');
  console.log('→ params', p);

  const kpi = await rpc(RPC.kpi, p);
  setPre('out-kpi', kpi);

  const dow = await rpc(RPC.dow, p);
  setPre('out-dow', dow);

  const mes = await rpc(RPC.mes, p);
  setPre('out-mes', mes);

  const hora = await rpc(RPC.hora, p);
  setPre('out-hora', hora);
}

async function runDiag(){
  const p = params();
  const out = [];
  out.push('PARAMS:\n'+JSON.stringify(p,null,2));

  // KPI
  const k = await rpc(RPC.kpi, p);
  out.push('KPI:\n'+JSON.stringify(k,null,2));
  const kfat = Number((k?.fat ?? 0));

  // DOW soma
  const d = await rpc(RPC.dow, p);
  const dsum = d.reduce((acc,x)=>acc+Number(x.total||0),0);
  out.push(`DOW soma=${dsum.toFixed(2)}  vs KPI.fat=${kfat.toFixed(2)}  diff=${(dsum-kfat).toFixed(2)}`);

  // MÊS soma
  const m = await rpc(RPC.mes, p);
  const msum = m.reduce((acc,x)=>acc+Number(x.total||0),0);
  out.push(`MES soma=${msum.toFixed(2)}  vs KPI.fat=${kfat.toFixed(2)}  diff=${(msum-kfat).toFixed(2)}`);

  // HORA soma (v3)
  const h = await rpc(RPC.hora, p);
  const hsum = h.reduce((acc,x)=>acc+Number(x.total||0),0);
  out.push(`HORA soma=${hsum.toFixed(2)} vs KPI.fat=${kfat.toFixed(2)}  diff=${(hsum-kfat).toFixed(2)}`);

  // Alertas
  const warn=[];
  if(Math.abs(dsum-kfat)>0.01) warn.push('→ DOW ≠ KPI (verifique filtros / MV)');
  if(Math.abs(msum-kfat)>0.01) warn.push('→ MÊS ≠ KPI (verifique filtros)');
  if(Math.abs(hsum-kfat)>0.01) warn.push('→ HORA ≠ KPI (provável MV desatualizada: rode refresh_vendas_hour())');
  out.push('\nALERTAS:\n'+(warn.length? warn.join('\n') : 'OK: todas as somas batem com o KPI'));

  setPre('out-diag', out.join('\n\n'));
}

document.getElementById('btn-run').addEventListener('click', async ()=>{
  try{ await runAll(); }catch(e){ setPre('out-diag', 'ERRO: '+(e.message||e)); console.error(e); }
});
document.getElementById('btn-diag').addEventListener('click', async ()=>{
  try{ await runDiag(); }catch(e){ setPre('out-diag', 'ERRO: '+(e.message||e)); console.error(e); }
});

// valores padrão de datas (últimos 30 dias)
const dfim = new Date(); const dini = new Date(); dini.setDate(dfim.getDate()-30);
document.getElementById('dini').value = dini.toISOString().slice(0,10);
document.getElementById('dfim').value = dfim.toISOString().slice(0,10);
</script>
</body>
</html>
