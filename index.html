<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v16 (filtros em cascata, sem regressão)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --line:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpiSub{font-size:11px;color:var(--muted);margin-top:2px}
    select,button,input[type="date"]{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .section{margin-top:14px}
    .charts{display:grid;grid-template-columns:1fr; gap:12px}
    canvas{width:100%; height:280px; display:block; background:#fff; border:1px solid var(--line); border-radius:10px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    .btns{display:flex;gap:6px;flex-wrap:wrap}
    .btn{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
    .btn.active{background:#111827;color:#fff;border-color:#111827}
    .col{display:flex;flex-direction:column;gap:6px}
    .badge{padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#374151}
    .filtersGrid{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:8px;margin-top:10px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">Build v16 • <span class="badge" id="modeBadge">detectando fonte…</span></div>
        <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
      </div>
      <div class="muted" id="periodo">Período: —</div>
    </div>

    <!-- Filtros principais -->
    <div class="section card">
      <div class="row">
        <div class="col" style="min-width:200px;flex:1">
          <div class="title">Unidade</div>
          <select id="f_unidade"><option>Carregando…</option></select>
        </div>

        <div class="col" style="min-width:240px;flex:2">
          <div class="title">Período rápido</div>
          <div class="btns" id="quick">
            <button class="btn" data-d="7">7</button>
            <button class="btn" data-d="15">15</button>
            <button class="btn active" data-d="30">30</button>
            <button class="btn" data-d="90">90</button>
            <button class="btn" data-d="180">180</button>
            <button class="btn" data-d="360">360</button>
          </div>
        </div>

        <div class="col" style="min-width:280px;flex:2">
          <div class="title">Período entre datas</div>
          <div class="row" style="gap:6px">
            <input type="date" id="d_ini">
            <input type="date" id="d_fim">
            <button id="b_aplicar" class="btn">Aplicar</button>
          </div>
          <div class="muted">Se preencher as datas acima, o período rápido é ignorado.</div>
        </div>
      </div>

      <!-- Filtros extras (aparecem só se a view *_dims* existir) -->
      <div id="extraFilters" class="filtersGrid" style="display:none">
        <div class="col">
          <div class="title">Turno</div>
          <select id="f_turno"><option value="Todos">Todos</option></select>
        </div>
        <div class="col">
          <div class="title">Canal</div>
          <select id="f_canal"><option value="Todos">Todos</option></select>
        </div>
        <div class="col">
          <div class="title">Cupom</div>
          <select id="f_cupom"><option value="Todos">Todos</option></select>
        </div>
        <div class="col">
          <div class="title">Pagamento</div>
          <select id="f_pagamento"><option value="Todos">Todos</option></select>
        </div>
        <div class="col">
          <div class="title">Cancelado</div>
          <select id="f_cancelado"><option value="Todos">Todos</option></select>
        </div>
        <div class="col">
          <div class="title">Entregador</div>
          <select id="f_entregador"><option value="Todos">Todos</option></select>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid section">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="kpiSub" id="k_ped_sub">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="kpiSub" id="k_fat_sub">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="kpiSub" id="k_des_sub">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="kpiSub" id="k_fre_sub">—</div></div>
    </div>

    <!-- Gráficos -->
    <div class="section charts">
      <div class="title">Receita diária (R$)</div>
      <canvas id="c_daily"></canvas>
      <div class="title">Totais por dia da semana (R$)</div>
      <canvas id="c_dow"></canvas>
    </div>

    <div class="card section">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

// preferir a view rica; se falhar, cair no fallback
const TABLE_DIMS    = "vendas_kpi_daily_dims";
const TABLE_FALLBACK= "vendas_kpi_daily";

const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = id => document.getElementById(id);
const logEl = $("log"); function log(m){ logEl.textContent += "\n" + m }
const modeBadge = $("modeBadge");

function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0) }
function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)) }
function addDays(d, delta){ const x=new Date(d); x.setDate(x.getDate()+delta); return x }
function toISO(d){ return d.toISOString().slice(0,10) }
function pct(cur, prev){ if(!prev) return "—"; const d=((cur-prev)/prev)*100; return ((d>=0?"+":"")+d.toFixed(1).replace(".",",")+"% vs ant.") }

let quickDays=30;
const f_unidade=$("f_unidade"), quickDiv=$("quick"), d_ini=$("d_ini"), d_fim=$("d_fim");
const f_turno=$("f_turno"), f_canal=$("f_canal"), f_cupom=$("f_cupom"), f_pagamento=$("f_pagamento"), f_cancelado=$("f_cancelado"), f_entregador=$("f_entregador");
let USE_DIMS=false, TABLE=TABLE_FALLBACK;

function dateWindow(){
  if(d_ini.value && d_fim.value){
    const start = new Date(d_ini.value+"T00:00:00");
    const end   = new Date(d_fim.value+"T23:59:59");
    $("periodo").textContent = "Período: "+toISO(start)+" → "+toISO(end);
    return {start,end};
  }
  const end=new Date(); const start=addDays(end, -(quickDays-1));
  $("periodo").textContent = "Período: "+toISO(start)+" → "+toISO(end);
  return {start,end};
}

function clearCanvas(cv){ const ctx=cv.getContext("2d"); ctx.clearRect(0,0,cv.width,cv.height) }
function lineChart(cv, data){
  const dpi=window.devicePixelRatio||1, W=cv.clientWidth, H=cv.clientHeight;
  cv.width=Math.floor(W*dpi); cv.height=Math.floor(H*dpi);
  const ctx=cv.getContext("2d"); ctx.setTransform(dpi,0,0,dpi,0,0);
  const padL=40,padR=10,padT=10,padB=24, plotW=W-padL-padR, plotH=H-padT-padB;
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1;
  const ys=data.map(d=>d.y), maxY=Math.max(1, Math.max(...ys,0));
  const n=data.length||0; const xPos=i=> padL + (n<=1? 0.5*plotW : (i/(n-1))*plotW);
  const yPos=v=> padT + plotH - ( (v)/(maxY) )*plotH;
  ctx.beginPath(); for(let t=0;t<=3;t++){ const y=padT+(t/3)*plotH; ctx.moveTo(padL,y); ctx.lineTo(W-padR,y);} ctx.stroke();
  ctx.fillStyle="#6b7280"; ctx.font="12px system-ui";
  for(let t=0;t<=3;t++){ const v=(t/3)*maxY, y=padT+plotH-(t/3)*plotH; ctx.fillText(fmtBRL(v), 6, y+4); }
  if(n>0){ ctx.strokeStyle="#2563eb"; ctx.lineWidth=2; ctx.beginPath();
    data.forEach((d,i)=>{ const x=xPos(i), y=yPos(d.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
    ctx.stroke();
  }
  ctx.fillStyle="#6b7280"; ctx.font="11px system-ui";
  const ticks = Math.min(4, Math.max(1,n));
  for(let t=0;t<ticks;t++){ const i=Math.round((t/(ticks-1))*(n-1)); if(i<0||i>=n) continue;
    const x=xPos(i), y=H-padB+14; ctx.fillText(String(data[i].x).slice(5), x-16,y); }
}
function barChart(cv, data){
  const dpi=window.devicePixelRatio||1, W=cv.clientWidth, H=cv.clientHeight;
  cv.width=Math.floor(W*dpi); cv.height=Math.floor(H*dpi);
  const ctx=cv.getContext("2d"); ctx.setTransform(dpi,0,0,dpi,0,0);
  const padL=40,padR=10,padT=10,padB=24, plotW=W-padL-padR, plotH=H-padT-padB;
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1;
  const ys=data.map(d=>d.y), maxY=Math.max(1, Math.max(...ys,0));
  const n=data.length||1, gap=8, bw=(plotW-gap*(n+1))/n;
  ctx.beginPath(); for(let t=0;t<=3;t++){ const y=padT+(t/3)*plotH; ctx.moveTo(padL,y); ctx.lineTo(W-padR,y);} ctx.stroke();
  ctx.fillStyle="#6b7280"; ctx.font="12px system-ui";
  for(let t=0;t<=3;t++){ const v=(t/3)*maxY, y=padT+plotH-(t/3)*plotH; ctx.fillText(fmtBRL(v), 6, y+4); }
  data.forEach((d,i)=>{
    const x=padL+gap+i*(bw+gap), h=plotH*(d.y/maxY), y=padT+plotH-h;
    ctx.fillStyle="#10b981"; ctx.fillRect(x,y,bw,h);
    ctx.fillStyle="#6b7280"; ctx.font="11px system-ui"; ctx.fillText(d.x, x+bw/2-12, H-padB+14);
  });
}

function fillSelect(sel, values, withAll=true, allLabel="Todos"){
  const old = sel.value;
  sel.innerHTML = "";
  if(withAll){ const o=document.createElement("option"); o.value=allLabel; o.textContent=allLabel; sel.appendChild(o); }
  values.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  if([...sel.options].some(o=>o.value===old)) sel.value=old;
}

// baixa opções distintas de uma coluna (últimos 365d)
async function distinctValues(table, col){
  const end=new Date(), start=addDays(end,-365);
  const r = await supa.from(table).select(col).gte("dia", toISO(start)).lte("dia", toISO(end)).range(0, 100000);
  if(r.error) throw r.error;
  const set = new Set();
  (r.data||[]).forEach(x=>{
    const v = x[col];
    if(v!==null && v!==undefined && String(v).trim()!=="") set.add(String(v));
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
}

// monta query de linhas diárias conforme filtros
async function fetchDaily(filters){
  const {start,end} = filters;
  let q = supa.from(TABLE)
    .select(USE_DIMS
      ? "dia,unidade,turno,canal,cupom,pagamento,cancelado,entregador,pedidos,fat,des,fre"
      : "dia,unidade,pedidos,fat,des,fre"
    )
    .gte("dia", toISO(start)).lte("dia", toISO(end))
    .order("dia",{ascending:true})
    .range(0, 200000);

  if(filters.unidade && filters.unidade!=="Todas") q = q.eq("unidade", filters.unidade);
  if(USE_DIMS){
    if(filters.turno      && filters.turno!=="Todos")       q = q.eq("turno", filters.turno);
    if(filters.canal      && filters.canal!=="Todos")       q = q.eq("canal", filters.canal);
    if(filters.cupom      && filters.cupom!=="Todos")       q = q.eq("cupom", filters.cupom);
    if(filters.pagamento  && filters.pagamento!=="Todos")   q = q.eq("pagamento", filters.pagamento);
    if(filters.cancelado  && filters.cancelado!=="Todos")   q = q.eq("cancelado", filters.cancelado);
    if(filters.entregador && filters.entregador!=="Todos")  q = q.eq("entregador", filters.entregador);
  }
  const r = await q;
  if(r.error){ log("[ERRO-Query] "+r.error.message); throw r.error }
  return r.data||[];
}

function aggKPIs(rows){
  let ped=0,fat=0,des=0,fre=0;
  for(const r of rows){ ped+=Number(r.pedidos)||0; fat+=Number(r.fat)||0; des+=Number(r.des)||0; fre+=Number(r.fre)||0; }
  return {ped,fat,des,fre};
}
function seriesByDay(rows){
  const map=new Map();
  for(const r of rows){ const d=r.dia; const v=Number(r.fat)||0; map.set(d,(map.get(d)||0)+v); }
  return Array.from(map.keys()).sort().map(d=>({x:d,y:map.get(d)}));
}
function seriesByDOW(rows){
  const acc=[0,0,0,0,0,0,0];
  for(const r of rows){ const d = new Date(r.dia+"T00:00:00").getDay(); acc[d] += Number(r.fat)||0; }
  const nomes=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
  return nomes.map((n,i)=>({x:n,y:acc[i]}));
}

async function go(){
  const {start,end} = dateWindow();
  const filters = {
    start,end,
    unidade: f_unidade.value || "Todas",
    turno: f_turno.value || "Todos",
    canal: f_canal.value || "Todos",
    cupom: f_cupom.value || "Todos",
    pagamento: f_pagamento.value || "Todos",
    cancelado: f_cancelado.value || "Todos",
    entregador: f_entregador.value || "Todos"
  };

  log(`[Query] ${TABLE} | ${toISO(start)} → ${toISO(end)} | UNI=${filters.unidade}${USE_DIMS?` | turno=${filters.turno} | canal=${filters.canal} | cupom=${filters.cupom} | pagamento=${filters.pagamento} | cancelado=${filters.cancelado} | entregador=${filters.entregador}`:""}`);

  const cur = await fetchDaily(filters);
  const win = Math.round( (end - start) / (1000*60*60*24) ) + 1;
  const prevEnd = addDays(start, -1), prevStart = addDays(prevEnd, -(win-1));
  const prev = await fetchDaily({...filters, start: prevStart, end: prevEnd});

  const K1=aggKPIs(cur), K0=aggKPIs(prev);
  $("k_ped").textContent = fmtInt(K1.ped);     $("k_ped_sub").textContent = (K0.ped?pct(K1.ped,K0.ped):"—");
  $("k_fat").textContent = fmtBRL(K1.fat);     $("k_fat_sub").textContent = (K0.fat?pct(K1.fat,K0.fat):"—");
  $("k_des").textContent = fmtBRL(K1.des);     $("k_des_sub").textContent = (K0.des?pct(K1.des,K0.des):"—");
  $("k_fre").textContent = fmtBRL(K1.fre);     $("k_fre_sub").textContent = (K0.fre?pct(K1.fre,K0.fre):"—");

  const cv1=$("c_daily"), cv2=$("c_dow");
  clearCanvas(cv1); clearCanvas(cv2);
  lineChart(cv1, seriesByDay(cur));
  barChart(cv2, seriesByDOW(cur));

  log("[OK] KPIs e gráficos atualizados.");
}

async function boot(){
  log("[Boot] v16 — tentando view rica (dims) sem regressão…");
  // detectar se a view *_dims* existe (1 chamada; se falhar, caímos no fallback)
  try{
    const test = await supa.from(TABLE_DIMS).select("dia").limit(1);
    if(test.error) throw test.error;
    USE_DIMS = true; TABLE = TABLE_DIMS;
    modeBadge.textContent = "fonte: public.vendas_kpi_daily_dims (com filtros extras)";
    $("extraFilters").style.display = "grid";
  }catch(_){
    USE_DIMS = false; TABLE = TABLE_FALLBACK;
    modeBadge.textContent = "fonte: public.vendas_kpi_daily (fallback: só Unidade + Data)";
    $("extraFilters").style.display = "none";
  }

  // popular UNIDADE
  const unidades = await distinctValues(TABLE, "unidade");
  fillSelect(f_unidade, unidades, true, "Todas");

  // se houver dims, popular os demais filtros (cada um isolado, leve)
  if(USE_DIMS){
    const [turnos, canais, cupons, pagamentos, cancelados, entregadores] = await Promise.all([
      distinctValues(TABLE, "turno"),
      distinctValues(TABLE, "canal"),
      distinctValues(TABLE, "cupom"),
      distinctValues(TABLE, "pagamento"),
      distinctValues(TABLE, "cancelado"),
      distinctValues(TABLE, "entregador"),
    ]);
    fillSelect(f_turno, turnos, true, "Todos");
    fillSelect(f_canal, canais, true, "Todos");
    fillSelect(f_cupom, cupons, true, "Todos");
    fillSelect(f_pagamento, pagamentos, true, "Todos");
    fillSelect(f_cancelado, cancelados, true, "Todos");
    fillSelect(f_entregador, entregadores, true, "Todos");
  }

  // listeners
  $("b_aplicar").onclick=()=>{ if(d_ini.value && d_fim.value){ quickDiv.querySelectorAll(".btn").forEach(b=>b.classList.remove("active")); go(); } };
  quickDiv.querySelectorAll(".btn").forEach(btn=>{
    btn.onclick=()=>{
      quickDiv.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      quickDays = Number(btn.dataset.d)||30;
      d_ini.value=""; d_fim.value="";
      go();
    };
  });
  f_unidade.onchange = go;
  [f_turno,f_canal,f_cupom,f_pagamento,f_cancelado,f_entregador].forEach(sel=>{
    if(sel) sel.onchange = go;
  });

  await go();

  // redimensiona = redesenha (sem “gráfico infinito”)
  let t=null; window.onresize=()=>{ clearTimeout(t); t=setTimeout(go,120); };
}
boot();
</script>
</body>
</html>
