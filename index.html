<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Maestro Food — Importador XLSX (Grande Volume)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--blue:#60a5fa;--green:#34d399;--red:#f87171;--border:#1f2937}
  body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0;padding:24px}
  .wrap{max-width:980px;margin:0 auto}
  h1{margin:0 0 6px;font-size:24px}
  p.muted{color:var(--muted);margin:0 0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0}
  .row{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  input[type=file],input[type=text],input[type=number],button,progress{width:100%}
  input,button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  button.primary{background:var(--blue);border:none;color:#0b1220;font-weight:700;cursor:pointer}
  .ok{color:var(--green)} .warn{color:#fbbf24} .err{color:var(--red)}
  pre{background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:10px;white-space:pre-wrap;max-height:280px;overflow:auto}
  label small{color:var(--muted)}
  .inline{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food — Importador XLSX (Grande Volume)</h1>
  <p class="muted">Leitura paginada e envio em lotes para <code>public.vendas_upload</code>. Depois rode <code>ingest_upload()</code> para preencher <code>public.vendas_xlsx</code> (com <b>dia</b> e <b>hora</b> separados; 1 registro = 1 pedido).</p>

  <div class="card">
    <div class="row cols-2">
      <div>
        <label>Supabase URL</label>
        <input id="sbUrl" value="https://uahmcfzerofhzjvlzrqc.supabase.co">
      </div>
      <div>
        <label>Supabase anon key</label>
        <input id="sbKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU">
      </div>
    </div>

    <div class="row cols-3">
      <div>
        <label>Arquivo .xlsx</label>
        <input id="file" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      </div>
      <div>
        <label>Linhas por janela de leitura<br><small>(XLSX → memória, recomendado 5000–10000)</small></label>
        <input id="readWindow" type="number" min="1000" max="20000" value="5000">
      </div>
      <div>
        <label>Lotes por envio ao Supabase<br><small>(recomendado 300–600, reduz 413/timeout)</small></label>
        <input id="batch" type="number" min="100" max="1000" value="400">
      </div>
    </div>

    <div class="inline" style="margin:8px 0">
      <input id="skipCentro" type="checkbox">
      <label for="skipCentro">Ignorar linhas com <b>Nome da loja</b> vazio ou igual a <b>“Loja Centro”</b></label>
    </div>

    <div class="row cols-2">
      <button id="btnStart" class="primary">Validar & Importar XLSX → vendas_upload</button>
      <button id="btnIngest">Executar ingest_upload() → vendas_xlsx</button>
    </div>
    <div class="row">
      <progress id="pb" max="100" value="0"></progress>
      <div id="status" class="muted">Aguardando arquivo…</div>
    </div>
  </div>

  <div class="card">
    <b>Mapeamento de cabeçalhos (detectados → staging)</b>
    <pre id="headers">—</pre>
    <div class="row cols-2">
      <div>
        <b>Preview (até 5 linhas)</b>
        <pre id="preview">—</pre>
      </div>
      <div>
        <b>Resumo</b>
        <pre id="resume">—</pre>
      </div>
    </div>
  </div>

  <div class="card">
    <b>Healthcheck do banco</b>
    <pre id="db">—</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<script>
(() => {
  // ---- Config obrigatória da staging ----
  // public.vendas_upload COM ESTES CAMPOS (TEXT):
  // 'Data da venda','unidade','Nome da loja','Canal de venda','Pagamento','Está cancelado','Total','Desconto','Entrega'
  const REQUIRED = [
    'Data da venda','unidade','Nome da loja','Canal de venda',
    'Pagamento','Está cancelado','Total','Desconto','Entrega'
  ];

  // ---- DOM ----
  const pb = document.getElementById('pb');
  const statusEl = document.getElementById('status');
  const headersEl = document.getElementById('headers');
  const previewEl = document.getElementById('preview');
  const resumeEl = document.getElementById('resume');
  const dbEl = document.getElementById('db');
  const skipCentro = document.getElementById('skipCentro');
  let supa = null;

  // ---- Utils ----
  const norm = s => String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const fmt = n => n.toLocaleString('pt-BR');

  function mapHeader(h){
    const k = norm(h);
    const M = [
      {std:'Data da venda', list:['data da venda','data','data venda','datadavenda']},
      {std:'unidade', list:['unidade','filial','uni','unidades']},
      {std:'Nome da loja', list:['nome da loja','loja','nomedaloja','nome_loja']},
      {std:'Canal de venda', list:['canal de venda','canal','canal venda','canal_venda']},
      {std:'Pagamento', list:['pagamento','forma de pagamento','meio de pagamento']},
      {std:'Está cancelado', list:['esta cancelado','está cancelado','cancelado','cancelada','canceled','cancelled']},
      {std:'Total', list:['total','faturamento','valor total','valor','total geral']},
      {std:'Desconto', list:['desconto','descontos','incentivos']},
      {std:'Entrega', list:['entrega','frete','shipping','delivery']}
    ];
    for (const m of M) if (m.list.includes(k)) return m.std;
    return h;
  }

  function ddmmYYYY_HHMM_fromAny(v){
    // Gera "dd/mm/yyyy hh:mm" a partir de Date, número Excel (serial) ou ISO/string
    try{
      if (v instanceof Date){
        const d=v, dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear();
        const hh=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }
      if (typeof v === 'number'){ // serial Excel
        return XLSX.SSF.format('dd/mm/yyyy hh:mm', v);
      }
      const s = String(v??'').trim();
      if (!s) return '';
      if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){
        if (/\d{1,2}:\d{2}/.test(s)) return s;
        return s + ' 00:00';
      }
      const d = new Date(s);
      if (!isNaN(d.getTime())) return ddmmYYYY_HHMM_fromAny(d);
      return '';
    }catch{ return ''; }
  }

  function buildRowStagingFromAoA(rowAoA, indexMap){
    // rowAoA = array de células da linha; indexMap: std -> idx da coluna
    const out = {};
    for (const std of REQUIRED){
      const idx = indexMap[std];
      let v = (idx!=null) ? rowAoA[idx] : '';
      if (std === 'Data da venda') v = ddmmYYYY_HHMM_fromAny(v);
      if (v == null) v = '';
      out[std] = String(v);
    }
    return out;
  }

  function show(obj, el){ el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2); }

  async function yieldUI(){ return new Promise(r=>setTimeout(r,0)); }

  async function health(){
    if (!supa) return;
    try{
      const a = await supa.from('vendas_xlsx').select('dia').order('dia',{ascending:true}).limit(1);
      const b = await supa.from('vendas_xlsx').select('dia').order('dia',{ascending:false}).limit(1);
      const c = await supa.from('vendas_xlsx').select('*',{count:'exact',head:true});
      const min = (!a.error && a.data?.[0]?.dia) ? a.data[0].dia : null;
      const max = (!b.error && b.data?.[0]?.dia) ? b.data[0].dia : null;
      const total = c.count ?? 0;
      show({ tabela:'vendas_xlsx', intervalo:`${min??'—'} → ${max??'—'}`, total }, dbEl);
    }catch(e){ show({erro:String(e)}, dbEl); }
  }

  // ---- Importador paginado ----
  async function start(){
    const file = document.getElementById('file').files?.[0];
    const url  = document.getElementById('sbUrl').value.trim();
    const key  = document.getElementById('sbKey').value.trim();
    const readWindow = Math.max(2000, Math.min(20000, Number(document.getElementById('readWindow').value)||5000));
    const batchSize  = Math.max(100,  Math.min(1000,  Number(document.getElementById('batch').value)||400));
    if (!file){ statusEl.innerHTML = 'Selecione um <b>.xlsx</b>.'; return; }
    if (!url || !key){ statusEl.innerHTML = '<span class="err">Configure URL/anon key.</span>'; return; }

    supa = window.supabase.createClient(url, key, {auth:{persistSession:true,autoRefreshToken:true}});

    statusEl.textContent = 'Lendo cabeçalhos…';
    pb.value = 0;

    // Lê workbook (dense = menos memória)
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array', cellDates:true, dense:true });
    const wsname = wb.SheetNames[0];
    const ws = wb.Sheets[wsname];
    if (!ws || !ws['!ref']){ statusEl.innerHTML = '<span class="err">Aba vazia ou !ref ausente.</span>'; return; }

    // Descobre range total
    const ref = XLSX.utils.decode_range(ws['!ref']);
    const firstRow = ref.s.r;      // geralmente 0
    const lastRow  = ref.e.r;      // índice final
    const firstCol = ref.s.c;
    const lastCol  = ref.e.c;

    // Header (linha do cabeçalho = firstRow)
    const headerAoA = XLSX.utils.sheet_to_json(ws, { header:1, range: {s:{r:firstRow,c:firstCol}, e:{r:firstRow,c:lastCol}}, defval:'' });
    const headers = (headerAoA[0] || []).map(h=>String(h));
    if (!headers.length){ statusEl.innerHTML = '<span class="err">Cabeçalho não encontrado.</span>'; return; }

    // Mapeia cabeçalhos → std
    const headerMap = {};   // std -> header original
    const indexMap  = {};   // std -> índice da coluna na planilha
    headers.forEach((h, idx) => {
      const std = mapHeader(h);
      if (!headerMap[std]){ headerMap[std] = h; indexMap[std] = idx; }
    });

    const missing = REQUIRED.filter(k => indexMap[k]==null);
    show({detectado: headerMap, faltando: missing}, headersEl);
    if (missing.length){
      statusEl.innerHTML = `<span class="err">Colunas obrigatórias ausentes: ${missing.join(', ')}</span>`;
      return;
    }

    // Preview de até 5 linhas (lendo próxima linha em diante)
    const previewRange = { s:{r:firstRow+1, c:firstCol}, e:{r:Math.min(firstRow+5, lastRow), c:lastCol} };
    const prevAoA = XLSX.utils.sheet_to_json(ws, { header:1, range: previewRange, defval:'' });
    const previewRows = prevAoA.map(r => buildRowStagingFromAoA(r, indexMap));
    show(previewRows, previewEl);

    // Resumo
    const totalRows = Math.max(0, lastRow - firstRow); // sem contar header, aprox
    show({arquivo:file.name, sheet:wsname, linhas_aproximadas: totalRows, janela_leitura: readWindow, lote_envio: batchSize}, resumeEl);

    statusEl.innerHTML = 'Importando por janelas…';
    let sentOK=0, sentErr=0, processed=0;

    // Percorre em janelas de leitura (ex.: 5000 linhas por janela)
    for (let start = firstRow + 1; start <= lastRow; start += readWindow){
      const end = Math.min(start + readWindow - 1, lastRow);
      const chunkAoA = XLSX.utils.sheet_to_json(ws, { header:1, range: {s:{r:start,c:firstCol}, e:{r:end,c:lastCol}}, defval:'' });
      // Converte para objetos staging on-the-fly e filtra “Loja Centro”/vazios se marcado
      const chunkObjs = [];
      for (let i=0;i<chunkAoA.length;i++){
        const row = chunkAoA[i];
        const obj = buildRowStagingFromAoA(row, indexMap);
        if (skipCentro.checked){
          const loja = (obj['Nome da loja']||'').trim();
          if (!loja || loja === 'Loja Centro') continue;
        }
        chunkObjs.push(obj);
      }

      // Envia esse “chunk” em sublotes menores (ex.: 400)
      for (let i=0;i<chunkObjs.length;i+=batchSize){
        const lot = chunkObjs.slice(i, i+batchSize);
        try{
          const { error } = await supa.from('vendas_upload').insert(lot, { returning:'minimal' });
          if (error){ sentErr += lot.length; console.error('Erro no lote:', error); }
          else { sentOK += lot.length; }
        }catch(e){
          sentErr += lot.length; console.error('Falha no request:', e);
        }
        processed += lot.length;
        const pct = Math.min(100, Math.round( (processed / totalRows) * 100 ));
        pb.value = pct;
        statusEl.textContent = `Upload: ${fmt(processed)} / ~${fmt(totalRows)} (${pct}%)`;
        await yieldUI(); // evita travar a UI
      }
      // libere memória da janela atual
      await yieldUI();
    }

    statusEl.innerHTML = `Upload concluído: <span class="ok">${fmt(sentOK)} ok</span>${sentErr?`, <span class="err">${fmt(sentErr)} erros</span>`:''}`;
    await health();
  }

  async function runIngest(){
    const url  = document.getElementById('sbUrl').value.trim();
    const key  = document.getElementById('sbKey').value.trim();
    if (!supa) supa = window.supabase.createClient(url, key, {auth:{persistSession:true,autoRefreshToken:true}});
    statusEl.textContent = 'Executando ingest_upload()…';
    const r = await supa.rpc('ingest_upload'); // esta função faz: 1 linha = 1 pedido, separa dia/hora, numéricos etc.
    if (r.error){ statusEl.innerHTML = `<span class="err">Erro na ingestão: ${r.error.message}</span>`; console.error(r.error); }
    else { statusEl.innerHTML = `<span class="ok">Ingestão concluída.</span>`; }
    await health();
  }

  document.getElementById('btnStart').addEventListener('click', start);
  document.getElementById('btnIngest').addEventListener('click', runIngest);
})();
</script>
</body>
</html>
