<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maestro Food</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="%232563eb"/><text x="32" y="38" font-family="Arial" font-size="28" text-anchor="middle" fill="white">MF</text></svg>'>
<style>
:root{--bg:#f6f7fb;--fg:#0f172a;--mut:#6b7280;--card:#fff;--brd:#e5e7eb;--acc:#2563eb}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
.wrap{max-width:1200px;margin:20px auto;padding:0 14px}
.top{display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:20px}
.muted{color:var(--mut)}
.card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px}
.grid{display:grid;gap:10px}
.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:980px){.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.cols-4{grid-template-columns:1fr}}
.filters .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}
label{display:block;font-size:12px;color:var(--mut);margin-bottom:4px}
select,input[type=date],button{width:100%;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff;font:inherit}
button.primary{background:var(--acc);color:#fff;border-color:var(--acc);cursor:pointer}
.kpi .v{font-weight:700;font-size:22px}
.badge{display:inline-block;background:#eef2ff;border:1px solid var(--brd);border-radius:999px;padding:4px 8px;font-size:12px}
.right{margin-left:auto}
.note{font-size:12px;color:var(--mut)}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="wrap" id="app" style="display:none">
  <div class="top">
    <div>
      <h1>Maestro Food</h1>
      <div class="muted" id="periodo">Período: —</div>
    </div>
  </div>

  <div class="card filters">
    <div class="top" style="margin-bottom:10px">
      <strong>FILTROS</strong>
      <button id="btnClear" style="width:auto">Limpar</button>
    </div>
    <div class="row">
      <div class="col-6">
        <label>Unidade</label>
        <select id="fUni"><option>Todas</option></select>
      </div>
      <div class="col-6">
        <label>Nome da loja (Top 10)</label>
        <select id="fLoja"><option>Todas</option></select>
      </div>

      <div class="col-3">
        <label>De</label>
        <input type="date" id="fDe">
      </div>
      <div class="col-3">
        <label>Até</label>
        <input type="date" id="fAte">
      </div>
      <div class="col-3">
        <label>Período rápido</label>
        <select id="fPr">
          <option value="7">Últimos 7</option>
          <option value="15">Últimos 15</option>
          <option value="30" selected>Últimos 30</option>
          <option value="90">Últimos 90</option>
          <option value="180">Últimos 180</option>
        </select>
      </div>
      <div class="col-3">
        <label>Turno</label>
        <select id="fTurno">
          <option>Todos</option><option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option><option>Dia</option>
        </select>
      </div>

      <div class="col-4">
        <label>Canal de venda</label>
        <select id="fCanal"><option>Todos</option></select>
      </div>
      <div class="col-4">
        <label>Pagamento</label>
        <select id="fPag"><option>Todos</option></select>
      </div>
      <div class="col-4">
        <label>Está cancelado?</label>
        <select id="fCanc"><option>Todos</option><option>Não</option><option>Sim</option></select>
      </div>

      <div class="col-12 card" style="border-style:dashed">
        <b>Admin — Importar CSV (<i>Pasta2.csv</i>)</b>
        <div class="top" style="gap:8px;margin-top:8px">
          <input type="file" id="csv" accept=".csv" style="max-width:280px">
          <button id="btnImport" class="primary" style="width:auto">Importar CSV</button>
          <span class="badge" id="importMsg" style="display:none"></span>
        </div>
        <div class="note">Importação é somativa com deduplicação pela chave (dia+unidade+loja+hora+pagamento+canal).</div>
      </div>
    </div>
  </div>

  <div class="grid cols-4" style="margin-top:10px">
    <div class="card kpi"><div class="muted">Pedidos</div><div class="v" id="k_ped">—</div></div>
    <div class="card kpi"><div class="muted">Ticket Médio</div><div class="v" id="k_tkm">—</div></div>
    <div class="card kpi"><div class="muted">Faturamento</div><div class="v" id="k_fat">—</div></div>
    <div class="card kpi"><div class="muted">Faturamento Médio (dia)</div><div class="v" id="k_fmd">—</div></div>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="top"><strong>Receita diária</strong>
      <div class="badge" id="lineMode" data-mode="total">Total</div>
    </div>
    <div style="height:280px"><canvas id="cLine"></canvas></div>
  </div>
</div>

<script>
(function(){
  'use strict';
  if (window.__DASH_LOCK__) return; window.__DASH_LOCK__ = true;

  // ======= SUPABASE =======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ======= HELPERS =======
  const $ = sel => document.querySelector(sel);
  const BRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const INT = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = (d)=> d && !isNaN(d.getTime()) ? d.toISOString().slice(0,10) : null;

  // "19/04/2023 10:49" -> {iso: "2023-04-19", hour:10}
  const parseDMYhm = (s) => {
    if(!s) return {iso:null, hour:null};
    const m = String(s).match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
    if(!m) return {iso:null, hour:null};
    const [_,dd,MM,yyyy,hh,mm] = m;
    const d = new Date(Date.UTC(+yyyy, +MM-1, +dd, +hh, +mm));
    return { iso: toISO(d), hour: +hh };
  };
  const cnum = (v) => {
    if (v===null || v===undefined) return 0;
    if (typeof v === 'number') return v;
    const s = String(v).trim().replace(/\./g,'').replace(',','.');
    const n = parseFloat(s); return isNaN(n)?0:n;
  };

  // ======= ESTADO/UI =======
  const app = $("#app"); app.style.display="block";
  const periodo = $("#periodo");
  const fUni=$("#fUni"), fLoja=$("#fLoja"), fDe=$("#fDe"), fAte=$("#fAte"), fPr=$("#fPr"),
        fTurno=$("#fTurno"), fCanal=$("#fCanal"), fPag=$("#fPag"), fCanc=$("#fCanc");
  let minISO=null, maxISO=null, chartLine=null;

  // ======= BOOT =======
  (async function boot(){
    await fetchLimites();
    await fetchDistinct();
    await loadData();
  })();

  async function fetchLimites(){
    const rMin = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const rMax = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    if(!rMin.error && rMin.data.length) minISO = rMin.data[0].dia;
    if(!rMax.error && rMax.data.length) maxISO = rMax.data[0].dia;

    if (minISO && maxISO) {
      fDe.min=minISO; fDe.max=maxISO; fAte.min=minISO; fAte.max=maxISO;
      fAte.value = maxISO;
      const days = +fPr.value || 30;
      const end = new Date(maxISO+"T00:00:00Z"); const start = new Date(end); start.setUTCDate(end.getUTCDate()-(days-1));
      fDe.value = toISO(start);
      periodo.textContent = `Período: ${fDe.value} → ${fAte.value}`;
    } else {
      fDe.value=""; fAte.value="";
      periodo.textContent = "Período: —";
    }
  }

  async function fetchDistinct(){
    const r = await supa.from(TABLE).select('unidade,"Canal de venda",pagamento').limit(200000);
    if (r.error) return;
    const uniq = (rows, col) => Array.from(new Set(rows.map(x=>x[col]).filter(Boolean))).sort();
    const fill = (sel, arr) => { sel.innerHTML = '<option>Todas</option>' + arr.map(v=>`<option>${v}</option>`).join(''); };
    fill(fUni,   uniq(r.data,'unidade'));
    fill(fCanal, uniq(r.data,'Canal de venda'));
    fill(fPag,   uniq(r.data,'pagamento'));
  }

  async function loadData(){
    let sISO = fDe.value || minISO, eISO = fAte.value || maxISO;
    if (sISO && eISO) periodo.textContent = `Período: ${sISO} → ${eISO}`;

    let q = supa.from(TABLE)
        .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
        .gte('dia', sISO).lte('dia', eISO).order('dia',{ascending:true}).limit(200000);

    if (fUni.value && fUni.value!=="Todas") q = q.eq('unidade', fUni.value);
    if (fLoja.value && fLoja.value!=="Todas") q = q.eq('Nome da loja', fLoja.value);
    if (fTurno.value && fTurno.value!=="Todos") q = q.eq('turno', fTurno.value);
    if (fCanal.value && fCanal.value!=="Todos") q = q.eq('Canal de venda', fCanal.value);
    if (fPag.value && fPag.value!=="Todos") q = q.eq('pagamento', fPag.value);
    if (fCanc.value && fCanc.value!=="Todos") q = q.eq('cancelado', fCanc.value);

    const r = await q;
    if (r.error){ console.error(r.error); paintEmpty(); return; }
    const rows = r.data||[];
    paint(rows);

    // Top 10 lojas (no período atual)
    const byLoja = {};
    rows.forEach(x=>{ const k=x["Nome da loja"]; if(!k) return; byLoja[k]=(byLoja[k]||0)+Number(x.fat||0); });
    const top = Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
    fLoja.innerHTML = '<option>Todas</option>' + top.map(v=>`<option>${v}</option>`).join('');
  }

  function paintEmpty(){
    $("#k_ped").textContent="—"; $("#k_tkm").textContent="—"; $("#k_fat").textContent="—"; $("#k_fmd").textContent="—";
    if (chartLine){ try{chartLine.destroy();}catch(e){} chartLine=null; }
  }

  function paint(data){
    if(!data.length){ paintEmpty(); return; }
    const sum = (arr,fn) => arr.reduce((s,x)=>s+(+fn(x)||0),0);
    const dias = Array.from(new Set(data.map(x=>x.dia))).length || 1;

    const ped = sum(data,x=>x.pedidos||1);
    const fat = sum(data,x=>x.fat);
    const des = sum(data,x=>x.des);
    const fre = sum(data,x=>x.fre);
    const tkm = ped>0? (fat/ped):0;
    const fmd = fat/dias;

    $("#k_ped").textContent = INT(ped);
    $("#k_tkm").textContent = BRL(tkm);
    $("#k_fat").textContent = BRL(fat);
    $("#k_fmd").textContent = BRL(fmd);

    // linha diária
    const byDay = {};
    data.forEach(x=>{ byDay[x.dia]=(byDay[x.dia]||0)+(+x.fat||0); });
    const labels = Object.keys(byDay).sort();
    const values = labels.map(k=>byDay[k]);

    if (chartLine){ try{chartLine.destroy();}catch(e){} chartLine=null; }
    const ctx = $("#cLine").getContext("2d");
    chartLine = new window.Chart(ctx,{ type:"line", data:{labels, datasets:[{data:values, borderWidth:2, pointRadius:0, tension:.2}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  // ======= IMPORTAÇÃO (CSV ; + vírgula decimal) — DEDUP interno =======
  $("#btnImport").addEventListener("click", async ()=>{
    const file = $("#csv").files[0];
    const tag = $("#importMsg"); tag.style.display="inline-block";

    if(!file){ tag.textContent = "Selecione o arquivo."; return; }

    Papa.parse(file,{
      header:true, skipEmptyLines:true, delimiter:";",
      complete: async (res)=>{
        try{
          const rows = res.data || [];
          if (!rows.length){ tag.textContent = "Arquivo vazio."; return; }

          // normalizador de cabeçalho
          const norm = s => String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
          const header = res.meta.fields.map(h=>({orig:h, key:norm(h)}));
          const col = (...names) => {
            const wants = names.map(norm);
            const hit = header.find(h=> wants.includes(h.key));
            return hit ? hit.orig : null;
          };

          const C = {
            unidade:   col('unidade'),
            loja:      col('nome da loja','loja','nome loja'),
            turno:     col('turno'),
            canal:     col('canal de venda','canal','canal venda'),
            pagamento: col('pagamento','forma de pagamento'),
            cancelado: col('esta cancelado','está cancelado','cancelado'),
            dataHora:  col('data da venda','data venda','data'),
            total:     col('total','valor total'),
            desconto:  col('desconto'),
            entrega:   col('entrega','frete','taxa de entrega'),
          };

          if (!C.unidade || !C.dataHora || !C.total){
            tag.textContent = "Nada para importar (colunas não foram reconhecidas).";
            return;
          }

          // converte + agrega por chave composta para evitar duplicidades no mesmo lote
          const map = new Map();
          let minD=null, maxD=null;

          const toBoolSim = (v)=>{
            const s = String(v||'').trim().toLowerCase();
            return /^(s|sim|y|yes|true|1)$/.test(s) ? "Sim" : "Não";
          };

          for (const r of rows){
            const { iso, hour } = parseDMYhm(r[C.dataHora]);
            if(!iso) continue;
            if(!minD || iso<minD) minD=iso;
            if(!maxD || iso>maxD) maxD=iso;

            const unidade   = (r[C.unidade]||"").toString();
            const loja      = (C.loja? r[C.loja] : "") || "";
            const turno     = C.turno ? String(r[C.turno]||"") : "";
            const canal     = C.canal ? String(r[C.canal]||"") : "";
            const pagamento = C.pagamento ? String(r[C.pagamento]||"") : "";
            const cancelado = C.cancelado ? toBoolSim(r[C.cancelado]) : "Não";

            const fat = cnum(r[C.total]);
            const des = C.desconto ? cnum(r[C.desconto]) : 0;
            const fre = C.entrega  ? cnum(r[C.entrega])  : 0;

            const hKey = (Number.isFinite(hour)? String(hour) : 'null');
            const key = [iso,unidade,loja,hKey,pagamento,canal].join('|');

            if (!map.has(key)){
              map.set(key,{
                dia: iso, unidade, pedidos: 1, fat, des, fre,
                "Nome da loja": loja, turno, "Canal de venda": canal, pagamento, cancelado,
                hora: Number.isFinite(hour)? hour : null
              });
            } else {
              const o = map.get(key);
              o.pedidos += 1;
              o.fat += fat;
              o.des += des;
              o.fre += fre;
              if (o.cancelado!=="Sim" && cancelado==="Sim") o.cancelado="Sim";
              if (!o.turno && turno) o.turno = turno;
            }
          }

          const out = Array.from(map.values());
          if (!out.length){ tag.textContent = "Nenhuma linha válida no arquivo."; return; }

          // upsert em lotes — sem exclusão por intervalo
          const chunk = 2000; let done=0;
          for (let i=0;i<out.length;i+=chunk){
            const part = out.slice(i,i+chunk);
            const ins = await supa
              .from(TABLE)
              .upsert(part, { onConflict: 'dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"' });
            if (ins.error){ tag.textContent = "Erro ao inserir: " + ins.error.message; return; }
            done += part.length;
            tag.textContent = `Importando… ${Math.round(done/out.length*100)}%`;
          }
          tag.textContent = "Importado.";
          await fetchLimites(); await fetchDistinct(); await loadData();
        }catch(e){
          console.error(e); tag.textContent = "Falha no import.";
        }
      },
      error: (err)=>{ console.error(err); $("#importMsg").textContent = "Erro no CSV."; }
    });
  });

  // eventos filtros
  $("#btnClear").addEventListener("click", async ()=>{
    fUni.value="Todas"; fLoja.value="Todas"; fTurno.value="Todos"; fCanal.value="Todos"; fPag.value="Todos"; fCanc.value="Todos";
    if (maxISO){
      fAte.value = maxISO; const days = +fPr.value||30;
      const end=new Date(maxISO+"T00:00:00Z"); const start=new Date(end); start.setUTCDate(end.getUTCDate()-(days-1));
      fDe.value = toISO(start);
    } else { fDe.value=""; fAte.value=""; }
    await loadData();
  });
  [fUni,fLoja,fDe,fAte,fPr,fTurno,fCanal,fPag,fCanc].forEach(el=>{
    el.addEventListener("change", async ()=>{
      if (el===fPr && maxISO){
        const days = +fPr.value||30; const end=new Date(maxISO+"T00:00:00Z"); const start=new Date(end); start.setUTCDate(end.getUTCDate()-(days-1));
        fDe.value = toISO(start); fAte.value = maxISO;
      }
      await loadData();
    });
  });

})();
</script>
</body>
</html>
