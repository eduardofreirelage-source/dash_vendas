<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dash Vendas — ETAPA 2 (Filtros)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">V</text></svg>'/>
<style>
  :root{--bg:#0b1220;--card:#121a2b;--muted:#92a0b6;--text:#e9eef6;--acc:#2ea779;--err:#e5484d;--stroke:#23304a}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1180px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 6px}
  .card{background:#11192b;border:1px solid var(--stroke);border-radius:14px;padding:14px;margin-top:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#0f172a;color:#e9eef6}
  .grid{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .btn{background:var(--acc);border:none;color:#fff;cursor:pointer}
  .muted{color:var(--muted)}
  pre{white-space:pre-wrap;background:#0f172a;border:1px solid var(--stroke);border-radius:10px;padding:10px;overflow:auto}
  .err{color:var(--err)}
</style>
</head>
<body>
<div class="container">
  <h1>Dash Vendas — ETAPA 2 (Filtros)</h1>
  <div class="muted">Base: <code>public.vendas_canon</code> (sem duplicatas, turno normalizado).</div>

  <div class="card grid cols-4">
    <div>
      <label>Data inicial</label>
      <input id="dini" type="date"/>
      <div class="muted" id="minmax"></div>
    </div>
    <div>
      <label>Data final</label>
      <input id="dfim" type="date"/>
    </div>
    <div>
      <label>Unidade(s)</label>
      <select id="unids" multiple size="6"></select>
    </div>
    <div>
      <label>Canal(is)</label>
      <select id="canais" multiple size="6"></select>
    </div>
  </div>

  <div class="card grid cols-3">
    <div>
      <label>Pagamento(s)</label>
      <select id="pags" multiple size="6"></select>
    </div>
    <div>
      <label>Turno</label>
      <select id="turno">
        <option value="">Ambos</option>
        <option>Dia</option>
        <option>Noite</option>
      </select>
    </div>
    <div>
      <label>Cancelado</label>
      <select id="cancelado">
        <option value="">Todos</option>
        <option>Não</option>
        <option>Sim</option>
      </select>
    </div>
  </div>

  <div class="card grid cols-3">
    <button class="btn" id="btnAplicar">Aplicar filtros</button>
    <div>
      <b>Total (filtro):</b> <span id="total" class="muted">—</span>
      <span id="msg" class="muted"></span>
    </div>
    <div><button id="btnAmostra" class="btn">Ver amostra</button></div>
  </div>

  <div class="card">
    <b>Amostra (máx. 20)</b>
    <pre id="out">(vazio)</pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script>
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const $ = (id)=>document.getElementById(id);
const dini=$('dini'), dfim=$('dfim'), minmax=$('minmax');
const unids=$('unids'), canais=$('canais'), pags=$('pags');
const turno=$('turno'), cancelado=$('cancelado');
const total=$('total'), out=$('out'), msg=$('msg');

function selectedValues(sel){
  return Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
}
function applyFilters(q){
  if(dini.value) q = q.gte('dia', dini.value);
  if(dfim.value) q = q.lte('dia', dfim.value);
  const u = selectedValues(unids); if(u.length) q = q.in('unidade', u);
  const c = selectedValues(canais); if(c.length) q = q.in('canal', c);
  const p = selectedValues(pags);   if(p.length) q = q.in('pagamento_base', p);
  if(turno.value)     q = q.eq('turno', turno.value);
  if(cancelado.value) q = q.eq('cancelado', cancelado.value);
  return q;
}

async function loadOptions(){
  // daterange
  const r0 = await supa.from('vw_vendas_daterange').select('*').single();
  if(r0.error){ msg.textContent = 'Erro carregar daterange'; console.error(r0.error); }
  const min = r0.data?.min_dia, max = r0.data?.max_dia;
  if(min && max){
    minmax.textContent = `min ${min} · max ${max}`;
    dini.value = min; dfim.value = max;
    dini.min = min; dfim.min = min; dini.max = max; dfim.max = max;
  }
  // unidades
  const r1 = await supa.from('vw_vendas_unidades').select('unidade');
  if(r1.error){ console.error(r1.error); } else {
    unids.innerHTML = (r1.data||[]).map(x=>`<option>${x.unidade}</option>`).join('');
  }
  // canais
  const r2 = await supa.from('vw_vendas_canais').select('canal');
  if(r2.error){ console.error(r2.error); } else {
    canais.innerHTML = (r2.data||[]).map(x=>`<option>${x.canal}</option>`).join('');
  }
  // pagamentos
  const r3 = await supa.from('vw_vendas_pagamentos').select('pagamento_base');
  if(r3.error){ console.error(r3.error); } else {
    pags.innerHTML = (r3.data||[]).map(x=>`<option>${x.pagamento_base}</option>`).join('');
  }
}

async function contar(){
  // contador leve (sem carregar linhas): HEAD + count: 'estimated'
  let q = supa.from('vendas_canon').select('dia', { count: 'estimated', head: true });
  q = applyFilters(q);
  const r = await q;
  if(r.error){ total.textContent = '—'; msg.textContent = ' (erro ao contar)'; console.error(r.error); return; }
  total.textContent = r.count ?? '—';
  msg.textContent = r.count !== null ? ' (estimado)' : '';
}

async function amostra(){
  let q = supa.from('vendas_canon').select('dia,hora,turno,unidade,canal,pagamento_base,fat,des,fre,pedido_id',{ count: null }).order('dia',{ascending:false});
  q = applyFilters(q);
  const r = await q.limit(20);
  out.textContent = r.error ? JSON.stringify(r.error, null, 2) : JSON.stringify(r.data||[], null, 2);
}

$('btnAplicar').addEventListener('click', contar);
$('btnAmostra').addEventListener('click', amostra);

loadOptions().then(contar);
</script>
</body>
</html>
