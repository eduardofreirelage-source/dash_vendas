<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--mut:#6b7280;--card:#fff;--brd:#e5e7eb;--acc:#2563eb;--good:#16a34a;--bad:#dc2626;--chip:#eef2ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:22px auto;padding:0 14px}
    h1{font-size:20px;margin:0}
    .mut{color:var(--mut);font-size:12px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .topbar{display:flex;gap:8px;align-items:center}
    button,select,input{font:inherit;border:1px solid var(--brd);border-radius:8px;background:#fff;padding:8px 10px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid{display:grid;gap:12px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kpi{position:relative}
    .title{font-size:12px;color:var(--mut)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600}
    .up{color:var(--good)} .down{color:var(--bad)}
    .chartbox{position:relative;height:300px;width:100%}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff}
    .pill button.active{background:var(--acc);color:#fff}
    details.filter{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filter>summary{padding:12px 14px;list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600}
    details.filter[open]>summary{border-bottom:1px solid var(--brd)}
    .filters{padding:12px 14px}
    .fgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-12{grid-column:span 12}
    .seg{display:flex;gap:6px;align-items:center}
    .seg .lbl{font-size:12px;color:var(--mut);white-space:nowrap}
    .seg .grow{min-width:160px;width:100%}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    /* compacta multiselect */
    select[multiple]{height:36px;overflow:hidden}
    @media (max-width:940px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}.fgrid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:560px){.grid.cols-4,.grid.cols-2{grid-template-columns:1fr}.fgrid{grid-template-columns:repeat(4,1fr)}}
    /* Gate (auth) */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
    .tabs button.active{background:var(--acc);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--mut);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
    .hint{font-size:12px;color:var(--mut);margin-top:6px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso — Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div id="authForm">
        <div class="field"><label for="authEmail">E-mail</label><input id="authEmail" type="email" placeholder="voce@empresa.com" /></div>
        <div class="field" id="passRow"><label for="authPass">Senha</label><input id="authPass" type="password" placeholder="••••••••" /></div>
        <div class="field" id="newPassRow" style="display:none"><label for="newPass">Nova senha</label><input id="newPass" type="password" placeholder="Defina a nova senha" /></div>
        <div class="field" id="newPassBtnRow" style="display:none"><button id="btnSetNewPass">Definir nova senha</button></div>
        <div class="hint"><a href="#" id="forgot">Esqueci a senha</a></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="btnSignup" style="display:none">Criar conta</button>
          <button id="btnLogin">Entrar</button>
        </div>
        <div class="error" id="authErr"></div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <h1>Maestro Food</h1>
      <div class="topbar">
        <span class="mut" id="who"></span>
        <button id="btnAdmin" class="ghost" style="display:none">Admin usuários</button>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filter" id="fx">
      <summary>FILTROS <span class="mut" id="limpar" style="font-weight:400">Limpar</span></summary>
      <div class="filters">
        <div class="fgrid">
          <div class="col-6 seg"><span class="lbl">Unidade</span><select id="uni" class="grow"></select></div>
          <div class="col-6 seg"><span class="lbl">Nome da loja (Top 10)</span><div id="lojas" class="chips"></div></div>

          <div class="col-3 seg"><span class="lbl">De</span><input id="dini" type="date" class="grow"/></div>
          <div class="col-3 seg"><span class="lbl">Até</span><input id="dfim" type="date" class="grow"/></div>
          <div class="col-3 seg"><span class="lbl">Período rápido</span>
            <select id="pr" class="grow">
              <option value="7">Últimos 7</option><option value="15">Últimos 15</option>
              <option value="30" selected>Últimos 30</option><option value="90">Últimos 90</option>
              <option value="180">Últimos 180</option><option value="360">Últimos 360</option>
            </select>
          </div>
          <div class="col-3 seg"><span class="lbl">Turno</span>
            <select id="turno" class="grow" multiple>
              <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>

          <div class="col-4 seg"><span class="lbl">Canal de venda</span><select id="canal" class="grow" multiple></select></div>
          <div class="col-4 seg"><span class="lbl">Pagamento</span><select id="pag" class="grow" multiple></select></div>
          <div class="col-4 seg"><span class="lbl">Está cancelado?</span>
            <select id="canc" class="grow"><option value="Todos" selected>Todos</option><option>Sim</option><option>Não</option></select>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>) direto do navegador
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
            <input type="file" id="csvfile" accept=".csv" />
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" value="0" max="100" style="display:none;width:220px;height:10px"></progress>
            <span class="mut">Após importar, os gráficos já usam a base carregada.</span>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar"><div class="title" style="font-size:14px;color:inherit">Receita diária</div>
        <div class="pill" id="lineMode"><button data-v="total" class="active">Total</button><button data-v="media">Média (7d)</button></div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
      <div class="mut" style="margin-top:4px">Sombra clara = período anterior do mesmo tamanho.</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar"><div class="title" style="font-size:14px;color:inherit">Receita por dia da semana</div>
        <div class="pill" id="dowFatMode"><button data-v="total" class="active">Total</button><button data-v="media">Média</button></div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar"><div class="title" style="font-size:14px;color:inherit">Pedidos por dia da semana</div>
        <div class="pill" id="dowPedMode"><button data-v="total" class="active">Total</button><button data-v="media">Média</button></div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar"><div class="title" style="font-size:14px;color:inherit">Receita por hora (0–23)</div>
        <div class="pill" id="hourMode"><button data-v="total" class="active">Total</button><button data-v="media">Média</button></div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
      <div class="mut" style="margin-top:4px">Horas com baixa atividade são ocultadas (proxy para >30 min sem venda).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar"><div class="title" style="font-size:14px;color:inherit">Receita por mês</div>
        <div class="pill" id="monMode"><button data-v="total" class="active">Total</button><button data-v="media">Média</button></div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar"><div class="title" style="font-size:14px;color:inherit">Top 10 Lojas (R$)</div>
        <div class="pill" id="topMode"><button data-v="total" class="active">Total</button><button data-v="media">Média</button></div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>

    <!-- Painel Admin (remoto via Edge Function, opcional) -->
    <div class="card" id="adminPanel" style="margin-top:12px;display:none">
      <div class="toolbar"><div class="title">Admin — Usuários</div><div class="mut">Excluir usuários (admins)</div></div>
      <div id="usersBox" class="mut">Carregando…</div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__=true;

  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

  const STAGING = "vendas_kpi_daily_v2_data";   // recebe o CSV
  let   TABLE   = "vendas_kpi_daily_v2";        // MV/tabela oficial; muda para STAGING após import

  const ADMIN_FUNCTION_URL = ""; // preencha quando publicar a Edge Function de admin

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } });

  // ===== UI =====
  const app=document.getElementById("app"), gate=document.getElementById("gate"), who=document.getElementById("who");
  const tabLogin=document.getElementById("tabLogin"), tabSignup=document.getElementById("tabSignup");
  const authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass");
  const btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup");
  const authErr=document.getElementById("authErr"), forgot=document.getElementById("forgot");
  const newPassRow=document.getElementById("newPassRow"), newPassBtnRow=document.getElementById("newPassBtnRow");
  const btnSetNewPass=document.getElementById("btnSetNewPass"), newPass=document.getElementById("newPass");
  const passRow=document.getElementById("passRow");
  const btnLogout=document.getElementById("btnLogout"), btnAdmin=document.getElementById("btnAdmin");
  const adminPanel=document.getElementById("adminPanel"), usersBox=document.getElementById("usersBox");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }

  tabLogin.addEventListener("click",()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; });
  tabSignup.addEventListener("click",()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; });

  btnLogin.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
  });

  btnSignup.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password: pass });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail (se exigido).";
  });

  btnLogout.addEventListener("click", async ()=>{ await supa.auth.signOut(); });

  // Esqueci a senha
  forgot.addEventListener("click", async (e)=>{
    e.preventDefault(); authErr.textContent="";
    const email=(authEmail.value||"").trim(); if(!email){ authErr.textContent="Informe seu e-mail."; return; }
    const redirectTo = window.location.href.split('#')[0];
    const { error } = await supa.auth.resetPasswordForEmail(email, { redirectTo });
    authErr.textContent = error ? error.message : "Enviamos um link de redefinição para o seu e-mail.";
  });

  // Link de recuperação → troca de senha
  async function handleRecoveryIfAny(){
    const hasCode = window.location.hash.includes("type=recovery") || window.location.search.includes("type=recovery");
    if(!hasCode) return;
    const { error } = await supa.auth.exchangeCodeForSession(window.location.href);
    if(error){ authErr.textContent = error.message; return; }
    // Mostra campos de nova senha
    tabLogin.classList.add("active"); tabSignup.classList.remove("active");
    passRow.style.display="none"; btnLogin.style.display="none"; btnSignup.style.display="none";
    newPassRow.style.display="block"; newPassBtnRow.style.display="block";
    authErr.textContent="Defina sua nova senha e clique em 'Definir nova senha'.";
  }
  btnSetNewPass.addEventListener("click", async ()=>{
    const pw=(newPass.value||"").trim(); if(!pw){ authErr.textContent="Digite a nova senha."; return; }
    const { error } = await supa.auth.updateUser({ password: pw });
    authErr.textContent = error ? error.message : "Senha alterada. Você já está autenticado.";
    if(!error){ newPassRow.style.display="none"; newPassBtnRow.style.display="none"; }
  });

  supa.auth.onAuthStateChange(async (_e, session)=>{
    if(session){ hideGate(); const u=await supa.auth.getUser(); who.textContent=u.data.user?.email||""; await afterLogin(); }
    else{ showGate(); who.textContent=""; }
  });

  // ====== Filtros & Data ======
  const selUni=document.getElementById("uni"), chipLojas=document.getElementById("lojas");
  const dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  const turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");

  const limpar=document.getElementById("limpar");
  limpar.addEventListener("click",(e)=>{e.preventDefault(); selUni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos"; [...chipLojas.children].forEach(c=>c.classList.remove("active")); recarregarDebounced(); });

  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ return d.toISOString().slice(0,10); }
  function parseISO(s){ return new Date(s+"T00:00:00Z"); }
  function addDays(d,k){ const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function debounce(fn,wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

  let maxDiaISO=null, minDiaISO=null, diasDisponiveis=new Set();
  async function fetchLimites(){
    // tenta STAGING primeiro: se tiver dados, já usa staging como fonte
    const st = await supa.from(STAGING).select("dia", { count:"exact", head:true });
    if(!st.error && (st.count||0)>0){ TABLE = STAGING; }
    const r1 = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2 = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r1.error||r2.error) return;
    minDiaISO = r1.data?.[0]?.dia||null;
    maxDiaISO = r2.data?.[0]?.dia||null;

    // popula set de dias (para "fixar" datas inexistentes)
    diasDisponiveis = new Set();
    let page=1000, off=0;
    for(;;){
      const rs = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).range(off,off+page-1);
      if(rs.error) break;
      (rs.data||[]).forEach(x=>diasDisponiveis.add(x.dia));
      if((rs.data||[]).length<page) break;
      off+=page; if(off>300000) break;
    }
    if(minDiaISO&&maxDiaISO){ dini.min=minDiaISO; dfim.min=minDiaISO; dini.max=maxDiaISO; dfim.max=maxDiaISO; }
  }
  function snap(iso){ if(!iso||diasDisponiveis.has(iso)) return iso; const d=parseISO(iso); for(let k=1;k<60;k++){ const a=toISO(addDays(d,-k)), b=toISO(addDays(d,k)); if(diasDisponiveis.has(a)) return a; if(diasDisponiveis.has(b)) return b; } return null; }

  async function fetchUnidades(){
    const set=new Set(); set.add("Todas");
    const a = await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).range(0,9999);
    const b = await supa.from(TABLE).select("unidade").order("unidade",{ascending:false}).range(0,9999);
    [a,b].forEach(r=>!r.error && (r.data||[]).forEach(x=>x.unidade&&set.add(x.unidade)));
    return [...set];
  }

  async function fetchPaged(fields,sISO,eISO,uni,lojas,fil){
    let out=[], page=1000, off=0;
    for(;;){
      let q=supa.from(TABLE).select(fields).gte("dia",sISO).lte("dia",eISO).order("dia",{ascending:true}).range(off,off+page-1);
      if(uni && uni!=="Todas") q=q.eq("unidade",uni);
      if(lojas && lojas.length) q=q.in("Nome da Loja", lojas);
      if(fil.turno?.length) q=q.in("turno", fil.turno);
      if(fil.canal?.length) q=q.in("Canal de venda", fil.canal);
      if(fil.pag?.length)   q=q.in("pagamento", fil.pag);
      if(fil.canc && fil.canc!=="Todos") q=q.eq("cancelado", fil.canc==="Sim"?"Sim":"Não");
      const r=await q; if(r.error) throw r.error;
      const a=r.data||[]; out=out.concat(a);
      if(a.length<page) break; off+=page; if(off>500000) break;
    }
    return out;
  }

  // KPIs + Gráficos
  const ids={
    ped:["k_ped","d_ped"],tkm:["k_tkm","d_tkm"],fat:["k_fat","d_fat"],fmd:["k_fmd","d_fmd"],
    des:["k_des","d_des"],desp:["k_desp","d_desp"],fre:["k_fre","d_fre"],frem:["k_frem","d_frem"],
    fatl:["k_fatl","d_fatl"],fatlp:["k_fatlp","d_fatlp"]
  };
  function setDelta(el,cur,prev){ const pct= prev>0? ((cur-prev)/prev*100):0; el.className="delta "+(pct>=0?"up":"down"); el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"%"; }

  let chartLine=null,chartDowFat=null,chartDowPed=null,chartHour=null,chartMonth=null,chartTop=null;
  function destroy(c){ if(c){ try{c.destroy();}catch(e){} } return null; }
  function movingAvg(a,w){ const out=[],n=a.length; let acc=0; for(let i=0;i<n;i++){ acc+=a[i]; if(i>=w) acc-=a[i-w]; out.push(acc/Math.min(i+1,w)); } return out; }

  function drawLine(days,vals,prev,mode){
    chartLine=destroy(chartLine); const ctx=document.getElementById("cLine").getContext("2d");
    const dataCur=mode==="media"? movingAvg(vals,7) : vals.slice();
    chartLine=new Chart(ctx,{type:"line",data:{labels:days,datasets:[
      {data:prev,fill:true,borderWidth:0,backgroundColor:"rgba(2,132,199,.12)",pointRadius:0,tension:.2},
      {data:dataCur,borderWidth:2,pointRadius:0,tension:.2}
    ]},options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}});
  }
  function drawBar(id,labels,totals,counts,mode){
    const showAvg=mode==="media"; const vals=showAvg? totals.map((v,i)=> (counts[i]||1)? v/(counts[i]||1):0 ) : totals.slice();
    const ctx=document.getElementById(id).getContext("2d");
    return new Chart(ctx,{type:"bar",data:{labels:labels,datasets:[{data:vals}]},options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }

  let runId=0;
  async function recarregar(){
    const myRun=++runId;
    try{
      if(!maxDiaISO) await fetchLimites();
      if(!maxDiaISO) return;

      let s,e;
      if(dini.value && dfim.value){
        const s0=snap(dini.value), e0=snap(dfim.value);
        if(s0) dini.value=s0; if(e0) dfim.value=e0;
        s=parseISO(dini.value); e=parseISO(dfim.value);
      }else{
        const end=parseISO(maxDiaISO); const start=addDays(end,-((Number(pr.value)||30)-1)); s=start; e=end; dini.value=toISO(s); dfim.value=toISO(e);
      }
      const startISO=toISO(s), endISO=toISO(e);

      const lojas=[...chipLojas.children].filter(c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      const filtros={ turno:[...turno.selectedOptions].map(o=>o.value), canal:[...canal.selectedOptions].map(o=>o.value), pag:[...pag.selectedOptions].map(o=>o.value), canc:canc.value||"Todos" };
      const uniVal=selUni.value||"Todas";

      const fields = 'dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora';
      const cur = await fetchPaged(fields,startISO,endISO,uniVal==="Todas"?null:uniVal,lojas,filtros);
      if(myRun!==runId) return;
      const daysLen=Math.max(1, Math.round((e-s)/(24*3600*1000))+1);
      const prevEnd=addDays(s,-1), prevStart=addDays(prevEnd,-(daysLen-1));
      const ant= await fetchPaged(fields,toISO(prevStart),toISO(prevEnd),uniVal==="Todas"?null:uniVal,lojas,filtros);
      if(myRun!==runId) return;

      // preencher opções de Canal/Pagamento (somente 1ª vez)
      if(canal.options.length===0 || pag.options.length===0){
        const all=await fetchPaged('"Canal de venda",pagamento',minDiaISO,maxDiaISO,null,null,{});
        const canals=[...new Set((all||[]).map(r=>r["Canal de venda"]).filter(Boolean))].sort();
        const pags=[...new Set((all||[]).map(r=>r["pagamento"]).filter(Boolean))].sort();
        canals.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; canal.appendChild(o); });
        pags.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; pag.appendChild(o); });
      }

      // KPIs
      const sum=(a,k)=>a.reduce((s,r)=>s+Number(r[k]||0),0);
      const ped=sum(cur,"pedidos"), fat=sum(cur,"fat"), des=sum(cur,"des"), fre=sum(cur,"fre");
      const pedA=sum(ant,"pedidos"), fatA=sum(ant,"fat"), desA=sum(ant,"des"), freA=sum(ant,"fre");
      const diasCur=new Set(cur.map(r=>r.dia)).size||1, diasAnt=new Set(ant.map(r=>r.dia)).size||1;
      const tkm=ped>0? fat/ped:0, tkmA=pedA>0? fatA/pedA:0;
      const fmd=fat/diasCur, fmdA=fatA/diasAnt;
      const fatL=fat - des - fre - (0.12*fat), fatLA=fatA - desA - freA - (0.12*fatA);
      const desP= fat>0? (des/fat*100):0, desPA= fatA>0? (desA/fatA*100):0;
      const freM= ped>0? fre/ped:0, freMA= pedA>0? freA/pedA:0;
      const fatLP= fat>0? (fatL/fat*100):0, fatLPA= fatA>0? (fatLA/fatA*100):0;

      document.getElementById(ids.ped[0]).textContent=fmtInt(ped);
      document.getElementById(ids.tkm[0]).textContent=fmtBRL(tkm);
      document.getElementById(ids.fat[0]).textContent=fmtBRL(fat);
      document.getElementById(ids.fmd[0]).textContent=fmtBRL(fmd);
      document.getElementById(ids.des[0]).textContent=fmtBRL(des);
      document.getElementById(ids.desp[0]).textContent=desP.toFixed(1)+"%";
      document.getElementById(ids.fre[0]).textContent=fmtBRL(fre);
      document.getElementById(ids.frem[0]).textContent=fmtBRL(freM);
      document.getElementById(ids.fatl[0]).textContent=fmtBRL(fatL);
      document.getElementById(ids.fatlp[0]).textContent=fatLP.toFixed(1)+"%";

      setDelta(document.getElementById(ids.ped[1]), ped, pedA);
      setDelta(document.getElementById(ids.tkm[1]), tkm, tkmA);
      setDelta(document.getElementById(ids.fat[1]), fat, fatA);
      setDelta(document.getElementById(ids.fmd[1]), fmd, fmdA);
      setDelta(document.getElementById(ids.des[1]), des, desA);
      setDelta(document.getElementById(ids.desp[1]), desP, desPA);
      setDelta(document.getElementById(ids.fre[1]), fre, freA);
      setDelta(document.getElementById(ids.frem[1]), freM, freMA);
      setDelta(document.getElementById(ids.fatl[1]), fatL, fatLA);
      setDelta(document.getElementById(ids.fatlp[1]), fatLP, fatLPA);

      // Line (com sombra)
      const byDayMap=new Map(), byDayPrev=new Map();
      cur.forEach(r=>byDayMap.set(r.dia,(byDayMap.get(r.dia)||0)+Number(r.fat||0)));
      ant.forEach(r=>byDayPrev.set(r.dia,(byDayPrev.get(r.dia)||0)+Number(r.fat||0)));
      const days=[...byDayMap.keys()].sort(); const vals=days.map(d=>byDayMap.get(d));
      const prevVals=days.map(d=>byDayPrev.get(d)||0);
      drawLine(days,vals,prevVals, lineMode);

      // DOW fat/ped
      function aggDow(rows, field){
        const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"]; const tot=[0,0,0,0,0,0,0]; const cnt=[0,0,0,0,0,0,0];
        const diasSet=new Set(rows.map(r=>r.dia)); [...diasSet].forEach(d=>cnt[parseISO(d).getUTCDay()]++);
        rows.forEach(r=>{ const d=parseISO(r.dia).getUTCDay(); tot[d]+=Number(r[field]||0); });
        return {labels:lbl, totals:tot, counts:cnt};
      }
      const dFat=aggDow(cur,"fat"); chartDowFat=destroy(chartDowFat); chartDowFat=drawBar("cDowFat", dFat.labels, dFat.totals, dFat.counts, dowFatMode);

      const dPed=aggDow(cur,"pedidos"); chartDowPed=destroy(chartDowPed); chartDowPed=drawBar("cDowPed", dPed.labels, dPed.totals, dPed.counts, dowPedMode);

      // HORA (ocultando horas com poucos dias ativos)
      const hourLabels=[], hourTotals=[], hourCounts=[];
      const daysByHour = Array(24).fill(0).map(()=>new Set()); const acc=Array(24).fill(0);
      cur.forEach(r=>{ if(r.hora==null) return; const h=Number(r.hora)||0; if(h<0||h>23) return; acc[h]+=Number(r.fat||0); daysByHour[h].add(r.dia); });
      const totalDays=new Set(cur.map(r=>r.dia)).size||1;
      for(let h=0;h<24;h++){ const active=daysByHour[h].size; const keep = active>=Math.ceil(totalDays*0.5) && acc[h]>0;
        if(keep){ hourLabels.push(String(h).padStart(2,"0")+":00"); hourTotals.push(acc[h]); hourCounts.push(active); } }
      chartHour=destroy(chartHour); chartHour=drawBar("cHour", hourLabels, hourTotals, hourCounts, hourMode);

      // MÊS
      const mMap=new Map(), daysPerM=new Map();
      cur.forEach(r=>{ const ym=r.dia.slice(0,7); mMap.set(ym,(mMap.get(ym)||0)+Number(r.fat||0));
        if(!daysPerM.has(ym)) daysPerM.set(ym,new Set()); daysPerM.get(ym).add(r.dia); });
      const mLabels=[...mMap.keys()].sort(); const mTotals=mLabels.map(x=>mMap.get(x)); const mCounts=mLabels.map(x=> (daysPerM.get(x)||new Set()).size||1);
      chartMonth=destroy(chartMonth); chartMonth=drawBar("cMonth", mLabels, mTotals, mCounts, monMode);

      // TOP 10 + chips (só preenche chips na 1ª vez)
      const byLoja={}; cur.forEach(r=>{ const n=r["Nome da Loja"]; if(!n) return; byLoja[n]=(byLoja[n]||0)+Number(r.fat||0); });
      const top=Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const topLabels=top.map(x=>x[0]), topTotals=top.map(x=>x[1]), topCounts=topLabels.map(_=>diasCur);
      chartTop=destroy(chartTop);
      const showAvg=(topMode==="media"); const tVals=showAvg? topTotals.map((v,i)=> v/(topCounts[i]||1) ): topTotals.slice();
      chartTop=new Chart(document.getElementById("cTop").getContext("2d"),{type:"bar",data:{labels:topLabels,datasets:[{data:tVals}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
      if(chipLojas.children.length===0){ chipLojas.innerHTML=""; topLabels.forEach(lbl=>{ const c=document.createElement("span"); c.className="chip"; c.textContent=lbl; c.setAttribute("data-v",lbl); c.addEventListener("click",()=>{ c.classList.toggle("active"); recarregarDebounced(); }); chipLojas.appendChild(c); }); }
    }catch(e){ console.error(e); }
  }
  const recarregarDebounced=debounce(recarregar,120);

  // Botões dos modos (Total/Média)
  let lineMode="total", dowFatMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";
  function wirePill(id, setter){ document.getElementById(id).querySelectorAll("button").forEach(b=>{ b.addEventListener("click",()=>{ b.parentElement.querySelectorAll("button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); setter(b.getAttribute("data-v")); recarregarDebounced(); }); });}
  wirePill("lineMode",v=>lineMode=v); wirePill("dowFatMode",v=>dowFatMode=v); wirePill("dowPedMode",v=>dowPedMode=v); wirePill("hourMode",v=>hourMode=v); wirePill("monMode",v=>monMode=v); wirePill("topMode",v=>topMode=v);

  // Import CSV (limpa staging e insere — correção: not('is', null) em vez de neq(null))
  document.getElementById("btnImport").addEventListener("click", async ()=>{
    const f=document.getElementById("csvfile").files[0]; if(!f){ alert("Selecione Pasta2.csv"); return; }
    const prog=document.getElementById("prog"); prog.style.display="inline-block"; prog.value=0;

    // limpa staging
    await supa.from(STAGING).delete().not('dia','is',null);

    Papa.parse(f,{ header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        const rows=res.data||[]; const chunk=2000; let done=0;
        for(let i=0;i<rows.length;i+=chunk){
          const slice=rows.slice(i,i+chunk).map(r=>({
            dia:r.dia, unidade:r.unidade, pedidos:Number(r.pedidos)||0, fat:Number(r.fat)||0, des:Number(r.des)||0, fre:Number(r.fre)||0,
            "Nome da Loja":r["Nome da Loja"], turno:r.turno, "Canal de venda":r["Canal de venda"], pagamento:r.pagamento, cancelado:r.cancelado, hora:r.hora!==""?Number(r.hora):null
          }));
          const ins=await supa.from(STAGING).insert(slice); if(ins.error){ alert("Erro ao importar: "+ins.error.message); break; }
          done+=slice.length; prog.value=Math.round(done/rows.length*100);
        }
        prog.style.display="none";
        TABLE=STAGING; // usa imediatamente o staging
        await fetchLimites(); await recarregar();
        // recolhe a caixa de filtros
        document.getElementById("fx").open=false;
      },
      error:(err)=>{ prog.style.display="none"; alert("CSV inválido: "+(err.message||err)); }
    });
  });

  async function afterLogin(){
    await handleRecoveryIfAny();
    const opts=await fetchUnidades();
    selUni.innerHTML=""; opts.forEach(u=>{ const o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); }); selUni.value="Todas";
    [selUni,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>el.addEventListener("change",()=>{ document.getElementById("fx").open=false; recarregarDebounced(); }));
    await fetchLimites();
    // datas iniciais ancoradas no último dia do banco
    if(maxDiaISO){ const end=parseISO(maxDiaISO); const start=addDays(end,-29); dini.value=toISO(start); dfim.value=toISO(end); }
    await recarregar();

    // admin users (opcional)
    btnAdmin.style.display = ADMIN_FUNCTION_URL ? "inline-block" : "none";
    btnAdmin.addEventListener("click", async ()=>{
      if(!ADMIN_FUNCTION_URL){ alert("Function não configurada."); return; }
      const { data:{ session } } = await supa.auth.getSession(); if(!session){ alert("Faça login."); return; }
      adminPanel.style.display="block"; usersBox.textContent="Carregando…";
      try{
        const r=await fetch(ADMIN_FUNCTION_URL,{ headers:{Authorization:"Bearer "+session.access_token} });
        if(!r.ok){ usersBox.textContent="Sem permissão/erro no backend."; return; }
        const js=await r.json(); if(!Array.isArray(js)||!js.length){ usersBox.textContent="Sem usuários."; return; }
        const table=document.createElement("table"); table.style.width="100%"; table.style.borderCollapse="collapse";
        table.innerHTML=`<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid var(--brd)">E-mail</th><th style="text-align:left;padding:6px;border-bottom:1px solid var(--brd)">Criado</th><th style="padding:6px;border-bottom:1px solid var(--brd)">Ação</th></tr></thead><tbody></tbody>`;
        js.forEach(u=>{ const tr=document.createElement("tr");
          tr.innerHTML=`<td style="padding:6px;border-bottom:1px solid var(--brd)">${u.email}</td>
            <td style="padding:6px;border-bottom:1px solid var(--brd)">${(u.created_at||"").replace("T"," ").replace("Z","")}</td>
            <td style="padding:6px;border-bottom:1px solid var(--brd);text-align:center"><button data-id="${u.id}">Excluir</button></td>`;
          table.tBodies[0].appendChild(tr);
        });
        usersBox.innerHTML=""; usersBox.appendChild(table);
        usersBox.querySelectorAll("button[data-id]").forEach(b=>b.addEventListener("click", async ()=>{
          if(!confirm("Excluir este usuário?")) return;
          const { data:{ session } } = await supa.auth.getSession();
          const del=await fetch(ADMIN_FUNCTION_URL+"?id="+encodeURIComponent(b.getAttribute("data-id")), { method:"DELETE", headers:{Authorization:"Bearer "+session.access_token} });
          if(del.ok) b.closest("tr").remove(); else alert("Falha ao excluir.");
        }));
      }catch(err){ usersBox.textContent="Erro: "+(err.message||err); }
    });
  }

  // arranque
  (async function init(){
    const { data:{ session } } = await supa.auth.getSession();
    if(session){ hideGate(); who.textContent=(await supa.auth.getUser()).data.user?.email||""; await afterLogin(); }
    else{ showGate(); await handleRecoveryIfAny(); }
  })();
})();
</script>
</body>
</html>
