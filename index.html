<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food — Importador CSV (v2)</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--mut:#667085;--blue:#1a73e8;--ok:#16a34a;--err:#dc2626;--bd:#e6eaf2;--r:14px}
  body{background:var(--bg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink)}
  .wrap{max-width:900px;margin:32px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:16px}
  h1{margin:0 0 6px 0;font-size:22px}
  .mut{color:var(--mut)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type=file]{border:1px solid var(--bd);border-radius:10px;padding:10px;background:#fff}
  button{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  progress{width:100%;height:10px}
  pre{background:#0b1220;color:#e2e8f0;padding:12px;border-radius:10px;overflow:auto;max-height:260px}
  code{background:#eef3ff;padding:2px 6px;border-radius:6px}
  .ok{color:var(--ok)} .err{color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food — Importador CSV (v2)</h1>
  <p class="mut">Preenche <b>vendas_kpi_daily_v2_data</b>. Dedup: <code>dia, unidade, "Nome da loja", hora, pagamento, "Canal de venda"</code>.</p>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <input id="csv" type="file" accept=".csv,text/csv"/>
      <button id="go">Importar CSV</button>
      <span id="msg" class="mut"></span>
    </div>
    <div style="margin-top:10px">
      <progress id="pg" value="0" max="1" hidden></progress>
    </div>
    <div id="counters" style="margin-top:8px" class="mut"></div>
    <div id="log" style="margin-top:10px"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div id="check"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
(async function(){
  // ===== CONFIG =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE         = "vendas_kpi_daily_v2_data";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const onConflict = 'dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"';
  const BATCH = 3000;

  // ===== UI =====
  const $ = id => document.getElementById(id);
  const csvInp = $('csv'), go = $('go'), msg = $('msg'), pg = $('pg'), log = $('log'), check = $('check'), counters = $('counters');

  // ===== Helpers =====
  const norm = s => String(s??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const normCancel = v => (v===true || ['sim','s','1','true','y'].includes(norm(v))) ? 'Sim' : 'Não';
  const parseBR = x => {
    if (x==null || x==='') return 0;
    if (typeof x==='number') return x;
    const n = Number(String(x).trim().replace(/\./g,'').replace(',','.'));
    return Number.isFinite(n) ? n : 0;
  };
  const ddmmyyyyToISO = s => {
    if (!s) return null;
    const [datePart,timePart] = String(s).trim().split(' ');
    const [d,m,y] = (datePart||'').split('/');
    if (!d||!m||!y) return null;
    const iso = `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    return (timePart ? `${iso}T${timePart}:00` : `${iso}T00:00:00`);
  };
  const hourFromDateText = s => {
    const t = String(s||'').split(' ')[1]||'';
    if (t.includes(':')) {
      const h = parseInt(t.split(':')[0],10);
      if (Number.isFinite(h)) return h;
    }
    return -1;
  };
  const onlyDate = iso => (iso && typeof iso === 'string' && iso.length>=10) ? iso.slice(0,10) : null;
  const isISODate = d => /^\d{4}-\d{2}-\d{2}$/.test(d) && !Number.isNaN(new Date(d).getTime());

  // ===== Healthcheck =====
  async function health(){
    const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    const c = await supa.from(TABLE).select('*', { count:'exact', head:true });
    const min = a.data?.[0]?.dia?.slice(0,10) || '—';
    const max = b.data?.[0]?.dia?.slice(0,10) || '—';
    check.innerHTML = `Tabela: <code>${TABLE}</code><br>Intervalo no banco: <b>${min}</b> → <b>${max}</b><br>Total (count exato): <b>${c.count ?? '—'}</b>`;
  }
  await health();

  // ===== Delimitador (auto) =====
  async function detectDelimiter(file){
    const first = await file.slice(0, 4096).text();
    const semis = (first.match(/;/g)||[]).length;
    const commas = (first.match(/,/g)||[]).length;
    const tabs = (first.match(/\t/g)||[]).length;
    if (semis >= commas && semis >= tabs) return ';';
    if (commas >= tabs) return ',';
    return '\t';
  }

  // ===== Importação =====
  go.addEventListener('click', async ()=>{
    const file = csvInp.files?.[0];
    if (!file){ msg.textContent = 'Selecione o CSV.'; return; }

    const delimiter = await detectDelimiter(file);
    msg.textContent = `Lendo arquivo… (delimitador: "${delimiter==="\t"?"TAB":delimiter}")`;
    pg.hidden=false; pg.value=0; log.innerHTML=''; counters.textContent='';

    let total=0, ok=0, badDate=0, badRequired=0, sent=0;
    let acc = [];

    Papa.parse(file, {
      header:true,
      skipEmptyLines:'greedy',
      delimiter,
      encoding:'utf-8',
      transformHeader: (h)=>{
        const k = norm(h);
        // sinônimos -> nomes do banco
        const map = {
          'dia':'dia','data':'dia','data da venda':'dia','data de venda':'dia','dt_venda':'dia','dt venda':'dia','datadavenda':'dia',
          'unidade':'unidade','filial':'unidade',
          'total':'fat','faturamento':'fat','valor total':'fat','valor':'fat','total geral':'fat',
          'desconto':'des','des':'des',
          'entrega':'fre','frete':'fre','fre':'fre',
          'pagamento':'pagamento','forma de pagamento':'pagamento','meio de pagamento':'pagamento','tipo de pagamento':'pagamento',
          'canal de venda':'Canal de venda','canal_venda':'Canal de venda','canal':'Canal de venda',
          'nome da loja':'Nome da loja','loja':'Nome da loja','nome loja':'Nome da loja',
          'turno':'turno',
          'esta cancelado':'cancelado','está cancelado':'cancelado','cancelado':'cancelado',
          'hora':'hora','horario':'hora','horário':'hora'
        };
        return map[k] ?? h; // mantém desconhecidos
      },
      step: async (row, parser)=>{
        total++;
        const r = row.data;

        // === extrai & valida data ===
        let diaIso = null;
        if (r.dia){
          if (String(r.dia).includes('/')) diaIso = ddmmyyyyToISO(r.dia);
          else diaIso = r.dia;
        }
        const dia = onlyDate(diaIso);
        if (!dia || !isISODate(dia)){ badDate++; return; }

        // obrigatórios
        const unidade = (r.unidade??'').toString().trim();
        const fat = parseBR(r.fat);
        if (!unidade || !Number.isFinite(fat)){ badRequired++; return; }

        // números extras
        const des = parseBR(r.des);
        const fre = parseBR(r.fre);

        // hora
        let hora = -1;
        if ('hora' in r && r.hora !== '' && r.hora != null){
          const h = parseInt(r.hora,10); if (Number.isFinite(h)) hora = h;
        } else {
          hora = hourFromDateText(r.dia);
        }

        acc.push({
          dia, unidade, pedidos: 1,
          fat, des, fre,
          turno: r.turno ?? null,
          pagamento: r.pagamento ?? null,
          "Canal de venda": r["Canal de venda"] ?? null,
          "Nome da loja": r["Nome da loja"] ?? null,
          cancelado: normCancel(r.cancelado),
          hora: Number.isFinite(hora) ? hora : -1
        });
        ok++;

        // flush por lote
        if (acc.length >= BATCH){
          parser.pause();
          msg.textContent = `Enviando… ${sent + acc.length} linhas`;
          await sendBatch(acc);
          sent += acc.length; acc = [];
          pg.value = ok / Math.max(total, 1);
          counters.textContent = `Lidas: ${total.toLocaleString('pt-BR')} • Válidas: ${ok.toLocaleString('pt-BR')} • Data inválida: ${badDate.toLocaleString('pt-BR')} • Faltando obrigatórios: ${badRequired.toLocaleString('pt-BR')}`;
          parser.resume();
        }
      },
      complete: async ()=>{
        if (acc.length){
          msg.textContent = `Enviando… ${sent + acc.length} linhas (finalizando)`;
          await sendBatch(acc);
          sent += acc.length;
        }
        msg.innerHTML = `<span class="ok">Concluído.</span> Enviadas ${ok.toLocaleString('pt-BR')} linhas válidas.`;
        counters.textContent = `Lidas: ${total.toLocaleString('pt-BR')} • Válidas: ${ok.toLocaleString('pt-BR')} • Data inválida: ${badDate.toLocaleString('pt-BR')} • Faltando obrigatórios: ${badRequired.toLocaleString('pt-BR')}`;
        pg.hidden = true;
        await health();
      },
      error: (e)=>{ msg.innerHTML = `<span class="err">Erro ao ler CSV:</span> ${e?.message||e}`; }
    });
  });

  async function sendBatch(batch){
    // dedup no lote para evitar 409
    const m = new Map();
    for (const r of batch){
      const key = [r.dia,r.unidade,r["Nome da loja"],r.hora,r.pagamento,r["Canal de venda"]].join('|');
      const cur = m.get(key) || { ...r };
      cur.pedidos = (cur.pedidos||0) + (r.pedidos||0);
      cur.fat     = (cur.fat||0)     + (r.fat||0);
      cur.des     = (cur.des||0)     + (r.des||0);
      cur.fre     = (cur.fre||0)     + (r.fre||0);
      cur.cancelado = r.cancelado || cur.cancelado || 'Não';
      m.set(key, cur);
    }
    const rows = [...m.values()];
    const { error } = await supa.from(TABLE).upsert(rows, { onConflict, ignoreDuplicates:false });
    if (error){
      const div = document.createElement('div');
      div.innerHTML = `<div class="err">Supabase erro:</div><pre>${JSON.stringify(error,null,2)}</pre><div class="mut">Dica: erro 22*** costuma ser dado de coluna inválida; este importador agora <b>não envia</b> linhas sem data válida.</div>`;
      log.appendChild(div);
      throw error;
    }
  }
})();
</script>
</body>
</html>
