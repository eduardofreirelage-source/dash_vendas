```html
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232563eb'/%3E%3Ctext x='32' y='38' font-size='26' text-anchor='middle' fill='%23fff' font-family='Arial'%3EMF%3C/text%3E%3C/svg%3E">
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff; --warn:#eab308; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px;cursor:pointer}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)} .delta.warn{color:var(--warn)}
    .sparkline{height:30px;width:100px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff;cursor:pointer}
    .pill button.active{background:var(--accent);color:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,button,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    input[type="date"]{padding:7px 10px}
    input[type="number"]{width:100px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    .chartbox{position:relative;height:300px;width:100%}
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{min-width:180px}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .status{font-size:12px}
    .status.ok{color:var(--good)} .status.err{color:var(--bad)}
    .hidden{display:none !important}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-box{background:#fff;border-radius:14px;padding:16px;max-width:500px;width:90%}
    @media (max-width:980px){
      .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
      .filters-grid{grid-template-columns:repeat(6,1fr)}
      .grow{min-width:140px}
    }
    @media (max-width:560px){
      .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}
      .filters-grid{grid-template-columns:repeat(4,1fr)}
      .grow{min-width:120px}
    }
    /* AUTH */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px;cursor:pointer}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso — Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div id="authForm">
        <div class="field">
          <label for="authEmail">E-mail</label>
          <input id="authEmail" type="email" autocomplete="email" placeholder="voce@empresa.com" />
        </div>
        <div class="field" id="passRow">
          <label for="authPass">Senha</label>
          <input id="authPass" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
        <div class="field hidden" id="newPassRow">
          <label for="newPass">Nova senha</label>
          <input id="newPass" type="password" autocomplete="new-password" placeholder="Nova senha" />
        </div>
        <div class="row" style="margin-top:10px;justify-content:space-between">
          <span class="muted" id="forgot" style="cursor:pointer">Esqueci a senha</span>
          <div>
            <button id="btnSignup" style="display:none">Criar conta</button>
            <button id="btnLogin">Entrar</button>
            <button id="btnSaveNew" style="display:none">Salvar nova senha</button>
          </div>
        </div>
        <div class="error" id="authErr"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <div class="topbar">
        <span class="status" id="statusTxt"></span>
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filterbox" id="fx">
      <summary>
        FILTROS
        <span class="muted right" id="limpar" title="Limpar filtros" style="font-weight:400">Limpar</span>
      </summary>
      <div class="body">
        <div class="filters-grid">
          <!-- Linha 1 -->
          <div class="col-6">
            <div class="row">
              <span class="lbl">Unidade</span>
              <select id="uni" class="grow"></select>
            </div>
          </div>
          <div class="col-6">
            <div class="row">
              <span class="lbl">Nome da loja (Top 10)</span>
              <div id="lojas" class="chips"></div>
            </div>
          </div>
          <!-- Linha 2 -->
          <div class="col-3">
            <div class="row"><span class="lbl">De</span><input type="date" id="dini" class="grow" /></div>
          </div>
          <div class="col-3">
            <div class="row"><span class="lbl">Até</span><input type="date" id="dfim" class="grow" /></div>
          </div>
          <div class="col-3">
            <div class="row">
              <span class="lbl">Período rápido</span>
              <select id="pr" class="grow">
                <option value="7">Últimos 7</option>
                <option value="15">Últimos 15</option>
                <option value="30" selected>Últimos 30</option>
                <option value="90">Últimos 90</option>
                <option value="180">Últimos 180</option>
                <option value="360">Últimos 360</option>
              </select>
            </div>
          </div>
          <div class="col-3">
            <div class="row">
              <span class="lbl">Turno</span>
              <select id="turno" class="grow" multiple>
                <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
              </select>
            </div>
          </div>
          <!-- Linha 3 -->
          <div class="col-4">
            <div class="row"><span class="lbl">Canal de venda</span><select id="canal" class="grow" multiple></select></div>
          </div>
          <div class="col-4">
            <div class="row"><span class="lbl">Pagamento</span><select id="pag" class="grow" multiple></select></div>
          </div>
          <div class="col-4">
            <div class="row">
              <span class="lbl">Está cancelado?</span>
              <select id="canc" class="grow">
                <option value="Todos" selected>Todos</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>
          </div>
          <!-- Linha 4: Custos -->
          <div class="col-3">
            <div class="row">
              <span class="lbl">CMV %</span>
              <input type="number" id="cmvPct" class="grow" value="30" min="0" max="100" step="0.1" />
            </div>
          </div>
          <div class="col-3">
            <div class="row">
              <span class="lbl">Custos Fixos %</span>
              <input type="number" id="fixPct" class="grow" value="10" min="0" max="100" step="0.1" />
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;justify-content:space-between;flex-wrap:wrap">
          <div>
            <input type="file" id="csvfile" accept=".csv" />
            <button id="btnImport">Importar CSV (incremental)</button>
            <progress id="prog" value="0" max="100" style="display:none"></progress>
          </div>
          <div class="muted" id="impMsg"></div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi">
        <div class="title">Pedidos</div><div class="val" id="k_ped">—</div>
        <div class="delta" id="d_ped">—</div>
        <canvas class="sparkline" id="s_ped"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Ticket Médio (por Canal)</div><div class="val" id="k_tkm">—</div>
        <div class="delta" id="d_tkm">—</div>
        <canvas class="sparkline" id="s_tkm"></canvas>
      </div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi">
        <div class="title">Faturamento</div><div class="val" id="k_fat">—</div>
        <div class="delta" id="d_fat">—</div>
        <canvas class="sparkline" id="s_fat"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento Médio (Dia)</div><div class="val" id="k_fmd">—</div>
        <div class="delta" id="d_fmd">—</div>
        <canvas class="sparkline" id="s_fmd"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div>
        <div class="delta" id="d_fatl">—</div>
        <canvas class="sparkline" id="s_fatl"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div>
        <div class="delta" id="d_fatlp">—</div>
        <canvas class="sparkline" id="s_fatlp"></canvas>
      </div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi">
        <div class="title">Margem de Contribuição %</div><div class="val" id="k_marg">—</div>
        <div class="delta" id="d_marg">—</div>
        <canvas class="sparkline" id="s_marg"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">ROI Incentivos %</div><div class="val" id="k_roi">—</div>
        <div class="delta" id="d_roi">—</div>
        <canvas class="sparkline" id="s_roi"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Custo por Pedido</div><div class="val" id="k_cpp">—</div>
        <div class="delta" id="d_cpp">—</div>
        <canvas class="sparkline" id="s_cpp"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Churn de Lojas %</div><div class="val" id="k_churn">—</div>
        <div class="delta" id="d_churn">—</div>
        <canvas class="sparkline" id="s_churn"></canvas>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária (Stacked por Canal) — forecast em dashed</div>
        <div class="pill" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média (7d)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana</div>
        <div class="pill" data-target="dowMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora (0–23)</div>
        <div class="pill" data-target="hourMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
      <div class="muted" style="margin-top:6px">Oculto horários com baixa atividade (&gt;30min sem venda).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por mês (Waterfall: Ganhos vs. Perdas)</div>
        <div class="pill" data-target="monMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas (Treemap)</div>
        <div class="pill" data-target="topMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pareto de Canais (80/20)</div>
        <div class="pill" data-target="paretoMode">
          <button data-val="total" class="active">Total</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cPareto"></canvas></div>
    </div>

    <!-- Modal para Breakdown -->
    <div class="modal" id="kpiModal">
      <div class="modal-box">
        <h3 id="modalTitle"></h3>
        <div id="modalContent"></div>
        <button onclick="document.getElementById('kpiModal').classList.remove('active')">Fechar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // Supabase Config
  var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });

  // Fonte
  var SOURCE_PREF = "vendas_kpi_daily_v2_data";
  var SOURCE_FALL = "vendas_kpi_daily_v2";
  var TABLE = null;
  var keyLoja = "Nome da loja";
  var keyCanal = "Canal de venda";

  // Estado/UI
  var app=document.getElementById("app"), gate=document.getElementById("gate");
  var who=document.getElementById("who"), statusTxt=document.getElementById("statusTxt");
  var uni=document.getElementById("uni"), lojasBox=document.getElementById("lojas");
  var dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  var turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  var cmvPct=document.getElementById("cmvPct"), fixPct=document.getElementById("fixPct");
  var periodoTxt=document.getElementById("periodo"), fx=document.getElementById("fx");
  var csvfile=document.getElementById("csvfile"), btnImport=document.getElementById("btnImport"), prog=document.getElementById("prog"), impMsg=document.getElementById("impMsg");

  // AUTH (mantido como original)
  var tabLogin=document.getElementById("tabLogin"), tabSignup=document.getElementById("tabSignup");
  var authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass");
  var btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup"), btnLogout=document.getElementById("btnLogout");
  var authErr=document.getElementById("authErr"), forgot=document.getElementById("forgot");
  var newPassRow=document.getElementById("newPassRow"), passRow=document.getElementById("passRow"), newPass=document.getElementById("newPass"), btnSaveNew=document.getElementById("btnSaveNew");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }

  tabLogin.addEventListener("click", ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; });
  tabSignup.addEventListener("click", ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; });

  btnLogin.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
    afterLogin();
  });
  btnSignup.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password: pass });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail se necessário.";
  });
  btnLogout.addEventListener("click", async ()=>{ await supa.auth.signOut(); showGate(); });

  forgot.addEventListener("click", async ()=>{
    const email=(authEmail.value||"").trim();
    if(!email){ authErr.textContent="Digite seu e-mail e clique novamente."; return; }
    const { error } = await supa.auth.resetPasswordForEmail(email, { redirectTo: location.origin + location.pathname });
    authErr.textContent = error ? error.message : "Enviamos o link de redefinição para seu e-mail.";
  });
  function checkRecovery(){
    const hash = location.hash||"";
    if(hash.includes("access_token") || (new URLSearchParams(location.search)).get("type")==="recovery"){
      passRow.classList.add("hidden");
      newPassRow.classList.remove("hidden");
      btnLogin.style.display="none"; btnSignup.style.display="none"; btnSaveNew.style.display="inline-block";
      authErr.textContent = "Defina sua nova senha:";
    }
  }
  btnSaveNew.addEventListener("click", async ()=>{
    const np = (newPass.value||"").trim();
    if(!np){ authErr.textContent="Informe a nova senha."; return; }
    const { error } = await supa.auth.updateUser({ password: np });
    authErr.textContent = error ? error.message : "Senha atualizada. Faça login novamente.";
  });

  supa.auth.onAuthStateChange((_e, session)=>{
    if(session){ hideGate(); afterLogin(); } else { showGate(); }
  });

  // Utils
  function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt; }
  function setDelta(el, cur, prev, benchmark=null){
    const pct = prev>0 ? ((cur-prev)/prev*100) : 0;
    const cls = benchmark ? (cur>=benchmark ? "up" : (cur>0.98*benchmark ? "warn" : "down")) : (pct>=0 ? "up" : "down");
    const arrow = pct>=0 ? "▲" : "▼";
    el.className="delta "+cls;
    el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"% "+arrow;
    if(benchmark) el.textContent += ` (Meta: ${benchmark.toFixed(1)}%)`;
  }
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ if(!(d instanceof Date) || isNaN(d)) return null; return d.toISOString().slice(0,10); }
  function parseISO(s){ if(!s) return null; return new Date(s+"T00:00:00Z"); }
  function addDays(d, k){ const t=new Date(d.getTime()); t.setUTCDate(t.getUTCDate()+k); return t; }
  function movingAvg(arr, win){ const out=[]; let acc=0; for(let i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push(acc / Math.min(i+1,win)); } return out; }
  function avg(a,b){ return b>0 ? a/b : 0; }

  var chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null, chartPareto=null;
  var lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total", paretoMode="total";
  function destroyChart(c){ if(c){ try{c.destroy();}catch(e){} } return null; }

  var minISO=null, maxISO=null;
  var diasSet = new Set();

  async function pickSource(){
    TABLE = null;
    let r = await supa.from(SOURCE_PREF).select("dia").limit(1);
    if(!r.error){ TABLE = SOURCE_PREF; }
    else{
      let r2 = await supa.from(SOURCE_FALL).select("dia").limit(1);
      if(!r2.error){ TABLE = SOURCE_FALL; }
    }
    if(!TABLE){ statusTxt.className="status err"; statusTxt.textContent="Sem dados na fonte."; return; }
    const t = await supa.from(TABLE).select("*").limit(1);
    if(!t.error && t.data && t.data[0]){
      const o=t.data[0];
      if(!("Nome da loja" in o) && ("Nome da Loja" in o)) keyLoja="Nome da Loja";
      keyCanal = ("Canal de venda" in o) ? "Canal de venda" : Object.keys(o).find(k=>k.toLowerCase()=="canal de venda") || "Canal de venda";
    }
    statusTxt.className="status ok"; statusTxt.textContent="Fonte: "+TABLE;
  }

  async function fetchPaged(columns, filters){
    let out=[], page=10000, from=0, to=page-1, more=true;
    while(more){
      let q = supa.from(TABLE).select(columns).order("dia",{ascending:true}).range(from,to);
      if(filters && filters.dgte) q = q.gte("dia", filters.dgte);
      if(filters && filters.dlte) q = q.lte("dia", filters.dlte);
      const r = await q; if(r.error) throw r.error;
      const a=r.data||[];
      out = out.concat(a);
      more = a.length===page; from += page; to += page;
    }
    return out;
  }

  async function fetchMinMax(){
    minISO = null; maxISO = null; diasSet = new Set();
    const r1 = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2 = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r1.error || r2.error){ throw (r1.error||r2.error); }
    minISO = r1.data?.[0]?.dia || null;
    maxISO = r2.data?.[0]?.dia || null;
    if(minISO && maxISO){
      const all = await fetchPaged("dia", {});
      (all||[]).forEach(x=>diasSet.add(x.dia));
    }
  }
  function snap(iso){
    if(!iso || diasSet.has(iso)) return iso;
    const d = parseISO(iso); if(!d) return null;
    for(let k=1;k<=30;k++){
      const a = toISO(addDays(d, -k)), b = toISO(addDays(d, k));
      if(diasSet.has(a)) return a;
      if(diasSet.has(b)) return b;
    }
    return null;
  }

  async function buildOptions(){
    try {
      const u = await supa.from(TABLE).select("unidade", { distinct: true }).order("unidade");
      const c = await supa.from(TABLE).select(`"${keyCanal}"`, { distinct: true }).order(keyCanal);
      const p = await supa.from(TABLE).select("pagamento", { distinct: true }).order("pagamento");
      const lj = await supa.from(TABLE).select(`"${keyLoja}", sum(fat) as total_fat`).groupBy(keyLoja).order("total_fat", { ascending: false }).limit(10);

      uni.innerHTML = "<option>Todas</option>" + (u.data||[]).map(r => `<option>${r.unidade}</option>`).join("");
      canal.innerHTML = (c.data||[]).map(r => `<option>${r[keyCanal]}</option>`).join("");
      pag.innerHTML = (p.data||[]).map(r => `<option>${r.pagamento}</option>`).join("");
      lojasBox.innerHTML = (lj.data||[]).map(r => `<span class="chip" data-v="${r[keyLoja]}">${r[keyLoja]}</span>`).join("");
      
      uni.value = "Todas";
      lojasBox.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => { chip.classList.toggle("active"); reload(); fx.open=false; });
      });
    } catch (e) {
      console.error("Erro em buildOptions:", e);
      statusTxt.className="status err"; statusTxt.textContent="Erro ao carregar opções.";
    }
  }

  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    hideGate();
    await pickSource();
    await bootstrap();
  }

  async function bootstrap(){
    try {
      if(!TABLE){ await pickSource(); if(!TABLE) return; }
      await fetchMinMax();
      if(!minISO || !maxISO){ statusTxt.className="status err"; statusTxt.textContent="Sem dados."; return; }
      const end = parseISO(maxISO), start = addDays(end, -29);
      dini.value = toISO(start); dfim.value = toISO(end);
      await buildOptions();

      document.getElementById("limpar").addEventListener("click",(e)=>{
        e.preventDefault();
        const end2 = parseISO(maxISO), start2 = addDays(end2, -29);
        uni.value="Todas"; dini.value=toISO(start2); dfim.value=toISO(end2); pr.value="30";
        turno.value=""; canal.value=""; pag.value=""; canc.value="Todos"; cmvPct.value="30"; fixPct.value="10";
        Array.from(lojasBox.children).forEach(c=>c.classList.remove("active"));
        reload(); fx.open=false;
      });
      [uni,dini,dfim,pr,turno,canal,pag,canc,cmvPct,fixPct].forEach(el=>{
        el.addEventListener("change", () => {
          if (el.id === "dini" && dfim.value && dini.value > dfim.value) {
            statusTxt.className="status err"; statusTxt.textContent="Data inicial não pode ser após final.";
            return;
          }
          applyQuickDate(); reload(); fx.open=false;
        });
      });
      document.querySelectorAll(".pill").forEach(p=>{
        p.addEventListener("click", ev=>{
          const btn=ev.target.closest("button"); if(!btn) return;
          p.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          const target=p.getAttribute("data-target"), val=btn.getAttribute("data-val");
          if(target==="lineMode") lineMode=val;
          if(target==="dowMode") dowMode=val;
          if(target==="dowPedMode") dowPedMode=val;
          if(target==="hourMode") hourMode=val;
          if(target==="monMode") monMode=val;
          if(target==="topMode") topMode=val;
          if(target==="paretoMode") paretoMode=val;
          reload();
        });
      });
      btnImport.addEventListener("click", importCSV);

      await reload();
    } catch(e) {
      statusTxt.className="status err"; statusTxt.textContent="Erro ao iniciar: "+e.message;
    }
  }

  function applyQuickDate(){
    if(!maxISO) return;
    const days = Number(pr.value||0); if(!days) return;
    const end = parseISO(maxISO); const start = addDays(end, -(days-1));
    dini.value = toISO(start); dfim.value = toISO(end);
  }

  function getSelected(el){ return Array.from(el.selectedOptions||[]).map(o=>o.value).filter(v=>v); }

  async function reload(){
    try {
      if(!TABLE){ await pickSource(); if(!TABLE) return; }
      let sISO = snap(dini.value||minISO)||minISO, eISO = snap(dfim.value||maxISO)||maxISO;
      periodoTxt.textContent = "Período: "+(sISO||"—")+" → "+(eISO||"—");

      const rows = await fetchPaged("*", { dgte:sISO, dlte:eISO });
      if(rows[0]){
        if(!("Nome da loja" in rows[0]) && ("Nome da Loja" in rows[0])) keyLoja="Nome da Loja";
        if(!("Canal de venda" in rows[0])) keyCanal = Object.keys(rows[0]).find(k=>k.toLowerCase()=="canal de venda") || keyCanal;
      }

      const lojasSel = Array.from(lojasBox.children).filter(c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      const turnosSel = getSelected(turno);
      const canaisSel = getSelected(canal);
      const pagsSel = getSelected(pag);
      const cancSel = canc.value||"Todos";
      const uniSel = uni.value||"Todas";
      const cmv = Number(cmvPct.value||30)/100;
      const fix = Number(fixPct.value||10)/100;

      const cur = rows.filter(r=>{
        if(uniSel!=="Todas" && r.unidade!==uniSel) return false;
        if(lojasSel.length && !lojasSel.includes(r[keyLoja])) return false;
        if(turnosSel.length && (!r.turno || !turnosSel.includes(r.turno))) return false;
        if(canaisSel.length && (!r[keyCanal] || !canaisSel.includes(r[keyCanal]))) return false;
        if(pagsSel.length && (!r.pagamento || !pagsSel.includes(r.pagamento))) return false;
        if(cancSel==="Sim" && (r.cancelado||"Não")!=="Sim") return false;
        if(cancSel==="Não" && (r.cancelado||"Não")==="Sim") return false;
        return true;
      });

      const sD = parseISO(sISO), eD = parseISO(eISO);
      const daysLen = Math.max(1, Math.round((eD - sD)/(24*3600*1000))+1);
      const prevEnd = addDays(sD,-1), prevStart = addDays(prevEnd, -(daysLen-1));
      const antRows = await fetchPaged("*", { dgte: toISO(prevStart), dlte: toISO(prevEnd) });
      const ant = antRows.filter(r=>{
        if(uniSel!=="Todas" && r.unidade!==uniSel) return false;
        if(lojasSel.length && !lojasSel.includes(r[keyLoja])) return false;
        if(turnosSel.length && (!r.turno || !turnosSel.includes(r.turno))) return false;
        if(canaisSel.length && (!r[keyCanal] || !canaisSel.includes(r[keyCanal]))) return false;
        if(pagsSel.length && (!r.pagamento || !pagsSel.includes(r.pagamento))) return false;
        if(cancSel==="Sim" && (r.cancelado||"Não")!=="Sim") return false;
        if(cancSel==="Não" && (r.cancelado||"Não")==="Sim") return false;
        return true;
      });

      renderKPIs(cur, ant, cmv, fix);
      renderCharts(cur, ant);
    } catch(e) {
      statusTxt.className="status err"; statusTxt.textContent="Falha ao carregar: "+e.message;
    }
  }

  function renderKPIs(cur, ant, cmv, fix) {
    const sum = (arr,k)=>arr.reduce((s,r)=>s+Number(r[k]||0),0);
    const ped = sum(cur,"pedidos"), fat=sum(cur,"fat"), des=sum(cur,"des"), fre=sum(cur,"fre");
    const pedA=sum(ant,"pedidos"), fatA= sum(ant,"fat"), desA=sum(ant,"des"), freA=sum(ant,"fre");
    const dias = new Set(cur.map(r=>r.dia)).size || 1, diasA= new Set(ant.map(r=>r.dia)).size || 1;

    const tkm = ped>0 ? fat/ped : 0, tkmA = pedA>0 ? fatA/pedA : 0;
    const tkmByCanal = Array.from(new Set(cur.map(r=>r[keyCanal]))).map(c => ({
      canal: c, tkm: avg(sum(cur.filter(r=>r[keyCanal]===c),"fat"), sum(cur.filter(r=>r[keyCanal]===c),"pedidos"))
    }));
    const fmd = fat/dias, fmdA = fatA/diasA;
    const fatL = fat - des - fre - (0.12*fat), fatLA= fatA - desA - freA - (0.12*fatA);
    const fatLP= fat>0 ? (fatL/fat*100) : 0, fatLPA = fatA>0 ? (fatLA/fatA*100) : 0;
    const marg = fat>0 ? ((fatL - cmv*fat)/fat*100) : 0, margA = fatA>0 ? ((fatLA - cmv*fatA)/fatA*100) : 0;
    const roi = des>0 ? ((fat - fatA) / des * 100) : 0, roiA = desA>0 ? ((fatA - fatA) / desA * 100) : 0;
    const cpp = ped>0 ? (fre + des + fix*fat)/ped : 0, cppA = pedA>0 ? (freA + desA + fix*fatA)/pedA : 0;
    const lojasCur = new Map(), lojasAnt = new Map();
    cur.forEach(r => lojasCur.set(r[keyLoja], (lojasCur.get(r[keyLoja])||0)+Number(r.fat||0)));
    ant.forEach(r => lojasAnt.set(r[keyLoja], (lojasAnt.get(r[keyLoja])||0)+Number(r.fat||0)));
    const churn = Array.from(lojasCur.keys()).filter(l => {
      const curFat = lojasCur.get(l)||0, antFat = lojasAnt.get(l)||0;
      return antFat>0 && (curFat - antFat)/antFat <= -0.1;
    }).length / (lojasCur.size||1) * 100;
    const churnA = 0; // Assumindo churn anterior como 0 para delta, ajustar se necessário

    setText("k_ped", fmtInt(ped)); setText("k_tkm", fmtBRL(tkm));
    setText("k_fat", fmtBRL(fat)); setText("k_fmd", fmtBRL(fmd));
    setText("k_fatl", fmtBRL(fatL)); setText("k_fatlp", fatLP.toFixed(1)+"%");
    setText("k_marg", marg.toFixed(1)+"%"); setText("k_roi", roi.toFixed(1)+"%");
    setText("k_cpp", fmtBRL(cpp)); setText("k_churn", churn.toFixed(1)+"%");

    setDelta(document.getElementById("d_ped"), ped, pedA);
    setDelta(document.getElementById("d_tkm"), tkm, tkmA);
    setDelta(document.getElementById("d_fat"), fat, fatA);
    setDelta(document.getElementById("d_fmd"), fmd, fmdA);
    setDelta(document.getElementById("d_fatl"), fatL, fatLA);
    setDelta(document.getElementById("d_fatlp"), fatLP, fatLPA, 60);
    setDelta(document.getElementById("d_marg"), marg, margA, 30);
    setDelta(document.getElementById("d_roi"), roi, roiA, 200);
    setDelta(document.getElementById("d_cpp"), cpp, cppA);
    setDelta(document.getElementById("d_churn"), churn, churnA, 5);

    // Sparklines (últimos 7 dias)
    const sparkData = cur.reduce((acc, r) => {
      const d = r.dia; if (!acc[d]) acc[d] = {fat:0, ped:0, des:0, fre:0};
      acc[d].fat += Number(r.fat||0); acc[d].ped += Number(r.pedidos||0);
      acc[d].des += Number(r.des||0); acc[d].fre += Number(r.fre||0);
      return acc;
    }, {});
    const days = Object.keys(sparkData).sort().slice(-7);
    const drawSpark = (id, vals) => {
      new Chart(document.getElementById(id).getContext("2d"), {
        type: "line", data: { labels: days, datasets: [{ data: vals, borderWidth: 1, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
      });
    };
    drawSpark("s_ped", days.map(d => sparkData[d]?.ped || 0));
    drawSpark("s_tkm", days.map(d => sparkData[d]?.ped > 0 ? sparkData[d].fat / sparkData[d].ped : 0));
    drawSpark("s_fat", days.map(d => sparkData[d]?.fat || 0));
    drawSpark("s_fmd", days.map(d => sparkData[d]?.fat || 0));
    drawSpark("s_fatl", days.map(d => {
      const f = sparkData[d]?.fat || 0;
      return f - sparkData[d]?.des - sparkData[d]?.fre - 0.12*f;
    }));
    drawSpark("s_fatlp", days.map(d => {
      const f = sparkData[d]?.fat || 0;
      return f > 0 ? (f - sparkData[d]?.des - sparkData[d]?.fre - 0.12*f)/f*100 : 0;
    }));
    drawSpark("s_marg", days.map(d => {
      const f = sparkData[d]?.fat || 0;
      return f > 0 ? ((f - sparkData[d]?.des - sparkData[d]?.fre - 0.12*f - cmv*f)/f*100) : 0;
    }));
    drawSpark("s_roi", days.map(d => {
      const f = sparkData[d]?.fat || 0, ddes = sparkData[d]?.des || 1;
      return (f - fatA) / ddes * 100;
    }));
    drawSpark("s_cpp", days.map(d => {
      const p = sparkData[d]?.ped || 0, f = sparkData[d]?.fat || 0;
      return p > 0 ? (sparkData[d]?.fre + sparkData[d]?.des + fix*f)/p : 0;
    }));
    drawSpark("s_churn", days.map(d => {
      const lojasD = new Map();
      cur.filter(r=>r.dia===d).forEach(r => lojasD.set(r[keyLoja], (lojasD.get(r[keyLoja])||0)+Number(r.fat||0)));
      return Array.from(lojasD.keys()).filter(l => {
        const curFat = lojasD.get(l)||0, antFat = lojasAnt.get(l)||0;
        return antFat>0 && (curFat-antFat)/antFat <= -0.1;
      }).length / (lojasD.size||1) * 100;
    }));

    // Modal para Breakdown (exemplo para ticket médio, expandir para outros KPIs)
    document.getElementById("k_tkm").parentElement.addEventListener("click", () => {
      const modal = document.getElementById("kpiModal");
      document.getElementById("modalTitle").textContent = "Breakdown: Ticket Médio por Canal";
      document.getElementById("modalContent").innerHTML = tkmByCanal.map(c => `<p>${c.canal}: ${fmtBRL(c.tkm)}</p>`).join("");
      modal.classList.add("active");
    });
  }

  function groupBy(arr, keyFn, valFn){
    const m=new Map(); arr.forEach(r=>{ const k=keyFn(r); m.set(k, (m.get(k)||0)+valFn(r)); });
    const labels=Array.from(m.keys()).sort(); const values=labels.map(k=>m.get(k)); return {labels, values};
  }

  function linearForecast(data, days) {
    const n = data.length;
    if (n < 2) return Array(days).fill(data[0] || 0);
    const x = Array(n).fill().map((_,i)=>i), y = data;
    const xMean = x.reduce((a,b)=>a+b)/n, yMean = y.reduce((a,b)=>a+b)/n;
    const slope = x.reduce((sum, xi, i) => sum + (xi-xMean)*(y[i]-yMean), 0) / x.reduce((sum, xi) => sum + (xi-xMean)**2, 0);
    const intercept = yMean - slope*xMean;
    return Array(days).fill().map((_,i)=>intercept + slope*(n+i));
  }

  function drawStackedArea(canvasId, labels, datasets) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: { labels, datasets: datasets.map(d => ({ label: d.label, data: d.data, fill: true, tension: 0.2, borderDash: d.borderDash || [] })) },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: { legend: { position: "top" }, tooltip: { mode: "index", intersect: false } },
        scales: { y: { stacked: true, beginAtZero: true } }
      }
    });
  }

  function drawBar(canvasId, labels, totals, counts, mode, horizontal){
    const showMed = (mode==="media");
    const vals = showMed ? totals.map((v,i)=> avg(v, counts[i]||1)) : totals.slice();
    const ctx=document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type:"bar",
      data:{ labels:labels, datasets:[{ data:vals }] },
      options:{ indexAxis: horizontal?'y':'x', responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function drawWaterfall(canvasId, labels, gains, losses) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Ganhos", data: gains, backgroundColor: "rgba(22,163,74,0.5)" },
          { label: "Perdas", data: losses.map(v=>-v), backgroundColor: "rgba(220,38,38,0.5)" }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: { legend: { position: "top" } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function drawTreemap(canvasId, labels, values) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "treemap",
      data: {
        datasets: [{
          tree: values.map((v,i)=>({value:v, label:labels[i]})),
          key: "value",
          labels: { display: true, formatter: ctx => ctx.raw.label }
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: { legend: { display: false } }
      }
    });
  }

  function drawPareto(canvasId, labels, values) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    const sorted = values.map((v,i)=>({v, l:labels[i]})).sort((a,b)=>b.v-a.v);
    const total = sorted.reduce((s,o)=>s+o.v,0);
    const cum = sorted.reduce((acc,o,i)=> {
      acc.push((acc[i-1] || 0) + o.v / total * 100);
      return acc;
    }, []);
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: sorted.map(o=>o.l),
        datasets: [
          { label: "Faturamento", data: sorted.map(o=>o.v), yAxisID: "y" },
          { label: "% Cumulativo", type: "line", data: cum, yAxisID: "y2" }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: { legend: { position: "top" } },
        scales: { y: { beginAtZero: true }, y2: { position: "right", max: 100, beginAtZero: true } }
      }
    });
  }

  function renderCharts(cur, ant){
    // Receita Diária (Stacked por Canal + Forecast)
    const byDay = groupBy(cur, r=>r.dia, r=>Number(r.fat||0));
    const byDayPrev = groupBy(ant, r=>r.dia, r=>Number(r.fat||0));
    const byCanal = Array.from(new Set(cur.map(r=>r[keyCanal]))).map(c => ({
      label: c || "Outros", data: byDay.labels.map(d => sum(cur.filter(r=>r.dia===d && r[keyCanal]===c),"fat"))
    }));
    const forecast = linearForecast(byDay.values.slice(-30), 7);
    const forecastLabels = byDay.labels.slice(-1).map((_,i)=>toISO(addDays(parseISO(byDay.labels[byDay.labels.length-1]),i+1)));
    const datasets = [...byCanal, { label: "Forecast", data: [...Array(byDay.labels.length-7).fill(null), ...forecast], borderDash: [5,5] }];
    chartLine = destroyChart(chartLine);
    chartLine = drawStackedArea("cLine", [...byDay.labels, ...forecastLabels], datasets);

    // Receita por Dia da Semana
    const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    const m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
    const diasU=new Set(cur.map(r=>r.dia)); Array.from(diasU).forEach(d=>{ cnt[parseISO(d).getUTCDay()]++; });
    cur.forEach(r=>{ const d=parseISO(r.dia).getUTCDay(); m[d]+=Number(r.fat||0); });
    chartDowFat = destroyChart(chartDowFat); chartDowFat = drawBar("cDowFat", lbl, m, cnt, dowMode, false);

    // Pedidos por Dia da Semana (mantido)
    const mPed=[0,0,0,0,0,0,0];
    cur.forEach(r=>{ const d=parseISO(r.dia).getUTCDay(); mPed[d]+=Number(r.pedidos||0); });
    chartDowPed = destroyChart(chartDowPed); chartDowPed = drawBar("cDowPed", lbl, mPed, cnt, dowPedMode, false);

    // Receita por Hora
    const mHour=Array(24).fill(0), daysByHour=Array(24).fill(0).map(()=>new Set());
    cur.forEach(r=>{ const h=Number(r.hora); if(isNaN(h)||h<0||h>23) return; mHour[h]+=Number(r.fat||0); daysByHour[h].add(r.dia); });
    const totDays=new Set(cur.map(r=>r.dia)).size||1; const labelsH=[], totalsH=[], countsH=[];
    for(let h=0;h<24;h++){ const active=daysByHour[h].size; if(active>=Math.ceil(totDays*0.5) && mHour[h]>0){
      labelsH.push(String(h).padStart(2,"0")+":00"); totalsH.push(mHour[h]); countsH.push(active); } }
    chartHour = destroyChart(chartHour); chartHour = drawBar("cHour", labelsH, totalsH, countsH, hourMode, false);

    // Receita por Mês (Waterfall)
    const mMonth=new Map(), cntMonth=new Map(), daysPerMonth=new Map();
    cur.forEach(r=>{ const ym=(r.dia||"").slice(0,7); mMonth.set(ym,(mMonth.get(ym)||0)+Number(r.fat||0)); 
      if(!daysPerMonth.has(ym)) daysPerMonth.set(ym,new Set()); daysPerMonth.get(ym).add(r.dia); });
    Array.from(daysPerMonth.keys()).forEach(ym=> cntMonth.set(ym, daysPerMonth.get(ym).size));
    const labelsM=Array.from(mMonth.keys()).sort(), totalsM=labelsM.map(x=>mMonth.get(x)), lossesM=labelsM.map(x=>
      sum(cur.filter(r=>r.dia.startsWith(x)),"des") + sum(cur.filter(r=>r.dia.startsWith(x)),"fre") + 0.12*totalsM[labelsM.indexOf(x)]);
    chartMonth = destroyChart(chartMonth); chartMonth = drawWaterfall("cMonth", labelsM, totalsM, lossesM);

    // Top 10 Lojas (Treemap)
    const byL=new Map();
    cur.forEach(r=>{ const n=r[keyLoja]; if(!n) return; byL.set(n,(byL.get(n)||0)+Number(r.fat||0)); });
    const top = Array.from(byL.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labelsT=top.map(x=>x[0]), totalsT=top.map(x=>x[1]);
    chartTop = destroyChart(chartTop); chartTop = drawTreemap("cTop", labelsT, totalsT);

    // Pareto de Canais
    const byC = groupBy(cur, r=>r[keyCanal] || "Outros", r=>Number(r.fat||0));
    chartPareto = destroyChart(chartPareto); chartPareto = drawPareto("cPareto", byC.labels, byC.values);
  }

  // Import CSV (mantido com melhorias de robustez)
  function stripBOM(s){ return s.replace(/^\uFEFF/, ""); }
  function normKey(s){
    return stripBOM(String(s||""))
      .replace(/[^\S\r\n]+/g," ")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\w\s\/\-\.\u00C0-\u024F]/g,"")
      .toLowerCase().trim();
  }
  function toNumber(v){
    if(v===null||v===undefined||v==="") return 0;
    if(typeof v==="number") return v;
    const s=String(v).replace(/\./g,"").replace(",",".");
    const n=Number(s); return isNaN(n)?0:n;
  }
  function toDateISO(v){
    if(!v) return null;
    const s=String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    let m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return m[3]+"-"+m[2]+"-"+m[1];
    m=s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
    if(m) return m[3]+"-"+m[2]+"-"+m[1];
    return null;
  }
  function pick(map, ...cands){ for(const c of cands){ const k=map[normKey(c)]; if(k) return k; } return null; }
  function guessDateKey(rows){
    const keys = Object.keys(rows[0]||{});
    let best=null, bestScore=0;
    for(const k of keys){
      let ok=0, tot=0;
      for(let i=0;i<Math.min(rows.length,80);i++){
        const iso=toDateISO(rows[i][k]);
        if(iso) ok++; tot++;
      }
      const score = ok/(tot||1);
      if(score>bestScore && score>=0.6){ best=k; bestScore=score; }
    }
    return best;
  }
  function guessFatKey(rows){
    const keys = Object.keys(rows[0]||{});
    const namePref = keys.find(k=>/fat|fatur|total|valor/i.test(k));
    if(namePref) return namePref;
    let best=null, bestSum=0;
    for(const k of keys){
      let sum=0, numOk=0;
      for(let i=0;i<Math.min(rows.length,200);i++){
        const v=toNumber(rows[i][k]); if(!isNaN(v)){ sum+=v; numOk++; }
      }
      if(numOk>=rows.length*0.6 && sum>bestSum){ best=k; bestSum=sum; }
    }
    return best;
  }
  function guessUnidadeKey(rows){
    const keys = Object.keys(rows[0]||{});
    const cand = keys.find(k=>/unid|filial|loja/i.test(k) && !/nome/i.test(k));
    if(cand) return cand;
    return keys.find(k=>/loja/i.test(k)) || null;
  }

  async function importCSV(){
    const f = csvfile.files?.[0];
    if(!f){ impMsg.textContent="Selecione o arquivo CSV."; return; }
    prog.style.display="inline-block"; prog.value=0; impMsg.textContent="Lendo…";

    Papa.parse(f, {
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        try{
          const rows=res.data||[]; if(!rows.length){ impMsg.textContent="Arquivo vazio."; prog.style.display="none"; return; }
          const sample = rows[0]||{};
          const map = {}; Object.keys(sample).forEach(k=> map[normKey(k)] = k);

          let K = {
            dia: pick(map,"dia","data","data do pedido","dt","data venda","data_venda"),
            unidade: pick(map,"unidade","filial","loja unidade","cod filial"),
            pedidos: pick(map,"pedidos","qtd","qtde","quantidade"),
            fat: pick(map,"fat","faturamento","total","valor total","vl total","total pedido","vr total","valor"),
            des: pick(map,"des","desconto","desc.","vl desconto","valor desconto"),
            fre: pick(map,"fre","frete","entrega","delivery","valor entrega","vl entrega"),
            loja: pick(map,"nome da loja","nome da Loja","loja","nome_loja","fantasia","nome loja"),
            turno: pick(map,"turno","periodo","shift"),
            canal: pick(map,"canal de venda","canal","origem"),
            pagamento: pick(map,"pagamento","forma de pagamento","meio de pagamento","forma","meio"),
            cancelado: pick(map,"cancelado","pedido cancelado","esta cancelado","está cancelado","cancel."),
            hora: pick(map,"hora","hora do pedido","hr","hour")
          };

          if(!K.dia) K.dia = guessDateKey(rows);
          if(!K.fat) K.fat = guessFatKey(rows);
          if(!K.unidade) K.unidade = guessUnidadeKey(rows);

          if(!K.dia || !K.unidade || !K.fat){
            impMsg.textContent="Nada para importar (colunas obrigatórias não reconhecidas: dia/unidade/fat).";
            prog.style.display="none";
            return;
          }

          const acc = new Map();
          let minFileISO=null, maxFileISO=null;
          rows.forEach(r=>{
            const dia = toDateISO(r[K.dia]); if(!dia) return;
            if(!minFileISO || dia<minFileISO) minFileISO=dia;
            if(!maxFileISO || dia>maxFileISO) maxFileISO=dia;

            const unidade = (r[K.unidade]||"").toString().trim(); if(!unidade) return;
            const loja = K.loja ? (r[K.loja]||"").toString().trim() : "";
            let hora = -1; if(K.hora){ const raw=String(r[K.hora]).replace(/\D/g,""); if(raw!=="") hora=Number(raw); }
            const canalV = K.canal ? (r[K.canal]||"").toString().trim() : "";
            const pagamentoV = K.pagamento ? (r[K.pagamento]||"").toString().trim() : "";
            let canceladoV = K.cancelado ? (String(r[K.cancelado]||"").trim()) : "";
            if(canceladoV){ const s=canceladoV.toLowerCase(); canceladoV = s.startsWith("s")||s==="1" ? "Sim" : "Não"; }

            const pedidos = K.pedidos ? toNumber(r[K.pedidos]) : 0;
            const fat = toNumber(r[K.fat]);
            const des = K.des? toNumber(r[K.des]) : 0;
            const fre = K.fre? toNumber(r[K.fre]) : 0;

            const key = [dia,unidade,loja,hora,pagamentoV,canalV].join("|");
            if(!acc.has(key)){
              acc.set(key, { dia, unidade, pedidos:0, fat:0, des:0, fre:0,
                [keyLoja]:loja, turno:(K.turno? (r[K.turno]||"").toString().trim():""),
                [keyCanal]:canalV, pagamento:pagamentoV, cancelado:canceladoV||"Não", hora:(isNaN(hora)?-1:hora)
              });
            }
            const o=acc.get(key); o.pedidos+=pedidos; o.fat+=fat; o.des+=des; o.fre+=fre;
            if((o.cancelado||"")!=="Sim" && canceladoV==="Sim") o.cancelado="Sim";
          });

          const data = Array.from(acc.values());
          if(!data.length){ impMsg.textContent="Nada para importar (dados inválidos)."; prog.style.display="none"; return; }

          const chunk=800; let done=0; let upsertOk=true; let errMsg="";
          for(let i=0;i<data.length;i+=chunk){
            const slice=data.slice(i,i+chunk);
            const up = await supa.from(SOURCE_PREF).upsert(slice, {
              onConflict: 'dia,unidade,"'+keyLoja+'",hora,pagamento,"'+keyCanal+'"',
              ignoreDuplicates: false
            });
            if(up.error){ upsertOk=false; errMsg = up.error.message; break; }
            done+=slice.length; prog.value=Math.round(done/data.length*100);
          }

          if(!upsertOk){
            if(!minFileISO || !maxFileISO){ impMsg.textContent="Erro: range de datas não detectado."; prog.style.display="none"; return; }
            await supa.from(SOURCE_PREF).delete().gte("dia", minFileISO).lte("dia", maxFileISO);
            done=0; for(let i=0;i<data.length;i+=chunk){
              const slice=data.slice(i,i+chunk);
              const ins = await supa.from(SOURCE_PREF).insert(slice);
              if(ins.error){ impMsg.textContent="Erro ao inserir: "+ins.error.message; prog.style.display="none"; return; }
              done+=slice.length; prog.value=Math.round(done/data.length*100);
            }
          }

          impMsg.textContent="Importado com sucesso.";
          prog.style.display="none";
          await pickSource(); await fetchMinMax(); await buildOptions(); await reload();
          fx.open=false;
        } catch(err){
          impMsg.textContent="Erro: "+(err.message||err);
          prog.style.display="none";
        }
      },
      error: (err)=>{ impMsg.textContent="CSV inválido: "+(err.message||err); prog.style.display="none"; }
    });
  }

  (async function init(){
    checkRecovery();
    const { data:{ session } } = await supa.auth.getSession();
    if(session){ hideGate(); await pickSource(); await bootstrap(); }
    else { showGate(); }
  })();
})();
</script>
</body>
</html>
```
