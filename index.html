<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DASHBOARD — CFO (v2.20.0 — KPI⇢gráficos)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%232f6ef7"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
:root{
  --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#2f6ef7;
  --chip:#f7e9ed; --wine:#7b1e3a; --wine-soft:#9c3554; --ok:#10b981;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:28px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn.clear{gap:6px}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;transition:all .2s ease}
.sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
.sec-title{display:flex;align-items:center;gap:10px;font-weight:700}
.ico{width:16px;height:16px;color:#475569}
.muted{color:var(--muted)}
.row{display:grid;gap:12px}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-2{grid-template-columns:repeat(2,1fr)}
/* inputs */
input[type="date"], .msel-btn{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:44px;font-size:16px}
input[type="date"]::-webkit-calendar-picker-indicator{transform:scale(1.2)}
/* chips */
.chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
.chip{padding:10px 0;border:1px solid #efd5db;border-radius:10px;background:var(--chip);cursor:pointer;text-align:center;font-weight:800;color:#7b1e3a}
.chip.active{background:var(--wine);border-color:var(--wine);color:#fff}
/* multiselect */
.msel{position:relative}.msel-btn{text-align:left;cursor:pointer}.msel-btn:after{content:"▾";float:right;color:#475569}
.msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
.msel.open .msel-panel{display:block}
.msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
.msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
.msel-opt:hover{background:#f3f4f6}
/* KPIs */
.krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
.kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
.kpi h4 .spacer{flex:1}
.kpi .val{font-size:22px;font-weight:800}
.kpi .accent{border-top:2px solid var(--wine);height:0;margin:6px 0} /* espessura fixa */
.kpi .sub{font-size:12px;color:#667085;margin-top:2px}
.kpi[role="button"]{cursor:pointer}
.kpi.active{box-shadow:0 0 0 3px rgba(123,30,58,.15)}
/* delta chip */
.delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:12px;margin-left:12px;background:#f1f5f9;color:#64748b}
.delta.up{background:rgba(123,30,58,.1);border-color:rgba(123,30,58,.25);color:var(--wine)}
.delta.down{background:rgba(148,163,184,.15);border-color:rgba(148,163,184,.35)}
/* charts */
.chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
.chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
.seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:800}
.seg button.active{background:var(--wine);color:#fff}
.chart-box{height:280px;position:relative}
.chart-box canvas{display:block;width:100% !important;height:100% !important;}
.chart-card.wide{grid-column:span 2}.chart-card.wide .chart-box{height:360px}
/* donut center clickable */
.center-link{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.92);border:1px solid var(--line);padding:4px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;color:#334155;white-space:nowrap}
/* auto-collapse */
.section.collapsed .row, .section.collapsed #periodoInfo{display:none}
.section.collapsed .sec-head{cursor:pointer}
.diag{font-size:12px;color:#475569;margin-left:8px}
.upload-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.upload-info{margin-top:8px;font-size:12px;color:#475569}
@media (max-width:1024px){.cols-3{grid-template-columns:repeat(2,1fr)}.cols-2{grid-template-columns:1fr}.krow{grid-template-columns:repeat(2,1fr)}.chart-card.wide{grid-column:span 1}}
@media (max-width:640px){.cols-3,.krow{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>DASHBOARD</h1>
    <div class="upload-bar">
      <button id="btnUpload" class="btn">📤 Carregar Excel</button>
      <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
    </div>
  </div>

  <!-- Filtros de Data -->
  <div id="secDatas" class="section">
    <div class="sec-head">
      <div class="sec-title"><svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>Filtros de Data</div>
      <button id="btnClear" class="btn clear">✖ Limpar filtros</button>
    </div>
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px;">Intervalo (início)</div><input type="date" id="fDe"></div>
      <div><div class="muted" style="margin-bottom:6px;">Intervalo (fim)</div><input type="date" id="fAte"></div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Período rápido</div>
        <div class="chips">
          <button class="chip" data-q="7">07</button><button class="chip" data-q="15">15</button>
          <button class="chip active" data-q="30">30</button><button class="chip" data-q="60">60</button>
          <button class="chip" data-q="90">90</button><button class="chip" data-q="120">120</button>
        </div>
        <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">—</div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div id="secFiltros" class="section">
    <div class="sec-head">
      <div class="sec-title"><svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>Filtros</div>
      <div><span id="status" class="muted">—</span><span id="diag" class="diag"></span><div id="uploadInfo" class="upload-info"></div></div>
    </div>
    <div class="row cols-3">
      <div><div class="muted" style="margin-bottom:6px;">Unidade</div><div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Nome da Loja</div><div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Turno da Venda</div><div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div></div>
    </div>
    <div class="row cols-3" style="margin-top:10px;">
      <div><div class="muted" style="margin-bottom:6px;">Canal de Venda</div><div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div></div>
      <div><div class="muted" style="margin-bottom:6px;">Tipo de Pagamento</div><div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div></div>
      <div>
        <div class="muted" style="margin-bottom:6px;">Cancelado</div>
        <div id="ms-cancel" class="msel">
          <button class="msel-btn">Não</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="Não" checked><label>Não</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="krow">
    <div class="kpi" role="button" data-k="ped"><h4><span>Pedidos</span><span class="spacer"></span><span id="d_ped" class="delta">—</span></h4><div class="val" id="k_ped">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_ped">—</span></div></div>
    <div class="kpi" role="button" data-k="tkt"><h4><span>Ticket Médio</span><span class="spacer"></span><span id="d_tkt" class="delta">—</span></h4><div class="val" id="k_tkt">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_tkt">—</span></div></div>
    <div class="kpi" role="button" data-k="fat"><h4><span>Faturamento</span><span class="spacer"></span><span id="d_fat" class="delta">—</span></h4><div class="val" id="k_fat">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fat">—</span></div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi" role="button" data-k="fatmed"><h4><span>Faturamento Médio</span><span class="spacer"></span><span id="d_fatmed" class="delta">—</span></h4><div class="val" id="k_fatmed">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fatmed">—</span></div></div>
    <div class="kpi" role="button" data-k="des"><h4><span>Incentivos</span><span class="spacer"></span><span id="d_des" class="delta">—</span></h4><div class="val" id="k_des">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_des">—</span></div></div>
    <div class="kpi" role="button" data-k="desperc"><h4><span>% de Incentivos</span><span class="spacer"></span><span id="d_desperc" class="delta">—</span></h4><div class="val" id="k_desperc">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_desperc">—</span></div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi" role="button" data-k="fre"><h4><span>Frete</span><span class="spacer"></span><span id="d_fre" class="delta">—</span></h4><div class="val" id="k_fre">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fre">—</span></div></div>
    <div class="kpi" role="button" data-k="fremed"><h4><span>Frete Médio</span><span class="spacer"></span><span id="d_fremed" class="delta">—</span></h4><div class="val" id="k_fremed">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_fremed">—</span></div></div>
    <div class="kpi" role="button" data-k="canc_ped"><h4><span>Pedidos Cancelados</span><span class="spacer"></span><span id="d_canc_ped" class="delta">—</span></h4><div class="val" id="k_canc_ped">—</div><div class="accent"></div><div class="sub">Participação: <span id="k_canc_part">—</span> (Anterior: <span id="p_canc_part">—</span>)</div></div>
  </div>
  <div class="krow" style="margin-top:12px;">
    <div class="kpi" role="button" data-k="canc_val"><h4><span>Valor de Cancelados</span><span class="spacer"></span><span id="d_canc_val" class="delta">—</span></h4><div class="val" id="k_canc_val">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_canc_val">—</span></div></div>
    <div class="kpi" role="button" data-k="roi"><h4><span>ROI</span><span class="spacer"></span><span id="d_roi" class="delta">—</span></h4><div class="val" id="k_roi">—</div><div class="accent"></div><div class="sub">Anterior: <span id="p_roi">—</span></div></div>
    <div></div>
  </div>

  <!-- GRÁFICOS -->
  <div class="section">
    <div class="sec-head">
      <div class="sec-title">Gráficos</div>
      <div id="segGlobal" class="seg"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">Média</button></div>
    </div>
    <div class="row cols-2">
      <div class="chart-card wide"><div class="chart-head"><div class="muted">Vendas por mês — últimos 12M vs. 12M anteriores</div></div><div class="chart-box"><canvas id="ch_month"></canvas></div></div>
      <div class="chart-card"><div class="chart-head"><div class="muted">Vendas por dia da semana</div></div><div class="chart-box"><canvas id="ch_dow"></canvas></div></div>
      <div class="chart-card"><div class="chart-head"><div class="muted">Vendas por hora</div></div><div class="chart-box"><canvas id="ch_hour"></canvas></div></div>
      <div class="chart-card"><div class="chart-head"><div class="muted">Vendas por turno</div></div><div class="chart-box"><canvas id="ch_turno"></canvas></div></div>
      <div class="chart-card">
        <div class="chart-head"><div class="muted">Participação por loja — Top 6</div></div>
        <div class="chart-box">
          <canvas id="ch_top6"></canvas>
          <button id="top6Center" class="center-link">Total: R$ 0,00</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

<script>
/* ========= CONFIG ========= */
const READ_VIEW='vendas_canon';
const DEST_INSERT_TABLE='vendas_xlsx';
const REFRESH_RPC='refresh_sales_materialized';
const SUPABASE_URL='https://msmyfxgrnuusnvoqyeuo.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U';
const supa=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);

/* ========= Chart.js theme ========= */
Chart.defaults.font.family='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu';
Chart.defaults.color='#334155';
Chart.defaults.plugins.legend.position='top';
Chart.defaults.plugins.tooltip.backgroundColor='rgba(15,23,42,.95)';
Chart.defaults.plugins.tooltip.titleColor='#e2e8f0';
Chart.defaults.plugins.tooltip.bodyColor='#e2e8f0';
Chart.defaults.plugins.tooltip.borderColor='rgba(148,163,184,.25)';
Chart.defaults.plugins.tooltip.borderWidth=1;
Chart.defaults.datasets.bar.borderRadius=6;
Chart.defaults.datasets.bar.borderSkipped=false;
Chart.defaults.datasets.bar.maxBarThickness=42;
function gradNow(ctx){const g=ctx.createLinearGradient(0,0,0,240);g.addColorStop(0,'rgba(123,30,58,0.95)');g.addColorStop(1,'rgba(156,53,84,0.55)');return g;}
function gradPrev(ctx){const g=ctx.createLinearGradient(0,0,0,240);g.addColorStop(0,'rgba(148,163,184,0.85)');g.addColorStop(1,'rgba(203,213,225,0.45)');return g;}

/* ========= Helpers ========= */
const $=id=>document.getElementById(id);
const setStatus=(t,k)=>{const el=$('status');el.textContent=t;el.style.color=(k==='err'?'#ef4444':k==='ok'?'#10b981':'#667085');};
const setDiag=msg=>{$('diag').textContent=msg||'';};
const info=msg=>{$('uploadInfo').textContent=msg||'';};
const money=v=>(v==null||!isFinite(+v))?'R$ 0,00':'R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const num=v=>(v==null||!isFinite(+v))?'0':(+v).toLocaleString('pt-BR');
const pctf=v=>(v==null||!isFinite(+v))?'0,0%':((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
const iso=d=>d.toISOString().slice(0,10);
function addDaysISO(isoStr,n){const d=new Date(isoStr+'T00:00:00');d.setDate(d.getDate()+n);return iso(d);}
function daysLen(de,ate){const d1=new Date(de+'T00:00:00'),d2=new Date(ate+'T00:00:00');return Math.round((d2-d1)/(1000*60*60*24))+1;}
function monthStartISO(isoStr){const d=new Date(isoStr+'T00:00:00');d.setDate(1);return iso(d);}
function monthEndISO(isoStr){const d=new Date(isoStr+'T00:00:00');d.setMonth(d.getMonth()+1,0);return iso(d);}
function addMonthsISO(isoStr,delta){const d=new Date(isoStr+'T00:00:00');const day=d.getDate();d.setDate(1);d.setMonth(d.getMonth()+delta);const last=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();d.setDate(Math.min(day,last));return iso(d);}
function formatYM(isoStr){const d=new Date(isoStr+'T00:00:00');const m=d.getMonth();const y=String(d.getFullYear()).slice(-2);const n=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];return `${n[m]}/${y}`;}
function rangeDaysCountPerDOW(de,ate){const n=[0,0,0,0,0,0,0];let d=new Date(de+'T00:00:00');const end=new Date(ate+'T00:00:00');for(;d<=end;d.setDate(d.getDate()+1)){n[d.getDay()]++;}return n;}
function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}

/* ========= Multiselect ========= */
function MultiSelect(rootId, placeholder){
  const root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
  let options=[], selected=new Set(), filtered=[];
  function render(){panel.innerHTML='';const q=document.createElement('input');q.className='msel-search';q.placeholder='Filtrar…';q.addEventListener('input',()=>{filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase()));draw();resetAutoCollapse();});panel.appendChild(q);draw();}
  function draw(){const box=document.createElement('div');(filtered.length?filtered:options).forEach(v=>{const row=document.createElement('div');row.className='msel-opt';const cb=document.createElement('input');cb.type='checkbox';cb.value=v;cb.checked=selected.has(v);const lb=document.createElement('label');lb.textContent=v;cb.addEventListener('change',()=>{cb.checked?selected.add(v):selected.delete(v);refresh();applyAll();resetAutoCollapse();});row.appendChild(cb);row.appendChild(lb);box.appendChild(row);});panel.querySelectorAll('.msel-opt').forEach(n=>n.remove());panel.appendChild(box);}
  function refresh(){btn.textContent=selected.size===0?placeholder:`${selected.size} selecionado(s)`;}
  btn.addEventListener('click',()=>{root.classList.toggle('open');resetAutoCollapse();});document.addEventListener('click',e=>{if(!root.contains(e.target)) root.classList.remove('open');});
  return {setOptions(list, keepOrder=false){options=(list||[]).filter(v=>v!=null).map(String);if(!keepOrder) options.sort((a,b)=>a.localeCompare(b,'pt-BR'));filtered=options.slice();selected=new Set([...selected].filter(v=>options.includes(v)));render();refresh();},get(){return [...selected];},set(vals){selected=new Set((vals||[]).map(String));refresh();draw();}};
}

/* ========= Auto collapse ========= */
const secDatas=$('secDatas'), secFiltros=$('secFiltros'); let autoCollapseTimer=null;
function collapseFilters(){secDatas.classList.add('collapsed');secFiltros.classList.add('collapsed');}
function expandFilters(){secDatas.classList.remove('collapsed');secFiltros.classList.remove('collapsed');}
function resetAutoCollapse(){clearTimeout(autoCollapseTimer);expandFilters();autoCollapseTimer=setTimeout(collapseFilters,10000);}
[secDatas,secFiltros].forEach(sec=>{sec.querySelector('.sec-head').addEventListener('click',()=>{if(sec.classList.contains('collapsed')){expandFilters();resetAutoCollapse();}});});

/* ========= Estado/Período ========= */
let firstDay='', lastDay='';
const chips=[...document.querySelectorAll('.chip')];
const fDe=$('fDe'), fAte=$('fAte'), periodoInfo=$('periodoInfo');
const ms={unids:MultiSelect('ms-unids','Todas as unidades'), lojas:MultiSelect('ms-lojas','Todas as lojas'), canais:MultiSelect('ms-canais','Todos os canais'), turnos:MultiSelect('ms-turnos','Todos os turnos'), pags:MultiSelect('ms-pags','Todos os tipos'), cancel:MultiSelect('ms-cancel','Todos')};
function setActiveChip(v){chips.forEach(c=>c.classList.toggle('active',c.dataset.q===String(v))); }
function applyQuick(v){setActiveChip(v);const ate=lastDay||iso(new Date());const de=addDaysISO(ate,-(Number(v)-1));fDe.value=de;fAte.value=ate;periodoInfo.textContent=`Último dia carregado: ${lastDay}`;applyAll();}
$('btnClear').addEventListener('click',()=>{ms.unids.set([]);ms.lojas.set([]);ms.canais.set([]);ms.turnos.set([]);ms.pags.set([]);ms.cancel.set(['Não']);applyQuick('30');});
chips.forEach(b=>b.addEventListener('click',()=>{applyQuick(b.dataset.q);resetAutoCollapse();}));
[fDe,fAte].forEach(inp=>inp.addEventListener('change',()=>{chips.forEach(c=>c.classList.remove('active'));periodoInfo.textContent=`Último dia carregado: ${lastDay}`;applyAll();resetAutoCollapse();}));

/* ========= KPI calc (mesmo de antes) ========= */
function buildParams(de,ate,overrideCancel=null){
  const canc=overrideCancel!=null?[overrideCancel]:ms.cancel.get();
  let p_cancelado=null; if(canc.length===1&&(canc[0]==='Não'||canc[0]==='Sim')) p_cancelado=canc[0];
  return {p_dini:de,p_dfim:ate,p_unids:ms.unids.get().length?ms.unids.get():null,p_lojas:ms.lojas.get().length?ms.lojas.get():null,p_turnos:ms.turnos.get().length?ms.turnos.get():null,p_canais:ms.canais.get().length?ms.canais.get():null,p_pags:ms.pags.get().length?ms.pags.get():null,p_cancelado};
}
function rpcName(p){return p.p_unids?'kpi_vendas_v2':'kpi_vendas';}
function prepareArgs(name,p){if(name==='kpi_vendas'){const{p_unids,...rest}=p;return rest;}return p;}
function agg(rows){let ped=0,fat=0,des=0,fre=0;for(const r of (rows||[])){ped+=+r.pedidos||0;fat+=+r.fat||0;des+=+r.des||0;fre+=+r.fre||0;}return{ped,fat,des,fre};}
function upSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>'; }
function downSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>'; }
function deltaBadge(el,curr,prev){if(!isFinite(prev)||+prev===0){el.textContent='—';el.className='delta';return;}const p=((curr-prev)/prev)*100;el.innerHTML=(p>=0?upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%';el.className='delta '+(p>=0?'up':'down');}
async function updateKPIs(de,ate,dePrev,atePrev){
  const pNow=buildParams(de,ate), pPrev=buildParams(dePrev,atePrev);
  const nameNow=rpcName(pNow), namePrev=rpcName(pPrev);
  const [now,prev,cNow,cPrev]=await Promise.all([supa.rpc(nameNow,prepareArgs(nameNow,pNow)),supa.rpc(namePrev,prepareArgs(namePrev,pPrev)),supa.rpc(nameNow,prepareArgs(nameNow,{...pNow,p_cancelado:'Sim'})),supa.rpc(namePrev,prepareArgs(namePrev,{...pPrev,p_cancelado:'Sim'}))]);
  if(now.error) throw now.error; if(prev.error) throw prev.error;
  const N=agg(now.data||[]), P=agg(prev.data||[]); const CN=agg((cNow?.data)||[]), CP=agg((cPrev?.data)||[]);
  const len=daysLen(de,ate);
  const tktN=(N.ped>0)?(N.fat/N.ped):0, tktP=(P.ped>0)?(P.fat/P.ped):0;
  const fatMedN=len?(N.fat/len):0, fatMedP=len?(P.fat/len):0;
  const desPercN=N.fat?(N.des/N.fat):0, desPercP=P.fat?(P.des/P.fat):0;
  const freMedN=N.ped?(N.fre/N.ped):0, freMedP=P.ped?(P.fre/P.ped):0;
  const partCancN=N.ped?(CN.ped/N.ped):0, partCancP=P.ped?(CP.ped/P.ped):0;
  $('k_ped').textContent=num(N.ped); $('p_ped').textContent=num(P.ped); deltaBadge($('d_ped'),N.ped,P.ped);
  $('k_tkt').textContent=money(tktN); $('p_tkt').textContent=money(tktP); deltaBadge($('d_tkt'),tktN,tktP);
  $('k_fat').textContent=money(N.fat); $('p_fat').textContent=money(P.fat); deltaBadge($('d_fat'),N.fat,P.fat);
  $('k_fatmed').textContent=money(fatMedN); $('p_fatmed').textContent=money(fatMedP); deltaBadge($('d_fatmed'),fatMedN,fatMedP);
  $('k_des').textContent=money(N.des); $('p_des').textContent=money(P.des); deltaBadge($('d_des'),N.des,P.des);
  $('k_desperc').textContent=pctf(desPercN); $('p_desperc').textContent=pctf(desPercP); deltaBadge($('d_desperc'),desPercN,desPercP);
  $('k_fre').textContent=money(N.fre); $('p_fre').textContent=money(P.fre); deltaBadge($('d_fre'),N.fre,P.fre);
  $('k_fremed').textContent=money(freMedN); $('p_fremed').textContent=money(freMedP); deltaBadge($('d_fremed'),freMedN,freMedP);
  $('k_canc_ped').textContent=num(CN.ped); deltaBadge($('d_canc_ped'),CN.ped,CP.ped);
  $('k_canc_val').textContent=money(CN.fat); $('p_canc_val').textContent=money(CP.fat); deltaBadge($('d_canc_val'),CN.fat,CP.fat);
  const roiN=(N.des>0)?(N.fat-N.des)/N.des:NaN, roiP=(P.des>0)?(P.fat-P.des)/P.des:NaN;
  $('k_roi').textContent=Number.isFinite(roiN)?pctf(roiN):'—'; $('p_roi').textContent=Number.isFinite(roiP)?pctf(roiP):'—'; deltaBadge($('d_roi'),Number.isFinite(roiN)?roiN:0,Number.isFinite(roiP)?roiP:0);
}

/* ========= KPI→gráficos (nova lógica) ========= */
let chartModeGlobal='total';
let selectedMetric='fat'; // padrão
const KPI_MAP={
  ped:{label:'Pedidos',kind:'sum',field:'pedidos'},
  tkt:{label:'Ticket Médio',kind:'ratio',num:'fat',den:'pedidos'},
  fat:{label:'Faturamento',kind:'sum',field:'fat'},
  fatmed:{label:'Faturamento Médio',kind:'sum',field:'fat',forceMedia:true},
  des:{label:'Incentivos',kind:'sum',field:'des'},
  desperc:{label:'% de Incentivos',kind:'ratio',num:'des',den:'fat',isPercent:true},
  fre:{label:'Frete',kind:'sum',field:'fre'},
  fremed:{label:'Frete Médio',kind:'ratio',num:'fre',den:'pedidos'},
  canc_ped:{label:'Pedidos Cancelados',kind:'sum',field:'pedidos',overrideCancel:'Sim'},
  canc_val:{label:'Valor de Cancelados',kind:'sum',field:'fat',overrideCancel:'Sim'},
  roi:{label:'ROI',kind:'ratio',num:'fatMinusDes',den:'des',isPercent:true}
};
function fmtMetric(metric,v){
  const M=KPI_MAP[metric]||{};
  if(M.isPercent) return pctf(v);
  if(metric==='tkt' || metric==='fremed') return money(v);
  if(metric==='ped' || metric==='canc_ped') return num(v);
  return money(v);
}
function tickFormatter(metric){
  if(KPI_MAP[metric]?.isPercent) return (value)=>((value*100).toLocaleString('pt-BR',{maximumFractionDigits:0})+'%');
  if(metric==='ped'||metric==='canc_ped') return (v)=>num(v);
  return (v)=>{const val=Number(v)||0; if(Math.abs(val)>=1_000_000) return 'R$ '+(val/1_000_000).toFixed(1).replace('.',',')+' mi'; if(Math.abs(val)>=1_000) return 'R$ '+(val/1_000).toFixed(1).replace('.',',')+' mil'; return 'R$ '+val.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,'.');};
}

/* ========= Fetch base rows (para qualquer métrica) ========= */
async function fetchBaseRows(de,ate,overrideCancel=null){
  let q=supa.from(READ_VIEW).select('dia,hora,turno,fat,des,fre,pedidos,cancelado,loja,unidade,canal,pagamento_base',{head:false}).gte('dia',de).lte('dia',ate).limit(200000);
  const un=ms.unids.get(); if(un.length) q=q.in('unidade',un);
  const lj=ms.lojas.get(); if(lj.length) q=q.in('loja',lj);
  const tr=ms.turnos.get(); if(tr.length) q=q.in('turno',tr);
  const cn=ms.canais.get(); if(cn.length) q=q.in('canal',cn);
  const pg=ms.pags.get();  if(pg.length) q=q.in('pagamento_base',pg);
  const cancSel=ms.cancel.get();
  if(overrideCancel!=null) q=q.eq('cancelado',overrideCancel);
  else if(cancSel.length===1 && (cancSel[0]==='Sim'||cancSel[0]==='Não')) q=q.eq('cancelado',cancSel[0]);
  const {data,error}=await q; if(error) throw error;
  return (data||[]).map(r=>({
    dia:String(r.dia), hora:(r.hora==null?null:Number(r.hora)), turno:r.turno||((Number(r.hora)>=6&&Number(r.hora)<18)?'Dia':'Noite'),
    fat:Number(r.fat)||0, des:Number(r.des)||0, fre:Number(r.fre)||0, pedidos:Number(r.pedidos)||0,
    cancelado:r.cancelado==='Sim'?'Sim':'Não', loja:String(r.loja||''), unidade:String(r.unidade||''), canal:String(r.canal||''), pagamento_base:String(r.pagamento_base||'')
  }));
}

/* ========= Agregadores ========= */
function getBucketKey(dim,row){
  if(dim==='dow'){ return new Date(row.dia+'T00:00:00').getDay(); }
  if(dim==='hour'){ return Number.isFinite(row.hora)?row.hora:null; }
  if(dim==='turno'){ return row.turno||'Outro'; }
  if(dim==='month'){ const d=new Date(row.dia+'T00:00:00'); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  return null;
}
function labelsFor(dim, context){
  if(dim==='dow') return ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  if(dim==='hour') return Array.from({length:24},(_,h)=>String(h).padStart(2,'0')+'h');
  if(dim==='turno') return ['Dia','Noite'];
  if(dim==='month' && context?.start){ // 12 labels
    const labs=[]; let cur=context.start; for(let i=0;i<12;i++){ labs.push(formatYM(cur)); cur=addMonthsISO(cur,1); } return labs;
  }
  return [];
}
function denominatorDays(dim, de, ate){
  if(dim==='dow') return rangeDaysCountPerDOW(de,ate);
  const len=daysLen(de,ate);
  if(dim==='hour') return Array(24).fill(len);
  if(dim==='turno') return ['Dia','Noite'].map(()=>len);
  return [];
}
function sumPush(obj,a){obj.fat+=a.fat||0;obj.ped+=a.ped||0;obj.des+=a.des||0;obj.fre+=a.fre||0;}
function metricFromSums(metric,s){
  const M=KPI_MAP[metric]||{};
  if(M.kind==='sum'){ return (s[M.field]||0); }
  // ratios
  let num=0, den=0;
  if(M.num==='fatMinusDes'){ num=(s.fat||0)-(s.des||0); } else { num=s[M.num]||0; }
  den=s[M.den]||0;
  return den? (num/den) : 0;
}
function aggregateSeries(rows, metric, dim, mode, de, ate, opts={}){
  const labels = labelsFor(dim, opts);
  const idxMap = new Map(); labels.forEach((l,i)=>idxMap.set(l, i));
  // For dow/hour use stable order arrays
  let buckets=[], keys=[];
  if(dim==='dow'){ keys=[0,1,2,3,4,5,6]; buckets=keys.map(()=>({fat:0,ped:0,des:0,fre:0})); }
  else if(dim==='hour'){ keys=[...Array(24).keys()]; buckets=keys.map(()=>({fat:0,ped:0,des:0,fre:0})); }
  else if(dim==='turno'){ keys=['Dia','Noite']; buckets=keys.map(()=>({fat:0,ped:0,des:0,fre:0})); }
  else if(dim==='month'){ keys=opts.ymList||[]; buckets=keys.map(()=>({fat:0,ped:0,des:0,fre:0,days:opts.daysPerYM?.[i]||0})); }

  const ymList = opts.ymList||[];
  for(const r of rows){
    const k=getBucketKey(dim,r);
    if(k==null) continue;
    let idx=-1;
    if(dim==='dow'){ idx = keys.indexOf(k); }
    else if(dim==='hour'){ idx = (k>=0&&k<24)?k:-1; }
    else if(dim==='turno'){ idx = keys.indexOf(k); }
    else if(dim==='month'){ const d=new Date(r.dia+'T00:00:00'); const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; idx = ymList.indexOf(ym); }
    if(idx<0) continue;
    sumPush(buckets[idx], {fat:r.fat, ped:r.pedidos, des:r.des, fre:r.fre});
  }

  let values=keys.map((_,i)=>metricFromSums(metric,{fat:buckets[i].fat,ped:buckets[i].ped,des:buckets[i].des,fre:buckets[i].fre}));

  // média (por dia) — para somas divide pelo nº de dias aplicável ao bucket
  if(mode==='media' && KPI_MAP[metric]?.kind==='sum'){
    if(dim==='month' && opts.daysPerYMArr){ values=values.map((v,i)=>opts.daysPerYMArr[i]? v/opts.daysPerYMArr[i] : v); }
    else{
      const den = denominatorDays(dim,de,ate);
      values = values.map((v,i)=> den[i]? v/den[i]: v);
    }
  }
  // para razões, manter direto (média de dia = razão de totais no período)
  return {labels: (dim==='month'? labelsFor('month', opts): labels), values};
}

/* ========= UI: Charts ========= */
function ensureChart(canvasId, labels, nowArr, prevArr, metric, tooltipExtra=''){
  const canvas=$(canvasId); if(!canvas) return;
  if(canvas.__chart){ try{canvas.__chart.destroy();}catch(e){} canvas.__chart=null; }
  const ctx=canvas.getContext('2d');
  const chart=new Chart(ctx,{type:'bar',
    data:{labels, datasets:[
      {label:'Atual', data:nowArr.map(v=>+v||0), backgroundColor:gradNow(ctx)},
      {label:'Anterior', data:prevArr.map(v=>+v||0), backgroundColor:gradPrev(ctx)}
    ]},
    options:{
      responsive:true, maintainAspectRatio:false, animation:false,
      scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'rgba(0,0,0,.05)'}, ticks:{callback:tickFormatter(metric)}}},
      plugins:{ legend:{position:'top'},
        tooltip:{mode:'index',intersect:false,callbacks:{
          label:(c)=>`${c.dataset.label}: ${fmtMetric(metric, c.parsed.y||0)}`,
          footer:()=> tooltipExtra
        }}
      }
    }
  });
  canvas.__chart=chart;
}

/* ========= Charts a partir do KPI selecionado ========= */
async function updateChartsForMetric(){
  const de=fDe.value||firstDay, ate=fAte.value||lastDay;
  const {dePrev,atePrev}=computePrevRangeISO(de,ate);
  const meta=KPI_MAP[selectedMetric]||{};
  try{
    const [rowsNow, rowsPrev] = await Promise.all([fetchBaseRows(de,ate,meta.overrideCancel||null), fetchBaseRows(dePrev,atePrev,meta.overrideCancel||null)]);
    const tip=`Período anterior: ${dePrev} → ${atePrev}`;

    // DOW
    let a=aggregateSeries(rowsNow,selectedMetric,'dow',chartModeGlobal,de,ate);
    let b=aggregateSeries(rowsPrev,selectedMetric,'dow',chartModeGlobal,dePrev,atePrev);
    ensureChart('ch_dow', a.labels, a.values, b.values, selectedMetric, tip);

    // HOUR (filtra zeros p/ limpar)
    let ah=aggregateSeries(rowsNow,selectedMetric,'hour',chartModeGlobal,de,ate);
    let bh=aggregateSeries(rowsPrev,selectedMetric,'hour',chartModeGlobal,dePrev,atePrev);
    const keepIdx=ah.values.map((v,i)=> (v||bh.values[i])?i:null).filter(i=>i!=null);
    ensureChart('ch_hour', keepIdx.map(i=>ah.labels[i]), keepIdx.map(i=>ah.values[i]), keepIdx.map(i=>bh.values[i]), selectedMetric, tip);

    // TURNO
    let at=aggregateSeries(rowsNow,selectedMetric,'turno',chartModeGlobal,de,ate);
    let bt=aggregateSeries(rowsPrev,selectedMetric,'turno',chartModeGlobal,dePrev,atePrev);
    ensureChart('ch_turno', at.labels, at.values, bt.values, selectedMetric, tip);

    setStatus('OK — gráficos atualizados','ok');
  }catch(e){ console.error(e); setStatus('OK (gráficos por KPI indisponíveis)','ok'); }
}

/* ========= Month 12×12 por KPI ========= */
function computePrevRangeISO(deISO,ateISO){
  const d1=new Date(deISO+'T00:00:00'), d2=new Date(ateISO+'T00:00:00');
  const len=daysLen(deISO,ateISO); const atePrev=new Date(d1.getTime()-86400000); const dePrev=new Date(atePrev.getTime()-(len-1)*86400000);
  return {dePrev: iso(dePrev), atePrev: iso(atePrev)};
}
async function updateMonth12x12ForMetric(){
  try{
    const end = lastDay || iso(new Date());
    const endMonthStart=monthStartISO(end);
    const last12Start=addMonthsISO(endMonthStart,-11);
    const prev12Start=addMonthsISO(endMonthStart,-23);
    const last12End  =monthEndISO(end);
    const prev12End  =monthEndISO(addMonthsISO(endMonthStart,-12));
    const meta=KPI_MAP[selectedMetric]||{};

    const rows = await fetchBaseRows(prev12Start,last12End,meta.overrideCancel||null);

    // separar em now (últimos 12 meses) e prev (12 anteriores)
    const ymNow=[]; let cur=last12Start; for(let i=0;i<12;i++){ymNow.push(cur.slice(0,7)); cur=addMonthsISO(cur,1);}
    const ymPrev=ymNow.map(ym=>{const [yy,mm]=ym.split('-').map(Number);const p=new Date(yy,mm-1-12,1);return `${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,'0')}`;});
    const daysPerYMArr = ymNow.map(ym=>{const [yy,mm]=ym.split('-').map(Number);return daysInMonth(yy,mm-1);});
    const daysPerYMArrPrev = ymPrev.map(ym=>{const [yy,mm]=ym.split('-').map(Number);return daysInMonth(yy,mm-1);});

    const an=aggregateSeries(rows.filter(r=>ymNow.includes(r.dia.slice(0,7))),selectedMetric,'month',chartModeGlobal,last12Start,last12End,{start:last12Start,ymList:ymNow,daysPerYMArr});
    const ap=aggregateSeries(rows.filter(r=>ymPrev.includes(r.dia.slice(0,7))),selectedMetric,'month',chartModeGlobal,prev12Start,prev12End,{start:prev12Start,ymList:ymPrev,daysPerYMArr:daysPerYMArrPrev});
    ensureChart('ch_month', an.labels, an.values, ap.values, selectedMetric, `Comparação 12M vs 12M anteriores`);
  }catch(e){ console.error(e); setStatus('OK (mensal por KPI indisponível)','ok'); }
}

/* ========= Donut Top-6 por KPI ========= */
const wine=["#7b1e3a","#8c2947","#9c3554","#ad4061","#bd4c6e","#ce577b"];
function ensureDonutTop6(labels, values, metric){
  const cvs=$('ch_top6'); if(!cvs) return;
  if(cvs.__chart){ try{cvs.__chart.destroy();}catch(e){} cvs.__chart=null; }
  const ctx=cvs.getContext('2d');
  const total=(values||[]).reduce((a,b)=>a+(+b||0),0);
  $('top6Center').textContent='Total: '+fmtMetric(metric,total);
  const chart=new Chart(ctx,{type:'doughnut',
    data:{labels, datasets:[{data:values, backgroundColor:wine, hoverBackgroundColor:wine, borderColor:'#fff', borderWidth:1}]},
    options:{responsive:true, maintainAspectRatio:false, cutout:'60%',
      plugins:{legend:{position:'right',labels:{usePointStyle:true,pointStyle:'circle',boxWidth:10,padding:16,color:'#334155'}},
        tooltip:{callbacks:{label:(c)=>{const label=c.label||'';const val=c.parsed||0;const ds=c.chart.data.datasets[0];const tt=(ds.data||[]).reduce((a,b)=>a+(+b||0),0);const perc=tt?((val/tt)*100).toFixed(1):0;return `${label}: ${fmtMetric(metric,val)} (${perc}%)`;}}}
    }});
  cvs.__chart=chart;
}
async function updateTop6ForMetric(){
  try{
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    const meta=KPI_MAP[selectedMetric]||{};
    // traz somas necessárias por loja
    let q=supa.from(READ_VIEW).select('loja, fat:fat.sum(), pedidos:pedidos.sum(), des:des.sum(), fre:fre.sum()', {head:false}).gte('dia',de).lte('dia',ate).order('fat',{ascending:false}).limit(200);
    const un=ms.unids.get(); if(un.length) q=q.in('unidade',un);
    const lj=ms.lojas.get(); if(lj.length) q=q.in('loja',lj);
    const tr=ms.turnos.get(); if(tr.length) q=q.in('turno',tr);
    const cn=ms.canais.get(); if(cn.length) q=q.in('canal',cn);
    const pg=ms.pags.get();  if(pg.length) q=q.in('pagamento_base',pg);
    const cancSel=ms.cancel.get();
    if(meta.overrideCancel) q=q.eq('cancelado',meta.overrideCancel);
    else if(cancSel.length===1 && (cancSel[0]==='Sim'||cancSel[0]==='Não')) q=q.eq('cancelado',cancSel[0]);
    const {data,error}=await q; if(error) throw error;
    const rows=(data||[]).map(r=>({loja:r.loja, fat:+r.fat||0, pedidos:+r.pedidos||0, des:+r.des||0, fre:+r.fre||0}));
    function metricFromRow(m,r){
      if(KPI_MAP[m].kind==='sum') return r[KPI_MAP[m].field]||0;
      let num=0, den=0;
      if(KPI_MAP[m].num==='fatMinusDes') num=(r.fat||0)-(r.des||0); else num=r[KPI_MAP[m].num]||0;
      den=r[KPI_MAP[m].den]||0;
      return den? num/den : 0;
    }
    rows.forEach(r=>r.val=metricFromRow(selectedMetric,r));
    rows.sort((a,b)=>b.val-a.val);
    const top=rows.slice(0,6);
    ensureDonutTop6(top.map(x=>x.loja), top.map(x=>x.val), selectedMetric);
  }catch(e){ console.warn('top6',e.message||e); ensureDonutTop6([],[],selectedMetric); }
}
$('top6Center').addEventListener('click',()=>{ setStatus('Top 6 — total clicado','ok'); });

/* ========= Options fallback ========= */
async function fallbackDistinct(col){try{const {data,error}=await supa.from(READ_VIEW).select(col,{head:false}).neq(col,null).limit(5000);if(error) return [];const vals=(data||[]).map(r=>r[col]).filter(Boolean);return [...new Set(vals)].sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));}catch(_e){return[]}}
async function reloadStaticOptions(){
  const [unids,lojas,canais,pags]=await Promise.all([
    (async()=>{const r=await supa.from('vw_vendas_unidades').select('unidade').order('unidade');return (!r.error?r.data:await fallbackDistinct('unidade'));})(),
    (async()=>{const r=await supa.from('vw_vendas_lojas').select('loja').order('loja');return (!r.error?r.data:await fallbackDistinct('loja'));})(),
    (async()=>{const r=await supa.from('vw_vendas_canais').select('canal').order('canal');return (!r.error?r.data:await fallbackDistinct('canal'));})(),
    (async()=>{const r=await supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base');return (!r.error?r.data:await fallbackDistinct('pagamento_base'));})(),
  ]);
  const toArr=(rows,key)=> Array.isArray(rows) ? rows.map(r=> key?r[key]:r).filter(Boolean) : [];
  ms.unids.setOptions(toArr(unids,'unidade'),true);
  ms.lojas.setOptions(toArr(lojas,'loja'),true);
  ms.canais.setOptions(toArr(canais,'canal'),true);
  ms.pags.setOptions(toArr(pags,'pagamento_base'),true);
  ms.turnos.setOptions(['Dia','Noite'],true);
}

/* ========= Apply All ========= */
async function applyAll(){
  try{
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    const {dePrev,atePrev}=computePrevRangeISO(de,ate);
    setStatus('Consultando…');
    let kpiOk=true;
    await updateKPIs(de,ate,dePrev,atePrev).catch(e=>{console.error(e);kpiOk=false;});
    await updateMonth12x12ForMetric();
    await updateChartsForMetric();
    await updateTop6ForMetric();
    setStatus(kpiOk?'OK':'OK (sem KPIs — RPC indisponível)','ok');
    resetAutoCollapse();
  }catch(e){ console.error(e); setStatus('Erro: '+(e.message||e),'err'); }
}
(async function init(){
  try{
    setStatus('Carregando…');
    const dr=await supa.from('vw_vendas_daterange').select('*').limit(1);
    if(!dr.error && dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }
    await reloadStaticOptions();
    ms.cancel.setOptions(['','Não','Sim']); ms.cancel.set(['Não']);
    $('periodoInfo').textContent=`Último dia carregado: ${lastDay}`;
    applyQuick('30');
    resetAutoCollapse();
  }catch(e){ console.error(e); setStatus('Erro ao iniciar: '+(e.message||e),'err'); }
})();

/* ========= Toggle global total/média ========= */
const segGlobal=$('segGlobal');
segGlobal.addEventListener('click',(e)=>{
  const btn=e.target.closest('.seg-btn'); if(!btn) return;
  chartModeGlobal=btn.dataset.mode;
  segGlobal.querySelectorAll('.seg-btn').forEach(b=>b.classList.toggle('active',b===btn));
  updateMonth12x12ForMetric(); updateChartsForMetric();
});

/* ========= Clique nos KPIs ========= */
document.querySelectorAll('.kpi[role="button"]').forEach(el=>{
  el.addEventListener('click', ()=>{
    document.querySelectorAll('.kpi[role="button"]').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    selectedMetric=el.dataset.k;
    // se KPI for "médio", ativa modo Média
    if(KPI_MAP[selectedMetric]?.forceMedia){
      chartModeGlobal='media';
      segGlobal.querySelectorAll('.seg-btn').forEach(b=>b.classList.toggle('active', b.dataset.mode==='media'));
    }
    updateMonth12x12ForMetric(); updateChartsForMetric(); updateTop6ForMetric();
  });
});
</script>
</body>
</html>
