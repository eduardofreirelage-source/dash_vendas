<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v18.0-ops)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb;
      --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .delta .up{color:var(--good)} .delta .down{color:var(--bad)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    input[type="date"]{padding:7px 10px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .seg{display:flex;gap:6px;align-items:center}
    .seg .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .seg .grow{min-width:180px}
    .chartbox{position:relative;height:300px;width:100%} /* altura fixa -> sem “infinito” */
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff}
    .pill button.active{background:var(--accent);color:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{
      padding:12px 14px; list-style:none; cursor:pointer; user-select:none; outline:none;
      display:flex; align-items:center; justify-content:space-between;
      font-weight:600;
    }
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-2{grid-column:span 2} .col-12{grid-column:span 12}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .shadow-note{font-size:11px;color:var(--muted);margin-top:4px}
    .sep{height:1px;background:var(--brd);margin:8px 0}
    .admin{background:#fafafa;border:1px dashed var(--brd);border-radius:10px;padding:10px;margin-top:8px}
    progress{width:220px;height:10px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    @media (max-width:940px){ .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))} .filters-grid{grid-template-columns:repeat(6,1fr)} }
    @media (max-width:560px){ .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr} .filters-grid{grid-template-columns:repeat(4,1fr)} }
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div>
        <h1>Dashboard Vendas — Supabase <span class="muted">(v18.0-ops)</span></h1>
        <div class="muted">Fonte: <code>public.vendas_kpi_daily_v2</code> (auto)</div>
        <div class="muted" id="periodo">Período: —</div>
        <div class="muted" id="limites">Limites no banco: —</div>
      </div>
      <div class="muted">Projeto: <code>uahmcfzerofhzjvlzrqc</code></div>
    </div>

    <!-- FILTROS -->
    <details class="filterbox" id="fx">
      <summary>
        FILTROS
        <span class="muted right" id="limpar" title="Limpar filtros" style="font-weight:400">Limpar</span>
      </summary>
      <div class="body">
        <div class="filters-grid">
          <!-- Linha 1: Unidade + Nome da Loja -->
          <div class="col-6 seg">
            <span class="lbl">Unidade</span>
            <select id="uni" class="grow"></select>
          </div>
          <div class="col-6 seg">
            <span class="lbl">Nome da loja (Top 10)</span>
            <div id="lojas" class="chips"></div>
          </div>

          <!-- Linha 2: De / Até / Período rápido / Turno -->
          <div class="col-3 seg">
            <span class="lbl">De</span>
            <input type="date" id="dini" class="grow" />
          </div>
          <div class="col-3 seg">
            <span class="lbl">Até</span>
            <input type="date" id="dfim" class="grow" />
          </div>
          <div class="col-3 seg">
            <span class="lbl">Período rápido</span>
            <select id="pr" class="grow">
              <option value="7">Últimos 7</option>
              <option value="15">Últimos 15</option>
              <option value="30" selected>Últimos 30</option>
              <option value="90">Últimos 90</option>
              <option value="180">Últimos 180</option>
              <option value="360">Últimos 360</option>
            </select>
          </div>
          <div class="col-3 seg">
            <span class="lbl">Turno</span>
            <select id="turno" class="grow" multiple>
              <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>

          <!-- Linha 3: Canal / Pagamento / Cancelado -->
          <div class="col-4 seg">
            <span class="lbl">Canal de venda</span>
            <select id="canal" class="grow" multiple></select>
          </div>
            <div class="col-4 seg">
            <span class="lbl">Pagamento</span>
            <select id="pag" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Está cancelado?</span>
            <select id="canc" class="grow">
              <option value="Todos" selected>Todos</option>
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
            </select>
          </div>
        </div>
        <div class="hint">Datas limitadas ao último lançamento do banco. Se escolher um dia inexistente, ajusto automaticamente para o mais próximo válido.</div>

        <div class="admin">
          <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>) direto do navegador
          <div class="row" style="margin-top:6px;flex-wrap:wrap">
            <input type="file" id="csvfile" accept=".csv" />
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" value="0" max="100" style="display:none"></progress>
            <span class="muted">Recomendado via Edge Function (rápido). Sem Function, faço direto (lento) em lotes.</span>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">…</div><div class="delta" id="d_tkm">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">…</div><div class="delta" id="d_fmd">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">…</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">…</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">…</div><div class="delta" id="d_frem">—</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">…</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">…</div><div class="delta" id="d_fatlp">—</div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária (R$) — com sombra do período anterior</div>
        <div class="pill" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média (7d)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
      <div class="shadow-note">A “sombra” representa o período imediatamente anterior (mesmo nº de dias).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana (R$)</div>
        <div class="pill" data-target="dowMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora (0–23)</div>
        <div class="pill" data-target="hourMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
      <div class="shadow-note">Horas pouco ativas são ocultadas (proxy p/ >30 min sem venda).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por mês</div>
        <div class="pill" data-target="monMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas (R$)</div>
        <div class="pill" data-target="topMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>

    <!-- LOGS -->
    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Credenciais =====
  var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var TABLE = "vendas_kpi_daily_v2";
  var STAGING = "vendas_kpi_daily_v2_data";
  var FUNCTION_URL = ""; // opcional: ex. https://<project>.functions.supabase.co/import_csv

  // ===== UI helpers =====
  var elLog=document.getElementById("log");
  function log(s){ elLog.textContent += "\n"+s; elLog.scrollTop=elLog.scrollHeight; }
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ return d.toISOString().slice(0,10); }
  function parseISO(s){ return new Date(s+"T00:00:00Z"); }
  function addDays(d, k){ var t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function sum(arr, key){ var s=0; for(var i=0;i<arr.length;i++) s+=Number(arr[i][key]||0); return s; }
  function avg(dividendo,divisor){ return (divisor>0)? (dividendo/divisor):0; }
  function debounce(fn, wait){ var t; return function(){ var args=arguments, ctx=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, wait); }; }

  // ===== Supabase client =====
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:false } });

  // ===== Estado =====
  var selUni=document.getElementById("uni");
  var chipLojas=document.getElementById("lojas");
  var dini=document.getElementById("dini");
  var dfim=document.getElementById("dfim");
  var pr=document.getElementById("pr");
  var turno=document.getElementById("turno");
  var canal=document.getElementById("canal");
  var pag=document.getElementById("pag");
  var canc=document.getElementById("canc");
  var periodoTxt=document.getElementById("periodo");
  var limitesTxt=document.getElementById("limites");
  var runId = 0, drawing = false;

  var chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  var lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";

  var diasDisponiveis = new Set(); // dias existentes no banco (para validação)
  var maxDiaISO=null, minDiaISO=null;

  // ===== Eventos UI =====
  document.getElementById("limpar").addEventListener("click", function(e){
    e.preventDefault();
    selUni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos";
    Array.prototype.forEach.call(chipLojas.children, c=>c.classList.remove("active"));
    recarregarDebounced();
  });

  // Toggle Total/Média por gráfico
  function wirePills(){
    Array.prototype.forEach.call(document.querySelectorAll(".pill"), function(pill){
      pill.addEventListener("click", function(ev){
        var btn = ev.target.closest("button"); if(!btn) return;
        Array.prototype.forEach.call(pill.querySelectorAll("button"), b=>b.classList.remove("active"));
        btn.classList.add("active");
        var trg = pill.getAttribute("data-target");
        var val = btn.getAttribute("data-val");
        if(trg==="lineMode") lineMode=val;
        if(trg==="dowMode") dowMode=val;
        if(trg==="dowPedMode") dowPedMode=val;
        if(trg==="hourMode") hourMode=val;
        if(trg==="monMode") monMode=val;
        if(trg==="topMode") topMode=val;
        recarregarDebounced();
      });
    });
  }

  // ===== Helpers de consulta =====
  async function fetchPaged(fields, startISO, endISO, unidade, lojas, filtros){
    var page=1000, off=0, out=[];
    for(;;){
      var q = supa.from(TABLE).select(fields).gte("dia", startISO).lte("dia", endISO).order("dia",{ascending:true}).range(off, off+page-1);
      if(unidade && unidade!=="Todas") q = q.eq("unidade", unidade);
      if(lojas && lojas.length) q = q.in("Nome da Loja", lojas);
      if(filtros.turno && filtros.turno.length) q = q.in("turno", filtros.turno);
      if(filtros.canal && filtros.canal.length) q = q.in("Canal de venda", filtros.canal);
      if(filtros.pag && filtros.pag.length) q = q.in("pagamento", filtros.pag);
      if(filtros.canc && filtros.canc!=="Todos"){
        q = q.eq("cancelado", filtros.canc==="Sim" ? "Sim":"Não");
      }
      var r = await q;
      if(r.error){ throw r.error; }
      var a=r.data||[];
      out = out.concat(a);
      if(a.length<page) break;
      off += page;
      if(off>500000){ log("[Warn] paginação abortada por salvaguarda."); break; }
    }
    return out;
  }

  async function fetchUnidades(){
    var uniq={}, arr=["Todas"];
    function push(list){
      (list||[]).forEach(function(row){
        var u=(row.unidade||"").trim(); if(!u) return;
        if(!uniq[u]){ uniq[u]=1; arr.push(u); }
      });
    }
    // usar todo o intervalo de datas do banco
    var r1 = await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).range(0,9999);
    if(!r1.error) push(r1.data);
    var r2 = await supa.from(TABLE).select("unidade").order("unidade",{ascending:false}).range(0,9999);
    if(!r2.error) push(r2.data);
    if(arr.length===1){ arr.push("Uni. Raja"); arr.push("Uni.Savassi"); }
    return arr;
  }

  async function fetchLimites(){
    // pega min e max de dia + listas para canal/pagamento
    var r = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    var r2= await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r.error||r2.error) throw (r.error||r2.error);
    minDiaISO = (r.data&&r.data[0]&&r.data[0].dia)||null;
    maxDiaISO = (r2.data&&r2.data[0]&&r2.data[0].dia)||null;
    limitesTxt.textContent = "Limites no banco: "+minDiaISO+" → "+maxDiaISO;

    // popula set de dias disponíveis (para validar datas)
    diasDisponiveis = new Set();
    var page=1000, off=0;
    for(;;){
      var rs = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).range(off, off+page-1);
      if(rs.error) break;
      (rs.data||[]).forEach(x=>diasDisponiveis.add(x.dia));
      if((rs.data||[]).length<page) break;
      off+=page;
      if(off>500000) break;
    }

    // limitar inputs
    if(minDiaISO && maxDiaISO){
      dini.min=minDiaISO; dfim.min=minDiaISO;
      dini.max=maxDiaISO; dfim.max=maxDiaISO;
    }
  }

  function snapToAvailable(iso){
    if(!iso || diasDisponiveis.has(iso)) return iso;
    // encontra o dia válido mais próximo
    var d = parseISO(iso);
    for(var k=1;k<60;k++){
      var a=toISO(addDays(d, -k)), b=toISO(addDays(d, k));
      if(diasDisponiveis.has(a)) return a;
      if(diasDisponiveis.has(b)) return b;
    }
    return null;
  }

  function uniqPush(arr, val){ if(arr.indexOf(val)<0) arr.push(val); }

  function calcDelta(cur, prev){
    var pct = (prev>0)? ((cur-prev)/prev*100): 0;
    var cls = pct>=0 ? "up" : "down";
    var arrow = pct>=0 ? "▲" : "▼";
    return { text: (pct>=0?"+":"")+pct.toFixed(1)+"% "+arrow, cls: cls };
  }

  function setDelta(el, delta){
    el.className="delta "+(delta.cls||"");
    el.textContent = delta.text;
  }

  function groupBy(arr, keyFn, valFn, agg){
    var m=new Map();
    arr.forEach(function(r){
      var k=keyFn(r); var v=valFn(r);
      m.set(k, (m.get(k)||0)+v);
    });
    var labels=Array.from(m.keys()).sort();
    var values=labels.map(k=>m.get(k));
    return {labels, values};
  }

  function groupByDow(arr, valFn){
    var lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    var m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
    // cnt = nº de ocorrências de cada DOW no período (para média)
    // calculo datas distintas para evitar contar dias repetidos
    var diasSet=new Set();
    arr.forEach(r=>diasSet.add(r.dia));
    Array.from(diasSet).forEach(d=>{ cnt[parseISO(d).getUTCDay()]++; });
    arr.forEach(function(r){
      var dow=parseISO(r.dia).getUTCDay();
      m[dow]+=valFn(r);
    });
    return {labels:lbl, totals:m, counts:cnt};
  }

  function groupByHour(arr, valFn){
    var m=Array(24).fill(0), cnt=Array(24).fill(0), activeDays=Array(24).fill(0);
    var daysByHour = Array(24).fill(0).map(()=>new Set());
    arr.forEach(function(r){
      if(r.hora===null||r.hora===undefined) return;
      var h = Number(r.hora)||0; if(h<0||h>23) return;
      m[h]+=valFn(r);
      daysByHour[h].add(r.dia);
    });
    for(var h=0;h<24;h++){
      activeDays[h] = daysByHour[h].size;
      cnt[h] = activeDays[h]; // média = total / dias com aquela hora ativa
    }
    // ocultar horas pouco ativas (< 50% dos dias do período)
    var totalDays = new Set(arr.map(r=>r.dia)).size || 1;
    var labels=[], totals=[], counts=[];
    for(var h=0;h<24;h++){
      var keep = activeDays[h] >= Math.ceil(totalDays*0.5) && m[h]>0;
      if(keep){ labels.push(String(h).padStart(2,"0")+":00"); totals.push(m[h]); counts.push(cnt[h]); }
    }
    return {labels, totals, counts};
  }

  function groupByMonth(arr, valFn){
    var m=new Map(), cnt=new Map(); // yyyy-mm -> total / dias
    var daysPerMonth=new Map();
    arr.forEach(r=>{
      var ym = r.dia.slice(0,7);
      m.set(ym, (m.get(ym)||0)+valFn(r));
      if(!daysPerMonth.has(ym)) daysPerMonth.set(ym, new Set());
      daysPerMonth.get(ym).add(r.dia);
    });
    Array.from(daysPerMonth.keys()).forEach(ym=>{
      cnt.set(ym, daysPerMonth.get(ym).size);
    });
    var labels=Array.from(m.keys()).sort();
    var totals=labels.map(x=>m.get(x));
    var counts=labels.map(x=>cnt.get(x)||1);
    return {labels, totals, counts};
  }

  function movingAvg(arr, win){
    var out=[], acc=0;
    for(var i=0;i<arr.length;i++){
      acc+=arr[i];
      if(i>=win) acc-=arr[i-win];
      out.push( acc / Math.min(i+1, win) );
    }
    return out;
  }

  function destroyChart(c){ if(c){ try{c.destroy();}catch(e){} } return null; }

  // ===== KPI =====
  function updateKPI(cur, ant){
    var ped = sum(cur,"pedidos");
    var fat = sum(cur,"fat");
    var des = sum(cur,"des");
    var fre = sum(cur,"fre");

    var pedA = sum(ant,"pedidos");
    var fatA = sum(ant,"fat");
    var desA = sum(ant,"des");
    var freA = sum(ant,"fre");

    var diasDistinct = new Set(cur.map(r=>r.dia)).size || 1;

    // KPIs
    var tkm = ped>0 ? fat/ped : 0;
    var fmd = fat / diasDistinct;
    var fatLiq = fat - des - fre - (0.12*fat);
    var fatLiqPct = fat>0 ? (fatLiq/fat*100) : 0;
    var desPct = fat>0 ? (des/fat*100) : 0;
    var freMed = ped>0 ? fre/ped : 0;

    // anteriores
    var diasDistinctA = new Set(ant.map(r=>r.dia)).size || 1;
    var tkmA = pedA>0 ? fatA/pedA : 0;
    var fmdA = fatA / diasDistinctA;
    var fatLiqA = fatA - desA - freA - (0.12*fatA);
    var fatLiqPctA = fatA>0 ? (fatLiqA/fatA*100) : 0;
    var desPctA = fatA>0 ? (desA/fatA*100) : 0;
    var freMedA = pedA>0 ? freA/pedA : 0;

    // escreve
    document.getElementById("k_ped").textContent = fmtInt(ped);
    document.getElementById("k_tkm").textContent = fmtBRL(tkm);
    document.getElementById("k_fat").textContent = fmtBRL(fat);
    document.getElementById("k_fmd").textContent = fmtBRL(fmd);
    document.getElementById("k_des").textContent = fmtBRL(des);
    document.getElementById("k_desp").textContent = (desPct).toFixed(1)+"%";
    document.getElementById("k_fre").textContent = fmtBRL(fre);
    document.getElementById("k_frem").textContent = fmtBRL(freMed);
    document.getElementById("k_fatl").textContent = fmtBRL(fatLiq);
    document.getElementById("k_fatlp").textContent = (fatLiqPct).toFixed(1)+"%";

    setDelta(document.getElementById("d_ped"),  calcDelta(ped, pedA));
    setDelta(document.getElementById("d_tkm"),  calcDelta(tkm, tkmA));
    setDelta(document.getElementById("d_fat"),  calcDelta(fat, fatA));
    setDelta(document.getElementById("d_fmd"),  calcDelta(fmd, fmdA));
    setDelta(document.getElementById("d_des"),  calcDelta(des, desA));
    setDelta(document.getElementById("d_desp"), calcDelta(desPct, desPctA));
    setDelta(document.getElementById("d_fre"),  calcDelta(fre, freA));
    setDelta(document.getElementById("d_frem"), calcDelta(freMed, freMedA));
    setDelta(document.getElementById("d_fatl"), calcDelta(fatLiq, fatLiqA));
    setDelta(document.getElementById("d_fatlp"),calcDelta(fatLiqPct, fatLiqPctA));
  }

  // ===== Charts =====
  function drawLine(days, vals, prevVals){
    chartLine = destroyChart(chartLine);
    var ctx=document.getElementById("cLine").getContext("2d");
    var dataCur = vals.slice();
    var dataMed = movingAvg(vals, 7);
    var showMed = (lineMode==="media");
    var mainData = showMed? dataMed : dataCur;

    chartLine = new window.Chart(ctx, {
      type:"line",
      data:{
        labels: days,
        datasets:[
          // sombra do período anterior (área sem borda)
          { data: prevVals, fill:true, borderWidth:0, backgroundColor:"rgba(2, 132, 199, 0.12)", pointRadius:0, tension:0.2 },
          // série principal
          { label: showMed? "Média (7d)" : "Total", data: mainData, borderWidth:2, pointRadius:0, tension:0.2 }
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function drawBar(canvasId, labels, totals, counts, mode){
    var showMed = (mode==="media");
    var vals = showMed ? totals.map((v,i)=> avg(v, counts[i]||1)) : totals.slice();
    var ctx=document.getElementById(canvasId).getContext("2d");
    var inst = new window.Chart(ctx, {
      type:"bar",
      data:{ labels:labels, datasets:[{ data:vals }] },
      options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
    return inst;
  }

  function drawTop(labels, totals, counts, mode){
    var showMed = (mode==="media");
    var vals = showMed ? totals.map((v,i)=> avg(v, counts[i]||1)) : totals.slice();
    var ctx=document.getElementById("cTop").getContext("2d");
    chartTop = destroyChart(chartTop);
    chartTop = new window.Chart(ctx, {
      type:"bar",
      data:{ labels:labels, datasets:[{ data:vals }] },
      options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ x:{ beginAtZero:true } } }
    });
  }

  // ===== Fluxo principal =====
  async function recarregar(){
    const myRun = ++runId;
    try{
      // define janela baseada no último dia do banco
      if(!maxDiaISO) await fetchLimites();
      if(!maxDiaISO) throw new Error("Sem limites de data no banco.");

      var psISO = dini.value || ""; var peISO = dfim.value || "";
      var s,e;
      if(psISO && peISO){
        var s0 = snapToAvailable(psISO), e0 = snapToAvailable(peISO);
        if(s0!==psISO){ log("[Ajuste] 'De' ajustado para "+s0+" (dia válido)."); dini.value=s0; }
        if(e0!==peISO){ log("[Ajuste] 'Até' ajustado para "+e0+" (dia válido)."); dfim.value=e0; }
        s = parseISO(dini.value); e = parseISO(dfim.value);
      }else{
        // período rápido ancorado no maxDia do banco
        var end = parseISO(maxDiaISO);
        var days = Number(pr.value)||30;
        var start = addDays(end, -(days-1));
        s=start; e=end;
        dini.value = toISO(s); dfim.value = toISO(e);
      }
      var startISO = toISO(s), endISO = toISO(e);
      periodoTxt.textContent = "Período: "+startISO+" → "+endISO;

      // filtros
      var lojas = Array.prototype.filter.call(chipLojas.children, c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      var filtros = {
        turno: Array.from(turno.selectedOptions).map(o=>o.value),
        canal: Array.from(canal.selectedOptions).map(o=>o.value),
        pag:   Array.from(pag.selectedOptions).map(o=>o.value),
        canc:  (canc.value||"Todos")
      };
      var uniVal = selUni.value || "Todas";
      log("[Query] "+TABLE+" | "+startISO+" → "+endISO+" | UNI="+uniVal+" | lojas="+(lojas.join(",")||"Todas"));

      // coleta atual
      var fields = "dia,unidade,pedidos,fat,des,fre,\"Nome da Loja\",turno,\"Canal de venda\",pagamento,cancelado,hora";
      var cur = await fetchPaged(fields, startISO, endISO, uniVal==="Todas"? null: uniVal, lojas, filtros);
      if(myRun!==runId) return;
      log("[OK] Linhas (atual): "+cur.length.toLocaleString("pt-BR"));

      // janela anterior
      var daysLen = Math.max(1, Math.round((parseISO(endISO)-parseISO(startISO))/(24*3600*1000))+1);
      var prevEnd   = addDays(parseISO(startISO), -1);
      var prevStart = addDays(prevEnd, -(daysLen-1));
      var prevStartISO = toISO(prevStart), prevEndISO = toISO(prevEnd);
      var ant = await fetchPaged(fields, prevStartISO, prevEndISO, uniVal==="Todas"? null: uniVal, lojas, filtros);
      if(myRun!==runId) return;
      log("[Query ant] "+prevStartISO+" → "+prevEndISO+" | Linhas: "+ant.length.toLocaleString("pt-BR"));

      // popula select dinâmicos (canal/pagamento) na 1ª carga do período
      if(canal.options.length===0 || pag.options.length===0){
        var all = await fetchPaged("dia,\"Canal de venda\",pagamento", minDiaISO, maxDiaISO, null, null, { });
        var canals = Array.from(new Set((all||[]).map(r=>r["Canal de venda"]).filter(Boolean))).sort();
        var pags   = Array.from(new Set((all||[]).map(r=>r["pagamento"]).filter(Boolean))).sort();
        canals.forEach(v=>{ var o=document.createElement("option"); o.value=v; o.textContent=v; canal.appendChild(o); });
        pags.forEach(v=>{ var o=document.createElement("option"); o.value=v; o.textContent=v; pag.appendChild(o); });
      }

      // ==== KPIs
      updateKPI(cur, ant);

      // ==== LINE: receita diária
      var byDay = groupBy(cur, r=>r.dia, r=>Number(r.fat||0));
      var byDayPrev = groupBy(ant, r=>r.dia, r=>Number(r.fat||0));
      drawLine(byDay.labels, byDay.values, byDayPrev.values);

      // ==== DOW FAT / PED
      var useLiq = false; // KPIs já mostram líquido; aqui usamos fat bruto para leitura comparativa
      var dowFat = groupByDow(cur, r=> Number(r.fat||0) - (useLiq? Number(r.fre||0): 0) );
      chartDowFat = destroyChart(chartDowFat);
      chartDowFat = drawBar("cDowFat", dowFat.labels, dowFat.totals, dowFat.counts, dowMode);

      var dowPed = groupByDow(cur, r=> Number(r.pedidos||0));
      chartDowPed = destroyChart(chartDowPed);
      chartDowPed = drawBar("cDowPed", dowPed.labels, dowPed.totals, dowPed.counts, dowPedMode);

      // ==== HORA (oculta horas pouco ativas)
      var hour = groupByHour(cur, r=> Number(r.fat||0));
      chartHour = destroyChart(chartHour);
      (function(){
        var ctx=document.getElementById("cHour").getContext("2d");
        var showMed = (hourMode==="media");
        var vals = showMed ? hour.totals.map((v,i)=>avg(v, hour.counts[i]||1)) : hour.totals.slice();
        chartHour = new window.Chart(ctx, {
          type:"bar",
          data:{ labels:hour.labels, datasets:[{ data:vals }] },
          options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
        });
      })();

      // ==== MÊS
      var month = groupByMonth(cur, r=> Number(r.fat||0));
      chartMonth = destroyChart(chartMonth);
      chartMonth = drawBar("cMonth", month.labels, month.totals, month.counts, monMode);

      // ==== TOP 10 LOJAS (e chips)
      var byLoja = {};
      cur.forEach(r=>{
        var n=r["Nome da Loja"]; if(!n) return;
        byLoja[n]=(byLoja[n]||0)+Number(r.fat||0);
      });
      var top = Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
      var topLabels = top.map(x=>x[0]);
      var topTotals = top.map(x=>x[1]);
      var topCounts = top.map(_=> (new Set(cur.map(r=>r.dia)).size) ); // média por dia do período
      drawTop(topLabels, topTotals, topCounts, topMode);

      // chips (só monta na 1ª vez ou se vazio)
      if(chipLojas.children.length===0){
        chipLojas.innerHTML="";
        topLabels.forEach(lbl=>{
          var chip=document.createElement("span");
          chip.className="chip"; chip.textContent=lbl; chip.setAttribute("data-v", lbl);
          chip.addEventListener("click", function(){ chip.classList.toggle("active"); recarregarDebounced(); });
          chipLojas.appendChild(chip);
        });
      }

    }catch(e){
      console.error(e);
      log("[ERRO] "+(e.message||String(e)));
    }
  }
  var recarregarDebounced = debounce(recarregar, 120);

  async function boot(){
    log("[Boot] v18.0-ops — filtros alinhados, sombra, médias corretas e import CSV");

    await fetchLimites();
    // ancorar período rápido no max dia do banco
    var end = parseISO(maxDiaISO);
    var start = addDays(end, -29);
    dini.value = toISO(start); dfim.value = toISO(end);

    var opts = await fetchUnidades();
    selUni.innerHTML=""; opts.forEach(function(u){ var o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); });
    selUni.value="Todas";

    // eventos que disparam recarga
    [selUni, dini, dfim, pr, turno, canal, pag, canc].forEach(el=>{
      el.addEventListener("change", function(){
        // ao aplicar (qualquer mudança), recolhe box
        document.getElementById("fx").open=false;
        recarregarDebounced();
      });
    });

    wirePills();
    await recarregar();
  }

  // ===== Importação (Admin) =====
  async function importDirectCSV(rows){
    // IMPORTAÇÃO DIRETA (fallback) — em lotes
    log("[Import] Iniciando import direto (fallback). Linhas: "+rows.length.toLocaleString("pt-BR"));
    var prog=document.getElementById("prog"); prog.style.display="inline-block"; prog.value=0;

    // 1) cria/limpa staging
    try{
      await supa.rpc('void'); // no-op se existir; ignora
    }catch(_){}
    // vamos truncar via delete (anon não executa TRUNCATE)
    await supa.from(STAGING).delete().neq('dia', null);

    // 2) insere em lotes
    var chunk=2000, total=rows.length, done=0;
    for(var i=0;i<rows.length;i+=chunk){
      var slice = rows.slice(i, i+chunk).map(r=>({
        dia: r.dia, unidade: r.unidade, pedidos: Number(r.pedidos)||0, fat: Number(r.fat)||0, des: Number(r.des)||0, fre: Number(r.fre)||0,
        "Nome da Loja": r["Nome da Loja"], turno: r.turno, "Canal de venda": r["Canal de venda"], pagamento: r.pagamento, cancelado: r.cancelado, hora: r.hora!==""? Number(r.hora): null
      }));
      var ins = await supa.from(STAGING).insert(slice);
      if(ins.error){ throw ins.error; }
      done += slice.length; prog.value = Math.round(done/total*100);
    }

    // 3) pedir para a Edge Function promover staging -> final (MV refresh ou copy p/ tabela)
    if(FUNCTION_URL){
      log("[Import] Pedindo promoção via Function…");
      try{
        var resp = await fetch(FUNCTION_URL, { method:"POST", headers:{"Content-Type":"application/json","Authorization":"Bearer "+SUPABASE_ANON}, body: JSON.stringify({ action:"promote" }) });
        var txt = await resp.text();
        log("[Function] "+txt);
      }catch(err){
        log("[Function ERRO] "+(err.message||err));
      }
    }else{
      log("[Aviso] FUNCTION_URL não configurada — atualize manualmente sua MV/Tabela no backend.");
    }

    prog.style.display="none";
    await fetchLimites(); // limites podem mudar
    await recarregar();
    log("[Import] Concluído.");
  }

  document.getElementById("btnImport").addEventListener("click", async function(){
    var f = document.getElementById("csvfile").files[0];
    if(!f){ alert("Selecione o arquivo CSV (Pasta2.csv)"); return; }

    // Preferência: mandar para Edge Function (rápida e segura)
    if(FUNCTION_URL){
      log("[Import] Enviando arquivo para Edge Function…");
      var fd = new FormData(); fd.append("file", f);
      try{
        var resp = await fetch(FUNCTION_URL, { method:"POST", headers:{ "Authorization":"Bearer "+SUPABASE_ANON }, body: fd });
        var txt = await resp.text();
        log("[Function] "+txt);
        await fetchLimites(); await recarregar();
        return;
      }catch(e){ log("[Function ERRO] "+(e.message||e)); /* cai pro fallback */ }
    }

    // Fallback: parse local com PapaParse e insere em lotes
    log("[Import] Function não configurada. Usando import local (pode ser lento para 58MB).");
    Papa.parse(f, {
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: function(res){
        importDirectCSV(res.data);
      },
      error: function(err){ log("[CSV ERRO] "+(err.message||err)); }
    });
  });

  // Boot
  boot();
})();
</script>

<!-- =============== NOTAS PARA O BACKEND (OPCIONAL, RECOMENDADO) =================
Edge Function (import_csv) — Deno

// supabase functions new import_csv
// supabase functions deploy import_csv
// No Dashboard (Project Settings -> Functions), defina a env SUPABASE_SERVICE_ROLE_KEY

import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

serve(async (req) => {
  const url = new URL(req.url);
  const supa = createClient(Deno.env.get("SUPABASE_URL")!, Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!);
  const tableStaging = "vendas_kpi_daily_v2_data";
  const tableFinal = "vendas_kpi_daily_v2"; // MV ou Tabela

  // CORS simples
  const headers = { "access-control-allow-origin": "*", "access-control-allow-headers": "authorization, content-type" };
  if (req.method === "OPTIONS") return new Response("ok", { headers });

  if (req.method === "POST" && req.headers.get("content-type")?.includes("multipart/form-data")) {
    // Upload CSV -> Storage (temporário) -> COPY via SQL (rápido)
    const form = await req.formData();
    const file = form.get("file");
    if (!(file instanceof File)) return new Response("Arquivo ausente", { status:400, headers });

    // Salva no Storage opcionalmente, ou usa streaming direto (dependendo do seu plano)
    // Aqui, por simplicidade, faremos parse parcial (cuidado com 58MB: prefira COPY na prática)

    // TRUNCATE staging
    await supa.rpc('exec_sql', { sql: `TRUNCATE ${tableStaging};` }).catch(()=>{});

    // *** SUGESTÃO real: suba para Storage e rode um SQL: COPY staging FROM 'gs://...' com extensão/privado. ***

    return new Response("Recebido. Agora rode a ação 'promote'.", { headers });
  }

  if (req.method === "POST" && url.pathname.endsWith("/import_csv")) {
    return new Response("Use POST multipart/form-data com campo 'file'", { status:400, headers });
  }

  if (req.method === "POST") {
    // promote: se final for MV -> REFRESH; se for tabela -> TRUNCATE + INSERT
    const q = await supa.from("pg_class").select("relkind").eq("relname", tableFinal).single();
    const kind = (q.data && q.data.relkind) || null;

    if (kind === "m") {
      await supa.rpc('exec_sql', { sql: `REFRESH MATERIALIZED VIEW ${tableFinal};` });
      return new Response("MV atualizada (refresh).", { headers });
    } else if (kind === "r") {
      await supa.rpc('exec_sql', { sql: `
        TRUNCATE ${tableFinal};
        INSERT INTO ${tableFinal}
        (dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora)
        SELECT dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora
        FROM ${tableStaging};
      `});
      return new Response("Tabela final atualizada a partir do staging.", { headers });
    } else {
      return new Response("Objeto final não encontrado.", { status:404, headers });
    }
  }

  return new Response("OK", { headers });
});

// SQL helper (RPC) para executar comandos administrativos com role da Function
-- no SQL Editor do Studio, crie:
-- CREATE OR REPLACE FUNCTION public.exec_sql(sql text) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
-- BEGIN EXECUTE sql; END; $$;
-- GRANT EXECUTE ON FUNCTION public.exec_sql(text) TO anon;
============================================================================= -->
</html>
