<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapear colunas ↔ filtros (1com sugestões)</title>
<style>
  :root{
    --bg:#0f1320; --card:#14192b; --muted:#8aa1b1; --text:#e7eef5; --accent:#5b9dff; --border:#22304a;
    --good:#53d769; --warn:#ffd166; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text)}
  .wrap{max-width:1100px; margin:28px auto; padding:0 16px}
  h1{margin:0 0 8px; font-size:24px}
  .sub{color:var(--muted); margin-bottom:18px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media (max-width:960px){ .row{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
  .mapping-grid{display:grid; grid-template-columns:1.2fr 1fr; gap:10px; align-items:center}
  label{font-size:13px; color:var(--muted)}
  select, textarea, input[type=text]{width:100%; background:#0c1122; border:1px solid var(--border); color:var(--text); border-radius:10px; padding:10px; outline:none}
  textarea{min-height:120px; font-family:ui-monospace,Consolas,Menlo,monospace; resize:vertical}
  .btn{background:#1a2742; color:var(--text); border:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{background:var(--accent); border-color:#4b8dea; color:#041733}
  .btn.good{background:var(--good); color:#05250d; border-color:#45b65d}
  .btn.warn{background:var(--warn); color:#222; border-color:#d7b356}
  .btn.bad{background:var(--bad); color:#fff; border-color:#e45c5c}
  .flex{display:flex; gap:10px; flex-wrap:wrap}
  .k{font-family:ui-monospace,Consolas,Menlo,monospace; padding:2px 6px; border-radius:6px; background:#0c1122; border:1px solid var(--border)}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#0c1122; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px}
  .list{display:flex; flex-wrap:wrap; gap:6px}
  .info{border:1px dashed var(--border); padding:10px; border-radius:12px; color:var(--muted)}
  .ok{color:var(--good)} .err{color:var(--bad)} .hint{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Mapear colunas do banco ↔ filtros</h1>
  <div class="sub">
    Agora, mesmo sem amostra, os selects já vêm com <b>opções sugeridas</b>.  
    Salva em <span class="k">localStorage</span> (chaves <span class="k">colmap_v1</span> e <span class="k">colnames_v1</span>).
  </div>

  <div class="card" style="margin-bottom:16px">
    <div class="flex">
      <button class="btn primary" id="btnSave">Salvar mapeamento</button>
      <button class="btn" id="btnExport">Exportar JSON</button>
      <button class="btn" id="btnImport">Importar JSON</button>
      <button class="btn warn" id="btnValidate">Validar</button>
      <button class="btn bad" id="btnReset">Resetar p/ padrão</button>
    </div>
    <div id="infoBox" class="info" style="margin-top:10px; display:none"></div>
  </div>

  <div class="row">
    <div class="card">
      <h3 style="margin:0 0 10px">1) Mapeie os campos</h3>
      <div id="mapGrid" class="mapping-grid"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">2) Diga ao sistema quais colunas existem</h3>

      <div class="flex" style="margin-bottom:8px">
        <button class="btn good" id="btnFillSuggestions">Preencher com sugestões</button>
        <button class="btn" id="btnFromComma">Informar lista (vírgulas)</button>
        <button class="btn" id="btnFromSample">Colar amostra JSON (1 linha)</button>
        <button class="btn" id="btnClearCols">Limpar colunas</button>
      </div>

      <div class="flex" style="margin-bottom:12px">
        <input type="text" id="inpAddCol" placeholder="Adicionar coluna manualmente (ex.: canal)"/>
        <button class="btn" id="btnAddCol">Adicionar</button>
      </div>

      <details id="detComma" style="margin-bottom:10px">
        <summary>Colar nomes separados por vírgula</summary>
        <textarea id="taCols" placeholder="dia, hora, unidade, loja, canal, pagamento_base, turno, cancelado, pedidos, fat, des, fre, pedido_id, row_key"></textarea>
        <div class="flex" style="margin-top:8px"><button class="btn good" id="btnApplyCols">Aplicar</button></div>
      </details>

      <details id="detSample" style="margin-bottom:10px">
        <summary>Colar amostra JSON (objeto de 1 linha)</summary>
        <textarea id="taSample" placeholder='{"dia":"2025-08-15","unidade":"Uni.Raja","loja":"Loja A","canal":"iFood","pagamento_base":"Pix","turno":"Dia","cancelado":"Não","pedidos":10,"fat":100,"des":10,"fre":5,"pedido_id":"A1"}'></textarea>
        <div class="flex" style="margin-top:8px"><button class="btn good" id="btnApplySample">Extrair chaves</button></div>
      </details>

      <div class="sub">Colunas detectadas:</div>
      <div id="colsList" class="list"></div>

      <hr style="border-color:var(--border); margin:14px 0"/>
      <h3 style="margin:0 0 8px">Diagnóstico</h3>
      <div id="diagBox" class="sub">—</div>
      <details>
        <summary>JSON do mapeamento</summary>
        <pre id="preMap" style="margin-top:8px"></pre>
      </details>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin-top:0">Como usar no seu dashboard</h3>
<pre><code>// Lê o mapeamento salvo
const map = getMap();           // { dia: 'dia', unid: 'unidade', ... }
const colUnidade = getCol('unid');

// Payload típico para sua RPC
const payload = {
  p_dini: '2025-08-15',
  p_dfim: '2025-08-20',
  p_unids: ['Uni.Raja'],
  p_lojas: null,
  p_turnos: null,
  p_canais: null,
  p_pags: null,
  p_cancelado: 'Não'
};
const ready = applyMapToPayload(payload); // se quiser ajustar valores
</code></pre>
  </div>
</div>

<script>
/* ===== Config & defaults ===== */
const STORAGE_KEY = 'colmap_v1';
const COLS_KEY    = 'colnames_v1';

const FIELDS = [
  { key:'dia',        label:'Data da venda (dia)',  required:true },
  { key:'hora',       label:'Hora (opcional)',      required:false },
  { key:'unid',       label:'Unidade',              required:true },
  { key:'loja',       label:'Nome/Código da Loja',  required:false },
  { key:'canal',      label:'Canal de Venda',       required:false },
  { key:'pag',        label:'Pagamento Base',       required:false },
  { key:'turno',      label:'Turno',                required:false },
  { key:'cancelado',  label:'Está Cancelado',       required:true },
  { key:'ped',        label:'Pedidos (qtd)',        required:false },
  { key:'fat',        label:'Faturamento',          required:false },
  { key:'des',        label:'Desconto',             required:false },
  { key:'fre',        label:'Entrega (frete)',      required:false },
  { key:'pedido_id',  label:'Pedido ID (opcional)', required:false },
  { key:'row_key',    label:'Row Key/Hash (opt.)',  required:false },
];

const DEFAULT_MAP = {
  dia:'dia', hora:'hora', unid:'unidade', loja:'loja',
  canal:'canal', pag:'pagamento_base', turno:'turno',
  cancelado:'cancelado', ped:'pedidos', fat:'fat', des:'des', fre:'fre',
  pedido_id:'pedido_id', row_key:'row_key'
};
const SUGGESTED_COLS = Array.from(new Set(Object.values(DEFAULT_MAP)));

/* ===== State & helpers ===== */
let mapping  = loadMap();
let colnames = loadCols();

/* Se não houver colunas salvas, pré-preenche com sugestões */
if (!colnames.length) {
  colnames = [...SUGGESTED_COLS];
  saveCols();
  showInfo('Não havia colunas detectadas. Preenchi as opções com <b>colunas sugeridas</b> (dia, hora, unidade, loja, canal, pagamento_base, turno, cancelado, pedidos, fat, des, fre, pedido_id, row_key). Você pode adicionar/remover à vontade.');
}

/* APIs públicas p/ o dashboard */
window.getMap  = () => ({...mapping});
window.setMap  = (m) => { mapping = {...mapping, ...m}; saveMap(); renderAll(); };
window.getCol  = (k) => mapping?.[k] ?? null;
window.setAvailableColumns = (cols) => { colnames = uniq((cols||[]).map(s=>String(s))); saveCols(); renderAll(); };
window.applyMapToPayload = (p) => ({...p}); // hook para ajustes se precisar

/* Storage */
function loadMap(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {...DEFAULT_MAP}; }catch{ return {...DEFAULT_MAP}; } }
function saveMap(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(mapping)); }
function loadCols(){ try{ return JSON.parse(localStorage.getItem(COLS_KEY)) || []; }catch{ return []; } }
function saveCols(){ localStorage.setItem(COLS_KEY, JSON.stringify(colnames)); }

/* ===== UI rendering ===== */
const $mapGrid = document.getElementById('mapGrid');
const $colsList = document.getElementById('colsList');
const $diagBox = document.getElementById('diagBox');
const $preMap = document.getElementById('preMap');
const $infoBox = document.getElementById('infoBox');

function renderMapping(){
  $mapGrid.innerHTML = '';
  FIELDS.forEach(f=>{
    const d1 = document.createElement('div');
    const lab = document.createElement('label');
    lab.textContent = (f.required?'★ ':'') + f.label;
    d1.appendChild(lab);

    const d2 = document.createElement('div');
    const sel = document.createElement('select');
    sel.dataset.key = f.key;

    const opts = ['','-- (vazio) --', ...colnames];
    opts.forEach(name=>{
      const val = name===''?'':(name==='-- (vazio) --'?'':name);
      const o = document.createElement('option');
      o.value = val;
      o.textContent = name===''?'—':name;
      if ((mapping[f.key]||'') === val) o.selected = true;
      sel.appendChild(o);
    });

    sel.addEventListener('change', ()=>{
      mapping[f.key] = sel.value || '';
      saveMap();
      renderDiag();
      renderMapJson();
    });
    d2.appendChild(sel);

    $mapGrid.appendChild(d1);
    $mapGrid.appendChild(d2);
  });
}
function renderCols(){
  $colsList.innerHTML = '';
  if (!colnames.length){
    const span = document.createElement('span');
    span.className='sub';
    span.textContent = '— nenhuma coluna informada ainda —';
    $colsList.appendChild(span);
    return;
  }
  colnames.forEach(c=>{
    const p = document.createElement('div');
    p.className='pill';
    p.textContent = c;
    $colsList.appendChild(p);
  });
}
function renderDiag(){
  const {errors,warns} = validateMap();
  if(errors.length===0 && warns.length===0){
    $diagBox.innerHTML = '<span class="ok">✔ Mapeamento consistente.</span>'; return;
  }
  let html='';
  if(errors.length){ html += `<div class="err"><b>Erros:</b><ul>${errors.map(e=>`<li>${esc(e)}</li>`).join('')}</ul></div>`; }
  if(warns.length){ html += `<div class="hint"><b>Avisos:</b><ul>${warns.map(e=>`<li>${esc(e)}</li>`).join('')}</ul></div>`; }
  $diagBox.innerHTML = html;
}
function renderMapJson(){ $preMap.textContent = JSON.stringify(mapping, null, 2); }
function renderAll(){ renderMapping(); renderCols(); renderDiag(); renderMapJson(); }

/* ===== Validation ===== */
function validateMap(){
  const errors=[], warns=[];
  FIELDS.filter(f=>f.required).forEach(f=>{ if(!mapping[f.key]) errors.push(`Campo obrigatório "${f.label}" não mapeado.`); });
  const used = {};
  Object.entries(mapping).forEach(([k,v])=>{ if(!v) return; (used[v]??=[]).push(k); });
  Object.entries(used).forEach(([c,keys])=>{ if(keys.length>1) warns.push(`Coluna "${c}" usada por ${keys.length} campos (${keys.join(', ')}).`); });
  Object.entries(mapping).forEach(([k,v])=>{ if(v && !colnames.includes(v)) warns.push(`Coluna "${v}" (para ${k}) não está na lista de colunas disponíveis.`); });
  return {errors,warns};
}

/* ===== Controls ===== */
document.getElementById('btnSave').onclick = ()=>{ saveMap(); renderDiag(); alert('Mapeamento salvo ✅'); };
document.getElementById('btnValidate').onclick = ()=>{
  const {errors,warns}=validateMap();
  if(!errors.length && !warns.length) alert('Tudo certo ✅'); else alert(`Veja o diagnóstico na tela.\nErros: ${errors.length} • Avisos: ${warns.length}`);
};
document.getElementById('btnReset').onclick = ()=>{
  if(!confirm('Resetar para o padrão?')) return;
  mapping = {...DEFAULT_MAP};
  saveMap(); renderAll();
};
document.getElementById('btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(mapping,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='colmap.json'; a.click(); URL.revokeObjectURL(url);
};
document.getElementById('btnImport').onclick = ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async()=>{ const f=inp.files?.[0]; if(!f)return; const txt=await f.text();
    try{ const j=JSON.parse(txt); mapping={...mapping,...j}; saveMap(); renderAll(); }catch{ alert('JSON inválido.'); }
  }; inp.click();
};
document.getElementById('btnFillSuggestions').onclick = ()=>{
  setAvailableColumns(SUGGESTED_COLS);
  alert('Sugestões aplicadas.');
};
document.getElementById('btnFromComma').onclick = ()=>{ document.getElementById('detComma').open = true; };
document.getElementById('btnApplyCols').onclick = ()=>{
  const raw=document.getElementById('taCols').value||'';
  const cols=uniq(raw.split(',').map(s=>s.trim()).filter(Boolean));
  if(!cols.length){ alert('Informe pelo menos 1 nome.'); return; }
  setAvailableColumns(cols); alert('Colunas aplicadas.');
};
document.getElementById('btnFromSample').onclick = ()=>{ document.getElementById('detSample').open = true; };
document.getElementById('btnApplySample').onclick = ()=>{
  const raw=document.getElementById('taSample').value||'';
  try{
    const obj=JSON.parse(raw); if(!obj || typeof obj!=='object' || Array.isArray(obj)) throw 0;
    setAvailableColumns(Object.keys(obj)); alert('Chaves extraídas.');
  }catch{ alert('JSON inválido. Cole um objeto com uma linha.'); }
};
document.getElementById('btnClearCols').onclick = ()=>{
  if(!confirm('Limpar colunas?')) return;
  setAvailableColumns([]); alert('Colunas limpas.');
};
document.getElementById('btnAddCol').onclick = ()=>{
  const name=(document.getElementById('inpAddCol').value||'').trim();
  if(!name) return alert('Digite um nome de coluna.');
  if(!colnames.includes(name)) colnames.push(name);
  saveCols(); renderAll(); document.getElementById('inpAddCol').value='';
};

/* ===== Utils ===== */
function uniq(arr){ return Array.from(new Set(arr)); }
function esc(s){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function showInfo(html){ $infoBox.innerHTML = html; $infoBox.style.display='block'; }

/* Init */
renderAll();
</script>
</body>
</html>
