<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Produtos & Fichas Técnicas</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">FT</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#7b1e3a;
      --ok:#059669; --err:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:28px}
    h2{margin:0 0 12px;font-size:20px}
    h3{margin:0 0 10px}
    .status{font-size:13px;color:var(--muted)}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active{background:#f1f5f9;font-weight:700}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
    textarea{min-height:80px}
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.pri{background:var(--pri);color:#fff;border-color:var(--pri)}
    .btn.ghost{background:#f8fafc}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
    th{background:#f8fafc}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hint{color:#64748b;font-size:12px}
    .stack{display:flex;flex-direction:column;gap:10px}
    @media (max-width:900px){.cols-2,.cols-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Produtos & Fichas Técnicas</h1>
    <div id="status" class="status">Carregando…</div>

    <div class="section">
      <div class="tabs">
        <button type="button" class="tab active" data-tab="tab-pratos">Pratos</button>
        <button type="button" class="tab" data-tab="tab-prato-rec">Componentes do Prato</button>
        <button type="button" class="tab" data-tab="tab-rec">Receitas</button>
        <button type="button" class="tab" data-tab="tab-ing">Ingredientes</button>
      </div>
    </div>

    <!-- PRATOS -->
    <div class="section" id="tab-pratos">
      <h2>Pratos</h2>
      <div class="row cols-2">
        <div class="stack">
          <div class="toolbar">
            <input id="prato-search" placeholder="Buscar prato cadastrado"/>
            <button id="btnNewPrato" class="btn">+ Novo prato</button>
          </div>
          <div style="overflow:auto">
            <table id="tblPrato">
              <thead><tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th>Ações</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="sep"></div>
          <div>
            <h3 id="pr-form-title">Novo prato</h3>
            <div class="row cols-3">
              <div><label>Nome</label><input id="pr-nome" placeholder="Ex.: Strogonoff de frango"/></div>
              <div><label>Categoria</label>
                <select id="pr-cat">
                  <option value="PRATOS">PRATOS</option>
                  <option value="ACOMPANHAMENTOS">ACOMPANHAMENTOS</option>
                  <option value="BEBIDAS">BEBIDAS</option>
                  <option value="SOBREMESA">SOBREMESA</option>
                  <option value="OUTROS">OUTROS</option>
                </select>
              </div>
              <div><label>Peso do prato</label><input id="pr-peso" inputmode="decimal" placeholder="Ex.: 500 (g ou ml)"/></div>
            </div>
            <div class="row cols-3" style="margin-top:8px">
              <div><label>Preço de venda (fator multiplicador)</label><input id="pr-preco-factor" inputmode="decimal" placeholder="Ex.: 3,2"/></div>
              <div>
                <label>Custo do prato (calculado)</label>
                <input id="pr-custo-calc" readonly style="background:#f8fafc"/>
              </div>
              <div>
                <label>Última alteração</label>
                <input id="pr-updated" readonly style="background:#f8fafc"/>
              </div>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnPrSave" class="btn pri">Salvar</button>
              <button id="btnPrCancel" class="btn ghost" style="display:none">Cancelar</button>
            </div>
            <div class="hint" id="pr-mode-hint"></div>
          </div>
        </div>

        <!-- DASHBOARD SOURCE -->
        <div class="stack">
          <h3>Pratos do Dashboard</h3>
          <div class="hint">Fonte: <code id="srcName">vendas_pratos_pratos</code> (colunas esperadas: <b>prato</b> e opcional <b>categoria</b>)</div>
          <div class="toolbar">
            <select id="fDashCat">
              <option value="">Todas as categorias</option>
              <option value="PRATOS">PRATOS</option>
              <option value="ACOMPANHAMENTOS">ACOMPANHAMENTOS</option>
              <option value="BEBIDAS">BEBIDAS</option>
              <option value="SOBREMESA">SOBREMESA</option>
              <option value="OUTROS">OUTROS</option>
              <option value="N/D">Sem categoria</option>
            </select>
            <input id="dash-search" placeholder="Buscar no dashboard"/>
            <button id="btnSyncAll" class="btn">Sincronizar todos que faltam</button>
          </div>
          <div id="dashList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- COMPONENTES DO PRATO -->
    <div class="section" id="tab-prato-rec" style="display:none">
      <h2>Componentes do Prato</h2>

      <div class="row cols-3">
        <div><label>Selecione o prato</label><select id="prc-prato"></select></div>
        <div><label>Receita</label><select id="prc-receita"></select></div>
        <div><label>Qtd por prato</label><input id="prc-qtd" inputmode="decimal" placeholder="Ex.: 220"/></div>
      </div>
      <div class="row cols-3" style="margin-top:8px">
        <div><label>Unidade</label>
          <select id="prc-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
        </div>
        <div><label>Observações</label><input id="prc-obs" placeholder="Opcional"/></div>
        <div style="align-self:end"><button id="btnAddPrComp" class="btn pri">Adicionar Receita ao Prato</button></div>
      </div>

      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblPrComp">
          <thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- RECEITAS -->
    <div class="section" id="tab-rec" style="display:none">
      <h2>Receitas</h2>

      <div class="row cols-3">
        <div><label>Selecionar receita para editar</label><select id="ri-receita"></select></div>
        <div style="align-self:end"><span class="tag">Selecione acima para carregar os itens</span></div>
      </div>

      <div class="sep"></div>
      <h3>Itens da receita selecionada</h3>
      <div class="row cols-3">
        <div><label>Tipo</label>
          <select id="ri-tipo"><option value="INGREDIENTE">Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
        </div>
        <div><label>Referência</label><select id="ri-ref"></select></div>
        <div><label>Qtd</label><input id="ri-qtd" inputmode="decimal" placeholder="Ex.: 300"/></div>
      </div>
      <div class="row cols-3" style="margin-top:8px">
        <div><label>Unidade</label>
          <select id="ri-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
        </div>
        <div><label>Perda da linha (%)</label><input id="ri-perda" inputmode="decimal" value="0"/></div>
        <div style="align-self:end"><button id="btnRiAdd" class="btn pri">Adicionar item</button></div>
      </div>

      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblRi">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <h3>Cabeçalho da receita</h3>
      <div class="row cols-3">
        <div><label>Nome</label><input id="rec-nome" placeholder="Ex.: Arroz Branco"/></div>
        <div><label>Rendimento (quantidade)</label><input id="rec-rend-qtd" inputmode="decimal" placeholder="Ex.: 1000"/></div>
        <div><label>Unidade do rendimento</label>
          <select id="rec-rend-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:8px">
        <div><label>Perda global (%)</label><input id="rec-perda" inputmode="decimal" value="0"/></div>
        <div><label>Observações</label><input id="rec-obs" placeholder="Opcional"/></div>
        <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnSaveRec" class="btn pri">Salvar alterações</button>
          <button id="btnNewRec" class="btn">Nova receita</button>
        </div>
      </div>

      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblRec">
          <thead><tr><th>Nome</th><th>Rendimento</th><th>Perda%</th><th>Itens</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- INGREDIENTES -->
    <div class="section" id="tab-ing" style="display:none">
      <h2>Ingredientes</h2>

      <div class="toolbar">
        <input id="ing-search" placeholder="Buscar"/>
        <button id="btnNewIng" class="btn">+ Novo ingrediente</button>
      </div>

      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblIng">
          <thead><tr><th>Nome</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <h3 id="ing-form-title">Novo ingrediente</h3>
      <div class="row cols-3">
        <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"/></div>
        <div><label>Unidade</label>
          <select id="ing-und"><option value="g">g</option><option value="kg" selected>kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
        </div>
        <div><label>Custo unitário</label><input id="ing-custo" inputmode="decimal" placeholder="Ex.: 0,0123"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Observações</label><textarea id="ing-obs" placeholder="Opcional"></textarea></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnSaveIng" class="btn pri">Salvar</button>
        <button id="btnCancelIng" class="btn ghost" style="display:none">Cancelar</button>
      </div>
      <div class="hint" id="ing-mode-hint"></div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  /************ CONFIG ************/
  const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Fonte de pratos do dashboard
  const DASHBOARD_PRATOS_SOURCE = 'vendas_pratos_pratos';
  const SRC_NAME_COL = 'prato';
  const SRC_CAT_COL  = 'categoria'; // opcional

  /************ HELPERS ************/
  const $ = (id)=> document.getElementById(id);
  const setStatus=(msg,cls)=>{ const el=$('status'); if(!el) return; el.textContent=msg; el.className='status'+(cls?(' '+cls):''); };
  const fmt = (n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
  const money = (n)=> 'R$ '+ new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:4}).format(+n||0);
  const ptToNumber = (v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
  const need = (id, label)=>{ const el=$(id); if(!el){ throw new Error('Elemento ausente: #'+id+' ('+label+')'); } return el; };
  const confirmDel = (msg)=> window.confirm(msg||'Confirma exclusão?');

  // conversões simples
  function toBaseUnit(qtd, un){ // retorna {value, base} onde base g/ml/un
    if(un==='kg') return {value:qtd*1000, base:'g'};
    if(un==='g')  return {value:qtd, base:'g'};
    if(un==='L')  return {value:qtd*1000, base:'ml'};
    if(un==='ml') return {value:qtd, base:'ml'};
    return {value:qtd, base:un||'un'};
  }
  function sameFamily(a,b){ const A=(a||'').toLowerCase(), B=(b||'').toLowerCase();
    if(['g','kg'].includes(A) && ['g','kg'].includes(B)) return 'g';
    if(['ml','l'].includes(A) && ['ml','l'].includes(B)) return 'ml';
    if(A==='porcao' && B==='porcao') return 'porcao';
    if(A==='un' && B==='un') return 'un';
    return null;
  }

  /************ TABS ************/
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('.section[id^="tab-"]').forEach(sec=>sec.style.display='none');
      $(id).style.display='block';
    });
  });

  /************ INGREDIENTES ************/
  let ingEditId=null;
  async function loadIngredientes(){
    const tb=$('tblIng').querySelector('tbody');
    tb.innerHTML='<tr><td colspan="5">Carregando…</td></tr>';
    const q = supa.from('ingredientes').select('id,nome,unidade,custo_unitario,ativo').order('nome',{ascending:true});
    const {data,error}=await q;
    if(error){ tb.innerHTML='<tr><td colspan="5">Erro ao carregar ingredientes</td></tr>'; setStatus(error.message,'err'); return; }
    const term = ($('ing-search').value||'').toLowerCase();
    tb.innerHTML='';
    (data||[])
      .filter(r=>!term || String(r.nome||'').toLowerCase().includes(term))
      .forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.nome||''}</td>
          <td>${r.unidade||''}</td>
          <td>${money(r.custo_unitario||0)}</td>
          <td>${r.ativo?'<span class="tag">Ativo</span>':'<span class="tag">Inativo</span>'}</td>
          <td>
            <button class="btn" data-act="ing-edit" data-id="${r.id}">Editar</button>
            <button class="btn" data-act="ing-toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
            <button class="btn" data-act="ing-del" data-id="${r.id}">Excluir</button>
          </td>`;
        tb.appendChild(tr);
      });
  }
  $('ing-search').addEventListener('input', loadIngredientes);
  $('btnNewIng').addEventListener('click', ()=>{ ingEditId=null; $('ing-form-title').textContent='Novo ingrediente'; $('btnCancelIng').style.display='none'; $('ing-mode-hint').textContent=''; $('ing-nome').value=''; $('ing-und').value='kg'; $('ing-custo').value=''; $('ing-obs').value=''; });
  $('btnCancelIng').addEventListener('click', ()=>$('btnNewIng').click());
  $('tblIng').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id, act=b.dataset.act;
    if(act==='ing-edit'){
      const {data,error}=await supa.from('ingredientes').select('*').eq('id',id).single();
      if(error){ return alert(error.message||error); }
      ingEditId=id;
      $('ing-form-title').textContent='Editar ingrediente';
      $('btnCancelIng').style.display='inline-flex';
      $('ing-mode-hint').textContent='Editando #'+id;
      $('ing-nome').value=data.nome||'';
      $('ing-und').value=data.unidade||'kg';
      $('ing-custo').value=(data.custo_unitario!=null? String(data.custo_unitario).replace('.',','):'');
      $('ing-obs').value=data.obs||'';
    }else if(act==='ing-toggle'){
      const {data}=await supa.from('ingredientes').select('ativo').eq('id',id).single();
      const {error}=await supa.from('ingredientes').update({ativo:!data.ativo}).eq('id',id);
      if(error){ return alert(error.message||error); }
      loadIngredientes();
    }else if(act==='ing-del'){
      if(!confirmDel('Excluir ingrediente?')) return;
      const {error}=await supa.from('ingredientes').delete().eq('id',id);
      if(error){ return alert(error.message||error); }
      loadIngredientes();
    }
  });
  $('btnSaveIng').addEventListener('click', async ()=>{
    const nome=$('ing-nome').value.trim();
    const unidade=$('ing-und').value;
    const custo=ptToNumber($('ing-custo').value);
    const obs=($('ing-obs').value||'').trim()||null;
    if(!nome){ return alert('Informe o nome'); }
    if(ingEditId){
      const {error}=await supa.from('ingredientes').update({nome,unidade,custo_unitario:custo,obs}).eq('id',ingEditId);
      if(error){ return alert(error.message||error); }
      setStatus('Ingrediente atualizado','ok');
    }else{
      const {error}=await supa.from('ingredientes').insert({nome,unidade,custo_unitario:custo,obs});
      if(error){ return alert(error.message||error); }
      setStatus('Ingrediente criado','ok');
    }
    $('btnNewIng').click();
    loadIngredientes();
  });

  /************ RECEITAS ************/
  let recEditId=null;
  async function loadReceitasResumo(){
    const tb=$('tblRec').querySelector('tbody');
    tb.innerHTML='<tr><td colspan="6">Carregando…</td></tr>';
    const {data,error}=await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true});
    if(error){ tb.innerHTML='<tr><td colspan="6">Crie a view v_receitas_resumo</td></tr>'; }
    else{
      tb.innerHTML='';
      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.nome}</td><td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td>
          <td>${fmt(r.perda_pct)}%</td><td>${r.itens}</td>
          <td>${r.ativo?'<span class="tag">Ativo</span>':'<span class="tag">Inativo</span>'}</td>
          <td>
            <button class="btn" data-act="rec-edit" data-id="${r.id}">Editar</button>
            <button class="btn" data-act="rec-toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
            <button class="btn" data-act="rec-del" data-id="${r.id}">Excluir</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    const {data:opt}=await supa.from('receitas').select('id,nome').eq('ativo',true).order('nome');
    const sel=$('ri-receita'); sel.innerHTML='';
    (opt||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=x.nome; sel.appendChild(o); });
    if(recEditId){ sel.value=String(recEditId); }
    loadReceitaSelecionada();
    fillOptionsFromQuery('prc-receita','receitas','id','nome',{ativo:true});
  }
  $('tblRec').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id, act=b.dataset.act;
    if(act==='rec-edit'){
      recEditId=id;
      await carregarCabecalhoReceita(id);
      $('ri-receita').value=String(id);
      loadReceitaItensTable(id);
    }else if(act==='rec-toggle'){
      const {data}=await supa.from('receitas').select('ativo').eq('id',id).single();
      const {error}=await supa.from('receitas').update({ativo:!data.ativo}).eq('id',id);
      if(error){ return alert(error.message||error); }
      loadReceitasResumo();
    }else if(act==='rec-del'){
      if(!confirmDel('Excluir receita e seus itens?')) return;
      const {error}=await supa.from('receitas').delete().eq('id',id);
      if(error){ return alert(error.message||error); }
      recEditId=null;
      loadReceitasResumo();
      clearCabecalhoReceita();
      $('tblRi').querySelector('tbody').innerHTML='';
    }
  });
  async function carregarCabecalhoReceita(id){
    const {data,error}=await supa.from('receitas').select('*').eq('id',id).single();
    if(error){ return alert(error.message||error); }
    $('rec-nome').value=data.nome||'';
    $('rec-rend-qtd').value=data.rendimento_qtd??'';
    $('rec-rend-und').value=data.unidade_rendimento||'g';
    $('rec-perda').value=data.perda_pct??'0';
    $('rec-obs').value=data.obs||'';
  }
  function clearCabecalhoReceita(){
    $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs').value='';
  }
  $('btnNewRec').addEventListener('click', ()=>{ recEditId=null; clearCabecalhoReceita(); $('ri-receita').value=''; $('tblRi').querySelector('tbody').innerHTML=''; });
  $('btnSaveRec').addEventListener('click', async ()=>{
    const payload={
      nome:$('rec-nome').value.trim(),
      rendimento_qtd:ptToNumber($('rec-rend-qtd').value),
      unidade_rendimento:$('rec-rend-und').value,
      perda_pct:ptToNumber($('rec-perda').value),
      obs:($('rec-obs').value||'').trim()||null
    };
    if(!payload.nome || !payload.rendimento_qtd){ return alert('Informe nome e rendimento'); }
    if(recEditId){
      const {error}=await supa.from('receitas').update(payload).eq('id',recEditId);
      if(error){ return alert(error.message||error); }
      setStatus('Receita atualizada','ok');
    }else{
      const {data,error}=await supa.from('receitas').insert(payload).select('id').single();
      if(error){ return alert(error.message||error); }
      recEditId=data.id;
      $('ri-receita').value=String(recEditId);
      setStatus('Receita criada','ok');
    }
    loadReceitasResumo();
  });

  async function fillOptionsFromQuery(selectId, table, valKey, labelKey, whereEq){
    const sel=$(selectId); if(!sel) return;
    let q=supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true});
    if(whereEq){ Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v)); }
    const {data,error}=await q;
    if(error){ sel.innerHTML=''; return; }
    sel.innerHTML='';
    (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
  }

  async function loadRefOptionsForTipo(){
    const tipo=$('ri-tipo').value;
    if(tipo==='INGREDIENTE'){ await fillOptionsFromQuery('ri-ref','ingredientes','id','nome',{ativo:true}); }
    else{ await fillOptionsFromQuery('ri-ref','receitas','id','nome',{ativo:true}); }
  }
  $('ri-tipo').addEventListener('change', loadRefOptionsForTipo);

  async function loadReceitaItensTable(receitaId){
    const id = receitaId || $('ri-receita').value;
    const tb=$('tblRi').querySelector('tbody');
    tb.innerHTML='';
    if(!id){ return; }
    const {data,error}=await supa.from('receita_itens').select('*').eq('receita_id',id);
    if(error){ tb.innerHTML='<tr><td colspan="6">Erro ao listar itens</td></tr>'; return; }
    for(const it of (data||[])){
      let nome='—';
      if(it.tipo==='INGREDIENTE'){ const {data:ing}=await supa.from('ingredientes').select('nome').eq('id',it.ref_id).single(); nome=ing?.nome||'(ingrediente removido)'; }
      else{ const {data:rec}=await supa.from('receitas').select('nome').eq('id',it.ref_id).single(); nome=rec?.nome||'(receita removida)'; }
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${it.tipo}</td>
        <td>${nome}</td>
        <td><input data-k="qtd" data-id="${it.id}" value="${it.qtd}"/></td>
        <td>
          <select data-k="unidade" data-id="${it.id}">
            ${['g','kg','ml','L','un','porcao'].map(u=>`<option value="${u}" ${u===it.unidade?'selected':''}>${u}</option>`).join('')}
          </select>
        </td>
        <td><input data-k="perda_pct" data-id="${it.id}" value="${it.perda_pct||0}"/></td>
        <td>
          <button class="btn" data-act="ri-save" data-id="${it.id}">Salvar</button>
          <button class="btn" data-act="ri-del" data-id="${it.id}">Remover</button>
        </td>`;
      tb.appendChild(tr);
    }
  }
  function loadReceitaSelecionada(){ const id=$('ri-receita').value; if(!id){ $('tblRi').querySelector('tbody').innerHTML=''; clearCabecalhoReceita(); return; } recEditId=id; carregarCabecalhoReceita(id); loadReceitaItensTable(id); }
  $('ri-receita').addEventListener('change', loadReceitaSelecionada);
  $('tblRi').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id, act=b.dataset.act;
    if(act==='ri-del'){
      if(!confirmDel('Remover item da receita?')) return;
      const {error}=await supa.from('receita_itens').delete().eq('id',id);
      if(error){ return alert(error.message||error); }
      loadReceitaItensTable();
    }else if(act==='ri-save'){
      const inputs=[...document.querySelectorAll('[data-id="'+id+'"]')].reduce((acc,el)=>{ acc[el.dataset.k]=el.value; return acc; },{});
      const payload={ qtd:ptToNumber(inputs.qtd), unidade:inputs.unidade, perda_pct:ptToNumber(inputs.perda_pct) };
      const {error}=await supa.from('receita_itens').update(payload).eq('id',id);
      if(error){ return alert(error.message||error); }
      setStatus('Linha atualizada','ok');
    }
  });

  /************ PRATOS ************/
  let prEditId=null;
  let pratosHasExtraCols = { preco_factor:true, peso_prato:true, updated_at:true }; // detectaremos dinamicamente
  function resetPrForm(){ prEditId=null; $('pr-form-title').textContent='Novo prato'; $('pr-mode-hint').textContent=''; $('btnPrCancel').style.display='none';
    $('pr-nome').value=''; $('pr-cat').value='PRATOS'; $('pr-peso').value=''; $('pr-preco-factor').value=''; $('pr-custo-calc').value=''; $('pr-updated').value='';
  }
  $('btnNewPrato').addEventListener('click', resetPrForm);
  $('btnPrCancel').addEventListener('click', resetPrForm);

  async function loadPratos(){
    const tb=$('tblPrato').querySelector('tbody');
    tb.innerHTML='<tr><td colspan="5">Carregando…</td></tr>';
    const {data,error}=await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true});
    if(error){ tb.innerHTML='<tr><td colspan="5">Crie a view v_pratos_resumo</td></tr>'; }
    else{
      const term=($('prato-search').value||'').toLowerCase();
      tb.innerHTML='';
      (data||[]).filter(p=>!term || String(p.nome||'').toLowerCase().includes(term))
      .forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${p.nome}</td><td>${p.categoria||'—'}</td><td>${p.receitas||0}</td>
          <td>${p.ativo?'<span class="tag">Ativo</span>':'<span class="tag">Inativo</span>'}</td>
          <td>
            <button class="btn" data-act="pr-edit" data-id="${p.id}">Editar</button>
            <button class="btn" data-act="pr-toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
            <button class="btn" data-act="pr-del" data-id="${p.id}">Excluir</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    fillOptionsFromQuery('prc-prato','pratos','id','nome',{ativo:true});
  }
  $('prato-search').addEventListener('input', loadPratos);
  $('tblPrato').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.dataset.id, act=b.dataset.act;
    if(act==='pr-edit'){
      // tentar buscar colunas extras também
      let cols='id,nome,categoria,preco_factor,peso_prato,updated_at';
      let res=await supa.from('pratos').select(cols).eq('id',id).single();
      if(res.error && String(res.error.message||'').includes('column')){ // sem as extras
        pratosHasExtraCols.preco_factor=false; pratosHasExtraCols.peso_prato=false; pratosHasExtraCols.updated_at=false;
        res=await supa.from('pratos').select('id,nome,categoria').eq('id',id).single();
      }
      if(res.error){ return alert(res.error.message||res.error); }
      const data=res.data;
      prEditId=id; $('pr-form-title').textContent='Editar prato'; $('btnPrCancel').style.display='inline-flex'; $('pr-mode-hint').textContent='Editando #'+id;
      $('pr-nome').value=data.nome||''; $('pr-cat').value=data.categoria||'PRATOS';
      $('pr-preco-factor').value = (data.preco_factor!=null? String(data.preco_factor).replace('.',',') : '');
      $('pr-peso').value = (data.peso_prato!=null? String(data.peso_prato).replace('.',',') : '');
      $('pr-updated').value = data.updated_at ? new Date(data.updated_at).toLocaleString('pt-BR') : '';
      await updatePratoCustoCalculado(id);
    }else if(act==='pr-toggle'){
      const {data}=await supa.from('pratos').select('ativo').eq('id',id).single();
      const {error}=await supa.from('pratos').update({ativo:!data.ativo}).eq('id',id);
      if(error){ return alert(error.message||error); }
      loadPratos();
    }else if(act==='pr-del'){
      if(!confirmDel('Excluir prato?')) return;
      const {error}=await supa.from('pratos').delete().eq('id',id);
      if(error){ return alert(error.message||error); }
      loadPratos();
    }
  });
  $('btnPrSave').addEventListener('click', async ()=>{
    const nome=$('pr-nome').value.trim(); const categoria=$('pr-cat').value;
    const preco_factor=ptToNumber($('pr-preco-factor').value);
    const peso_prato=ptToNumber($('pr-peso').value);
    if(!nome){ return alert('Informe o nome'); }
    // monta payload dinamicamente para não quebrar se colunas não existirem
    const payload={nome,categoria};
    if(pratosHasExtraCols.preco_factor) payload.preco_factor = isNaN(preco_factor)? null : preco_factor;
    if(pratosHasExtraCols.peso_prato) payload.peso_prato = isNaN(peso_prato)? null : peso_prato;
    if(prEditId){
      let res=await supa.from('pratos').update(payload).eq('id',prEditId);
      if(res.error && String(res.error.message||'').includes('column')){ // salva só as básicas
        await supa.from('pratos').update({nome,categoria}).eq('id',prEditId);
      }else if(res.error){ return alert(res.error.message||res.error); }
      setStatus('Prato atualizado','ok');
      await updatePratoCustoCalculado(prEditId);
    }else{
      let res=await supa.from('pratos').insert(payload);
      if(res.error && String(res.error.message||'').includes('column')){
        res=await supa.from('pratos').insert({nome,categoria});
      }
      if(res.error){ return alert(res.error.message||res.error); }
      setStatus('Prato criado','ok');
    }
    resetPrForm(); loadPratos();
  });

  /************ CUSTO DO PRATO (cálculo) ************/
  const recCostCache = new Map();
  async function calcReceitaCost(receita_id){
    if(recCostCache.has(receita_id)) return recCostCache.get(receita_id);
    const rec = await supa.from('receitas').select('*').eq('id',receita_id).single();
    if(rec.error) throw rec.error;
    const R = rec.data;
    const itens = await supa.from('receita_itens').select('*').eq('receita_id',receita_id);
    if(itens.error) throw itens.error;
    let total=0;
    for(const it of (itens.data||[])){
      const perda = (it.perda_pct||0)/100;
      if(it.tipo==='INGREDIENTE'){
        const ing = await supa.from('ingredientes').select('custo_unitario,unidade').eq('id',it.ref_id).single();
        if(ing.error) continue;
        // converte qtd do item para unidade do custo do ingrediente
        const fam = sameFamily(it.unidade, ing.data.unidade);
        if(!fam){ console.warn('Unidade incompatível em ingrediente', it); continue; }
        const qBase = toBaseUnit(it.qtd, it.unidade);
        const ingBase = toBaseUnit(1, ing.data.unidade); // 1 unidade do custo
        const fator = qBase.value / ingBase.value; // quantas "unidades de custo" usamos
        total += (fator * (ing.data.custo_unitario||0)) * (1+perda);
      }else if(it.tipo==='RECEITA'){
        const sub = await calcReceitaCost(it.ref_id);
        const fam = sameFamily(it.unidade, sub.unit);
        if(!fam){ console.warn('Unidade incompatível em sub-receita', it); continue; }
        const qBase = toBaseUnit(it.qtd, it.unidade);
        const yieldBase = toBaseUnit(sub.yield, sub.unit);
        const custoPorBase = sub.totalCost / yieldBase.value;
        total += (qBase.value * custoPorBase) * (1+perda);
      }
    }
    const result = { totalCost: total, unit: R.unidade_rendimento||'g', yield: R.rendimento_qtd||1 };
    recCostCache.set(receita_id, result);
    return result;
  }
  async function updatePratoCustoCalculado(prato_id){
    try{
      const prs = await supa.from('prato_receitas').select('receita_id,qtd,unidade').eq('prato_id',prato_id);
      if(prs.error){ $('pr-custo-calc').value=''; return; }
      let total=0;
      for(const row of (prs.data||[])){
        const rc = await calcReceitaCost(row.receita_id);
        const fam = sameFamily(row.unidade, rc.unit);
        if(!fam){ console.warn('Unidade incompatível no vínculo prato-receita', row); continue; }
        const qtdBase = toBaseUnit(row.qtd, row.unidade);
        const yieldBase = toBaseUnit(rc.yield, rc.unit);
        const custoPorBase = rc.totalCost / yieldBase.value;
        total += qtdBase.value * custoPorBase;
      }
      $('pr-custo-calc').value = money(total);
    }catch(e){ $('pr-custo-calc').value=''; }
  }

  /************ PRATO ⇄ RECEITAS ************/
  async function loadPratoCompTable(){
    const prato_id=$('prc-prato').value;
    const tb=$('tblPrComp').querySelector('tbody'); tb.innerHTML='';
    if(!prato_id) return;
    const {data,error}=await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id',prato_id);
    if(error){ tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>'; return; }
    for(const r of (data||[])){
      const {data:rec}=await supa.from('receitas').select('nome').eq('id',r.receita_id).single();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${rec?.nome||'(receita removida)'}</td>
        <td>${fmt(r.qtd)}</td>
        <td>${r.unidade}</td>
        <td><button class="btn" data-act="prc-del" data-id="${r.id}">Remover</button></td>`;
      tb.appendChild(tr);
    }
    // se estou editando um prato, atualiza custo
    if(prEditId){ recCostCache.clear(); updatePratoCustoCalculado(prEditId); }
  }
  $('prc-prato').addEventListener('change', loadPratoCompTable);
  $('btnAddPrComp').addEventListener('click', async ()=>{
    const prato_id=$('prc-prato').value, receita_id=$('prc-receita').value;
    const qtd=ptToNumber($('prc-qtd').value), unidade=$('prc-und').value, obs=($('prc-obs').value||'').trim()||null;
    if(!prato_id || !receita_id || !qtd){ return alert('Selecione prato/receita e informe quantidade'); }
    const {error}=await supa.from('prato_receitas').insert({prato_id,receita_id,qtd,unidade,obs});
    if(error){ if(String(error.message||'').includes('duplicate')) alert('Esta receita já está vinculada.'); else alert(error.message||error); return; }
    $('prc-qtd').value=''; $('prc-obs').value='';
    setStatus('Receita adicionada ao prato','ok'); loadPratoCompTable();
  });
  $('tblPrComp').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='prc-del'){
      if(!confirmDel('Remover receita do prato?')) return;
      const {error}=await supa.from('prato_receitas').delete().eq('id',b.dataset.id);
      if(error){ return alert(error.message||error); }
      loadPratoCompTable();
    }
  });

  /************ DASHBOARD PRATOS (IMPORT) ************/
  $('srcName').textContent = DASHBOARD_PRATOS_SOURCE;
  async function loadDashboardPratos(){
    const cont=$('dashList'); cont.innerHTML='Carregando…';
    // tenta com categoria; se der erro de coluna, tenta somente nome
    let data=null, hadCat=true;
    let res = await supa.from(DASHBOARD_PRATOS_SOURCE).select(SRC_NAME_COL+','+SRC_CAT_COL);
    if(res.error && String(res.error.message||'').includes('column')){ hadCat=false; res = await supa.from(DASHBOARD_PRATOS_SOURCE).select(SRC_NAME_COL); }
    if(res.error){ cont.textContent='Não foi possível ler '+DASHBOARD_PRATOS_SOURCE; setStatus(res.error.message,'err'); return; }
    data=res.data;
    const {data:exist}=await supa.from('pratos').select('nome');
    const existSet=new Set((exist||[]).map(x=>x.nome));
    const term=($('dash-search').value||'').toLowerCase();
    const cat=($('fDashCat').value||'');
    const items=Array.from(new Map((data||[]).map(r=>[r[SRC_NAME_COL], r])).values())
      .filter(r=>!term || String(r[SRC_NAME_COL]||'').toLowerCase().includes(term))
      .filter(r=>{
        const c = hadCat ? (r[SRC_CAT_COL]||'N/D').toUpperCase() : 'N/D';
        return !cat || c===cat;
      })
      .sort((a,b)=> String(a[SRC_NAME_COL]||'').localeCompare(String(b[SRC_NAME_COL]||''),'pt-BR'));
    cont.innerHTML='';
    items.forEach(r=>{
      const nome=r[SRC_NAME_COL]; const c = hadCat ? (r[SRC_CAT_COL]||'N/D').toUpperCase() : 'N/D';
      const exists=existSet.has(nome);
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`
        <div class="meta"><strong>${nome}</strong> <span class="tag">${c}</span> ${exists?'<span class="tag">Já existe</span>':''}</div>
        <div><button class="btn" data-act="imp-one" data-nome="${nome.replace(/"/g,'&quot;')}" data-cat="${c}" ${exists?'disabled':''}>Importar</button></div>`;
      cont.appendChild(div);
    });
  }
  $('dashList').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='imp-one'){
      await importPratoByName(b.dataset.nome, b.dataset.cat);
      await loadPratos(); await loadDashboardPratos();
    }
  });
  $('fDashCat').addEventListener('change', loadDashboardPratos);
  $('dash-search').addEventListener('input', loadDashboardPratos);
  $('btnSyncAll').addEventListener('click', async ()=>{
    let res = await supa.from(DASHBOARD_PRATOS_SOURCE).select(SRC_NAME_COL+','+SRC_CAT_COL);
    let hadCat = true;
    if(res.error && String(res.error.message||'').includes('column')){ hadCat=false; res = await supa.from(DASHBOARD_PRATOS_SOURCE).select(SRC_NAME_COL); }
    if(res.error){ return alert(res.error.message||res.error); }
    const {data:exist}=await supa.from('pratos').select('nome');
    const existSet=new Set((exist||[]).map(x=>x.nome));
    const unique = Array.from(new Map((res.data||[]).map(r=>[r[SRC_NAME_COL], r])).values());
    for(const r of unique){
      const nome=r[SRC_NAME_COL]; if(!nome || existSet.has(nome)) continue;
      await importPratoByName(nome, hadCat ? (r[SRC_CAT_COL]||'PRATOS').toUpperCase() : 'PRATOS');
    }
    loadPratos(); loadDashboardPratos();
  });
  async function importPratoByName(nome, cat){
    const categoria = cat && cat!=='N/D' ? cat : 'PRATOS';
    const {error}=await supa.from('pratos').insert({nome, categoria});
    if(error && !String(error.message||'').includes('duplicate')){ alert(error.message||error); }
  }

  /************ INIT ************/
  async function init(){
    try{
      await loadPratos();
      await loadDashboardPratos();
      await loadIngredientes();
      await loadReceitasResumo();
      await loadRefOptionsForTipo();
      setStatus('Pronto','ok');
    }catch(e){ setStatus(e.message||String(e),'err'); }
  }
  init();
  </script>
</body>
</html>
