<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard ‚Äì Upload Seguro</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--line:#e6e7eb;--ink:#0b1220;--muted:#667085;--ok:#0ea5e9;--bad:#ef4444;--pri:#2f6ef7}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 12px}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-top:12px}
  .muted{color:var(--muted)}
  #log{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;font-size:12px;border:1px dashed var(--line);border-radius:10px;padding:10px;background:#f8fafc;max-height:280px;overflow:auto}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Dashboard</h1>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div><strong>Upload</strong> <span class="muted">(.xlsx/.xls/.csv com ‚ÄúData da venda‚Äù)</span></div>
      <div>
        <label class="btn" for="fileExcel">üì§ Carregar Excel</label>
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" hidden>
      </div>
    </div>
    <div id="status" class="muted" style="margin-top:8px">‚Äî</div>
    <div id="log" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div class="muted">Pr√©via (5 primeiras linhas v√°lidas):</div>
        <div id="preview" style="font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#f8fafc;border:1px dashed var(--line);border-radius:10px;padding:10px;max-height:260px;overflow:auto"></div>
      </div>
      <div>
        <div class="muted">Mapeamento escolhido:</div>
        <div id="map" style="font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#f8fafc;border:1px dashed var(--line);border-radius:10px;padding:10px;max-height:260px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Supabase e SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
/** CONFIGURE AQUI **/
const SUPABASE_URL = 'https://SEU-PROJETO.supabase.co';
const SUPABASE_ANON_KEY = 'SEU-ANON-KEY';
const TABLE = 'vendas_xlsx';
/********************/

const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = sel => document.querySelector(sel);
const log = (...a)=>{$('#log').textContent += a.join(' ') + '\n'}
const setStatus = (txt, cls='')=>{
  const el = $('#status'); el.className = cls; el.textContent = txt;
}

function sanitize(s){
  return (s??'').toString()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')
    .replace(/\s+/g,' ').trim().toLowerCase();
}
function excelSerialToJSDate(n){
  // Excel serial -> JS Date. 25569 = 1970-01-01, *86400s/dia
  try{
    const utc_days = Math.floor(n - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    const fractional_day = n - Math.floor(n) + 0.0000001;
    let totalSeconds = Math.floor(86400 * fractional_day);
    const seconds = totalSeconds % 60; totalSeconds -= seconds;
    const hours = Math.floor(totalSeconds / (60*60));
    const minutes = Math.floor(totalSeconds / 60) % 60;
    date_info.setUTCHours(hours, minutes, seconds, 0);
    return date_info;
  }catch(e){return null}
}
function parseBRDateTime(s){
  // "dd/mm/aaaa hh:mm" ou "dd/mm/aaaa"
  if(typeof s !== 'string') return null;
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
  if(!m) return null;
  let [_, d, M, y, h, m2] = m;
  if(y.length===2) y = '20'+y;
  const dt = new Date(Number(y), Number(M)-1, Number(d), Number(h||0), Number(m2||0), 0, 0);
  return isNaN(dt) ? null : dt;
}
function toISODate(d){ return d.toISOString().slice(0,10) }
function toHourInt(d){ return d.getHours() }

function findColumn(columns, candidates){
  const low = columns.map(c=>sanitize(c));
  for(const cand of candidates){
    const idx = low.indexOf(sanitize(cand));
    if(idx>=0) return columns[idx];
  }
  // fallback: procura col que contenha todas as palavras
  for(const c of columns){
    const s = sanitize(c);
    let ok = true;
    for(const w of candidates[0].split(/\s+/)) if(!s.includes(w)){ ok=false; break; }
    if(ok) return c;
  }
  return null;
}

async function upsertChunks(rows, chunk=500){
  for(let i=0;i<rows.length;i+=chunk){
    const part = rows.slice(i, i+chunk);
    const {error} = await supa.from(TABLE).insert(part);
    if(error) throw error;
  }
}

function summarizeMap(mp){
  return [
    `dia  ‚á¢ ${mp.colDate || '‚Äî'}`,
    `hora ‚á¢ ${mp.colHour || '(derivado da data ou vazio)'}`,
    `unidade ‚á¢ ${mp.colUnid || '‚Äî'}`,
    `loja ‚á¢ ${mp.colLojaCod || mp.colLojaNome || '‚Äî'}`,
    `canal ‚á¢ ${mp.colCanal || '‚Äî'}`,
    `pagamento_base ‚á¢ ${mp.colPag || '‚Äî'}`,
    `cancelado ‚á¢ ${mp.colCancel || '‚Äî'}`,
    `pedidos ‚á¢ ${mp.colPedidos || 'Itens (default 1 se ausente)'}`,
    `fat ‚á¢ ${mp.colFat || 'Valor Entregador/Total'}`,
    `des ‚á¢ ${mp.colDes || 'Desconto'}`,
    `fre ‚á¢ ${mp.colFre || 'Entrega'}`,
  ].join('\n');
}

async function handleFile(file){
  $('#log').textContent = '';
  setStatus('Lendo arquivo‚Ä¶');

  const wb = await file.arrayBuffer().then(buf=>XLSX.read(buf, {type:'array'}));
  // pega primeira aba com dados
  const firstSheetName = wb.SheetNames[0];
  const ws = wb.Sheets[firstSheetName];
  const raw = XLSX.utils.sheet_to_json(ws, {defval:null}); // array de objetos

  if(!raw.length){ setStatus('Arquivo sem linhas.', 'bad'); return; }

  // nomes reais das colunas
  const columns = Object.keys(raw[0]||{});

  // mapeamento robusto
  const colDate = findColumn(columns, ['data da venda','data venda','data do pedido','data pedido','data','data hora','data/hora','datahora']);
  const colHour = findColumn(columns, ['hora','horario']);
  const colUnid = findColumn(columns, ['unidade']);
  const colLojaCod = findColumn(columns, ['codigo da loja','c√≥digo da loja','cod loja']);
  const colLojaNome= findColumn(columns, ['nome da loja','loja']);
  const colCanal   = findColumn(columns, ['canal de venda','canal','origem']);
  const colPag     = findColumn(columns, ['pagamento','meio de pagamento','tipo pagamento']);
  const colCancel  = findColumn(columns, ['esta cancelado','est√° cancelado','cancelado']);
  const colPedidos = findColumn(columns, ['itens','qtd','quantidade']);
  const colFat     = findColumn(columns, ['valor entregador','total','faturamento','faturamento liquido','fat']);
  const colDes     = findColumn(columns, ['desconto']);
  const colFre     = findColumn(columns, ['entrega','frete']);

  const mapping = {colDate,colHour,colUnid,colLojaCod,colLojaNome,colCanal,colPag,colCancel,colPedidos,colFat,colDes,colFre};
  $('#map').textContent = summarizeMap(mapping);

  if(!colDate){
    setStatus('N√£o achei coluna de data (ex.: ‚ÄúData da venda‚Äù). Upload bloqueado.', 'bad');
    log('Colunas do arquivo:', JSON.stringify(columns, null, 2));
    return;
  }

  let ok=0, bad=0;
  const out = [];
  const dropped = [];

  for(const r of raw){
    let d = r[colDate];
    let jsd=null;

    if(typeof d === 'number') jsd = excelSerialToJSDate(d);
    if(!jsd && typeof d === 'string') jsd = parseBRDateTime(d);
    if(!jsd && d instanceof Date && !isNaN(d)) jsd = d;

    if(!jsd){
      bad++; dropped.push({motivo:'data inv√°lida', amostra:d, row:r}); continue;
    }
    const dia = toISODate(jsd);
    let hora = null;

    // hora via coluna Hour ou extra√≠da da pr√≥pria data-string
    if(colHour && r[colHour]!=null && r[colHour] !== ''){
      const hv = r[colHour];
      if(typeof hv === 'number'){ // 0‚Äì23 ou serial hor√°rio
        hora = (hv>=0 && hv<=23) ? Math.trunc(hv) : toHourInt(excelSerialToJSDate(hv));
      }else if(typeof hv === 'string'){
        const m = hv.match(/(\d{1,2})/); hora = m ? Number(m[1]) : null;
      }
    }else{
      // se a string tinha hora, parseBRDateTime j√° capturou
      hora = toHourInt(jsd);
    }
    if(!(hora>=0 && hora<=23)) hora = null;

    const unidade = colUnid ? String(r[colUnid]??'').trim() : null;
    const loja = colLojaCod ? String(r[colLojaCod]??'').trim()
               : colLojaNome ? String(r[colLojaNome]??'').trim() : null;
    const canal = colCanal ? String(r[colCanal]??'').trim() : null;
    const pagamento_base = colPag ? String(r[colPag]??'').trim() : null;

    const canceladoRaw = colCancel ? String(r[colCancel]??'').trim().toLowerCase() : 'n√£o';
    const cancelado = (canceladoRaw === 'sim' || canceladoRaw === 'true' || canceladoRaw === '1') ? 'Sim' : 'N√£o';

    const pedidos = colPedidos ? Number(r[colPedidos]??0) : 1;
    const fat = Number((r[colFat]??0).toString().replace(',','.')) || 0;
    const des = Number((r[colDes]??0).toString().replace(',','.')) || 0;
    const fre = Number((r[colFre]??0).toString().replace(',','.')) || 0;

    // linha final para a tabela public.vendas_xlsx
    out.push({ dia, hora, unidade, loja, canal, pagamento_base, cancelado, pedidos, fat, des, fre });
    ok++;
  }

  // mostra pr√©via
  const prev = out.slice(0,5).map(o=>JSON.stringify(o)).join('\n');
  $('#preview').textContent = prev || '(sem linhas v√°lidas)';

  log(`Linhas lidas: ${raw.length}`);
  log(`V√°lidas para importa√ß√£o: ${ok}`);
  if(bad>0) log(`Descartadas: ${bad} (ex.: ${JSON.stringify(dropped[0],null,2)})`);

  if(!ok){
    setStatus('Nenhuma linha v√°lida encontrada: verifique a coluna de data.', 'bad');
    return;
  }

  // grava em lotes, sem permitir dia=null
  try{
    setStatus('Gravando no banco‚Ä¶');
    await upsertChunks(out, 800);
    setStatus(`‚úÖ Gravado/atualizado: ${ok} linha(s).`, 'ok');
  }catch(e){
    setStatus(`Erro ao gravar: ${e.message}`, 'bad');
    log('Detalhes:', JSON.stringify(e, null, 2));
  }
}

$('#fileExcel').addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  $('#log').textContent = ''; $('#preview').textContent = ''; $('#map').textContent = '';
  setStatus(`Arquivo: ${f.name}`);
  handleFile(f);
});
</script>
</body>
</html>
