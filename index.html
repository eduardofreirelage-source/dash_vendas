<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Dashboard Vendas</title>
    <link rel="icon" href="data:," />

    <!-- Credenciais (definidas de forma simples, sem objetos literais para evitar erro com ":") -->
    <script>
      (function () {
        window.ENV = window.ENV || {};
        window.ENV.VITE_SUPABASE_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
        window.ENV.VITE_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
      })();
    </script>

    <!-- Tailwind para o layout -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel para permitir JSX inline -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <style>
      html, body, #root { height: 100%; }
    </style>
  </head>

  <body class="bg-gray-50">
    <div id="root" class="min-h-full"></div>

    <!-- App -->
    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // ===== utils =====
      const fmtInt = (v) =>
        new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(Math.round(Number(v) || 0));
      const fmtCur = (v) =>
        new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(v) || 0);

      function Card({ title, value, hint }) {
        return (
          <div className="rounded-lg bg-white shadow-sm border border-gray-200 p-5">
            <div className="text-sm text-gray-600">{title}</div>
            <div className="mt-1 text-2xl font-semibold text-gray-900 tabular-nums">{value}</div>
            {hint ? <div className="mt-1 text-xs text-gray-500">{hint}</div> : null}
          </div>
        );
      }

      function App() {
        const [status, setStatus] = useState("Inicializando…");
        const [error, setError] = useState("");
        const [kpis, setKpis] = useState({ pedidos: 0, faturamento: 0, descontos: 0, frete: 0, periodo: "" });

        const TABLE_NAME = "vendas_import_csv"; // fonte principal no seu banco

        function getEnv() {
          const url = (window.ENV && window.ENV.VITE_SUPABASE_URL) || "";
          const anon = (window.ENV && window.ENV.VITE_SUPABASE_ANON_KEY) || "";
          return { url, anon };
        }

        const supabaseClient = useMemo(() => {
          try {
            const { url, anon } = getEnv();
            if (!url || !anon) return null;
            return window.supabase.createClient(url, anon);
          } catch {
            return null;
          }
        }, []);

        useEffect(() => {
          (async () => {
            try {
              const { url, anon } = getEnv();
              if (!url || !anon) {
                setStatus("Credenciais ausentes.");
                setError("Verifique as variáveis logo no topo deste HTML.");
                return;
              }
              if (!supabaseClient) {
                setStatus("Falha ao criar cliente Supabase.");
                setError("URL/ANON inválidos.");
                return;
              }

              setStatus("Conectando à Supabase…");

              // 1) último dia com venda
              const { data: last, error: e1 } = await supabaseClient
                .from(TABLE_NAME)
                .select("data_venda")
                .order("data_venda", { ascending: false })
                .limit(1);

              if (e1) throw e1;
              const lastDay = last?.[0]?.data_venda;
              if (!lastDay) {
                setStatus(`Conectado, mas não encontrei registros em ${TABLE_NAME}.`);
                return;
              }

              const end = new Date(lastDay + "T23:59:59");
              const start = new Date(end);
              start.setDate(end.getDate() - 29);
              const toISO = (d) => d.toISOString().slice(0, 10);

              setStatus(`Consultando KPIs (30d) em ${TABLE_NAME} de ${toISO(start)} até ${toISO(end)}…`);

              // 2) ler tudo em páginas
              let all = [];
              const pageSize = 5000;
              for (let from = 0; ; from += pageSize) {
                const to = from + pageSize - 1;
                const { data, error: e2 } = await supabaseClient
                  .from(TABLE_NAME)
                  .select("data_venda, valor_total, desconto, entrega", { count: "exact" })
                  .gte("data_venda", toISO(start))
                  .lte("data_venda", toISO(end))
                  .order("data_venda", { ascending: true })
                  .range(from, to);
                if (e2) throw e2;
                if (!data || data.length === 0) break;
                all = all.concat(data);
                if (data.length < pageSize) break;
              }

              // 3) KPIs
              const pedidos = all.length;
              const faturamento = all.reduce((s, r) => s + Number(r.valor_total || 0), 0);
              const descontos  = all.reduce((s, r) => s + Number(r.desconto    || 0), 0);
              const frete      = all.reduce((s, r) => s + Number(r.entrega     || 0), 0);

              setKpis({
                pedidos,
                faturamento,
                descontos,
                frete,
                periodo: `${toISO(start)} → ${toISO(end)}`
              });

              setStatus("Conectado e KPIs carregados.");
              setError("");
            } catch (err) {
              console.error("[Supabase] Erro:", err);
              setStatus("Falha ao consultar a base.");
              setError(err?.message || String(err));
            }
          })();
        }, [supabaseClient]);

        const { url, anon } = getEnv();

        return (
          <div className="max-w-5xl mx-auto p-6">
            <header className="mb-6">
              <h1 className="text-3xl font-bold text-gray-900">Dashboard Vendas — GitHub Pages</h1>
              <p className="text-sm text-gray-600 mt-1">
                Fonte: <code className="text-gray-800">public.vendas_import_csv</code> (últimos 30 dias)
              </p>
            </header>

            <div className="rounded-lg border p-4 bg-white mb-6">
              <div className="text-sm text-gray-700">
                <span className="font-medium">Status:</span>{" "}
                <span className={error ? "text-rose-700" : "text-emerald-700"}>{status}</span>
              </div>
              <div className="text-xs text-gray-500 mt-1 space-y-1">
                <div>URL: <code>{url || "(não definida)"}</code></div>
                <div>ANON: <code>{anon ? "(definida)" : "(não definida)"}</code></div>
                {kpis.periodo ? <div>Período: <span className="tabular-nums">{kpis.periodo}</span></div> : null}
              </div>
              {error ? (
                <pre className="mt-3 text-xs text-rose-700 whitespace-pre-wrap bg-rose-50 p-2 rounded border border-rose-200">
{error}
                </pre>
              ) : null}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card title="Pedidos" value={fmtInt(kpis.pedidos)} />
              <Card title="Faturamento" value={fmtCur(kpis.faturamento)} />
              <Card title="Incentivos" value={fmtCur(kpis.descontos)} />
              <Card title="Frete" value={fmtCur(kpis.frete)} />
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
