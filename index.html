<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Vendas (Light)</title>
  <!-- Tailwind via CDN (sem build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 + Babel (para usar JSX sem build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- Chart.js (gráficos) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Config com URL/KEY (criado no arquivo config.js) -->
  <!-- IMPORTANTÍSSIMO: este script deve vir ANTES do app -->
  <script src="./config.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root" class="p-4 max-w-6xl mx-auto"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // === Helpers ===
    const num = (x) => {
      if (x === null || x === undefined) return 0;
      if (typeof x === "number") return isFinite(x) ? x : 0;
      const s = String(x).trim().replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return isFinite(n) ? n : 0;
    };
    const fmtBRL = (v)=> new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(Number(v)||0);
    const fmtInt = (v)=> new Intl.NumberFormat("pt-BR", { maximumFractionDigits:0 }).format(Math.round(Number(v)||0));
    const fmtPct = (v)=> `${(Number(v)||0).toFixed(2)}%`;
    const deltaPct = (cur, prev) => {
      const c = Number(cur)||0, p = Number(prev)||0;
      if (p === 0 && c === 0) return 0;
      if (p === 0) return 100;
      return ((c - p)/Math.abs(p))*100;
    };

    // === Supabase client ===
    const sb = supabase.createClient(window.ENV.VITE_SUPABASE_URL, window.ENV.VITE_SUPABASE_ANON_KEY);
    const TABLE = "vendas_import_csv"; // onde estão seus dados carregados

    async function getMinMaxDate() {
      // min
      const { data: d1, error: e1 } = await sb
        .from(TABLE)
        .select("data_venda", { head: false })
        .order("data_venda", { ascending: true })
        .limit(1);
      if (e1) throw e1;
      // max
      const { data: d2, error: e2 } = await sb
        .from(TABLE)
        .select("data_venda", { head: false })
        .order("data_venda", { ascending: false })
        .limit(1);
      if (e2) throw e2;
      return {
        min: d1?.[0]?.data_venda || null,
        max: d2?.[0]?.data_venda || null,
      };
    }

    // Busca paginada por período + (opcional) unidade
    async function fetchRows({ from, to, unidade = null, pageSize = 1000, maxPages = 30 }) {
      let rows = [];
      let page = 0;
      while (page < maxPages) {
        let q = sb
          .from(TABLE)
          .select("data_venda,hora,unidade,valor_total,desconto,entrega", { head: false })
          .gte("data_venda", from)
          .lte("data_venda", to)
          .order("data_venda", { ascending: true })
          .range(page*pageSize, (page+1)*pageSize - 1);

        if (unidade && unidade.length) {
          // filter IN
          q = q.in("unidade", unidade);
        }

        const { data, error } = await q;
        if (error) throw error;

        rows = rows.concat(data || []);
        if (!data || data.length < pageSize) break;
        page++;
      }
      return rows;
    }

    // === UI ===
    function Card({ title, children }) {
      return (
        <div className="bg-white rounded-lg border border-gray-200 shadow-sm p-4">
          <div className="text-sm font-semibold text-gray-700 mb-2">{title}</div>
          {children}
        </div>
      );
    }

    function Kpi({ label, value, prevValue, type="money" }) {
      const d = useMemo(()=> deltaPct(value, prevValue), [value, prevValue]);
      const Icon = d >= 0 ? "▲" : "▼";
      const color = d > 0 ? "text-emerald-700" : d < 0 ? "text-rose-700" : "text-gray-500";
      const fmt = type === "money" ? fmtBRL : type === "percent" ? fmtPct : fmtInt;
      return (
        <div className="rounded-lg bg-white shadow-sm p-4 border border-gray-200">
          <div className="text-sm text-gray-600">{label}</div>
          <div className="mt-1 flex items-baseline gap-3">
            <span className="text-2xl font-semibold tabular-nums text-gray-900">{fmt(value||0)}</span>
            <span className={`ml-2 ${color}`}>
              {d === 0 ? "•" : Icon} {Math.abs(d).toFixed(2)}%
            </span>
          </div>
          <div className="mt-1 text-xs text-gray-500">
            Anterior: <span className="tabular-nums">{fmt(prevValue||0)}</span>
          </div>
        </div>
      );
    }

    function HourlyChart({ id, cur, prev }) {
      const canvasRef = useRef(null);
      useEffect(()=>{
        if (!canvasRef.current) return;
        const ctx = canvasRef.current.getContext("2d");
        const chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: Array.from({length:24}, (_,h)=> String(h).padStart(2,"0")+":00"),
            datasets: [
              { label: "ANTERIOR (média/dia)", data: prev, backgroundColor: "rgba(148,163,184,0.6)" },
              { label: "ATUAL (média/dia)", data: cur, backgroundColor: "rgba(59,130,246,0.85)" },
            ]
          },
          options: {
            responsive: true,
            scales: { y: { ticks: { callback: (v)=> fmtBRL(v) } } },
            plugins: { legend: { position: "bottom" }, tooltip: { callbacks: { label: (ctx)=> `${ctx.dataset.label}: ${fmtBRL(ctx.parsed.y)}` } } }
          }
        });
        return ()=> chart.destroy();
      }, [cur, prev]);
      return <canvas ref={canvasRef} className="w-full h-64"></canvas>;
    }

    function App() {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [dateMinMax, setDateMinMax] = useState({min:null, max:null});
      const [from, setFrom] = useState("");
      const [to, setTo] = useState("");
      const [unidades, setUnidades] = useState([]);
      const [selUnidades, setSelUnidades] = useState([]);

      // dados calculados
      const [kpi, setKpi] = useState({ pedidos:0, vendas:0, descontos:0, frete:0 });
      const [kpiPrev, setKpiPrev] = useState({ pedidos:0, vendas:0, descontos:0, frete:0 });
      const [hourCur, setHourCur] = useState(Array(24).fill(0));
      const [hourPrev, setHourPrev] = useState(Array(24).fill(0));

      // Inicial: datas e unidades
      useEffect(()=>{
        (async ()=>{
          try{
            setLoading(true);
            const mm = await getMinMaxDate();
            setDateMinMax(mm);
            const max = mm.max || new Date().toISOString().slice(0,10);
            const dmax = new Date(max);
            const dmin = new Date(dmax); dmin.setDate(dmax.getDate()-29);
            const iso = (d)=> d.toISOString().slice(0,10);
            setFrom(iso(dmin));
            setTo(iso(dmax));

            // pegar unidades distintas (só 1 página grande para buscar opções)
            const { data, error } = await sb.from(TABLE).select("unidade").limit(10000);
            if (error) throw error;
            const opts = Array.from(new Set((data||[]).map(r=> (r.unidade||"").trim()).filter(Boolean))).sort();
            setUnidades(opts);
          }catch(e){
            console.error(e);
            setError(e.message||String(e));
          }finally{
            setLoading(false);
          }
        })();
      },[]);

      // função que calcula KPIs + hora a partir das linhas
      const compute = (rows) => {
        const pedidos = rows.length;
        let vendas=0, descontos=0, frete=0;
        const hour = Array(24).fill(0);
        for (const r of rows) {
          const v = num(r.valor_total), d = num(r.desconto), f = num(r.entrega);
          vendas += v; descontos += d; frete += f;
          let h = r.hora;
          if (h === null || h === undefined || h === "") h = 12;
          h = Math.max(0, Math.min(23, parseInt(h, 10) || 0));
          hour[h] += v;
        }
        return { pedidos, vendas, descontos, frete, hour };
      };

      async function loadData() {
        try{
          setLoading(true); setError(null);
          // período atual
          const rowsCur = await fetchRows({ from, to, unidade: selUnidades });
          // período anterior (mesmo tamanho, imediatamente anterior)
          const dFrom = new Date(from+"T00:00:00");
          const dTo = new Date(to+"T00:00:00");
          const span = Math.max(1, Math.round((dTo - dFrom)/(24*3600*1000))+1);
          const prevEnd = new Date(dFrom.getTime()-24*3600*1000);
          const prevStart = new Date(prevEnd.getTime() - (span-1)*24*3600*1000);
          const iso = (d)=> d.toISOString().slice(0,10);
          const rowsPrev = await fetchRows({ from: iso(prevStart), to: iso(prevEnd), unidade: selUnidades });

          // KPIs
          const cur = compute(rowsCur);
          const prv = compute(rowsPrev);
          setKpi({ pedidos:cur.pedidos, vendas:cur.vendas, descontos:cur.descontos, frete:cur.frete });
          setKpiPrev({ pedidos:prv.pedidos, vendas:prv.vendas, descontos:prv.descontos, frete:prv.frete });

          // Hora — média por dia
          const daysCur = Math.max(1, rowsCur.length ? (new Set(rowsCur.map(r=>r.data_venda)).size) : 1);
          const daysPrev = Math.max(1, rowsPrev.length ? (new Set(rowsPrev.map(r=>r.data_venda)).size) : 1);
          setHourCur(cur.hour.map(v=> v / daysCur));
          setHourPrev(prv.hour.map(v=> v / daysPrev));
        }catch(e){
          console.error(e);
          setError(e.message||String(e));
        }finally{
          setLoading(false);
        }
      }

      useEffect(()=>{ if (from && to) loadData(); /* carrega ao abrir */ }, [from,to, selUnidades.join("|")]);

      return (
        <div>
          <header className="mb-4">
            <h1 className="text-2xl font-bold text-gray-900">Dashboard de Vendas (Light, sem build)</h1>
            <p className="text-sm text-gray-600">Lendo diretamente do Supabase: <code className="bg-gray-100 px-1 rounded">{TABLE}</code></p>
          </header>

          {/* Filtros */}
          <div className="bg-white rounded-lg shadow-sm p-4 border border-gray-200 mb-4">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card title="Data início">
                <input type="date" className="w-full border rounded px-2 py-1"
                  min={dateMinMax.min||""} max={dateMinMax.max||""}
                  value={from||""} onChange={(e)=> setFrom(e.target.value)} />
                <div className="text-xs text-gray-500 mt-1">Faixa do banco: {dateMinMax.min} → {dateMinMax.max}</div>
              </Card>
              <Card title="Data fim">
                <input type="date" className="w-full border rounded px-2 py-1"
                  min={dateMinMax.min||""} max={dateMinMax.max||""}
                  value={to||""} onChange={(e)=> setTo(e.target.value)} />
              </Card>
              <Card title="Período rápido">
                <div className="grid grid-cols-3 gap-2">
                  {[7,15,30,60,90,120].map(d=>(
                    <button key={d} onClick={()=>{
                      const dTo = to ? new Date(to+"T00:00:00") : new Date();
                      const dFrom = new Date(dTo); dFrom.setDate(dTo.getDate()-(d-1));
                      const iso = (x)=> x.toISOString().slice(0,10);
                      setFrom(iso(dFrom)); setTo(iso(dTo));
                    }} className="text-sm border rounded px-2 py-1 hover:bg-gray-50">{d}d</button>
                  ))}
                </div>
                <button className="mt-2 text-xs text-blue-700 underline" onClick={()=>{
                  setSelUnidades([]); if (dateMinMax.max){ const toD=new Date(dateMinMax.max); const fromD=new Date(toD); fromD.setDate(toD.getDate()-29); setFrom(fromD.toISOString().slice(0,10)); setTo(toD.toISOString().slice(0,10)); }
                }}>Limpar filtros</button>
              </Card>
              <Card title="Unidade">
                <select multiple className="w-full border rounded px-2 py-1 h-[90px]" value={selUnidades} onChange={(e)=>{
                  const vals = Array.from(e.target.selectedOptions).map(o=>o.value);
                  setSelUnidades(vals);
                }}>
                  {unidades.map(u=> <option key={u} value={u}>{u}</option>)}
                </select>
                <div className="flex gap-2 mt-1">
                  <button className="text-xs border rounded px-2" onClick={()=> setSelUnidades([])}>Todas</button>
                  <button className="text-xs border rounded px-2" onClick={()=> setSelUnidades(unidades)}>Selecionar todas</button>
                </div>
              </Card>
            </div>
            <div className="mt-3">
              <button onClick={loadData} className="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Atualizar</button>
              {loading && <span className="ml-3 text-sm text-gray-500">Carregando…</span>}
              {error && <span className="ml-3 text-sm text-rose-700">Erro: {error}</span>}
            </div>
          </div>

          {/* KPIs */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <Kpi label="Pedidos" value={kpi.pedidos} prevValue={kpiPrev.pedidos} type="int" />
            <Kpi label="Faturamento" value={kpi.vendas} prevValue={kpiPrev.vendas} type="money" />
            <Kpi label="Incentivos" value={kpi.descontos} prevValue={kpiPrev.descontos} type="money" />
            <Kpi label="Frete" value={kpi.frete} prevValue={kpiPrev.frete} type="money" />
          </div>

          {/* Gráfico por hora (média por dia) */}
          <div className="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
            <div className="text-sm font-semibold text-gray-700 mb-2">Média de Faturamento por Hora — ATUAL × ANTERIOR</div>
            <HourlyChart id="chart-hour" cur={hourCur} prev={hourPrev} />
          </div>

          <footer className="text-xs text-gray-500 mt-6">
            * Esta versão é “light” (sem build): React + Supabase + Chart.js por CDN.  
            * Tabela lida: <code>{TABLE}</code>. Colunas usadas: <code>data_venda, hora, unidade, valor_total, desconto, entrega</code>.
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
