<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Importador XLSX ‚Äî Maestro</title>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --bg:#0b1220; --card:#111a2b; --muted:#9fb0d3; --brand:#3b82f6; --ok:#16a34a; --err:#ef4444; }
  *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto;color:#e6eefc;background:var(--bg);}
  .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
  h1{font-size:26px;margin:0 0 18px}
  .card{background:var(--card);border:1px solid #1b2944;border-radius:14px;padding:18px;margin-bottom:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type=file]{padding:10px;background:#0e1729;border:1px dashed #2b3c61;border-radius:10px;color:#cfe0ff;width:100%}
  button{background:var(--brand);border:0;color:#fff;padding:12px 18px;border-radius:10px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .progress{height:18px;background:#0e1729;border:1px solid #203156;border-radius:10px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a)}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:820px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>üìÅ Importador XLSX ‚Äî Maestro</h1>

    <div class="card">
      <div class="row">
        <input id="file" type="file" accept=".xlsx" />
        <button id="btnImport">Importar</button>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="progress" style="flex:1"><div id="bar" class="bar"></div></div>
        <div id="progLabel" class="muted mono">Aguardando‚Ä¶</div>
      </div>
      <div id="status" class="mono" style="margin-top:10px"></div>
    </div>

    <div class="grid2">
      <div class="card">
        <b>Healthcheck</b>
        <div id="health" class="mono muted" style="margin-top:8px">‚Äî</div>
      </div>
      <div class="card">
        <b>Amostra (at√© 5 linhas)</b>
        <div id="sample" class="mono" style="margin-top:8px">‚Äî</div>
      </div>
    </div>

    <div class="card">
      <b>Mapeamento de cabe√ßalhos (auto)</b>
      <div id="mapOut" class="mono" style="margin-top:8px">‚Äî</div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const TABLE_NAME = 'vendas_xlsx';           // ajuste se necess√°rio
const ROW_KEY_ONCONFLICT = 'row_key';        // precisa ser UNIQUE no banco
// Tamanhos: linhas lidas da planilha por janela, e lote por upsert
const WINDOW_ROWS = 5000;
const BATCH_SIZE  = 500;
/* ==================== */

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// utils
const $ = (id)=>document.getElementById(id);
const norm = s => String(s ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
const lower = s => norm(s).toLowerCase();

// Pagamento normalizado (ajuste conforme sua realidade)
function normalizePagamento(s){
  const x = lower(s);
  if (!x) return null;
  if (x.includes('pix')) return 'PIX';
  if (x.includes('cartao') || x.includes('cart√£o')) return 'Cart√£o';
  if (x.includes('dinheiro')) return 'Dinheiro';
  if (x.includes('pago online') || x.includes('pagamento online')) return 'Pago Online';
  if (x.includes('consumo funcionario')) return 'Consumo Funcion√°rio';
  if (x.includes('voucher parceiro')) return 'Voucher Parceiro Desconto';
  return s; // mant√©m original
}
function normalizeCancel(v){
  const x = lower(v);
  if (x==='s' || x==='sim' || x==='true' || x==='1') return 'Sim';
  if (x==='n' || x==='nao' || x==='n√£o' || x==='false' || x==='0') return 'N√£o';
  return x ? v : 'N√£o';
}
function turnoByHour(h){
  const hr = Number(h);
  if (isNaN(hr)) return null;
  if (hr>=6 && hr<12) return 'Manh√£';
  if (hr>=12 && hr<18) return 'Tarde';
  if (hr>=18 && hr<24) return 'Noite';
  return 'Madrugada';
}

// Excel date/serial ‚Üí ISO
function excelSerialToDate(n){
  // Base 1900 com bug do 29/02/1900 (Excel)
  const epoch = new Date(Date.UTC(1899,11,30)); // 1899-12-30
  const ms = Math.round((Number(n) || 0) * 86400000);
  return new Date(epoch.getTime() + ms);
}
function two(n){ return String(n).padStart(2,'0'); }
function toISODate(d){
  const y=d.getUTCFullYear(), m=d.getUTCMonth()+1, day=d.getUTCDate();
  const hh=d.getUTCHours(), mm=d.getUTCMinutes(), ss=d.getUTCSeconds();
  return `${y}-${two(m)}-${two(day)}T${two(hh)}:${two(mm)}:${two(ss)}`;
}

// "Data da venda" (serial ou string) ‚Üí {iso, dia, hora, minuto}
function parseVendaTS(v){
  if (v==null || v==='') return { iso:null, dia:null, hora:null, minuto:null };
  // 1) se n√∫mero (serial Excel)
  if (!isNaN(v) && v!==true && v!==false){
    const d = excelSerialToDate(Number(v));
    const iso = toISODate(d);
    return { iso, dia: iso.slice(0,10), hora: Number(iso.slice(11,13)), minuto: Number(iso.slice(14,16)) };
  }
  const s = String(v).trim();
  // 2) ‚Äúdd/mm/aaaa hh:mm(:ss)?‚Äù
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m){
    let [_, dd, MM, yyyy, hh='0', mi='0', ss='0'] = m;
    if (yyyy.length===2) yyyy = (+yyyy < 50 ? '20':'19') + yyyy;
    const iso = `${yyyy}-${two(MM)}-${two(dd)}T${two(hh)}:${two(mi)}:${two(ss)}`;
    return { iso, dia: iso.slice(0,10), hora: Number(hh), minuto: Number(mi) };
  }
  // 3) Tenta Date.parse seguro (assume j√° em ISO)
  const d = new Date(s);
  if (!isNaN(d.getTime())){
    const iso = toISODate(d);
    return { iso, dia: iso.slice(0,10), hora: Number(iso.slice(11,13)), minuto: Number(iso.slice(14,16)) };
  }
  return { iso:null, dia:null, hora:null, minuto:null };
}

// Cabe√ßalhos mapeados ‚Üí nomes padronizados
function mapHeader(h){
  const key = lower(h);
  const dict = [
    {std:'Pedido', list:['pedido','id','n do pedido','numero do pedido']},
    {std:'unidade', list:['unidade','filial','loja','uni']},
    {std:'Nome da loja', list:['nome da loja','nome loja','loja nome','nomedaloja']},
    {std:'Canal de venda', list:['canal de venda','canal','canal_venda','canal de vendas']},
    {std:'Pagamento', list:['pagamento','forma de pagamento','meio de pagamento']},
    {std:'Est√° cancelado', list:['esta cancelado','est√° cancelado','cancelado','cancelada']},
    {std:'Data da venda', list:['data da venda','data','data_venda','datadavenda','ts_venda','venda em']},
    {std:'Total', list:['total','valor total','valor','valor pedido','total geral']},
    {std:'Desconto', list:['desconto','des','incentivo','incentivos']},
    {std:'Entrega', list:['entrega','frete','taxa de entrega','valor entrega']},
    {std:'Turno', list:['turno','periodo','per√≠odo']},
  ];
  for (const i of dict){ if (i.list.some(x => x===key)) return i.std; }
  return h; // mant√©m
}

// Hash est√°vel (row_key). Usa Web Crypto quando dispon√≠vel.
async function hashRowKey(str){
  if (crypto?.subtle){
    const buf = new TextEncoder().encode(str);
    const dig = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(dig)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  // fallback simples
  let h=0; for (let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; }
  return 'h'+(h>>>0).toString(16);
}

// Exclus√£o ‚ÄúLoja Centro‚Äù/vazios
function lojaBloqueada(nome){
  const n = lower(nome);
  return !n || n==='loja centro';
}

// ========= Import =========
$('btnImport').addEventListener('click', async ()=>{
  const file = $('file').files[0];
  if (!file){ alert('Selecione um .xlsx'); return; }
  $('btnImport').disabled = true; $('status').textContent = 'Lendo planilha‚Ä¶';

  try{
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, {cellDates:true, raw:false});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    if (!ws || !ws['!ref']) throw new Error('Aba vazia');

    // limites/√≠ndices
    const ref = XLSX.utils.decode_range(ws['!ref']);
    const firstRow = ref.s.r, lastRow = ref.e.r, firstCol = ref.s.c, lastCol = ref.e.c;

    // header
    const headerA1 = XLSX.utils.sheet_to_json(ws, {range: XLSX.utils.encode_range({s:{r:firstRow,c:firstCol}, e:{r:firstRow,c:lastCol}}), header:1})[0] || [];
    const mapped = {};
    headerA1.forEach(h => { mapped[h] = mapHeader(h); });
    $('mapOut').textContent = JSON.stringify(mapped, null, 2);

    // progresso
    let totalRows = (lastRow - firstRow);
    let sent = 0, ok=0, fail=0, kept=0;
    const t0 = Date.now();

    // janela por janela para n√£o estourar mem√≥ria
    for (let r = firstRow+1; r <= lastRow; r += WINDOW_ROWS){
      const endR = Math.min(r + WINDOW_ROWS - 1, lastRow);
      const windowData = XLSX.utils.sheet_to_json(ws, {
        range: XLSX.utils.encode_range({s:{r:r,c:firstCol}, e:{r:endR,c:lastCol}}),
        header: headerA1,
        defval: ''
      });

      // normaliza + filtra + transforma
      const toInsert = [];
      for (const raw of windowData){
        // aplica header mapeado
        const row = {};
        for (const [orig,val] of Object.entries(raw)){
          row[mapped[orig] || orig] = val;
        }

        // Data/hora
        const ts = parseVendaTS(row['Data da venda']);
        if (!ts.dia){ fail++; continue; } // sem data n√£o d√° para inserir

        // Regra de loja
        const loja = row['Nome da loja'];
        if (lojaBloqueada(loja)){ kept++; continue; }

        // Campos financeiros
        const fat = parseFloat(String(row['Total']).replace(',','.')) || 0;
        const des = parseFloat(String(row['Desconto']).replace(',','.')) || 0;
        const fre = parseFloat(String(row['Entrega']).replace(',','.')) || 0;

        const unidade = row['unidade'] || row['Unidade'] || null;
        const pagamento = normalizePagamento(row['Pagamento']);
        const cancelado = normalizeCancel(row['Est√° cancelado']);
        const canal = row['Canal de venda'] || null;
        const turno = row['Turno'] || turnoByHour(ts.hora) || null;

        const baseKey = [
          ts.dia, two(ts.hora), two(ts.minuto),
          unidade||'', loja||'', pagamento||'', canal||'',
          fat.toFixed(2)
        ].join('|');
        const row_key = await hashRowKey(baseKey);

        toInsert.push({
          row_key,
          dia: ts.dia,
          hora: ts.hora,
          minuto: ts.minuto,
          ts_venda: ts.iso, // timestamp (UTC). Se preferir sem TZ, ajuste no SQL.
          unidade,
          "Nome da loja": loja,
          "Canal de venda": canal,
          pagamento,
          cancelado,
          turno,
          pedidos: 1,
          fat, des, fre
        });
      }

      // envia em lotes
      for (let i=0;i<toInsert.length;i+=BATCH_SIZE){
        const batch = toInsert.slice(i, i+BATCH_SIZE);
        const {error, count} = await sb.from(TABLE_NAME)
          .upsert(batch, { onConflict: ROW_KEY_ONCONFLICT, ignoreDuplicates: false, count:'exact' });
        if (error){ fail += batch.length; console.error('Erro upsert:', error); }
        else ok += batch.length;

        sent += batch.length;
        const pct = Math.min(100, ((sent+kept+fail)/(totalRows))*100);
        $('bar').style.width = pct.toFixed(1)+'%';
        $('progLabel').textContent = `Enviados ${sent} | Ignorados ${kept} | Erros ${fail} ‚Äî ${pct.toFixed(1)}%`;
      }
    }

    const secs = ((Date.now()-t0)/1000).toFixed(1);
    $('status').innerHTML = `‚úÖ Importa√ß√£o conclu√≠da em ${secs}s ‚Äî <span class="ok">${ok} inseridos/upsert</span>, <span class="muted">${kept} ignorados (loja vazia/Centro)</span>, <span class="err">${fail} falhas</span>.`;
    $('btnImport').disabled = false;

    await renderHealth();
    await renderSample();

  }catch(err){
    console.error(err);
    $('status').innerHTML = `<span class="err">Erro: ${err.message}</span>`;
    $('btnImport').disabled = false;
  }
});

// Healthcheck e amostra
async function renderHealth(){
  const minQ = await sb.rpc('sql', { q: `select min(dia) as dia from ${TABLE_NAME}` }).catch(()=>({data:null}));
  const maxQ = await sb.rpc('sql', { q: `select max(dia) as dia from ${TABLE_NAME}` }).catch(()=>({data:null}));
  const cntQ = await sb.from(TABLE_NAME).select('row_key', {count:'exact', head:true});
  const min = (minQ?.data?.[0]?.dia)||'‚Äî', max = (maxQ?.data?.[0]?.dia)||'‚Äî', count=cntQ?.count ?? '‚Äî';
  $('health').textContent = `Intervalo no banco: ${min} ‚Üí ${max}\nTotal (count exato): ${count}`;
}
async function renderSample(){
  const {data, error} = await sb.from(TABLE_NAME).select('dia,hora,minuto,"Nome da loja","Canal de venda",pagamento,fat,des,fre,cancelado').order('dia',{ascending:false}).limit(5);
  $('sample').textContent = error ? `Erro: ${error.message}` : JSON.stringify(data, null, 2);
}

/* RPC utilit√°ria para SELECT simples (permite min/max sem expor schema).
   Crie no banco uma fun√ß√£o segura, por ex:
   create or replace function public.sql(q text)
   returns json language plpgsql security definer as $$
   begin return query execute q; end $$;
   grant execute on function public.sql(text) to anon, authenticated;
*/
</script>
</body>
</html>
