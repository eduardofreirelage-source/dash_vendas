<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Maestro Food</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="%232563eb"/><text x="32" y="38" font-family="Arial" font-size="28" text-anchor="middle" fill="white">MF</text></svg>'>
<style>
:root{--bg:#f6f7fb;--fg:#0f172a;--mut:#6b7280;--card:#fff;--brd:#e5e7eb;--acc:#2563eb}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
.wrap{max-width:1200px;margin:20px auto;padding:0 14px}
.top{display:flex;gap:10px;align-items:center;justify-content:space-between}
h1{margin:0;font-size:20px}
.muted{color:var(--mut)}
.card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px}
.grid{display:grid;gap:10px}
.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:980px){.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:560px){.cols-4{grid-template-columns:1fr}}
/* Filtros */
.filters .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.filters .grid{grid-template-columns:repeat(12,1fr)}
.col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}
label{display:block;font-size:12px;color:var(--mut);margin-bottom:4px}
select,input[type=date],button{width:100%;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff;font:inherit}
button.primary{background:var(--acc);color:#fff;border-color:var(--acc);cursor:pointer;width:auto}
.badge{display:inline-block;background:#eef2ff;border:1px solid var(--brd);border-radius:999px;padding:4px 8px;font-size:12px}
.right{margin-left:auto}
.note{font-size:12px;color:var(--mut)}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="wrap" id="app" style="display:block">
  <div class="top">
    <div>
      <h1>Maestro Food</h1>
      <div class="muted" id="periodo">Período: —</div>
    </div>
    <button id="btnClear" title="Limpar filtros" class="badge">Limpar</button>
  </div>

  <!-- FILTROS -->
  <div class="card filters">
    <div class="hdr">
      <strong>FILTROS</strong>
      <div class="badge" id="status" style="display:none"></div>
    </div>
    <div class="grid">
      <div class="col-6">
        <label>Unidade</label>
        <select id="fUni"><option value="">Todas</option></select>
      </div>
      <div class="col-6">
        <label>Nome da loja (Top 10)</label>
        <select id="fLoja"><option value="">Todas</option></select>
      </div>

      <div class="col-3">
        <label>De</label>
        <input type="date" id="fDe">
      </div>
      <div class="col-3">
        <label>Até</label>
        <input type="date" id="fAte">
      </div>
      <div class="col-3">
        <label>Período rápido</label>
        <select id="fPr">
          <option value="7">Últimos 7</option>
          <option value="15">Últimos 15</option>
          <option value="30" selected>Últimos 30</option>
          <option value="90">Últimos 90</option>
          <option value="180">Últimos 180</option>
        </select>
      </div>
      <div class="col-3">
        <label>Turno</label>
        <select id="fTurno">
          <option value="">Todos</option>
          <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option><option>Dia</option>
        </select>
      </div>

      <div class="col-4">
        <label>Canal de venda</label>
        <select id="fCanal"><option value="">Todos</option></select>
      </div>
      <div class="col-4">
        <label>Pagamento</label>
        <select id="fPag"><option value="">Todos</option></select>
      </div>
      <div class="col-4">
        <label>Está cancelado?</label>
        <select id="fCanc">
          <option value="">Todos</option>
          <option>Não</option>
          <option>Sim</option>
        </select>
      </div>

      <div class="col-12 card" style="border-style:dashed;margin-top:4px">
        <b>Admin — Importar CSV (<i>Pasta2.csv</i>)</b>
        <div class="top" style="gap:8px;margin-top:8px">
          <input type="file" id="csv" accept=".csv" style="max-width:280px">
          <button id="btnImport" class="primary">Importar CSV</button>
          <span class="badge" id="importMsg" style="display:none"></span>
        </div>
        <div class="note">Importação é somativa com deduplicação por (dia, unidade, "Nome da loja", hora, pagamento, "Canal de venda").</div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid cols-4" style="margin-top:10px">
    <div class="card"><div class="muted">Pedidos</div><div id="k_ped" style="font-weight:700;font-size:22px">—</div></div>
    <div class="card"><div class="muted">Ticket Médio</div><div id="k_tkm" style="font-weight:700;font-size:22px">—</div></div>
    <div class="card"><div class="muted">Faturamento</div><div id="k_fat" style="font-weight:700;font-size:22px">—</div></div>
    <div class="card"><div class="muted">Faturamento Médio (dia)</div><div id="k_fmd" style="font-weight:700;font-size:22px">—</div></div>
  </div>

  <!-- GRÁFICO -->
  <div class="card" style="margin-top:10px">
    <div class="top"><strong>Receita diária</strong><span class="badge">Total</span></div>
    <div style="height:280px"><canvas id="cLine"></canvas></div>
  </div>
</div>

<script>
(function(){
  'use strict';
  if (window.__DASH_LOCK__) return; window.__DASH_LOCK__ = true;

  // ===== CONFIG SUPABASE =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";
  const COL_LOJA = 'Nome da loja';
  const COL_CANAL = 'Canal de venda';

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ===== HELPERS =====
  const $=s=>document.querySelector(s);
  const BRL=n=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const INT=n=>new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = d => (d && !isNaN(d.getTime())) ? d.toISOString().slice(0,10) : "";
  const isAll = v => !v || v==="Todos" || v==="Todas";

  const status = $("#status");
  const showStatus = txt => { status.textContent = txt; status.style.display = txt ? "inline-block" : "none"; };

  // ===== ELEMENTOS =====
  const fUni=$("#fUni"), fLoja=$("#fLoja"), fDe=$("#fDe"), fAte=$("#fAte"), fPr=$("#fPr"),
        fTurno=$("#fTurno"), fCanal=$("#fCanal"), fPag=$("#fPag"), fCanc=$("#fCanc");
  const periodo=$("#periodo");
  let minISO="", maxISO="";
  let chartLine=null;

  // ===== BOOT =====
  (async function boot(){
    await fetchLimites();
    await fetchDistincts();
    await reload();
  })();

  async function fetchLimites(){
    // Busca min/max se existirem; não força filtros com null
    const rMin = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const rMax = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    if(!rMin.error && rMin.data.length) minISO = rMin.data[0].dia; else minISO="";
    if(!rMax.error && rMax.data.length) maxISO = rMax.data[0].dia; else maxISO="";

    // Preenche datas padrão só se houver dados
    if (minISO && maxISO){
      fAte.value = maxISO;
      const days = +fPr.value || 30;
      const end = new Date(maxISO+"T00:00:00Z");
      const start = new Date(end); start.setUTCDate(end.getUTCDate()-(days-1));
      fDe.value = toISO(start);
      fDe.min=minISO; fDe.max=maxISO; fAte.min=minISO; fAte.max=maxISO;
      periodo.textContent = `Período: ${fDe.value} → ${fAte.value}`;
    }else{
      fDe.value=""; fAte.value="";
      periodo.textContent = "Período: —";
    }
  }

  async function fetchDistincts(){
    const r = await supa.from(TABLE).select(`unidade, "${COL_CANAL}", pagamento`).limit(200000);
    if (r.error) return;

    const uniq = (rows, col) => Array.from(new Set(rows.map(x=>x[col]).filter(Boolean))).sort();
    const fill = (sel, arr) => { sel.innerHTML = '<option value="">Todos</option>' + arr.map(v=>`<option>${v}</option>`).join(''); };

    fill(fUni,   uniq(r.data,'unidade'));
    fill(fCanal, uniq(r.data,COL_CANAL));
    fill(fPag,   uniq(r.data,'pagamento'));
  }

  async function reload(){
    showStatus("Carregando…");

    // Datas: só aplico filtros se houver valor
    const sISO = fDe.value || "";
    const eISO = fAte.value || "";
    if (sISO && eISO) periodo.textContent = `Período: ${sISO} → ${eISO}`;
    else if (minISO && maxISO) periodo.textContent = `Período: ${minISO} → ${maxISO}`;
    else periodo.textContent = "Período: —";

    let q = supa.from(TABLE)
      .select(`dia,unidade,pedidos,fat,des,fre,"${COL_LOJA}",turno,"${COL_CANAL}",pagamento,cancelado,hora`)
      .order('dia',{ascending:true})
      .limit(200000);

    if (sISO) q = q.gte('dia', sISO);
    if (eISO) q = q.lte('dia', eISO);
    if (!isAll(fUni.value))   q = q.eq('unidade', fUni.value);
    if (!isAll(fLoja.value))  q = q.eq(COL_LOJA, fLoja.value);
    if (!isAll(fTurno.value)) q = q.eq('turno', fTurno.value);
    if (!isAll(fCanal.value)) q = q.eq(COL_CANAL, fCanal.value);
    if (!isAll(fPag.value))   q = q.eq('pagamento', fPag.value);
    if (!isAll(fCanc.value))  q = q.eq('cancelado', fCanc.value);

    const r = await q;
    if (r.error){ console.error(r.error); paintEmpty(); showStatus("Erro ao carregar"); return; }
    const rows = r.data||[];
    paint(rows);

    // Top 10 lojas do período atual
    const acc = {};
    rows.forEach(x=>{ const k=x[COL_LOJA]; if(!k) return; acc[k]=(acc[k]||0)+(+x.fat||0); });
    const top = Object.entries(acc).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
    fLoja.innerHTML = '<option value="">Todas</option>' + top.map(v=>`<option>${v}</option>`).join('');

    showStatus("");
  }

  function paintEmpty(){
    $("#k_ped").textContent="—"; $("#k_tkm").textContent="—"; $("#k_fat").textContent="—"; $("#k_fmd").textContent="—";
    if (chartLine){ try{chartLine.destroy();}catch(e){} chartLine=null; }
  }

  function paint(data){
    if(!data.length){ paintEmpty(); return; }
    const sum=(a,f)=>a.reduce((s,x)=>s+(+f(x)||0),0);
    const dias = Array.from(new Set(data.map(x=>x.dia))).length || 1;

    const ped = sum(data,x=>x.pedidos||1);
    const fat = sum(data,x=>x.fat);
    const des = sum(data,x=>x.des);
    const fre = sum(data,x=>x.fre);
    const tkm = ped>0? fat/ped : 0;
    const fmd = fat/dias;

    $("#k_ped").textContent = INT(ped);
    $("#k_tkm").textContent = BRL(tkm);
    $("#k_fat").textContent = BRL(fat);
    $("#k_fmd").textContent = BRL(fmd);

    const byDay = {};
    data.forEach(x=>{ byDay[x.dia]=(byDay[x.dia]||0)+(+x.fat||0); });
    const labels = Object.keys(byDay).sort();
    const values = labels.map(k=>byDay[k]);

    if (chartLine){ try{chartLine.destroy();}catch(e){} chartLine=null; }
    const ctx = $("#cLine").getContext("2d");
    chartLine = new window.Chart(ctx,{
      type:"line",
      data:{ labels, datasets:[{ data:values, borderWidth:2, pointRadius:0, tension:.2 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  // ===== IMPORTAÇÃO CSV (dedup local + upsert somativo) =====
  $("#btnImport").addEventListener("click", ()=>{
    const file = $("#csv").files[0];
    const tag = $("#importMsg");
    const setMsg = t=>{ tag.textContent=t; tag.style.display="inline-block"; };

    if(!file){ setMsg("Selecione o arquivo."); return; }

    Papa.parse(file,{
      header:true, skipEmptyLines:true, delimiter:";",
      complete: async (res)=>{
        try{
          const rows = res.data||[];
          if(!rows.length){ setMsg("Arquivo vazio."); return; }

          const norm = s=>String(s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
          const header = res.meta.fields.map(h=>({orig:h, key:norm(h)}));
          const col=(...names)=>{ const wants=names.map(norm); const hit=header.find(h=>wants.includes(h.key)); return hit?hit.orig:null; };

          const C = {
            unidade:   col('unidade'),
            loja:      col('nome da loja','loja','nome loja'),
            turno:     col('turno'),
            canal:     col('canal de venda','canal','canal venda'),
            pagamento: col('pagamento','forma de pagamento'),
            cancelado: col('esta cancelado','está cancelado','cancelado'),
            dataHora:  col('data da venda','data venda','data'),
            total:     col('total','valor total'),
            desconto:  col('desconto'),
            entrega:   col('entrega','frete','taxa de entrega'),
          };

          if (!C.unidade || !C.dataHora || !C.total){
            setMsg("Nada para importar (colunas não foram reconhecidas).");
            return;
          }

          const toISOhm = (s)=>{
            const m = String(s).match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
            if(!m) return {iso:"", hour:null};
            const [_,dd,MM,yyyy,hh,mm] = m;
            const d = new Date(Date.UTC(+yyyy, +MM-1, +dd, +hh, +mm));
            return { iso: toISO(d), hour: +hh };
          };
          const cnum = v=>{
            if (v===null||v===undefined) return 0;
            if (typeof v==='number') return v;
            const s=String(v).trim().replace(/\./g,'').replace(',','.');
            const n=parseFloat(s); return isNaN(n)?0:n;
          };
          const toSimNao = v=>{
            const s=String(v||'').trim().toLowerCase();
            return /^(s|sim|y|yes|true|1)$/.test(s) ? "Sim" : "Não";
          };

          // Dedup local por chave composta
          const map = new Map();
          for (const r of rows){
            const { iso, hour } = toISOhm(r[C.dataHora]);
            if(!iso) continue;
            const unidade   = (r[C.unidade]||"").toString();
            const loja      = (C.loja? r[C.loja] : "") || "";
            const turno     = C.turno ? String(r[C.turno]||"") : "";
            const canal     = C.canal ? String(r[C.canal]||"") : "";
            const pagamento = C.pagamento ? String(r[C.pagamento]||"") : "";
            const cancelado = C.cancelado ? toSimNao(r[C.cancelado]) : "Não";
            const fat = cnum(r[C.total]);
            const des = C.desconto ? cnum(r[C.desconto]) : 0;
            const fre = C.entrega  ? cnum(r[C.entrega])  : 0;

            const hKey = Number.isFinite(hour)? String(hour) : 'null';
            const key = [iso,unidade,loja,hKey,pagamento,canal].join('|');

            if (!map.has(key)){
              map.set(key,{
                dia: iso, unidade, pedidos: 1, fat, des, fre,
                [COL_LOJA]: loja, turno, [COL_CANAL]: canal, pagamento, cancelado,
                hora: Number.isFinite(hour)? hour : null
              });
            } else {
              const o=map.get(key);
              o.pedidos += 1; o.fat += fat; o.des += des; o.fre += fre;
              if (o.cancelado!=="Sim" && cancelado==="Sim") o.cancelado="Sim";
              if (!o.turno && turno) o.turno = turno;
            }
          }
          const out = Array.from(map.values());
          if(!out.length){ setMsg("Nenhuma linha válida."); return; }

          // upsert somativo (sem apagar histórico), chave única combinada
          const chunk=1500; let done=0;
          for(let i=0;i<out.length;i+=chunk){
            const part = out.slice(i,i+chunk);
            const ins = await supa
              .from(TABLE)
              .upsert(part, { onConflict: `dia,unidade,"${COL_LOJA}",hora,pagamento,"${COL_CANAL}"` });
            if(ins.error){ setMsg("Erro ao inserir: "+ins.error.message); return; }
            done += part.length;
            setMsg(`Importando… ${Math.round(done/out.length*100)}%`);
          }
          setMsg("Importado.");
          // Recarrega filtros/dados com as novas faixas
          await fetchLimites();
          await fetchDistincts();
          await reload();
        }catch(e){
          console.error(e); setMsg("Falha no import.");
        }
      },
      error: err=>{ console.error(err); tag.textContent="Erro no CSV."; tag.style.display="inline-block"; }
    });
  });

  // Eventos filtros
  $("#btnClear").addEventListener("click", async ()=>{
    fUni.value=""; fLoja.value=""; fTurno.value=""; fCanal.value=""; fPag.value=""; fCanc.value="";
    if (maxISO){
      fAte.value = maxISO; const days = +fPr.value||30;
      const end=new Date(maxISO+"T00:00:00Z"); const start=new Date(end); start.setUTCDate(end.getUTCDate()-(days-1));
      fDe.value = toISO(start);
    } else { fDe.value=""; fAte.value=""; }
    await reload();
  });
  [fUni,fLoja,fDe,fAte,fPr,fTurno,fCanal,fPag,fCanc].forEach(el=>{
    el.addEventListener("change", async ()=>{
      if (el===fPr && maxISO){
        const days = +fPr.value||30;
        const end=new Date(maxISO+"T00:00:00Z"); const start=new Date(end); start.setUTCDate(end.getUTCDate()-(days-1));
        fDe.value = toISO(start); fAte.value = maxISO;
      }
      await reload();
    });
  });

})();
</script>
</body>
</html>
