<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v13.7 (vendas_kpi • paginação no cliente)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--muted:#6b7280;--ink:#0f172a;--line:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .select,.btn{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font:inherit}
    .btn{cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .title{font-size:12px;color:var(--muted)}
    .kpi{font-size:22px;font-weight:800;margin-top:4px}
    .delta{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:320px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:10px;white-space:pre-wrap;overflow:auto}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard Vendas — Supabase</h1>
    <div class="muted">Build <b>v13.7</b> • fonte fixa: <code>public.vendas_kpi</code> • sem sum() no servidor (paginação 2k)</div>

    <div class="row">
      <label>Período
        <select id="selPeriodo" class="select">
          <option value="30" selected>Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="180">Últimos 180 dias</option>
          <option value="365">Últimos 365 dias</option>
        </select>
      </label>

      <label>UNIDADE
        <select id="selUnidade" class="select">
          <option>Carregando…</option>
        </select>
      </label>

      <label style="display:flex;gap:8px;align-items:center">
        <input type="radio" name="modo" value="bruto" checked> Total (bruto)
      </label>
      <label style="display:flex;gap:8px;align-items:center">
        <input type="radio" name="modo" value="liquido"> Líquido (Total − Entrega)
      </label>

      <button id="btnGo" class="btn">Recarregar</button>
      <div class="muted" id="periodoTxt">Período: —</div>
    </div>

    <div class="grid">
      <div class="card"><div class="title">Pedidos</div><div class="kpi" id="k_ped">…</div><div class="delta" id="d_ped">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="kpi" id="k_fat">…</div><div class="delta" id="d_fat">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="kpi" id="k_desc">…</div><div class="delta" id="d_desc">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="kpi" id="k_fre">…</div><div class="delta" id="d_fre">—</div></div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="title">Receita diária (R$)</div>
      <canvas id="chartDia"></canvas>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="title">Totais por dia da semana (R$)</div>
      <canvas id="chartWeek"></canvas>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
/* ====== CREDENCIAIS ====== */
const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const TABLE = "vendas_kpi";

/* ====== Helpers ====== */
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const el = s => document.querySelector(s);
const log = msg => { el("#log").textContent += "\n" + msg; };
const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
const fmtInt = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
const toISO = d => d.toISOString().slice(0,10);
const toNum = x => {
  if(x==null||x==="")return 0;
  if(typeof x==="number")return x;
  const s=String(x).trim(); if(!s) return 0;
  const t=s.replace(/\./g,"").replace(/,/g,".");
  const n=Number(t);
  return isFinite(n)?n:0;
};

/* ====== Controles ====== */
const selPeriodo = el("#selPeriodo");
const selUnidade = el("#selUnidade");
const btnGo      = el("#btnGo");
let loading = false;

/* ====== Charts ====== */
let chartDia, chartWeek;
function drawLine(id, labels, data, labelTxt){
  const ctx = el(id).getContext("2d");
  if(id==="#chartDia" && chartDia){ chartDia.destroy(); }
  if(id==="#chartWeek" && chartWeek){ chartWeek.destroy(); }
  const inst = new Chart(ctx,{
    type:"line",
    data:{ labels, datasets:[{ label:labelTxt, data, tension:.25 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:true} }, scales:{ x:{ ticks:{maxRotation:0,autoSkip:true} } } }
  });
  if(id==="#chartDia") chartDia = inst; else chartWeek = inst;
}

/* ====== Unidades (distinct) ====== */
async function loadUnidades(){
  log("[Boot] v13.7 — carregando unidades (distinct) …");
  let q = supa.from(TABLE).select('unidade',{ distinct:true }).order('unidade',{ascending:true});
  const r = await q;
  if(r.error){ log("[ERRO] Unidades: "+r.error.message); selUnidade.innerHTML = `<option>Todas</option>`; return; }
  const arr = (r.data||[]).map(x=>x.unidade).filter(Boolean);
  selUnidade.innerHTML = `<option>Todas</option>` + arr.map(u=>`<option>${u}</option>`).join("");
}

/* ====== Janela ====== */
function getWindow(days){
  const end = new Date(); end.setDate(end.getDate()-1);
  const start = new Date(end); start.setDate(end.getDate()-(Number(days)-1));
  el("#periodoTxt").textContent = `Período: ${toISO(start)} → ${toISO(end)}`;
  return { start: toISO(start), end: toISO(end) };
}

/* ====== Paginação moderada (2k por página) ====== */
async function fetchPagedRows({from,to,unidade}){
  const page = 2000; let off=0, acc=[];
  for(;;){
    let q = supa.from(TABLE)
      .select('data_venda,valor_total,desconto,entrega,unidade')
      .gte('data_venda', from).lte('data_venda', to)
      .range(off, off+page-1);
    if(unidade && unidade!=="Todas") q = q.eq('unidade', unidade);
    const r = await q;
    if(r.error) throw r.error;
    const arr = r.data||[];
    acc = acc.concat(arr);
    if(arr.length<page) break;
    off += page;
  }
  log(`[OK] Carregadas ${acc.length.toLocaleString("pt-BR")} linhas (paginado).`);
  return acc;
}

/* ====== KPIs & séries (no cliente) ====== */
async function compute({from,to,unidade,modo}){
  const rows = await fetchPagedRows({from,to,unidade});

  let pedidos = rows.length, fat=0, des=0, fre=0;
  const byDay = {};
  const add = (d,val)=>{ byDay[d]=(byDay[d]||0)+val; };

  for(const r of rows){
    const d = String(r.data_venda).slice(0,10);
    const vFat = toNum(r.valor_total);
    const vDes = toNum(r.desconto);
    const vFre = toNum(r.entrega);
    fat += vFat; des += vDes; fre += vFre;
    const val = (modo==='liquido') ? (vFat - vFre) : vFat;
    add(d, val);
  }
  const days = Object.keys(byDay).sort();
  const series = days.map(d=>byDay[d]);

  // semana
  const weekAgg = new Array(7).fill(0);
  for(const d of days){
    const wd = new Date(d+"T00:00:00").getDay();
    weekAgg[wd] += byDay[d];
  }

  return { pedidos,fat,des,fre, days,series,weekAgg };
}

/* ====== UI ====== */
function setKPIs({pedidos,fat,des,fre}){
  el("#k_ped").textContent = fmtInt(pedidos);
  el("#k_fat").textContent = fmtBRL(fat);
  el("#k_desc").textContent = fmtBRL(des);
  el("#k_fre").textContent = fmtBRL(fre);
  el("#d_ped").textContent = "—";
  el("#d_fat").textContent = "—";
  el("#d_desc").textContent = "—";
  el("#d_fre").textContent = "—";
}

/* ====== GO (com trava p/ evitar cliques múltiplos) ====== */
async function GO(){
  if(loading) return;
  loading = true;
  try{
    const days = Number(selPeriodo.value||30);
    const { start, end } = getWindow(days);
    const unidade = selUnidade.value||"Todas";
    const modo = (document.querySelector('input[name="modo"]:checked')||{}).value||'bruto';

    log(`[Query] ${TABLE} | janela ${days}d ${start} → ${end} | UNIDADE=${unidade} | modo=${modo}`);
    const res = await compute({from:start,to:end,unidade,modo});
    setKPIs(res);
    drawLine("#chartDia", res.days, res.series, "Faturamento diário (R$)");
    drawLine("#chartWeek", ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], res.weekAgg, "Totais por dia da semana (R$)");
    log("[OK] KPIs e gráficos atualizados.");
  }catch(e){
    console.error(e);
    log("[ERRO] "+(e.message||String(e)));
  }finally{
    loading = false;
  }
}

/* ====== Boot ====== */
(async function(){
  await loadUnidades();
  selPeriodo.value = "30";
  btnGo.onclick = GO;
  selPeriodo.onchange = GO;
  selUnidade.onchange = GO;
  document.querySelectorAll('input[name="modo"]').forEach(r=>r.onchange=GO);
  GO();
})();
</script>
</body>
</html>
