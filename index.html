<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Maestro Food</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%232563eb'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='54' fill='white' font-family='system-ui,sans-serif'%3EM%3C/text%3E%3C/svg%3E"/>
<style>
:root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626;--chip:#eef2ff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 4px}
.muted{color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
.topbar{display:flex;gap:8px;align-items:center}
button,input,select{font:inherit;border:1px solid var(--brd);border-radius:10px;background:#fff;padding:8px 10px}
button{cursor:pointer}button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
button.ghost{background:#fff}
.card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
.grid{display:grid;gap:12px}.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.kpi{position:relative}.kpi .title{font-size:12px;color:var(--muted)}.kpi .val{font-size:22px;font-weight:700;margin-top:4px}
.delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600}
.delta.up{color:var(--good)}.delta.down{color:var(--bad)}
.chartbox{position:relative;height:300px}
.pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
.pill button{border:0;padding:6px 10px;background:#fff}
.pill button.active{background:var(--accent);color:#fff}
details.filter{border:1px solid var(--brd);border-radius:12px;background:#fff}
details.filter>summary{padding:12px 14px;list-style:none;display:flex;align-items:center;justify-content:space-between;cursor:pointer;font-weight:600}
details.filter[open]>summary{border-bottom:1px solid var(--brd)}
details.filter .body{padding:12px 14px}
.filters{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
.seg{display:flex;gap:8px;align-items:center}.seg .lbl{font-size:12px;color:var(--muted);white-space:nowrap}.seg .grow{width:100%}
.chips{display:flex;gap:6px;flex-wrap:wrap}.chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}.chip.active{background:#dbeafe;border-color:#bfdbfe}
.hint{font-size:12px;color:var(--muted)}
progress{width:240px;height:10px}
@media (max-width:940px){.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}.filters{grid-template-columns:repeat(6,1fr)}}
@media (max-width:560px){.cols-4,.cols-3,.cols-2{grid-template-columns:1fr}.filters{grid-template-columns:repeat(4,1fr)}}
.gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:20}
.gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
.tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
.tabs button{flex:1;border:0;background:#fff;padding:8px 10px}.tabs button.active{background:var(--accent);color:#fff}
.field{display:flex;flex-direction:column;margin-top:8px}.field label{font-size:12px;color:var(--muted);margin-bottom:4px}
.error{color:#b91c1c;font-size:12px;min-height:16px;margin-top:6px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<!-- AUTH -->
<div id="gate" class="gate" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 8px">Entrar</h3>
    <div class="tabs">
      <button id="tabLogin" class="active">Login</button>
      <button id="tabSignup">Criar conta</button>
    </div>
    <div class="field"><label for="authEmail">E-mail</label><input id="authEmail" type="email" placeholder="voce@empresa.com"/></div>
    <div class="field" id="passRow"><label for="authPass">Senha</label><input id="authPass" type="password" placeholder="••••••••"/></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnForgot" class="ghost">Esqueci a senha</button>
      <button id="btnSignup" style="display:none">Criar conta</button>
      <button id="btnLogin" class="primary">Entrar</button>
    </div>
    <div class="error" id="authErr"></div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="toolbar">
    <h1>Maestro Food</h1>
    <div class="topbar">
      <span class="muted" id="who"></span>
      <button id="btnLogout" class="ghost">Sair</button>
    </div>
  </div>

  <!-- FILTROS -->
  <details class="filter" id="fx" open>
    <summary>FILTROS <span id="btnClear" class="muted" style="font-weight:400">Limpar</span></summary>
    <div class="body">
      <div class="filters">
        <div class="col-6 seg"><span class="lbl">Unidade</span><select id="uni" class="grow"></select></div>
        <div class="col-6 seg"><span class="lbl">Nome da loja (Top 10)</span><div id="lojas" class="chips"></div></div>

        <div class="col-3 seg"><span class="lbl">De</span><input id="dini" type="date" class="grow"></div>
        <div class="col-3 seg"><span class="lbl">Até</span><input id="dfim" type="date" class="grow"></div>
        <div class="col-3 seg"><span class="lbl">Período rápido</span>
          <select id="pr" class="grow">
            <option value="7">Últimos 7</option>
            <option value="15">Últimos 15</option>
            <option value="30" selected>Últimos 30</option>
            <option value="90">Últimos 90</option>
            <option value="180">Últimos 180</option>
            <option value="360">Últimos 360</option>
          </select>
        </div>
        <div class="col-3 seg"><span class="lbl">Turno</span>
          <select id="turno" multiple class="grow">
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>

        <div class="col-4 seg"><span class="lbl">Canal de venda</span><select id="canal" multiple class="grow"></select></div>
        <div class="col-4 seg"><span class="lbl">Pagamento</span><select id="pag" multiple class="grow"></select></div>
        <div class="col-4 seg"><span class="lbl">Está cancelado?</span>
          <select id="canc" class="grow"><option value="Todos">Todos</option><option value="Não" selected>Não</option><option value="Sim">Sim</option></select>
        </div>

        <!-- ADMIN: Import CSV -->
        <div class="col-12 card" style="border-style:dashed">
          <b>Admin — Importar CSV (<i>Pasta2.csv</i>)</b> • o intervalo do arquivo é limpo antes de inserir
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <input id="csvfile" type="file" accept=".csv"/>
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" value="0" max="100" style="display:none"></progress>
            <span class="muted" id="impMsg"></span>
          </div>
        </div>
      </div>
    </div>
  </details>

  <!-- KPIs -->
  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
    <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
    <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
    <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
  </div>
  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
    <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
    <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
    <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
  </div>
  <div class="grid cols-2" style="margin-top:12px">
    <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
    <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
  </div>

  <!-- GRÁFICOS -->
  <div class="card" style="margin-top:12px">
    <div class="toolbar"><div class="title">Receita diária</div>
      <div class="pill" data-target="lineMode"><button data-val="total" class="active">Total</button><button data-val="media">Média (7d)</button></div>
    </div>
    <div class="chartbox"><canvas id="cLine"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar"><div class="title">Receita por dia da semana</div>
      <div class="pill" data-target="dowMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cDowFat"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar"><div class="title">Pedidos por dia da semana</div>
      <div class="pill" data-target="dowPedMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cDowPed"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar"><div class="title">Receita por hora</div>
      <div class="pill" data-target="hourMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cHour"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar"><div class="title">Receita por mês</div>
      <div class="pill" data-target="monMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cMonth"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar"><div class="title">Top 10 Lojas</div>
      <div class="pill" data-target="topMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cTop"></canvas></div>
  </div>
</div>

<script>
(function(){
  // ====== CONFIG ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE   = "vendas_kpi_daily_v2";      // view/tabela de leitura
  const STAGING = "vendas_kpi_daily_v2_data"; // tabela de escrita (import)
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true } });

  // ====== HELPERS ======
  const $ = (id)=>document.getElementById(id);
  const fmtBRL = (n)=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = (n)=>new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = (d)=>{ if(!(d instanceof Date) || isNaN(d)) return ""; return d.toISOString().slice(0,10); };
  const parseISO = (s)=>{ const d = new Date(s+"T00:00:00Z"); return d; };
  const addDays = (d,k)=>{ const t = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); t.setUTCDate(t.getUTCDate()+k); return t; };
  const movingAvg = (arr,win)=>{ const out=[],q=[]; let sum=0; for(let v of arr){ q.push(v); sum+=v; if(q.length>win) sum-=q.shift(); out.push(sum/q.length); } return out; };
  const setDelta = (el, cur, prev)=>{ const pct = prev>0 ? ( (cur-prev)/prev*100 ) : 0; const up = pct>=0; el.className="delta "+(up?"up":"down"); el.textContent=((up?"+":"")+pct.toFixed(1)+"% "+(up?"▲":"▼")); };

  // ====== STATE ======
  const gate = $("gate"), app=$("app"), who=$("who");
  const dini=$("dini"), dfim=$("dfim"), pr=$("pr"), uni=$("uni"), turno=$("turno"), canal=$("canal"), pag=$("pag"), canc=$("canc");
  const lojasBox=$("lojas");
  let minISO=null, maxISO=null;
  let chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  let lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";

  // ====== AUTH UI ======
  const tabLogin=$("tabLogin"), tabSignup=$("tabSignup"), authEmail=$("authEmail"), authPass=$("authPass"), authErr=$("authErr"), btnLogin=$("btnLogin"), btnSignup=$("btnSignup"), btnForgot=$("btnForgot");
  tabLogin.onclick=()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; $("passRow").style.display="flex"; authErr.textContent=""; };
  tabSignup.onclick=()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; $("passRow").style.display="flex"; authErr.textContent=""; };
  btnLogin.onclick=async()=>{ authErr.textContent=""; const email=(authEmail.value||"").trim(), pass=authPass.value||""; if(!email||!pass){authErr.textContent="Informe e-mail e senha.";return;}
    const {error}=await supa.auth.signInWithPassword({email,password:pass}); if(error){authErr.textContent=error.message;return;} await afterLogin();};
  btnSignup.onclick=async()=>{ authErr.textContent=""; const email=(authEmail.value||"").trim(), pass=authPass.value||""; if(!email||!pass){authErr.textContent="Informe e-mail e senha.";return;}
    const {error}=await supa.auth.signUp({email,password:pass}); if(error){authErr.textContent=error.message;return;} authErr.textContent="Conta criada. Verifique seu e-mail se necessário."; };
  btnForgot.onclick=async()=>{ authErr.textContent=""; const email=(authEmail.value||"").trim(); if(!email){authErr.textContent="Digite seu e-mail e clique novamente."; return;}
    const {error}=await supa.auth.resetPasswordForEmail(email,{redirectTo:location.href}); authErr.textContent = error? error.message : "Enviamos um link para redefinição de senha."; };
  supa.auth.onAuthStateChange(async (ev, session)=>{ if(ev==="PASSWORD_RECOVERY"){ // modal simples de nova senha
      const nova = prompt("Digite a nova senha:"); if(nova){ await supa.auth.updateUser({ password:nova }); alert("Senha alterada. Faça login."); } } });

  async function afterLogin(){ const {data:{user}}=await supa.auth.getUser(); who.textContent=user?.email||""; gate.style.display="none"; app.style.display="block"; await boot(); }
  $("btnLogout").onclick=async()=>{ await supa.auth.signOut(); app.style.display="none"; gate.style.display="flex"; };

  // ====== BOOT ======
  async function boot(){
    // Limites de data (se vazio, evita crash)
    const a = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const b = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO = a.data?.[0]?.dia || "2025-01-01";
    maxISO = b.data?.[0]?.dia || toISO(new Date());
    dini.min=minISO; dfim.min=minISO; dini.max=maxISO; dfim.max=maxISO;

    // Período inicial (Últimos 30 até o maxISO)
    const end = parseISO(maxISO), start = addDays(end,-29);
    dini.value = toISO(start); dfim.value = toISO(end);

    // Unidades
    const r = await supa.from(TABLE).select("unidade").order("unidade").range(0,9999);
    const set = new Set((r.data||[]).map(x=>(x.unidade||"").trim()).filter(Boolean));
    uni.innerHTML = `<option>Todas</option>` + Array.from(set).map(u=>`<option>${u}</option>`).join("");

    // Opções Canal/Pagamento
    const r2 = await supa.from(TABLE).select('"Canal de venda",pagamento').range(0,9999);
    const canals = new Set((r2.data||[]).map(x=>x["Canal de venda"]).filter(Boolean));
    const pags   = new Set((r2.data||[]).map(x=>x["pagamento"]).filter(Boolean));
    canal.innerHTML = Array.from(canals).sort().map(v=>`<option>${v}</option>`).join("");
    pag.innerHTML   = Array.from(pags).sort().map(v=>`<option>${v}</option>`).join("");

    // Interações
    ["change","input"].forEach(evt=>{
      [uni,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>el.addEventListener(evt, ()=>{ if(el===pr){ // snap rápido
        const days = Number(pr.value||30), end = parseISO(dfim.value||maxISO), start = addDays(end, -(days-1)); dini.value=toISO(start); }
        $("fx").open=false; recarregar(); }));
    });
    $("btnClear").onclick=(e)=>{ e.preventDefault(); uni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Não"; Array.from(lojasBox.children).forEach(c=>c.classList.remove("active")); recarregar(); };

    // Botões "Total/Média"
    document.querySelectorAll(".pill").forEach(p=>{
      p.addEventListener("click", (ev)=>{
        const btn = ev.target.closest("button"); if(!btn) return;
        p.querySelectorAll("button").forEach(b=>b.classList.toggle("active", b===btn));
        const t = p.getAttribute("data-target"); const v = btn.getAttribute("data-val");
        if(t==="lineMode") lineMode=v; if(t==="dowMode") dowMode=v; if(t==="dowPedMode") dowPedMode=v; if(t==="hourMode") hourMode=v; if(t==="monMode") monMode=v; if(t==="topMode") topMode=v;
        recarregar();
      });
    });

    await recarregar();
  }

  // ====== QUERY + RENDER ======
  function destroy(c){ if(c){ try{c.destroy();}catch(e){} } return null; }

  async function queryRange(startISO, endISO, filtros){
    let q = supa.from(TABLE).select('dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora').gte("dia",startISO).lte("dia",endISO).order("dia",{ascending:true});
    if(filtros.uni && filtros.uni!=="Todas") q = q.eq("unidade", filtros.uni);
    if(filtros.lojas?.length) q = q.in("Nome da Loja", filtros.lojas);
    if(filtros.turno?.length) q = q.in("turno", filtros.turno);
    if(filtros.canal?.length) q = q.in("Canal de venda", filtros.canal);
    if(filtros.pag?.length)   q = q.in("pagamento", filtros.pag);
    if(filtros.canc && filtros.canc!=="Todos") q = q.eq("cancelado", filtros.canc);
    const {data,error} = await q; if(error) throw error;
    return data||[];
  }

  function groupSum(arr, keyFn, valFn){
    const m=new Map(); for(const r of arr){ const k=keyFn(r); m.set(k,(m.get(k)||0)+valFn(r)); }
    const labels=Array.from(m.keys()).sort(); const values=labels.map(k=>m.get(k)); return {labels,values};
  }

  async function recarregar(){
    const s = dini.value || minISO, e = dfim.value || maxISO;
    const filtros = {
      uni: uni.value||"Todas",
      lojas: Array.from(lojasBox.querySelectorAll(".chip.active")).map(c=>c.dataset.v),
      turno: Array.from(turno.selectedOptions).map(o=>o.value),
      canal: Array.from(canal.selectedOptions).map(o=>o.value),
      pag:   Array.from(pag.selectedOptions).map(o=>o.value),
      canc:  canc.value||"Não",
    };

    const cur = await queryRange(s,e,filtros);
    // período anterior (mesmo nº de dias)
    const len = Math.max(1, Math.round((parseISO(e)-parseISO(s))/(24*3600*1000))+1);
    const ePrev = addDays(parseISO(s),-1), sPrev = addDays(ePrev, -(len-1));
    const ant = await queryRange(toISO(sPrev), toISO(ePrev), filtros);

    // KPIs
    const sumN = (a,k)=>a.reduce((s,x)=>s+Number(x[k]||0),0);
    const ped=sumN(cur,"pedidos"), fat=sumN(cur,"fat"), des=sumN(cur,"des"), fre=sumN(cur,"fre");
    const pedA=sumN(ant,"pedidos"), fatA=sumN(ant,"fat"), desA=sumN(ant,"des"), freA=sumN(ant,"fre");
    const dias = new Set(cur.map(x=>x.dia)).size || 1, diasA = new Set(ant.map(x=>x.dia)).size || 1;
    const tkm = ped>0? fat/ped:0, tkmA = pedA>0? fatA/pedA:0;
    const fmd = fat/dias, fmdA = fatA/diasA;
    const fatL = fat - des - fre - 0.12*fat, fatLA = fatA - desA - freA - 0.12*fatA;
    const desP = fat>0? (des/fat*100):0, desPA = fatA>0? (desA/fatA*100):0;
    const freM = ped>0? fre/ped:0, freMA = pedA>0? freA/pedA:0;
    const fatLP = fat>0? (fatL/fat*100):0, fatLPA = fatA>0? (fatLA/fatA*100):0;

    $("k_ped").textContent=fmtInt(ped); $("k_tkm").textContent=fmtBRL(tkm); $("k_fat").textContent=fmtBRL(fat); $("k_fmd").textContent=fmtBRL(fmd);
    $("k_des").textContent=fmtBRL(des); $("k_desp").textContent=desP.toFixed(1)+"%"; $("k_fre").textContent=fmtBRL(fre); $("k_frem").textContent=fmtBRL(freM);
    $("k_fatl").textContent=fmtBRL(fatL); $("k_fatlp").textContent=fatLP.toFixed(1)+"%";
    setDelta($("d_ped"),ped,pedA); setDelta($("d_tkm"),tkm,tkmA); setDelta($("d_fat"),fat,fatA); setDelta($("d_fmd"),fmd,fmdA);
    setDelta($("d_des"),des,desA); setDelta($("d_desp"),desP,desPA); setDelta($("d_fre"),fre,freA); setDelta($("d_frem"),freM,freMA);
    setDelta($("d_fatl"),fatL,fatLA); setDelta($("d_fatlp"),fatLP,fatLPA);

    // LINE com sombra (período anterior preenchendo área)
    const byDay = groupSum(cur, r=>r.dia, r=>Number(r.fat||0));
    const byDayPrev = groupSum(ant, r=>r.dia, r=>Number(r.fat||0));
    const main = (lineMode==="media")? movingAvg(byDay.values,7): byDay.values.slice();
    chartLine = destroy(chartLine);
    chartLine = new Chart($("cLine").getContext("2d"),{
      type:"line",
      data:{labels:byDay.labels,datasets:[
        {data:byDayPrev.values,fill:true,backgroundColor:"rgba(2,132,199,.12)",borderWidth:0,pointRadius:0,tension:.25},
        {data:main,borderWidth:2,pointRadius:0,tension:.25}
      ]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // DOW (fat)
    const lblDOW=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    const mF=[0,0,0,0,0,0,0], cF=[0,0,0,0,0,0,0];
    const diasSet=new Set(cur.map(r=>r.dia)); Array.from(diasSet).forEach(d=>cF[new Date(d).getUTCDay()]++);
    cur.forEach(r=>{ mF[new Date(r.dia).getUTCDay()]+=Number(r.fat||0); });
    chartDowFat = destroy(chartDowFat);
    chartDowFat = new Chart($("cDowFat").getContext("2d"), {type:"bar",data:{labels:lblDOW,datasets:[{data:(dowMode==="media")? mF.map((v,i)=>v/(cF[i]||1)):mF}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

    // DOW (pedidos)
    const mP=[0,0,0,0,0,0,0], cP=[...cF];
    cur.forEach(r=>{ mP[new Date(r.dia).getUTCDay()]+=Number(r.pedidos||0); });
    chartDowPed = destroy(chartDowPed);
    chartDowPed = new Chart($("cDowPed").getContext("2d"), {type:"bar",data:{labels:lblDOW,datasets:[{data:(dowPedMode==="media")? mP.map((v,i)=>v/(cP[i]||1)):mP}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

    // HORA
    const mH=Array(24).fill(0), dH=Array(24).fill(0).map(()=>new Set());
    cur.forEach(r=>{ if(r.hora==null) return; const h=+r.hora; if(h>=0&&h<=23){ mH[h]+=Number(r.fat||0); dH[h].add(r.dia); }});
    const totalDays = new Set(cur.map(r=>r.dia)).size || 1;
    const labH=[], totH=[], cntH=[];
    for(let h=0;h<24;h++){ const act=dH[h].size; const keep = act >= Math.ceil(totalDays*0.5) && mH[h]>0; if(keep){ labH.push(String(h).padStart(2,"0")+":00"); totH.push(mH[h]); cntH.push(act);} }
    chartHour = destroy(chartHour);
    chartHour = new Chart($("cHour").getContext("2d"), {type:"bar",data:{labels:labH,datasets:[{data:(hourMode==="media")? totH.map((v,i)=>v/(cntH[i]||1)):totH}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

    // MÊS
    const mM=new Map(), cM=new Map(), daysPerMonth=new Map();
    cur.forEach(r=>{ const ym=r.dia.slice(0,7); mM.set(ym,(mM.get(ym)||0)+Number(r.fat||0)); if(!daysPerMonth.has(ym)) daysPerMonth.set(ym,new Set()); daysPerMonth.get(ym).add(r.dia); });
    Array.from(daysPerMonth.keys()).forEach(ym=>cM.set(ym,daysPerMonth.get(ym).size));
    const labM=Array.from(mM.keys()).sort(), totM=labM.map(x=>mM.get(x)), cntM=labM.map(x=>cM.get(x)||1);
    chartMonth = destroy(chartMonth);
    chartMonth = new Chart($("cMonth").getContext("2d"), {type:"bar",data:{labels:labM,datasets:[{data:(monMode==="media")? totM.map((v,i)=>v/(cntM[i]||1)):totM}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

    // TOP 10 lojas + chips
    const byLoja = new Map(); cur.forEach(r=>{ const n=r["Nome da Loja"]||r.unidade||"—"; byLoja.set(n,(byLoja.get(n)||0)+Number(r.fat||0)); });
    const top = Array.from(byLoja.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const labs=top.map(x=>x[0]), vals=top.map(x=>x[1]), counts=labs.map(_=>dias);
    chartTop = destroy(chartTop);
    chartTop = new Chart($("cTop").getContext("2d"), {type:"bar",data:{labels:labs,datasets:[{data:(topMode==="media")? vals.map((v,i)=>v/(counts[i]||1)):vals}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
    if(lojasBox.children.length===0){
      lojasBox.innerHTML="";
      labs.forEach(lbl=>{ const chip=document.createElement("span"); chip.className="chip"; chip.textContent=lbl; chip.dataset.v=lbl; chip.onclick=()=>{ chip.classList.toggle("active"); recarregar(); }; lojasBox.appendChild(chip); });
    }
  }

  // ====== IMPORT CSV (Pasta2.csv bruto -> agrega e grava em STAGING) ======
  $("btnImport").onclick=async function(){
    try{
      const file = $("csvfile").files?.[0]; if(!file){ $("impMsg").textContent="Selecione o arquivo Pasta2.csv"; return; }
      const prog=$("prog"); prog.style.display="inline-block"; prog.value=0; $("impMsg").textContent="Lendo arquivo…";

      // Parse com Papa (delimitador ';', header)
      const rows = await new Promise((resolve,reject)=>{
        Papa.parse(file,{ header:true, delimiter:";", skipEmptyLines:true, dynamicTyping:false, encoding:"UTF-8",
          complete:(res)=>resolve(res.data||[]), error:(err)=>reject(err) });
      });

      // Normalização números PT-BR
      const pt = (v)=>{ if(v==null||v==="") return 0; if(typeof v==="number") return v; v=(v+"").trim().replace(/\./g,"").replace(",","."); const n=Number(v); return isNaN(n)?0:n; };
      // Pega campo tolerante a maiúscula/acentos
      const get = (o, arr)=>{ for(const k of arr){ if(k in o) return o[k]; const ks = Object.keys(o); const f = ks.find(x=>x.toLowerCase()===k.toLowerCase()); if(f) return o[f]; } return ""; };

      // Mapa agregado
      const map = new Map(); let min=null, max=null;
      for(const r of rows){
        const dataVenda = get(r,["Data da venda"]);
        if(!dataVenda) continue;
        // dd/mm/aaaa HH:MM
        const m = dataVenda.match(/(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2}))?/);
        if(!m) continue;
        const d = new Date(Date.UTC(+m[3], (+m[2]-1), +m[1], +(m[4]||"0"), +(m[5]||"0")));
        const dia = toISO(d); const hora = d.getUTCHours();

        min = (min==null || dia<min)? dia:min; max = (max==null || dia>max)? dia:max;

        const unidade   = (get(r,["Unidade"])||"").trim() || "—";
        const lojaRaw   = (get(r,["Nome da loja","Nome da Loja","Loja"])||"").trim();
        const nomeLoja  = lojaRaw || unidade; // fallback
        const turnoV    = (get(r,["Turno"])||"").trim();
        const canalV    = (get(r,["Canal de venda"])||"").trim();
        const pagV      = (get(r,["Forma de pagamento","Pagamento"])||"").trim();
        const cancV     = (get(r,["Está cancelado","Cancelado"])||"Não").toString().match(/sim/i)?"Sim":"Não";

        const fat = pt(get(r,["Total"]));
        const des = pt(get(r,["Desconto"]));
        const fre = pt(get(r,["Total taxa de serviço","Taxa de entrega","Taxa"]));

        const key = JSON.stringify([dia,unidade,nomeLoja,turnoV,canalV,pagV,cancV,hora]);
        const cur = map.get(key) || { dia, unidade, pedidos:0, fat:0, des:0, fre:0, "Nome da Loja":nomeLoja, turno:turnoV, "Canal de venda":canalV, pagamento:pagV, cancelado:cancV, hora };
        cur.pedidos += 1; cur.fat += fat; cur.des += des; cur.fre += fre;
        map.set(key, cur);
      }
      const agg = Array.from(map.values());
      if(agg.length===0){ $("impMsg").textContent="Nada para importar. Confira o arquivo."; prog.style.display="none"; return; }

      $("impMsg").textContent=`Agregando ${agg.length.toLocaleString("pt-BR")} linhas…`;
      // Limpa intervalo no STAGING
      if(min && max){
        await supa.from(STAGING).delete().gte("dia",min).lte("dia",max);
      }

      // Inserção em lotes
      const CHUNK=500; let done=0;
      for(let i=0;i<agg.length;i+=CHUNK){
        const slice = agg.slice(i,i+CHUNK).map(x=>({
          dia:x.dia, unidade:x.unidade, pedidos:Math.round(x.pedidos), fat:+x.fat.toFixed(2), des:+x.des.toFixed(2), fre:+x.fre.toFixed(2),
          "Nome da Loja": x["Nome da Loja"], turno:x.turno, "Canal de venda":x["Canal de venda"], pagamento:x.pagamento, cancelado:x.cancelado, hora:x.hora
        }));
        const {error} = await supa.from(STAGING).insert(slice);
        if(error){ $("impMsg").textContent = "Erro ao inserir: "+error.message; prog.style.display="none"; return; }
        done += slice.length; prog.value = Math.round(done/agg.length*100);
      }
      $("impMsg").textContent = `Importação concluída (${done.toLocaleString("pt-BR")} registros). Atualizando…`;
      prog.style.display="none";
      // Recarrega filtros/limites e fecha box
      await boot();
      $("fx").open=false;

    }catch(err){
      $("impMsg").textContent = "Falha: "+(err.message||err);
      $("prog").style.display="none";
    }
  };

  // ====== START ======
  (async ()=>{
    const {data:{session}} = await supa.auth.getSession();
    if(session){ app.style.display="block"; gate.style.display="none"; who.textContent=session.user?.email||""; await boot(); }
    else { gate.style.display="flex"; app.style.display="none"; }
  })();

})();
</script>
</body>
</html>
