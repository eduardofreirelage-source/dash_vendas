<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232563eb'/%3E%3Ctext x='32' y='38' font-size='26' text-anchor='middle' fill='%23fff' font-family='Arial'%3EMF%3C/text%3E%3C/svg%3E">
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff; --warn:#eab308; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px;cursor:pointer}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)} .delta.warn{color:var(--warn)}
    .sparkline{height:30px;width:100px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff;cursor:pointer}
    .pill button.active{background:var(--accent);color:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,button,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    input[type="date"]{padding:7px 10px}
    input[type="number"]{width:100px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    .chartbox{position:relative;height:300px;width:100%}
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .grow{min-width:180px}
    .right{margin-left:auto}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .status{font-size:12px}
    .status.ok{color:var(--good)} .status.err{color:var(--bad)}
    .hidden{display:none !important}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-box{background:#fff;border-radius:14px;padding:16px;max-width:500px;width:90%}
    @media (max-width:980px){
      .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
      .filters-grid{grid-template-columns:repeat(6,1fr)}
      .grow{min-width:140px}
    }
    @media (max-width:560px){
      .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}
      .filters-grid{grid-template-columns:repeat(4,1fr)}
      .grow{min-width:120px}
    }
    .filter-section{border-top:1px solid var(--brd);padding-top:12px;margin-top:12px}
    .filter-section:first-child{border-top:none;padding-top:0;margin-top:0}
    /* AUTH */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px;cursor:pointer}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso — Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div id="authForm">
        <div class="field">
          <label for="authEmail">E-mail</label>
          <input id="authEmail" type="email" autocomplete="email" placeholder="voce@empresa.com" />
        </div>
        <div class="field" id="passRow">
          <label for="authPass">Senha</label>
          <input id="authPass" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
        <div class="field hidden" id="newPassRow">
          <label for="newPass">Nova senha</label>
          <input id="newPass" type="password" autocomplete="new-password" placeholder="Nova senha" />
        </div>
        <div class="row" style="margin-top:10px;justify-content:space-between">
          <span class="muted" id="forgot" style="cursor:pointer">Esqueci a senha</span>
          <div>
            <button id="btnSignup" style="display:none">Criar conta</button>
            <button id="btnLogin">Entrar</button>
            <button id="btnSaveNew" style="display:none">Salvar nova senha</button>
          </div>
        </div>
        <div class="error" id="authErr"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <div class="topbar">
        <span class="status" id="statusTxt"></span>
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filterbox" id="fx">
      <summary>
        FILTROS
        <span class="muted right" id="limpar" title="Limpar filtros" style="font-weight:400">Limpar</span>
      </summary>
      <div class="body">
        <div class="filters-grid">
          <div class="filter-section col-12">
            <div class="row">
              <span class="lbl">Unidade</span>
              <select id="uni" class="grow">
                <option>Todas</option>
              </select>
            </div>
          </div>
          <div class="filter-section col-12">
            <div class="row">
              <span class="lbl">Nome da loja (Top 10)</span>
              <div id="lojas" class="chips"></div>
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">De</span>
              <input type="date" id="dini" class="grow" />
              <span class="lbl" style="margin-left:10px">Até</span>
              <input type="date" id="dfim" class="grow" />
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">Período rápido</span>
              <select id="pr" class="grow">
                <option value="7">Últimos 7</option>
                <option value="15">Últimos 15</option>
                <option value="30" selected>Últimos 30</option>
                <option value="90">Últimos 90</option>
                <option value="180">Últimos 180</option>
                <option value="360">Últimos 360</option>
              </select>
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">Turno</span>
              <select id="turno" class="grow" multiple>
                <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
              </select>
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">Canal de venda</span>
              <select id="canal" class="grow" multiple></select>
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">Pagamento</span>
              <select id="pag" class="grow" multiple></select>
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">Está cancelado?</span>
              <select id="canc" class="grow">
                <option value="Todos" selected>Todos</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">CMV %</span>
              <input type="number" id="cmvPct" class="grow" value="30" min="0" max="100" step="0.1" />
            </div>
          </div>
          <div class="filter-section col-6">
            <div class="row">
              <span class="lbl">Custos Fixos %</span>
              <input type="number" id="fixPct" class="grow" value="10" min="0" max="100" step="0.1" />
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="applyFilters">Aplicar</button>
          <div class="muted" id="impMsg"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <input type="file" id="csvfile" accept=".csv" />
          <button id="btnImport">Importar CSV (incremental)</button>
          <progress id="prog" value="0" max="100" style="display:none"></progress>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi">
        <div class="title">Pedidos</div><div class="val" id="k_ped">—</div>
        <div class="delta" id="d_ped">—</div>
        <canvas class="sparkline" id="s_ped"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Ticket Médio (por Canal)</div><div class="val" id="k_tkm">—</div>
        <div class="delta" id="d_tkm">—</div>
        <canvas class="sparkline" id="s_tkm"></canvas>
      </div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi">
        <div class="title">Faturamento</div><div class="val" id="k_fat">—</div>
        <div class="delta" id="d_fat">—</div>
        <canvas class="sparkline" id="s_fat"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento Médio (Dia)</div><div class="val" id="k_fmd">—</div>
        <div class="delta" id="d_fmd">—</div>
        <canvas class="sparkline" id="s_fmd"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div>
        <div class="delta" id="d_fatl">—</div>
        <canvas class="sparkline" id="s_fatl"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div>
        <div class="delta" id="d_fatlp">—</div>
        <canvas class="sparkline" id="s_fatlp"></canvas>
      </div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi">
        <div class="title">Margem de Contribuição %</div><div class="val" id="k_marg">—</div>
        <div class="delta" id="d_marg">—</div>
        <canvas class="sparkline" id="s_marg"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">ROI Incentivos %</div><div class="val" id="k_roi">—</div>
        <div class="delta" id="d_roi">—</div>
        <canvas class="sparkline" id="s_roi"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Custo por Pedido</div><div class="val" id="k_cpp">—</div>
        <div class="delta" id="d_cpp">—</div>
        <canvas class="sparkline" id="s_cpp"></canvas>
      </div>
      <div class="card kpi">
        <div class="title">Churn de Lojas %</div><div class="val" id="k_churn">—</div>
        <div class="delta" id="d_churn">—</div>
        <canvas class="sparkline" id="s_churn"></canvas>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária (Stacked por Canal) — forecast em dashed</div>
        <div class="pill" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média (7d)</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana</div>
        <div class="pill" data-target="dowMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora (0–23)</div>
        <div class="pill" data-target="hourMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
      <div class="muted" style="margin-top:6px">Oculto horários com baixa atividade (&gt;30min sem venda).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por mês (Waterfall: Ganhos vs. Perdas)</div>
        <div class="pill" data-target="monMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas (Treemap)</div>
        <div class="pill" data-target="topMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pareto de Canais (80/20)</div>
        <div class="pill" data-target="paretoMode">
          <button data-val="total" class="active">Total</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cPareto"></canvas></div>
    </div>

    <!-- Modal para Breakdown -->
    <div class="modal" id="kpiModal">
      <div class="modal-box">
        <h3 id="modalTitle"></h3>
        <div id="modalContent"></div>
        <button onclick="document.getElementById('kpiModal').classList.remove('active')">Fechar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // Supabase Config
  var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });

  // Fonte
  var SOURCE_PREF = "vendas_kpi_daily_v2_data";
  var SOURCE_FALL = "vendas_kpi_daily_v2";
  var TABLE = null;
  var keyLoja = "Nome da loja";
  var keyCanal = "Canal de venda";

  // Estado/UI
  var app=document.getElementById("app"), gate=document.getElementById("gate");
  var who=document.getElementById("who"), statusTxt=document.getElementById("statusTxt");
  var uni=document.getElementById("uni"), lojasBox=document.getElementById("lojas");
  var dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  var turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  var cmvPct=document.getElementById("cmvPct"), fixPct=document.getElementById("fixPct");
  var periodoTxt=document.getElementById("periodo"), fx=document.getElementById("fx");
  var csvfile=document.getElementById("csvfile"), btnImport=document.getElementById("btnImport"), prog=document.getElementById("prog"), impMsg=document.getElementById("impMsg");
  var applyFilters = document.getElementById("applyFilters");

  // AUTH
  var tabLogin=document.getElementById("tabLogin"), tabSignup=document.getElementById("tabSignup");
  var authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass");
  var btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup"), btnLogout=document.getElementById("btnLogout");
  var authErr=document.getElementById("authErr"), forgot=document.getElementById("forgot");
  var newPassRow=document.getElementById("newPassRow"), passRow=document.getElementById("passRow"), newPass=document.getElementById("newPass"), btnSaveNew=document.getElementById("btnSaveNew");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }

  tabLogin.addEventListener("click", ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; });
  tabSignup.addEventListener("click", ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; });

  btnLogin.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
    afterLogin();
  });
  btnSignup.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password: pass });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail se necessário.";
  });
  btnLogout.addEventListener("click", async ()=>{ await supa.auth.signOut(); showGate(); });

  forgot.addEventListener("click", async ()=>{
    const email=(authEmail.value||"").trim();
    if(!email){ authErr.textContent="Digite seu e-mail e clique novamente."; return; }
    const { error } = await supa.auth.resetPasswordForEmail(email, { redirectTo: location.origin + location.pathname });
    authErr.textContent = error ? error.message : "Enviamos o link de redefinição para seu e-mail.";
  });
  function checkRecovery(){
    const hash = location.hash||"";
    if(hash.includes("access_token") || (new URLSearchParams(location.search)).get("type")==="recovery"){
      passRow.classList.add("hidden");
      newPassRow.classList.remove("hidden");
      btnLogin.style.display="none"; btnSignup.style.display="none"; btnSaveNew.style.display="inline-block";
      authErr.textContent = "Defina sua nova senha:";
    }
  }
  btnSaveNew.addEventListener("click", async ()=>{
    const np = (newPass.value||"").trim();
    if(!np){ authErr.textContent="Informe a nova senha."; return; }
    const { error } = await supa.auth.updateUser({ password: np });
    authErr.textContent = error ? error.message : "Senha atualizada. Faça login novamente.";
  });

  supa.auth.onAuthStateChange((_e, session)=>{
    if(session){ hideGate(); afterLogin(); } else { showGate(); }
  });

  // Utils
  function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt; }
  function setDelta(el, cur, prev, benchmark=null){
    const pct = prev>0 ? ((cur-prev)/prev*100) : 0;
    const cls = benchmark ? (cur>=benchmark ? "up" : (cur>0.98*benchmark ? "warn" : "down")) : (pct>=0 ? "up" : "down");
    const arrow = pct>=0 ? "▲" : "▼";
    el.className="delta "+cls;
    el.textContent=(pct>=0?"+":"")+pct.toFixed(1)+"% "+arrow;
    if(benchmark) el.textContent += ` (Meta: ${benchmark.toFixed(1)}%)`;
  }
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ if(!(d instanceof Date) || isNaN(d)) return null; return d.toISOString().slice(0,10); }
  function parseISO(s){ if(!s) return null; return new Date(s+"T00:00:00Z"); }
  function addDays(d, k){ const t=new Date(d.getTime()); t.setUTCDate(t.getUTCDate()+k); return t; }
  function movingAvg(arr, win){ const out=[]; let acc=0; for(let i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push(acc / Math.min(i+1,win)); } return out; }
  function avg(a,b){ return b>0 ? a/b : 0; }

  var chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null, chartPareto=null;
  var lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total", paretoMode="total";
  function destroyChart(c){ if(c){ try{c.destroy();}catch(e){} } return null; }

  var minISO=null, maxISO=null;
  var diasSet = new Set();

  async function pickSource() {
    TABLE = null;
    setText("statusTxt", "Conectando ao Supabase...");
    let r = await supa.from(SOURCE_PREF).select("dia").limit(1);
    console.log("Tentativa em " + SOURCE_PREF + ": ", r.data, r.error);
    if (!r.error && r.data && r.data.length > 0) { TABLE = SOURCE_PREF; }
    else {
      let r2 = await supa.from(SOURCE_FALL).select("dia").limit(1);
      console.log("Tentativa em " + SOURCE_FALL + ": ", r2.data, r2.error);
      if (!r2.error && r2.data && r2.data.length > 0) { TABLE = SOURCE_FALL; }
    }
    if (!TABLE) {
      setText("statusTxt", "Sem dados ou erro na fonte: " + (r.error?.message || r2.error?.message));
      return;
    }
    setText("statusTxt", "Fonte: " + TABLE);
    const t = await supa.from(TABLE).select("*").limit(1);
    console.log("Estrutura da tabela: ", t.data, t.error);
    if (t.data && t.data[0]) {
      console.log("Colunas encontradas: ", Object.keys(t.data[0]));
    } else {
      setText("statusTxt", "Estrutura da tabela não encontrada.");
    }
  }

  async function fetchPaged(columns, filters){
    let out=[], page=1000, from=0, to=page-1, more=true;
    while(more){
      let q = supa.from(TABLE).select(columns).order("dia",{ascending:true}).range(from,to);
      if(filters && filters.dgte) q = q.gte("dia", filters.dgte);
      if(filters && filters.dlte) q = q.lte("dia", filters.dlte);
      const r = await q; if(r.error) throw r.error;
      const a=r.data||[];
      out = out.concat(a);
      more = a.length===page; from += page; to += page;
    }
    return out;
  }

  async function fetchMinMax(){
    minISO = null; maxISO = null; diasSet = new Set();
    const r1 = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2 = await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r1.error || r2.error || !r1.data || !r2.data){
      console.error("Erro em fetchMinMax:", r1.error || r2.error);
      setText("statusTxt", "Erro ao carregar intervalo de datas.");
      return;
    }
    minISO = r1.data[0]?.dia || null;
    maxISO = r2.data[0]?.dia || null;
    if(minISO && maxISO){
      const all = await fetchPaged("dia", {});
      (all||[]).forEach(x=>diasSet.add(x.dia));
    } else {
      setText("statusTxt", "Nenhum intervalo de datas encontrado.");
    }
  }

  function snap(iso){
    if(!iso || diasSet.has(iso)) return iso;
    const d = parseISO(iso); if(!d) return minISO || maxISO;
    for(let k=1;k<=30;k++){
      const a = toISO(addDays(d, -k)), b = toISO(addDays(d, k));
      if(diasSet.has(a)) return a;
      if(diasSet.has(b)) return b;
    }
    return minISO || maxISO;
  }

  async function buildOptions(){
    try {
      const u = await supa.from(TABLE).select("unidade", { distinct: true }).order("unidade");
      const c = await supa.from(TABLE).select(`"${keyCanal}"`, { distinct: true }).order(keyCanal);
      const p = await supa.from(TABLE).select("pagamento", { distinct: true }).order("pagamento");
      const allData = await supa.from(TABLE).select(`"${keyLoja}", fat`).limit(1000);
      const lj = Object.entries(allData.data.reduce((acc, row) => {
        if (row[keyLoja] && row.fat) {
          acc[row[keyLoja]] = (acc[row[keyLoja]] || 0) + (row.fat || 0);
        }
        return acc;
      }, {})).map(([loja, total_fat]) => ({ [keyLoja]: loja, total_fat }))
        .sort((a, b) => b.total_fat - a.total_fat)
        .slice(0, 10);

      uni.innerHTML = "<option>Todas</option>" + (u.data||[]).map(r => `<option>${r.unidade || 'Sem unidade'}</option>`).join("");
      canal.innerHTML = (c.data||[]).map(r => `<option>${r[keyCanal] || 'Sem canal'}</option>`).join("");
      pag.innerHTML = (p.data||[]).map(r => `<option>${r.pagamento || 'Sem pagamento'}</option>`).join("");
      lojasBox.innerHTML = (lj||[]).map(r => `<span class="chip" data-v="${r[keyLoja] || 'Sem nome'}">${r[keyLoja] || 'Sem nome'}</span>`).join("");
      
      uni.value = "Todas";
      lojasBox.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => { chip.classList.toggle("active"); });
      });
    } catch (e) {
      console.error("Erro em buildOptions:", e);
      statusTxt.className="status err"; statusTxt.textContent="Erro ao carregar opções.";
    }
  }

  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    hideGate();
    await pickSource();
    await bootstrap();
  }

  async function bootstrap() {
    try {
      if (!TABLE) { await pickSource(); if (!TABLE) return; }
      setText("statusTxt", "Carregando intervalo de datas...");
      await fetchMinMax();
      if (!minISO || !maxISO) { 
        setText("statusTxt", "Sem intervalo de datas válido. Usando fallback.");
        minISO = "2025-08-01"; maxISO = "2025-08-10";
      }
      setText("statusTxt", "Construindo opções...");
      await buildOptions();
      const end = parseISO(maxISO), start = addDays(end, -29);
      dini.value = toISO(start); dfim.value = toISO(end);
      setText("statusTxt", "Carregando dados...");
      await reload();
      setText("statusTxt", "Pronto.");
    } catch (e) {
      setText("statusTxt", "Erro ao iniciar: " + e.message);
      console.error("Erro em bootstrap: ", e);
    }
  }

  async function reload() {
    try {
      if (!TABLE) { await pickSource(); if (!TABLE) return; }
      let sISO = snap(dini.value || minISO) || minISO, eISO = snap(dfim.value || maxISO) || maxISO;
      periodoTxt.textContent = "Período: " + (sISO || "—") + " → " + (eISO || "—");
      console.log("Período selecionado: ", sISO, "até", eISO);

      const rows = await fetchPaged("*", { dgte: sISO, dlte: eISO });
      console.log("Dados recuperados: ", rows);
      if (!rows || rows.length === 0) {
        setText("statusTxt", "Nenhum dado no período selecionado.");
        return;
      }
      renderKPIs(rows, [], 0.3, 0.1);
      renderCharts(rows, []);
      setText("statusTxt", "Dados carregados.");
    } catch (e) {
      setText("statusTxt", "Falha ao carregar: " + e.message);
      console.error("Erro em reload: ", e);
    }
  }

  function applyQuickDate(){
    if(!maxISO) return;
    const days = Number(pr.value||0); if(!days) return;
    const end = parseISO(maxISO); const start = addDays(end, -(days-1));
    dini.value = toISO(start); dfim.value = toISO(end);
  }

  function getSelected(el){ return Array.from(el.selectedOptions||[]).map(o=>o.value).filter(v=>v); }

  applyFilters.addEventListener("click", () => {
    applyQuickDate();
    reload();
    fx.open = false;
  });

  [uni, dini, dfim, pr, turno, canal, pag, canc, cmvPct, fixPct].forEach(el => {
    el.addEventListener("change", () => {
      if (el.id === "dini" && dfim.value && dini.value > dfim.value) {
        statusTxt.className = "status err";
        statusTxt.textContent = "Data inicial não pode ser após final.";
        return;
      }
    });
  });

  document.getElementById("limpar").addEventListener("click", (e) => {
    e.preventDefault();
    const end = parseISO(maxISO), start = addDays(end, -29);
    uni.value = "Todas";
    dini.value = toISO(start) || "2025-08-01";
    dfim.value = toISO(end) || "2025-08-10";
    pr.value = "30";
    turno.value = "";
    canal.value = "";
    pag.value = "";
    canc.value = "Todos";
    cmvPct.value = "30";
    fixPct.value = "10";
    Array.from(lojasBox.children).forEach(c => c.classList.remove("active"));
    reload();
    fx.open = false;
  });

  // Função de Importação de CSV
  btnImport.addEventListener("click", async () => {
    const file = csvfile.files[0];
    if (!file) {
      setText("impMsg", "Selecione um arquivo CSV.");
      return;
    }

    setText("impMsg", "Processando CSV...");
    prog.style.display = "inline-block";
    prog.value = 0;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      chunkSize: 1024,
      step: (results, parser) => {
        prog.value += 10; // Aproximação de progresso
        const data = results.data[0];
        if (data.dia && (data.fat || data.pedidos)) {
          // Verifica se o dia já existe para evitar duplicação
          const exists = await supa.from(TABLE).select("dia").eq("dia", data.dia).maybeSingle();
          if (!exists.data) {
            const { error } = await supa.from(TABLE).insert({
              dia: data.dia,
              fat: parseFloat(data.fat) || 0,
              pedidos: parseInt(data.pedidos) || 0,
              unidade: data.unidade || null,
              [keyLoja]: data[keyLoja] || null,
              [keyCanal]: data[keyCanal] || null,
              pagamento: data.pagamento || null
            });
            if (error) console.error("Erro ao inserir:", error);
          }
        }
      },
      complete: () => {
        prog.style.display = "none";
        setText("impMsg", "Importação concluída.");
        reload(); // Recarrega os dados após importação
      },
      error: (error) => {
        prog.style.display = "none";
        setText("impMsg", "Erro ao processar CSV: " + error.message);
        console.error("Erro no CSV:", error);
      }
    });
  });

  // Funções de Renderização
  function renderKPIs(rows, prev, cmv, fix) {
    console.log("Renderizando KPIs com rows: ", rows);
    if (!rows || rows.length === 0) {
      setText("statusTxt", "Nenhum dado para renderizar KPIs.");
      return;
    }
    const cur = { ped:0, fat:0, tkm:0 };
    rows.forEach(r => {
      cur.ped += (r.pedidos || 0);
      cur.fat += (r.fat || 0);
    });
    cur.tkm = avg(cur.fat, cur.ped);

    setText("k_ped", fmtInt(cur.ped));
    setText("k_fat", fmtBRL(cur.fat));
    setText("k_tkm", fmtBRL(cur.tkm));

    const prevPed = prev.reduce((a,r)=>a+(r.pedidos||0),0), prevFat = prev.reduce((a,r)=>a+(r.fat||0),0);
    const prevTkm = avg(prevFat, prevPed);
    setDelta(document.getElementById("d_ped"), cur.ped, prevPed);
    setDelta(document.getElementById("d_fat"), cur.fat, prevFat);
    setDelta(document.getElementById("d_tkm"), cur.tkm, prevTkm);
  }

  function renderCharts(rows, prev) {
    console.log("Renderizando gráficos com rows: ", rows);
    if (!rows || rows.length === 0) {
      setText("statusTxt", "Nenhum dado para renderizar gráficos.");
      return;
    }
    if (chartLine) chartLine.destroy();
    chartLine = new Chart(document.getElementById("cLine").getContext("2d"), {
      type: "line",
      data: { 
        labels: rows.map(r => r.dia || 'Sem data'),
        datasets: [{ label: "Faturamento", data: rows.map(r => r.fat || 0) }]
      }
    });
  }

  // Inicialização
  checkRecovery();
  if(supa.auth.getSession()){ hideGate(); afterLogin(); }
})();
</script>
</body>
</html>
