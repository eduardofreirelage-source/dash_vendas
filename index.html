<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v13)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--card:#fff;--bd:#e5e7eb;--accent:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    select,button{height:36px;border:1px solid var(--bd);background:#fff;border-radius:8px;padding:0 10px}
    button{cursor:pointer}
    .charts{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    canvas{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:10px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    .tog{display:flex;gap:10px;align-items:center}
    .tog label{margin:0}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.kpis{grid-template-columns:1fr}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">
          Build <b>v13</b> • Fonte: <code id="fonte">detectando…</code>
        </div>
        <div class="muted">Período: <span id="spanPeriodo">—</span></div>
      </div>
      <div class="row">
        <div class="card">
          <label for="selPeriodo">Período</label>
          <select id="selPeriodo">
            <option value="30">Últimos 30 dias</option>
            <option value="60">Últimos 60 dias</option>
            <option value="90">Últimos 90 dias</option>
            <option value="180">Últimos 180 dias</option>
            <option value="365" selected>Últimos 365 dias</option>
          </select>
        </div>
        <div class="card">
          <label for="selUnidade">UNIDADE</label>
          <select id="selUnidade">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="card">
          <label>Faturamento</label>
          <div class="tog">
            <input type="radio" name="fatmodo" id="fat_bruto" value="bruto" checked>
            <label for="fat_bruto">Total (bruto)</label>
            <input type="radio" name="fatmodo" id="fat_liq" value="liquido">
            <label for="fat_liq">Líquido (Total − Entrega)</label>
          </div>
        </div>
        <div class="card" style="display:flex;gap:8px;align-items:flex-end">
          <button id="btnReload">Recarregar</button>
          <button id="btnFallback" title="Tenta janelas alternativas e recuo de data">Forçar janela</button>
        </div>
      </div>
    </div>

    <div class="kpis">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="muted" id="k_ped_delta">+0,0% vs ant.</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="muted" id="k_fat_delta">+0,0% vs ant.</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">…</div><div class="muted" id="k_desc_delta">+0,0% vs ant.</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="muted" id="k_fre_delta">+0,0% vs ant.</div></div>
    </div>

    <div class="charts">
      <div>
        <div class="title" style="margin:6px 0">Receita diária (usa o modo bruto/liq. escolhido)</div>
        <canvas id="chDaily" height="220"></canvas>
      </div>
      <div>
        <div class="title" style="margin:6px 0">Totais por dia da semana (usa o modo bruto/liq. escolhido)</div>
        <canvas id="chDOW" height="220"></canvas>
      </div>
      <div>
        <div class="title" style="margin:6px 0">Comparativo período atual × anterior (faturamento)</div>
        <canvas id="chCompare" height="220"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
(() => {
  // ====== CONFIG — usei as credenciais que você passou ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

  // ====== Helpers UI ======
  const $ = (id) => document.getElementById(id);
  const elFonte = $("fonte"), elLog = $("log"), elPeriodo = $("spanPeriodo");
  const selPeriodo = $("selPeriodo"), selUnidade = $("selUnidade");
  const btnReload = $("btnReload"), btnFallback = $("btnFallback");
  const fmtBRL = (n) => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = (n) => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO = (d) => d.toISOString().slice(0,10);
  const addDays = (d, delta) => { const x = new Date(d); x.setDate(x.getDate()+delta); return x; };
  const log = (m) => { elLog.textContent += "\n" + m; elLog.scrollTop = elLog.scrollHeight; };

  // normaliza número (suporta "1.234,56", "1234.56", 1234.56)
  function toNum(x){
    if(x==null||x==="")return 0;
    if(typeof x==="number")return x;
    const s = String(x).trim();
    if(!s) return 0;
    const t = s.replace(/\./g,"").replace(/,/g,".");
    const n = Number(t);
    return isFinite(n)?n:0;
  }

  // ====== Supabase client ======
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ====== Estado global ======
  const state = {
    // tabela ativa e mapeamento de colunas
    table: null,
    map: null, // {dt,val,desc,fre,uni}
    charts: { daily:null, dow:null, comp:null }
  };

  // tenta usar 'public.vendas', se não, 'public.vendas_import_csv'
  async function detectTable(){
    log("[Boot] v13 — preferida 'vendas' → fallback 'vendas_import_csv' · sem ORDER/max · paginação");

    // tenta 'vendas'
    let r = await supa.from("vendas").select("data_venda,valor_total").limit(1);
    if(!r.error && r.data && r.data.length){
      state.table = "vendas";
      state.map = { dt:"data_venda", val:"valor_total", desc:"desconto", fre:"entrega", uni:"unidade" };
      elFonte.textContent = "public.vendas";
      log("[Fonte] usando public.vendas");
      return;
    }
    // fallback 'vendas_import_csv'
    r = await supa.from("vendas_import_csv").select("data_venda_date,Total").limit(1);
    if(!r.error && r.data && r.data.length){
      state.table = "vendas_import_csv";
      state.map = { dt:"data_venda_date", val:"Total", desc:"Desconto", fre:"Entrega", uni:"Unidade" };
      elFonte.textContent = "public.vendas_import_csv";
      log("[Fonte] usando public.vendas_import_csv");
      return;
    }
    throw new Error("Nenhuma tabela com dados encontrada.");
  }

  // lista unidades com base na janela consultada (ou sem filtro se simples)
  function fillUnitsFromRows(rows){
    const uniKey = state.map.uni;
    const set = new Set();
    for(const r of rows){
      const u = r[uniKey];
      if(u && String(u).trim()) set.add(String(u));
    }
    const cur = selUnidade.value;
    selUnidade.innerHTML = '<option value="">Todas</option>' + [...set].sort().map(u=>`<option value="${u}">${u}</option>`).join("");
    // se já havia escolhido algo, tenta manter
    if(cur && set.has(cur)) selUnidade.value = cur;
  }

  // busca paginada (sem ORDER), filtrando por data e unidade
  async function fetchWindow(startISO, endISO, unidade){
    const t = state.table, M = state.map;
    const page = 10000;
    let off = 0, all = [];
    for(;;){
      let q = supa.from(t)
        .select([M.dt,M.val,M.desc,M.fre,M.uni].join(","), { count:"exact" })
        .gte(M.dt, startISO).lte(M.dt, endISO)
        .range(off, off+page-1);
      if(unidade) q = q.eq(M.uni, unidade);
      const r = await q;
      if(r.error){
        // loga e sai — quem chama decide fallback
        throw r.error;
      }
      const arr = r.data||[];
      all = all.concat(arr);
      if(arr.length < page) break;
      off += page;
    }
    return all;
  }

  // converte linha bruta → normalizada
  function normRow(r){
    const M = state.map;
    const date = String(r[M.dt]).slice(0,10);
    const total = toNum(r[M.val]);
    const desc  = toNum(r[M.desc]);
    const fre   = toNum(r[M.fre]);
    const uni   = r[M.uni] ?? null;
    return { date, total, desc, fre, uni };
  }

  // agrega e atualiza UI
  function updateKPIs(rows, rowsPrev){
    const modo = document.querySelector('input[name="fatmodo"]:checked').value; // 'bruto'|'liquido'
    const metric = (x) => modo==="liquido" ? (x.total - x.fre) : x.total;

    const ped  = rows.length;
    const fat  = rows.reduce((s,x)=>s+metric(x),0);
    const des  = rows.reduce((s,x)=>s+x.desc,0);
    const fre  = rows.reduce((s,x)=>s+x.fre,0);

    const pedP = rowsPrev.length;
    const fatP = rowsPrev.reduce((s,x)=>s+metric(x),0);
    const desP = rowsPrev.reduce((s,x)=>s+x.desc,0);
    const freP = rowsPrev.reduce((s,x)=>s+x.fre,0);

    $("k_ped").textContent = fmtInt(ped);
    $("k_fat").textContent = fmtBRL(fat);
    $("k_desc").textContent = fmtBRL(des);
    $("k_fre").textContent = fmtBRL(fre);

    const pct = (a,b)=> (b===0?0:((a-b)/b*100));
    $("k_ped_delta").textContent = (pct(ped, pedP)).toLocaleString("pt-BR",{maximumFractionDigits:1,minimumFractionDigits:1})+"% vs ant.";
    $("k_fat_delta").textContent = (pct(fat, fatP)).toLocaleString("pt-BR",{maximumFractionDigits:1,minimumFractionDigits:1})+"% vs ant.";
    $("k_desc_delta").textContent = (pct(des, desP)).toLocaleString("pt-BR",{maximumFractionDigits:1,minimumFractionDigits:1})+"% vs ant.";
    $("k_fre_delta").textContent = (pct(fre, freP)).toLocaleString("pt-BR",{maximumFractionDigits:1,minimumFractionDigits:1})+"% vs ant.";
  }

  // cria/destroi chart
  function setChart(refKey, cfg){
    const prev = state.charts[refKey];
    if(prev){ prev.destroy(); }
    state.charts[refKey] = new Chart(cfg.ctx, cfg.opts);
  }

  function drawCharts(rows, rowsPrev){
    const modo = document.querySelector('input[name="fatmodo"]:checked').value;
    const metric = (x)=> modo==="liquido" ? (x.total - x.fre) : x.total;

    // diária
    const byDate = new Map();
    for(const r of rows){ byDate.set(r.date, (byDate.get(r.date)||0) + metric(r)); }
    const labels = [...byDate.keys()].sort();
    const data = labels.map(d=>byDate.get(d));

    setChart("daily", {
      ctx: document.getElementById("chDaily"),
      opts: {
        type:"line",
        data:{ labels, datasets:[{ label:"Receita diária", data, tension:.2 }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      }
    });

    // DOW atual
    const byDow = new Array(7).fill(0);
    for(const r of rows){
      const dow = new Date(r.date+"T00:00:00").getDay(); // 0..6
      byDow[dow] += metric(r);
    }
    const dowLabels = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    setChart("dow", {
      ctx: document.getElementById("chDOW"),
      opts: {
        type:"bar",
        data:{ labels:dowLabels, datasets:[{ label:"Total por dia da semana", data:byDow }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      }
    });

    // Comparativo atual x anterior (faturamento total do período)
    const totalAtual = rows.reduce((s,x)=>s+metric(x),0);
    const totalAnt   = rowsPrev.reduce((s,x)=>s+metric(x),0);
    setChart("comp", {
      ctx: document.getElementById("chCompare"),
      opts: {
        type:"bar",
        data:{ labels:["Anterior","Atual"], datasets:[{ label:"Faturamento", data:[totalAnt,totalAtual] }] },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      }
    });
  }

  // executa fluxo de carregamento
  async function load({forceFallback=false}={}){
    try{
      // detectar fonte, se ainda não
      if(!state.table){
        await detectTable();
      }

      // janela base
      const days = parseInt(selPeriodo.value, 10) || 30;
      const end0 = new Date(); // hoje (UTC do browser)
      let end = end0, start = addDays(end, -days+1);

      // tenta janela + recuo de fim (para bases onde "hoje" ainda não chegou)
      const endOffsets = [0, -1, -3, -7, -14, -30];
      const unit = selUnidade.value || "";
      let got = null, chosenOffset = 0;

      for(const off of endOffsets){
        const tryEnd = addDays(end0, off);
        const tryStart = addDays(tryEnd, -days+1);
        log(`[Query] Tentando janela ${days}d: ${toISO(tryStart)} → ${toISO(tryEnd)}${unit?` | UNIDADE=${unit}`:""}`);
        try{
          const raw = await fetchWindow(toISO(tryStart), toISO(tryEnd), unit || null);
          if(raw.length){
            got = { rows: raw.map(normRow), start: tryStart, end: tryEnd };
            chosenOffset = off;
            break;
          }
        }catch(e){
          log(`[Warn] tentativa falhou: ${e.message||e}`);
        }
      }

      if(!got){
        // fallback de dias: 60 → 90 → 180 → 365
        const sizes = [60,90,180,365];
        outer: for(const sz of sizes){
          for(const off of endOffsets){
            const tryEnd = addDays(end0, off);
            const tryStart = addDays(tryEnd, -sz+1);
            log(`[Query] Fallback janela ${sz}d: ${toISO(tryStart)} → ${toISO(tryEnd)}${unit?` | UNIDADE=${unit}`:""}`);
            try{
              const raw = await fetchWindow(toISO(tryStart), toISO(tryEnd), unit || null);
              if(raw.length){
                selPeriodo.value = String(sz); // atualiza seleção para refletir
                got = { rows: raw.map(normRow), start: tryStart, end: tryEnd };
                chosenOffset = off;
                break outer;
              }
            }catch(e){
              log(`[Warn] fallback falhou: ${e.message||e}`);
            }
          }
        }
      }

      if(!got){
        throw new Error("Nenhum dado encontrado (tente outro período ou verifique RLS).");
      }

      // preencher UNIDADES a partir do dataset carregado (evita query pesada de distinct)
      fillUnitsFromRows(got.rows);

      // período anterior (mesma duração, imediatamente antes)
      const span = (got.end - got.start)/(24*3600*1000) + 1; // dias
      const prevEnd   = addDays(got.start, -1);
      const prevStart = addDays(prevEnd, -span+1);
      log(`[Query] Período anterior: ${toISO(prevStart)} → ${toISO(prevEnd)}${unit?` | UNIDADE=${unit}`:""}`);
      let prevRaw = [];
      try{
        prevRaw = await fetchWindow(toISO(prevStart), toISO(prevEnd), unit || null);
      }catch(e){
        log(`[Warn] período anterior falhou: ${e.message||e}`);
        prevRaw = [];
      }

      const rows     = got.rows;
      const rowsPrev = prevRaw.map(normRow);

      // UI período
      elPeriodo.textContent = `${toISO(got.start)} → ${toISO(got.end)}${chosenOffset?` (offset ${chosenOffset}d)`:''}`;

      // KPIs
      updateKPIs(rows, rowsPrev);

      // Charts
      drawCharts(rows, rowsPrev);

      log("[OK] KPIs e gráficos atualizados.");
    }catch(e){
      log("[ERRO] " + (e.message||String(e)));
    }
  }

  // eventos
  btnReload.addEventListener("click", () => load({}));
  btnFallback.addEventListener("click", () => load({forceFallback:true}));
  selPeriodo.addEventListener("change", () => load({}));
  selUnidade.addEventListener("change", () => load({}));
  document.querySelectorAll('input[name="fatmodo"]').forEach(r => r.addEventListener("change", () => load({})));

  // start
  (async function init(){
    try{
      await detectTable();
      await load({});
    }catch(e){
      log("[ERRO init] "+(e.message||String(e)));
    }
  })();

})();
</script>
</body>
</html>
