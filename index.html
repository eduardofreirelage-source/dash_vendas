<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — CFO (v2.8 Light)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="18" fill="%23eef2ff"/><text x="64" y="78" text-anchor="middle" font-family="Inter,Arial" font-weight="700" font-size="60" fill="%233256e0">C</text></svg>'/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<style>
:root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--text:#0f172a;--stroke:#e5e7eb;--brand:#2563eb;--brand-weak:#e0e7ff;--good:#16a34a;--bad:#dc2626}
*,*:before,*:after{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
h1{font-size:20px;margin:0}
small.ver{margin-left:8px;color:var(--muted);font-weight:600;background:var(--brand-weak);padding:2px 8px;border-radius:999px}
.btn-link{color:var(--muted);text-decoration:underline;cursor:pointer}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#fff;color:var(--text)}
select[multiple]{min-height:72px}
.row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
.row .wide-2{grid-column:span 2}
.topbar{display:flex;gap:12px;align-items:center}
.pill{background:#eef2ff;color:#1e40af;border-radius:999px;padding:2px 8px;font-weight:600;font-size:12px}
.summary{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin-top:12px}
.summary .box{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
.summary .big{font-size:20px;font-weight:700}
.muted{color:var(--muted)}
.kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin-top:12px}
.kpi{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
.kpi h3{font-size:13px;color:var(--muted);margin:0 0 6px}
.kpi .val{display:flex;align-items:baseline;gap:6px}
.kpi .main{font-weight:700;font-size:20px}
.kpi .delta{font-size:12px;font-weight:700}
.delta.up{color:var(--good)} .delta.down{color:var(--bad)} .delta.flat{color:var(--muted)}
canvas{background:#fff;border:1px solid var(--stroke);border-radius:14px}
.hint{color:var(--muted);font-size:12px;margin:6px 0 0}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Dashboard Vendas — CFO <small class="ver">v2.8 Light</small></h1>
      <div class="muted" id="periodoLabel">Período: —</div>
    </div>
    <div class="topbar">
      <a id="btnClear" class="btn-link">Limpar filtros</a>
    </div>
  </header>

  <!-- Filtros -->
  <div class="card">
    <div class="row">
      <div><label>Unidade(s)</label><select id="fUnidade" multiple></select></div>
      <div><label>Loja(s)</label><select id="fLoja" multiple></select></div>
      <div><label>Turno(s)</label><select id="fTurno" multiple></select></div>
      <div><label>Canal(is)</label><select id="fCanal" multiple></select></div>
      <div><label>Pagamento(s)</label><select id="fPag" multiple></select></div>
      <div><label>Cancelado</label>
        <select id="fCanc">
          <option value="Não" selected>Não</option>
          <option value="Sim">Sim</option>
          <option value="Todos">Todos</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><label>Período (De)</label><input id="fDe" type="date"/></div>
      <div><label>Período (Até)</label><input id="fAte" type="date"/></div>
      <div class="wide-2">
        <label>Período Rápido</label>
        <select id="fRapido">
          <option value="30">Último mês (30d)</option>
          <option value="7">Últimos 7 dias</option>
          <option value="15">Últimos 15 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="120">Últimos 120 dias</option>
          <option value="semana">Última semana</option>
          <option value="mes">Último mês (calendário)</option>
          <option value="custom">Personalizado (usar datas)</option>
        </select>
        <div class="hint">Se não for “Personalizado”, usamos o <b>último dia disponível</b> no banco como referência.</div>
      </div>
      <div class="wide-2"><span class="pill" id="datasetInfo">—</span></div>
    </div>
  </div>

  <!-- Resumo -->
  <div class="summary">
    <div class="box"><div class="muted">Canônicas (DISTINCT)</div><div class="big" id="sCanon">—</div></div>
    <div class="box"><div class="muted">% Duplicatas</div><div class="big" id="sDupPct">—</div><div class="hint">A consulta usa base canônica.</div></div>
    <div class="box"><div class="muted">Data mínima</div><div class="big" id="sMinDia">—</div></div>
    <div class="box"><div class="muted">Data máxima</div><div class="big" id="sMaxDia">—</div></div>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><h3>Pedidos</h3><div class="val"><div class="main" id="kPed">—</div><div class="delta" id="dPed">—</div></div><div class="muted" id="aPed">Anterior: —</div></div>
    <div class="kpi"><h3>Ticket Médio (líquido)</h3><div class="val"><div class="main" id="kTkt">R$ —</div><div class="delta" id="dTkt">—</div></div><div class="muted" id="aTkt">Anterior: —</div></div>
    <div class="kpi"><h3>Faturamento (bruto)</h3><div class="val"><div class="main" id="kFat">R$ —</div><div class="delta" id="dFat">—</div></div><div class="muted" id="aFat">Anterior: —</div></div>
    <div class="kpi"><h3>Faturamento Médio (por pedido)</h3><div class="val"><div class="main" id="kFatMed">R$ —</div><div class="delta" id="dFatMed">—</div></div><div class="muted" id="aFatMed">Anterior: —</div></div>
    <div class="kpi"><h3>Incentivos (descontos)</h3><div class="val"><div class="main" id="kDes">R$ —</div><div class="delta" id="dDes">—</div></div><div class="muted" id="aDes">Anterior: —</div></div>
    <div class="kpi"><h3>Incentivos Média (% do faturamento)</h3><div class="val"><div class="main" id="kDesPct">—</div><div class="delta" id="dDesPct">—</div></div><div class="muted" id="aDesPct">Anterior: —</div></div>
    <div class="kpi"><h3>Frete</h3><div class="val"><div class="main" id="kFre">R$ —</div><div class="delta" id="dFre">—</div></div><div class="muted" id="aFre">Anterior: —</div></div>
    <div class="kpi"><h3>Frete Médio (por pedido)</h3><div class="val"><div class="main" id="kFreMed">R$ —</div><div class="delta" id="dFreMed">—</div></div><div class="muted" id="aFreMed">Anterior: —</div></div>
  </div>

  <!-- Gráfico -->
  <div class="card" style="margin-top:12px;">
    <h3 class="muted" style="margin:0 0 8px">Receita por hora</h3>
    <canvas id="chartHora" height="140"></canvas>
  </div>
</div>

<script>
/* =================== SUPABASE =================== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* =================== DOM =================== */
const $ = (id)=>document.getElementById(id);
const fUnidade=$('fUnidade'), fLoja=$('fLoja'), fTurno=$('fTurno'), fCanal=$('fCanal'), fPag=$('fPag'), fCanc=$('fCanc');
const fDe=$('fDe'), fAte=$('fAte'), fRapido=$('fRapido'), btnClear=$('btnClear');
const periodoLabel=$('periodoLabel'), datasetInfo=$('datasetInfo');
const sCanon=$('sCanon'), sDupPct=$('sDupPct'), sMinDia=$('sMinDia'), sMaxDia=$('sMaxDia');
const kPed=$('kPed'), dPed=$('dPed'), aPed=$('aPed');
const kTkt=$('kTkt'), dTkt=$('dTkt'), aTkt=$('aTkt');
const kFat=$('kFat'), dFat=$('dFat'), aFat=$('aFat');
const kFatMed=$('kFatMed'), dFatMed=$('dFatMed'), aFatMed=$('aFatMed');
const kDes=$('kDes'), dDes=$('dDes'), aDes=$('aDes');
const kDesPct=$('kDesPct'), dDesPct=$('dDesPct'), aDesPct=$('aDesPct');
const kFre=$('kFre'), dFre=$('dFre'), aFre=$('aFre');
const kFreMed=$('kFreMed'), dFreMed=$('dFreMed'), aFreMed=$('aFreMed');
let chartHora=null, minDia=null, maxDia=null;

/* =================== UTILS =================== */
const fmtN =(n)=> (Number(n)||0).toLocaleString('pt-BR');
const fmtR$=(n)=> 'R$ '+(Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtPct=(n)=> (Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})+'%';
function arrowDelta(cur, prev){
  if(!isFinite(prev)||prev===0){ return {txt:'—',cls:'flat',prev:prev||0}; }
  const delta = ((cur - prev)/prev)*100;
  if(delta>0) return {txt:'▲ '+fmtPct(delta), cls:'up', prev};
  if(delta<0) return {txt:'▼ '+fmtPct(Math.abs(delta)), cls:'down', prev};
  return {txt:'—',cls:'flat',prev};
}
function parseSel(sel){ return Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v!==''); }
function addDays(iso, n){ const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function toISO(d){ return new Date(d).toISOString().slice(0,10); }
function labelPeriodo(de,ate){ periodoLabel.textContent = `Período: ${de} → ${ate}`; }

/* =================== LOAD OPTIONS =================== */
async function loadOptions(){
  const [rng,un,lo,tu,ca,pg] = await Promise.all([
    supa.from('vw_vendas_daterange').select('*').single(),
    supa.from('vw_vendas_unidades').select('unidade').order('unidade'),
    supa.from('vw_vendas_lojas').select('loja').order('loja'),
    supa.from('vw_vendas_turnos').select('turno').order('turno'),
    supa.from('vw_vendas_canais').select('canal').order('canal'),
    supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
  ]);
  if(rng.error){ console.error(rng.error); datasetInfo.textContent='❗️Erro vw_vendas_daterange'; return; }
  minDia=rng.data.min_dia; maxDia=rng.data.max_dia;
  sMinDia.textContent=minDia; sMaxDia.textContent=maxDia;
  datasetInfo.textContent=`min ${minDia} • max ${maxDia}`;
  sCanon.textContent = (rng.data.canon_count? fmtN(rng.data.canon_count): '—');
  sDupPct.textContent = rng.data.dup_pct!=null ? fmtPct(rng.data.dup_pct) : '—';

  function fill(sel, rows, col, lbl){
    sel.innerHTML=''; sel.appendChild(new Option(`Todas as ${lbl}`,'',true,true));
    (rows.data||[]).forEach(r=>{ const v=r[col]; if(v!==null&&v!==undefined&&String(v).trim()!==''){ sel.appendChild(new Option(v,v)); }});
  }
  fill(fUnidade,un,'unidade','unidades');
  fill(fLoja,lo,'loja','lojas');
  fill(fTurno,tu,'turno','turnos');
  fill(fCanal,ca,'canal','canais');
  fill(fPag,pg,'pagamento_base','formas');

  // período inicial (últimos 30 com base no maxDia)
  fRapido.value='30'; applyQuickPeriod();
}

/* =================== PERIODOS =================== */
function applyQuickPeriod(){
  const mode=fRapido.value; const max=maxDia||toISO(new Date());
  let de=max, ate=max;
  if(mode==='custom'){ fDe.disabled=false; fAte.disabled=false; if(!fDe.value)fDe.value=max; if(!fAte.value)fAte.value=max; labelPeriodo(fDe.value,fAte.value); applyAll(); return; }
  fDe.disabled=true; fAte.disabled=true;
  if(['7','15','30','60','90','120'].includes(mode)){ de=addDays(max, -(Number(mode)-1)); }
  else if(mode==='semana'){ const d=new Date(max); const dow=(d.getDay()+6)%7; de=addDays(max,-dow); }
  else if(mode==='mes'){ const d=new Date(max); d.setDate(1); de=toISO(d); d.setMonth(d.getMonth()+1); d.setDate(0); ate=toISO(d); }
  fDe.value=de; fAte.value=ate; labelPeriodo(de,ate); applyAll();
}
function currentPeriod(){ return {de: fDe.value||minDia, ate: fAte.value||maxDia}; }
function previousPeriod(){ const {de,ate}=currentPeriod(); const span = Math.round((new Date(ate)-new Date(de))/(1000*60*60*24))+1; const pAte=addDays(de,-1); const pDe=addDays(pAte, -(span-1)); return {de:pDe, ate:pAte}; }

/* =================== RPCs =================== */
async function callKPI(period){
  const payload={
    p_de:period.de, p_ate:period.ate,
    p_unid:parseSel(fUnidade)||null, p_loja:parseSel(fLoja)||null, p_turno:parseSel(fTurno)||null,
    p_canal:parseSel(fCanal)||null, p_pag:parseSel(fPag)||null, p_canc:fCanc.value||'Não'
  };
  const {data,error}=await supa.rpc('kpi_vendas',payload).single();
  if(error){ console.error('kpi_vendas',error); return {ped:0,fat:0,des:0,fre:0}; }
  return {ped:Number(data.ped)||0, fat:Number(data.fat)||0, des:Number(data.des)||0, fre:Number(data.fre)||0};
}
async function callHora(period){
  const payload={
    p_de:period.de, p_ate:period.ate,
    p_unid:parseSel(fUnidade)||null, p_loja:parseSel(fLoja)||null, p_turno:parseSel(fTurno)||null,
    p_canal:parseSel(fCanal)||null, p_pag:parseSel(fPag)||null, p_canc:fCanc.value||'Não'
  };
  const {data,error}=await supa.rpc('fat_por_hora',payload);
  if(error){ console.warn('fat_por_hora',error); return []; }
  return data||[];
}

/* =================== RENDER =================== */
function setDelta(el, clsEl, cur, prev, fmt=fmtN){
  const d=arrowDelta(cur,prev); el.textContent=d.txt; el.className='delta '+d.cls; clsEl.textContent = fmt(prev);
}
function renderKPIs(cur, prev){
  // bases
  const pedC=cur.ped, pedP=prev.ped;
  const fatC=cur.fat, desC=cur.des, freC=cur.fre;
  const fatP=prev.fat, desP=prev.des, freP=prev.fre;

  // ticket líquido = (fat - des - fre)/ped
  const tktC = pedC? (fatC - desC - freC)/pedC : 0;
  const tktP = pedP? (fatP - desP - freP)/pedP : 0;

  // fat médio (bruto/pedido)
  const fatMedC = pedC? fatC/pedC : 0;
  const fatMedP = pedP? fatP/pedP : 0;

  // incentivos % (des/fat)
  const desPctC = fatC? (desC/fatC*100) : 0;
  const desPctP = fatP? (desP/fatP*100) : 0;

  // frete médio
  const freMedC = pedC? freC/pedC : 0;
  const freMedP = pedP? freP/pedP : 0;

  // pintar
  kPed.textContent=fmtN(pedC); setDelta(dPed,aPed,pedC,pedP,fmtN);
  kTkt.textContent=fmtR$(tktC); setDelta(dTkt,aTkt,tktC,tktP,fmtR$);
  kFat.textContent=fmtR$(fatC); setDelta(dFat,aFat,fatC,fatP,fmtR$);
  kFatMed.textContent=fmtR$(fatMedC); setDelta(dFatMed,aFatMed,fatMedC,fatMedP,fmtR$);
  kDes.textContent=fmtR$(desC); setDelta(dDes,aDes,desC,desP,fmtR$);
  kDesPct.textContent=fmtPct(desPctC); setDelta(dDesPct,aDesPct,desPctC,desPctP,fmtPct);
  kFre.textContent=fmtR$(freC); setDelta(dFre,aFre,freC,freP,fmtR$);
  kFreMed.textContent=fmtR$(freMedC); setDelta(dFreMed,aFreMed,freMedC,freMedP,fmtR$);
}
async function renderChart(period){
  const data = await callHora(period);
  const byHour = Array.from({length:24},(_,h)=>({h, fat:0}));
  for(const r of data){ const h = Number(r.hora); const v = Number(r.fat)||0; if(h>=0 && h<24) byHour[h].fat += v; }
  const ctx = document.getElementById('chartHora').getContext('2d');
  if(chartHora){ chartHora.destroy(); }
  chartHora = new Chart(ctx,{type:'line',data:{labels:byHour.map(x=>x.h.toString().padStart(2,'0')+'h'),datasets:[{label:'Receita (R$)',data:byHour.map(x=>x.fat)}]},options:{responsive:true,plugins:{legend:{display:true}},scales:{y:{ticks:{callback:(v)=>'R$ '+Number(v).toLocaleString('pt-BR')}}}}});
}

/* =================== APPLY =================== */
async function applyAll(){
  const cur=currentPeriod(), prv=previousPeriod(); labelPeriodo(cur.de,cur.ate);
  try{
    const [c,p] = await Promise.all([callKPI(cur), callKPI(prv)]);
    renderKPIs(c,p);
    renderChart(cur);
  }catch(e){ console.error(e); }
}

/* =================== EVENTS =================== */
['change','input'].forEach(ev=>{
  [fUnidade,fLoja,fTurno,fCanal,fPag,fCanc].forEach(el=>el.addEventListener(ev, applyAll));
});
fDe.addEventListener('change', ()=>{ fRapido.value='custom'; labelPeriodo(fDe.value,fAte.value); applyAll(); });
fAte.addEventListener('change', ()=>{ fRapido.value='custom'; labelPeriodo(fDe.value,fAte.value); applyAll(); });
fRapido.addEventListener('change', applyQuickPeriod);
btnClear.addEventListener('click', ()=>{
  [fUnidade,fLoja,fTurno,fCanal,fPag].forEach(sel=>{ Array.from(sel.options).forEach(o=>o.selected=false); sel.options[0].selected=true; });
  fCanc.value='Não'; fRapido.value='30'; applyQuickPeriod();
});

/* =================== BOOT =================== */
loadOptions().then(applyAll);
</script>
</body>
</html>
