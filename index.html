<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .delta.up{color:var(--good)} .delta.down{color:var(--bad)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,input{font:inherit;padding:10px 12px;border:1px solid var(--brd);border-radius:8px;background:#fff;line-height:1}
    input[type="date"]{padding:9px 12px}
    @supports (-webkit-touch-callout: none) { select, input { font-size:16px; } }
    button{cursor:pointer}
    button.ghost{background:#fff}

    /* Filtros */
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3}
    .seg{display:flex;gap:6px;align-items:center}
    .seg .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .seg .grow{min-width:180px;width:100%}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff}
    .pill button.active{background:var(--accent);color:#fff}
    .chartbox{position:relative;height:300px;width:100%}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}

    /* Responsivo */
    @media (max-width:940px){
      .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}
      .filters-grid{grid-template-columns:repeat(6,1fr)}
      .col-6{grid-column:1 / -1}
      .col-3{grid-column:span 3} .col-4{grid-column:span 3}
      .seg{gap:8px}
    }
    @media (max-width:560px){
      .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}
      .filters-grid{grid-template-columns:1fr}
      .col-12,.col-6,.col-4,.col-3{grid-column:1 / -1}
      .seg{flex-direction:column;align-items:stretch;gap:6px}
      .seg .lbl{margin-bottom:2px}
      details.filterbox>summary{position:sticky;top:0;background:#fff;z-index:5;border-top-left-radius:12px;border-top-right-radius:12px}
      details.filterbox .body{padding:12px}
      select, input { width:100% }
    }

    .admin{background:#fafafa;border:1px dashed var(--brd);border-radius:10px;padding:10px;margin-top:8px}
    .link{color:var(--accent);cursor:pointer}

    /* Gate (auth) */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:none;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso ao Maestro Food</h3>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div id="authForm">
        <div class="row" style="flex-direction:column;align-items:stretch;gap:8px">
          <div>
            <div class="muted">E-mail</div>
            <input id="authEmail" type="email" autocomplete="email" placeholder="voce@empresa.com" />
          </div>
          <div>
            <div class="muted">Senha</div>
            <input id="authPass" type="password" autocomplete="current-password" placeholder="••••••••" />
            <div class="muted" style="margin-top:6px"><span id="lForgot" class="link">Esqueci minha senha</span></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button id="btnSignup" style="display:none">Criar conta</button>
          <button id="btnLogin">Entrar</button>
        </div>
        <div class="muted" id="authErr" style="color:#b91c1c"></div>
      </div>

      <!-- Forgot password -->
      <div id="resetBox" style="display:none">
        <div class="muted" style="margin:6px 0 8px">Informe seu e-mail para receber o link de redefinição.</div>
        <input id="resetEmail" type="email" placeholder="seu@email.com" />
        <div class="row" style="margin-top:8px;justify-content:flex-end">
          <button id="btnSendReset">Enviar link</button>
        </div>
        <div id="resetMsg" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- New password -->
      <div id="newPassBox" style="display:none">
        <div class="muted" style="margin:6px 0 8px">Defina a nova senha:</div>
        <input id="newPass1" type="password" placeholder="Nova senha" />
        <input id="newPass2" type="password" placeholder="Confirmar senha" style="margin-top:6px" />
        <div class="row" style="margin-top:8px;justify-content:flex-end">
          <button id="btnDoReset">Atualizar senha</button>
        </div>
        <div id="newPassMsg" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:6px">
      <h1 style="margin:0">Maestro Food</h1>
      <div class="topbar">
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filterbox" id="fx">
      <summary>
        FILTROS
        <span class="muted" id="limpar" title="Limpar filtros" style="font-weight:400">Limpar</span>
      </summary>
      <div class="body">
        <div class="filters-grid">
          <div class="col-6 seg"><span class="lbl">Unidade</span><select id="uni" class="grow"></select></div>
          <div class="col-6 seg"><span class="lbl">Nome da loja (Top 10)</span><div id="lojas" class="chips"></div></div>
          <div class="col-3 seg"><span class="lbl">De</span><input type="date" id="dini" class="grow" /></div>
          <div class="col-3 seg"><span class="lbl">Até</span><input type="date" id="dfim" class="grow" /></div>
          <div class="col-3 seg">
            <span class="lbl">Período rápido</span>
            <select id="pr" class="grow">
              <option value="7">Últimos 7</option><option value="15">Últimos 15</option>
              <option value="30" selected>Últimos 30</option><option value="90">Últimos 90</option>
              <option value="180">Últimos 180</option><option value="360">Últimos 360</option>
            </select>
          </div>
          <div class="col-3 seg"><span class="lbl">Turno</span><select id="turno" class="grow" multiple>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option></select></div>
          <div class="col-4 seg"><span class="lbl">Canal de venda</span><select id="canal" class="grow" multiple></select></div>
          <div class="col-4 seg"><span class="lbl">Pagamento</span><select id="pag" class="grow" multiple></select></div>
          <div class="col-4 seg"><span class="lbl">Está cancelado?</span>
            <select id="canc" class="grow"><option value="Todos" selected>Todos</option><option value="Sim">Sim</option><option value="Não">Não</option></select>
          </div>
        </div>

        <div class="admin">
          <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>)
          <div class="row" style="margin-top:6px;flex-wrap:wrap">
            <input type="file" id="csvfile" accept=".csv" />
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" value="0" max="100" style="width:220px;height:10px;display:none"></progress>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">…</div><div class="delta" id="d_tkm">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">…</div><div class="delta" id="d_fmd">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">…</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">…</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">…</div><div class="delta" id="d_frem">—</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">…</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">…</div><div class="delta" id="d_fatlp">—</div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px;color:#111">Receita diária</div>
        <div class="pill" data-target="lineMode"><button data-val="total" class="active">Total</button><button data-val="media">Média (7d)</button></div>
      </div><div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px;color:#111">Receita por dia da semana</div>
        <div class="pill" data-target="dowMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
      </div><div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px;color:#111">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
      </div><div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px;color:#111">Receita por hora</div>
        <div class="pill" data-target="hourMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
      </div><div class="chartbox"><canvas id="cHour"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px;color:#111">Receita por mês</div>
        <div class="pill" data-target="monMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
      </div><div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px;color:#111">Top 10 Lojas</div>
        <div class="pill" data-target="topMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
      </div><div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Config =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  let TABLE  = "vendas_kpi_daily_v2";         // alvo principal (MV)
  const STAGING= "vendas_kpi_daily_v2_data";   // staging (upload)

  const RESET_REDIRECT = window.location.href.split('#')[0] + "#recover"; // Configure no Auth → Redirect URLs

  // ===== Helpers =====
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });
  const Q = (id)=>document.getElementById(id);
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ return d.toISOString().slice(0,10); }
  function parseISO(s){ return new Date(s+"T00:00:00Z"); }
  function addDays(d, k){ const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function avg(a,b){ return b>0? a/b : 0; }
  function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }; }

  // ===== Estado =====
  const selUni=Q("uni"), chipLojas=Q("lojas"), dini=Q("dini"), dfim=Q("dfim"), pr=Q("pr"),
        turno=Q("turno"), canal=Q("canal"), pag=Q("pag"), canc=Q("canc");
  let chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  let lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";
  let diasDisponiveis=new Set(), maxDiaISO=null, minDiaISO=null, runId=0;

  // ===== Auth (entrar/criar conta/esqueci senha) =====
  const gate=Q("gate"), app=Q("app"), who=Q("who");
  const tabLogin=Q("tabLogin"), tabSignup=Q("tabSignup"), btnLogin=Q("btnLogin"), btnSignup=Q("btnSignup"),
        authEmail=Q("authEmail"), authPass=Q("authPass"), authErr=Q("authErr"), btnLogout=Q("btnLogout");
  const lForgot=Q("lForgot"), resetBox=Q("resetBox"), resetEmail=Q("resetEmail"), btnSendReset=Q("btnSendReset"), resetMsg=Q("resetMsg");
  const newPassBox=Q("newPassBox"), newPass1=Q("newPass1"), newPass2=Q("newPass2"), btnDoReset=Q("btnDoReset");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }

  tabLogin.onclick=()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; resetBox.style.display="none"; newPassBox.style.display="none"; };
  tabSignup.onclick=()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; resetBox.style.display="none"; newPassBox.style.display="none"; };

  btnLogin.onclick=async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
    hideGate(); afterLogin();
  };

  btnSignup.onclick=async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password: pass });
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail se necessário.";
  };

  lForgot.onclick=()=>{ resetBox.style.display="block"; newPassBox.style.display="none"; authErr.textContent=""; };
  btnSendReset.onclick=async ()=>{
    resetMsg.textContent="";
    const email=(resetEmail.value||"").trim(); if(!email){ resetMsg.textContent="Preencha o e-mail."; return; }
    const { error } = await supa.auth.resetPasswordForEmail(email, { redirectTo: RESET_REDIRECT });
    resetMsg.textContent = error ? ("Erro: "+error.message) : "Link enviado! Verifique seu e-mail.";
  };
  btnDoReset.onclick=async ()=>{
    const p1=newPass1.value||"", p2=newPass2.value||"";
    if(p1.length<6){ Q("newPassMsg").textContent="Mínimo 6 caracteres."; return; }
    if(p1!==p2){ Q("newPassMsg").textContent="Senhas não conferem."; return; }
    const { error } = await supa.auth.updateUser({ password:p1 });
    Q("newPassMsg").textContent = error ? ("Erro: "+error.message) : "Senha atualizada! Faça login.";
  };
  btnLogout.onclick=async()=>{ await supa.auth.signOut(); showGate(); };
  supa.auth.onAuthStateChange((event, session)=>{
    if(event==="PASSWORD_RECOVERY"){ showGate(); tabLogin.click(); newPassBox.style.display="block"; }
    if(session && event!=="PASSWORD_RECOVERY"){ hideGate(); afterLogin(); }
  });

  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    boot();
  }

  // ===== Filtros =====
  Q("limpar").onclick=function(e){
    e.preventDefault();
    selUni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos";
    Array.from(chipLojas.children).forEach(c=>c.classList.remove("active"));
    recarregarDebounced();
  };

  // ===== Data helpers =====
  async function ensureSource(){
    // tenta ler 1 linha da MV; se quebrar, cai para STAGING
    const probe = await supa.from(TABLE).select("dia").limit(1);
    if(probe.error){ TABLE = STAGING; }
  }

  async function fetchPaged(fields, startISO, endISO, unidade, lojas, filtros){
    let page=1000, off=0, out=[];
    for(;;){
      let q = supa.from(TABLE).select(fields).gte("dia", startISO).lte("dia", endISO).order("dia",{ascending:true}).range(off, off+page-1);
      if(unidade && unidade!=="Todas") q=q.eq("unidade",unidade);
      if(lojas && lojas.length) q=q.in("Nome da Loja",lojas);
      if(filtros.turno && filtros.turno.length) q=q.in("turno",filtros.turno);
      if(filtros.canal && filtros.canal.length) q=q.in("Canal de venda",filtros.canal);
      if(filtros.pag && filtros.pag.length) q=q.in("pagamento",filtros.pag);
      if(filtros.canc && filtros.canc!=="Todos") q=q.eq("cancelado", filtros.canc==="Sim"?"Sim":"Não");
      const r=await q; if(r.error){ throw r.error; }
      const a=r.data||[]; out=out.concat(a);
      if(a.length<page) break;
      off+=page; if(off>500000) break;
    }
    return out;
  }

  async function fetchUnidades(){
    const uniq={}, arr=["Todas"];
    function push(list){ (list||[]).forEach(row=>{ const u=(row.unidade||"").trim(); if(!u) return; if(!uniq[u]){ uniq[u]=1; arr.push(u); } }); }
    const r1=await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).range(0,9999);
    if(!r1.error) push(r1.data);
    const r2=await supa.from(TABLE).select("unidade").order("unidade",{ascending:false}).range(0,9999);
    if(!r2.error) push(r2.data);
    if(arr.length===1){ arr.push("Uni. Raja","Uni.Savassi"); }
    return arr;
  }

  async function fetchLimites(){
    const r = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const r2= await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r.error||r2.error) return;
    minDiaISO = (r.data&&r.data[0]&&r.data[0].dia)||null;
    maxDiaISO = (r2.data&&r2.data[0]&&r2.data[0].dia)||null;

    diasDisponiveis = new Set();
    let page=1000, off=0;
    for(;;){
      const rs=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).range(off,off+page-1);
      if(rs.error) break;
      (rs.data||[]).forEach(x=>diasDisponiveis.add(x.dia));
      if((rs.data||[]).length<page) break;
      off+=page; if(off>500000) break;
    }
    if(minDiaISO&&maxDiaISO){ dini.min=minDiaISO; dfim.min=minDiaISO; dini.max=maxDiaISO; dfim.max=maxDiaISO; }
  }
  function snapToAvailable(iso){
    if(!iso || diasDisponiveis.has(iso)) return iso;
    const d=parseISO(iso);
    for(let k=1;k<60;k++){
      const a=toISO(addDays(d,-k)), b=toISO(addDays(d,k));
      if(diasDisponiveis.has(a)) return a;
      if(diasDisponiveis.has(b)) return b;
    }
    return null;
  }

  function movingAvg(arr,win){ const out=[],n=arr.length; let acc=0; for(let i=0;i<n;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push(acc/Math.min(i+1,win)); } return out; }
  function destroyChart(c){ if(c){ try{c.destroy();}catch(e){} } return null; }
  function setDelta(el, cur, prev){ const pct=(prev>0)?((cur-prev)/prev*100):0; const up=pct>=0; el.className="delta "+(up?"up":"down"); el.textContent=(up?"+":"")+pct.toFixed(1)+"% "+(up?"▲":"▼"); }

  function drawLine(days, vals, prevVals, mode){
    chartLine=destroyChart(chartLine);
    const ctx=Q("cLine").getContext("2d");
    const dataMed=movingAvg(vals,7), showMed=(mode==="media"), mainData=showMed?dataMed:vals;
    chartLine=new window.Chart(ctx,{ type:"line",
      data:{ labels:days, datasets:[
        { data:prevVals, fill:true, borderWidth:0, backgroundColor:"rgba(2,132,199,.12)", pointRadius:0, tension:.2 },
        { label:showMed?"Média (7d)":"Total", data:mainData, borderWidth:2, pointRadius:0, tension:.2 }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
  }
  function drawBar(canvasId, labels, totals, counts, mode){
    const showMed=(mode==="media"), vals=showMed? totals.map((v,i)=> avg(v,counts[i]||1)) : totals.slice();
    const ctx=Q(canvasId).getContext("2d");
    return new window.Chart(ctx,{ type:"bar", data:{ labels, datasets:[{data:vals}] }, options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }});
  }

  async function recarregar(){
    const myRun=++runId;
    try{
      if(!maxDiaISO) await fetchLimites();
      if(!maxDiaISO) return;

      let psISO=dini.value||"", peISO=dfim.value||"", s,e;
      if(psISO&&peISO){
        const s0=snapToAvailable(psISO), e0=snapToAvailable(peISO);
        if(s0!==psISO) dini.value=s0; if(e0!==peISO) dfim.value=e0;
        s=parseISO(dini.value); e=parseISO(dfim.value);
      }else{
        const end=parseISO(maxDiaISO), days=Number(pr.value)||30, start=addDays(end,-(days-1));
        s=start; e=end; dini.value=toISO(s); dfim.value=toISO(e);
      }
      const startISO=toISO(s), endISO=toISO(e);

      const lojas=Array.from(chipLojas.children).filter(c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      const filtros={ turno:Array.from(turno.selectedOptions).map(o=>o.value), canal:Array.from(canal.selectedOptions).map(o=>o.value), pag:Array.from(pag.selectedOptions).map(o=>o.value), canc:(canc.value||"Todos") };
      const uniVal=selUni.value||"Todas";

      const fields='dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora';
      const cur=await fetchPaged(fields,startISO,endISO,uniVal==="Todas"?null:uniVal,lojas,filtros); if(myRun!==runId) return;

      const daysLen=Math.max(1, Math.round((parseISO(endISO)-parseISO(startISO))/(24*3600*1000))+1);
      const prevEnd=addDays(parseISO(startISO),-1), prevStart=addDays(prevEnd,-(daysLen-1));
      const ant=await fetchPaged(fields,toISO(prevStart),toISO(prevEnd),uniVal==="Todas"?null:uniVal,lojas,filtros); if(myRun!==runId) return;

      if(canal.options.length===0 || pag.options.length===0){
        const all=await fetchPaged('dia,"Canal de venda",pagamento', minDiaISO, maxDiaISO, null, null, {});
        const canals=Array.from(new Set((all||[]).map(r=>r["Canal de venda"]).filter(Boolean))).sort();
        const pags=Array.from(new Set((all||[]).map(r=>r["pagamento"]).filter(Boolean))).sort();
        canals.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; canal.appendChild(o); });
        pags.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; pag.appendChild(o); });
      }

      // KPIs
      (function(){
        const ped = cur.reduce((s,r)=>s+Number(r.pedidos||0),0);
        const fat = cur.reduce((s,r)=>s+Number(r.fat||0),0);
        const des = cur.reduce((s,r)=>s+Number(r.des||0),0);
        const fre = cur.reduce((s,r)=>s+Number(r.fre||0),0);

        const pedA = ant.reduce((s,r)=>s+Number(r.pedidos||0),0);
        const fatA = ant.reduce((s,r)=>s+Number(r.fat||0),0);
        const desA = ant.reduce((s,r)=>s+Number(r.des||0),0);
        const freA = ant.reduce((s,r)=>s+Number(r.fre||0),0);

        const diasDistinct  = new Set(cur.map(r=>r.dia)).size || 1;
        const diasDistinctA = new Set(ant.map(r=>r.dia)).size || 1;

        const tkm  = ped  > 0 ? fat  / ped  : 0;
        const tkmA = pedA > 0 ? fatA / pedA : 0;

        const fmd  = fat  / diasDistinct;
        const fmdA = fatA / diasDistinctA;

        const fatLiq  = fat  - des  - fre  - (0.12 * fat);
        const fatLiqA = fatA - desA - freA - (0.12 * fatA);

        const desPct  = fat  > 0 ? (des  / fat  * 100) : 0;
        const desPctA = fatA > 0 ? (desA / fatA * 100) : 0;

        const freMed  = ped  > 0 ? fre  / ped  : 0;
        const freMedA = pedA > 0 ? freA / pedA : 0;

        const fatLiqPct  = fat  > 0 ? (fatLiq  / fat  * 100) : 0;
        const fatLiqPctA = fatA > 0 ? (fatLiqA / fatA * 100) : 0;

        Q("k_ped").textContent   = fmtInt(ped);
        Q("k_tkm").textContent   = fmtBRL(tkm);
        Q("k_fat").textContent   = fmtBRL(fat);
        Q("k_fmd").textContent   = fmtBRL(fmd);
        Q("k_des").textContent   = fmtBRL(des);
        Q("k_desp").textContent  = desPct.toFixed(1)+"%";
        Q("k_fre").textContent   = fmtBRL(fre);
        Q("k_frem").textContent  = fmtBRL(freMed);
        Q("k_fatl").textContent  = fmtBRL(fatLiq);
        Q("k_fatlp").textContent = fatLiqPct.toFixed(1)+"%";

        setDelta(Q("d_ped"),   ped,   pedA);
        setDelta(Q("d_tkm"),   tkm,   tkmA);
        setDelta(Q("d_fat"),   fat,   fatA);
        setDelta(Q("d_fmd"),   fmd,   fmdA);
        setDelta(Q("d_des"),   des,   desA);
        setDelta(Q("d_desp"),  desPct,desPctA);
        setDelta(Q("d_fre"),   fre,   freA);
        setDelta(Q("d_frem"),  freMed,freMedA);
        setDelta(Q("d_fatl"),  fatLiq,fatLiqA);
        setDelta(Q("d_fatlp"), fatLiqPct,fatLiqPctA);
      })();

      // Gráficos
      function byDay(arr){ const m=new Map(); arr.forEach(r=>m.set(r.dia,(m.get(r.dia)||0)+Number(r.fat||0))); const labels=Array.from(m.keys()).sort(); return {labels, values:labels.map(k=>m.get(k))};}
      const curD=byDay(cur), antD=byDay(ant);
      drawLine(curD.labels, curD.values, antD.values, lineMode);

      function groupDow(arr, field){
        const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
        const diasSet=new Set(arr.map(r=>r.dia)); Array.from(diasSet).forEach(d=>{ cnt[parseISO(d).getUTCDay()]++; });
        arr.forEach(r=>{ const d=parseISO(r.dia).getUTCDay(); m[d]+=Number(r[field]||0); }); return {labels:lbl, totals:m, counts:cnt};
      }
      const dowFat=groupDow(cur,'fat'); chartDowFat=destroyChart(chartDowFat); chartDowFat=drawBar("cDowFat", dowFat.labels, dowFat.totals, dowFat.counts, dowMode);
      const dowPed=groupDow(cur,'pedidos'); chartDowPed=destroyChart(chartDowPed); chartDowPed=drawBar("cDowPed", dowPed.labels, dowPed.totals, dowPed.counts, dowPedMode);

      const hour=(function(){ const m=Array(24).fill(0), cnt=Array(24).fill(0), daysByHour=Array(24).fill(0).map(()=>new Set());
        cur.forEach(r=>{ if(r.hora==null) return; const h=Number(r.hora)||0; if(h<0||h>23) return; m[h]+=Number(r.fat||0); daysByHour[h].add(r.dia); });
        const totalDays=new Set(cur.map(r=>r.dia)).size||1, labels=[], totals=[], counts=[];
        for(let h=0;h<24;h++){ cnt[h]=daysByHour[h].size; const keep=cnt[h] >= Math.ceil(totalDays*0.5) && m[h]>0;
          if(keep){ labels.push(String(h).padStart(2,"0")+":00"); totals.push(m[h]); counts.push(cnt[h]); }}
        return {labels, totals, counts}; })();
      chartHour=destroyChart(chartHour); chartHour=drawBar("cHour", hour.labels, hour.totals, hour.counts, hourMode);

      const month=(function(){ const m=new Map(), cnt=new Map(), daysPerMonth=new Map();
        cur.forEach(r=>{ const ym=r.dia.slice(0,7); m.set(ym,(m.get(ym)||0)+Number(r.fat||0)); if(!daysPerMonth.has(ym)) daysPerMonth.set(ym,new Set()); daysPerMonth.get(ym).add(r.dia); });
        Array.from(daysPerMonth.keys()).forEach(ym=>cnt.set(ym,daysPerMonth.get(ym).size));
        const labels=Array.from(m.keys()).sort(), totals=labels.map(x=>m.get(x)), counts=labels.map(x=>cnt.get(x)||1); return {labels, totals, counts}; })();
      chartMonth=destroyChart(chartMonth); chartMonth=drawBar("cMonth", month.labels, month.totals, month.counts, monMode);

      const byLoja={}; cur.forEach(r=>{ const n=r["Nome da Loja"]; if(!n) return; byLoja[n]=(byLoja[n]||0)+Number(r.fat||0); });
      const top=Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const topLabels=top.map(x=>x[0]), topTotals=top.map(x=>x[1]), topCounts=top.map(_=>(new Set(cur.map(r=>r.dia)).size));
      chartTop=destroyChart(chartTop);
      (function(){ const ctx=Q("cTop").getContext("2d"); const showMed=(topMode==="media");
        const vals=showMed? topTotals.map((v,i)=>avg(v,topCounts[i]||1)) : topTotals.slice();
        chartTop=new window.Chart(ctx,{type:"bar",data:{labels:topLabels,datasets:[{data:vals}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}}); })();

      // chips lojas (só a 1ª vez)
      if(chipLojas.children.length===0){
        chipLojas.innerHTML="";
        topLabels.forEach(lbl=>{ const chip=document.createElement("span"); chip.className="chip"; chip.textContent=lbl; chip.setAttribute("data-v",lbl);
          chip.addEventListener("click", ()=>{ chip.classList.toggle("active"); recarregarDebounced(); }); chipLojas.appendChild(chip); });
      }

    }catch(_e){ /* silencioso */ }
  }
  const recarregarDebounced=debounce(recarregar,120);

  async function boot(){
    await ensureSource();               // garante fonte (MV ou STAGING)
    await fetchLimites();               // pega min/max do banco
    if(maxDiaISO){ const end=parseISO(maxDiaISO), start=addDays(end,-29); dini.value=toISO(start); dfim.value=toISO(end); }

    const opts=await fetchUnidades();   // popula unidade
    selUni.innerHTML=""; opts.forEach(u=>{ const o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); }); selUni.value="Todas";

    [selUni,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>{
      el.addEventListener("change", ()=>{ Q("fx").open=false; recarregarDebounced(); });
    });

    // toggles Total/Média
    document.querySelectorAll(".pill").forEach(p=>{
      p.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          p.querySelectorAll("button").forEach(b=>b.classList.remove("active")); btn.classList.add("active");
          const tgt=p.getAttribute("data-target"), v=btn.getAttribute("data-val");
          if(tgt==="lineMode") lineMode=v; if(tgt==="dowMode") dowMode=v; if(tgt==="dowPedMode") dowPedMode=v;
          if(tgt==="hourMode") hourMode=v; if(tgt==="monMode") monMode=v; if(tgt==="topMode") topMode=v;
          recarregarDebounced();
        });
      });
    });

    await recarregar();
  }

  // ===== Import CSV (staging) + tentativa de promoção =====
  Q("btnImport").addEventListener("click", async function(){
    const f=Q("csvfile").files[0]; if(!f){ alert("Selecione o arquivo Pasta2.csv"); return; }
    const prog=Q("prog"); prog.style.display="inline-block"; prog.value=0;

    // limpa staging
    await supa.from(STAGING).delete().neq('dia', null);

    // Autodetecta separador (Papa: delimiter:"" faz detecção automática)
    Papa.parse(f, {
      header:true, skipEmptyLines:true, dynamicTyping:false, delimiter:"",
      complete: async function(res){
        const rows=res.data||[]; const chunk=2000; let done=0;
        for(let i=0;i<rows.length;i+=chunk){
          const slice=rows.slice(i,i+chunk).map(r=>{
            // normaliza chaves com possíveis variações
            const nomeLoja = r["Nome da Loja"] ?? r["nome da loja"] ?? r["nome_loja"] ?? r["Nome_loja"];
            const canal    = r["Canal de venda"] ?? r["canal de venda"] ?? r["canal_venda"];
            return {
              dia:r.dia, unidade:r.unidade, pedidos:Number(r.pedidos)||0, fat:Number(r.fat)||0, des:Number(r.des)||0, fre:Number(r.fre)||0,
              "Nome da Loja": nomeLoja, turno:r.turno, "Canal de venda": canal, pagamento:r.pagamento, cancelado:r.cancelado, hora:(r.hora!=="" && r.hora!=null)? Number(r.hora):null
            };
          });
          const ins=await supa.from(STAGING).insert(slice);
          if(ins.error){ alert("Erro ao importar: "+ins.error.message); prog.style.display="none"; return; }
          done+=slice.length; prog.value=Math.round(done/rows.length*100);
        }
        prog.style.display="none";
        // tenta usar MV; se MV não existir, fica no STAGING automaticamente pelo ensureSource()
        await ensureSource(); await fetchLimites(); await recarregar();
        alert("Importação concluída.");
      },
      error: function(err){ prog.style.display="none"; alert("Erro no CSV: "+(err.message||err)); }
    });
  });

  // start
  (async function init(){
    if(location.hash==="#recover"){ showGate(); tabLogin.click(); newPassBox.style.display="block"; }
    const { data:{ session } } = await supa.auth.getSession();
    if(session){ hideGate(); afterLogin(); } else { showGate(); }
  })();

})();
</script>
</body>
</html>
