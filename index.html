<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase • v17.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --text:#0f172a; --muted:#6b7280; --card:#ffffff;
      --bd:#e5e7eb; --shadow:0 1px 2px rgba(0,0,0,.05); --accent:#0ea5e9;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
      font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:var(--shadow)}
    .kpi{flex:1 1 240px}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:24px;font-weight:700;margin-top:4px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type="date"]{width:100%;padding:8px 10px;border:1px solid var(--bd);border-radius:8px;background:#fff}
    .btn{padding:8px 12px;border:1px solid var(--bd);background:#fff;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.ghost{background:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .quick{display:flex;gap:8px;flex-wrap:wrap}
    .quick .btn{padding:6px 10px}
    canvas{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:10px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    @media (max-width:900px){.row{flex-direction:column;align-items:stretch}}
  </style>
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">Build <b>v17.2</b> • Fonte preferida: <code>public.vendas_kpi_daily</code></div>
        <div class="muted">URL: <span id="u"></span></div>
      </div>
      <div class="muted" id="periodo">Período: —</div>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-top:14px">
      <div class="row">
        <div style="min-width:180px">
          <label>Unidade</label>
          <select id="f_unidade"></select>
        </div>

        <div style="min-width:240px">
          <label>Período rápido (dias)</label>
          <div class="quick">
            <button class="btn" data-days="7">7</button>
            <button class="btn" data-days="15">15</button>
            <button class="btn" data-days="30">30</button>
            <button class="btn" data-days="90">90</button>
            <button class="btn" data-days="180">180</button>
            <button class="btn" data-days="360">360</button>
          </div>
        </div>

        <div>
          <label>De (dd/mm/aaaa)</label>
          <input id="f_de" placeholder="dd/mm/aaaa" />
        </div>
        <div>
          <label>Até (dd/mm/aaaa)</label>
          <input id="f_ate" placeholder="dd/mm/aaaa" />
        </div>

        <div>
          <label>Modo de Faturamento</label>
          <div>
            <label><input type="radio" name="modo" value="bruto" checked> Total (bruto)</label>
            <label style="margin-left:8px"><input type="radio" name="modo" value="liquido"> Líquido (Total − Entrega)</label>
          </div>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="btn_apply" class="btn primary">Aplicar</button>
          <button id="btn_clear" class="btn ghost">Limpar filtros</button>
          <button id="btn_reload" class="btn">Recarregar</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">Se preencher as datas acima, o período rápido é ignorado.</div>
    </div>

    <!-- KPIs -->
    <div class="row" style="margin-top:14px">
      <div class="card kpi">
        <div class="title">Pedidos</div>
        <div class="val" id="k_ped">…</div>
        <div class="sub" id="k_ped_sub">—</div>
      </div>
      <div class="card kpi">
        <div class="title">Faturamento</div>
        <div class="val" id="k_fat">…</div>
        <div class="sub" id="k_fat_sub">—</div>
      </div>
      <div class="card kpi">
        <div class="title">Incentivos</div>
        <div class="val" id="k_des">…</div>
        <div class="sub" id="k_des_sub">—</div>
      </div>
      <div class="card kpi">
        <div class="title">Frete</div>
        <div class="val" id="k_fre">…</div>
        <div class="sub" id="k_fre_sub">—</div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="card" style="margin-top:14px">
      <div class="title">Receita diária (R$)</div>
      <canvas id="chart_daily" height="160"></canvas>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="title">Totais por dia da semana (R$)</div>
      <canvas id="chart_wd" height="160"></canvas>
    </div>

    <!-- Logs -->
    <div class="card" style="margin-top:14px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
(function(){
  // ====== CREDENCIAIS (as que você me passou) ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

  document.getElementById("u").textContent = SUPABASE_URL.replace(/^https?:\/\//,'');

  // ====== helpers ======
  const elLog = document.getElementById("log");
  function log(x){ elLog.textContent += "\n" + x; }
  const BRL = new Intl.NumberFormat("pt-BR",{ style:"currency", currency:"BRL"});
  const INT = new Intl.NumberFormat("pt-BR",{ maximumFractionDigits:0});
  const WD  = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
  function ymd(d){ return d.toISOString().slice(0,10); }
  function dmyStr(d){ const s=ymd(d).split("-"); return `${s[2]}/${s[1]}/${s[0]}`; }
  function parseDMY(s){
    if(!s) return null;
    const m = String(s).trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    return new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
  }
  function addDays(d,n){ const r=new Date(d); r.setDate(r.getDate()+n); return r; }
  function pct(curr, prev){
    if(!prev) return {txt:"—", sign:0};
    const p = ((curr - prev) / prev) * 100;
    const t = (p>=0?"+":"") + p.toFixed(1).replace(".",",") + "% vs ant.";
    return {txt:t, sign:p};
  }
  function sum(arr,fn){ let s=0; for(const x of arr) s += fn(x)||0; return s; }

  // ====== Supabase ======
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const TABLE = "vendas_kpi_daily"; // dia, unidade, pedidos, fat, des, fre

  // ====== estado ======
  const state = {
    unidade: "Todas",
    dias: 30,
    de: null, ate: null,
    modo: "bruto"
  };

  // ====== UI refs ======
  const selUni   = document.getElementById("f_unidade");
  const inDe     = document.getElementById("f_de");
  const inAte    = document.getElementById("f_ate");
  const btnsQuick= Array.from(document.querySelectorAll(".quick .btn"));
  const radios   = Array.from(document.querySelectorAll('input[name="modo"]'));
  const periodEl = document.getElementById("periodo");

  const k_ped = document.getElementById("k_ped");
  const k_ped_sub = document.getElementById("k_ped_sub");
  const k_fat = document.getElementById("k_fat");
  const k_fat_sub = document.getElementById("k_fat_sub");
  const k_des = document.getElementById("k_des");
  const k_des_sub = document.getElementById("k_des_sub");
  const k_fre = document.getElementById("k_fre");
  const k_fre_sub = document.getElementById("k_fre_sub");

  // ====== charts ======
  let chartDaily = null, chartWD = null;
  function drawDaily(labels, values){
    if(chartDaily) chartDaily.destroy();
    const ctx = document.getElementById("chart_daily").getContext("2d");
    chartDaily = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{ label:"Receita diária (R$)", data: values, tension:.2 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { ticks: { callback:v=>BRL.format(v) } } }
      }
    });
  }
  function drawWeekday(labels, values){
    if(chartWD) chartWD.destroy();
    const ctx = document.getElementById("chart_wd").getContext("2d");
    chartWD = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{ label:"Por dia da semana (R$)", data: values }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { ticks: { callback:v=>BRL.format(v) } } }
      }
    });
  }

  // ====== data ======
  async function listUnidades(){
    // unidades distintas (leve; tabela já é diária)
    const r = await supa.from(TABLE).select("unidade",{distinct:true}).order("unidade",{ascending:true});
    if(r.error){ log("[Warn] unidades: "+r.error.message); return ["Todas"]; }
    const u = Array.from(new Set((r.data||[]).map(x=>x.unidade).filter(Boolean)));
    return ["Todas", ...u];
  }

  function windowNow(){
    const today = new Date(); // usa hoje — evita max()/ORDER
    const ate = state.ate ? state.ate : new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const dias = state.de && state.ate ? Math.max(1, Math.round((state.ate - state.de)/86400000)+1) : state.dias;
    const de = state.de ? state.de : addDays(ate, -(dias-1));
    return { de, ate, dias };
  }
  function prevWindow(w){ // imediatamente anterior
    const dias = Math.round((w.ate - w.de)/86400000)+1;
    const ate  = addDays(w.de, -1);
    const de   = addDays(ate, -(dias-1));
    return { de, ate, dias };
  }

  async function fetchPaged(filters, deIso, ateIso){
    // paginação defensiva (5k)
    const page = 5000;
    let from = 0, acc=[];
    for(;;){
      let q = supa.from(TABLE)
        .select("dia,unidade,pedidos,fat,des,fre")
        .gte("dia", deIso).lte("dia", ateIso)
        .range(from, from+page-1);
      if(filters.unidade && filters.unidade!=="Todas") q = q.eq("unidade", filters.unidade);
      const r = await q;
      if(r.error) throw r.error;
      const arr = r.data||[];
      acc = acc.concat(arr);
      if(arr.length<page) break;
      from += page;
    }
    return acc;
  }

  function aggregate(rows, modo){
    const pedidos = sum(rows, r=>r.pedidos);
    const fat     = sum(rows, r=>r.fat);
    const des     = sum(rows, r=>r.des);
    const fre     = sum(rows, r=>r.fre);
    const fatShow = (modo==="liquido") ? (fat - fre) : fat;

    // série diária (preencher dias ausentes com 0)
    const byDate = new Map();
    for(const r of rows){
      const key = r.dia.slice(0,10);
      const v = (modo==="liquido") ? (r.fat - r.fre) : r.fat;
      byDate.set(key, (byDate.get(key)||0) + v);
    }
    const w = windowNow(); // usa janela atual para eixo completo
    let labels=[], values=[];
    for(let d=new Date(w.de); d<=w.ate; d=addDays(d,1)){
      const k = ymd(d);
      labels.push(dmyStr(d));
      values.push(byDate.get(k)||0);
    }

    // por dia da semana
    const wd = [0,0,0,0,0,0,0];
    for(const [k,v] of byDate){ // k = YYYY-MM-DD
      const dt = new Date(k+"T00:00:00");
      wd[dt.getDay()] += v;
    }

    return { pedidos, fat, des, fre, fatShow, labels, values, wd };
  }

  function setKPIs(curr, prev){
    k_ped.textContent = INT.format(curr.pedidos);
    const p1 = pct(curr.pedidos, prev.pedidos);
    k_ped_sub.textContent = `${p1.txt} • ant: ${INT.format(prev.pedidos)}`;

    k_fat.textContent = BRL.format(curr.fatShow);
    const p2 = pct(curr.fatShow, prev.fatShow);
    k_fat_sub.textContent = `${p2.txt} • ant: ${BRL.format(prev.fatShow)}`;

    k_des.textContent = BRL.format(curr.des);
    const p3 = pct(curr.des, prev.des);
    k_des_sub.textContent = `${p3.txt} • ant: ${BRL.format(prev.des)}`;

    k_fre.textContent = BRL.format(curr.fre);
    const p4 = pct(curr.fre, prev.fre);
    k_fre_sub.textContent = `${p4.txt} • ant: ${BRL.format(prev.fre)}`;
  }

  async function recarregar(){
    try{
      const w = windowNow();
      const deIso = ymd(w.de), ateIso = ymd(w.ate);
      periodEl.textContent = `Período: ${deIso} → ${ateIso}`;

      log(`[Query] ${TABLE} | janela ${w.dias}d ${deIso} → ${ateIso} | UNI=${state.unidade} | modo=${state.modo}`);
      const rowsNow  = await fetchPaged(state, deIso, ateIso);
      log(`[OK] Linhas (atual): ${rowsNow.length}`);

      const prev = prevWindow(w);
      const deIsoP = ymd(prev.de), ateIsoP = ymd(prev.ate);
      log(`[Query] anterior: ${deIsoP} → ${ateIsoP}`);
      const rowsPrev = await fetchPaged(state, deIsoP, ateIsoP);

      const aggNow  = aggregate(rowsNow,  state.modo);
      const aggPrev = aggregate(rowsPrev, state.modo);

      setKPIs(aggNow, aggPrev);
      drawDaily(aggNow.labels, aggNow.values);
      drawWeekday(WD, aggNow.wd);
      log("[OK] KPIs e gráficos atualizados.");
    }catch(e){
      log("[ERRO] "+(e.message||String(e)));
      console.error(e);
    }
  }

  // ====== boot ======
  async function boot(){
    log("[Boot] v17.2 — diagnóstico + gráficos estáveis (Chart.js) • sem ORDER/max • paginação 5k");

    // unidades
    const opts = await listUnidades();
    selUni.innerHTML = opts.map(u=>`<option>${u}</option>`).join("");
    selUni.value = "Todas";

    // quick
    btnsQuick.forEach(btn=>{
      btn.onclick = ()=>{ state.dias = parseInt(btn.dataset.days,10); state.de=null; state.ate=null; inDe.value=""; inAte.value=""; recarregar(); };
    });

    // modo
    radios.forEach(r=> r.onchange = ()=>{ state.modo = r.value; recarregar(); });

    // unidade
    selUni.onchange = ()=>{ state.unidade = selUni.value; recarregar(); };

    // aplicar datas
    document.getElementById("btn_apply").onclick = ()=>{
      const d1 = parseDMY(inDe.value), d2 = parseDMY(inAte.value);
      if(d1 && d2 && d1<=d2){ state.de=d1; state.ate=d2; recarregar(); }
      else { alert("Datas inválidas. Use dd/mm/aaaa."); }
    };

    // limpar
    document.getElementById("btn_clear").onclick = ()=>{
      state.unidade="Todas"; selUni.value="Todas";
      state.modo="bruto"; radios.find(r=>r.value==="bruto").checked=true;
      state.de=null; state.ate=null; state.dias=30; inDe.value=""; inAte.value="";
      recarregar();
    };

    // recarregar
    document.getElementById("btn_reload").onclick = recarregar;

    // primeira carga
    recarregar();
  }

  boot();
})();
</script>
</body>
</html>
