<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v17.3 (Filtros completos + fallback)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--bd:#e5e7eb;--chip:#eef2ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:20px;font-weight:700;margin-top:4px}
    .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .pill{display:inline-block;background:var(--chip);border-radius:999px;padding:2px 8px;margin-right:6px}
    .btn{background:#111827;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.alt{background:#374151}
    .btn.ghost{background:#fff;color:#111827;border:1px solid var(--bd)}
    .btn.small{padding:6px 8px;font-size:12px}
    select,input{border:1px solid var(--bd);border-radius:8px;padding:8px 10px;background:#fff}
    label{font-size:12px;color:var(--muted)}
    .controls{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
    .controls .col{display:flex;flex-direction:column;gap:6px}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .inline{display:flex;align-items:center;gap:8px}
    .chart-card{padding:16px}
    canvas{max-width:100%;height:300px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    @media (max-width:980px){.controls{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:600px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">
          Build <span class="pill">v17.3</span>
          Fonte ativa: <code id="fonte">detectando…</code> (fallback automático)
        </div>
        <div class="muted">URL: <code id="urlShow">—</code></div>
      </div>
      <div class="muted" id="periodoShow">Período: —</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">Diagnóstico</div>
      <div id="diag" class="muted">—</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">Filtros (em cascata)</div>
      <div class="controls" style="margin-top:10px">
        <div class="col">
          <label>Unidade</label>
          <select id="f_unidade"><option>Todas</option></select>
        </div>
        <div class="col">
          <label>Turno</label>
          <select id="f_turno"><option>Todos</option></select>
        </div>
        <div class="col">
          <label>Canal</label>
          <select id="f_canal"><option>Todos</option></select>
        </div>
        <div class="col">
          <label>Cupom</label>
          <select id="f_cupom">
            <option>Todos</option>
            <option value="S">S</option>
            <option value="N">N</option>
          </select>
        </div>
        <div class="col">
          <label>Pagamento</label>
          <select id="f_pagamento"><option>Todos</option></select>
        </div>
        <div class="col">
          <label>Cancelado</label>
          <select id="f_cancelado">
            <option>Todos</option>
            <option value="S">S</option>
            <option value="N">N</option>
          </select>
        </div>
        <div class="col">
          <label>Entregador</label>
          <select id="f_entregador"><option>Todos</option></select>
        </div>

        <div class="col">
          <label>Período rápido (dias)</label>
          <div class="stack">
            <button class="btn small ghost" data-days="7">7</button>
            <button class="btn small ghost" data-days="15">15</button>
            <button class="btn small ghost" data-days="30">30</button>
            <button class="btn small ghost" data-days="90">90</button>
            <button class="btn small ghost" data-days="180">180</button>
            <button class="btn small ghost" data-days="360">360</button>
          </div>
        </div>
        <div class="col">
          <label>De (dd/mm/aaaa)</label>
          <input id="dtDe" placeholder="dd/mm/aaaa" />
        </div>
        <div class="col">
          <label>Até (dd/mm/aaaa)</label>
          <input id="dtAte" placeholder="dd/mm/aaaa" />
        </div>
        <div class="col">
          <label>Modo de Faturamento</label>
          <div class="inline">
            <label class="inline"><input type="radio" name="modo" value="bruto" checked /> Total (bruto)</label>
            <label class="inline"><input type="radio" name="modo" value="liquido" /> Líquido (Total − Entrega)</label>
          </div>
        </div>
        <div class="col">
          <label>Ações</label>
          <div class="stack">
            <button id="btnAplicar" class="btn">Aplicar</button>
            <button id="btnLimpar" class="btn alt">Limpar filtros</button>
            <button id="btnReload" class="btn ghost">Recarregar</button>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Se preencher as datas acima, o período rápido é ignorado.</div>
    </div>

    <div class="kpi">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="muted" id="k_ped_prev">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="muted" id="k_fat_prev">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_des">…</div><div class="muted" id="k_des_prev">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="muted" id="k_fre_prev">—</div></div>
    </div>

    <div class="grid2">
      <div class="card chart-card">
        <div class="title">Receita diária (R$)</div>
        <canvas id="chartLine"></canvas>
      </div>
      <div class="card chart-card">
        <div class="title">Totais por dia da semana (R$)</div>
        <canvas id="chartBars"></canvas>
      </div>
    </div>

    <div class="card" style="margin:12px 0 24px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

  <script>
    // ===== Credenciais =====
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ===== Estado/UI =====
    const elLog = document.getElementById("log"), elDiag = document.getElementById("diag"),
          elPeriodo = document.getElementById("periodoShow"), elUrlShow = document.getElementById("urlShow"),
          elFonte = document.getElementById("fonte");
    const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
    const fmtInt = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
    const log = m => { elLog.textContent += "\\n" + m; elLog.scrollTop = elLog.scrollHeight; };
    const toISO = d => d.toISOString().slice(0,10);
    const parseDMY = (s)=>{const m=String(s||"").trim().match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/); if(!m) return null; const [_,dd,mm,yy]=m; const dt=new Date(Date.UTC(+yy,+mm-1,+dd,12)); return isNaN(dt)?null:dt;};
    const addDays = (date,n)=>{const d=new Date(date); d.setUTCDate(d.getUTCDate()+n); return d;};

    const f_unidade = document.getElementById("f_unidade"),
          f_turno = document.getElementById("f_turno"),
          f_canal = document.getElementById("f_canal"),
          f_cupom = document.getElementById("f_cupom"),
          f_pagamento = document.getElementById("f_pagamento"),
          f_cancelado = document.getElementById("f_cancelado"),
          f_entregador = document.getElementById("f_entregador");

    const dtDe = document.getElementById("dtDe"), dtAte = document.getElementById("dtAte");
    const btnsQuick = Array.from(document.querySelectorAll("[data-days]"));
    const btnAplicar = document.getElementById("btnAplicar"),
          btnLimpar = document.getElementById("btnLimpar"),
          btnReload = document.getElementById("btnReload");

    const k_ped=document.getElementById("k_ped"), k_fat=document.getElementById("k_fat"), k_des=document.getElementById("k_des"), k_fre=document.getElementById("k_fre");
    const k_ped_prev=document.getElementById("k_ped_prev"), k_fat_prev=document.getElementById("k_fat_prev"), k_des_prev=document.getElementById("k_des_prev"), k_fre_prev=document.getElementById("k_fre_prev");

    let quickDays = 30, chartLine, chartBars, TABLE = "vendas_kpi_daily", USE_DIMS = false;

    function destroyCharts(){ if(chartLine){chartLine.destroy();} if(chartBars){chartBars.destroy();} }
    function drawLine(data,label){
      destroyCharts();
      const ctx=document.getElementById("chartLine").getContext("2d");
      chartLine=new Chart(ctx,{type:"line",data:{labels:data.map(d=>d.dia),datasets:[{label,data:data.map(d=>d.valor),tension:.25}]},options:{responsive:true,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{ticks:{maxRotation:0,autoSkip:true}}}}});
    }
    function drawBars(byWeek){
      const ctx=document.getElementById("chartBars").getContext("2d");
      const ordem=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"]; const vals=ordem.map(k=>byWeek[k]||0);
      chartBars=new Chart(ctx,{type:"bar",data:{labels:ordem,datasets:[{label:"Total (R$)",data:vals}]},options:{responsive:true,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }
    function weekDayIndex(iso){ return new Date(iso+"T00:00:00Z").getUTCDay(); }
    function labelWeek(i){ return ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][i]; }
    function byWeekSum(daily){ const acc={}; for(const d of daily){ const wd=labelWeek(weekDayIndex(d.dia)); acc[wd]=(acc[wd]||0)+d.valor; } return acc; }

    function resolveJanela(){
      const iDe=parseDMY(dtDe.value), iAte=parseDMY(dtAte.value);
      let end=new Date(); end=new Date(Date.UTC(end.getUTCFullYear(),end.getUTCMonth(),end.getUTCDate(),12));
      let start=addDays(end,-(quickDays-1));
      if(iDe && iAte && iDe<=iAte){ start=iDe; end=iAte; }
      return {startISO:toISO(start), endISO:toISO(end)};
    }
    function janelaAnterior({startISO,endISO}){
      const s=new Date(startISO+"T12:00:00Z"), e=new Date(endISO+"T12:00:00Z");
      const dias=Math.round((e-s)/(24*3600*1000))+1, ePrev=addDays(s,-1), sPrev=addDays(ePrev,-(dias-1));
      return {startISO:toISO(sPrev), endISO:toISO(ePrev)};
    }

    function sum(arr, f){ return arr.reduce((a,x)=>a+Number(x[f]||0),0); }
    function setKPIs(cur,prev){
      const ped = sum(cur,"pedidos"), fat=sum(cur,"fat"), des=sum(cur,"des"), fre=sum(cur,"fre");
      const pedP= sum(prev,"pedidos"), fatP=sum(prev,"fat"), desP=sum(prev,"des"), freP=sum(prev,"fre");
      const varPct=(c,p)=>p?((c-p)/p*100):0;
      const delta=(pct,prev,fmt)=>`${pct>=0?"+":""}${pct.toFixed(1)}% vs ant. • ant: ${fmt(prev)}`;

      k_ped.textContent=fmtInt(ped);   k_ped_prev.textContent=delta(varPct(ped,pedP),pedP,fmtInt);
      k_fat.textContent=fmtBRL(fat);   k_fat_prev.textContent=delta(varPct(fat,fatP),fatP,fmtBRL);
      k_des.textContent=fmtBRL(des);   k_des_prev.textContent=delta(varPct(des,desP),desP,fmtBRL);
      k_fre.textContent=fmtBRL(fre);   k_fre_prev.textContent=delta(varPct(fre,freP),freP,fmtBRL);
    }
    function groupDaily(rows, modo){
      const map=new Map();
      for(const r of rows){
        const k=r.dia;
        if(!map.has(k)) map.set(k,{pedidos:0,fat:0,des:0,fre:0});
        const o=map.get(k);
        o.pedidos += Number(r.pedidos||0);
        o.fat     += Number(r.fat||0);
        o.des     += Number(r.des||0);
        o.fre     += Number(r.fre||0);
      }
      const out=[]; for(const [d,v] of map.entries()){ out.push({dia:d, valor: (modo==="liquido")?(v.fat - v.fre):v.fat}); }
      out.sort((a,b)=>a.dia.localeCompare(b.dia));
      return out;
    }

    async function tryDims(){
      const test = await supa.from("vendas_kpi_daily_dims").select("dia,unidade,turno,canal,cupom,pagamento,cancelado,entregador,pedidos,fat,des,fre").limit(1);
      if(!test.error){ TABLE="vendas_kpi_daily_dims"; USE_DIMS=true; elFonte.textContent="public."+TABLE; elDiag.textContent="✓ usando view rica (dims)."; return true; }
      const test2 = await supa.from("vendas_kpi_daily").select("dia,unidade,pedidos,fat,des,fre").limit(1);
      if(!test2.error){ TABLE="vendas_kpi_daily"; USE_DIMS=false; elFonte.textContent="public."+TABLE; elDiag.textContent="✓ usando fallback (sem dims)."; return true; }
      elDiag.textContent="✗ nenhuma view disponível."; return false;
    }

    function setOptions(selectEl, values, keep="Todos"){
      const cur = selectEl.value || keep;
      selectEl.innerHTML=""; 
      const all=document.createElement("option"); all.textContent=keep; all.value=keep; selectEl.appendChild(all);
      Array.from(new Set(values.filter(v=>v && v!=="(sem)"))).sort().forEach(v=>{
        const o=document.createElement("option"); o.textContent=v; o.value=v; if(v===cur) o.selected=true; selectEl.appendChild(o);
      });
    }

    async function fetchPaged(fromISO,toISO,filters){
      const page=5000; let off=0, acc=[];
      for(;;){
        let sel = USE_DIMS
          ? "dia,unidade,turno,canal,cupom,pagamento,cancelado,entregador,pedidos,fat,des,fre"
          : "dia,unidade,pedidos,fat,des,fre";
        let q = supa.from(TABLE).select(sel).gte("dia",fromISO).lte("dia",toISO).range(off, off+page-1);
        if(filters.unidade && filters.unidade!=="Todas"){ q=q.eq("unidade",filters.unidade); }
        if(USE_DIMS){
          if(filters.turno && filters.turno!=="Todos") q=q.eq("turno",filters.turno);
          if(filters.canal && filters.canal!=="Todos") q=q.eq("canal",filters.canal);
          if(filters.cupom && filters.cupom!=="Todos") q=q.eq("cupom",filters.cupom);
          if(filters.pagamento && filters.pagamento!=="Todos") q=q.eq("pagamento",filters.pagamento);
          if(filters.cancelado && filters.cancelado!=="Todos") q=q.eq("cancelado",filters.cancelado);
          if(filters.entregador && filters.entregador!=="Todos") q=q.eq("entregador",filters.entregador);
        }
        const r=await q;
        if(r.error) throw r.error;
        const arr=r.data||[];
        acc=acc.concat(arr);
        if(arr.length<page) break;
        off+=page;
      }
      return acc;
    }

    function fillFilterOptions(rows){
      // sempre Unidade
      setOptions(f_unidade, rows.map(r=>r.unidade), "Todas");
      if(!USE_DIMS){
        // sem dims: zera outros filtros mas mantém UI
        setOptions(f_turno, [], "Todos");
        setOptions(f_canal, [], "Todos");
        setOptions(f_pagamento, [], "Todos");
        setOptions(f_entregador, [], "Todos");
        // cupom/cancelado já têm S/N fixos, mantemos
        return;
      }
      setOptions(f_turno,      rows.map(r=>r.turno), "Todos");
      setOptions(f_canal,      rows.map(r=>r.canal), "Todos");
      setOptions(f_pagamento,  rows.map(r=>r.pagamento), "Todos");
      setOptions(f_entregador, rows.map(r=>r.entregador), "Todos");
    }

    async function recarregar(){
      try{
        const modo=(document.querySelector('input[name="modo"]:checked')||{}).value||"bruto";
        const jan=resolveJanela(); elPeriodo.textContent=`Período: ${jan.startISO} → ${jan.endISO}`;
        const filters={
          unidade:   f_unidade.value||"Todas",
          turno:     f_turno.value||"Todos",
          canal:     f_canal.value||"Todos",
          cupom:     f_cupom.value||"Todos",
          pagamento: f_pagamento.value||"Todos",
          cancelado: f_cancelado.value||"Todos",
          entregador:f_entregador.value||"Todos"
        };
        log(`[Query] ${TABLE} | ${jan.startISO} → ${jan.endISO} | filtros=${JSON.stringify(filters)} | modo=${modo}`);

        const rows = await fetchPaged(jan.startISO, jan.endISO, filters);
        log(`[OK] Linhas (atual): ${rows.length.toLocaleString("pt-BR")}`);
        fillFilterOptions(rows);

        const janPrev=janelaAnterior(jan);
        log(`[Query] anterior: ${janPrev.startISO} → ${janPrev.endISO}`);
        const rowsPrev = await fetchPaged(janPrev.startISO, janPrev.endISO, filters);

        setKPIs(rows, rowsPrev);
        const daily=groupDaily(rows, modo);
        drawLine(daily, modo==="liquido" ? "Receita diária (líquida)" : "Receita diária (bruta)");
        drawBars(byWeekSum(daily));

        log("[OK] KPIs e gráficos atualizados.");
      }catch(e){
        console.error(e); log("[ERRO] "+(e.message||String(e)));
      }
    }

    // Eventos
    document.querySelectorAll('[data-days]').forEach(b=> b.addEventListener('click', ()=>{ quickDays=+b.dataset.days; dtDe.value=""; dtAte.value=""; recarregar(); }));
    btnAplicar.onclick = ()=> recarregar();
    btnReload.onclick  = ()=> recarregar();
    btnLimpar.onclick  = ()=>{
      f_unidade.value="Todas"; f_turno.value="Todos"; f_canal.value="Todos"; f_cupom.value="Todos"; f_pagamento.value="Todos"; f_cancelado.value="Todos"; f_entregador.value="Todos";
      quickDays=30; dtDe.value=""; dtAte.value="";
      document.querySelector('input[name="modo"][value="bruto"]').checked=true;
      recarregar();
    };
    [f_unidade,f_turno,f_canal,f_cupom,f_pagamento,f_cancelado,f_entregador].forEach(el=> el.onchange=()=>recarregar());
    document.querySelectorAll('input[name="modo"]').forEach(r=> r.onchange=()=>recarregar());

    // Boot
    (async function boot(){
      elUrlShow.textContent = SUPABASE_URL.replace(/^https?:\\/\\//,"");
      log("[Boot] v17.3 — tentando view rica (dims) com fallback sem regressão…");
      const ok = await tryDims();
      if(!ok){ log("[ERRO] não consegui detectar uma view válida."); return; }
      recarregar();
    })();
  </script>
</body>
</html>
