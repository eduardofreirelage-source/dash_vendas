<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard222</title>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--line:#e5e7eb;--ink:#0b1220;--muted:#667085;--ok:#0284c7;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-top:12px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .muted{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--bad)}
    #log{white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;font-size:12px;border:1px dashed var(--line);border-radius:10px;padding:10px;background:#f8fafc;max-height:260px;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:800px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div><strong>Upload</strong> <span class="muted">(.xlsx/.xls/.csv com ‚ÄúData da venda‚Äù)</span></div>
        <div>
          <label class="btn" for="fileExcel">üì§ Carregar Excel</label>
          <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" hidden>
        </div>
      </div>
      <div id="status" class="muted" style="margin-top:8px">‚Äî</div>
      <div id="log" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="muted">Pr√©via (5 primeiras linhas v√°lidas):</div>
          <div id="preview" style="font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#f8fafc;border:1px dashed #e6e7eb;border-radius:10px;padding:10px;max-height:260px;overflow:auto"></div>
        </div>
        <div>
          <div class="muted">Mapeamento escolhido:</div>
          <div id="map" style="font-family:ui-monospace,Menlo,monospace;font-size:12px;background:#f8fafc;border:1px dashed #e6e7eb;border-radius:10px;padding:10px;max-height:260px;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /********* Fallback de import din√¢mico *********/
    async function importWithFallback(urls){
      let lastErr;
      for(const u of urls){
        try { return await import(u); }
        catch(e){ lastErr=e; console.warn('Falha import', u, e); }
      }
      throw lastErr || new Error('Falha ao importar m√≥dulo remoto');
    }

    // Tenta v√°rias URLs conhecidas pro SheetJS (XLSX)
    const XLSX = await importWithFallback([
      // CDN oficial da SheetJS (vers√£o livre):
      'https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs',
      // Unpkg em modo m√≥dulo:
      'https://unpkg.com/xlsx@0.20.2?module',
      // jsDelivr variantes:
      'https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.mjs',
      'https://cdn.jsdelivr.net/npm/xlsx@0.20.2/+esm',
    ]);

    // Supabase (opcional ‚Äì se for gravar no banco)
    let createClient = null;
    try {
      ({ createClient } = await importWithFallback([
        'https://esm.sh/@supabase/supabase-js@2',
        'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm',
      ]));
    } catch(e){
      console.warn('Supabase n√£o importado (seguir√° apenas pr√©via local).', e);
    }

    /********* CONFIG *********/
    const SUPABASE_URL = 'https://SEU-PROJETO.supabase.co';   // << troque
    const SUPABASE_ANON_KEY = 'SEU-ANON-KEY';                  // << troque
    const TABLE = 'vendas_xlsx';
    const supa = (createClient && SUPABASE_URL.startsWith('http'))
      ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    /********* HELPERS *********/
    const $ = s => document.querySelector(s);
    const log = (...a)=>{$('#log').textContent += a.join(' ') + '\n'}
    const setStatus = (t, cls='') => { const el=$('#status'); el.className=cls; el.textContent=t }

    const sanitize = s => (s??'').toString()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/\s+/g,' ').trim().toLowerCase();

    function excelSerialToJSDate(n){
      try{
        const utc_days = Math.floor(n - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);
        const fractional_day = n - Math.floor(n) + 1e-7;
        let totalSeconds = Math.floor(86400 * fractional_day);
        const seconds = totalSeconds % 60; totalSeconds -= seconds;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor(totalSeconds / 60) % 60;
        date_info.setFullYear(date_info.getUTCFullYear(), date_info.getUTCMonth(), date_info.getUTCDate());
        date_info.setHours(hours, minutes, seconds, 0);
        return date_info;
      }catch{ return null }
    }
    function parseBRDateTime(s){
      if(typeof s!=='string') return null;
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(!m) return null;
      let [_, d, M, y, h, m2] = m;
      if(y.length===2) y = '20'+y;
      const dt = new Date(Number(y), Number(M)-1, Number(d), Number(h||0), Number(m2||0), 0, 0);
      return isNaN(dt) ? null : dt;
    }
    const toISO = d => d.toISOString().slice(0,10);
    const toHour = d => d.getHours();

    function findColumn(cols, candidates){
      const low = cols.map(c=>sanitize(c));
      for(const cand of candidates){
        const i = low.indexOf(sanitize(cand));
        if(i>=0) return cols[i];
      }
      for(const c of cols){
        const s = sanitize(c);
        let ok = true;
        for(const w of candidates[0].split(/\s+/)) if(!s.includes(w)){ ok=false; break; }
        if(ok) return c;
      }
      return null;
    }
    function summarizeMap(mp){
      return [
        `dia  ‚á¢ ${mp.colDate || '‚Äî'}`,
        `hora ‚á¢ ${mp.colHour || '(derivado/ausente)'}`,
        `unidade ‚á¢ ${mp.colUnid || '‚Äî'}`,
        `loja ‚á¢ ${mp.colLojaCod || mp.colLojaNome || '‚Äî'}`,
        `canal ‚á¢ ${mp.colCanal || '‚Äî'}`,
        `pagamento_base ‚á¢ ${mp.colPag || '‚Äî'}`,
        `cancelado ‚á¢ ${mp.colCancel || '‚Äî'}`,
        `pedidos ‚á¢ ${mp.colPed || '(default 1)'}`,
        `fat ‚á¢ ${mp.colFat || 'Valor Entregador/Total'}`,
        `des ‚á¢ ${mp.colDes || 'Desconto'}`,
        `fre ‚á¢ ${mp.colFre || 'Entrega'}`
      ].join('\n');
    }
    async function insertChunks(rows, n=800){
      if(!supa){ log('‚ö†Ô∏è Supabase n√£o configurado ‚Äî apenas pr√©via.'); return; }
      for(let i=0;i<rows.length;i+=n){
        const part = rows.slice(i,i+n);
        const {error} = await supa.from(TABLE).insert(part);
        if(error) throw error;
      }
    }

    /********* MAIN: handle upload *********/
    async function handleFile(file){
      $('#log').textContent=''; $('#map').textContent=''; $('#preview').textContent='';
      setStatus('Lendo arquivo‚Ä¶');

      // Leitura com SheetJS
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, {defval:null});
      if(!data.length){ setStatus('Arquivo sem linhas.', 'bad'); return; }

      // Mapeamento de colunas
      const cols = Object.keys(data[0]||{});
      const colDate = findColumn(cols, ['data da venda','data venda','data do pedido','data pedido','data','data hora','data/hora','datahora']);
      const colHour = findColumn(cols, ['hora','horario']);
      const colUnid = findColumn(cols, ['unidade']);
      const colLojaCod = findColumn(cols, ['codigo da loja','c√≥digo da loja','cod loja']);
      const colLojaNome= findColumn(cols, ['nome da loja','loja']);
      const colCanal   = findColumn(cols, ['canal de venda','canal','origem']);
      const colPag     = findColumn(cols, ['pagamento','meio de pagamento','tipo pagamento']);
      const colCancel  = findColumn(cols, ['esta cancelado','est√° cancelado','cancelado']);
      const colPed     = findColumn(cols, ['itens','qtd','quantidade']);
      const colFat     = findColumn(cols, ['valor entregador','total','faturamento','faturamento liquido','fat']);
      const colDes     = findColumn(cols, ['desconto']);
      const colFre     = findColumn(cols, ['entrega','frete']);

      const mapping = {colDate,colHour,colUnid,colLojaCod,colLojaNome,colCanal,colPag,colCancel,colPed,colFat,colDes,colFre};
      $('#map').textContent = summarizeMap(mapping);

      if(!colDate){
        setStatus('N√£o achei coluna de data (ex.: ‚ÄúData da venda‚Äù).', 'bad');
        log('Colunas do arquivo:', JSON.stringify(cols, null, 2));
        return;
      }

      // Normaliza√ß√£o
      let ok=0,bad=0;
      const out=[], dropped=[];
      const num = v => Number((v??0).toString().replace(',','.')) || 0;

      for(const r of data){
        let d = r[colDate], jsd=null;
        if(typeof d==='number') jsd = excelSerialToJSDate(d);
        if(!jsd && typeof d==='string') jsd = parseBRDateTime(d);
        if(!jsd && d instanceof Date && !isNaN(d)) jsd = d;
        if(!jsd){ bad++; dropped.push({motivo:'data inv√°lida', amostra:d}); continue; }

        const dia = toISO(jsd);

        let hora=null;
        if(colHour && r[colHour]!=null && r[colHour]!==''){
          const hv = r[colHour];
          if(typeof hv==='number'){ hora = (hv>=0 && hv<=23) ? Math.trunc(hv) : toHour(excelSerialToJSDate(hv)); }
          else if(typeof hv==='string'){ const m = hv.match(/(\d{1,2})/); hora = m ? Number(m[1]) : null; }
        }else{ hora = toHour(jsd); }
        if(!(hora>=0 && hora<=23)) hora = null;

        const unidade = colUnid ? String(r[colUnid]??'').trim() : null;
        const loja    = colLojaCod ? String(r[colLojaCod]??'').trim()
                      : colLojaNome ? String(r[colLojaNome]??'').trim() : null;
        const canal   = colCanal ? String(r[colCanal]??'').trim() : null;
        const pagamento_base = colPag ? String(r[colPag]??'').trim() : null;
        const cancelRaw = colCancel ? String(r[colCancel]??'').trim().toLowerCase() : 'n√£o';
        const cancelado = (cancelRaw==='sim'||cancelRaw==='true'||cancelRaw==='1') ? 'Sim' : 'N√£o';
        const pedidos = colPed ? Number(r[colPed]??0) : 1;

        const fat = num(r[colFat]); const des = num(r[colDes]); const fre = num(r[colFre]);

        out.push({ dia, hora, unidade, loja, canal, pagamento_base, cancelado, pedidos, fat, des, fre });
        ok++;
      }

      // Pr√©via e logs
      $('#preview').textContent = out.slice(0,5).map(o=>JSON.stringify(o)).join('\n') || '(sem linhas v√°lidas)';
      log(`Linhas lidas: ${data.length}`);
      log(`V√°lidas para importa√ß√£o: ${ok}`);
      if(bad>0) log(`Descartadas: ${bad} (ex.: ${JSON.stringify(dropped[0]||{},null,2)})`);

      if(!ok){ setStatus('Nenhuma linha v√°lida. Verifique a coluna de data.', 'bad'); return; }

      // Grava√ß√£o (opcional)
      try{
        if(supa){
          setStatus('Gravando no banco‚Ä¶');
          await insertChunks(out, 800);
          setStatus(`‚úÖ Gravado/atualizado: ${ok} linha(s).`, 'ok');
        }else{
          setStatus(`Pr√©via pronta (Supabase n√£o configurado).`, 'ok');
        }
      }catch(e){
        setStatus(`Erro ao gravar: ${e.message}`, 'bad');
        log('Detalhes:', JSON.stringify(e,null,2));
      }
    }

    /********* UI *********/
    $('#fileExcel').addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(!f) return;
      setStatus(`Arquivo: ${f.name}`);
      handleFile(f);
    });
  </script>
</body>
</html>
