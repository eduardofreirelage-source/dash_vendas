<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard — Upload para vendas_xlsx111</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0e1014; --panel:#151821; --muted:#8b91a1; --text:#dde3ee;
      --ok:#2ecc71; --warn:#e2b93b; --err:#ff5c5c; --brand:#3b82f6;
      --chip:#1f2330;
    }
    html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    .wrap{max-width:1120px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 18px;font-size:28px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--panel);border:1px solid #23283a;padding:12px 12px 14px;border-radius:12px}
    .chip{background:var(--chip);border:1px solid #273047;color:#b6c2d9;border-radius:999px;padding:6px 10px}
    .btn{background:var(--brand);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.sec{background:#2b3042}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grow{flex:1}
    .msg{margin-top:10px;border-radius:10px;padding:10px 12px}
    .msg.ok{background:rgba(46,204,113,.09);border:1px solid #2ecc71}
    .msg.warn{background:rgba(226,185,59,.09);border:1px solid #e2b93b}
    .msg.err{background:rgba(255,92,92,.09);border:1px solid #ff5c5c}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}
    .card{background:var(--panel);border:1px solid #23283a;border-radius:12px;min-height:220px;padding:10px 12px}
    .hd{font-weight:600;color:#c9d4ea;margin:4px 0 8px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;color:#b9c6e4}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#1a2030;border:1px solid #273047;border-radius:999px;padding:6px 10px;color:#cbd5e1}
    .pill strong{color:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .progress{height:8px;background:#1e2433;border-radius:6px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3b82f6,#22c55e)}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted)}
  </style>

  <!-- XLSX: tenta local (recomendado). Se não existir, cai para CDN. -->
  <script>
    (function ensureXLSX(){
      var s=document.createElement('script');
      s.src="xlsx.full.min.js"; s.onload=function(){window.__XLSX_LOCAL_OK=true};
      s.onerror=function(){
        var c=document.createElement('script');
        c.src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js";
        c.onload=function(){window.__XLSX_CDN_OK=true};
        c.onerror=function(){
          document.addEventListener('DOMContentLoaded',function(){
            showBanner('Falha ao carregar a biblioteca XLSX. Coloque <b>xlsx.full.min.js</b> na mesma pasta deste HTML ou libere a CDN.', 'warn');
          });
        };
        document.head.appendChild(c);
      };
      document.head.appendChild(s);
    })();
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- MD5 compacto (para row_key) -->
  <script>
  /*! tiny-md5 (dom) */
  (function(){function r(r){for(var n=unescape(encodeURIComponent(r)),t=[],e=0;e<n.length;e++)t.push(n.charCodeAt(e));return t}function n(r){for(var n="",t=0;t<r.length;t++)n+=String.fromCharCode(r[t]);return decodeURIComponent(escape(n))}function t(r,n){return r<<n|r>>>32-n}function e(r,n,e,o,a,f){return t(r+(n&e|~n&o)+a+f,7)+n}function o(r,n,e,o,a,f){return t(r+(n&o|e&~o)+a+f,12)+n}function a(r,n,e,o,a,f){return t(r+(n^e^o)+a+f,17)+n}function f(r,n,e,o,a,f){return t(r+(e^(n|~o))+a+f,22)+n}function u(r){for(var n=1732584193,t=-271733879,e=-1732584194,o=271733878,u=0;u<r.length;u+=16){var i=n,c=t,h=e,v=o;n=e(e=t=t=t,t=t,0);n=e(e=e,0);var y=r[u+0]|0,p=r[u+1]|0,d=r[u+2]|0,s=r[u+3]|0,l=r[u+4]|0,g=r[u+5]|0,m=r[u+6]|0,A=r[u+7]|0,w=r[u+8]|0,b=r[u+9]|0,k=r[u+10]|0,_=r[u+11]|0,S=r[u+12]|0,x=r[u+13]|0,C=r[u+14]|0,E=r[u+15]|0;n=e(n,t,e,o,y,3614090360),o=e(o,n,t,e,p,3905402710),e=e(o,n,t,d,606105819),t=e(t,o,n,s,3250441966),n=e(n,t,e,o,l,4118548399),o=e(o,n,t,e,g,1200080426),e=e(o,n,t,m,2821735955),t=e(t,o,n,A,4249261313),n=e(n,t,e,o,w,1770035416),o=e(o,n,t,e,b,2336552879),e=e(o,n,t,k,4294925233),t=e(t,o,n,_,2304563134),n=e(n,t,e,o,S,1804603682),o=e(o,n,t,e,x,4254626195),e=e(o,n,t,C,2792965006),t=e(t,o,n,E,1236535329),n=o(n,t,e,o,y,4129170786),o=o(o,n,t,e,w,3225465664),e=o(e,o,n,d,643717713),t=o(t,e,o,s,3921069994),n=o(n,t,e,o,g,3593408605),o=o(o,n,t,e,k,38016083),e=o(e,o,n,m,3634488961),t=o(t,e,o,A,3889429448),n=o(n,t,e,o,b,568446438),o=o(o,n,t,e,S,3275163606),e=o(e,o,n,C,4107603335),t=o(t,e,o,E,1163531501),n=o(n,t,e,o,y,2850285829),o=o(o,n,t,e,p,4243563512),e=o(e,o,n,_,1735328473),t=o(t,e,o,x,2368359562),n=a(n,t,e,o,p,4294588738),o=a(o,n,t,e,w,2272392833),e=a(e,o,n,k,1839030562),t=a(t,e,o,S,4259657740),n=a(n,t,e,o,y,2763975236),o=a(o,n,t,e,g,1272893353),e=a(e,o,n,m,4139469664),t=a(t,e,o,A,3200236656),n=a(n,t,e,o,b,681279174),o=a(o,n,t,e,_,3936430074),e=a(e,o,n,C,3572445317),t=a(t,e,o,E,76029189),n=a(n,t,e,o,p,3654602809),o=a(o,n,t,e,w,3873151461),e=a(e,o,n,d,530742520),t=a(t,e,o,s,3299628645),n=f(n,t,e,o,y,4096336452),o=f(o,n,t,e,k,1126891415),e=f(e,o,n,S,2878612391),t=f(t,e,o,p,4237533241),n=f(n,t,e,o,A,1700485571),o=f(o,n,t,e,d,2399980690),e=f(e,o,n,_,4293915773),t=f(t,e,o,g,2240044497),n=f(n,t,e,o,w,1873313359),o=f(o,n,t,e,C,4264355552),e=f(e,o,n,b,2734768916),t=f(t,e,o,E,1309151649),n=f(n,t,e,o,s,4149444226),o=f(o,n,t,e,m,3174756917),e=f(e,o,n,x,718787259),t=f(t,e,o,y,3951481745),n=n+i|0,t=t+c|0,e=e+h|0,o=o+v|0}return[n,t,e,o]}function i(r){for(var n=[],t=0;t<r.length;t+=4)n.push(r[t]|r[t+1]<<8|r[t+2]<<16|r[t+3]<<24);return n}function c(n){for(var t="",e=0;e<n.length;e++){var o=(n[e>>>2]>>>8*(e%4))&255;t+=("0"+o.toString(16)).slice(-2)}return t}window.md5=function(t){var e=r(t),o=(function(r){for(var n=r.length,t=[n>>>29&7|1,0,0,0],e=0;e<n;e++)t.push(r[e]);for(t.push(128);t.length%64!==56;)t.push(0);for(var o=8*n,a=0;a<8;a++)t.push(o>>>8*a&255);for(var f=[],u=0;u<t.length;u+=4)f.push(t[u]|t[u+1]<<8|t[u+2]<<16|t[u+3]<<24);return f})(e),a=u(o);return c(a.map(function(r){return[r&255,r>>>8&255,r>>>16&255,r>>>24&255]}).flat())};
  })();
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>

    <div class="bar">
      <span class="chip">.csv</span>
      <span class="chip">.xlsx / .xls</span>
      <span class="muted"> (Excel serial, <b>dd/mm/aaaa</b> ou <b>yyyy-mm-dd</b>. Se vier <b>data+hora</b>, eu extraio a <b>hora</b> automaticamente.)</span>
      <div class="grow"></div>
      <input id="file" type="file" accept=".csv,.xlsx,.xls" />
      <button id="btnSave" class="btn" disabled>Salvar no banco</button>
      <button id="btnClear" class="btn sec">Limpar UI</button>
    </div>

    <div id="xlDiag" class="row" style="margin-top:8px;gap:8px">
      <span class="pill">Leitor Excel: <strong id="xlStatus">...</strong></span>
      <span class="pill">Linhas <strong id="stat-lines">0</strong></span>
      <span class="pill">Válidas <strong id="stat-valid">0</strong></span>
      <span class="pill muted">Puladas (sem data) <strong id="stat-skip">0</strong></span>
    </div>

    <div id="banner"></div>

    <div id="progressWrap" class="msg" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div><b id="progLabel">Enviando...</b></div>
        <div class="muted" id="progNum">0/0</div>
      </div>
      <div class="progress" style="margin-top:8px"><i id="progBar"></i></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">Prévia (5 primeiras linhas válidas):</div>
        <pre id="preview">—</pre>
      </div>
      <div class="card">
        <div class="hd">Mapeamento escolhido:</div>
        <pre id="mapview">—</pre>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="hd">Ajuda rápida</div>
      <ul class="muted">
        <li>Se aparecer <code>"null value in column &quot;dia&quot;"</code>, alguma linha veio sem data. Eu pulo essas linhas no upload.</li>
        <li>Datas aceitas: Excel serial, <b>dd/mm/aaaa</b> ou <b>yyyy-mm-dd</b>. Se vier <b>data+hora</b>, eu extraio a <b>hora</b> automaticamente.</li>
        <li>Se sua rede bloquear CDN, deixe o arquivo <code>xlsx.full.min.js</code> na <b>mesma pasta</b> deste HTML.</li>
      </ul>
    </div>
  </div>

<script>
/* ====== CONFIG DO SUPABASE ====== */
const SUPABASE_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== UI helpers ====== */
const $ = (sel) => document.querySelector(sel);
function showBanner(html, kind='ok'){
  const el = document.createElement('div');
  el.className = 'msg '+(kind==='ok'?'ok':kind==='warn'?'warn':'err');
  el.innerHTML = html;
  const b = $('#banner');
  b.innerHTML='';
  b.appendChild(el);
}
function setProgress(cur, total, label='Enviando...'){
  $('#progressWrap').style.display='block';
  $('#progLabel').textContent = label;
  $('#progNum').textContent = `${cur}/${total}`;
  const pct = total? Math.round((cur/total)*100):0;
  $('#progBar').style.width = pct+'%';
}
function hideProgress(){ $('#progressWrap').style.display='none' }

/* ====== XLSX diag ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  const ok = window.__XLSX_LOCAL_OK || window.__XLSX_CDN_OK || (window.XLSX!=null);
  $('#xlStatus').textContent = ok ? (window.__XLSX_LOCAL_OK?'OK (local)':'OK (CDN)') : 'Falhou';
  if(!ok){
    showBanner('Falha ao carregar a biblioteca XLSX. Coloque <b>xlsx.full.min.js</b> na mesma pasta deste HTML ou libere a CDN.', 'warn');
  }
});

/* ====== Leitura e mapeamento ====== */
let parsedRows = [];    // linhas normalizadas prontas para enviar
let sampleRows = [];    // para exibir na prévia
let mappingChosen = {}; // nomes mapeados

$('#btnClear').addEventListener('click', ()=>{
  parsedRows = []; sampleRows=[]; mappingChosen={};
  $('#file').value = '';
  $('#stat-lines').textContent='0';
  $('#stat-valid').textContent='0';
  $('#stat-skip').textContent='0';
  $('#preview').textContent='—';
  $('#mapview').textContent='—';
  $('#btnSave').disabled=true;
  hideProgress();
  showBanner('', 'ok'); $('#banner').innerHTML='';
});

$('#file').addEventListener('change', async (e)=>{
  hideProgress();
  $('#btnSave').disabled = true;
  $('#preview').textContent='Lendo arquivo...';
  $('#mapview').textContent='—';
  parsedRows = []; sampleRows=[]; mappingChosen={};

  const file = e.target.files?.[0];
  if(!file){ $('#preview').textContent='—'; return; }

  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:'array', cellDates:true, raw:false});
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const data = XLSX.utils.sheet_to_json(ws, {defval:null});
  const total = data.length;

  // mapeamento automático por header
  const headers = Object.keys(data[0] || {});
  const map = chooseMapping(headers);
  mappingChosen = map;
  $('#mapview').textContent = JSON.stringify(map, null, 2);

  let valid = 0, skipped=0;
  const out = [];
  for (let i=0;i<data.length;i++){
    const row = data[i];
    const norm = normalizeRow(row, map);
    if(!norm.dia){ skipped++; continue; }
    // gera row_key determinístico (evita erro NOT NULL / PK)
    norm.row_key = makeRowKey(norm);
    out.push(norm);
    if(sampleRows.length<5) sampleRows.push(norm);
    valid++;
  }

  parsedRows = out;
  $('#stat-lines').textContent = String(total);
  $('#stat-valid').textContent = String(valid);
  $('#stat-skip').textContent = String(skipped);
  $('#preview').textContent = sampleRows.length? sampleRows.map(x=>JSON.stringify(x,null,2)).join('\n_\n') : '—';
  $('#btnSave').disabled = parsedRows.length===0;

  if(!parsedRows.length){
    showBanner('Nenhuma linha válida (todas sem data). Veja “Ajuda rápida”.', 'warn');
  }else{
    showBanner('Pronto para enviar. Use <b>Salvar no banco</b>.', 'ok');
  }
});

/* ====== Envio (upsert por row_key) ====== */
$('#btnSave').addEventListener('click', async ()=>{
  if(!parsedRows.length) return;
  const BATCH = 500;
  let ok=0, fail=0;
  setProgress(0, parsedRows.length, 'Enviando...');

  for (let i=0;i<parsedRows.length;i+=BATCH){
    const chunk = parsedRows.slice(i, i+BATCH);
    // upsert por row_key (on_conflict)
    const { error } = await supa
      .from('vendas_xlsx')
      .upsert(chunk, { onConflict: 'row_key' });

    if(error){
      fail += chunk.length;
      hideProgress();
      alert(`Parte dos registros falhou.\nInseridos/Atualizados: ${ok}\nFalhas: ${fail}\n\nÚltimo erro:\n${error.message||error}`);
      return;
    }else{
      ok += chunk.length;
      setProgress(ok, parsedRows.length, 'Enviando...');
    }
  }
  hideProgress();
  showBanner(`✅ Envio concluído: <b>${ok}/${parsedRows.length}</b> inseridos/atualizados.`, 'ok');
});

/* ====== Funções de normalização ====== */
function chooseMapping(headers){
  // normaliza headers
  const hs = headers.map(h=>String(h||'').trim().toLowerCase());
  const find = (...alts)=> {
    for(const a of alts){
      const ix = hs.indexOf(a.toLowerCase());
      if(ix>=0) return headers[ix];
    }
    return null;
  };

  const dia = find('data da venda','data do pedido','data','dia','dt','data venda','data pedido','data/hora','data e hora','data hora');
  const hora = find('hora','horário','horario','time','hora venda');
  const unid = find('unidade','uni','filial','empresa','unid');
  const loja = find('código da loja','codigo da loja','código loja','codigo loja','loja','nome da loja');
  const canal= find('canal de venda','canal','origem');
  const pag  = find('pagamento','tipo de pagamento','pagamento_base','tipo pagamento');
  const canc = find('está cancelado','cancelado','cancelada','cancel','cancelada?','está cancelada');
  const ped  = find('itens','pedidos','qtd pedidos','qtd','quantidade');
  const fat  = find('valor entregador','fat','faturamento','valor total','valor');
  const des  = find('des','desconto');
  const fre  = find('fre','entrega','frete');
  const pedido_id = find('pedido','pedido id','id pedido','id');

  return { dia, hora, unid, loja, canal, pag, canc, ped, fat, des, fre, pedido_id };
}

// parse data+hora ou serial excel
function parseDiaHora(v){
  if(v==null || v==='') return {dia:null,hora:null};
  // se veio um Date (XLSX cellDates:true) ou string reconhecida
  if(v instanceof Date){
    const d = v;
    return { dia: d.toISOString().slice(0,10), hora: d.getHours() };
  }
  if(typeof v==='number'){
    // Serial Excel: dias desde 1899-12-30
    const epoch = new Date(Date.UTC(1899,11,30));
    const ms = v*24*3600*1000;
    const d = new Date(epoch.getTime()+ms);
    return { dia: d.toISOString().slice(0,10), hora: d.getHours() };
  }
  const s = String(v).trim();
  // dd/mm/aaaa [hh:mm]
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::\d{2})?)?$/);
  if(m){
    const dd = m[1].padStart(2,'0');
    const mm = m[2].padStart(2,'0');
    const yyyy = m[3].length===2 ? ('20'+m[3]) : m[3];
    const hh = m[4]!=null? Number(m[4]): null;
    return { dia: `${yyyy}-${mm}-${dd}`, hora: hh };
  }
  // yyyy-mm-dd[ hh:mm]
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{1,2}):(\d{2})(?::\d{2})?)?$/);
  if(m2){
    const hh = m2[4]!=null? Number(m2[4]): null;
    return { dia:`${m2[1]}-${m2[2]}-${m2[3]}`, hora: hh };
  }
  // fallback: tenta Date()
  const d = new Date(s);
  if(!isNaN(d)){
    return { dia: d.toISOString().slice(0,10), hora: d.getHours() };
  }
  return { dia:null, hora:null };
}

function toNum(x){
  if(x==null || x==='') return 0;
  if(typeof x==='number') return x;
  const s=String(x).replace(/\./g,'').replace(',','.');
  const v=parseFloat(s);
  return isNaN(v)?0:v;
}
function toInt(x){
  if(x==null || x==='') return 0;
  if(typeof x==='number') return Math.round(x);
  const v=parseInt(String(x).replace(/\D+/g,'')||'0',10);
  return isNaN(v)?0:v;
}
function normCancel(x){
  const s = String(x==null?'':x).toLowerCase();
  if(['sim','yes','y','true','1'].includes(s)) return 'Sim';
  if(['nao','não','no','n','false','0'].includes(s)) return 'Não';
  return s ? s[0].toUpperCase()+s.slice(1) : 'Não';
}

function normalizeRow(row, map){
  const {dia,hora} = parseDiaHora(row[map.dia]);
  const turno = hora==null? null : (hora<12?'Manhã':hora<18?'Dia':'Noite');

  const rec = {
    dia, hora: hora==null? null: Number(hora),
    unidade: map.unid? String(row[map.unid]??'').trim() : null,
    loja: map.loja? String(row[map.loja]??'').trim() : null,
    canal: map.canal? String(row[map.canal]??'').trim() : null,
    pagamento_base: map.pag? String(row[map.pag]??'').trim() : null,
    cancelado: normCancel( map.canc? row[map.canc] : 'Não' ),
    pedidos: toInt( map.ped? row[map.ped] : 0 ),
    fat: toNum( map.fat? row[map.fat] : 0 ),
    des: toNum( map.des? row[map.des] : 0 ),
    fre: toNum( map.fre? row[map.fre] : 0 ),
    pedido_id: map.pedido_id? String(row[map.pedido_id]??'').trim() : null,
    turno
  };
  return rec;
}

function makeRowKey(o){
  // chave determinística a partir dos campos principais
  const key = [
    o.dia??'', o.hora??'', o.unidade??'', o.loja??'', o.canal??'',
    o.pagamento_base??'', o.cancelado??'', o.pedido_id??'',
    String(o.pedidos??0), String(o.fat??0), String(o.des??0), String(o.fre??0)
  ].join('|');
  return md5(key);
}
</script>
</body>
</html>
