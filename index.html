<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;
      --ok:#16a34a;--bad:#dc2626
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0}
    .toolbar{display:flex;align-items:center;justify-content:space-between}
    .muted{color:var(--muted);font-size:12px}
    .filters{background:#fff;border:1px solid var(--brd);border-radius:12px;padding:12px}
    .filters summary{cursor:pointer;list-style:none;font-weight:700}
    .grid{display:grid;gap:10px}
    .g12{grid-template-columns:repeat(12,1fr)}
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    .field{display:flex;flex-direction:column}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    select,input,button{font:inherit;border:1px solid var(--brd);border-radius:10px;background:#fff;padding:8px 10px}
    button{cursor:pointer}
    .right{margin-left:auto}
    .card{background:#fff;border:1px solid var(--brd);border-radius:12px;padding:14px}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:22px;font-weight:700}
    .seg-btn{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .seg-btn button{border:0;padding:6px 10px;background:#fff}
    .seg-btn button.active{background:var(--accent);color:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{border:1px solid var(--brd);background:#eef2ff;border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    progress{height:10px}
    @media (max-width:940px){ .g12{grid-template-columns:repeat(6,1fr)} .col-6{grid-column:span 6}.col-4{grid-column:span 3}.col-3{grid-column:span 3} }
    @media (max-width:560px){ .g12{grid-template-columns:repeat(4,1fr)} .col-6,.col-4,.col-3{grid-column:span 4} }
    /* Auth */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border:1px solid var(--brd);border-radius:14px;padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
    .tabs button.active{background:var(--accent);color:#fff}
    .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

  <!-- AUTH -->
  <div id="gate" class="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div class="field"><label>E-mail</label><input id="authEmail" type="email" autocomplete="email"></div>
      <div class="field"><label>Senha</label><input id="authPass" type="password" autocomplete="current-password"></div>
      <div class="error" id="authErr"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="btnSignup" style="display:none">Criar conta</button>
        <button id="btnLogin">Entrar</button>
      </div>
    </div>
  </div>

  <div id="app" class="wrap" style="display:none">
    <div class="toolbar" style="margin-bottom:10px">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="per">Período: —</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="muted" id="who"></span>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="filters">
      <div class="grid g12">
        <div class="field col-6">
          <label>Unidade</label>
          <select id="f_unidade"></select>
        </div>
        <div class="field col-6">
          <label>Nome da loja (Top 10)</label>
          <div id="chips" class="chips"></div>
        </div>

        <div class="field col-3">
          <label>De</label>
          <input id="f_de" type="date">
        </div>
        <div class="field col-3">
          <label>Até</label>
          <input id="f_ate" type="date">
        </div>
        <div class="field col-3">
          <label>Período rápido</label>
          <select id="f_rapido">
            <option value="7">Últimos 7</option>
            <option value="15">Últimos 15</option>
            <option value="30" selected>Últimos 30</option>
            <option value="90">Últimos 90</option>
          </select>
        </div>
        <div class="field col-3">
          <label>Turno</label>
          <select id="f_turno" multiple>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>

        <div class="field col-4">
          <label>Canal de venda</label>
          <select id="f_canal" multiple></select>
        </div>
        <div class="field col-4">
          <label>Pagamento</label>
          <select id="f_pag" multiple></select>
        </div>
        <div class="field col-4">
          <label>Está cancelado?</label>
          <select id="f_canc">
            <option>Todos</option><option>Não</option><option>Sim</option>
          </select>
        </div>

        <div class="col-12" style="border-top:1px dashed var(--brd);padding-top:10px;margin-top:4px">
          <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>) • o intervalo de datas do arquivo é limpo antes de inserir
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <input id="csvfile" type="file" accept=".csv">
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" value="0" max="100" style="display:none"></progress>
            <span class="muted" id="importMsg"></span>
            <button id="btnLimpar" class="right" title="Limpar filtros">Limpar</button>
          </div>
          <div class="muted" style="margin-top:6px">
            Limpo apenas o intervalo de datas do arquivo, insiro com deduplicação por chave composta (dia+unidade+loja+hora+pagamento+canal+Total+Entrega+Desconto).
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid g12" style="margin-top:12px">
      <div class="card kpi col-3"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
      <div class="card kpi col-3"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div></div>
      <div class="card kpi col-3"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
      <div class="card kpi col-3"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div></div>

      <div class="card kpi col-3"><div class="title">Incentivos</div><div class="val" id="k_des">—</div></div>
      <div class="card kpi col-3"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div></div>
      <div class="card kpi col-3"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      <div class="card kpi col-3"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div></div>

      <div class="card kpi col-6"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div></div>
      <div class="card kpi col-6"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div></div>
    </div>

    <!-- Gráfico exemplo (linha) -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária</div>
        <div class="seg-btn" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média (7d)</button>
        </div>
      </div>
      <div style="height:300px"><canvas id="cLine"></canvas></div>
    </div>
  </div>

<script>
(function(){
  if (window.__MAESTRO_BOOT__) return; window.__MAESTRO_BOOT__ = true;

  // ==== CONFIG ====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const READ_VIEW = "vendas_kpi_daily_v2";         // para SELECTs
  const WRITE_TABLE = "vendas_kpi_daily_v2_data";   // para IMPORT

  // ==== CLIENT & STATE (evita duplicação de variáveis) ====
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true }});
  const STATE = {
    minISO:null, maxISO:null, dias:new Set(),
    charts:{ line:null }, lineMode:'total'
  };

  // ==== HELPERS ====
  const $ = sel => document.querySelector(sel);
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ if(!(d instanceof Date) || isNaN(d)) return null; return d.toISOString().slice(0,10); }
  function parseISO(s){ if(!s) return null; const d=new Date(s+"T00:00:00Z"); return isNaN(d)?null:d; }
  function addDays(d,k){ const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function movingAvg(arr, win){ const out=[]; let acc=0; for(let i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push(acc / Math.min(i+1,win)); } return out; }

  // ==== AUTH UI ====
  const gate=$("#gate"), app=$("#app"), who=$("#who");
  const tabLogin=$("#tabLogin"), tabSignup=$("#tabSignup"), btnLogin=$("#btnLogin"), btnSignup=$("#btnSignup"), authErr=$("#authErr");
  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }
  tabLogin.onclick=()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; };
  tabSignup.onclick=()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; };
  btnLogin.onclick=async()=>{ authErr.textContent=""; const email=$("#authEmail").value.trim(), pass=$("#authPass").value; if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; } const {error}=await supa.auth.signInWithPassword({email,password:pass}); if(error){ authErr.textContent=error.message; return; } hideGate(); afterLogin(); };
  btnSignup.onclick=async()=>{ authErr.textContent=""; const email=$("#authEmail").value.trim(), pass=$("#authPass").value; if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; } const {error}=await supa.auth.signUp({email,password:pass}); authErr.textContent= error ? error.message : "Conta criada. Verifique seu e-mail, se necessário."; };
  $("#btnLogout").onclick=async()=>{ await supa.auth.signOut(); showGate(); };

  supa.auth.onAuthStateChange((_e, session)=>{ if(session){ hideGate(); afterLogin(); } else { showGate(); } });

  // ==== CARREGAMENTO BASE ====
  async function afterLogin(){
    const u = await supa.auth.getUser(); who.textContent = u.data?.user?.email || "";
    await ensureLimits();
    await fillStaticFilters();
    wireFilters();
    await reload();
  }

  // Busca min/max e popula range de dias
  async function ensureLimits(){
    // min
    let r = await supa.from(READ_VIEW).select("dia").order("dia",{ascending:true}).limit(1);
    if(r.error){ throw r.error; }
    STATE.minISO = r.data?.[0]?.dia || null;

    // max
    r = await supa.from(READ_VIEW).select("dia").order("dia",{ascending:false}).limit(1);
    if(r.error){ throw r.error; }
    STATE.maxISO = r.data?.[0]?.dia || null;

    // Datas disponíveis (apenas para snap básico)
    STATE.dias = new Set();
    let off=0, page=2000;
    for(;;){
      const q = await supa.from(READ_VIEW).select("dia").order("dia",{ascending:true}).range(off, off+page-1);
      if(q.error) break;
      (q.data||[]).forEach(x=>STATE.dias.add(x.dia));
      if((q.data||[]).length<page) break;
      off += page;
    }

    if(STATE.minISO && STATE.maxISO){
      $("#f_de").min = $("#f_ate").min = STATE.minISO;
      $("#f_de").max = $("#f_ate").max = STATE.maxISO;
      const end = parseISO(STATE.maxISO), start = addDays(end,-29);
      $("#f_de").value = toISO(start); $("#f_ate").value = toISO(end);
      $("#per").textContent = `Período: ${toISO(start)} → ${toISO(end)}`;
    }
  }

  async function fillStaticFilters(){
    // Unidades
    const opts = ["Todas"];
    const r = await supa.from(READ_VIEW).select("unidade").order("unidade",{ascending:true}).limit(10000);
    if(!r.error){ const set=new Set((r.data||[]).map(x=>x.unidade).filter(Boolean)); set.forEach(v=>opts.push(v)); }
    $("#f_unidade").innerHTML = opts.map(v=>`<option>${v}</option>`).join("");
    $("#f_unidade").value = "Todas";

    // Canal / Pagamento
    const all = await supa.from(READ_VIEW).select('"Canal de venda",pagamento').limit(200000);
    if(!all.error){
      const canals = Array.from(new Set((all.data||[]).map(r=>r["Canal de venda"]).filter(Boolean))).sort();
      const pags   = Array.from(new Set((all.data||[]).map(r=>r["pagamento"]).filter(Boolean))).sort();
      $("#f_canal").innerHTML = canals.map(v=>`<option>${v}</option>`).join("");
      $("#f_pag").innerHTML   = pags.map(v=>`<option>${v}</option>`).join("");
    }
  }

  function wireFilters(){
    ["#f_unidade","#f_de","#f_ate","#f_rapido","#f_turno","#f_canal","#f_pag","#f_canc"].forEach(sel=>{
      $(sel).addEventListener("change", async ()=>{
        if(sel==="#f_rapido"){
          const end = parseISO(STATE.maxISO); const days = Number($("#f_rapido").value)||30;
          $("#f_de").value = toISO(addDays(end,-(days-1))); $("#f_ate").value = toISO(end);
        }
        await reload();
      });
    });
    $("#btnLimpar").onclick = async ()=>{
      $("#f_unidade").value="Todas"; $("#f_canc").value="Todos"; $("#f_turno").value="";
      $("#f_canal").value=""; $("#f_pag").value="";
      const end = parseISO(STATE.maxISO); $("#f_rapido").value="30";
      $("#f_de").value=toISO(addDays(end,-29)); $("#f_ate").value=toISO(end);
      await reload();
    };
  }

  // ==== RELOAD PRINCIPAL ====
  async function reload(){
    if(!STATE.maxISO){ return; }
    const sISO = $("#f_de").value || STATE.minISO;
    const eISO = $("#f_ate").value || STATE.maxISO;
    $("#per").textContent = `Período: ${sISO} → ${eISO}`;

    const campos = 'dia,unidade,pedidos,fat,des,fre,"Nome da Loja",turno,"Canal de venda",pagamento,cancelado,hora';

    let q = supa.from(READ_VIEW).select(campos, {count:"exact"}).gte("dia",sISO).lte("dia",eISO).order("dia",{ascending:true}).limit(200000);
    const uni = $("#f_unidade").value; if(uni && uni!=="Todas") q = q.eq("unidade", uni);
    const canc = $("#f_canc").value; if(canc && canc!=="Todos") q = q.eq("cancelado", canc);
    const turnos = Array.from($("#f_turno").selectedOptions).map(o=>o.value); if(turnos.length) q = q.in("turno", turnos);
    const canais = Array.from($("#f_canal").selectedOptions).map(o=>o.value); if(canais.length) q = q.in("Canal de venda", canais);
    const pags   = Array.from($("#f_pag").selectedOptions).map(o=>o.value);   if(pags.length)   q = q.in("pagamento", pags);

    const r = await q;
    if(r.error){ console.error(r.error); paintEmpty(); return; }

    const rows = r.data||[];
    paintKPI(rows);
    paintLine(rows);
    buildTopChips(rows);
  }

  function paintEmpty(){
    ["k_ped","k_tkm","k_fat","k_fmd","k_des","k_desp","k_fre","k_frem","k_fatl","k_fatlp"].forEach(id=>{ $("#"+id).textContent="—"; });
    if(STATE.charts.line){ try{STATE.charts.line.destroy();}catch(e){} STATE.charts.line=null; }
  }

  function paintKPI(rows){
    const ped = rows.reduce((s,r)=>s+Number(r.pedidos||0),0);
    const fat = rows.reduce((s,r)=>s+Number(r.fat||0),0);
    const des = rows.reduce((s,r)=>s+Number(r.des||0),0);
    const fre = rows.reduce((s,r)=>s+Number(r.fre||0),0);
    const dias = new Set(rows.map(r=>r.dia)).size || 1;

    const tkm = ped>0 ? fat/ped : 0;
    const fmd = fat/dias;
    const freM= ped>0 ? fre/ped : 0;
    const fatL= fat-des-fre-(0.12*fat);
    const desP= fat>0 ? (des/fat*100) : 0;
    const fatLP= fat>0 ? (fatL/fat*100) : 0;

    $("#k_ped").textContent = fmtInt(ped);
    $("#k_tkm").textContent = fmtBRL(tkm);
    $("#k_fat").textContent = fmtBRL(fat);
    $("#k_fmd").textContent = fmtBRL(fmd);
    $("#k_des").textContent = fmtBRL(des);
    $("#k_desp").textContent = desP.toFixed(1)+"%";
    $("#k_fre").textContent = fmtBRL(fre);
    $("#k_frem").textContent = fmtBRL(freM);
    $("#k_fatl").textContent = fmtBRL(fatL);
    $("#k_fatlp").textContent = fatLP.toFixed(1)+"%";
  }

  function paintLine(rows){
    const byDay = new Map();
    rows.forEach(r=> byDay.set(r.dia, (byDay.get(r.dia)||0) + Number(r.fat||0)) );
    const labels = Array.from(byDay.keys()).sort();
    const vals = labels.map(k=>byDay.get(k));
    const data = (STATE.lineMode==="media") ? movingAvg(vals,7) : vals;

    if(STATE.charts.line){ try{STATE.charts.line.destroy();}catch(e){} STATE.charts.line=null; }
    const ctx = document.getElementById("cLine").getContext("2d");
    STATE.charts.line = new Chart(ctx, {
      type:"line",
      data:{ labels, datasets:[{ data, borderWidth:2, pointRadius:0, tension:0.25 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
    });

    // switcher
    document.querySelectorAll('.seg-btn[data-target="lineMode"] button').forEach(b=>{
      b.onclick=()=>{ document.querySelectorAll('.seg-btn[data-target="lineMode"] button').forEach(x=>x.classList.remove("active")); b.classList.add("active"); STATE.lineMode=b.dataset.val; paintLine(rows); }
    });
  }

  function buildTopChips(rows){
    const byLoja = {};
    rows.forEach(r=>{ const n=r["Nome da Loja"]; if(!n) return; byLoja[n]=(byLoja[n]||0)+Number(r.fat||0); });
    const top = Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const box=$("#chips"); if(box.childElementCount) return;
    top.forEach(([nome])=>{
      const sp = document.createElement("span");
      sp.className="chip"; sp.textContent=nome; sp.dataset.v=nome;
      sp.onclick=async()=>{ sp.classList.toggle("active"); await reload(); };
      box.appendChild(sp);
    });
  }

  // ==== IMPORT CSV (limpa intervalo e insere) ====
  $("#btnImport").onclick = async ()=>{
    const file = $("#csvfile").files[0];
    const msg = $("#importMsg"); msg.textContent="";
    if(!file){ msg.textContent="Selecione o arquivo."; return; }

    $("#prog").style.display="inline-block"; $("#prog").value=0;

    Papa.parse(file, {
      header:true, skipEmptyLines:true,
      complete: async (res)=>{
        try{
          const raw = res.data||[];
          // Normaliza e detecta mínimo/máximo
          const norm = []; let minD=null, maxD=null;
          for(const row of raw){
            const n = normalizeRow(row);
            if(!n) continue;
            norm.push(n);
            const d = parseISO(n.dia);
            if(!minD || d<minD) minD=d;
            if(!maxD || d>maxD) maxD=d;
          }
          if(norm.length===0){ msg.textContent="Nada para importar (colunas não foram reconhecidas)."; $("#prog").style.display="none"; return; }
          const minISO = toISO(minD), maxISO = toISO(maxD);

          // Limpa intervalo no WRITE_TABLE
          let del = await supa.from(WRITE_TABLE).delete().gte("dia",minISO).lte("dia",maxISO);
          if(del.error){ throw del.error; }

          // Insere em blocos
          const chunk=1500; let done=0;
          for(let i=0;i<norm.length;i+=chunk){
            const slice = norm.slice(i,i+chunk);
            const ins = await supa.from(WRITE_TABLE).insert(slice);
            if(ins.error){ throw ins.error; }
            done += slice.length; $("#prog").value = Math.round(done/norm.length*100);
          }

          $("#prog").style.display="none"; msg.textContent="Importado.";
          await ensureLimits(); await reload();
        }catch(e){
          console.error(e);
          $("#prog").style.display="none";
          msg.textContent = "Erro ao inserir: "+(e.message||e);
        }
      },
      error: (err)=>{ $("#prog").style.display="none"; msg.textContent="Erro no CSV: "+(err.message||err); }
    });
  };

  // Mapeia diferentes cabeçalhos -> schema oficial
  // Aceita: dia/Data, unidade/Unidade, pedidos/Pedidos, fat/Total, des/Desconto, fre/Entrega,
  // "Nome da loja" ou "Nome da Loja", "Canal de venda" ou "Canal de Venda", pagamento/Pagamento, cancelado/Cancelado, hora/Hora
  function normalizeRow(r){
    const pick = (alts)=> {
      for(const k of alts){ if(r[k]!==undefined && r[k]!==null && String(r[k]).trim()!==""){ return r[k]; } }
      return null;
    };

    // dia pode vir como dd/mm/aaaa
    let dia = pick(["dia","Dia","data","Data"]);
    if(!dia) return null;
    if(/^\d{2}\/\d{2}\/\d{4}$/.test(dia)){ // dd/mm/aaaa
      const [dd,mm,yyyy]=dia.split("/"); dia = `${yyyy}-${mm}-${dd}`;
    }

    const unidade = pick(["unidade","Unidade"]);
    const pedidos = Number(pick(["pedidos","Pedidos"]))||0;
    const fat  = Number(pick(["fat","Total"]))||0;
    const des  = Number(pick(["des","Desconto"]))||0;
    const fre  = Number(pick(["fre","Entrega"]))||0;
    const loja = pick(['Nome da Loja','Nome da loja','loja','Loja']);
    const turno= pick(["turno","Turno"]);
    const canal= pick(["Canal de venda","Canal de Venda"]);
    const pag  = pick(["pagamento","Pagamento"]);
    let canc    = pick(["cancelado","Cancelado"]);
    if(canc===null || canc===undefined || canc==="") canc="Não";
    if(String(canc).toLowerCase()==="nao"||String(canc).toLowerCase()==="não") canc="Não";
    if(String(canc).toLowerCase()==="sim") canc="Sim";
    let hora = pick(["hora","Hora"]);
    hora = (hora===""||hora===null||hora===undefined) ? null : Number(hora);

    return {
      dia, unidade, pedidos, fat, des, fre,
      "Nome da Loja": loja || null,
      turno: turno || null,
      "Canal de venda": canal || null,
      pagamento: pag || null,
      cancelado: canc,
      hora
    };
  }

  // Início
  (async function init(){
    const s = await supa.auth.getSession();
    if(s.data?.session){ hideGate(); afterLogin(); } else { showGate(); }
  })();

})();
</script>
</body>
</html>
