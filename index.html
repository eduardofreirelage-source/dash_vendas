<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Produtos & Fichas Técnicas</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">FT</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --wine:#7b1e3a; --ok:#059669; --err:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:28px}
    h3{margin:0 0 12px}
    .status{font-size:13px;margin-left:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active{background:#f1f5f9;font-weight:700}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:14px;}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
    textarea{min-height:80px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.pri{background:var(--wine);color:#fff;border-color:var(--wine)}
    .btn.ghost{background:#f8fafc}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi > span{padding:4px 8px;background:#f8fafc;border:1px solid var(--line);border-radius:8px;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
    th{background:#f8fafc}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .sep{height:1px;background:var(--line);margin:12px 0}
    details.summary-card{border:1px dashed var(--line);border-radius:12px;padding:12px;background:#fcfcfd}
    details > summary{cursor:pointer;font-weight:600;list-style:none}
    details > summary::-webkit-details-marker{display:none}
    .stack{display:flex;flex-direction:column;gap:12px}
    @media (max-width:900px){.cols-2,.cols-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h1>Produtos & Fichas Técnicas</h1>
      <div id="status" class="status">Carregando…</div>
    </div>

    <div class="tabs">
      <button type="button" class="tab active" data-tab="tab-pratos">Pratos</button>
      <button type="button" class="tab" data-tab="tab-prcomp">Componentes do Prato</button>
      <button type="button" class="tab" data-tab="tab-rec">Receitas</button>
      <button type="button" class="tab" data-tab="tab-ing">Ingredientes</button>
    </div>

    <!-- ================= PRATOS ================= -->
    <div class="section" id="tab-pratos">
      <h3>Pratos</h3>

      <div class="grid cols-2">
        <!-- Lista de pratos -->
        <div>
          <div class="grid cols-2">
            <div><input id="prato-search" placeholder="Buscar prato cadastrado"></div>
            <div style="text-align:right"><button class="btn" id="btnNewPrato">+ Novo prato</button></div>
          </div>
          <div style="overflow:auto;margin-top:8px">
            <table id="tblPratos">
              <thead>
                <tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th>Ações</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Editor abaixo -->
          <div class="sep"></div>
          <div class="stack">
            <div class="kpi" id="prato-kpi">
              <span id="kpi-custo">Custo: —</span>
              <span id="kpi-peso">Peso: —</span>
              <span id="kpi-atual">Última alteração: —</span>
            </div>
            <div class="grid cols-3">
              <div><label>Nome</label><input id="pr-nome" placeholder="Ex.: Strogonoff de frango"></div>
              <div><label>Categoria</label>
                <select id="pr-categ">
                  <option value="PRATOS">PRATOS</option>
                  <option value="BEBIDAS">BEBIDAS</option>
                  <option value="SOBREMESA">SOBREMESA</option>
                  <option value="ACOMPANHAMENTOS">ACOMPANHAMENTOS</option>
                  <option value="OUTROS">OUTROS</option>
                </select>
              </div>
              <div><label>Peso do prato</label><input id="pr-peso" inputmode="decimal" placeholder="Ex.: 500 (g/ml)"></div>
            </div>
            <div class="grid cols-3">
              <div><label>Preço de venda (fator ou preço)</label><input id="pr-preco" inputmode="decimal" placeholder="Ex.: 3,2 (fator) ou 34,90 (R$)"></div>
              <div><label>Custo do prato (calculado)</label><input id="pr-custo" disabled></div>
              <div><label>Última alteração</label><input id="pr-upd" disabled></div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn pri" id="btnSavePrato">Salvar</button>
              <button class="btn ghost" id="btnCancelPrato" style="display:none">Cancelar</button>
            </div>
            <div class="hint" id="prato-edit-hint" style="color:#64748b"></div>
          </div>
        </div>

        <!-- Importação do dashboard (colapsável) -->
        <div>
          <details class="summary-card" id="imp-pane">
            <summary>Pratos do Dashboard (clique para expandir/ocultar)</summary>
            <div class="sep"></div>
            <div class="grid cols-3">
              <div>
                <label>Filtrar por categoria (quando existir na fonte)</label>
                <select id="imp-categ">
                  <option value="">Sem categoria</option>
                  <option>PRATOS</option><option>BEBIDAS</option><option>SOBREMESA</option>
                  <option>ACOMPANHAMENTOS</option><option>PROMOÇÕES</option><option>OUTROS</option>
                </select>
              </div>
              <div><label>Buscar no dashboard</label><input id="imp-search" placeholder="Ex.: Strogonoff"></div>
              <div style="align-self:end"><button class="btn" id="btnImpSyncAll">Sincronizar todos que faltam</button></div>
            </div>
            <div class="hint">Fonte: <code>vendas_pratos_pratos</code> (colunas esperadas: <code>prato</code> e opcional <code>categoria</code>)</div>
            <div style="overflow:auto;margin-top:8px">
              <table id="tblImp">
                <thead><tr><th>Prato (dashboard)</th><th>Categoria</th><th>Situação</th><th>Ação</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </details>
        </div>
      </div>
    </div>

    <!-- ================= COMPONENTES DO PRATO ================= -->
    <div class="section" id="tab-prcomp" style="display:none">
      <h3>Componentes do Prato</h3>

      <!-- Seleciona primeiro -->
      <div class="grid cols-3">
        <div><label>Selecione o prato</label><select id="pc-prato"></select></div>
        <div style="align-self:end"><span class="pill">Após selecionar, os componentes aparecem abaixo</span></div>
      </div>

      <div class="sep"></div>

      <!-- Lista de componentes do prato selecionado -->
      <div class="pill" id="pc-title">Componentes — (nenhum prato selecionado)</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tblPc">
          <thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Observações</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Form de adição / edição abaixo, colapsável -->
      <details class="summary-card" id="pc-add-pane" style="margin-top:12px" open>
        <summary>Adicionar nova receita ao prato</summary>
        <div class="grid cols-3" style="margin-top:12px">
          <div><label>Receita</label><select id="pc-rec"></select></div>
          <div><label>Qtd por prato</label><input id="pc-qtd" inputmode="decimal" placeholder="Ex.: 220"></div>
          <div><label>Unidade</label>
            <select id="pc-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
          </div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div><label>Observações</label><input id="pc-obs" placeholder="Opcional"></div>
        </div>
        <div style="margin-top:10px"><button class="btn pri" id="btnPcAdd">Adicionar Receita ao Prato</button></div>
      </details>
    </div>

    <!-- ================= RECEITAS ================= -->
    <div class="section" id="tab-rec" style="display:none">
      <h3>Receitas</h3>

      <!-- Seleciona primeiro -->
      <div class="grid cols-3">
        <div><label>Selecionar receita para editar</label><select id="ri-receita"></select></div>
        <div style="align-self:end"><button class="btn" id="btnRecNew">+ Nova receita</button></div>
      </div>

      <div class="sep"></div>

      <!-- Cabeçalho da receita selecionada -->
      <div class="grid cols-3">
        <div><label>Nome da receita</label><input id="rec-nome" placeholder="Ex.: Arroz Branco pronto"></div>
        <div><label>Rendimento (qtd)</label><input id="rec-rend-qtd" inputmode="decimal" placeholder="Ex.: 1000"></div>
        <div><label>Unidade do rendimento</label>
          <select id="rec-rend-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Perda global (%)</label><input id="rec-perda" inputmode="decimal" value="0"></div>
        <div><label>Observações</label><input id="rec-obs" placeholder="Opcional"></div>
        <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn pri" id="btnRecSave">Salvar alterações</button>
          <button class="btn ghost" id="btnRecCancel" style="display:none">Cancelar</button>
        </div>
      </div>

      <div class="sep"></div>
      <div class="pill">Componentes da receita selecionada</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tblRi">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Adicionar item à receita (abaixo) -->
      <details class="summary-card" style="margin-top:12px">
        <summary>Adicionar novo componente à receita</summary>
        <div class="grid cols-3" style="margin-top:10px">
          <div><label>Tipo</label>
            <select id="draft-tipo"><option value="INGREDIENTE">Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
          </div>
          <div><label>Referência</label><select id="draft-ref"></select></div>
          <div><label>Qtd</label><input id="draft-qtd" inputmode="decimal" placeholder="Ex.: 300"></div>
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <div><label>Unidade</label>
            <select id="draft-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
          </div>
          <div><label>Perda da linha (%)</label><input id="draft-perda" inputmode="decimal" value="0"></div>
          <div style="align-self:end"><button class="btn" id="btnDraftAdd">Adicionar</button></div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="tblDraft">
            <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnDraftClear">Limpar</button>
          <button class="btn pri" id="btnDraftSave">Salvar novos itens</button>
        </div>
      </details>

    </div>

    <!-- ================= INGREDIENTES ================= -->
    <div class="section" id="tab-ing" style="display:none">
      <h3>Ingredientes</h3>

      <div style="overflow:auto">
        <table id="tblIng">
          <thead><tr><th>Nome</th><th>Unidade</th><th>Preço unitário</th><th>Ativo</th><th>Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sep"></div>
      <div class="pill">Cadastrar / Editar ingrediente</div>
      <div class="grid cols-3" style="margin-top:8px">
        <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"></div>
        <div><label>Unidade</label>
          <select id="ing-und"><option value="g">g</option><option value="kg" selected>kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option></select>
        </div>
        <div><label>Preço unitário</label><input id="ing-custo" inputmode="decimal" placeholder="Ex.: 0,0123"></div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div><label>Observações</label><textarea id="ing-obs" placeholder="Opcional"></textarea></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button type="button" id="btnSaveIng" class="btn pri">Salvar</button>
        <button type="button" id="btnCancelIngEdit" class="btn ghost" style="display:none">Cancelar</button>
      </div>
      <div class="hint" id="ing-mode-hint"></div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ========= Supabase ========= */
    const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const DASHBOARD_PRATOS_SOURCE = 'vendas_pratos_pratos'; // prato, categoria (opcional)

    /* ========= Helpers ========= */
    const $ = (id)=> document.getElementById(id);
    const setStatus=(msg,cls)=>{ const el=$('status'); if(!el) return; el.textContent=msg; el.className='status'+(cls?(' '+cls):''); };
    const fmtBR = (n, max=3)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:max}).format(+n || 0);
    const ptToNumber = (v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
    const need = (id, label)=>{ const el=$(id); if(!el) throw new Error('Elemento ausente: #'+id+' ('+label+')'); return el; };

    /* ========= Tabs ========= */
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.tab;
        document.querySelectorAll('.section').forEach(sec=>sec.style.display='none');
        $(id).style.display='block';
      });
    });

    /* ===================================================== *
     *                         PRATOS                        *
     * ===================================================== */
    let pratoEditId = null;

    async function loadPratosList(){
      const tb = $('tblPratos').querySelector('tbody');
      tb.innerHTML = '<tr><td colspan="5">Carregando…</td></tr>';
      const q = supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true});
      const { data, error } = await q;
      if(error){ tb.innerHTML='<tr><td colspan="5">Crie a view v_pratos_resumo</td></tr>'; return; }
      const filtro = $('prato-search').value?.toLowerCase() || '';
      tb.innerHTML='';
      (data||[]).filter(p=>p.nome.toLowerCase().includes(filtro)).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.categoria||'—'}</td>
          <td>${p.receitas ?? 0}</td>
          <td>${p.ativo?'<span class="pill">Ativo</span>':'<span class="pill">Inativo</span>'}</td>
          <td class="row-actions">
            <button class="btn" data-act="edit" data-id="${p.id}">Editar</button>
            <button class="btn" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
            <button class="btn" data-act="del" data-id="${p.id}">Excluir</button>
          </td>`;
        tb.appendChild(tr);
      });
      await fillOptionsFromQuery('pc-prato','pratos','id','nome',{ativo:true});
    }

    function enterPratoEdit(row){
      pratoEditId = row?.id || null;
      $('pr-nome').value = row?.nome || '';
      $('pr-categ').value = row?.categoria || 'PRATOS';
      $('pr-peso').value = row?.peso_prato ?? '';
      $('pr-preco').value = row?.preco_venda ?? '';
      $('pr-custo').value = row?.custo_total!=null ? 'R$ '+fmtBR(row.custo_total,3) : '';
      $('pr-upd').value = row?.updated_at ? new Date(row.updated_at).toLocaleString('pt-BR') : '';
      $('prato-edit-hint').textContent = row ? 'Editando prato #'+row.id : 'Criando novo prato';
      $('btnCancelPrato').style.display = row ? 'inline-flex' : 'none';
      $('kpi-custo').textContent = 'Custo: '+($('pr-custo').value || '—');
      $('kpi-peso').textContent  = 'Peso: '+(($('pr-peso').value)||'—');
      $('kpi-atual').textContent = 'Última alteração: '+(($('pr-upd').value)||'—');
    }
    $('btnNewPrato').addEventListener('click', ()=>enterPratoEdit(null));
    $('btnCancelPrato').addEventListener('click', ()=>enterPratoEdit(null));
    $('prato-search').addEventListener('input', loadPratosList);

    $('tblPratos').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act==='edit'){
        const { data, error } = await supa.from('pratos').select('*').eq('id', id).single();
        if(error){ alert(error.message||error); return; }
        enterPratoEdit(data);
      }else if(act==='toggle'){
        const { data } = await supa.from('pratos').select('ativo').eq('id', id).single();
        const { error } = await supa.from('pratos').update({ ativo: !data.ativo, updated_at: new Date().toISOString() }).eq('id', id);
        if(error){ alert(error.message||error); return; }
        await loadPratosList();
      }else if(act==='del'){
        if(!confirm('Excluir prato?')) return;
        const { error } = await supa.from('pratos').delete().eq('id', id);
        if(error){ alert(error.message||error); return; }
        await loadPratosList();
        enterPratoEdit(null);
      }
    });

    $('btnSavePrato').addEventListener('click', async ()=>{
      const payload = {
        nome: $('pr-nome').value.trim(),
        categoria: $('pr-categ').value,
        peso_prato: ptToNumber($('pr-peso').value),
        preco_venda: ptToNumber($('pr-preco').value),
        updated_at: new Date().toISOString()
      };
      if(!payload.nome){ alert('Informe o nome do prato'); return; }
      let error;
      if(pratoEditId){
        ({ error } = await supa.from('pratos').update(payload).eq('id', pratoEditId));
      }else{
        ({ error } = await supa.from('pratos').insert(payload));
      }
      if(error){ alert(error.message||error); return; }
      setStatus('Prato salvo','ok');
      await loadPratosList();
    });

    // Importação (colapsável)
    async function loadDashPratos(){
      const tb = $('tblImp').querySelector('tbody');
      tb.innerHTML = '<tr><td colspan="4">Carregando…</td></tr>';
      const { data:dash, error } = await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato,categoria').limit(5000);
      if(error){ tb.innerHTML = '<tr><td colspan="4">Não foi possível ler '+DASHBOARD_PRATOS_SOURCE+'</td></tr>'; return; }
      const nomes = Array.from(new Set((dash||[]).map(r=>r.prato).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      const byCat = new Map();
      (dash||[]).forEach(r=>{ const c=(r.categoria||'').toUpperCase()||''; if(!byCat.has(r.prato)) byCat.set(r.prato,c); });
      const { data:pr } = await supa.from('pratos').select('nome');
      const exist = new Set((pr||[]).map(p=>p.nome));
      const filtCat = ($('imp-categ').value||'').toUpperCase();
      const filtro = ($('imp-search').value||'').toLowerCase();

      tb.innerHTML='';
      nomes
       .filter(n=>n.toLowerCase().includes(filtro))
       .filter(n=> !filtCat || (byCat.get(n)||'')===filtCat )
       .forEach(n=>{
        const exists = exist.has(n);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${n}</td>
          <td><span class="pill">${byCat.get(n)||'N/D'}</span></td>
          <td>${exists?'<span class="pill">Já existe</span>':'<span class="pill">Falta importar</span>'}</td>
          <td>${exists?'-':`<button class="btn" data-act="imp-one" data-nome="${n.replace(/"/g,'&quot;')}" data-c="${byCat.get(n)||''}">Importar</button>`}</td>`;
        tb.appendChild(tr);
      });
    }
    $('imp-pane').addEventListener('toggle', (e)=>{ if(e.target.open){ loadDashPratos(); }});
    $('imp-categ').addEventListener('change', loadDashPratos);
    $('imp-search').addEventListener('input', loadDashPratos);
    $('tblImp').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      if(btn.dataset.act==='imp-one'){
        const nome = btn.dataset.nome;
        const categoria = btn.dataset.c || 'PRATOS';
        const { error } = await supa.from('pratos').insert({ nome, categoria });
        if(error && !String(error.message||'').includes('duplicate')){ alert(error.message||error); return; }
        await loadPratosList(); await loadDashPratos();
      }
    });
    $('btnImpSyncAll').addEventListener('click', async ()=>{
      const rows = Array.from($('tblImp').querySelectorAll('button[data-act="imp-one"]'));
      for(const b of rows){
        const nome = b.dataset.nome; const categoria = b.dataset.c || 'PRATOS';
        await supa.from('pratos').insert({ nome, categoria }).catch(()=>{});
      }
      await loadPratosList(); await loadDashPratos();
    });

    /* ===================================================== *
     *                 COMPONENTES DO PRATO                  *
     * ===================================================== */
    async function loadPratoCompList(){
      const prato_id = $('pc-prato').value;
      const tb = $('tblPc').querySelector('tbody');
      const title = $('pc-title');
      tb.innerHTML='';
      if(!prato_id){ title.textContent='Componentes — (nenhum prato selecionado)'; return; }
      // nome do prato
      const { data: p } = await supa.from('pratos').select('nome').eq('id', prato_id).single();
      title.textContent = 'Componentes — '+(p?.nome || '(desconhecido)');
      // lista
      const { data, error } = await supa.from('prato_receitas').select('id, receita_id, qtd, unidade, obs').eq('prato_id', prato_id);
      if(error){ tb.innerHTML='<tr><td colspan="5">Erro ao listar</td></tr>'; return; }
      tb.innerHTML='';
      for(const row of (data||[])){
        const { data: rec } = await supa.from('receitas').select('nome').eq('id', row.receita_id).single();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${rec?.nome || '(receita removida)'}</td>
          <td><input data-k="qtd" data-id="${row.id}" value="${row.qtd}"></td>
          <td>
            <select data-k="unidade" data-id="${row.id}">
              ${['g','kg','ml','L','porcao'].map(u=>`<option value="${u}" ${u===row.unidade?'selected':''}>${u}</option>`).join('')}
            </select>
          </td>
          <td><input data-k="obs" data-id="${row.id}" value="${row.obs||''}"></td>
          <td class="row-actions">
            <button class="btn" data-act="pc-save" data-id="${row.id}">Salvar</button>
            <button class="btn" data-act="pc-del" data-id="${row.id}">Remover</button>
          </td>`;
        tb.appendChild(tr);
      }
    }
    $('pc-prato').addEventListener('change', loadPratoCompList);

    $('tblPc').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act==='pc-del'){
        if(!confirm('Remover receita do prato?')) return;
        const { error } = await supa.from('prato_receitas').delete().eq('id', id);
        if(error){ alert(error.message||error); return; }
        await loadPratoCompList();
      }
      if(act==='pc-save'){
        const cells = Array.from($('tblPc').querySelectorAll(`[data-id="${id}"]`)).reduce((acc,el)=>{ acc[el.dataset.k]=el.value; return acc; },{});
        const payload = { qtd: ptToNumber(cells.qtd), unidade: cells.unidade, obs: cells.obs };
        const { error } = await supa.from('prato_receitas').update(payload).eq('id', id);
        if(error){ alert(error.message||error); return; }
        setStatus('Componente atualizado','ok');
      }
    });

    $('btnPcAdd').addEventListener('click', async ()=>{
      const prato_id = $('pc-prato').value;
      const receita_id = $('pc-rec').value;
      const qtd = ptToNumber($('pc-qtd').value);
      const unidade = $('pc-und').value;
      const obs = $('pc-obs').value.trim() || null;
      if(!prato_id || !receita_id || !qtd){ alert('Selecione prato/receita e informe quantidade'); return; }
      const { error } = await supa.from('prato_receitas').insert({ prato_id, receita_id, qtd, unidade, obs });
      if(error){
        if(!String(error.message||'').includes('duplicate')){ alert(error.message||error); return; }
      }
      $('pc-qtd').value=''; $('pc-obs').value='';
      await loadPratoCompList();
    });

    /* ===================================================== *
     *                       RECEITAS                        *
     * ===================================================== */
    let receitaEditId = null;

    async function fillOptions(selectId, items, valKey, labelKey){
      const sel = $(selectId); if(!sel) return;
      sel.innerHTML='';
      (items||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
    }
    async function fillOptionsFromQuery(selectId, table, valKey, labelKey, whereEq){
      const sel = $(selectId); if(!sel) return;
      let q = supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true});
      if(whereEq){ Object.entries(whereEq).forEach(([k,v]) => q = q.eq(k, v)); }
      const { data } = await q;
      sel.innerHTML='';
      (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
    }

    async function loadReceitasSelect(){
      await fillOptionsFromQuery('ri-receita','receitas','id','nome',{});
      await fillOptionsFromQuery('pc-rec','receitas','id','nome',{ativo:true});
    }

    async function enterReceita(id){
      receitaEditId = id||null;
      if(!id){
        $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs').value='';
        $('tblRi').querySelector('tbody').innerHTML='';
        return;
      }
      const { data, error } = await supa.from('receitas').select('*').eq('id', id).single();
      if(error){ alert(error.message||error); return; }
      $('rec-nome').value = data.nome || '';
      $('rec-rend-qtd').value = data.rendimento_qtd ?? '';
      $('rec-rend-und').value = data.unidade_rendimento || 'g';
      $('rec-perda').value = data.perda_pct ?? '0';
      $('rec-obs').value = data.obs || '';
      await loadReceitaItensTable();
    }

    $('ri-receita').addEventListener('change', ()=>enterReceita($('ri-receita').value));
    $('btnRecNew').addEventListener('click', async ()=>{
      // cria rascunho mínimo
      const nome = prompt('Nome da nova receita:'); if(!nome) return;
      const { data, error } = await supa.from('receitas').insert({ nome, rendimento_qtd:0, unidade_rendimento:'g', perda_pct:0 }).select('id').single();
      if(error){ alert(error.message||error); return; }
      await loadReceitasSelect();
      $('ri-receita').value = data.id;
      enterReceita(data.id);
      setStatus('Receita criada','ok');
    });

    $('btnRecSave').addEventListener('click', async ()=>{
      if(!receitaEditId){ alert('Selecione uma receita'); return; }
      const payload = {
        nome: $('rec-nome').value.trim(),
        rendimento_qtd: ptToNumber($('rec-rend-qtd').value),
        unidade_rendimento: $('rec-rend-und').value,
        perda_pct: ptToNumber($('rec-perda').value),
        obs: $('rec-obs').value.trim() || null
      };
      if(!payload.nome){ alert('Informe o nome'); return; }
      const { error } = await supa.from('receitas').update(payload).eq('id', receitaEditId);
      if(error){ alert(error.message||error); return; }
      await loadReceitasSelect();
      setStatus('Receita salva','ok');
    });

    async function loadReceitaItensTable(){
      const tb = $('tblRi').querySelector('tbody');
      tb.innerHTML='';
      if(!receitaEditId) return;
      const { data, error } = await supa.from('receita_itens').select('*').eq('receita_id', receitaEditId);
      if(error){ tb.innerHTML='<tr><td colspan="6">Erro ao listar itens</td></tr>'; return; }
      for(const it of (data||[]).sort((a,b)=>a.tipo.localeCompare(b.tipo))){
        let nome='—';
        if(it.tipo==='INGREDIENTE'){
          const { data:ing } = await supa.from('ingredientes').select('nome').eq('id', it.ref_id).single();
          nome = ing?.nome || '(ingrediente removido)';
        } else {
          const { data:rec } = await supa.from('receitas').select('nome').eq('id', it.ref_id).single();
          nome = rec?.nome || '(receita removida)';
        }
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.tipo}</td>
          <td>${nome}</td>
          <td><input data-k="qtd" data-id="${it.id}" value="${it.qtd}"></td>
          <td>
            <select data-k="unidade" data-id="${it.id}">
              ${['g','kg','ml','L','un','porcao'].map(u=>`<option value="${u}" ${u===it.unidade?'selected':''}>${u}</option>`).join('')}
            </select>
          </td>
          <td><input data-k="perda_pct" data-id="${it.id}" value="${it.perda_pct||0}"></td>
          <td class="row-actions">
            <button class="btn" data-act="ri-save" data-id="${it.id}">Salvar</button>
            <button class="btn" data-act="ri-del" data-id="${it.id}">Remover</button>
          </td>`;
        tb.appendChild(tr);
      }
    }

    $('tblRi').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act==='ri-del'){
        if(!confirm('Remover componente?')) return;
        const { error } = await supa.from('receita_itens').delete().eq('id', id);
        if(error){ alert(error.message||error); return; }
        await loadReceitaItensTable();
      }
      if(act==='ri-save'){
        const row = Array.from($('tblRi').querySelectorAll(`[data-id="${id}"]`)).reduce((acc,el)=>{ acc[el.dataset.k]=el.value; return acc; },{});
        const payload = { qtd: ptToNumber(row.qtd), unidade: row.unidade, perda_pct: ptToNumber(row.perda_pct) };
        const { error } = await supa.from('receita_itens').update(payload).eq('id', id);
        if(error){ alert(error.message||error); return; }
        setStatus('Linha atualizada','ok');
      }
    });

    // Adição de itens à receita
    async function refreshDraftRefs(){
      const tipo = $('draft-tipo').value;
      if(tipo==='INGREDIENTE'){
        const { data } = await supa.from('ingredientes').select('id,nome').eq('ativo',true).order('nome');
        fillOptions('draft-ref', data, 'id','nome');
      }else{
        const { data } = await supa.from('receitas').select('id,nome').eq('ativo',true).order('nome');
        fillOptions('draft-ref', data, 'id','nome');
      }
    }
    $('draft-tipo').addEventListener('change', refreshDraftRefs);

    let draftItems = [];
    function renderDraft(){
      const tb = $('tblDraft').querySelector('tbody');
      tb.innerHTML='';
      draftItems.forEach((d,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${d.tipo}</td><td>${d.nome}</td><td>${fmtBR(d.qtd)}</td><td>${d.unidade}</td><td>${fmtBR(d.perda_pct)}%</td>
          <td class="row-actions"><button class="btn" data-act="rm" data-idx="${idx}">Remover</button></td>`;
        tb.appendChild(tr);
      });
    }
    $('btnDraftAdd').addEventListener('click', async ()=>{
      if(!receitaEditId){ alert('Selecione uma receita'); return; }
      const tipo = $('draft-tipo').value;
      const ref_id = $('draft-ref').value;
      const qtd = ptToNumber($('draft-qtd').value);
      const unidade = $('draft-und').value;
      const perda_pct = ptToNumber($('draft-perda').value);
      if(!ref_id || !qtd){ alert('Selecione referência e informe quantidade'); return; }
      let nome='';
      if(tipo==='INGREDIENTE'){ const { data } = await supa.from('ingredientes').select('nome').eq('id', ref_id).single(); nome=data?.nome||''; }
      else { const { data } = await supa.from('receitas').select('nome').eq('id', ref_id).single(); nome=data?.nome||''; }
      draftItems.push({ tipo, ref_id, nome, qtd, unidade, perda_pct });
      $('draft-qtd').value=''; $('draft-perda').value='0';
      renderDraft();
    });
    $('tblDraft').addEventListener('click',(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      if(btn.dataset.act==='rm'){ draftItems.splice(+btn.dataset.idx,1); renderDraft(); }
    });
    $('btnDraftClear').addEventListener('click', ()=>{ draftItems=[]; renderDraft(); });
    $('btnDraftSave').addEventListener('click', async ()=>{
      if(!receitaEditId || !draftItems.length) return;
      const payload = draftItems.map(d=>({ receita_id: receitaEditId, tipo:d.tipo, ref_id:d.ref_id, qtd:d.qtd, unidade:d.unidade, perda_pct:d.perda_pct }));
      const { error } = await supa.from('receita_itens').insert(payload);
      if(error){ alert(error.message||error); return; }
      draftItems=[]; renderDraft();
      await loadReceitaItensTable();
      setStatus('Itens adicionados','ok');
    });

    /* ===================================================== *
     *                     INGREDIENTES                      *
     * ===================================================== */
    let ingEditId = null;

    async function loadIngredientes(){
      const tb = $('tblIng').querySelector('tbody');
      tb.innerHTML='<tr><td colspan="5">Carregando…</td></tr>';
      const { data, error } = await supa.from('ingredientes').select('*').order('nome',{ascending:true});
      if(error){ tb.innerHTML='<tr><td colspan="5">Erro ao listar ingredientes</td></tr>'; return; }
      tb.innerHTML='';
      (data||[]).forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${row.nome}</td>
          <td>${row.unidade}</td>
          <td>R$ ${fmtBR(row.custo_unitario)}</td>
          <td>${row.ativo?'<span class="pill">Ativo</span>':'<span class="pill">Inativo</span>'}</td>
          <td class="row-actions">
            <button class="btn" data-act="edit" data-id="${row.id}">Editar</button>
            <button class="btn" data-act="toggle" data-id="${row.id}">${row.ativo?'Desativar':'Ativar'}</button>
            <button class="btn" data-act="del" data-id="${row.id}">Excluir</button>
          </td>`;
        tb.appendChild(tr);
      });
      await loadReceitasSelect(); // refs atualizadas
    }

    function enterIngEdit(row){
      ingEditId=row?.id||null;
      $('ing-nome').value=row?.nome||'';
      $('ing-und').value=row?.unidade||'kg';
      $('ing-custo').value=row?.custo_unitario!=null ? String(row.custo_unitario).replace('.',',') : '';
      $('ing-obs').value=row?.obs||'';
      $('btnCancelIngEdit').style.display = row ? 'inline-flex' : 'none';
      $('ing-mode-hint').textContent = row? ('Editando ingrediente #'+row.id) : '';
    }
    $('btnCancelIngEdit').addEventListener('click', ()=>enterIngEdit(null));

    $('tblIng').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      if(act==='edit'){
        const { data, error } = await supa.from('ingredientes').select('*').eq('id', id).single();
        if(error){ alert(error.message||error); return; }
        enterIngEdit(data);
      }else if(act==='toggle'){
        const { data } = await supa.from('ingredientes').select('ativo').eq('id', id).single();
        const { error } = await supa.from('ingredientes').update({ ativo: !data.ativo }).eq('id', id);
        if(error){ alert(error.message||error); return; }
        await loadIngredientes();
      }else if(act==='del'){
        if(!confirm('Excluir ingrediente?')) return;
        const { error } = await supa.from('ingredientes').delete().eq('id', id);
        if(error){ alert(error.message||error); return; }
        await loadIngredientes();
      }
    });

    $('btnSaveIng').addEventListener('click', async ()=>{
      const payload = {
        nome: $('ing-nome').value.trim(),
        unidade: $('ing-und').value,
        custo_unitario: ptToNumber($('ing-custo').value),
        obs: $('ing-obs').value.trim() || null
      };
      if(!payload.nome){ alert('Informe o nome'); return; }
      let error;
      if(ingEditId){
        ({ error } = await supa.from('ingredientes').update(payload).eq('id', ingEditId));
      }else{
        ({ error } = await supa.from('ingredientes').insert(payload));
      }
      if(error){ alert(error.message||error); return; }
      setStatus('Ingrediente salvo','ok');
      enterIngEdit(null);
      await loadIngredientes();
    });

    /* ================= INIT ================= */
    async function init(){
      try{
        await loadPratosList();
        await loadReceitasSelect();
        await refreshDraftRefs();
        await loadIngredientes();
        setStatus('Pronto','ok');
      }catch(e){ setStatus(e.message,'err'); }
    }
    init();
  });
  </script>
</body>
</html>
