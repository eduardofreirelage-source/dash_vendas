<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Ingest√£o de Vendas ‚Äî Excel ‚Üí Supabase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;line-height:1.4;margin:24px;color:#111}
    h1{margin:0 0 16px}
    fieldset{border:1px solid #ddd;border-radius:8px;padding:16px;margin:0 0 16px}
    legend{font-weight:600}
    label{display:block;margin:6px 0 2px}
    input,select,button,textarea{font:inherit;padding:8px;border:1px solid #bbb;border-radius:6px}
    button{cursor:pointer}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    .ok{color:#0a7f2e}
    .warn{color:#9a6b00}
    .err{color:#b00020;white-space:pre-wrap}
    .muted{color:#666}
    .pill{display:inline-block;background:#f0f2f5;border:1px solid #d9dee3;border-radius:999px;padding:2px 8px;margin:2px 4px 0 0}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(180px,1fr));gap:8px}
    .grid label{margin-top:12px}
    .box{background:#fafbfc;border:1px solid #e6eaef;border-radius:8px;padding:12px}
    #preview{max-height:220px;overflow:auto;border:1px dashed #d0d7de;border-radius:8px;padding:8px;background:#fff}
    table{border-collapse:collapse;width:100%} th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left}
    .badge{background:#eef6ff;color:#0747a6;border:1px solid #d1e4ff;border-radius:999px;padding:2px 8px}
    .small{font-size:12px}
  </style>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Ingest√£o de Vendas (Excel ‚Üí Supabase)</h1>

<fieldset>
  <legend>Conex√£o</legend>
  <div class="row">
    <div class="col">
      <label>Supabase URL</label>
      <input id="sb-url" value="https://uahmcfzerofhzjvlzrqc.supabase.co" />
    </div>
    <div class="col">
      <label>Anon/Public Key</label>
      <input id="sb-key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" />
    </div>
    <div class="col" style="align-self:end">
      <button id="btn-connect">Conectar</button>
      <span id="conn-status" class="muted"></span>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend>Arquivo</legend>
  <div class="row">
    <div class="col">
      <input type="file" id="file" accept=".xlsx,.xls" />
    </div>
    <div class="col" style="align-self:end">
      <button id="btn-validate">Validar</button>
      <button id="btn-save" disabled>Salvar no banco</button>
    </div>
  </div>
  <div id="file-info" class="muted small">Selecione o Excel e clique em <b>Validar</b>.</div>
</fieldset>

<fieldset>
  <legend>Mapeamento de colunas</legend>
  <div class="grid">
    <label>Data+Hora (mesma coluna)</label>
    <select id="map-datahora"></select>

    <label>Data (separada)</label>
    <select id="map-dia"></select>

    <label>Hora (separada)</label>
    <select id="map-hora"></select>

    <label>Unidade</label>
    <select id="map-unidade"></select>

    <label>Loja (NOME DA LOJA)</label>
    <select id="map-loja"></select>

    <label>Canal</label>
    <select id="map-canal"></select>

    <label>Pagamento</label>
    <select id="map-pagamento"></select>

    <label>Cancelado</label>
    <select id="map-cancelado"></select>

    <label>Pedidos / Itens</label>
    <select id="map-pedidos"></select>

    <label>Total</label>
    <select id="map-total"></select>

    <label>Desconto</label>
    <select id="map-desconto"></select>

    <label>Entrega</label>
    <select id="map-entrega"></select>

    <label>Turno</label>
    <select id="map-turno"></select>
  </div>
  <div class="small muted">Se preencher <b>Data+Hora</b>, pode deixar ‚ÄúData‚Äù e ‚ÄúHora‚Äù vazios ‚Äî eu extraio ambos.</div>
</fieldset>

<fieldset>
  <legend>Pr√©via / Diagn√≥stico</legend>
  <div class="row">
    <div class="col box">
      <div><span class="badge">Amostra normalizada</span></div>
      <div id="preview">‚Äî</div>
    </div>
    <div class="col box">
      <div><span class="badge">Distincts</span></div>
      <div id="distincts" class="small">‚Äî</div>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend>Debug</legend>
  <pre id="log" class="small"></pre>
</fieldset>

<script>
const $ = (id)=>document.getElementById(id);
const log = (m, cls)=>{ const el=$('log'); const line=document.createElement('div'); line.textContent=(typeof m==='string'?m:JSON.stringify(m,null,2)); if(cls) line.className=cls; el.appendChild(line); el.scrollTop=el.scrollHeight; };
const set = (id, html)=>{ $(id).innerHTML = html; };
const pad = (n)=> String(n).padStart(2,'0');

let supa = null;
let rawRows = [];
let normRows = [];
let headers = [];

document.addEventListener('DOMContentLoaded', async ()=>{
  // tenta auto conectar
  await connect();
});

$('btn-connect').onclick = connect;

async function connect(){
  try{
    const url = $('sb-url').value.trim();
    const key = $('sb-key').value.trim();
    supa = window.supabase.createClient(url, key);
    // ping simples
    const { data, error } = await supa.from('pg_stat_activity').select('pid').limit(1);
    if(error && !String(error.message||'').includes('permission')) {
      $('conn-status').textContent = 'Falhou: ' + error.message;
      $('conn-status').className = 'err';
      log('Conex√£o falhou: '+error.message,'err');
      return;
    }
    $('conn-status').textContent = 'Conectado ‚úî';
    $('conn-status').className = 'ok';
    log('‚úÖ Supabase client ok','ok');
  }catch(e){
    $('conn-status').textContent='Erro: '+e.message;
    $('conn-status').className='err';
    log(e,'err');
  }
}

// ---------- helpers ----------
function parsePtNumber(v){
  if(v==null || v==='') return 0;
  if(typeof v==='number') return v;
  let s = String(v).trim();
  s = s.replace(/[R$\s]/g,'');
  if(/[0-9]\.[0-9]{3}/.test(s) || /,/.test(s)){
    s = s.replace(/\./g,'').replace(/,/g,'.');
  }
  const n = Number(s);
  return isFinite(n)? n : 0;
}

function normCancel(v){
  if (typeof v === 'boolean') return v ? 'Sim' : 'N√£o';
  const s = String(v || '').toLowerCase().trim();
  if (['sim','s','true','1','yes','y'].includes(s)) return 'Sim';
  if (['n√£o','nao','n','false','0','no'].includes(s)) return 'N√£o';
  return 'N√£o';
}

function parseExcelSerial(n){
  try{
    const o = XLSX.SSF.parse_date_code(n);
    if(!o) return null;
    const d = new Date(Date.UTC(o.y, (o.m||1)-1, o.d||1, o.H||0, o.M||0, Math.floor(o.S||0)));
    return d;
  }catch{ return null; }
}

function parseDateLike(val){
  if(val==null || val==='') return null;
  if(val instanceof Date && !isNaN(val)) return val;
  if(typeof val === 'number') { const d = parseExcelSerial(val); if(d) return d; }
  const s = String(val).trim().replace('T',' ');
  let m = s.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})[ \t]+(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(m){ const [_,Y,Mo,D,h,mi,se] = m; return new Date(Number(Y), Number(Mo)-1, Number(D), Number(h), Number(mi), Number(se||0)); }
  m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})[ \t]+(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(m){ const [_,D,Mo,Y,h,mi,se] = m; return new Date(Number(Y), Number(Mo)-1, Number(D), Number(h), Number(mi), Number(se||0)); }
  m = s.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);
  if(m){ const [_,Y,Mo,D] = m; return new Date(Number(Y), Number(Mo)-1, Number(D), 0, 0, 0); }
  m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(m){ const [_,D,Mo,Y] = m; return new Date(Number(Y), Number(Mo)-1, Number(D), 0, 0, 0); }
  return null;
}
function toYYYYMMDDLocal(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

// ---------- validar ----------
$('btn-validate').onclick = async () => {
  try{
    const f = $('file').files[0];
    if(!f){ alert('Escolha um arquivo .xlsx'); return; }
    $('file-info').textContent = 'Lendo‚Ä¶';
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { cellDates:true, raw:true, dateNF:'yyyy-mm-dd hh:mm:ss' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    rawRows = XLSX.utils.sheet_to_json(ws, { defval:null, raw:true });
    headers = Object.keys(rawRows[0]||{});
    $('file-info').innerHTML = `üìÑ <b>${f.name}</b> ‚Äî ${rawRows.length} linhas | colunas: <span class="muted">${headers.join(', ')||'‚Äî'}</span>`;

    const selects = [
      'map-datahora','map-dia','map-hora','map-unidade','map-loja','map-canal',
      'map-pagamento','map-cancelado','map-pedidos','map-total','map-desconto','map-entrega','map-turno'
    ];
    const fill = (sel, cols)=> sel.innerHTML = '<option value="">‚Äî</option>' + cols.map(c=>`<option>${c}</option>`).join('');
    selects.forEach(id => fill($(id), headers));

    // autosel com ‚ÄúNome da loja‚Äù priorit√°rio
    const prefer = (names)=> headers.find(h => names.some(n => h.toLowerCase()===n));
    const setIf = (id, names)=>{ const hit = prefer(names); if(hit) $(id).value = hit; };

    setIf('map-datahora', ['datahora','data e hora','data hora','data/hora','data_hora','data da venda']);
    setIf('map-dia', ['data','dia','data da venda']);
    setIf('map-hora', ['hora','hr']);
    setIf('map-unidade', ['unidade','unid']);
    setIf('map-loja', ['nome da loja','loja','nome da loja ','nome de loja']);
    setIf('map-canal', ['canal','canal de venda','canal de vendas']);
    setIf('map-pagamento', ['pagamento','pagamento base','pagamento_base','forma de pagamento']);
    setIf('map-cancelado', ['est√° cancelado','esta cancelado','cancelado']);
    setIf('map-pedidos', ['itens','qtd','quantidade','pedidos']);
    setIf('map-total', ['total','valor','valor total']);
    setIf('map-desconto', ['desconto','desc']);
    setIf('map-entrega', ['entrega','frete']);
    setIf('map-turno', ['turno','per√≠odo','periodo']);

    recomputeNormalized();
    $('btn-save').disabled = (normRows.length===0);
  }catch(e){
    log(e,'err');
    alert('Erro ao ler o Excel: '+e.message);
  }
};

function currentMapping(){
  return {
    datahora: $('map-datahora').value || '',
    dia: $('map-dia').value || '',
    hora: $('map-hora').value || '',
    unidade: $('map-unidade').value || '',
    loja: $('map-loja').value || '',
    canal: $('map-canal').value || '',
    pagamento: $('map-pagamento').value || '',
    cancelado: $('map-cancelado').value || '',
    pedidos: $('map-pedidos').value || '',
    total: $('map-total').value || '',
    desconto: $('map-desconto').value || '',
    entrega: $('map-entrega').value || '',
    turno: $('map-turno').value || '',
  };
}

[
  'map-datahora','map-dia','map-hora','map-unidade','map-loja','map-canal',
  'map-pagamento','map-cancelado','map-pedidos','map-total','map-desconto','map-entrega','map-turno'
].forEach(id => $(id).addEventListener('change', recomputeNormalized));

function recomputeNormalized(){
  const map = currentMapping();
  const out = [];
  const dists = { unidade:new Set(), loja:new Set(), canal:new Set(), pagamento_base:new Set(), turno:new Set() };

  for(const r of rawRows){
    let dia=null, hora=null;
    if(map.datahora){
      const v = r[map.datahora];
      const dt = parseDateLike(v);
      if(dt){ dia = toYYYYMMDDLocal(dt); hora = dt.getHours(); }
    } else {
      if(map.dia){
        const vd = r[map.dia];
        const dd = parseDateLike(vd);
        if(dd) dia = toYYYYMMDDLocal(dd);
      }
      if(map.hora){
        const vh = r[map.hora];
        if(vh instanceof Date) hora = vh.getHours();
        else if(typeof vh==='number') hora = Math.max(0, Math.min(23, Math.floor(vh)));
        else if(typeof vh==='string'){ const m = vh.match(/(\d{1,2})/); if(m) hora = Math.max(0, Math.min(23, parseInt(m[1],10))); }
      }
    }
    const unidade = map.unidade ? String(r[map.unidade]??'').trim() : '';
    const loja    = map.loja    ? String(r[map.loja]??'').trim()    : '';
    const canal   = map.canal   ? String(r[map.canal]??'').trim()   : '';
    const pag     = map.pagamento ? String(r[map.pagamento]??'').trim() : '';
    const turno   = map.turno   ? String(r[map.turno]??'').trim()   : '';
    const canc    = normCancel(map.cancelado ? r[map.cancelado] : 'N√£o');
    const ped     = map.pedidos ? (Number(r[map.pedidos])||1) : 1;
    const fat     = map.total ? parsePtNumber(r[map.total]) : 0;
    const des     = map.desconto ? parsePtNumber(r[map.desconto]) : 0;
    const fre     = map.entrega ? parsePtNumber(r[map.entrega]) : 0;

    if(!dia){ continue; }

    const row = {
      dia, hora: (hora==null? null : Number(hora)),
      unidade, loja, canal,
      pagamento_base: pag,
      cancelado: canc,
      pedidos: Number.isFinite(ped)? ped : 1,
      fat, des, fre
    };
    out.push(row);

    if(unidade) dists.unidade.add(unidade);
    if(loja)    dists.loja.add(loja);
    if(canal)   dists.canal.add(canal);
    if(pag)     dists.pagamento_base.add(pag);
    if(turno)   dists.turno.add(turno);
  }

  normRows = out;

  const head = out.slice(0,20);
  if(head.length){
    const cols = Object.keys(head[0]);
    let html = '<table><thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>';
    for(const row of head){ html += '<tr>'+cols.map(c=>`<td>${row[c]??''}</td>`).join('')+'</tr>'; }
    html += '</tbody></table>';
    set('preview', html);
  } else {
    set('preview','‚Äî');
  }

  const counts = {
    linhas: out.length,
    unidades: dists.unidade.size,
    lojas: dists.loja.size,
    canais: dists.canal.size,
    pagamentos: dists.pagamento_base.size
  };
  set('distincts',
    `<div class="pill">linhas: <b>${counts.linhas}</b></div>`+
    `<div class="pill">unidades: <b>${counts.unidades}</b></div>`+
    `<div class="pill">lojas: <b>${counts.lojas}</b></div>`+
    `<div class="pill">canais: <b>${counts.canais}</b></div>`+
    `<div class="pill">pagamentos: <b>${counts.pagamentos}</b></div>`
  );

  $('btn-save').disabled = (normRows.length===0);
}

// ---------- salvar ----------
$('btn-save').onclick = async () => {
  if(!supa){ alert('Conecte no Supabase primeiro.'); return; }
  if(!normRows.length){ alert('Nada para salvar. Valide e confira o mapeamento.'); return; }

  const tableName = 'vendas_import_csv_v2';
  const BATCH = 2000;
  let ok = 0, fail = 0;

  for(let i=0;i<normRows.length;i+=BATCH){
    const slice = normRows.slice(i, i+BATCH);
    const { error } = await supa.from(tableName).insert(slice);
    if(error){
      log({lote: [i, i+slice.length], error}, 'err');
      fail += slice.length;
      if(String(error.message||'').toLowerCase().includes('permission')){
        alert('Permiss√£o negada para inserir em '+tableName+': '+error.message);
        break;
      }
    } else {
      ok += slice.length;
      log(`‚úÖ Lote ${i}-${i+slice.length-1} inserido`, 'ok');
    }
  }
  alert(`Conclu√≠do. OK: ${ok} | Falhas: ${fail}`);
};
</script>
</body>
</html>
