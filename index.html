<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — CFO (v2.5 Light)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%233b82f6"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --ok:#16a34a; --err:#dc2626; --neutral:#64748b;
  }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 6px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
  .badge{display:inline-block;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px;color:#334155}
  .small{font-size:12px}
  .status{font-size:12px;color:var(--muted)}
  /* KPIs */
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .label{font-size:12px;color:#475569}
  .value{display:flex;align-items:baseline;gap:8px}
  .big{font-size:20px;font-weight:800}
  .delta{font-size:12px}
  .up{color:var(--ok)} .down{color:var(--err)} .flat{color:var(--neutral)}
  /* Multiselect */
  .msel{position:relative}
  .msel-btn{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;text-align:left;cursor:pointer}
  .msel-btn:after{content:"▾";float:right;color:#334155}
  .msel-panel{position:absolute;z-index:50;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:8px}
  .msel-opt:hover{background:#f1f5f9}
  pre{white-space:pre-wrap;background:#f8fafc;color:#111827;border-radius:10px;padding:12px;overflow:auto;border:1px solid var(--line)}
  canvas{background:#fff;border:1px solid var(--line);border-radius:12px}
  .link{background:transparent;border:none;color:#334155;text-decoration:underline;cursor:pointer;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Dashboard Vendas — CFO <span class="badge">v2.5 Light</span></h1>

  <div class="card" style="margin-top:12px; position:relative;">
    <div style="position:absolute; right:16px; top:12px;">
      <button id="btnClear" class="link">Limpar filtros</button>
    </div>

    <!-- Linha 1: Unidade · Loja · Turno -->
    <div class="row cols-3">
      <div>
        <label class="label">Unidade(s)</label>
        <div id="ms-unidades" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Loja(s)</label>
        <div id="ms-lojas" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Turno(s)</label>
        <div id="ms-turnos" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
    </div>

    <!-- Linha 2: Datas OU Período rápido -->
    <div class="row cols-2" style="margin-top:10px;">
      <div>
        <label class="label">Período (De / Até)</label>
        <div class="row cols-2">
          <input id="dini" type="date" style="padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff"/>
          <input id="dfim" type="date" style="padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff"/>
        </div>
      </div>
      <div>
        <label class="label">Período Rápido</label>
        <select id="periodo" class="msel-btn" style="border:1px solid var(--line);border-radius:10px;background:#fff;">
          <option value="custom">— usar De/Até —</option>
          <option value="7">Última semana (7d)</option>
          <option value="15">Últimos 15 dias</option>
          <option value="30" selected>Último mês (30d)</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="120">Últimos 120 dias</option>
        </select>
      </div>
    </div>

    <!-- Linha 3: Canal · Pagamento · Cancelado -->
    <div class="row cols-3" style="margin-top:10px;">
      <div>
        <label class="label">Canal(is)</label>
        <div id="ms-canais" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Pagamento(s)</label>
        <div id="ms-pags" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Cancelado</label>
        <div id="ms-cancel" class="msel"><button type="button" class="msel-btn">Não</button><div class="msel-panel"></div></div>
      </div>
    </div>

    <div class="status" id="status"></div>
  </div>

  <!-- RESUMO -->
  <div class="card">
    <b>Quadro Resumo — Linhas filtradas</b>
    <div class="row cols-4" style="margin-top:8px;">
      <div class="box"><div class="label">Brutas</div><div class="value"><div id="q_brutas" class="big">-</div></div></div>
      <div class="box"><div class="label">Canônicas (DISTINCT)</div><div class="value"><div id="q_canon" class="big">-</div></div></div>
      <div class="box"><div class="label">Duplicatas (Brutas−Canon)</div><div class="value"><div id="q_dups" class="big">-</div></div></div>
      <div class="box"><div class="label">% Duplicatas</div><div class="value"><div id="q_perc" class="big">-</div></div></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <b>KPIs (comparados ao período anterior)</b>
    <div class="kpi" style="margin-top:8px;">
      <div class="box">
        <div class="label">Pedidos</div>
        <div class="value"><div id="k_ped" class="big">-</div><span id="d_ped" class="delta flat">—</span></div>
        <div id="p_ped" class="small muted">Anterior: —</div>
      </div>
      <div class="box">
        <div class="label">Ticket Médio (líquido)</div>
        <div class="value"><div id="k_tkt" class="big">-</div><span id="d_tkt" class="delta flat">—</span></div>
        <div id="p_tkt" class="small muted">Anterior: —</div>
      </div>
      <div class="box">
        <div class="label">Faturamento (bruto)</div>
        <div class="value"><div id="k_fat" class="big">-</div><span id="d_fat" class="delta flat">—</span></div>
        <div id="p_fat" class="small muted">Anterior: —</div>
      </div>
      <div class="box">
        <div class="label">Faturamento Médio (por pedido)</div>
        <div class="value"><div id="k_fatmed" class="big">-</div><span id="d_fatmed" class="delta flat">—</span></div>
        <div id="p_fatmed" class="small muted">Anterior: —</div>
      </div>
    </div>

    <div class="kpi" style="margin-top:8px;">
      <div class="box">
        <div class="label">Incentivos (descontos)</div>
        <div class="value"><div id="k_des" class="big">-</div><span id="d_des" class="delta flat">—</span></div>
        <div id="p_des" class="small muted">Anterior: —</div>
      </div>
      <div class="box">
        <div class="label">Incentivos Média (% do faturamento)</div>
        <div class="value"><div id="k_desperc" class="big">-</div><span id="d_desperc" class="delta flat">—</span></div>
        <div id="p_desperc" class="small muted">Anterior: —</div>
      </div>
      <div class="box">
        <div class="label">Frete</div>
        <div class="value"><div id="k_fre" class="big">-</div><span id="d_fre" class="delta flat">—</span></div>
        <div id="p_fre" class="small muted">Anterior: —</div>
      </div>
      <div class="box">
        <div class="label">Frete Médio (por pedido)</div>
        <div class="value"><div id="k_fremed" class="big">-</div><span id="d_fremed" class="delta flat">—</span></div>
        <div id="p_fremed" class="small muted">Anterior: —</div>
      </div>
    </div>
  </div>

  <!-- GRÁFICO -->
  <div class="card">
    <b>Receita por hora</b>
    <canvas id="chartHora" height="220"></canvas>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);

/* ===== UTIL ===== */
const fmt = (n,dec=0)=> (n==null||!isFinite(+n))?'-':(+n).toLocaleString('pt-BR',{minimumFractionDigits:dec,maximumFractionDigits:dec});
const money = (n)=> 'R$ '+fmt(n,2);
function pctDelta(curr, prev){
  if(prev==null || !isFinite(prev) || prev===0) return {txt:'—', cls:'flat'};
  const p = ((curr-prev)/prev)*100;
  const cls   = p>=0 ? 'up' : 'down';
  return {txt:`${p>=0?'↑':'↓'} ${Math.abs(p).toFixed(1)}%`, cls};
}
function setDelta(elId, prevElId, curr, prev, fmtFn=(x)=>fmt(x)){
  const d = pctDelta(curr, prev);
  $(elId).textContent = d.txt; $(elId).className = `delta ${d.cls}`;
  $(prevElId).textContent = `Anterior: ${fmtFn(prev)}`;
}
function setStatus(t){ $('status').textContent=t; }
const debounce=(fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
function dateToISO(d){ return d.toISOString().slice(0,10); }
function addDays(iso, n){ const d = new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }

/* ===== MULTISELECT ===== */
function MultiSelect(rootId, placeholder='Selecionar'){
  const root = $(rootId);
  const btn  = root.querySelector('.msel-btn');
  const panel= root.querySelector('.msel-panel');
  let options = [], selected = new Set(), filtered = [];
  function renderList(){
    panel.innerHTML = '';
    const inp = document.createElement('input'); inp.className='msel-search'; inp.placeholder='Filtrar…';
    inp.addEventListener('input', ()=>{ filtered=options.filter(v=>v.toLowerCase().includes(inp.value.toLowerCase())); draw(); });
    panel.appendChild(inp); draw();
  }
  function draw(){
    Array.from(panel.querySelectorAll('.msel-opt')).forEach(n=>n.remove());
    const list = document.createElement('div');
    (filtered.length?filtered:options).forEach((v,i)=>{
      const id = `${rootId}-${i}`;
      const row = document.createElement('div'); row.className='msel-opt';
      const cb  = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v; cb.checked=selected.has(v);
      const lb  = document.createElement('label'); lb.htmlFor=id; lb.textContent=v;
      cb.addEventListener('change', ()=>{ cb.checked?selected.add(v):selected.delete(v); refreshBtn(); scheduleApply(); saveState(); });
      row.appendChild(cb); row.appendChild(lb); list.appendChild(row);
    });
    panel.appendChild(list);
  }
  function refreshBtn(){
    if(selected.size===0) btn.textContent = placeholder;
    else if(selected.size===options.length) btn.textContent = `Todos (${selected.size})`;
    else btn.textContent = `${selected.size} selecionado(s)`;
  }
  btn.addEventListener('click', ()=>{ root.classList.toggle('open'); });
  document.addEventListener('click', (ev)=>{ if(!root.contains(ev.target)) root.classList.remove('open'); });
  return {
    setOptions(list, preselected){
      options = (list||[]).filter(Boolean).map(v=>String(v));
      options = Array.from(new Set(options)).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      filtered = options.slice();
      selected = new Set(preselected||[]);
      renderList(); refreshBtn();
    },
    get(){ return Array.from(selected); },
    set(vals){ selected = new Set(vals||[]); refreshBtn(); draw(); }
  };
}

/* ===== ESTADO / FILTROS ===== */
const ms = {
  unidades: MultiSelect('ms-unidades','Todas as unidades'),
  lojas:    MultiSelect('ms-lojas','Todas as lojas'),
  turnos:   MultiSelect('ms-turnos','Todos os turnos'),
  canais:   MultiSelect('ms-canais','Todos os canais'),
  pags:     MultiSelect('ms-pags','Todos os pagamentos'),
  cancel:   MultiSelect('ms-cancel','Não')
};
let lastDay='', firstDay='';
const STORAGE_KEY='cfo_light_v25';

function saveState(){
  const S = {
    periodo: $('periodo').value,
    dini: $('dini').value, dfim:$('dfim').value,
    unids: ms.unidades.get(), lojas: ms.lojas.get(), turnos: ms.turnos.get(),
    canais: ms.canais.get(), pags: ms.pags.get(), cancel: ms.cancel.get()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(S));
}
function loadState(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); }catch{ return null; }
}
function clearFilters(){
  $('periodo').value='30'; $('dini').value=''; $('dfim').value='';
  ms.unidades.set([]); ms.lojas.set([]); ms.turnos.set([]);
  ms.canais.set([]); ms.pags.set([]); ms.cancel.set(['Não']);
  saveState(); scheduleApply();
}

/* ===== OPTIONS + PERIOD ===== */
async function loadOptionsAndPeriod(){
  setStatus('Carregando…');
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(!dr.error && dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; } else { lastDay=dateToISO(new Date()); }

  // unidades, canais, pagamentos (views já existentes)
  const u = await supa.from('vw_vendas_unidades').select('unidade');
  const c = await supa.from('vw_vendas_canais').select('canal');
  const p = await supa.from('vw_vendas_pagamentos').select('pagamento_base');

  // lojas e turnos diretamente da base canônica (evita 404 de views opcionais)
  const lojasRes = await supa.from('vendas_canon').select('loja').neq('loja',null).limit(100000);
  const turnRes  = await supa.from('vendas_canon').select('turno').neq('turno',null).limit(100000);
  const lojas = Array.from(new Set((lojasRes.data||[]).map(r=>r.loja))).sort((a,b)=>a?.localeCompare(b||'','pt-BR'));
  const turnos = Array.from(new Set((turnRes.data||[]).map(r=>r.turno))).sort((a,b)=>a?.localeCompare(b||'','pt-BR'));

  ms.unidades.setOptions((u.data||[]).map(r=>r.unidade));
  ms.canais.setOptions((c.data||[]).map(r=>r.canal));
  ms.pags.setOptions((p.data||[]).map(r=>r.pagamento_base));
  ms.lojas.setOptions(lojas);
  ms.turnos.setOptions(turnos);
  ms.cancel.setOptions(['Não','Sim','Todos'], ['Não']);

  const S = loadState();
  if(S){
    $('periodo').value = S.periodo || '30';
    $('dini').value = S.dini||''; $('dfim').value=S.dfim||'';
    ms.unidades.set(S.unids||[]); ms.lojas.set(S.lojas||[]); ms.turnos.set(S.turnos||[]);
    ms.canais.set(S.canais||[]); ms.pags.set(S.pags||[]); ms.cancel.set(S.cancel||['Não']);
  }
  setStatus('');
}

/* ===== DATAS ===== */
function rangeFromPeriodo(){
  const val = $('periodo').value;
  if(val==='custom'){
    let dini=$('dini').value, dfim=$('dfim').value;
    if(!dfim) dfim = lastDay||dateToISO(new Date());
    if(!dini){ dini = addDays(dfim, -29); }
    return {dini, dfim, n: (new Date(dfim)-new Date(dini))/86400000 + 1};
  }else{
    const n = parseInt(val,10)||30;
    const dfim = lastDay||dateToISO(new Date());
    let dini = addDays(dfim, -(n-1)); if(firstDay && dini<firstDay) dini=firstDay;
    $('dini').value=''; $('dfim').value='';
    return {dini, dfim, n};
  }
}
function rangePrev(dini, n){
  const dfimPrev = addDays(dini, -1);
  const diniPrev = addDays(dfimPrev, -(n-1));
  return {dini:diniPrev, dfim:dfimPrev};
}

/* ===== BUILD FILTERS ===== */
function applyCommonFilters(q, isCanon){
  const {dini, dfim} = rangeFromPeriodo();
  q = q.gte('dia', dini).lte('dia', dfim);
  const unids = ms.unidades.get(); if(unids.length) q = q.in('unidade', unids);
  const lojas = ms.lojas.get();
  if(lojas.length){
    q = isCanon ? q.in('loja', lojas) : q.in('Nome da loja', lojas);
  }
  const turnos = ms.turnos.get(); if(turnos.length) q = q.in('turno', turnos);
  const canais = ms.canais.get();
  if(canais.length){
    q = isCanon ? q.in('canal', canais) : q.in('Canal de venda', canais);
  }
  const pags = ms.pags.get(); if(pags.length) q = q.in('pagamento_base', pags);
  const canc = ms.cancel.get();
  if(!canc.includes('Todos')) q = q.eq('cancelado', canc[0]||'Não');
  return q;
}

/* ===== RESUMO + KPIs (sem RPC) ===== */
async function fetchResumoSemRPC(){
  // brutas (vendas_xlsx)
  let qx = supa.from('vendas_xlsx').select('*', {count:'exact', head:true});
  qx = applyCommonFilters(qx, false);
  const brutas = (await qx).count || 0;

  // canônicas (vendas_canon)
  let qc = supa.from('vendas_canon').select('*', {count:'exact', head:true});
  qc = applyCommonFilters(qc, true);
  const canon = (await qc).count || 0;

  const dups = Math.max(0, brutas - canon);
  const perc = (brutas>0)? ((dups/brutas)*100) : null;
  return { brutas, canon, dups, perc };
}

async function fetchKPIsSemRPC(dini, dfim){
  // atual
  let qa = supa.from('vendas_canon');
  qa = applyCommonFilters(qa, true);
  const nowAgg = await qa.select('ped_sum:pedidos.sum(), fat_sum:fat.sum(), des_sum:des.sum(), fre_sum:fre.sum()').single();
  const ped = +((nowAgg.data||{}).ped_sum||0), fat=+((nowAgg.data||{}).fat_sum||0), des=+((nowAgg.data||{}).des_sum||0), fre=+((nowAgg.data||{}).fre_sum||0);

  // anterior
  const R = rangeFromPeriodo();
  const P = rangePrev(R.dini, R.n);
  let qb = supa.from('vendas_canon').gte('dia', P.dini).lte('dia', P.dfim);
  qb = applyCommonFilters(qb, true); // aplica mesmos filtros (unid/loja/…)
  const prevAgg = await qb.select('ped_sum:pedidos.sum(), fat_sum:fat.sum(), des_sum:des.sum(), fre_sum:fre.sum()').single();
  const p_ped=+((prevAgg.data||{}).ped_sum||0), p_fat=+((prevAgg.data||{}).fat_sum||0), p_des=+((prevAgg.data||{}).des_sum||0), p_fre=+((prevAgg.data||{}).fre_sum||0);

  return { ped,fat,des,fre, p_ped,p_fat,p_des,p_fre };
}

/* ===== CHART ===== */
let chartHora=null;
async function renderHora(dini, dfim){
  try{
    if(chartHora){ chartHora.destroy(); chartHora=null; }
    // tenta RPC (se existir, ótimo; senão, silenciosamente fica vazio)
    const r = await supa.rpc('kpi_vendas_hora', buildParams(dini, dfim));
    if(r.error) return;
    const rows = (r.data||[]).sort((a,b)=>(+a.hora)-(+b.hora));
    const labels = rows.map(x=> String(x.hora).padStart(2,'0')+':00');
    const valores = rows.map(x=> +x.fat || 0);
    const ctx = $('chartHora').getContext('2d');
    chartHora = new Chart(ctx, {
      type:'bar',
      data:{labels, datasets:[{label:'Receita (R$)', data: valores}]},
      options:{responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
    });
  }catch{ /* silencioso */ }
}

/* ===== PARAMS PARA RPC (se houver) ===== */
function buildParams(dini, dfim){
  const canc = ms.cancel.get();
  const p_cancelado = canc.includes('Todos') ? null : (canc[0]||'Não');
  return {
    p_dini: dini, p_dfim: dfim,
    p_unids: ms.unidades.get().length ? ms.unidades.get() : null,
    p_canais: ms.canais.get().length   ? ms.canais.get()   : null,
    p_pags: ms.pags.get().length       ? ms.pags.get()     : null,
    p_loja: ms.lojas.get().length      ? ms.lojas.get()    : null,
    p_turnos: ms.turnos.get().length   ? ms.turnos.get()   : null,
    p_cancelado
  };
}

/* ===== APLICAÇÃO ===== */
const scheduleApply = debounce(applyAll, 250);

async function applyAll(){
  try{
    setStatus('Atualizando…');
    const {dini, dfim, n} = rangeFromPeriodo();
    const prev = rangePrev(dini, n);

    // RESUMO
    const R = await fetchResumoSemRPC();
    $('q_brutas').textContent = fmt(R.brutas);
    $('q_canon').textContent  = fmt(R.canon);
    $('q_dups').textContent   = fmt(R.dups);
    $('q_perc').textContent   = (R.perc==null? '-' : (Number(R.perc).toFixed(2)+' %'));

    // KPIs
    const K = await fetchKPIsSemRPC(dini, dfim);
    const tkt_liq = K.ped>0 ? ((K.fat-K.des-K.fre)/K.ped) : 0;
    const fat_med = K.ped>0 ? (K.fat/K.ped) : 0;
    const des_perc = K.fat>0 ? (K.des/K.fat*100) : 0;
    const fre_med = K.ped>0 ? (K.fre/K.ped) : 0;

    const p_tkt_liq = K.p_ped>0 ? ((K.p_fat-K.p_des-K.p_fre)/K.p_ped) : 0;
    const p_fat_med = K.p_ped>0 ? (K.p_fat/K.p_ped) : 0;
    const p_des_perc = K.p_fat>0 ? (K.p_des/K.p_fat*100) : 0;
    const p_fre_med = K.p_ped>0 ? (K.p_fre/K.p_ped) : 0;

    $('k_ped').textContent = fmt(K.ped);      setDelta('d_ped','p_ped', K.ped, K.p_ped, fmt);
    $('k_tkt').textContent = money(tkt_liq);  setDelta('d_tkt','p_tkt', tkt_liq, p_tkt_liq, money);
    $('k_fat').textContent = money(K.fat);    setDelta('d_fat','p_fat', K.fat, K.p_fat, money);
    $('k_fatmed').textContent = money(fat_med); setDelta('d_fatmed','p_fatmed', fat_med, p_fat_med, money);

    $('k_des').textContent = money(K.des);    setDelta('d_des','p_des', K.des, K.p_des, money);
    $('k_desperc').textContent = fmt(des_perc,1)+'%'; setDelta('d_desperc','p_desperc', des_perc, p_des_perc, (x)=>fmt(x,1)+'%');
    $('k_fre').textContent = money(K.fre);    setDelta('d_fre','p_fre', K.fre, K.p_fre, money);
    $('k_fremed').textContent = money(fre_med); setDelta('d_fremed','p_fremed', fre_med, p_fre_med, money);

    // GRÁFICO (silencioso se RPC não existir)
    renderHora(dini, dfim);

    setStatus('');
  }catch(e){
    console.error(e);
    setStatus(''); // silencioso
  }
}

/* ===== LISTENERS ===== */
$('periodo').addEventListener('change', ()=>{ scheduleApply(); saveState(); });
$('dini').addEventListener('change', ()=>{ $('periodo').value='custom'; scheduleApply(); saveState(); });
$('dfim').addEventListener('change', ()=>{ $('periodo').value='custom'; scheduleApply(); saveState(); });
$('btnClear').addEventListener('click', clearFilters);

/* ===== INIT ===== */
(async function init(){
  await loadOptionsAndPeriod();
  scheduleApply();
})();
</script>
</body>
</html>
