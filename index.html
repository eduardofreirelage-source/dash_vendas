<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Maestro Food — Importador & Healthcheck</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#667085;--card:#fff;--brd:#e5e7eb;--accent:#1a73e8}
    body{background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:14px;margin-top:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button{font:inherit;padding:10px 12px;border:1px solid var(--brd);border-radius:10px}
    button{background:var(--accent);border-color:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:#eef2ff;border-color:var(--brd);color:#1747b7}
    pre{background:#0b1020;color:#cde5ff;padding:10px;border-radius:10px;overflow:auto}
    progress{height:10px;width:220px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    code.bad{color:#b91c1c}
    code.ok{color:#16a34a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Maestro Food — Importador CSV (linha-a-linha)</h1>
    <div class="muted">Tabela: <code>public.vendas_kpi_daily_v2_data</code> · Dedup: <code>row_key</code> (hash por linha)</div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Healthcheck</b>
        <button id="btnCheck" class="ghost">Consultar</button>
      </div>
      <div id="hc">—</div>
      <pre id="hcJson" style="display:none"></pre>
    </div>

    <div class="card">
      <b>Importar CSV</b>
      <div class="row" style="margin-top:8px">
        <input id="csv" type="file" accept=".csv,text/csv"/>
        <button id="btnImport">Importar</button>
        <progress id="prog" value="0" max="100" style="display:none"></progress>
      </div>
      <div id="msg" class="muted" style="margin-top:8px">Selecione seu <b>Pasta2.csv</b>. Mínimo: <code>dia</code>/<code>unidade</code>/<code>fat</code> (nomes podem variar; faço mapeamento).</div>
      <pre id="log" style="display:none"></pre>
    </div>
  </div>

  <!-- libs primeiro -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

  <script>
  (function(){
    // ===== Config =====
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const TABLE = "vendas_kpi_daily_v2_data";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ===== DOM =====
    const el = id => document.getElementById(id);
    const btnCheck = el('btnCheck'), hc = el('hc'), hcJson=el('hcJson');
    const csv = el('csv'), btnImport = el('btnImport'), prog = el('prog'), msg = el('msg'), log = el('log');

    // ===== Utils =====
    const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const onlyDate = iso => (iso && String(iso).length>=10)? String(iso).slice(0,10) : iso;
    const norm = s => String(s ?? "").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
    const parseBR = x => {
      if (x==null||x==='') return 0;
      if (typeof x==='number') return x;
      const s = String(x).trim().replace(/\./g,'').replace(',','.');
      const n = Number(s); return isFinite(n)? n : 0;
    };
    function ddmmyyyyToISO(s){
      if(!s) return null;
      const str = String(s).trim();
      const [datePart] = str.split(' ');
      const [d,m,y] = (datePart||'').split('/');
      const day=+d, mon=+m, yr=+y;
      if(!day||!mon||!yr||day<1||day>31||mon<1||mon>12||yr<1900||yr>2100) return null;
      const iso = `${yr.toString().padStart(4,'0')}-${mon.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      const test = new Date(iso); if (isNaN(test)) return null;
      return iso;
    }
    function pickHour(s){
      const str = String(s??'');
      const parts = str.split(' ');
      if (parts[1] && parts[1].includes(':')) {
        const h = parseInt(parts[1].split(':')[0],10);
        return isFinite(h)? h : -1;
      }
      return -1;
    }
    // Hash simples (djb2)
    function hashStr(str){
      let h = 5381; for (let i=0;i<str.length;i++) h = ((h<<5)+h) + str.charCodeAt(i);
      return String(h >>> 0); // uint32
    }
    function makeRowKey(r){
      // inclui valores monetários para diferenciar pedidos distintos no mesmo minuto/canal/etc.
      const key = [
        r.dia, r.unidade, r["Nome da loja"]||"", r.hora,
        r.pagamento||"", r["Canal de venda"]||"",
        (Number(r.fat)||0).toFixed(2),
        (Number(r.des)||0).toFixed(2),
        (Number(r.fre)||0).toFixed(2)
      ].join('|');
      return hashStr(key);
    }
    function mapHeader(h){
      const k = norm(h);
      const cand = [
        {std:'dia', list:['dia','data','data da venda','data de venda','data_venda','datadavenda']},
        {std:'unidade', list:['unidade','filial','unidades','uni']},
        {std:'pedidos', list:['pedidos','pedido','qtd','qtde','quantidade']},
        {std:'fat', list:['fat','faturamento','total','valor total','valor','total geral']},
        {std:'des', list:['des','desconto']},
        {std:'fre', list:['fre','frete','entrega']},
        {std:'turno', list:['turno']},
        {std:'Nome da loja', list:['nome da loja','nome loja','loja','nomedaloja','nome_da_loja']},
        {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda']},
        {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento']},
        {std:'cancelado', list:['esta cancelado','está cancelado','cancelado','cancelada']},
        {std:'hora', list:['hora','horario','horário','hora da venda']},
      ];
      for (const c of cand) if (c.list.includes(k)) return c.std;
      return h;
    }
    function setHC(text, json){
      hc.innerHTML = text;
      if (json) { hcJson.style.display='block'; hcJson.textContent = JSON.stringify(json, null, 2); }
      else { hcJson.style.display='none'; }
    }

    // ===== Healthcheck =====
    async function healthcheck(){
      try{
        const min = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
        const max = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
        const cnt = await supa.from(TABLE).select('dia', { count:'exact', head:true });
        const minISO = (min.data && min.data[0]) ? onlyDate(min.data[0].dia) : null;
        const maxISO = (max.data && max.data[0]) ? onlyDate(max.data[0].dia) : null;
        const total  = (cnt && Number.isFinite(cnt.count)) ? cnt.count : null;

        setHC(
          `Tabela: <b>${TABLE}</b><br/>Intervalo no banco: <b>${minISO||'—'}</b> → <b>${maxISO||'—'}</b><br/>Total (count exato): <b>${total??'—'}</b>`,
          {min:min.data, max:max.data, count: cnt.count}
        );
      }catch(e){
        setHC(`<span class="bad">Healthcheck falhou</span>`, {error:String(e)});
      }
    }

    // ===== Import =====
    btnImport.addEventListener('click', async ()=>{
      const file = csv.files?.[0];
      if(!file){ msg.innerHTML = '<code class="bad">Selecione um CSV.</code>'; return; }

      msg.textContent = 'Lendo arquivo…'; log.style.display='block'; log.textContent=''; prog.style.display='inline-block'; prog.value=0;

      Papa.parse(file, {
        header:true, skipEmptyLines:'greedy', transformHeader: mapHeader,
        complete: async (res)=>{
          try{
            const raw = res.data || [];
            if (!raw.length){ msg.innerHTML = '<code class="bad">CSV vazio.</code>'; prog.style.display='none'; return; }

            // Detecta headers presentes pós-mapeamento
            const headers = Object.keys(raw[0]||{});
            const hasDia = headers.includes('dia') || headers.some(h=> norm(h).includes('data'));
            const hasUni = headers.includes('unidade');
            const hasFat = headers.includes('fat') || headers.includes('Total');

            if(!hasDia || !hasUni || !hasFat){
              msg.innerHTML = '<code class="bad">Colunas obrigatórias não reconhecidas: dia/unidade/fat</code>';
              prog.style.display='none'; return;
            }

            // Normaliza linhas: 1 linha = 1 pedido
            const rows = [];
            let invalid = 0;

            for (let i=0;i<raw.length;i++){
              const r = raw[i];

              // dia
              let diaV = r.dia ?? r['Data da venda'] ?? r['data'] ?? r['Data'];
              let diaISO = null;
              if (diaV){
                diaISO = String(diaV).includes('/') ? ddmmyyyyToISO(diaV) : onlyDate(new Date(diaV).toISOString());
              }
              if (!diaISO){ invalid++; continue; }

              // monetários
              const fat = parseBR(r.fat ?? r.Total ?? 0);
              if (!isFinite(fat)) { invalid++; continue; }

              const des = parseBR(r.des ?? r['Desconto'] ?? 0);
              const fre = parseBR(r.fre ?? r['Entrega']  ?? r['Frete'] ?? 0);

              const unidade = String(r.unidade ?? r.Unidade ?? '').trim();
              if (!unidade){ invalid++; continue; }

              const loja = r['Nome da loja'] ?? r['nome da loja'] ?? r.Loja ?? null;
              const canal = r['Canal de venda'] ?? r['canal de venda'] ?? r.Canal ?? null;
              const pagamento = r['pagamento'] ?? r['Pagamento'] ?? null;

              let hora = -1;
              if ('hora' in r) hora = parseInt(r.hora,10); else hora = pickHour(r['Data da venda']);
              if (!isFinite(hora)) hora = -1;

              const cancelado = (()=>{
                const s = norm(r.cancelado ?? r['Está cancelado'] ?? '');
                return (s==='sim'||s==='s'||s==='true'||s==='1') ? 'Sim' : 'Não';
              })();

              const row = {
                dia: diaISO,
                unidade,
                pedidos: 1,
                fat, des, fre,
                turno: r.turno ?? r.Turno ?? null,
                "Canal de venda": canal,
                pagamento,
                "Nome da loja": loja,
                cancelado,
                hora
              };
              row.row_key = makeRowKey(row);
              rows.push(row);
            }

            if (!rows.length){
              msg.innerHTML = '<code class="bad">Nada para importar (linhas inválidas).</code>';
              prog.style.display='none'; return;
            }

            // Dedup DENTRO do próprio arquivo (mesmo row_key em lotes grandes)
            const seen = new Set();
            const clean = [];
            for (const r of rows){
              if (seen.has(r.row_key)) continue;
              seen.add(r.row_key);
              clean.push(r);
            }

            // Upsert por lotes
            msg.innerHTML = `Processadas ${rows.length.toLocaleString('pt-BR')} linhas (${invalid} inválidas). Enviando…`;
            const chunk = 5000;
            for (let i=0;i<clean.length;i+=chunk){
              const part = clean.slice(i, i+chunk);
              const { error } = await supa.from(TABLE).upsert(part, { onConflict: 'row_key' });
              if (error){ console.error(error); msg.innerHTML = `<code class="bad">Erro no lote ${i/chunk+1}: ${error.message||error}</code>`; prog.style.display='none'; return; }
              prog.value = Math.round((i+part.length)/clean.length*100);
            }

            prog.style.display='none';
            msg.innerHTML = `<code class="ok">Importado com sucesso.</code>`;

            await healthcheck();
          }catch(err){
            console.error(err);
            msg.innerHTML = `<code class="bad">Falha ao importar: ${err.message||err}</code>`;
            prog.style.display='none';
          }
        },
        error: (e)=>{ msg.innerHTML = `<code class="bad">Erro ao ler CSV: ${e.message||e}</code>`; prog.style.display='none'; }
      });
    });

    btnCheck.addEventListener('click', healthcheck);

    // auto-check ao abrir
    healthcheck();
  })();
  </script>
</body>
</html>
