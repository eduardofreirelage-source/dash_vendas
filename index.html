<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DASHBOARD — CFO (v2.20.1 — KPI clicável + bugfix REST 400 + canvas nítido)</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%232f6ef7"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#2f6ef7;
      --ok:#10b981; --down:#ef4444;
      --chip:#f7e9ed;
      --bar:#334155;
      --wine:#7b1e3a;
      --wine-soft:#9c3554;

      --c-now:#7b1e3a;
      --c-now-soft:#9c3554;
      --c-prev:#94a3b8;
      --c-prev-soft:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.clear{gap:6px}

    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;transition:max-height .25s ease}
    .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
    .sec-title{display:flex;align-items:center;gap:10px;font-weight:700}
    .ico{width:16px;height:16px;color:#475569}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}

    input[type="date"], .msel-btn, .input{
      width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff;
      min-height:44px;font-size:16px;
    }
    input[type="date"]::-webkit-calendar-picker-indicator{ transform:scale(1.2); }

    .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    .chip{padding:10px 0;border:1px solid #efd5db;border-radius:10px;background:var(--chip);cursor:pointer;text-align:center;font-weight:800;color:#7b1e3a}
    .chip.active{background:var(--c-now);border-color:var(--c-now);color:#fff;box-shadow:0 1px 0 rgba(123,30,58,.06)}

    .msel{position:relative}
    .msel-btn{cursor:pointer;text-align:left}
    .msel-btn:after{content:"▾";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
    .msel-opt:hover{background:#f3f4f6}

    .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{
      position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;
      padding:12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05);cursor:pointer;
      transition:border-color .15s ease, box-shadow .15s ease, transform .02s ease;
    }
    .kpi:active{ transform:scale(.995); }
    .kpi.active{ border-color:var(--c-now); box-shadow:0 0 0 4px rgba(123,30,58,.06); }
    .kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
    .kpi h4 .spacer{flex:1}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .accent{height:2px;background:var(--wine);border-radius:999px;margin:6px 0 6px 0;opacity:.95}
    .kpi .sub{font-size:12px;color:#667085;margin-top:2px}
    .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:12px;margin-left:12px;background:rgba(148,163,184,.15);color:#64748b}
    .delta svg{width:12px;height:12px}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .delta.down{background:rgba(148,163,184,.15);border-color:rgba(148,163,184,.35);color:#64748b}
    .delta.flat{background:#f1f5f9;border-color:#e2e8f0;color:#64748b}

    .chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
    .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:800}
    .seg button.active{background:var(--c-now);color:#fff}
    .chart-box{height:280px;position:relative}
    /* >>> Fix nitidez: deixe o Chart.js controlar o backstore (sem !important) */
    .chart-box canvas{display:block;width:100%;height:100%;}
    .chart-card.wide{grid-column:span 2;}
    .chart-card.wide .chart-box{height:360px}

    .center-link{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      background:rgba(255,255,255,.92);border:1px solid var(--line);
      padding:4px 10px;border-radius:999px;cursor:pointer;
      font-weight:800;font-size:12px;color:#334155;white-space:nowrap;
    }

    .section.collapsed .row,
    .section.collapsed #periodoInfo,
    .section.collapsed .upload-info { display:none; }
    .section.collapsed .sec-head{cursor:pointer}

    .diag{font-size:12px;color:#475569;margin-left:8px}
    .upload-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .upload-info{margin-top:8px;font-size:12px;color:#475569}

    @media (max-width:1024px){
      .cols-3{grid-template-columns:repeat(2,1fr)}
      .cols-2{grid-template-columns:1fr}
      .krow{grid-template-columns:repeat(2,1fr)}
      .chart-card.wide{grid-column:span 1;}
    }
    @media (max-width:640px){
      .cols-3{grid-template-columns:1fr}
      .krow{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>DASHBOARD</h1>
      <div class="upload-bar">
        <button id="btnUpload" class="btn">📤 Carregar Excel</button>
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
      </div>
    </div>

    <!-- (restante do HTML é idêntico ao que você já tem; mantendo para versão completa) -->
    <!-- Filtros de Data -->
    <!-- ... (igual à sua versão anterior v2.20.0) ... -->

    <!-- Filtros -->
    <!-- ... (igual) ... -->

    <!-- KPIs (clicáveis) -->
    <!-- ... (igual ao arquivo que te passei) ... -->

    <!-- GRÁFICOS -->
    <!-- ... (igual) ... -->

  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

  <script>
  /* ===================== CONFIG ===================== */
  const READ_VIEW        = 'vendas_canon';
  const DEST_INSERT_TABLE= 'vendas_xlsx';
  const REFRESH_RPC      = 'refresh_sales_materialized';

  const SUPABASE_URL  = 'https://msmyfxgrnuusnvoqyeuo.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ============ Chart.js — nitidez e tema ============ */
  Chart.defaults.font.family = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu';
  Chart.defaults.color = '#334155';
  Chart.defaults.plugins.legend.position = 'top';
  Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.95)';
  Chart.defaults.plugins.tooltip.titleColor = '#e2e8f0';
  Chart.defaults.plugins.tooltip.bodyColor = '#e2e8f0';
  Chart.defaults.plugins.tooltip.borderColor = 'rgba(148,163,184,.25)';
  Chart.defaults.plugins.tooltip.borderWidth = 1;
  Chart.defaults.datasets.bar.borderRadius = 6;
  Chart.defaults.datasets.bar.borderSkipped = false;
  Chart.defaults.datasets.bar.maxBarThickness = 42;

  /* >>> nitidez retina */
  Chart.defaults.devicePixelRatio = Math.max(1, window.devicePixelRatio || 1);

  function gradNow(ctx){
    const g = ctx.createLinearGradient(0,0,0,240);
    g.addColorStop(0,'rgba(123,30,58,0.95)');
    g.addColorStop(1,'rgba(156,53,84,0.55)');
    return g;
  }
  function gradPrev(ctx){
    const g = ctx.createLinearGradient(0,0,0,240);
    g.addColorStop(0,'rgba(148,163,184,0.85)');
    g.addColorStop(1,'rgba(203,213,225,0.45)');
    return g;
  }

  /* ===================== Helpers (idem) ===================== */
  const $ = id => document.getElementById(id);
  const setStatus=(t,k)=>{ const el=$('status'); if(!el) return; el.textContent=t; el.style.color=(k==='err'?'#ef4444':k==='ok'?'#10b981':'#667085'); };
  const setDiag=(msg)=>{ const d=$('diag'); if(d) d.textContent = msg || ''; };
  const info=(msg)=>{ const i=$('uploadInfo'); if(i) i.textContent = msg || ''; };

  const money=v=>(v==null||!isFinite(+v))?'R$ 0,00':'R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const num =v=>(v==null||!isFinite(+v))?'0':(+v).toLocaleString('pt-BR');
  const pctf=v=>(v==null||!isFinite(+v))?'0,0%':((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
  function iso(d){return d.toISOString().slice(0,10);}
  function addDaysISO(isoStr,n){const d=new Date(isoStr+'T00:00:00'); d.setDate(d.getDate()+n); return iso(d);}
  function daysLen(de,ate){const d1=new Date(de+'T00:00:00'), d2=new Date(ate+'T00:00:00');return Math.round((d2-d1)/(1000*60*60*24))+1;}
  function monthStartISO(isoStr){ const d=new Date(isoStr+'T00:00:00'); d.setDate(1); return iso(d); }
  function monthEndISO(isoStr){ const d=new Date(isoStr+'T00:00:00'); d.setMonth(d.getMonth()+1,0); return iso(d); }
  function addMonthsISO(isoStr, delta){ const d=new Date(isoStr+'T00:00:00'); const day=d.getDate(); d.setDate(1); d.setMonth(d.getMonth()+delta); const last=new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); d.setDate(Math.min(day,last)); return iso(d); }
  function formatYM(isoStr){ const d=new Date(isoStr+'T00:00:00'); const m=d.getMonth(); const y=String(d.getFullYear()).slice(-2); const n=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; return `${n[m]}/${y}`; }

  const rmAcc = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const normHeader = (s)=> rmAcc(s).toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
  function cleanSpaces(s){ return String(s||'').replace(/[\u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]/g,' ').replace(/\s+/g,' ').trim(); }
  function displayNormalize(s){ return cleanSpaces(s); }

  /* ===================== (resto do JS: igual ao v2.20.0, com os fixes abaixo) ===================== */

  /* >>> FIX 1: onde havia .limit(...), usar .range(0, N)  */
  /* >>> FIX 2: onde havia .eq('cancelado', valor), usar .in('cancelado', [valor]) */

  // EXEMPLO aplicado nos pontos críticos:

  async function baseQuery(de, ate){
    let q = supa.from(READ_VIEW)
      .select('dia,hora,turno,fat,des,fre,pedidos,cancelado,loja,unidade,canal,pagamento_base')
      .gte('dia', de).lte('dia', ate)
      .order('dia', { ascending:true })
      .range(0, 199999); // (antes: .limit(200000))

    const unids = window.ms?.unids?.get?.()||[]; if(unids.length) q = q.in('unidade', unids);
    const lojas = window.ms?.lojas?.get?.()||[]; if(lojas.length) q = q.in('loja', lojas);
    const turns = window.ms?.turnos?.get?.()||[]; if(turns.length) q = q.in('turno', turns);
    const cans  = window.ms?.canais?.get?.()||[]; if(cans.length)  q = q.in('canal', cans);
    const pags  = window.ms?.pags?.get?.()||[]; if(pags.length)   q = q.in('pagamento_base', pags);

    const forcedCancel = wantedCancelFilterForKPI();
    if(forcedCancel) q = q.in('cancelado', [forcedCancel]); // (antes: .eq('cancelado', forcedCancel))

    const { data, error } = await q;
    if(error){ console.error('[REST baseQuery]', error); throw error; }
    return data||[];
  }

  async function updateTop6(){
    try{
      const de=fDe.value||firstDay, ate=fAte.value||lastDay;
      const meta = KPI_META[selectedKPI]||KPI_META.fat;
      let q = supa.from(READ_VIEW)
        .select('loja,fat,des,fre,pedidos,cancelado,dia')
        .gte('dia', de).lte('dia', ate)
        .order('loja', { ascending:true })
        .range(0, 119999); // (antes: .limit(120000))

      const unids = ms.unids.get(); if(unids.length) q = q.in('unidade', unids);
      const lojas = ms.lojas.get(); if(lojas.length) q = q.in('loja', lojas);
      const turns = ms.turnos.get(); if(turns.length) q = q.in('turno', turns);
      const cans  = ms.canais.get(); if(cans.length)  q = q.in('canal', cans);
      const pags  = ms.pags.get(); if(pags.length)   q = q.in('pagamento_base', pags);

      const forcedCancel = wantedCancelFilterForKPI();
      if(forcedCancel) q = q.in('cancelado', [forcedCancel]); // (antes: .eq(...))

      const { data, error } = await q;
      if(error) throw error;

      // ... (resto do cálculo do donut permanece idêntico ao v2.20.0)
      // (mantém labels/values/extras/ensureDonutTop6)
    }catch(e){
      console.warn('top6 erro:', e.message||e);
      ensureDonutTop6([],[], 'Total: R$ 0,00','money');
    }
  }

  // ensureChart: sem mudanças visuais, mas com render nítida graças ao defaults.devicePixelRatio e sem !important no CSS
  function ensureChart(canvasId, labels, nowArr, prevArr, tooltipExtra='', fmt='money'){
    const canvas=$(canvasId); if(!canvas) return;
    if(canvas.__chart){ try{canvas.__chart.destroy();}catch(e){} canvas.__chart=null; }
    const ctx=canvas.getContext('2d');
    const chart=new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[
        {label:'Atual', data:nowArr.map(v=>+v||0), backgroundColor:gradNow(ctx)},
        {label:'Anterior', data:prevArr.map(v=>+v||0), backgroundColor:gradPrev(ctx)}
      ]},
      options:{
        responsive:true, maintainAspectRatio:false, animation:false, parsing:false,
        scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)'}, ticks:{callback:(v)=>formatTickBy(fmt,v)}}},
        plugins:{ legend:{position:'top'},
          tooltip:{mode:'index',intersect:false,callbacks:{
            label:(c)=>`${c.dataset.label}: ${formatValueBy(fmt, c.parsed.y||0)}`,
            footer:()=> tooltipExtra
          }}
        }
      }
    });
    canvas.__chart=chart;
  }

  /* === O RESTANTE DO CÓDIGO (KPI_META, wantedCancelFilterForKPI, clientAgg, updateChartsServer, updateMonth12x12, upload Excel etc.) é o mesmo da v2.20.0 que te enviei. === */
  /* Só apliquei os dois ajustes (range + in) em todos os pontos onde havia .limit e .eq(cancelado, ...) */

  </script>
</body>
</html>
