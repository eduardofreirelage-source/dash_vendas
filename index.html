<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Maestro Food</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- favicon inline p/ evitar 404 -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232563eb'/%3E%3Ctext x='32' y='38' font-family='Arial' font-size='28' text-anchor='middle' fill='white'%3EM%3C/text%3E%3C/svg%3E" />
<style>
  :root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  h1{font-size:20px;margin:0}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .muted{color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px}
  .grid{display:grid;gap:12px}.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .kpi{position:relative}.kpi .title{font-size:12px;color:var(--muted)} .kpi .val{font-size:22px;font-weight:700;margin-top:6px}
  .delta{position:absolute;right:12px;bottom:8px;font-size:12px;font-weight:600}
  .delta.up{color:var(--good)} .delta.down{color:var(--bad)}
  .filters{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  select,input,button{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
  input[type="date"]{padding:7px 10px}
  button{cursor:pointer}
  .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
  .pill button{border:0;padding:6px 10px;background:#fff}
  .pill button.active{background:var(--accent);color:#fff}
  .chartbox{position:relative;height:300px;width:100%}
  /* AUTH */
  .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:99}
  .gate .box{width:360px;max-width:92vw;background:#fff;border:1px solid var(--brd);border-radius:14px;padding:18px}
  .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
  .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
  .tabs button.active{background:var(--accent);color:#fff}
  .field{display:flex;flex-direction:column;margin-top:8px}
  .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
  .error{color:#b91c1c;font-size:12px;margin-top:6px;min-height:16px}
  @media (max-width:940px){.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}.filters{grid-template-columns:repeat(6,1fr)}}
  @media (max-width:560px){.cols-4,.cols-2{grid-template-columns:1fr}.filters{grid-template-columns:repeat(4,1fr)}}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<!-- AUTH -->
<div class="gate" id="gate" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 8px">Acesso • Maestro Food</h3>
    <div class="tabs">
      <button id="tabLogin" class="active">Entrar</button>
      <button id="tabSignup">Criar conta</button>
    </div>
    <div class="field"><label>E-mail</label><input id="authEmail" type="email" placeholder="voce@empresa.com"></div>
    <div class="field"><label>Senha</label><input id="authPass" type="password" placeholder="••••••••"></div>
    <div class="field" style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnSignup" style="display:none">Criar conta</button>
      <button id="btnLogin">Entrar</button>
    </div>
    <div class="muted" style="margin-top:6px"><a href="#" id="btnReset">Esqueci a senha</a></div>
    <div id="authMsg" class="error"></div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="toolbar">
    <h1>Maestro Food</h1>
    <div>
      <span class="muted" id="who"></span>
      <button id="btnLogout">Sair</button>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="muted">FILTROS</div>
      <button id="btnClear" class="muted" style="border:0;background:transparent">Limpar</button>
    </div>
    <div class="filters" style="margin-top:6px">
      <div class="col-6">
        <label>Unidade</label>
        <select id="uni"></select>
      </div>
      <div class="col-6">
        <label>Nome da loja (Top 10)</label>
        <select id="loja" multiple></select>
      </div>

      <div class="col-3">
        <label>De</label>
        <input id="dini" type="date" />
      </div>
      <div class="col-3">
        <label>Até</label>
        <input id="dfim" type="date" />
      </div>
      <div class="col-3">
        <label>Período rápido</label>
        <select id="pr">
          <option value="7">Últimos 7</option>
          <option value="15">Últimos 15</option>
          <option value="30" selected>Últimos 30</option>
          <option value="90">Últimos 90</option>
          <option value="180">Últimos 180</option>
          <option value="360">Últimos 360</option>
        </select>
      </div>
      <div class="col-3">
        <label>Turno</label>
        <select id="turno" multiple>
          <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option><option>Dia</option>
        </select>
      </div>

      <div class="col-4">
        <label>Canal de venda</label>
        <select id="canal" multiple></select>
      </div>
      <div class="col-4">
        <label>Pagamento</label>
        <select id="pag" multiple></select>
      </div>
      <div class="col-4">
        <label>Está cancelado?</label>
        <select id="canc">
          <option value="Todos">Todos</option>
          <option value="Sim">Sim</option>
          <option value="Não" selected>Não</option>
        </select>
      </div>

      <div class="col-12" style="border:1px dashed var(--brd);border-radius:10px;padding:10px">
        <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>) • o intervalo do arquivo é limpo antes de inserir
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <input type="file" id="csvfile" accept=".csv">
          <button id="btnImport">Importar CSV</button>
          <progress id="prog" value="0" max="100" style="display:none"></progress>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
    <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
    <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
    <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
  </div>
  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
    <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
    <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
    <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
  </div>
  <div class="grid cols-2" style="margin-top:12px">
    <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
    <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
  </div>

  <!-- GRÁFICOS -->
  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="title">Receita diária</div>
      <div class="pill" data-target="lineMode"><button data-val="total" class="active">Total</button><button data-val="media">Média (7d)</button></div>
    </div>
    <div class="chartbox"><canvas id="cLine"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="title">Receita por dia da semana</div>
      <div class="pill" data-target="dowMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cDowFat"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="title">Pedidos por dia da semana</div>
      <div class="pill" data-target="dowPedMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cDowPed"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="title">Receita por hora</div>
      <div class="pill" data-target="hourMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cHour"></canvas></div>
    <div class="muted" style="margin-top:4px">Horas com pouca atividade são ocultadas (proxy > 50% dos dias sem venda).</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div class="title">Receita por mês</div>
      <div class="pill" data-target="monMode"><button data-val="total" class="active">Total</button><button data-val="media">Média</button></div>
    </div>
    <div class="chartbox"><canvas id="cMonth"></canvas></div>
  </div>
</div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Supabase =====
  var supa = window.supabase.createClient(
    "https://uahmcfzerofhzjvlzrqc.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU",
    { auth:{persistSession:true,autoRefreshToken:true} }
  );
  var VIEW = "vendas_kpi_daily_v2";
  var BASE = "vendas_kpi_daily_v2_base";

  // ===== Helpers =====
  function fmtBRL(n){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0)}
  function fmtInt(n){return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0))}
  function toISO(d){return d instanceof Date ? d.toISOString().slice(0,10) : null}
  function parseISO(s){return new Date(s+"T00:00:00Z")}
  function addDays(d,k){var t=new Date(d);t.setUTCDate(t.getUTCDate()+k);return t}
  function numBR(x){ if(typeof x==="number") return x; var s=(x||"").toString().replace(/\./g,"").replace(",","."); var v=Number(s); return isFinite(v)?v:0; }
  function parseBRDateTime(s){ var m=(s||"").match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/); if(!m) return {iso:null,hour:null}; var d=new Date(Date.UTC(+m[3],+m[2]-1,+m[1],+m[4],+m[5])); return {iso:toISO(d),hour:d.getUTCHours()}; }
  function movingAvg(a,w){var out=[],acc=0;for(var i=0;i<a.length;i++){acc+=a[i]; if(i>=w) acc-=a[i-w]; out.push(acc/Math.min(i+1,w));} return out;}
  function setDelta(el,cur,prev){ var pct=prev>0?((cur-prev)/prev*100):0; el.className="delta "+(pct>=0?"up":"down"); el.textContent=((pct>=0?"+":"")+pct.toFixed(1)+"%"); }
  function uniq(a){return Array.from(new Set(a))}

  // ===== Estado/refs =====
  var app=document.getElementById("app"), gate=document.getElementById("gate"), who=document.getElementById("who");
  var authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass"), authMsg=document.getElementById("authMsg");
  var tabLogin=document.getElementById("tabLogin"), tabSignup=document.getElementById("tabSignup");
  var btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup"), btnLogout=document.getElementById("btnLogout"), btnReset=document.getElementById("btnReset");

  var uni=document.getElementById("uni"), loja=document.getElementById("loja");
  var dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  var turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  var btnClear=document.getElementById("btnClear");

  var chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null;
  var lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total";
  var minDiaISO=null, maxDiaISO=null;

  function showGate(){gate.style.display="flex";app.style.display="none"}
  function hideGate(){gate.style.display="none";app.style.display="block"}

  // Auth
  tabLogin.onclick=function(){tabLogin.classList.add("active");tabSignup.classList.remove("active");btnLogin.style.display="inline-block";btnSignup.style.display="none";authMsg.textContent=""}
  tabSignup.onclick=function(){tabSignup.classList.add("active");tabLogin.classList.remove("active");btnSignup.style.display="inline-block";btnLogin.style.display="none";authMsg.textContent=""}
  btnLogin.onclick=async function(){
    authMsg.textContent=""; var email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){authMsg.textContent="Informe e-mail e senha.";return}
    var {error}=await supa.auth.signInWithPassword({email,password:pass}); if(error){authMsg.textContent=error.message;return}
  };
  btnSignup.onclick=async function(){
    authMsg.textContent=""; var email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){authMsg.textContent="Informe e-mail e senha.";return}
    var {error}=await supa.auth.signUp({email,password:pass}); authMsg.textContent= error? error.message : "Conta criada. Verifique seu e-mail se solicitado.";
  };
  btnLogout.onclick=async function(){await supa.auth.signOut()};
  btnReset.onclick=async function(e){
    e.preventDefault(); var email=(authEmail.value||"").trim();
    if(!email){authMsg.textContent="Informe seu e-mail acima e clique novamente.";return}
    var {error}=await supa.auth.resetPasswordForEmail(email,{ redirectTo: location.origin+location.pathname+"#reset" });
    authMsg.textContent= error? error.message : "Se o e-mail existir, enviaremos instruções.";
  };
  supa.auth.onAuthStateChange(async(_e,session)=>{ if(session){ who.textContent=session.user?.email||""; hideGate(); await boot(); } else { showGate(); } });

  // Limites
  async function fetchLimites(){
    const a = await supa.from(VIEW).select("dia").order("dia",{ascending:true}).limit(1);
    const b = await supa.from(VIEW).select("dia").order("dia",{ascending:false}).limit(1);
    minDiaISO = (!a.error && a.data?.length)? a.data[0].dia : null;
    maxDiaISO = (!b.error && b.data?.length)? b.data[0].dia : null;
  }

  // Opções
  async function reloadOptions(){
    // Unidades
    uni.innerHTML="";
    let arr=["Todas"], seen={};
    const r1 = await supa.from(VIEW).select("unidade").order("unidade",{ascending:true}).range(0,9999);
    if(!r1.error) (r1.data||[]).forEach(r=>{let u=(r.unidade||"").trim(); if(u && !seen[u]){seen[u]=1;arr.push(u)}});
    if(arr.length===1){arr.push("Uni. Raja","Uni.Savassi")}
    arr.forEach(u=>{let o=document.createElement("option");o.value=u;o.textContent=u;uni.appendChild(o)}); uni.value="Todas";

    // Loja/Canal/Pagamento
    const all = await supa.from(VIEW).select('"Nome da loja","Canal de venda",pagamento').limit(20000);
    if(!all.error){
      let lojas=uniq((all.data||[]).map(r=>r["Nome da loja"]).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
      loja.innerHTML=""; lojas.forEach(v=>{let o=document.createElement("option");o.value=v;o.textContent=v;loja.appendChild(o)});

      let canais=uniq((all.data||[]).map(r=>r["Canal de venda"]).filter(Boolean)).sort();
      canal.innerHTML=""; canais.forEach(v=>{let o=document.createElement("option");o.value=v;o.textContent=v;canal.appendChild(o)});

      let pags=uniq((all.data||[]).map(r=>r["pagamento"]).filter(Boolean)).sort();
      pag.innerHTML=""; pags.forEach(v=>{let o=document.createElement("option");o.value=v;o.textContent=v;pag.appendChild(o)});
    }
  }

  async function boot(){
    await fetchLimites();
    await reloadOptions();
    if(maxDiaISO){ let end=parseISO(maxDiaISO), start=addDays(end,-29); dini.value=toISO(start); dfim.value=toISO(end); } else { dini.value=""; dfim.value=""; }
    wireFilters(); await recarregar();
  }

  function wireFilters(){
    function onChange(){ recarregar(); }
    [uni,loja,dini,dfim,pr,turno,canal,pag,canc].forEach(el=>el.addEventListener("change",onChange));
    btnClear.onclick=function(e){e.preventDefault(); uni.value="Todas"; loja.selectedIndex=-1; dini.value=""; dfim.value=""; pr.value="30"; turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value="Não"; recarregar(); }
    document.querySelectorAll(".pill").forEach(p=>{
      p.addEventListener("click",function(e){
        if(e.target.tagName!=="BUTTON") return;
        var tgt=this.getAttribute("data-target"), val=e.target.getAttribute("data-val");
        this.querySelectorAll("button").forEach(b=>b.classList.remove("active")); e.target.classList.add("active");
        if(tgt==="lineMode") lineMode=val; if(tgt==="dowMode") dowMode=val; if(tgt==="dowPedMode") dowPedMode=val; if(tgt==="hourMode") hourMode=val; if(tgt==="monMode") monMode=val;
        recarregar();
      });
    });
  }

  async function queryRange(startISO,endISO,filters){
    var page=1000, off=0, out=[];
    for(;;){
      var q = supa.from(VIEW).select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
        .gte('dia',startISO).lte('dia',endISO).order('dia',{ascending:true}).range(off,off+page-1);
      if(filters.uni && filters.uni!=="Todas") q=q.eq('unidade',filters.uni);
      if(filters.lojas && filters.lojas.length) q=q.in('Nome da loja',filters.lojas);
      if(filters.turno && filters.turno.length) q=q.in('turno',filters.turno);
      if(filters.canal && filters.canal.length) q=q.in('Canal de venda',filters.canal);
      if(filters.pag && filters.pag.length) q=q.in('pagamento',filters.pag);
      if(filters.canc && filters.canc!=="Todos") q=q.eq('cancelado',filters.canc);
      var r=await q; if(r.error){break}
      var a=r.data||[]; out=out.concat(a); if(a.length<page) break; off+=page; if(off>500000) break;
    }
    return out;
  }

  function destroy(c){ if(c){ try{c.destroy()}catch(e){} } return null }
  function setKPI(cur, ant){
    function s(arr,k){return arr.reduce((t,r)=>t+Number(r[k]||0),0)}
    var ped=s(cur,"pedidos"), fat=s(cur,"fat"), des=s(cur,"des"), fre=s(cur,"fre");
    var pedA=s(ant,"pedidos"), fatA=s(ant,"fat"), desA=s(ant,"des"), freA=s(ant,"fre");
    var dias = uniq(cur.map(r=>r.dia)).length||1, diasA = uniq(ant.map(r=>r.dia)).length||1;
    var tkm = ped>0? fat/ped : 0, tkmA = pedA>0? fatA/pedA : 0;
    var fmd = fat/dias, fmdA=fatA/diasA;
    var fatL = fat - des - fre - (0.12*fat), fatLA = fatA - desA - freA - (0.12*fatA);
    var desP = fat>0? (des/fat*100):0, desPA = fatA>0? (desA/fatA*100):0;
    var freM = ped>0? fre/ped : 0, freMA = pedA>0? freA/pedA : 0;
    var fatLP = fat>0? (fatL/fat*100):0, fatLPA = fatA>0? (fatLA/fatA*100):0;

    document.getElementById("k_ped").textContent=fmtInt(ped);
    document.getElementById("k_tkm").textContent=fmtBRL(tkm);
    document.getElementById("k_fat").textContent=fmtBRL(fat);
    document.getElementById("k_fmd").textContent=fmtBRL(fmd);
    document.getElementById("k_des").textContent=fmtBRL(des);
    document.getElementById("k_desp").textContent=desP.toFixed(1)+"%";
    document.getElementById("k_fre").textContent=fmtBRL(fre);
    document.getElementById("k_frem").textContent=fmtBRL(freM);
    document.getElementById("k_fatl").textContent=fmtBRL(fatL);
    document.getElementById("k_fatlp").textContent=fmtBRL(fatLP.toFixed?fatLP:0)+"%";

    setDelta(document.getElementById("d_ped"), ped, pedA);
    setDelta(document.getElementById("d_tkm"), tkm, tkmA);
    setDelta(document.getElementById("d_fat"), fat, fatA);
    setDelta(document.getElementById("d_fmd"), fmd, fmdA);
    setDelta(document.getElementById("d_des"), des, desA);
    setDelta(document.getElementById("d_desp"), desP, desPA);
    setDelta(document.getElementById("d_fre"), fre, freA);
    setDelta(document.getElementById("d_frem"), freM, freMA);
    setDelta(document.getElementById("d_fatl"), fatL, fatLA);
    setDelta(document.getElementById("d_fatlp"), fatLP, fatLPA);
  }

  function drawLine(days,vals,prevVals,mode){
    chartLine=destroy(chartLine);
    var ctx=document.getElementById("cLine").getContext("2d");
    var showMed=(mode==="media");
    var main=showMed? movingAvg(vals,7) : vals;
    chartLine=new Chart(ctx,{type:"line",data:{labels:days,datasets:[
      {data:prevVals,fill:true,backgroundColor:"rgba(2,132,199,0.12)",borderWidth:0,pointRadius:0,tension:0.2},
      {data:main,borderWidth:2,pointRadius:0,tension:0.2}
    ]},options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }
  function drawBar(id,labels,totals,counts,mode,horizontal){
    var showMed=(mode==="media"), vals=showMed? totals.map((v,i)=> (counts[i]||1)? v/(counts[i]):0 ) : totals.slice();
    var ctx=document.getElementById(id).getContext("2d");
    var opt={indexAxis: horizontal?'y':'x', responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}};
    return new Chart(ctx,{type:"bar",data:{labels:labels,datasets:[{data:vals}]},options:opt});
  }

  async function recarregar(){
    let sISO=dini.value, eISO=dfim.value;
    if(!sISO || !eISO){
      if(!maxDiaISO){ return; }
      let end=parseISO(maxDiaISO), start=addDays(end,-(Number(pr.value||30)-1));
      sISO=toISO(start); eISO=toISO(end); dini.value=sISO; dfim.value=eISO;
    }
    let filters={
      uni: uni.value||"Todas",
      lojas: Array.from(loja.selectedOptions).map(o=>o.value),
      turno: Array.from(turno.selectedOptions).map(o=>o.value),
      canal: Array.from(canal.selectedOptions).map(o=>o.value),
      pag:   Array.from(pag.selectedOptions).map(o=>o.value),
      canc:  (canc.value||"Todos")
    };

    const cur = await queryRange(sISO,eISO,filters);
    const daysLen = Math.max(1, Math.round((parseISO(eISO)-parseISO(sISO))/(24*3600*1000))+1);
    const prevEnd = addDays(parseISO(sISO),-1), prevStart=addDays(prevEnd,-(daysLen-1));
    const ant = await queryRange(toISO(prevStart),toISO(prevEnd),filters);

    setKPI(cur,ant);

    // line + sombra
    var byDayMap=new Map(), byPrevMap=new Map();
    cur.forEach(r=>byDayMap.set(r.dia,(byDayMap.get(r.dia)||0)+Number(r.fat||0)));
    ant.forEach(r=>byPrevMap.set(r.dia,(byPrevMap.get(r.dia)||0)+Number(r.fat||0)));
    var labels=Array.from(byDayMap.keys()).sort(), vals=labels.map(k=>byDayMap.get(k));
    var prevVals=labels.map((k)=> byPrevMap.get(toISO(addDays(parseISO(k),-daysLen)))||0 );
    drawLine(labels,vals,prevVals,lineMode);

    // dow fat
    var lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], tot=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
    var diasSet=uniq(cur.map(r=>r.dia)); diasSet.forEach(d=>{cnt[parseISO(d).getUTCDay()]++});
    cur.forEach(r=>{var d=parseISO(r.dia).getUTCDay(); tot[d]+=Number(r.fat||0)});
    chartDowFat=destroy(chartDowFat); chartDowFat=drawBar("cDowFat",lbl,tot,cnt,dowMode,false);

    // dow ped
    var t2=[0,0,0,0,0,0,0], c2=cnt.slice(); cur.forEach(r=>{var d=parseISO(r.dia).getUTCDay(); t2[d]+=Number(r.pedidos||0)});
    chartDowPed=destroy(chartDowPed); chartDowPed=drawBar("cDowPed",lbl,t2,c2,dowPedMode,false);

    // hora
    var m=Array(24).fill(0), c=Array(24).fill(0), daysHour=Array(24).fill(0).map(()=>new Set());
    cur.forEach(r=>{ if(r.hora==null) return; var h=Number(r.hora)||0; if(h>=0&&h<=23){ m[h]+=Number(r.fat||0); daysHour[h].add(r.dia);} });
    var totalDays=diasSet.length||1, hLbl=[], hTot=[], hCnt=[];
    for(var h=0;h<24;h++){ c[h]=daysHour[h].size; var keep=(c[h] >= Math.ceil(totalDays*0.5) && m[h]>0); if(keep){ hLbl.push(String(h).padStart(2,"0")+":00"); hTot.push(m[h]); hCnt.push(c[h]); } }
    chartHour=destroy(chartHour); chartHour=drawBar("cHour",hLbl,hTot,hCnt,hourMode,false);

    // mês
    var mMap=new Map(), dMap=new Map();
    cur.forEach(r=>{var ym=r.dia.slice(0,7); mMap.set(ym,(mMap.get(ym)||0)+Number(r.fat||0)); if(!dMap.has(ym)) dMap.set(ym,new Set()); dMap.get(ym).add(r.dia);});
    var mLbl=Array.from(mMap.keys()).sort(); var mTot=mLbl.map(x=>mMap.get(x)); var mCnt=mLbl.map(x=> (dMap.get(x)||new Set()).size );
    chartMonth=destroy(chartMonth); chartMonth=drawBar("cMonth",mLbl,mTot,mCnt,monMode,false);
  }

  // ===== Import CSV (Pasta2.csv)
  document.getElementById("btnImport").onclick=async function(){
    var f=document.getElementById("csvfile").files[0]; if(!f){alert("Selecione o Pasta2.csv");return}
    var prog=document.getElementById("prog"); prog.style.display="inline-block"; prog.value=0;

    function normKey(k){ return (k==null? "": k.toString().replace(/^\uFEFF/,"").trim()); }

    Papa.parse(f,{
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        const rows = res.data||[];
        if(!rows.length){ prog.style.display="none"; alert("CSV vazio."); return; }

        let mapped=[], minISO=null, maxISO=null;
        for(let r of rows){
          const _ = new Proxy({}, { get:(_t,prop)=> r[Object.keys(r).find(k=>normKey(k)===prop)] });
          const unidade = _["unidade"] || _["Unidade"] || r["﻿unidade"] || r["\ufeffunidade"] || "";
          const lojaN   = _["Nome da loja"] || _["Nome da Loja"] || "";
          const canalV  = _["Canal de venda"] || "";
          const turnoV  = _["Turno"] || "";
          const pagV    = _["Pagamento"] || "";
          const cancel  = (_["Está cancelado"]||"").toString().trim().toUpperCase();
          const dt      = _["Data da venda"] || "";
          const tot     = numBR(_["Total"]||0);       /* <<< FIX AQUI */
          const ent     = numBR(_["Entrega"]||0);
          const desc    = numBR(_["Desconto"]||0);
          const pedido  = (_["Número do pedido no parceiro"]||"").toString();

          const pdt = parseBRDateTime(dt);
          if(!pdt.iso){ continue; }
          minISO = (!minISO || pdt.iso<minISO)? pdt.iso : minISO;
          maxISO = (!maxISO || pdt.iso>maxISO)? pdt.iso : maxISO;

          mapped.push({
            dia: pdt.iso,
            unidade: unidade || null,
            pedidos: 1,
            fat: tot,
            des: desc,
            fre: ent,
            "Nome da loja": lojaN || null,
            turno: turnoV || null,
            "Canal de venda": canalV || null,
            pagamento: pagV || null,
            cancelado: (cancel==="S"||cancel==="SIM") ? "Sim" : "Não",
            hora: pdt.hour,
            pedido_id: pedido || null
          });
        }

        if(!mapped.length){ prog.style.display="none"; alert("Não foi possível mapear linhas válidas."); return; }

        await supa.from(BASE).delete().gte('dia',minISO).lte('dia',maxISO);
        const chunk=1500; let done=0;
        for(let i=0;i<mapped.length;i+=chunk){
          const slice=mapped.slice(i,i+chunk);
          const ins=await supa.from(BASE).insert(slice);
          if(ins.error){ prog.style.display="none"; alert("Erro ao inserir: "+ins.error.message); return; }
          done+=slice.length; prog.value=Math.round(done/mapped.length*100);
        }
        prog.style.display="none";
        await fetchLimites();                   // atualiza limites
        await reloadOptions();                  // repopula selects (Unidade/Loja/Canal/Pagamento)
        await recarregar();                     // redesenha KPIs e gráficos
        alert("Import concluído: "+mapped.length+" linhas • "+minISO+" → "+maxISO);
      },
      error: (err)=>{ prog.style.display="none"; alert("Erro ao ler CSV: "+(err.message||err)) }
    });
  };

  // Boot pela sessão
  (async function(){
    const {data:{session}} = await supa.auth.getSession();
    if(session){ who.textContent=session.user?.email||""; hideGate(); await boot(); } else { showGate(); }
  })();
})();
</script>
</body>
</html>
