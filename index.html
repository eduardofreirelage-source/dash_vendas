<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><circle cx="60" cy="60" r="60" fill="%232563eb"/><text x="60" y="76" font-size="64" text-anchor="middle" fill="white" font-family="Arial,Helvetica,sans-serif">M</text></svg>' />
  <style>
    :root{--bg:#f6f7fb;--fg:#0f172a;--mut:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--ok:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 6px}
    .muted{color:var(--mut);font-size:12px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .topbar{display:flex;gap:8px;align-items:center}
    button,select,input{font:inherit;background:#fff;border:1px solid var(--brd);border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px}
    .grid{display:grid;gap:12px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kpi{position:relative;padding-bottom:10px}
    .kpi .title{font-size:12px;color:var(--mut)}
    .kpi .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600}
    .kpi .delta.up{color:var(--ok)} .kpi .delta.down{color:var(--bad)}
    .chartbox{position:relative;height:300px}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px}
    .pill button.active{background:var(--accent);color:#fff}
    details.filter{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filter>summary{padding:12px 14px;list-style:none;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:700}
    details.filter[open]>summary{border-bottom:1px solid var(--brd)}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-2{grid-column:span 2}.col-12{grid-column:span 12}
    .seg{display:flex;gap:8px;align-items:center}
    .lbl{font-size:12px;color:var(--mut);white-space:nowrap}
    .grow{min-width:160px;width:100%}
    .hint{font-size:12px;color:var(--mut)}
    .right{margin-left:auto}
    progress{height:10px}
    @media (max-width:960px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}.filters-grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:560px){.grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}.filters-grid{grid-template-columns:repeat(4,1fr)}}
    /* Auth */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:8px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--mut);margin-bottom:4px}
    .error{color:#b91c1c;font-size:12px;min-height:16px;margin-top:6px}
    a.link{color:var(--accent);text-decoration:none;font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Entrar no Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div id="authStepLogin">
        <div class="field"><label>E-mail</label><input id="authEmail" type="email" autocomplete="email"></div>
        <div class="field"><label>Senha</label><input id="authPass" type="password" autocomplete="current-password"></div>
        <div class="error" id="authErr"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnLogin">Entrar</button>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <a class="link" href="#" id="lnkForgot">Esqueci a senha</a>
          <a class="link" href="#" id="lnkGoSignup">Criar conta</a>
        </div>
      </div>
      <div id="authStepSignup" style="display:none">
        <div class="field"><label>E-mail</label><input id="suEmail" type="email" autocomplete="email"></div>
        <div class="field"><label>Senha</label><input id="suPass" type="password" autocomplete="new-password"></div>
        <div class="error" id="suErr"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnSignup">Criar conta</button>
        </div>
      </div>
      <div id="authStepReset" style="display:none">
        <div class="field"><label>E-mail</label><input id="fpEmail" type="email" autocomplete="email"></div>
        <div class="error" id="fpErr"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnSendReset">Enviar link</button>
        </div>
        <div style="margin-top:8px"><a class="link" href="#" id="lnkBackLogin">Voltar</a></div>
      </div>
      <div id="authStepNewPass" style="display:none">
        <div class="field"><label>Nova senha</label><input id="npPass" type="password" autocomplete="new-password"></div>
        <div class="error" id="npErr"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnSetNewPass">Definir senha</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <div>
        <h1>Maestro Food</h1>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <div class="topbar">
        <span class="muted" id="who"></span>
        <button id="btnLogout" class="ghost">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filter" id="fx" open>
      <summary>FILTROS <span class="muted right" id="btnClear">Limpar</span></summary>
      <div class="card" style="border:none;border-radius:0;border-top:1px solid var(--brd)">
        <div class="filters-grid">
          <div class="col-6 seg"><span class="lbl">Unidade</span><select id="f_uni" class="grow"></select></div>
          <div class="col-6 seg"><span class="lbl">Nome da loja (Top 10)</span><select id="f_loja" class="grow" multiple size="3"></select></div>

          <div class="col-3 seg"><span class="lbl">De</span><input id="f_de" type="date" class="grow"></div>
          <div class="col-3 seg"><span class="lbl">Até</span><input id="f_ate" type="date" class="grow"></div>
          <div class="col-3 seg">
            <span class="lbl">Período rápido</span>
            <select id="f_pr" class="grow">
              <option value="7">Últimos 7</option><option value="15">Últimos 15</option>
              <option value="30" selected>Últimos 30</option><option value="90">Últimos 90</option>
              <option value="180">Últimos 180</option><option value="360">Últimos 360</option>
            </select>
          </div>
          <div class="col-3 seg">
            <span class="lbl">Turno</span>
            <select id="f_turno" class="grow" multiple size="4">
              <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>

          <div class="col-4 seg"><span class="lbl">Canal de venda</span><select id="f_canal" class="grow" multiple size="3"></select></div>
          <div class="col-4 seg"><span class="lbl">Pagamento</span><select id="f_pag" class="grow" multiple size="3"></select></div>
          <div class="col-4 seg">
            <span class="lbl">Está cancelado?</span>
            <select id="f_canc" class="grow"><option>Todos</option><option>Não</option><option>Sim</option></select>
          </div>
        </div>

        <!-- Import CSV -->
        <div class="card" style="margin-top:12px;border-style:dashed">
          <b>Admin — Importar CSV (Pasta2.csv)</b> • o intervalo do arquivo é limpo antes de inserir
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <input type="file" id="csvfile" accept=".csv">
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" max="100" value="0" style="display:none"></progress>
            <span class="muted" id="importMsg"></span>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
    </div>

    <!-- GRÁFICO -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="title" style="font-size:14px">Receita diária</div>
        <div class="pill" data-target="lineMode"><button data-val="total" class="active">Total</button><button data-val="media">Média (7d)</button></div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

  </div>

<script>
(function(){
  if (window.__BOOT__) return; window.__BOOT__ = true;

  // ====== CONFIG ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TB_PRIMARY = "vendas_kpi_daily_v2";
  const TB_STAGING = "vendas_kpi_daily_v2_data";

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });

  // ====== STATE ======
  let ACTIVE_TABLE = TB_STAGING;       // prioriza staging
  let COL_LOJA = "Nome da Loja";       // auto-ajusta para "Nome da loja" se for o caso
  let minISO=null, maxISO=null;
  let lineMode="total";
  let chartLine=null;

  // ====== UI refs ======
  const gate = document.getElementById("gate");
  const app  = document.getElementById("app");
  const who  = document.getElementById("who");
  const periodoTxt = document.getElementById("periodo");
  const fx   = document.getElementById("fx");
  const uni  = document.getElementById("f_uni");
  const loja = document.getElementById("f_loja");
  const fde  = document.getElementById("f_de");
  const fate = document.getElementById("f_ate");
  const fpr  = document.getElementById("f_pr");
  const turno= document.getElementById("f_turno");
  const canal= document.getElementById("f_canal");
  const pag  = document.getElementById("f_pag");
  const canc = document.getElementById("f_canc");
  const btnClear = document.getElementById("btnClear");

  // ====== helpers ======
  const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const parseISO = s => s ? new Date(s+"T00:00:00Z") : null;
  const toISO = d => (d && !isNaN(d.getTime())) ? d.toISOString().slice(0,10) : "";
  const addDays = (d,k)=>{ const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; };
  const debounce=(fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  function setDelta(el, cur, prev){
    const pct = (prev>0) ? ( (cur-prev)/prev*100 ) : 0;
    el.className = "delta " + (pct>=0?"up":"down");
    el.textContent = (pct>=0?"+":"") + pct.toFixed(1) + "% " + (pct>=0?"▲":"▼");
  }

  function destroyChart(c){ if(c){ try{c.destroy();}catch{} } return null; }

  // ====== AUTH ======
  const tabLogin = document.getElementById("tabLogin");
  const tabSignup= document.getElementById("tabSignup");
  const stepLogin = document.getElementById("authStepLogin");
  const stepSignup= document.getElementById("authStepSignup");
  const stepReset = document.getElementById("authStepReset");
  const stepNew   = document.getElementById("authStepNewPass");
  function show(el){ el.style.display="block" } function hide(el){ el.style.display="none" }

  tabLogin.onclick = ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); show(stepLogin); hide(stepSignup); hide(stepReset); hide(stepNew); };
  tabSignup.onclick= ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); show(stepSignup); hide(stepLogin); hide(stepReset); hide(stepNew); };

  const authEmail = document.getElementById("authEmail");
  const authPass  = document.getElementById("authPass");
  const authErr   = document.getElementById("authErr");
  document.getElementById("btnLogin").onclick = async ()=>{
    authErr.textContent="";
    const { error } = await supa.auth.signInWithPassword({ email: (authEmail.value||"").trim(), password: authPass.value||"" });
    if(error){ authErr.textContent = error.message; return; }
    afterLogin();
  };

  document.getElementById("lnkGoSignup").onclick = (e)=>{ e.preventDefault(); tabSignup.click(); };

  // signup
  const suEmail=document.getElementById("suEmail"), suPass=document.getElementById("suPass"), suErr=document.getElementById("suErr");
  document.getElementById("btnSignup").onclick = async ()=>{
    suErr.textContent="";
    const { error } = await supa.auth.signUp({ email:(suEmail.value||"").trim(), password: suPass.value||"" });
    if(error){ suErr.textContent=error.message; return; }
    suErr.textContent="Conta criada. Verifique seu e-mail se for necessário confirmar.";
  };

  // forgot
  const lnkForgot=document.getElementById("lnkForgot"), lnkBackLogin=document.getElementById("lnkBackLogin");
  const fpEmail=document.getElementById("fpEmail"), fpErr=document.getElementById("fpErr");
  lnkForgot.onclick = (e)=>{ e.preventDefault(); hide(stepLogin); hide(stepSignup); show(stepReset); };
  lnkBackLogin.onclick = (e)=>{ e.preventDefault(); tabLogin.click(); };
  document.getElementById("btnSendReset").onclick = async ()=>{
    fpErr.textContent="";
    const email=(fpEmail.value||"").trim();
    const { error } = await supa.auth.resetPasswordForEmail(email, { redirectTo: location.href });
    fpErr.textContent = error? error.message : "Se o e-mail existir, o link foi enviado.";
  };

  // recovery flow
  const npPass=document.getElementById("npPass"), npErr=document.getElementById("npErr");
  document.getElementById("btnSetNewPass").onclick = async ()=>{
    npErr.textContent="";
    const { error } = await supa.auth.updateUser({ password: npPass.value||"" });
    npErr.textContent = error? error.message : "Senha atualizada. Você já está logado.";
    if(!error){ setTimeout(()=>afterLogin(), 600); }
  };

  document.getElementById("btnLogout").onclick = async ()=>{ await supa.auth.signOut(); show(gate); hide(app); };

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function showApp(){ gate.style.display="none"; app.style.display="block"; }

  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    showApp();
    await boot();
  }

  supa.auth.onAuthStateChange(async (e, session)=>{
    if(e==="PASSWORD_RECOVERY"){ show(gate); hide(app); hide(stepLogin); hide(stepSignup); hide(stepReset); show(stepNew); return; }
    if(session){ afterLogin(); } else { showGate(); }
  });

  (async ()=>{
    const { data:{ session } } = await supa.auth.getSession();
    if(session) afterLogin(); else showGate();
  })();

  // ====== DATA LAYER ======
  async function detectSchema(){
    // tenta staging
    let r = await supa.from(TB_STAGING).select("*").limit(1);
    if(!r.error){ ACTIVE_TABLE = TB_STAGING; }
    else{
      r = await supa.from(TB_PRIMARY).select("*").limit(1);
      ACTIVE_TABLE = TB_PRIMARY;
    }
    // pega limites
    const a = await supa.from(ACTIVE_TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const b = await supa.from(ACTIVE_TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO = (a.data && a.data[0] && a.data[0].dia)||null;
    maxISO = (b.data && b.data[0] && b.data[0].dia)||null;

    // detecta nome da coluna de loja
    const probe = await supa.from(ACTIVE_TABLE).select("*").limit(1);
    const row = (probe.data&&probe.data[0])||{};
    if(Object.prototype.hasOwnProperty.call(row,"Nome da loja")) COL_LOJA = "Nome da loja";
    else COL_LOJA = "Nome da Loja";
  }

  function selectCols(){
    // precisa de aspas duplas nos nomes com espaço
    const lojaCol = `"${COL_LOJA}"`;
    return `dia,unidade,pedidos,fat,des,fre,${lojaCol},turno,"Canal de venda",pagamento,cancelado,hora`;
  }

  async function fetchPaged(startISO, endISO, filtros){
    const page=1000; let off=0, out=[];
    for(;;){
      let q = supa.from(ACTIVE_TABLE).select(selectCols()).gte("dia", startISO).lte("dia", endISO).order("dia",{ascending:true}).range(off, off+page-1);
      if(filtros.unidade && filtros.unidade!=="Todas") q = q.eq("unidade", filtros.unidade);
      if((filtros.lojas||[]).length) q = q.in(COL_LOJA, filtros.lojas);
      if((filtros.turno||[]).length) q = q.in("turno", filtros.turno);
      if((filtros.canal||[]).length) q = q.in("Canal de venda", filtros.canal);
      if((filtros.pag||[]).length)   q = q.in("pagamento", filtros.pag);
      if(filtros.canc && filtros.canc!=="Todos") q = q.eq("cancelado", filtros.canc);
      const r = await q; if(r.error) throw r.error;
      out = out.concat(r.data||[]);
      if((r.data||[]).length < page) break;
      off += page;
      if(off>500000) break;
    }
    return out;
  }

  async function loadFiltersOptions(){
    // Unidades
    const u = await supa.from(ACTIVE_TABLE).select("unidade").order("unidade",{ascending:true}).limit(10000);
    const uniq = Array.from(new Set((u.data||[]).map(r=>r.unidade).filter(Boolean)));
    uni.innerHTML = `<option>Todas</option>${uniq.map(x=>`<option>${x}</option>`).join("")}`;

    // Canal & Pagamento (valores únicos)
    const p = await supa.from(ACTIVE_TABLE).select('"Canal de venda",pagamento').limit(100000);
    const canais = Array.from(new Set((p.data||[]).map(r=>r["Canal de venda"]).filter(Boolean))).sort();
    const pags   = Array.from(new Set((p.data||[]).map(r=>r["pagamento"]).filter(Boolean))).sort();
    canal.innerHTML = canais.map(x=>`<option>${x}</option>`).join("");
    pag.innerHTML   = pags.map(x=>`<option>${x}</option>`).join("");
  }

  function movingAvg(arr, win){ const out=[]; let acc=0; for(let i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push(acc/Math.min(i+1,win)); } return out; }

  function drawLine(days, vals, prevVals, mode){
    chartLine = destroyChart(chartLine);
    const ctx=document.getElementById("cLine").getContext("2d");
    const dataMed = movingAvg(vals, 7);
    const main = (mode==="media") ? dataMed : vals;
    chartLine = new Chart(ctx, {
      type:"line",
      data:{ labels:days, datasets:[
        { data: prevVals, fill:true, borderWidth:0, backgroundColor:"rgba(2,132,199,.12)", pointRadius:0, tension:.2 },
        { data: main, borderWidth:2, pointRadius:0, tension:.2 }
      ] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ y:{beginAtZero:true} }, animation:false }
    });
  }

  function updKPIs(cur, ant){
    const S = k => cur.reduce((s,r)=>s+Number(r[k]||0),0);
    const SA= k => ant.reduce((s,r)=>s+Number(r[k]||0),0);
    const ped=S("pedidos"), pedA=SA("pedidos");
    const fat=S("fat"), fatA=SA("fat");
    const des=S("des"), desA=SA("des");
    const fre=S("fre"), freA=SA("fre");
    const dias = new Set(cur.map(r=>r.dia)).size || 1;
    const diasA= new Set(ant.map(r=>r.dia)).size || 1;

    const tkm = ped>0 ? fat/ped : 0, tkmA = pedA>0 ? fatA/pedA : 0;
    const fmd = fat/dias,        fmdA = fatA/diasA;
    const fatL= fat - des - fre - 0.12*fat, fatLA = fatA - desA - freA - 0.12*fatA;
    const desP= fat>0 ? des/fat*100 : 0, desPA = fatA>0 ? desA/fatA*100 : 0;
    const freM= ped>0 ? fre/ped : 0,     freMA = pedA>0 ? freA/pedA : 0;
    const fatLP= fat>0 ? fatL/fat*100 : 0, fatLPA = fatA>0 ? fatLA/fatA*100 : 0;

    // valores
    document.getElementById("k_ped").textContent = fmtInt(ped);
    document.getElementById("k_tkm").textContent = fmtBRL(tkm);
    document.getElementById("k_fat").textContent = fmtBRL(fat);
    document.getElementById("k_fmd").textContent = fmtBRL(fmd);
    document.getElementById("k_des").textContent = fmtBRL(des);
    document.getElementById("k_desp").textContent= desP.toFixed(1)+"%";
    document.getElementById("k_fre").textContent = fmtBRL(fre);
    document.getElementById("k_frem").textContent= fmtBRL(freM);
    document.getElementById("k_fatl").textContent= fmtBRL(fatL);
    document.getElementById("k_fatlp").textContent= fatLP.toFixed(1)+"%";

    // deltas
    setDelta(document.getElementById("d_ped"),  ped, pedA);
    setDelta(document.getElementById("d_tkm"),  tkm, tkmA);
    setDelta(document.getElementById("d_fat"),  fat, fatA);
    setDelta(document.getElementById("d_fmd"),  fmd, fmdA);
    setDelta(document.getElementById("d_des"),  des, desA);
    setDelta(document.getElementById("d_desp"), desP, desPA);
    setDelta(document.getElementById("d_fre"),  fre, freA);
    setDelta(document.getElementById("d_frem"), freM, freMA);
    setDelta(document.getElementById("d_fatl"), fatL, fatLA);
    setDelta(document.getElementById("d_fatlp"), fatLP, fatLPA);
  }

  async function recarregar(){
    if(!maxISO || !minISO) return;
    let sISO = fde.value || "";
    let eISO = fate.value|| "";
    if(!sISO || !eISO){
      const end = parseISO(maxISO);
      const days = Number(fpr.value||30);
      const start = addDays(end, -(days-1));
      sISO = toISO(start); eISO = toISO(end);
      fde.value=sISO; fate.value=eISO;
    }
    periodoTxt.textContent = `Período: ${sISO} → ${eISO}`;

    const filtros = {
      unidade: uni.value||"Todas",
      lojas: Array.from(loja.selectedOptions||[]).map(o=>o.value),
      turno: Array.from(turno.selectedOptions||[]).map(o=>o.value),
      canal: Array.from(canal.selectedOptions||[]).map(o=>o.value),
      pag:   Array.from(pag.selectedOptions||[]).map(o=>o.value),
      canc:  (canc.value||"Todos")
    };

    const cur = await fetchPaged(sISO, eISO, filtros);

    // período anterior (mesmo número de dias imediatamente antes)
    const nDias = Math.max(1, Math.round( (parseISO(eISO)-parseISO(sISO))/(24*3600*1000) )+1);
    const prevEnd = addDays(parseISO(sISO), -1);
    const prevBeg = addDays(prevEnd, -(nDias-1));
    const ant = await fetchPaged(toISO(prevBeg), toISO(prevEnd), filtros);

    // KPIs
    updKPIs(cur, ant);

    // Linha (sombra = anterior)
    const byDay = new Map(); const byDayPrev = new Map();
    cur.forEach(r=> byDay.set(r.dia, (byDay.get(r.dia)||0)+Number(r.fat||0)));
    ant.forEach(r=> byDayPrev.set(r.dia, (byDayPrev.get(r.dia)||0)+Number(r.fat||0)));
    const labels = Array.from(byDay.keys()).sort();
    const vals   = labels.map(d=>byDay.get(d)||0);
    const prevVals = labels.map((d,i)=>{ const dd = toISO(addDays(parseISO(d), -nDias)); return byDayPrev.get(d) ?? 0; });
    drawLine(labels, vals, prevVals, lineMode);

    // Top 10 lojas para o filtro
    if((loja.options||[]).length===0){
      const m = new Map();
      cur.forEach(r=>{ const n = r[COL_LOJA]; if(!n) return; m.set(n,(m.get(n)||0)+Number(r.fat||0)); });
      const top = Array.from(m.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
      loja.innerHTML = top.map(x=>`<option>${x}</option>`).join("");
    }
  }
  const recarregarDeb = debounce(recarregar, 120);

  // ====== IMPORT CSV ======
  document.getElementById("btnImport").onclick = async ()=>{
    const f = document.getElementById("csvfile").files[0];
    if(!f){ document.getElementById("importMsg").textContent="Selecione o arquivo (Pasta2.csv)."; return; }
    const prog = document.getElementById("prog"); prog.style.display="inline-block"; prog.value=0;
    document.getElementById("importMsg").textContent="Lendo arquivo…";

    Papa.parse(f, {
      header:true, skipEmptyLines:true, dynamicTyping:false,
      complete: async (res)=>{
        const rows = res.data||[];
        if(rows.length===0){ prog.style.display="none"; document.getElementById("importMsg").textContent="Arquivo vazio."; return; }

        // normaliza colunas
        const norm = r => ({
          dia: r.dia,
          unidade: r.unidade,
          pedidos: Number(r.pedidos||0),
          fat: Number(r.fat||0),
          des: Number(r.des||0),
          fre: Number(r.fre||0),
          [COL_LOJA]: r["Nome da Loja"] ?? r["Nome da loja"] ?? null,
          turno: r.turno || null,
          "Canal de venda": r["Canal de venda"] ?? null,
          pagamento: r.pagamento ?? null,
          cancelado: r.cancelado ?? null,
          hora: r.hora===""||r.hora==null? null : Number(r.hora)
        });

        // intervalo do arquivo
        const dias = rows.map(r=>r.dia).filter(Boolean).sort();
        const beg = dias[0], end = dias[dias.length-1];

        // limpa esse intervalo
        await supa.from(TB_STAGING).delete().gte("dia", beg).lte("dia", end);

        // insere em lotes
        const tot = rows.length;
        let done=0;
        for(let i=0;i<rows.length;i+=2000){
          const slice = rows.slice(i,i+2000).map(norm);
          const ins = await supa.from(TB_STAGING).insert(slice);
          if(ins.error){ document.getElementById("importMsg").textContent="Erro: "+ins.error.message; prog.style.display="none"; return; }
          done += slice.length; prog.value = Math.round(done/tot*100);
        }
        prog.style.display="none";
        document.getElementById("importMsg").textContent="Importado.";
        ACTIVE_TABLE = TB_STAGING; // garante leitura imediata
        await detectSchema(); // re-detecta COL_LOJA se necessário
        await recarregar();
      },
      error: (err)=>{ prog.style.display="none"; document.getElementById("importMsg").textContent="Erro ao ler CSV: "+(err.message||err); }
    });
  };

  // ====== BOOT ======
  async function boot(){
    await detectSchema();
    // datas iniciais
    if(maxISO && minISO){
      const end = parseISO(maxISO);
      const start = addDays(end, -29);
      fde.value = toISO(start); fate.value = toISO(end);
    }
    await loadFiltersOptions();

    // eventos dos filtros
    [uni, loja, fde, fate, fpr, turno, canal, pag, canc].forEach(el=>{
      el.addEventListener("change", ()=>{ fx.open=false; recarregarDeb(); });
    });
    btnClear.onclick = (e)=>{ e.preventDefault(); uni.value="Todas"; loja.innerHTML=""; fde.value=""; fate.value=""; fpr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos"; recarregarDeb(); };

    // toggle Total/Média
    document.querySelectorAll('.pill[data-target="lineMode"] button').forEach(btn=>{
      btn.onclick = ()=>{ document.querySelectorAll('.pill[data-target="lineMode"] button').forEach(b=>b.classList.remove("active")); btn.classList.add("active"); lineMode=btn.dataset.val; recarregarDeb(); };
    });

    await recarregar();
  }
})();
</script>
</body>
</html>
