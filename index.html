<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — v13.3 (Supabase • antifalha)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#f6f7fb;color:#0f172a;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:#6b7280;font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-top:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .title{font-size:12px;color:#6b7280}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    select,button{height:34px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;padding:0 10px}
    button{cursor:pointer}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:240px;overflow:auto}
    canvas{display:block;width:100%;max-width:100%;height:260px}
    @media (max-width:860px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js para gráficos simples -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard Vendas — Supabase</h1>
    <div class="muted" id="build">Build v13.3 • fonte principal: public.vendas_import_csv</div>

    <div class="row">
      <div class="card" style="flex:1 1 220px">
        <div class="title">Período</div>
        <select id="selPeriodo">
          <option value="30">Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="180">Últimos 180 dias</option>
          <option value="365">Últimos 365 dias</option>
        </select>
      </div>
      <div class="card" style="flex:1 1 220px">
        <div class="title">UNIDADE</div>
        <select id="selUnidade">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="card" style="display:flex;gap:8px;align-items:flex-end">
        <button id="btnReload">Recarregar</button>
      </div>
      <div style="margin-left:auto" class="muted" id="periodo">Período: —</div>
    </div>

    <div class="grid">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Receita diária</div>
      <div id="c_daily_wrap"><canvas id="c_daily"></canvas></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

  <script>
    // ===== Credenciais (as suas) =====
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ===== Mapeamento da tabela CSV (principal) =====
    const SRC = {
      table: "vendas_import_csv",
      colDate: "data_venda_date",
      colTotal: "Total",
      colDesc: "Desconto",
      colFrete: "Entrega",
      colUnid: "Unidade"
    };

    // ===== UI helpers =====
    const $ = s => document.querySelector(s);
    const elLog = $("#log");
    function log(m){ elLog.textContent += "\n" + m; elLog.scrollTop = elLog.scrollHeight; }
    const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(+n||0);
    const fmtInt = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(+n||0));
    const toNum = v => {
      if(v==null||v==="") return 0;
      if(typeof v==="number") return v;
      const s = String(v).trim().replace(/\./g,"").replace(/,/g,".");
      const n = Number(s);
      return isFinite(n)?n:0;
    };
    const addDays = (d, delta) => { const x = new Date(d); x.setDate(x.getDate()+delta); return x; };
    const toISO = d => d.toISOString().slice(0,10);

    // ===== Carregar UNIDADES (distinct) – rápido =====
    async function loadUnidades() {
      // pega 1 dia recente para listar unidades sem custo
      const today = new Date();
      const d2 = toISO(today);
      const d1 = toISO(addDays(today,-1));
      const { data, error } = await supa
        .from(SRC.table)
        .select(SRC.colUnid)
        .gte(SRC.colDate, d1)
        .lte(SRC.colDate, d2)
        .limit(5000);
      if (error) { log(`[Unidades] erro: ${error.message}`); return; }
      const set = new Set((data||[]).map(r => r[SRC.colUnid]).filter(Boolean));
      const sel = $("#selUnidade");
      sel.innerHTML = `<option value="">Todas</option>` + [...set].sort().map(u=>`<option>${u}</option>`).join("");
      if(!sel.value) sel.value = "";
    }

    // ===== Busca paginada com antifalha =====
    async function fetchWindow(days, unidade) {
      const end = new Date();
      const start = addDays(end, -days);
      $("#periodo").textContent = `Período: ${toISO(start)} → ${toISO(end)}`;

      const page = 2000; // mais leve
      let off = 0, rows = [];
      for (;;) {
        let q = supa.from(SRC.table)
          .select(`${SRC.colDate},${SRC.colTotal},${SRC.colDesc},${SRC.colFrete},${SRC.colUnid}`)
          .gte(SRC.colDate, toISO(start))
          .lte(SRC.colDate, toISO(end))
          .range(off, off + page - 1);
        if (unidade) q = q.eq(SRC.colUnid, unidade);

        const { data, error } = await q;
        if (error) {
          // Se timeout/500, retorna sinal para quem chamou reduzir a janela
          if (error.code === "57014" || String(error.message||"").match(/timeout|500/)) {
            return { rows: null, timeout: true, err: error };
          }
          throw error;
        }
        rows = rows.concat(data||[]);
        if (!data || data.length < page) break;
        off += page;
      }
      return { rows, timeout: false };
    }

    // ===== KPIs + gráfico =====
    let chartDaily = null;
    function drawDaily(series) {
      // limpa
      if (chartDaily) { chartDaily.destroy(); chartDaily = null; }
      const ctx = document.getElementById("c_daily").getContext("2d");
      const labels = series.map(d=>d.dia);
      const values = series.map(d=>d.total);

      chartDaily = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Faturamento diário (R$)", data: values }] },
        options: {
          responsive: true,
          animation: false,
          maintainAspectRatio: false,
          scales: { y: { ticks: { callback:v=>fmtBRL(v) } } }
        }
      });
    }

    function compute(rows) {
      let ped=rows.length, fat=0, desc=0, fre=0;
      const perDia = new Map();
      for (const r of rows) {
        const dt = r[SRC.colDate];
        const t  = toNum(r[SRC.colTotal]);
        const d  = toNum(r[SRC.colDesc]);
        const f  = toNum(r[SRC.colFrete]);
        fat+=t; desc+=d; fre+=f;
        const key = String(dt).slice(0,10);
        perDia.set(key, (perDia.get(key)||0) + t);
      }
      const series = [...perDia.entries()].sort(([a],[b]) => a.localeCompare(b)).map(([dia,total])=>({dia,total}));
      return { ped, fat, desc, fre, series };
    }

    async function go() {
      try {
        const unidade = $("#selUnidade").value || "";
        const days0 = parseInt($("#selPeriodo").value,10)||30;
        log(`[Query] Fonte: ${SRC.table} | janela ${days0}d | UNIDADE=${unidade||"Todas"}`);

        // tenta janela pedida; se der timeout, reduz (30→21→14→7)
        const tries = [days0, Math.max(21, Math.floor(days0*0.7)), 14, 7];
        let rows = null, lastErr = null;
        for (const dd of tries) {
          const res = await fetchWindow(dd, unidade);
          if (!res.timeout) { rows = res.rows; break; }
          lastErr = res.err;
          log(`[Warn] Timeout com ${dd} dias — reduzindo janela…`);
        }
        if (!rows) {
          throw lastErr || new Error("Sem dados por timeout.");
        }

        const { ped, fat, desc, fre, series } = compute(rows);
        $("#k_ped").textContent = fmtInt(ped);
        $("#k_fat").textContent = fmtBRL(fat);
        $("#k_desc").textContent = fmtBRL(desc);
        $("#k_fre").textContent = fmtBRL(fre);
        drawDaily(series);
        log(`[OK] Linhas: ${rows.length.toLocaleString("pt-BR")} • KPIs atualizados.`);
      } catch (e) {
        log(`[ERRO] ${e.message||e}`);
      }
    }

    // ===== boot =====
    (async function init(){
      log("[Boot] v13.3 — antifalha (paginação 2k + redução de janela em timeout)");
      await loadUnidades(); // preenche dropdown
      $("#btnReload").onclick = go;
      $("#selPeriodo").onchange = go;
      $("#selUnidade").onchange = go;
      go(); // primeira carga
    })();
  </script>
</body>
</html>
