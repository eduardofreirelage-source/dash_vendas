<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food â€” KPIs + Importador v0.9</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="28" fill="%232ea779"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">MF</text></svg>'/>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--text:#0f172a;--acc:#2563eb;--border:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1180px;margin:16px auto 64px;padding:0 16px}
  h1{font-size:22px;margin:6px 0 4px}
  .muted{color:var(--muted)}
  .row{display:grid;gap:12px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111827}
  .btn{background:var(--acc);border:1px solid var(--acc);color:#fff;cursor:pointer}
  .btn.ghost{background:#e9eef6;color:#0f172a;border-color:var(--border)}
  .kpi{display:flex;align-items:flex-end;gap:8px}
  .kpi b{font-size:30px}
  .title{font-size:16px;margin-bottom:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:8px 10px;text-align:left}
  th{background:#f2f5fa}
  canvas{background:#fff;border:1px solid var(--border);border-radius:12px}
  .right{text-align:right}
  pre{white-space:pre-wrap;background:#0f172a;color:#d6e3ff;border-radius:10px;padding:10px;overflow:auto;border:1px solid #23304a}
  .progress{height:10px;background:#0f172a;border:1px solid #23304a;border-radius:999px;overflow:hidden}
  .bar{height:10px;background:#22c55e;width:0%}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
  .tabs{display:flex;gap:8px;margin:8px 0 14px}
  .tabbtn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .tabbtn.active{background:#1f2937;color:#fff;border-color:#1f2937}
  .hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <h1>Maestro Food â€” KPIs + Importador <span class="muted">v0.9</span></h1>
  <div class="tabs">
    <button id="btnTabDash" class="tabbtn active">ðŸ“ˆ Dashboard</button>
    <button id="btnTabImp" class="tabbtn">ðŸ“¤ Importador (upload diÃ¡rio)</button>
  </div>

  <!-- DASHBOARD -->
  <section id="tabDash">
    <div class="muted">PerÃ­odo: <span id="periodo">â€”</span></div>
    <div class="card">
      <div class="row cols-4">
        <div>
          <label>PerÃ­odo rÃ¡pido</label>
          <select id="quick">
            <option value="30">Ãšltimos 30</option>
            <option value="7">Ãšltimos 7</option>
            <option value="14">Ãšltimos 14</option>
            <option value="mes">MÃªs atual</option>
            <option value="ano">Ano atual</option>
          </select>
        </div>
        <div><label>De</label><input id="dini" type="date"/></div>
        <div><label>AtÃ©</label><input id="dfim" type="date"/></div>
        <div><label>&nbsp;</label><button id="btnApply" class="btn">Aplicar</button></div>
      </div>
      <div class="row cols-4" style="margin-top:10px">
        <div><label>Unidade</label><input id="unidade" placeholder="ex.: Uni.Raja"/></div>
        <div><label>Nome da loja</label><input id="loja" placeholder="contÃ©mâ€¦"/></div>
        <div><label>Cancelado?</label>
          <select id="cancelado"><option value="">Todos</option><option value="NÃ£o">NÃ£o</option><option value="Sim">Sim</option></select>
        </div>
        <div><label>Pagamento (exato)</label><input id="pagamento" placeholder="CrÃ©dito, Pago Onlineâ€¦"/></div>
      </div>
      <div class="row cols-2" style="margin-top:10px">
        <div><label>Canal (exato)</label><input id="canal" placeholder="iFood, Telefone, VideoSoftâ€¦"/></div>
        <div class="muted">Fonte: <code>vendas_xlsx</code> Â· RPCs: <code>kpi_vendas</code>, <code>resumo_vendas</code>, <code>amostra_vendas</code>, <code>top_dups_vendas</code></div>
      </div>
    </div>

    <div class="row cols-4" style="margin-top:12px">
      <div class="card"><div class="title">Pedidos</div><div class="kpi"><b id="k_ped">0</b></div></div>
      <div class="card"><div class="title">Faturamento</div><div class="kpi"><b id="k_fat">R$ 0,00</b></div></div>
      <div class="card"><div class="title">Ticket MÃ©dio</div><div class="kpi"><b id="k_tkt">R$ 0,00</b><span class="muted">(fat/pedidos)</span></div></div>
      <div class="card"><div class="title">Faturamento LÃ­quido</div><div class="kpi"><b id="k_liq">R$ 0,00</b><span class="muted">(fat âˆ’ des)</span></div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">Resumo das linhas filtradas (Bruta Ã— CanÃ´nica)</div>
      <table>
        <thead><tr><th>Linhas brutas</th><th>Linhas Ãºnicas (dedupe)</th><th>Duplicatas descartadas</th><th>% duplicatas</th></tr></thead>
        <tbody id="tbResumo"><tr><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td></tr></tbody>
      </table>
    </div>

    <div class="row cols-2" style="margin-top:12px">
      <div class="card">
        <div class="title">Receita diÃ¡ria</div>
        <canvas id="chart" height="120"></canvas>
        <div class="muted" id="pontos" style="margin-top:4px">Pontos: 0</div>
      </div>
      <div class="card">
        <div class="title">Amostra filtrada (atÃ© 10)</div>
        <pre id="amostra">(vazio)</pre>
        <div class="row cols-2">
          <button id="btnDups" class="btn">Ver duplicatas (top 30)</button><div></div>
        </div>
        <div class="title" style="margin-top:10px">Duplicatas (hash â†’ ocorrÃªncias)</div>
        <pre id="dups">(vazio)</pre>
      </div>
    </div>
  </section>

  <!-- IMPORTADOR -->
  <section id="tabImp" class="hidden">
    <div class="muted">LÃª Excel, separa <b>dia/hora</b>, valida e grava com <b>UPSERT</b> (idempotente por <code>row_key</code>) em <code>public.vendas_xlsx</code>.</div>

    <div class="card">
      <div class="row cols-2">
        <div><label>Arquivo XLSX</label><input id="file" type="file" accept=".xlsx"/></div>
        <div><label>Aba (sheet)</label><select id="sheet"></select></div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <button id="btnRead" class="btn">1) Ler planilha</button>
        <button id="btnSend" class="btn">2) Enviar ao Supabase (UPSERT)</button>
        <button id="btnHealth" class="btn ghost">Healthcheck</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div id="status" class="muted status" style="margin-top:6px;">Pronto.</div>
      </div>
    </div>

    <div class="card"><div class="title">Mapeamento detectado</div><pre id="mapping">(vazio)</pre></div>
    <div class="card"><div class="title">RelatÃ³rio de validaÃ§Ã£o</div><pre id="report">(vazio)</pre></div>
    <div class="card"><div class="title">Preview (atÃ© 10 linhas vÃ¡lidas)</div><pre id="preview">(vazio)</pre></div>
    <div class="card"><div class="title">Healthcheck do banco</div><pre id="health">(clique em Healthcheck)</pre></div>
  </section>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const TABLE = 'vendas_xlsx';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ====== DOM ====== */
const $ = (id)=>document.getElementById(id);
/* dashboard */
const quick=$('quick'), dini=$('dini'), dfim=$('dfim'), periodo=$('periodo');
const unidade=$('unidade'), loja=$('loja'), cancelado=$('cancelado'), pagamento=$('pagamento'), canal=$('canal');
const k_ped=$('k_ped'), k_fat=$('k_fat'), k_tkt=$('k_tkt'), k_liq=$('k_liq'), pontos=$('pontos'), amostra=$('amostra'), dups=$('dups');
/* importador */
const file=$('file'), sheetSel=$('sheet'), btnRead=$('btnRead'), btnSend=$('btnSend'), btnHealth=$('btnHealth');
const mappingEl=$('mapping'), reportEl=$('report'), previewEl=$('preview'), healthEl=$('health'), statusEl=$('status'), bar=$('bar');

/* ====== TABS ====== */
const tabDash=$('tabDash'), tabImp=$('tabImp'), btnTabDash=$('btnTabDash'), btnTabImp=$('btnTabImp');
btnTabDash.onclick=()=>{tabDash.classList.remove('hidden');tabImp.classList.add('hidden');btnTabDash.classList.add('active');btnTabImp.classList.remove('active');};
btnTabImp.onclick =()=>{tabImp.classList.remove('hidden');tabDash.classList.add('hidden');btnTabImp.classList.add('active');btnTabDash.classList.remove('active');};

/* ====== UTILS ====== */
const brl = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
function fmtBRL(n){return brl.format(n||0)}
function todayISO(d=new Date()){d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function addDays(iso,delta){const d=new Date(iso);d.setDate(d.getDate()+delta);return d.toISOString().slice(0,10)}
const norm=(s)=>String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
const onlyDateISO=(iso)=> iso && iso.length>=10 ? iso.slice(0,10) : null;

/* Excel serial -> Date */
function excelSerialToDate(n){
  if(!isFinite(n)) return null;
  // Excel epoch 1899-12-30
  const ms = Math.round((n - 25569) * 86400 * 1000);
  return new Date(ms);
}

/* Parsing robusto de Data/Hora */
function parseDateLike(v){
  if(v==null || v==='') return {iso:null, dia:null, hora:-1};

  // 1) Date object
  if(Object.prototype.toString.call(v)==='[object Date]' && !isNaN(v)) {
    const d = new Date(v.getTime());
    const iso = d.toISOString().slice(0,19);
    return {iso, dia:onlyDateISO(iso), hora:d.getHours()};
  }

  // 2) Number (serial Excel)
  if(typeof v==='number'){
    const d=excelSerialToDate(v);
    if(d){
      const iso=d.toISOString().slice(0,19);
      return {iso, dia:onlyDateISO(iso), hora:d.getHours()};
    }
  }

  // 3) String dd/mm/aaaa hh:mm | dd/mm/aaaa
  const s=String(v).trim();
  const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
  if(m){
    const d=m[1].padStart(2,'0'), M=m[2].padStart(2,'0'), y=m[3];
    const hh = m[4]? m[4].padStart(2,'0') : '00';
    const mm = m[5]? m[5] : '00';
    const iso = `${y}-${M}-${d}T${hh}:${mm}:00`;
    return {iso, dia:`${y}-${M}-${d}`, hora:parseInt(hh,10)};
  }

  // 4) ISO yyyy-mm-dd[Thh:mm]
  if(/^\d{4}-\d{2}-\d{2}/.test(s)){
    const iso = s.length>10 ? s.slice(0,19) : (s+'T00:00:00');
    const hh = (iso.match(/T(\d{2}):/)||[])[1];
    return {iso, dia:onlyDateISO(iso), hora: hh? parseInt(hh,10) : 0};
  }

  // 5) Tenta Date(navegador)
  const d2=new Date(s);
  if(!isNaN(d2)){
    const iso=d2.toISOString().slice(0,19);
    return {iso, dia:onlyDateISO(iso), hora:d2.getHours()};
  }

  return {iso:null, dia:null, hora:-1};
}

function parseMoney(v){
  if(v==null||v==='') return 0;
  if(typeof v==='number') return v;
  let s=String(v).trim();
  // trata "(123,45)" como negativo
  if(/^\(.*\)$/.test(s)){ s='-'+s.replace(/[()]/g,''); }
  s=s.replace(/[^0-9,.\-]/g,'');
  const lastComma=s.lastIndexOf(','), lastDot=s.lastIndexOf('.');
  if(lastComma>lastDot){ s=s.replace(/\./g,'').replace(',','.'); } else { s=s.replace(/,/g,''); }
  const n=Number(s); return isFinite(n)? n:0;
}
function turnoFromHour(h){
  if(h<0) return null;
  if(h>=6 && h<12) return 'Dia';
  if(h>=12 && h<18) return 'Dia';
  if(h>=18 && h<24) return 'Noite';
  return 'Madrugada';
}
function normCancel(v){const s=norm(v); return (v===true||s==='sim'||s==='s'||s==='1'||s==='true')?'Sim':'NÃ£o';}
function pagamentoBase(p){const s=String(p??'').split(',')[0].trim(); return s||null;}
function setStatus(txt, cls){statusEl.textContent=txt; statusEl.className='muted status'+(cls?(' '+cls):'');}
function setBar(pct){bar.style.width=Math.max(0,Math.min(100,pct))+'%';}

/* ====== DASHBOARD ====== */
function applyQuick(){
  const now=todayISO(); let start,end=now;
  if(quick.value==='mes'){const d=new Date(); const y=d.getFullYear(), m=d.getMonth(); start=new Date(y,m,1).toISOString().slice(0,10);}
  else if(quick.value==='ano'){const d=new Date(); const y=d.getFullYear(); start=new Date(y,0,1).toISOString().slice(0,10);}
  else {const n=parseInt(quick.value,10)||30; start=addDays(now,-(n-1));}
  dini.value=start; dfim.value=end;
}
function params(){
  const p_dini=dini.value||todayISO(), p_dfim=dfim.value||p_dini;
  const p_unids=unidade.value?[unidade.value]:null;
  const p_canais=canal.value?[canal.value]:null;
  const p_pags=pagamento.value?[pagamento.value]:null;
  const p_loja=loja.value||null;
  const p_cancelado=cancelado.value||null;
  periodo.textContent=p_dini+' â†’ '+p_dfim;
  return {p_dini,p_dfim,p_unids,p_canais,p_pags,p_loja,p_cancelado};
}
let chart;
function renderChart(labels, values){
  if(chart) chart.destroy();
  const ctx=document.getElementById('chart');
  chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Receita',data:values,tension:.25}]},options:{responsive:true,scales:{y:{ticks:{callback:v=>fmtBRL(v).replace('R$','')}}}}});
  pontos.textContent='Pontos: '+values.length;
}
async function loadResumo(){
  const args=params(); const {data,error}=await supa.rpc('resumo_vendas',args);
  const el=$('tbResumo');
  if(error){console.error(error);el.innerHTML='<tr><td colspan="4">Erro no resumo</td></tr>';return;}
  const r=(data&&data[0])||{brutas:0,canon:0,duplicatas:0,perc_dup:0};
  el.innerHTML=`<tr>
    <td class="right">${Number(r.brutas||0).toLocaleString('pt-BR')}</td>
    <td class="right">${Number(r.canon||0).toLocaleString('pt-BR')}</td>
    <td class="right">${Number(r.duplicatas||0).toLocaleString('pt-BR')}</td>
    <td class="right">${Number(r.perc_dup||0).toLocaleString('pt-BR')}%</td>
  </tr>`;
}
async function loadAmostra(){
  const args=params(); const r=await supa.rpc('amostra_vendas',args);
  amostra.textContent = r.error ? JSON.stringify(r.error,null,2) : JSON.stringify(r.data||[],null,2);
}
async function loadKPIs(){
  const args=params(); const {data,error}=await supa.rpc('kpi_vendas',args);
  if(error){console.error(error);alert('Erro ao carregar KPIs');return;}
  let pedidos=0,fat=0,des=0; const labels=[],values=[];
  (data||[]).forEach(r=>{pedidos+=Number(r.pedidos||0); fat+=Number(r.fat||0); des+=Number(r.des||0); labels.push(String(r.dia)); values.push(Number(r.fat||0));});
  const tkt=pedidos>0?(fat/pedidos):0, liq=fat-des;
  k_ped.textContent=pedidos.toLocaleString('pt-BR'); k_fat.textContent=fmtBRL(fat); k_tkt.textContent=fmtBRL(tkt); k_liq.textContent=fmtBRL(liq);
  renderChart(labels,values);
}
async function loadDups(){ const args=params(); const r=await supa.rpc('top_dups_vendas',{...args,p_limit:30}); dups.textContent=r.error?JSON.stringify(r.error,null,2):JSON.stringify(r.data||[],null,2); }
async function aplicar(){ await loadKPIs(); await loadResumo(); await loadAmostra(); dups.textContent='(clique em "Ver duplicatas" para listar)'; }
document.getElementById('btnApply').addEventListener('click',aplicar);
document.getElementById('btnDups').addEventListener('click',loadDups);
quick.addEventListener('change',()=>{applyQuick();aplicar();});

/* ====== IMPORTADOR ====== */
/* Header map com mais sinÃ´nimos */
function buildHeaderMap(cols){
  const dict=[
    {std:'dia_src', list:['data','data da venda','dt venda','dt_venda','dia']},
    {std:'unidade', list:['unidade','codigo da loja','cÃ³digo da loja','cod loja','cod_loja','filial']},
    {std:'Nome da loja', list:['nome da loja','loja','nome_loja']},
    {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda']},
    {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento']},
    {std:'des', list:['desconto','des']},
    {std:'fre', list:['entrega','frete','valor entregador','taxa de entrega']},
    {std:'fat', list:['total','valor total','faturamento','total taxa de serviÃ§o + total?','vl total','valor']},
    {std:'cancelado', list:['esta cancelado','estÃ¡ cancelado','cancelado']},
    {std:'turno', list:['turno']},
    {std:'pedido_id', list:['pedido','numero do pedido','nÃºmero do pedido','numero do pedido no parceiro','nÃºmero do pedido no parceiro','id pedido','pedido_id']}
  ];
  const out={}, lower=cols.map(c=>({orig:c,key:norm(c)}));
  for(const d of dict){ for(const cand of d.list){ const hit=lower.find(x=>x.key===cand); if(hit){ out[d.std]=hit.orig; break; } } }
  const required=['dia_src','unidade','fat']; const missing=required.filter(k=>!out[k]);
  return {map:out, missing};
}

/* Ler XLSX */
file.addEventListener('change', async ()=>{
  sheetSel.innerHTML=''; mappingEl.textContent='(vazio)'; reportEl.textContent='(vazio)'; previewEl.textContent='(vazio)';
  setStatus('Lendo arquivoâ€¦'); setBar(0);
  const f=file.files?.[0]; if(!f){setStatus('Selecione um .xlsx','warn'); return;}
  try{
    const buf=await f.arrayBuffer();
    // Habilita cellDates para tentar trazer Date; o fallback cuida do resto
    const wb=XLSX.read(buf,{cellDates:true, cellText:false});
    const names=wb.SheetNames||[];
    if(!names.length){setStatus('XLSX sem abas.','err'); return;}
    window.__wb = wb; // guarda para uso
    sheetSel.innerHTML=names.map(n=>`<option>${n}</option>`).join('');
    // escolhe a aba com mais linhas
    let best=names[0], max=-1;
    for(const name of names){
      const sh=wb.Sheets[name]; const json=XLSX.utils.sheet_to_json(sh,{defval:'', raw:true});
      if(json.length>max){max=json.length; best=name;}
    }
    sheetSel.value=best; setStatus(`Arquivo carregado. ${names.length} abas. Selecionada: ${best}.`,'ok');
  }catch(e){console.error(e); setStatus('Falha ao ler XLSX.','err');}
});

let rowsRaw=[], rowsValid=[];
btnRead.addEventListener('click', ()=>{
  const wb=window.__wb; if(!wb){setStatus('Carregue o .xlsx primeiro.','warn'); return;}
  const name=sheetSel.value||wb.SheetNames[0]; const sh=wb.Sheets[name];
  const json=XLSX.utils.sheet_to_json(sh,{defval:'', raw:true}); rowsRaw=json;
  if(rowsRaw.length===0){setStatus('Nada para importar (planilha vazia).','warn'); reportEl.textContent=JSON.stringify({linhas:0},null,2); return;}
  const cols=Object.keys(rowsRaw[0]||{}); const hm=buildHeaderMap(cols); const headerMap=hm.map; window.__headerMap=headerMap;
  mappingEl.textContent=JSON.stringify({detectado:headerMap,faltando:hm.missing},null,2);
  if(hm.missing.length){setStatus('Faltam colunas obrigatÃ³rias: '+hm.missing.join(', '),'err'); return;}
  processRows();
});

function processRows(){
  rowsValid=[]; const headerMap=window.__headerMap;
  let invalid=0; const reasons={sem_dia:0,sem_unidade:0,fat_invalido:0,excecao:0};
  let i=0;
  for(const r of rowsRaw){ i++;
    try{
      const dlike = r[headerMap.dia_src];
      const {iso,dia,hora} = parseDateLike(dlike);
      const unidade = r[headerMap.unidade]?String(r[headerMap.unidade]).trim():'';
      const loja = r[headerMap['Nome da loja']]||null;
      const canal = r[headerMap['Canal de venda']]||null;
      const pagamento = r[headerMap['pagamento']]||null;
      const des = parseMoney(r[headerMap['des']]);
      const fre = parseMoney(r[headerMap['fre']]);
      const fat = parseMoney(r[headerMap['fat']]);
      const cancelado = normCancel(r[headerMap['cancelado']]);
      const turno = r[headerMap['turno']] || turnoFromHour(hora);
      const pedidoId = r[headerMap['pedido_id']] || null;

      if(!dia){ invalid++; reasons.sem_dia++; continue; }
      if(!unidade){ invalid++; reasons.sem_unidade++; continue; }
      if(!isFinite(fat)){ invalid++; reasons.fat_invalido++; continue; }

      const pagaBase = pagamentoBase(pagamento);
      const rk=[dia,unidade,(loja||''),(isFinite(hora)?hora:-1),(pagaBase||''),(canal||''),(pedidoId||'')].join('|');

      rowsValid.push({
        dia, hora:isFinite(hora)?hora:-1, turno:turno||null, unidade,
        "Nome da loja": loja, "Canal de venda": canal,
        pagamento: pagamento, pagamento_base: pagaBase||null,
        cancelado, pedidos:1, fat, des, fre, pedido_id:pedidoId, row_key: rk
      });
    }catch(e){ invalid++; reasons.excecao++; }
  }

  const rep = {
    'Linhas na planilha': rowsRaw.length,
    'VÃ¡lidas (importÃ¡veis)': rowsValid.length,
    'InvÃ¡lidas/ignoradas': invalid,
    'Motivos (top)': reasons
  };
  reportEl.textContent = JSON.stringify(rep, null, 2);
  previewEl.textContent = JSON.stringify(rowsValid.slice(0,10), null, 2);
  setStatus(rowsValid.length?'ValidaÃ§Ã£o OK. Pronto para enviar.':'Nada para importar (tudo invÃ¡lido).', rowsValid.length?'ok':'warn');
}

/* ENVIAR (UPSERT por row_key) */
btnSend.addEventListener('click', async ()=>{
  if(rowsValid.length===0){setStatus('Nada vÃ¡lido para enviar.','warn'); return;}
  setStatus('Iniciando envio (UPSERT)â€¦'); setBar(0);
  const chunk=1000; let sent=0, errs=0;
  for(let i=0;i<rowsValid.length;i+=chunk){
    const batch=rowsValid.slice(i,i+chunk);
    const ins=await supa.from(TABLE).upsert(batch,{onConflict:'row_key', ignoreDuplicates:true});
    if(ins.error){console.error(ins.error); errs += batch.length;} else { sent += batch.length; }
    setBar(((i+batch.length)/rowsValid.length)*100);
    setStatus(`Processado ${i+batch.length}/${rowsValid.length} Â· enviados ${sent} Â· erros ${errs}`, errs?'warn':'muted');
    await new Promise(r=>setTimeout(r,15));
  }
  setStatus(`ConcluÃ­do. Processadas ${rowsValid.length}. Erros ${errs}.`, errs?'warn':'ok');
});

/* HEALTHCHECK */
btnHealth.addEventListener('click', async ()=>{
  healthEl.textContent='Consultandoâ€¦';
  const a=await supa.from(TABLE).select('dia',{head:false}).order('dia',{ascending:true}).limit(1);
  const b=await supa.from(TABLE).select('dia',{head:false}).order('dia',{ascending:false}).limit(1);
  const c=await supa.from(TABLE).select('count',{count:'exact',head:true});
  if(a.error||b.error){healthEl.textContent=JSON.stringify({error_a:a.error,error_b:b.error},null,2); return;}
  const min=a.data?.[0]?.dia||null, max=b.data?.[0]?.dia||null, total=c.count??null;
  healthEl.textContent=JSON.stringify({tabela:TABLE, intervalo:{min_dia:min,max_dia:max}, total},null,2);
});

/* INIT */
function applyQuick(){const now=todayISO();let start,end=now;if(quick.value==='mes'){const d=new Date();const y=d.getFullYear(),m=d.getMonth();start=new Date(y,m,1).toISOString().slice(0,10);}else if(quick.value==='ano'){const d=new Date();const y=d.getFullYear();start=new Date(y,0,1).toISOString().slice(0,10);}else{const n=parseInt(quick.value,10)||30;start=addDays(now,-(n-1));}dini.value=start;dfim.value=end;}
function init(){applyQuick();aplicar();}
init();
</script>
</body>
</html>
