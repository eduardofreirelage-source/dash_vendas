<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DASHBOARD — CFO (v2.31 • fallback total a views)</title>
  <style>
    :root{ --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#2f6ef7; --ok:#10b981; --chip:#eef2ff; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:26px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0}
    .row{display:grid;gap:12px}
    .cols-3{grid-template-columns:repeat(3,1fr)} .cols-2{grid-template-columns:repeat(2,1fr)}
    input[type="date"], .msel-btn{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
    .chip{padding:8px 0;border:1px solid var(--line);border-radius:10px;background:var(--chip);font-weight:700;cursor:pointer;text-align:center}
    .chip.active{background:var(--pri);border-color:var(--pri);color:#fff}
    .muted{color:var(--muted);font-size:12px}
    .msel{position:relative} .msel-btn{cursor:pointer;text-align:left} .msel-btn:after{content:"▾";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
    .msel-opt:hover{background:#f3f4f6}
    .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
    .kpi .val{font-size:22px;font-weight:800} .kpi .sub{font-size:12px;color:#667085}
    .delta{margin-left:10px;border:1px solid var(--line);border-radius:999px;padding:2px 10px;font-weight:800;font-size:12px}
    .delta.up{color:#10b981;border-color:#86efac} .delta.down{color:#ef4444;border-color:#fecaca} .delta.flat{color:#64748b}
    .chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px}
    .chart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:700}
    .seg button.active{background:var(--pri);color:#fff}
    .chart-box{height:260px}
    .chart-box canvas{display:block;width:100% !important;height:100% !important}
    @media (max-width:1024px){ .cols-3{grid-template-columns:repeat(2,1fr)} .cols-2{grid-template-columns:1fr} .krow{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .cols-3{grid-template-columns:1fr} .krow{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>DASHBOARD</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnUpload" class="btn">📤 Carregar Excel</button>
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
        <button id="btnClear" class="btn">✖ Limpar filtros</button>
      </div>
    </div>

    <div class="section">
      <div class="row cols-3">
        <div><div class="muted">Início</div><input type="date" id="fDe"></div>
        <div><div class="muted">Fim</div><input type="date" id="fAte"></div>
        <div>
          <div class="muted">Período rápido</div>
          <div class="chips">
            <button class="chip" data-q="7">07</button>
            <button class="chip" data-q="15">15</button>
            <button class="chip active" data-q="30">30</button>
            <button class="chip" data-q="60">60</button>
            <button class="chip" data-q="90">90</button>
            <button class="chip" data-q="120">120</button>
          </div>
          <div id="periodoInfo" class="muted" style="margin-top:6px">—</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">Filtros</div>
        <div><span id="status" class="muted">—</span> <span id="diag" class="muted" style="margin-left:8px"></span></div>
      </div>
      <div class="row cols-3">
        <div><div class="muted">Unidade</div><div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div></div>
        <div><div class="muted">Nome da Loja</div><div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div></div>
        <div><div class="muted">Turno</div><div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div></div>
      </div>
      <div class="row cols-3" style="margin-top:10px">
        <div><div class="muted">Canal</div><div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div></div>
        <div><div class="muted">Tipo de Pagamento</div><div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div></div>
        <div>
          <div class="muted">Cancelado</div>
          <div id="ms-cancel" class="msel">
            <button class="msel-btn">Não</button>
            <div class="msel-panel">
              <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
              <div class="msel-opt"><input type="checkbox" value="Não" checked><label>Não</label></div>
              <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="krow">
      <div class="kpi"><h4>Pedidos <span id="d_ped" class="delta flat">—</span></h4><div class="val" id="k_ped">—</div><div class="sub">Anterior: <span id="p_ped">—</span></div></div>
      <div class="kpi"><h4>Ticket Médio <span id="d_tkt" class="delta flat">—</span></h4><div class="val" id="k_tkt">—</div><div class="sub">Anterior: <span id="p_tkt">—</span></div></div>
      <div class="kpi"><h4>Faturamento <span id="d_fat" class="delta flat">—</span></h4><div class="val" id="k_fat">—</div><div class="sub">Anterior: <span id="p_fat">—</span></div></div>
    </div>
    <div class="krow" style="margin-top:10px">
      <div class="kpi"><h4>Faturamento Médio <span id="d_fatmed" class="delta flat">—</span></h4><div class="val" id="k_fatmed">—</div><div class="sub">Anterior: <span id="p_fatmed">—</span></div></div>
      <div class="kpi"><h4>Incentivos <span id="d_des" class="delta flat">—</span></h4><div class="val" id="k_des">—</div><div class="sub">Anterior: <span id="p_des">—</span></div></div>
      <div class="kpi"><h4>% de Incentivos <span id="d_desperc" class="delta flat">—</span></h4><div class="val" id="k_desperc">—</div><div class="sub">Anterior: <span id="p_desperc">—</span></div></div>
    </div>
    <div class="krow" style="margin-top:10px">
      <div class="kpi"><h4>Frete <span id="d_fre" class="delta flat">—</span></h4><div class="val" id="k_fre">—</div><div class="sub">Anterior: <span id="p_fre">—</span></div></div>
      <div class="kpi"><h4>Frete Médio <span id="d_fremed" class="delta flat">—</span></h4><div class="val" id="k_fremed">—</div><div class="sub">Anterior: <span id="p_fremed">—</span></div></div>
      <div class="kpi"><h4>Pedidos Cancelados <span id="d_canc_ped" class="delta flat">—</span></h4><div class="val" id="k_canc_ped">—</div><div class="sub">Part.: <span id="k_canc_part">—</span> (Ant.: <span id="p_canc_part">—</span>)</div></div>
    </div>
    <div class="krow" style="margin-top:10px">
      <div class="kpi"><h4>Valor de Cancelados <span id="d_canc_val" class="delta flat">—</span></h4><div class="val" id="k_canc_val">—</div><div class="sub">Anterior: <span id="p_canc_val">—</span></div></div>
      <div class="kpi"><h4>ROI <span id="d_roi" class="delta flat">—</span></h4><div class="val" id="k_roi">—</div><div class="sub">Anterior: <span id="p_roi">—</span></div></div>
      <div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="section">
      <div class="row cols-2">
        <div class="chart-card">
          <div class="chart-head"><div class="muted">Vendas por dia da semana</div>
            <div class="seg" data-chart="dow"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">Média</button></div>
          </div><div class="chart-box"><canvas id="ch_dow"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-head"><div class="muted">Vendas por mês</div>
            <div class="seg" data-chart="month"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">Média</button></div>
          </div><div class="chart-box"><canvas id="ch_month"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-head"><div class="muted">Vendas por hora</div>
            <div class="seg" data-chart="hour"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">Média</button></div>
          </div><div class="chart-box"><canvas id="ch_hour"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-head"><div class="muted">Vendas por turno</div>
            <div class="seg" data-chart="turno"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">Média</button></div>
          </div><div class="chart-box"><canvas id="ch_turno"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
  <!-- app -->
  <script defer src="./app.js"></script>
</body>
</html>
