<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Uploader Vendas + Smoke Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon embutido -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' fill='%230b5'/%3E%3Ctext x='50%25' y='55%25' font-size='36' text-anchor='middle' fill='white'%3E✓%3C/text%3E%3C/svg%3E" />
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <!-- Supabase -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 18px; }
    h1 { margin-bottom: 8px; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    legend { padding: 0 6px; color: #444; }
    label { display:block; font-size: 12px; color: #555; margin-top: 6px; }
    select, input[type="text"], input[type="date"], button { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .col { min-width: 220px; flex: 1; }
    #log { white-space: pre-wrap; background:#0b1220; color:#d7e1ff; padding:12px; border-radius:8px; max-height: 360px; overflow:auto; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef; margin-right:6px; font-size:12px; }
    .ok { color:#0a0; }
    .warn { color:#a60; }
    .err { color:#c00; }
    .btn { background:#0b5; color:#fff; border:none; cursor:pointer; padding:8px 12px; border-radius:6px; }
    .btn-secondary { background:#456; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <h1>Uploader & Debug (Supabase)</h1>

  <fieldset>
    <legend>Supabase</legend>
    <div class="row">
      <div class="col">
        <label>URL</label>
        <input id="url" type="text" value="https://uahmcfzerofhzjvlzrqc.supabase.co" />
      </div>
      <div class="col">
        <label>Anon key</label>
        <input id="key" type="text" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" />
      </div>
      <div class="col" style="align-self:end">
        <button id="btnPing" class="btn">Testar conexão</button>
      </div>
    </div>
    <div id="connBadge" class="pill"></div>
  </fieldset>

  <fieldset>
    <legend>Upload Excel</legend>
    <div class="row">
      <div class="col">
        <input id="file" type="file" accept=".xlsx,.xls" />
      </div>
      <div class="col">
        <button id="btnRead" class="btn">Ler arquivo</button>
      </div>
      <div class="col">
        <span id="fileInfo" class="pill"></span>
      </div>
    </div>

    <div class="row">
      <div class="col"><label>Coluna com Data+Hora (opcional)</label><select id="m_datahora"></select></div>
      <div class="col"><label>Data (yyyy-mm-dd)</label><select id="m_data_venda"></select></div>
      <div class="col"><label>Hora (0–23)</label><select id="m_hora"></select></div>
      <div class="col"><label>Unidade</label><select id="m_unidade"></select></div>
      <div class="col"><label><b>Loja</b></label><select id="m_loja"></select></div>
      <div class="col"><label>Canal</label><select id="m_canal"></select></div>
      <div class="col"><label>Cancelado (Sim/Não/true/false)</label><select id="m_cancelado"></select></div>
      <div class="col"><label>Itens</label><select id="m_itens"></select></div>
      <div class="col"><label>Total</label><select id="m_total"></select></div>
      <div class="col"><label>Desconto</label><select id="m_des"></select></div>
      <div class="col"><label>Frete</label><select id="m_fre"></select></div>
      <div class="col"><label>Turno</label><select id="m_turno"></select></div>
      <div class="col"><label>Pagamento</label><select id="m_pagamento"></select></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><button id="btnPreview" class="btn btn-secondary">Validar & Prévia (5 linhas)</button></div>
      <div class="col"><button id="btnInsert" class="btn">Inserir no banco (lotes de 2.000)</button></div>
      <div class="col"><span id="insInfo" class="pill"></span></div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Smoke tests</legend>
    <div class="row">
      <div class="col"><label>Data inicial</label><input type="date" id="dini" /></div>
      <div class="col"><label>Data final</label><input type="date" id="dfim" /></div>
      <div class="col" style="align-self:end"><button id="btnAutoRange" class="btn btn-secondary">Usar min/max</button></div>
      <div class="col" style="align-self:end"><button id="btnSmoke" class="btn">Rodar smoke test</button></div>
    </div>
    <div id="smk" class="pill"></div>
  </fieldset>

  <fieldset>
    <legend>Debug</legend>
    <pre id="log"></pre>
  </fieldset>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

  const $ = (sel) => document.querySelector(sel);
  function log() {
    const el = $("#log");
    const parts = [];
    for (let i=0;i<arguments.length;i++) {
      const v = arguments[i];
      parts.push(typeof v === 'string' ? v : JSON.stringify(v, null, 2));
    }
    el.textContent += parts.join(' ') + "\n";
    el.scrollTop = el.scrollHeight;
  }
  const setPill = (id, txt, cls) => { const el=$(id); el.textContent = txt||''; el.className = 'pill ' + (cls||''); };

  let SUPA = null;
  let rows = [];

  const selects = ["m_datahora","m_data_venda","m_hora","m_unidade","m_loja","m_canal","m_cancelado","m_itens","m_total","m_des","m_fre","m_turno","m_pagamento"];

  function sanitizeHeader(k) {
    return String(k).replace(/\s+/g,' ').trim();
  }
  function sanitizeRows(json) {
    return json.map(r=>{
      const o={};
      for (const k of Object.keys(r)) {
        const kk = sanitizeHeader(k);
        o[kk] = r[k];
      }
      return o;
    });
  }

  function fillSelectOptions(cols) {
    for (const id of selects) {
      const el = $("#"+id);
      const opts = ['<option value="">-- (vazio) --</option>'];
      for (const c of cols) opts.push('<option>'+c+'</option>');
      el.innerHTML = opts.join('');
    }
    // sugestões (agora com "Data")
    suggest("#m_datahora", ["datahora","data e hora","data hora","data","Data"]);
    suggest("#m_data_venda", ["data_venda","data","Data","data da venda"]);
    suggest("#m_hora", ["hora","Hora"]);
    suggest("#m_unidade", ["unidade","Unidade"]);
    // loja agora pega "loja" (sem espaço) e variações
    suggest("#m_loja", ["loja","nome da loja","Nome da loja","Nome da Loja"]);
    suggest("#m_canal", ["canal","Canal de venda","Canal"]);
    suggest("#m_cancelado", ["cancelado","Cancelado","Está cancelado","está cancelado"]);
    suggest("#m_itens", ["itens","Itens","pedidos","Pedidos"]);
    suggest("#m_total", ["total","Total","fat","Fat"]);
    suggest("#m_des", ["des","Desconto","desconto"]);
    suggest("#m_fre", ["fre","Frete","frete","Entrega"]);
    suggest("#m_turno", ["turno","Turno"]);
    suggest("#m_pagamento", ["pagamento","Pagamento","pagamento_base"]);
  }
  function suggest(sel, list) {
    const el = $(sel);
    const vals = Array.from(el.options).map(o => o.value.toLowerCase());
    for (const c of list) {
      const idx = vals.indexOf(String(c).toLowerCase());
      if (idx >= 0) { el.selectedIndex = idx + 1; break; }
    }
  }
  function getMap() {
    const g = id => { const v=$("#"+id).value; return v===''?null:v; };
    return {
      datahora: g('m_datahora'),
      data_venda: g('m_data_venda'),
      hora: g('m_hora'),
      unidade: g('m_unidade'),
      loja: g('m_loja'),
      canal: g('m_canal'),
      cancelado: g('m_cancelado'),
      itens: g('m_itens'),
      total: g('m_total'),
      des: g('m_des'),
      fre: g('m_fre'),
      turno: g('m_turno'),
      pagamento: g('m_pagamento')
    };
  }

  function parseDateLike(v) {
    if (v === null || v === undefined || v === '') return { d:null, h:null };
    if (typeof v === 'number') {
      const epoch = new Date(Date.UTC(1899, 11, 30)); // Excel
      const ms = v * 86400000;
      const dt = new Date(epoch.getTime() + ms);
      return { d: dt.toISOString().slice(0,10), h: dt.getUTCHours() };
    }
    const s = String(v).trim().replace('T',' ');
    let m = s.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})(?:\s+(\d{1,2})(?::\d{2})?)?/);
    if (m) return { d:`${m[1]}-${m[2]}-${m[3]}`, h: m[4]?parseInt(m[4],10):null };
    m = s.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})(?:\s+(\d{1,2})(?::\d{2})?)?/);
    if (m) return { d:`${m[3]}-${m[2]}-${m[1]}`, h: m[4]?parseInt(m[4],10):null };
    m = s.match(/^(\d{1,2})(?::\d{2})?$/);
    if (m) return { d:null, h: parseInt(m[1],10) };
    return { d:null, h:null };
  }
  function toBoolVal(v) {
    if (typeof v === 'boolean') return v;
    const s = String(v||'').trim().toLowerCase();
    if (['sim','s','true','1','yes','y'].includes(s)) return true;
    if (['nao','não','n','false','0','no'].includes(s)) return false;
    return false;
  }
  function toNumber(v) {
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') return v;
    const n = Number(String(v).trim().split('.').join('').replace(',', '.'));
    return Number.isFinite(n) ? n : 0;
  }
  function mapRows(raw, map) {
    const out = [];
    for (const r of raw) {
      let d=null, h=null;
      if (map.datahora && r[map.datahora] != null) { const x = parseDateLike(r[map.datahora]); d=x.d; h=x.h; }
      if (!d && map.data_venda && r[map.data_venda] != null) { const x = parseDateLike(r[map.data_venda]); d=x.d; }
      if (h==null && map.hora && r[map.hora] != null) {
        const x = parseDateLike(r[map.hora]); h = (x.h!=null?x.h:toNumber(r[map.hora]));
      }
      out.push({
        data_venda: d,
        hora: (h!=null?parseInt(h,10):null),
        unidade: map.unidade ? String(r[map.unidade]||'').trim() : null,
        loja: map.loja ? String(r[map.loja]||'').trim() : null,
        canal: map.canal ? String(r[map.canal]||'').trim() : null,
        cancelado: map.cancelado ? !!toBoolVal(r[map.cancelado]) : false,
        itens: map.itens ? parseInt(toNumber(r[map.itens]),10) : 1,
        total: map.total ? toNumber(r[map.total]) : 0,
        des: map.des ? toNumber(r[map.des]) : 0,
        fre: map.fre ? toNumber(r[map.fre]) : 0,
        turno: map.turno ? String(r[map.turno]||'').trim() : null,
        pagamento: map.pagamento ? String(r[map.pagamento]||'').trim() : null
      });
    }
    return out;
  }

  async function initClient() {
    if (SUPA) return SUPA;
    SUPA = createClient($("#url").value.trim(), $("#key").value.trim());
    return SUPA;
  }

  async function ping() {
    try {
      await initClient();
      const tryCols = ['data_venda','loja','unidade','turno','*'];
      let ok = false, lastErr = null;
      for (const col of tryCols) {
        const q = SUPA.from('vendas_import_csv_v2').select(col).limit(1);
        const { error } = await q;
        if (!error) { ok = true; break; }
        lastErr = error;
      }
      if (ok) { setPill("#connBadge","✅ Supabase client ok","ok"); log("✅ Supabase client ok"); }
      else { setPill("#connBadge","❌ Erro Supabase","err"); log("❌", lastErr || {message:"Erro desconhecido"}); }
    } catch (e) { setPill("#connBadge","❌ Erro Supabase","err"); log("❌", e); }
  }

  $("#btnPing").addEventListener("click", ping);

  $("#btnRead").addEventListener("click", async () => {
    try {
      const f = $("#file").files[0];
      if (!f) { alert("Escolha um .xlsx"); return; }
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, {type:'array'});
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const jsonRaw = XLSX.utils.sheet_to_json(sheet, { defval: null });
      rows = sanitizeRows(jsonRaw); // <<< normaliza cabeçalhos (remove espaços extras)
      $("#fileInfo").textContent = `Arquivo: ${f.name} — Abas: ${wb.SheetNames.length} — Linhas: ${rows.length}`;
      log("📄 Arquivo lido", { nome:f.name, sheet: sheetName, linhas: rows.length });
      const cols = Object.keys(rows[0] || {});
      fillSelectOptions(cols);
      log("🔧 Amostra mapeada (1ª linha)", rows[0] || {});
    } catch (e) { log("❌ Erro lendo Excel", e); alert("Erro lendo o Excel (ver Debug)."); }
  });

  $("#btnPreview").addEventListener("click", () => {
    if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
    const map = getMap();
    const prev = mapRows(rows.slice(0,5), map);
    log("✅ Prévia (5 linhas)", prev);
  });

  $("#btnInsert").addEventListener("click", async () => {
    try {
      if (!rows.length) { alert("Leia o arquivo primeiro."); return; }
      await initClient();
      const map = getMap();
      const data = mapRows(rows, map);

      let semData = 0;
      for (const r of data) if (!r.data_venda) semData++;
      if (semData) log("⚠️ Linhas sem data_venda:", semData);

      const chunk = 2000;
      let ok=0, fail=0;
      for (let i=0;i<data.length;i+=chunk){
        const lote = data.slice(i, i+chunk);
        const { error } = await SUPA.from('vendas_import_csv_v2').insert(lote);
        if (error) { fail += lote.length; log({ lote:[i, i+lote.length], error }); }
        else { ok += lote.length; log("✅ Lote inserido", { lote:[i, i+lote.length] }); }
      }
      setPill("#insInfo", `Inserção concluída — ok: ${ok} / falhas: ${fail}`, fail?'warn':'ok');
      log("📦 Inserção concluída", { ok, fail });
    } catch (e) { log("❌ Erro inserindo", e); alert("Erro inserindo (ver Debug)."); }
  });

  $("#btnAutoRange").addEventListener("click", async ()=>{
    try {
      await initClient();
      // 1) tenta na view
      let minDia='', maxDia='';
      {
        const a = await SUPA.from('vw_vendas').select('dia').order('dia',{ascending:true}).limit(1);
        const b = await SUPA.from('vw_vendas').select('dia').order('dia',{ascending:false}).limit(1);
        if (!a.error && a.data?.length) minDia = a.data[0].dia;
        if (!b.error && b.data?.length) maxDia = b.data[0].dia;
      }
      // 2) fallback na base bruta
      if (!minDia || !maxDia) {
        const a = await SUPA.from('vendas_import_csv_v2').select('data_venda').not('data_venda','is',null).order('data_venda',{ascending:true}).limit(1);
        const b = await SUPA.from('vendas_import_csv_v2').select('data_venda').not('data_venda','is',null).order('data_venda',{ascending:false}).limit(1);
        if (!minDia && !a.error && a.data?.length) minDia = a.data[0].data_venda;
        if (!maxDia && !b.error && b.data?.length) maxDia = b.data[0].data_venda;
      }
      $("#dini").value = minDia || '';
      $("#dfim").value = maxDia || '';
      log("🗓️ Intervalo auto", { minDia, maxDia });
    } catch(e){ log("⚠️ AutoRange falhou", e); }
  });

  $("#btnSmoke").addEventListener("click", async ()=>{
    try{
      await initClient();
      const dini = $("#dini").value || '2025-01-01';
      const dfim = $("#dfim").value || '2025-12-31';
      const args = { p_dini:dini, p_dfim:dfim, p_unids:null, p_lojas:null, p_turnos:null, p_canais:null, p_pags:null, p_cancelado:null };

      const k = await SUPA.rpc('kpi_vendas_v2', args);
      if (k.error) { log("⚠️ KPI erro", k.error); $("#smk").textContent = "⚠️ KPI indisponível"; return; }
      const kpi = Array.isArray(k.data) ? k.data[0] : k.data;
      log("→ KPI params", args); log("✅ KPI", kpi);

      const d = await SUPA.rpc('chart_vendas_dow_v2', args);
      const m = await SUPA.rpc('chart_vendas_mes_v2', args);
      const h = await SUPA.rpc('chart_vendas_hora_v2', args);
      if (d.error || m.error || h.error) { log("⚠️ chart erros", { dow:d.error, mes:m.error, hora:h.error }); $("#smk").textContent = "⚠️ Charts indisponíveis"; return; }

      const sum = (arr, key) => (arr||[]).reduce((s,x)=>s+Number(x[key]||0),0);
      const sd = sum(d.data,'total'), sm = sum(m.data,'total'), sh = sum(h.data,'total');
      const fat = Number(kpi?.fat || 0);

      $("#smk").textContent =
        `DOW ${Math.abs(sd-fat)<1e-6?'✅':'❌'} soma=${sd.toLocaleString('pt-BR',{minimumFractionDigits:2})} vs KPI=${fat.toLocaleString('pt-BR',{minimumFractionDigits:2})}  | `+
        `MÊS ${Math.abs(sm-fat)<1e-6?'✅':'❌'} soma=${sm.toLocaleString('pt-BR',{minimumFractionDigits:2})} vs KPI=${fat.toLocaleString('pt-BR',{minimumFractionDigits:2})}  | `+
        `HORA ${Math.abs(sh-fat)<1e-6?'✅':'❌'} soma=${sh.toLocaleString('pt-BR',{minimumFractionDigits:2})} vs KPI=${fat.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
      log("🧪 Smoke", { dow:sd, mes:sm, hora:sh, fat, ok: Math.abs(sd-fat)<1e-6 && Math.abs(sm-fat)<1e-6 && Math.abs(sh-fat)<1e-6 });
    } catch(e){ $("#smk").textContent = "❌ Smoke test falhou (ver Debug)"; log("❌ Smoke", e); }
  });

  (async function start(){ try { await ping(); } catch(_){}})();
</script>
</body>
</html>
