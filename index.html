<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v13.2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--txt:#0f172a;--mut:#6b7280;--card:#fff;--brd:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 8px}
    .muted{color:var(--mut);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--mut)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    select,button{height:36px;border:1px solid var(--brd);border-radius:8px;background:#fff;padding:0 10px;font:inherit}
    button{cursor:pointer}
    .kpi{min-width:220px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap;min-height:120px}
    canvas{width:100%;height:280px;background:#fff;border:1px solid var(--brd);border-radius:10px}
    @media (max-width:960px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Dashboard Vendas — Supabase</h1>
  <div class="muted" id="fonte">Fonte: public.vendas_import_csv</div>

  <div class="row" style="margin-top:8px">
    <div class="card">
      <div class="title">Período</div>
      <select id="selPeriodo">
        <option value="30">Últimos 30 dias</option>
        <option value="60">Últimos 60 dias</option>
        <option value="90">Últimos 90 dias</option>
        <option value="180" selected>Últimos 180 dias</option>
        <option value="365">Últimos 365 dias</option>
      </select>
    </div>

    <div class="card">
      <div class="title">UNIDADE</div>
      <select id="selUnidade">
        <option>Todas</option>
      </select>
    </div>

    <div class="card">
      <div class="title">Faturamento</div>
      <label><input type="radio" name="modo" value="bruto" checked> Total (bruto)</label>
      &nbsp;
      <label><input type="radio" name="modo" value="liquido"> Líquido (Total − Entrega)</label>
    </div>

    <div class="row" style="gap:8px;margin-left:auto">
      <button id="btnReload">Recarregar</button>
    </div>
  </div>

  <div class="muted" id="periodo">Período: —</div>

  <div class="grid" style="margin-top:12px">
    <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="muted" id="k_ped_delta">+0,0% vs ant.</div></div>
    <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="muted" id="k_fat_delta">+0,0% vs ant.</div></div>
    <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_desc">…</div><div class="muted" id="k_desc_delta">+0,0% vs ant.</div></div>
    <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="muted" id="k_fre_delta">+0,0% vs ant.</div></div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card" style="grid-column:1/-1">
      <div class="title">Receita diária (usa o modo escolhido)</div>
      <canvas id="chartDiario"></canvas>
    </div>
    <div class="card" style="grid-column:1/-1">
      <div class="title">Totais por dia da semana (usa o modo escolhido)</div>
      <canvas id="chartSemana"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="title">Status / Logs</div>
    <pre id="log">Iniciando…</pre>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

const TABLE   = "vendas_import_csv";
const COL_DT  = "data_venda_date";
const COL_FAT = "Total";
const COL_DESC= "Desconto";
const COL_FRE = "Entrega";
const COL_UNI = "Unidade";

/* ====== UI helpers ====== */
const $ = s => document.querySelector(s);
const logEl = $("#log");
function log(s){ logEl.textContent += "\n" + s; }
function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
function fmtPct(p){ if(!isFinite(p)) return "0,0%"; return (p>=0?"+":"") + (p*100).toFixed(1).replace(".",",") + "%"; }
function toNum(x){
  if(x==null||x==="")return 0;
  if(typeof x==="number")return x;
  const s=String(x).trim();
  if(!s)return 0;
  const t=s.replace(/\./g,"").replace(/,/g,".");
  const n=Number(t);
  return isFinite(n)?n:0;
}
function toISO(d){ return d.toISOString().slice(0,10); }

/* ====== Supabase ====== */
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ====== Queries (pagina em 1000 por limite do PostgREST) ====== */
const PAGE = 1000;

async function fetchDistinctUnidades(startISO, endISO){
  const r = await supa.from(TABLE)
    .select(COL_UNI)
    .gte(COL_DT, startISO).lte(COL_DT, endISO)
    .range(0, PAGE-1);
  if(r.error){ log("[Unidade] erro: "+r.error.message); return ["Todas"]; }
  const set = new Set();
  (r.data||[]).forEach(v=>{ if(v[COL_UNI]) set.add(v[COL_UNI]); });
  return ["Todas", ...Array.from(set).sort()];
}

async function fetchRange(startISO, endISO, unidade){
  let all = [], page = 0;
  for(;;){
    let q = supa.from(TABLE)
      .select(`${COL_DT},${COL_FAT},${COL_DESC},${COL_FRE},${COL_UNI}`)
      .gte(COL_DT, startISO).lte(COL_DT, endISO)
      .range(page*PAGE, page*PAGE + PAGE - 1);

    if(unidade && unidade!=="Todas") q = q.eq(COL_UNI, unidade);

    const r = await q;
    if(r.error) throw r.error;

    const rows = r.data || [];
    all = all.concat(rows);
    log(`[Page] ${page} → recebidas ${rows.length}`);

    if(rows.length < PAGE) break; // última página
    page++;
    // segurança: evita looping infinito
    if(page > 2000){ log("[Warn] páginas demais, abortando"); break; }
  }
  return all;
}

/* ====== Agregação ====== */
function aggregate(rows, modo){
  let pedidos=0, fat=0, desc=0, fre=0;
  const diario = new Map();
  const semana = new Array(7).fill(0);

  for(const r of rows){
    const vFat = toNum(r[COL_FAT]);
    const vDes = toNum(r[COL_DESC]);
    const vFre = toNum(r[COL_FRE]);
    const data = String(r[COL_DT]).slice(0,10);

    pedidos += 1;
    fat  += vFat;
    desc += vDes;
    fre  += vFre;

    const v = (modo==="liquido") ? (vFat - vFre) : vFat;
    diario.set(data, (diario.get(data)||0) + v);

    const wd = (new Date(data+"T00:00:00")).getDay();
    semana[wd] += v;
  }
  return { pedidos, fat, desc, fre, diario, semana };
}
function delta(cur, prev){ if(!prev||prev===0) return 0; return (cur-prev)/prev; }

/* ====== Gráficos ====== */
let chartDiario=null, chartSemana=null;
function drawDiario(mapDiario){
  const labels = Array.from(mapDiario.keys()).sort();
  const values = labels.map(k=>mapDiario.get(k));
  if(chartDiario) chartDiario.destroy();
  chartDiario = new Chart($("#chartDiario"), {
    type:"line",
    data:{ labels, datasets:[{label:"Receita diária", data:values}]},
    options:{ responsive:true, maintainAspectRatio:false }
  });
}
function drawSemana(arrSemana){
  const labels = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
  if(chartSemana) chartSemana.destroy();
  chartSemana = new Chart($("#chartSemana"), {
    type:"bar",
    data:{ labels, datasets:[{label:"Totais por dia da semana", data:arrSemana}]},
    options:{ responsive:true, maintainAspectRatio:false }
  });
}

/* ====== Fluxo ====== */
async function carregar(){
  try{
    logEl.textContent = "Iniciando…";
    log(`[Boot] v13.2 — fonte fixa ${TABLE} • paginação de ${PAGE}`);

    $("#fonte").textContent = `Fonte: public.${TABLE}`;
    const days   = parseInt($("#selPeriodo").value,10);
    const modo   = document.querySelector("input[name=modo]:checked").value;
    const unidade= $("#selUnidade").value || "Todas";

    const end = new Date(); end.setHours(23,59,59,999);
    const start = new Date(end); start.setDate(end.getDate()-days+1);
    $("#periodo").textContent = `Período: ${toISO(start)} → ${toISO(end)}`;

    // carrega UNIDADES (uma vez por período)
    if($("#selUnidade").dataset.loaded !== `${days}`){
      const unidades = await fetchDistinctUnidades(toISO(start), toISO(end));
      $("#selUnidade").innerHTML = unidades.map(u=>`<option>${u}</option>`).join("");
      $("#selUnidade").dataset.loaded = `${days}`;
    }

    log(`[Query] ${TABLE} | janela ${days}d ${toISO(start)} → ${toISO(end)} | UNIDADE=${unidade}`);
    const curRows = await fetchRange(toISO(start), toISO(end), unidade);
    log(`[OK] Linhas retornadas (atual): ${curRows.length.toLocaleString("pt-BR")}`);
    const cur = aggregate(curRows, modo);

    const prevEnd = new Date(start); prevEnd.setDate(start.getDate()-1);
    const prevStart = new Date(prevEnd); prevStart.setDate(prevEnd.getDate()-days+1);
    log(`[Query] Anterior: ${toISO(prevStart)} → ${toISO(prevEnd)} | UNIDADE=${unidade}`);
    const prevRows = await fetchRange(toISO(prevStart), toISO(prevEnd), unidade);
    const prv = aggregate(prevRows, modo);

    $("#k_ped").textContent = fmtInt(cur.pedidos);
    $("#k_fat").textContent = fmtBRL(cur.fat);
    $("#k_desc").textContent = fmtBRL(cur.desc);
    $("#k_fre").textContent = fmtBRL(cur.fre);

    $("#k_ped_delta").textContent = fmtPct(delta(cur.pedidos, prv.pedidos)) + " vs ant.";
    $("#k_fat_delta").textContent = fmtPct(delta(cur.fat, prv.fat)) + " vs ant.";
    $("#k_desc_delta").textContent = fmtPct(delta(cur.desc, prv.desc)) + " vs ant.";
    $("#k_fre_delta").textContent = fmtPct(delta(cur.fre, prv.fre)) + " vs ant.";

    drawDiario(cur.diario);
    drawSemana(cur.semana);

    log("[OK] KPIs e gráficos atualizados.");
  }catch(e){
    log("[ERRO] "+(e.message||String(e)));
  }
}

/* ====== Eventos ====== */
$("#btnReload").addEventListener("click", carregar);
$("#selPeriodo").addEventListener("change", ()=>{ $("#selUnidade").dataset.loaded=""; carregar(); });
document.querySelectorAll("input[name=modo]").forEach(r=>r.addEventListener("change", carregar));
$("#selUnidade").addEventListener("change", carregar);
window.addEventListener("load", carregar);
</script>
</body>
</html>
