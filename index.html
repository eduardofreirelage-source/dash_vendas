<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Maestro Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --chip:#eef2ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi{position:relative;padding-bottom:8px}
    .delta{position:absolute;right:12px;bottom:10px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .delta .up{color:var(--good)} .delta .down{color:var(--bad)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    input[type="date"]{padding:7px 10px}
    button{cursor:pointer}
    button.ghost{background:#fff}
    .seg{display:flex;gap:6px;align-items:center}
    .seg .lbl{font-size:12px;color:var(--muted);white-space:nowrap}
    .seg .grow{min-width:180px}
    .chartbox{position:relative;height:300px;width:100%}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
    .pill button{border:0;padding:6px 10px;background:#fff}
    .pill button.active{background:var(--accent);color:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip.active{background:#dbeafe;border-color:#bfdbfe}
    details.filterbox{border:1px solid var(--brd);border-radius:12px;background:#fff}
    details.filterbox>summary{padding:12px 14px;list-style:none;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:space-between;font-weight:600}
    details.filterbox[open]>summary{border-bottom:1px solid var(--brd)}
    details.filterbox .body{padding:12px 14px}
    .filters-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-2{grid-column:span 2} .col-12{grid-column:span 12}
    .right{margin-left:auto}
    .admin{background:#fafafa;border:1px dashed var(--brd);border-radius:10px;padding:10px;margin-top:8px}
    @media (max-width:940px){ .grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))} .filters-grid{grid-template-columns:repeat(6,1fr)} }
    @media (max-width:560px){ .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr} .filters-grid{grid-template-columns:repeat(4,1fr)} }

    /* ===== AUTH (overlay) ===== */
    .gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1020,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
    .gate .box{width:360px;max-width:92vw;background:#fff;border-radius:14px;border:1px solid var(--brd);padding:18px}
    .tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
    .tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
    .tabs button.active{background:var(--accent);color:#fff}
    .field{display:flex;flex-direction:column;margin-top:8px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- AUTH OVERLAY -->
  <div class="gate" id="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Acesso — Maestro Food</h3>
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Criar conta</button>
      </div>
      <div id="authForm">
        <div class="field">
          <label for="authEmail">E-mail</label>
          <input id="authEmail" type="email" autocomplete="email" placeholder="voce@empresa.com" />
        </div>
        <div class="field">
          <label for="authPass">Senha</label>
          <input id="authPass" type="password" autocomplete="current-password" placeholder="••••••••" />
        </div>
        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button id="btnSignup" style="display:none">Criar conta</button>
          <button id="btnLogin">Entrar</button>
        </div>
        <div class="muted" id="authErr" style="color:#b91c1c;min-height:16px;margin-top:6px"></div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="toolbar">
      <h1>Maestro Food</h1>
      <div class="topbar">
        <span class="muted" id="who"></span>
        <button id="btnAdmin" class="ghost" style="display:none">Admin (Usuários)</button>
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filterbox" id="fx">
      <summary>
        FILTROS
        <span class="muted right" id="limpar" title="Limpar filtros" style="font-weight:400">Limpar</span>
      </summary>
      <div class="body">
        <div class="filters-grid">
          <div class="col-6 seg">
            <span class="lbl">Unidade</span>
            <select id="uni" class="grow"></select>
          </div>
          <div class="col-6 seg">
            <span class="lbl">Nome da loja (Top 10)</span>
            <div id="lojas" class="chips"></div>
          </div>
          <div class="col-3 seg">
            <span class="lbl">De</span>
            <input type="date" id="dini" class="grow" />
          </div>
          <div class="col-3 seg">
            <span class="lbl">Até</span>
            <input type="date" id="dfim" class="grow" />
          </div>
          <div class="col-3 seg">
            <span class="lbl">Período rápido</span>
            <select id="pr" class="grow">
              <option value="7">Últimos 7</option>
              <option value="15">Últimos 15</option>
              <option value="30" selected>Últimos 30</option>
              <option value="90">Últimos 90</option>
              <option value="180">Últimos 180</option>
              <option value="360">Últimos 360</option>
            </select>
          </div>
          <div class="col-3 seg">
            <span class="lbl">Turno</span>
            <select id="turno" class="grow" multiple>
              <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
            </select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Canal de venda</span>
            <select id="canal" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Pagamento</span>
            <select id="pag" class="grow" multiple></select>
          </div>
          <div class="col-4 seg">
            <span class="lbl">Está cancelado?</span>
            <select id="canc" class="grow">
              <option value="Todos" selected>Todos</option>
              <option value="Sim">Sim</option>
              <option value="Não">Não</option>
            </select>
          </div>
        </div>

        <div class="admin">
          <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>)
          <div class="row" style="margin-top:6px;flex-wrap:wrap">
            <input type="file" id="csvfile" accept=".csv" />
            <button id="btnImport">Importar CSV</button>
            <progress id="prog" value="0" max="100" style="display:none;width:220px;height:10px"></progress>
          </div>
        </div>
      </div>
    </details>

    <!-- KPIs -->
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">…</div><div class="delta" id="d_tkm">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">…</div><div class="delta" id="d_fmd">—</div></div>
    </div>
    <div class="grid cols-4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">…</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">…</div><div class="delta" id="d_desp">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="delta" id="d_fre">—</div></div>
      <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">…</div><div class="delta" id="d_frem">—</div></div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">…</div><div class="delta" id="d_fatl">—</div></div>
      <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">…</div><div class="delta" id="d_fatlp">—</div></div>
    </div>

    <!-- GRÁFICOS -->
    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita diária (R$)</div>
        <div class="pill" data-target="lineMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por dia da semana (R$)</div>
        <div class="pill" data-target="dowMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowFat"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Pedidos por dia da semana</div>
        <div class="pill" data-target="dowPedMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cDowPed"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por hora (0–23)</div>
        <div class="pill" data-target="hourMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cHour"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Receita por mês</div>
        <div class="pill" data-target="monMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cMonth"></canvas></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="toolbar">
        <div class="title">Top 10 Lojas (R$)</div>
        <div class="pill" data-target="topMode">
          <button data-val="total" class="active">Total</button>
          <button data-val="media">Média</button>
        </div>
      </div>
      <div class="chartbox"><canvas id="cTop"></canvas></div>
    </div>

    <!-- ADMIN: Usuários -->
    <div class="card" id="adminPanel" style="margin-top:12px; display:none">
      <div class="toolbar">
        <div class="title">Admin — Usuários</div>
        <div class="muted">Apenas administradores podem excluir contas.</div>
      </div>
      <div id="usersBox" class="muted">Carregando…</div>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Credenciais =====
  var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var TABLE = "vendas_kpi_daily_v2";
  var STAGING = "vendas_kpi_daily_v2_data";
  var ADMIN_FUNCTION_URL = ""; // configure se usar a Edge Function

  // ===== Helpers =====
  function log(_s){} // no-op (clean)
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ return d.toISOString().slice(0,10); }
  function parseISO(s){ return new Date(s+"T00:00:00Z"); }
  function addDays(d, k){ var t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function avg(a,b){ return b>0? a/b : 0; }
  function debounce(fn, wait){ var t; return function(){ var args=arguments, ctx=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, wait); }; }
  function destroyChart(c){ if(c){ try{c.destroy();}catch(e){} } return null; }
  function movingAvg(arr, win){ var out=[], acc=0; for(var i=0;i<arr.length;i++){ acc+=arr[i]; if(i>=win) acc-=arr[i-win]; out.push( acc / Math.min(i+1, win) ); } return out; }

  // ===== Supabase (Auth ON) =====
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true } });

  // ===== Estado / refs =====
  var selUni=document.getElementById("uni"), chipLojas=document.getElementById("lojas");
  var dini=document.getElementById("dini"), dfim=document.getElementById("dfim"), pr=document.getElementById("pr");
  var turno=document.getElementById("turno"), canal=document.getElementById("canal"), pag=document.getElementById("pag"), canc=document.getElementById("canc");
  var btnAdmin=document.getElementById("btnAdmin"), adminPanel=document.getElementById("adminPanel"), usersBox=document.getElementById("usersBox");
  var chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  var lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";
  var runId=0, maxDiaISO=null, minDiaISO=null, diasDisponiveis=new Set();

  // ===== Auth UI =====
  var gate=document.getElementById("gate"), app=document.getElementById("app");
  var tabLogin=document.getElementById("tabLogin"), tabSignup=document.getElementById("tabSignup");
  var authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass");
  var btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup"), authErr=document.getElementById("authErr");
  var who=document.getElementById("who"), btnLogout=document.getElementById("btnLogout");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }

  tabLogin.addEventListener("click", ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; });
  tabSignup.addEventListener("click", ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; });

  btnLogin.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
    hideGate(); afterLogin();
  });

  btnSignup.addEventListener("click", async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const { error } = await supa.auth.signUp({ email, password: pass });
    if(error){ authErr.textContent=error.message; return; }
    authErr.style.color="#16a34a"; authErr.textContent="Conta criada. Verifique seu e-mail se necessário.";
  });

  btnLogout.addEventListener("click", async ()=>{ await supa.auth.signOut(); showGate(); });

  async function afterLogin(){
    const { data:{ user } } = await supa.auth.getUser();
    who.textContent = user?.email || "";
    btnAdmin.style.display = ADMIN_FUNCTION_URL ? "inline-block" : "none";
    boot();
  }

  supa.auth.onAuthStateChange((_e, session)=>{ if(session){ hideGate(); afterLogin(); } else { showGate(); } });

  // ===== Filtros =====
  document.getElementById("limpar").addEventListener("click", function(e){
    e.preventDefault();
    selUni.value="Todas"; dini.value=""; dfim.value=""; pr.value="30"; turno.value=""; canal.value=""; pag.value=""; canc.value="Todos";
    Array.prototype.forEach.call(chipLojas.children, c=>c.classList.remove("active"));
    recarregarDebounced();
  });

  function setDelta(el, cur, prev){
    var pct = (prev>0)? ((cur-prev)/prev*100): 0;
    var cls = pct>=0 ? "up" : "down";
    var arrow = pct>=0 ? "▲" : "▼";
    el.className="delta "+cls; el.textContent = (pct>=0?"+":"")+pct.toFixed(1)+"% "+arrow;
  }

  async function fetchPaged(fields, startISO, endISO, unidade, lojas, filtros){
    var page=1000, off=0, out=[];
    for(;;){
      var q = supa.from(TABLE).select(fields).gte("dia", startISO).lte("dia", endISO).order("dia",{ascending:true}).range(off, off+page-1);
      if(unidade && unidade!=="Todas") q = q.eq("unidade", unidade);
      if(lojas && lojas.length) q = q.in("Nome da Loja", lojas);
      if(filtros.turno && filtros.turno.length) q = q.in("turno", filtros.turno);
      if(filtros.canal && filtros.canal.length) q = q.in("Canal de venda", filtros.canal);
      if(filtros.pag && filtros.pag.length) q = q.in("pagamento", filtros.pag);
      if(filtros.canc && filtros.canc!=="Todos") q = q.eq("cancelado", filtros.canc==="Sim" ? "Sim":"Não");
      var r = await q; if(r.error){ throw r.error; }
      var a=r.data||[]; out = out.concat(a);
      if(a.length<page) break; off += page; if(off>500000){ break; }
    }
    return out;
  }

  async function fetchUnidades(){
    var uniq={}, arr=["Todas"];
    function push(list){ (list||[]).forEach(function(row){ var u=(row.unidade||"").trim(); if(!u) return; if(!uniq[u]){ uniq[u]=1; arr.push(u); } }); }
    var r1 = await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).range(0,9999);
    if(!r1.error) push(r1.data);
    var r2 = await supa.from(TABLE).select("unidade").order("unidade",{ascending:false}).range(0,9999);
    if(!r2.error) push(r2.data);
    if(arr.length===1){ arr.push("Uni. Raja"); arr.push("Uni.Savassi"); }
    return arr;
  }

  async function fetchLimites(){
    var r = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    var r2= await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    if(r.error||r2.error) throw (r.error||r2.error);
    minDiaISO = (r.data&&r.data[0]&&r.data[0].dia)||null;
    maxDiaISO = (r2.data&&r2.data[0]&&r2.data[0].dia)||null;

    diasDisponiveis = new Set();
    var page=1000, off=0;
    for(;;){
      var rs = await supa.from(TABLE).select("dia").order("dia",{ascending:true}).range(off, off+page-1);
      if(rs.error) break;
      (rs.data||[]).forEach(x=>diasDisponiveis.add(x.dia));
      if((rs.data||[]).length<page) break;
      off+=page; if(off>500000) break;
    }
    if(minDiaISO && maxDiaISO){ dini.min=minDiaISO; dfim.min=minDiaISO; dini.max=maxDiaISO; dfim.max=maxDiaISO; }
  }
  function snapToAvailable(iso){
    if(!iso || diasDisponiveis.has(iso)) return iso;
    var d = parseISO(iso);
    for(var k=1;k<60;k++){
      var a=toISO(addDays(d, -k)), b=toISO(addDays(d, k));
      if(diasDisponiveis.has(a)) return a;
      if(diasDisponiveis.has(b)) return b;
    }
    return null;
  }

  async function recarregar(){
    const myRun = ++runId;
    try{
      if(!maxDiaISO) await fetchLimites();
      var psISO = dini.value || "", peISO = dfim.value || "";
      var s,e;
      if(psISO && peISO){
        var s0 = snapToAvailable(psISO), e0 = snapToAvailable(peISO);
        if(s0!==psISO){ dini.value=s0; } if(e0!==peISO){ dfim.value=e0; }
        s = parseISO(dini.value); e = parseISO(dfim.value);
      }else{
        var end = parseISO(maxDiaISO), start = addDays(end, -((Number(pr.value)||30)-1));
        s=start; e=end; dini.value = toISO(s); dfim.value = toISO(e);
      }
      var startISO = toISO(s), endISO = toISO(e);

      var lojas = Array.prototype.filter.call(chipLojas.children, c=>c.classList.contains("active")).map(c=>c.getAttribute("data-v"));
      var filtros = {
        turno: Array.from(turno.selectedOptions).map(o=>o.value),
        canal: Array.from(canal.selectedOptions).map(o=>o.value),
        pag:   Array.from(pag.selectedOptions).map(o=>o.value),
        canc:  (canc.value||"Todos")
      };
      var uniVal = selUni.value || "Todas";

      var fields = "dia,unidade,pedidos,fat,des,fre,\"Nome da Loja\",turno,\"Canal de venda\",pagamento,cancelado,hora";
      var cur = await fetchPaged(fields, startISO, endISO, uniVal==="Todas"? null: uniVal, lojas, filtros);
      if(myRun!==runId) return;

      var daysLen = Math.max(1, Math.round((parseISO(endISO)-parseISO(startISO))/(24*3600*1000))+1);
      var prevEnd   = addDays(parseISO(startISO), -1);
      var prevStart = addDays(prevEnd, -(daysLen-1));
      var ant = await fetchPaged(fields, toISO(prevStart), toISO(prevEnd), uniVal==="Todas"? null: uniVal, lojas, filtros);
      if(myRun!==runId) return;

      // KPIs
      (function(){
        var ped = cur.reduce((s,r)=>s+Number(r.pedidos||0),0);
        var fat = cur.reduce((s,r)=>s+Number(r.fat||0),0);
        var des = cur.reduce((s,r)=>s+Number(r.des||0),0);
        var fre = cur.reduce((s,r)=>s+Number(r.fre||0),0);
        var pedA = ant.reduce((s,r)=>s+Number(r.pedidos||0),0);
        var fatA = ant.reduce((s,r)=>s+Number(r.fat||0),0);
        var desA = ant.reduce((s,r)=>s+Number(r.des||0),0);
        var freA = ant.reduce((s,r)=>s+Number(r.fre||0),0);
        var diasDistinct = new Set(cur.map(r=>r.dia)).size || 1;
        var diasDistinctA = new Set(ant.map(r=>r.dia)).size || 1;

        var tkm = ped>0 ? fat/ped : 0;
        var tkmA= pedA>0 ? fatA/pedA : 0;

        var fmd = fat/diasDistinct;
        var fmdA= fatA/diasDistinctA;

        var fatLiq = fat - des - fre - (0.12*fat);
        var fatLiqA= fatA - desA - freA - (0.12*fatA);

        var desPct = fat>0 ? (des/fat*100) : 0;
        var desPctA= fatA>0 ? (desA/fatA*100) : 0;

        var freMed = ped>0 ? fre/ped : 0;
        var freMedA= pedA>0 ? freA/pedA : 0;

        var fatLiqPct = fat>0 ? (fatLiq/fat*100) : 0;
        var fatLiqPctA= fatA>0 ? (fatLiqA/fatA*100) : 0;

        document.getElementById("k_ped").textContent = fmtInt(ped);
        document.getElementById("k_tkm").textContent = fmtBRL(tkm);
        document.getElementById("k_fat").textContent = fmtBRL(fat);
        document.getElementById("k_fmd").textContent = fmtBRL(fmd);
        document.getElementById("k_des").textContent = fmtBRL(des);
        document.getElementById("k_desp").textContent = desPct.toFixed(1)+"%";
        document.getElementById("k_fre").textContent = fmtBRL(fre);
        document.getElementById("k_frem").textContent = fmtBRL(freMed);
        document.getElementById("k_fatl").textContent = fmtBRL(fatLiq);
        document.getElementById("k_fatlp").textContent = fatLiqPct.toFixed(1)+"%";

        setDelta(document.getElementById("d_ped"), ped, pedA);
        setDelta(document.getElementById("d_tkm"), tkm, tkmA);
        setDelta(document.getElementById("d_fat"), fat, fatA);
        setDelta(document.getElementById("d_fmd"), fmd, fmdA);
        setDelta(document.getElementById("d_des"), des, desA);
        setDelta(document.getElementById("d_desp"), desPct, desPctA);
        setDelta(document.getElementById("d_fre"), fre, freA);
        setDelta(document.getElementById("d_frem"), freMed, freMedA);
        setDelta(document.getElementById("d_fatl"), fatLiq, fatLiqA);
        setDelta(document.getElementById("d_fatlp"), fatLiqPct, fatLiqPctA);
      })();

      // LINE (com sombra)
      function groupBy(arr, keyFn, valFn){ var m=new Map(); arr.forEach(r=>{ var k=keyFn(r); var v=valFn(r); m.set(k,(m.get(k)||0)+v); }); var labels=Array.from(m.keys()).sort(); var values=labels.map(k=>m.get(k)); return {labels,values}; }
      var byDay = groupBy(cur, r=>r.dia, r=>Number(r.fat||0));
      var byDayPrev = groupBy(ant, r=>r.dia, r=>Number(r.fat||0));
      chartLine = destroyChart(chartLine);
      chartLine = new window.Chart(document.getElementById("cLine").getContext("2d"), {
        type:"line",
        data:{ labels: byDay.labels, datasets:[
          { data: byDayPrev.values, fill:true, borderWidth:0, backgroundColor:"rgba(2,132,199,0.12)", pointRadius:0, tension:0.2 },
          { data: (lineMode==="media"? movingAvg(byDay.values,7) : byDay.values), borderWidth:2, pointRadius:0, tension:0.2 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
      });

      // DOW fat
      function drawBar(canvasId, labels, totals, counts, mode){
        var vals = (mode==="media") ? totals.map((v,i)=> avg(v, counts[i]||1)) : totals.slice();
        return new window.Chart(document.getElementById(canvasId).getContext("2d"), {
          type:"bar",
          data:{ labels, datasets:[{ data:vals }] },
          options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
        });
      }
      function buildDow(arr, valKey){
        var lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], m=[0,0,0,0,0,0,0], cnt=[0,0,0,0,0,0,0];
        var diasSet=new Set(arr.map(r=>r.dia));
        Array.from(diasSet).forEach(d=>{ cnt[parseISO(d).getUTCDay()]++; });
        arr.forEach(r=>{ var d=parseISO(r.dia).getUTCDay(); m[d]+=Number(r[valKey]||0); });
        return {labels:lbl, totals:m, counts:cnt};
      }
      var dowFat = buildDow(cur, "fat");
      chartDowFat = destroyChart(chartDowFat); chartDowFat = drawBar("cDowFat", dowFat.labels, dowFat.totals, dowFat.counts, dowMode);

      // DOW ped
      var dowPed = buildDow(cur, "pedidos");
      chartDowPed = destroyChart(chartDowPed); chartDowPed = drawBar("cDowPed", dowPed.labels, dowPed.totals, dowPed.counts, dowPedMode);

      // HORA
      (function(){
        var m=Array(24).fill(0), daysByHour=Array(24).fill(0).map(()=>new Set());
        cur.forEach(r=>{ if(r.hora===null||r.hora===undefined) return; var h=Number(r.hora)||0; if(h<0||h>23) return; m[h]+=Number(r.fat||0); daysByHour[h].add(r.dia); });
        var totalDays = new Set(cur.map(r=>r.dia)).size || 1, labels=[], totals=[], counts=[];
        for(var h=0;h<24;h++){ var active=daysByHour[h].size; var keep=active>=Math.ceil(totalDays*0.5)&&m[h]>0; if(keep){ labels.push(String(h).padStart(2,"0")+":00"); totals.push(m[h]); counts.push(active); } }
        chartHour = destroyChart(chartHour); chartHour = drawBar("cHour", labels, totals, counts, hourMode);
      })();

      // MÊS
      (function(){
        var m=new Map(), cnt=new Map(), daysPerMonth=new Map();
        cur.forEach(r=>{ var ym=r.dia.slice(0,7); m.set(ym,(m.get(ym)||0)+Number(r.fat||0)); if(!daysPerMonth.has(ym)) daysPerMonth.set(ym,new Set()); daysPerMonth.get(ym).add(r.dia); });
        Array.from(daysPerMonth.keys()).forEach(ym=> cnt.set(ym, daysPerMonth.get(ym).size));
        var labels=Array.from(m.keys()).sort(), totals=labels.map(x=>m.get(x)), counts=labels.map(x=>cnt.get(x)||1);
        chartMonth = destroyChart(chartMonth); chartMonth = drawBar("cMonth", labels, totals, counts, monMode);
      })();

      // TOP 10 + chips
      (function(){
        var byLoja={}; cur.forEach(r=>{ var n=r["Nome da Loja"]; if(!n) return; byLoja[n]=(byLoja[n]||0)+Number(r.fat||0); });
        var top = Object.entries(byLoja).sort((a,b)=>b[1]-a[1]).slice(0,10);
        var labels=top.map(x=>x[0]), totals=top.map(x=>x[1]), counts=top.map(_=> (new Set(cur.map(r=>r.dia)).size) );
        chartTop = destroyChart(chartTop);
        chartTop = new window.Chart(document.getElementById("cTop").getContext("2d"), {
          type:"bar",
          data:{ labels, datasets:[{ data:(topMode==="media"? totals.map((v,i)=>avg(v,counts[i]||1)) : totals) }] },
          options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{display:false} }, scales:{ x:{ beginAtZero:true } } }
        });
        if(chipLojas.children.length===0){
          chipLojas.innerHTML="";
          labels.forEach(lbl=>{
            var chip=document.createElement("span");
            chip.className="chip"; chip.textContent=lbl; chip.setAttribute("data-v", lbl);
            chip.addEventListener("click", function(){ chip.classList.toggle("active"); recarregarDebounced(); });
            chipLojas.appendChild(chip);
          });
        }
      })();

    }catch(e){ /* silencioso (clean) */ }
  }
  var recarregarDebounced = debounce(recarregar, 120);

  async function boot(){
    await fetchLimites();
    var end = parseISO(maxDiaISO), start = addDays(end, -29);
    document.getElementById("dini").value = toISO(start); document.getElementById("dfim").value = toISO(end);

    var opts = await fetchUnidades(); selUni.innerHTML=""; opts.forEach(u=>{ var o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); }); selUni.value="Todas";
    [selUni, dini, dfim, pr, turno, canal, pag, canc].forEach(el=>{ el.addEventListener("change", function(){ document.getElementById("fx").open=false; recarregarDebounced(); }); });

    // Admin users (opcional, se configurar function)
    btnAdmin.addEventListener("click", async ()=>{
      if(!ADMIN_FUNCTION_URL){ alert("Function de admin não configurada."); return; }
      const { data:{ session } } = await supa.auth.getSession(); if(!session){ alert("Faça login."); return; }
      adminPanel.style.display = "block"; usersBox.textContent = "Carregando…";
      try{
        const r = await fetch(ADMIN_FUNCTION_URL, { headers:{ "Authorization":"Bearer "+session.access_token } });
        if(!r.ok){ usersBox.textContent = "Sem permissão (ou erro no backend)."; return; }
        const js = await r.json();
        if(!Array.isArray(js) || js.length===0){ usersBox.textContent="Sem usuários."; return; }
        const table = document.createElement("table");
        table.style.width="100%"; table.style.borderCollapse="collapse";
        table.innerHTML = `<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid var(--brd)">E-mail</th><th style="text-align:left;padding:6px;border-bottom:1px solid var(--brd)">Criado</th><th style="padding:6px;border-bottom:1px solid var(--brd)">Ação</th></tr></thead><tbody></tbody>`;
        js.forEach(u=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td style="padding:6px;border-bottom:1px solid var(--brd)">${u.email}</td>
                          <td style="padding:6px;border-bottom:1px solid var(--brd)">${(u.created_at||"").replace("T"," ").replace("Z","")}</td>
                          <td style="padding:6px;border-bottom:1px solid var(--brd);text-align:center"><button data-id="${u.id}">Excluir</button></td>`;
          table.tBodies[0].appendChild(tr);
        });
        usersBox.innerHTML=""; usersBox.appendChild(table);
        usersBox.querySelectorAll("button[data-id]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm("Excluir este usuário?")) return;
            const id=btn.getAttribute("data-id");
            const del = await fetch(ADMIN_FUNCTION_URL+"?id="+encodeURIComponent(id), { method:"DELETE", headers:{ "Authorization":"Bearer "+session.access_token } });
            if(del.ok){ btn.closest("tr").remove(); } else { alert("Falha ao excluir."); }
          });
        });
      }catch(err){ usersBox.textContent="Erro."; }
    });

    // Import CSV direto no navegador (staging)
    document.getElementById("btnImport").addEventListener("click", async function(){
      var f = document.getElementById("csvfile").files[0];
      if(!f){ alert("Selecione o arquivo CSV (Pasta2.csv)"); return; }
      const prog=document.getElementById("prog"); prog.style.display="inline-block"; prog.value=0;
      await supa.from(STAGING).delete().neq('dia', null);
      Papa.parse(f, {
        header:true, skipEmptyLines:true, dynamicTyping:false,
        complete: async function(res){
          const rows=res.data||[]; const chunk=2000; let done=0;
          for(let i=0;i<rows.length;i+=chunk){
            const slice = rows.slice(i,i+chunk).map(r=>({
              dia:r.dia, unidade:r.unidade, pedidos:Number(r.pedidos)||0, fat:Number(r.fat)||0, des:Number(r.des)||0, fre:Number(r.fre)||0,
              "Nome da Loja":r["Nome da Loja"], turno:r.turno, "Canal de venda":r["Canal de venda"], pagamento:r.pagamento, cancelado:r.cancelado, hora:r.hora!==""? Number(r.hora): null
            }));
            const ins = await supa.from(STAGING).insert(slice);
            if(ins.error){ alert("Erro ao importar: "+ins.error.message); break; }
            done+=slice.length; prog.value=Math.round(done/rows.length*100);
          }
          prog.style.display="none"; await fetchLimites(); await recarregar();
        },
        error: function(err){ prog.style.display="none"; alert("CSV inválido: "+(err.message||err)); }
      });
    });

    await recarregar();
  }

  // Início
  (async function initAuth(){
    const { data:{ session } } = await supa.auth.getSession();
    if(session){ hideGate(); afterLogin(); } else { showGate(); }
  })();

  // Toggles de gráfico
  document.querySelectorAll(".pill").forEach(p=>{
    p.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        p.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const mode = btn.getAttribute("data-val");
        const target = p.getAttribute("data-target");
        if(target==="lineMode") lineMode=mode;
        else if(target==="dowMode") dowMode=mode;
        else if(target==="dowPedMode") dowPedMode=mode;
        else if(target==="hourMode") hourMode=mode;
        else if(target==="monMode") monMode=mode;
        else if(target==="topMode") topMode=mode;
        recarregar();
      });
    });
  });
})();
</script>
</body>
</html>
