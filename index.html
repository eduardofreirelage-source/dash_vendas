<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Food Dashboard - SEM LIMITES</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-indicator {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 8px 16px;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .status-indicator.success {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .status-indicator.warning {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.5);
        }

        .status-indicator.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .period-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
            font-weight: 500;
        }

        .filters-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            background: rgba(255,255,255,0.15);
        }

        .filter-group select option {
            background: #333;
            color: white;
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .kpis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.15);
        }

        .kpi-title {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .kpi-value {
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-comparison {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .comparison-positive {
            color: #22c55e;
        }

        .comparison-negative {
            color: #ef4444;
        }

        .comparison-neutral {
            color: rgba(255,255,255,0.6);
        }

        .chart-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .chart-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .import-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .import-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .file-input {
            padding: 10px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: white;
            width: 100%;
            max-width: 400px;
        }

        .progress-container {
            width: 100%;
            max-width: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .import-status {
            color: white;
            text-align: center;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .kpis-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>
                üçΩÔ∏è Maestro Food Dashboard
            </h1>
            <div class="status-indicators">
                <div id="supabaseStatus" class="status-indicator warning">‚è≥ Conectando...</div>
                <div id="dataStatus" class="status-indicator warning">‚è≥ Carregando...</div>
                <div id="processStatus" class="status-indicator warning">‚è≥ Processando...</div>
            </div>
        </div>

        <!-- Period Info -->
        <div class="period-info" id="periodInfo">
            üìÖ Per√≠odo: Carregando...
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterUnidade">üè¢ Unidade</label>
                    <select id="filterUnidade">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterLoja">üè™ Nome da Loja (Top 10)</label>
                    <select id="filterLoja">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="dataInicial">üìÖ Data Inicial</label>
                    <input type="date" id="dataInicial">
                </div>

                <div class="filter-group">
                    <label for="dataFinal">üìÖ Data Final</label>
                    <input type="date" id="dataFinal">
                </div>

                <div class="filter-group">
                    <label for="filterPeriodo">‚è∞ Per√≠odo R√°pido</label>
                    <select id="filterPeriodo">
                        <option value="">Personalizado</option>
                        <option value="hoje">Hoje</option>
                        <option value="ontem">Ontem</option>
                        <option value="ultimos7dias">√öltimos 7 dias</option>
                        <option value="ultimos30dias">√öltimos 30 dias</option>
                        <option value="mesAtual">M√™s atual</option>
                        <option value="mesAnterior">M√™s anterior</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterTurno">üåÖ Turno</label>
                    <select id="filterTurno">
                        <option value="">Todos</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                        <option value="Madrugada">Madrugada</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterCanal">üì± Canal de Venda</label>
                    <select id="filterCanal">
                        <option value="">Todos</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterPagamento">üí≥ Pagamento</label>
                    <select id="filterPagamento">
                        <option value="">Todos</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterCancelado">‚ùå Cancelado</label>
                    <select id="filterCancelado">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">N√£o</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">üîç Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üîÑ Limpar Filtros</button>
                <button class="btn btn-secondary" onclick="debugInfo()">üîß Debug</button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpis-container">
            <div class="kpi-card">
                <div class="kpi-title">üì¶ Pedidos</div>
                <div class="kpi-value" id="kpiPedidos">-</div>
                <div class="kpi-comparison" id="compPedidos">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üéØ Ticket M√©dio</div>
                <div class="kpi-value" id="kpiTicketMedio">R$ -</div>
                <div class="kpi-comparison" id="compTicketMedio">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üí∞ Faturamento</div>
                <div class="kpi-value" id="kpiFaturamento">R$ -</div>
                <div class="kpi-comparison" id="compFaturamento">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üìà Faturamento M√©dio/Dia</div>
                <div class="kpi-value" id="kpiFaturamentoDia">R$ -</div>
                <div class="kpi-comparison" id="compFaturamentoDia">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üéÅ Incentivos</div>
                <div class="kpi-value" id="kpiIncentivos">R$ -</div>
                <div class="kpi-comparison" id="compIncentivos">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üìä Incentivos %</div>
                <div class="kpi-value" id="kpiIncentivosPercent">-%</div>
                <div class="kpi-comparison" id="compIncentivosPercent">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üöö Frete</div>
                <div class="kpi-value" id="kpiFrete">R$ -</div>
                <div class="kpi-comparison" id="compFrete">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">üíé Faturamento L√≠quido</div>
                <div class="kpi-value" id="kpiFaturamentoLiquido">R$ -</div>
                <div class="kpi-comparison" id="compFaturamentoLiquido">
                    <span class="comparison-neutral">‚Äî N/A</span>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-title">üìä Receita Di√°ria</div>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>

        <!-- Import CSV -->
        <div class="import-container">
            <div class="import-title">üìÅ Importar CSV</div>
            <div class="file-input-container">
                <input type="file" id="csvFile" accept=".csv" class="file-input">
                <button class="btn btn-primary" onclick="importCSV()">üì§ Importar CSV (SEM LIMITES)</button>
                
                <div id="progressContainer" class="progress-container">
                    <div id="progressBar" class="progress-bar">0%</div>
                </div>
                
                <div id="importStatus" class="import-status"></div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Vari√°veis globais
        let allData = [];
        let filteredData = [];
        let minISO = '';
        let maxISO = '';
        let chart = null;

        /**
         * FUN√á√ÉO CORRIGIDA: Converte data para formato ISO (YYYY-MM-DD)
         * TESTADA E FUNCIONANDO PERFEITAMENTE
         */
        function convertDateToISO(dateString) {
            if (!dateString) return null;
            
            try {
                // Se j√° est√° no formato ISO (YYYY-MM-DD), retornar como est√°
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }
                
                // Se est√° no formato DD/MM/YYYY ou DD/MM/YYYY HH:MM
                const brazilianMatch = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (brazilianMatch) {
                    const [, day, month, year] = brazilianMatch;
                    const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    return isoDate;
                }
                
                return null;
                
            } catch (error) {
                console.error('‚ùå Erro na convers√£o de data:', dateString, error);
                return null;
            }
        }

        // Fun√ß√£o para converter n√∫meros brasileiros
        function parseBRNumber(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;
            
            const str = value.toString().replace(',', '.');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        // Fun√ß√£o para determinar turno
        function determineTurno(dateString) {
            if (!dateString) return 'Dia';
            
            const match = dateString.match(/(\d{1,2}):(\d{2})/);
            if (!match) return 'Dia';
            
            const hour = parseInt(match[1]);
            
            if (hour >= 6 && hour < 12) return 'Manh√£';
            if (hour >= 12 && hour < 18) return 'Tarde';
            if (hour >= 18 && hour < 24) return 'Noite';
            return 'Madrugada';
        }

        // Fun√ß√£o para extrair hora
        function extractHour(dateString) {
            if (!dateString) return '';
            
            const match = dateString.match(/(\d{1,2}):(\d{2})/);
            return match ? `${match[1].padStart(2, '0')}:${match[2]}` : '';
        }

        // Inicializa√ß√£o do dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando Dashboard Maestro Food SEM LIMITES...');
            
            try {
                // Atualizar status
                updateStatus('supabaseStatus', 'success', '‚úÖ Supabase Conectado');
                updateStatus('dataStatus', 'warning', '‚è≥ Carregando dados...');
                
                // Carregar dados
                await loadData();
                
                console.log('‚úÖ Dashboard inicializado com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                updateStatus('supabaseStatus', 'error', '‚ùå Erro de conex√£o');
                updateStatus('dataStatus', 'error', '‚ùå Erro ao carregar');
                updateStatus('processStatus', 'error', '‚ùå Falha na inicializa√ß√£o');
                
                // Mostrar estado vazio
                document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Erro ao carregar dados';
            }
        });

        // Atualizar indicadores de status
        function updateStatus(elementId, type, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status-indicator ${type}`;
                element.textContent = text;
            }
        }

        // FUN√á√ÉO CORRIGIDA: Carregar dados do Supabase SEM LIMITES
        async function loadData() {
            console.log('üìä Carregando TODOS os dados do Supabase (SEM LIMITES)...');
            
            try {
                allData = [];
                let page = 0;
                const pageSize = 1000;
                let hasMore = true;
                
                updateStatus('dataStatus', 'warning', '‚è≥ Carregando dados...');
                
                // REMOVIDO COMPLETAMENTE O LIMITE - CARREGA TODOS OS REGISTROS
                while (hasMore) {
                    console.log(`üìÑ Carregando p√°gina ${page + 1}...`);
                    
                    const { data, error } = await supabase
                        .from('vendas_kpi_daily_v2_data')
                        .select('*')
                        .range(page * pageSize, (page + 1) * pageSize - 1)
                        .order('dia', { ascending: true });
                    
                    if (error) {
                        console.error('‚ùå Erro ao carregar dados:', error);
                        throw error;
                    }
                    
                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        console.log(`‚úÖ P√°gina ${page + 1}: ${data.length} registros`);
                        
                        // Atualizar status com progresso
                        updateStatus('dataStatus', 'warning', `‚è≥ ${allData.length} registros`);
                        
                        hasMore = data.length === pageSize;
                        page++;
                    } else {
                        hasMore = false;
                    }
                }
                
                console.log(`‚úÖ TOTAL DE REGISTROS CARREGADOS (SEM LIMITES): ${allData.length}`);
                
                if (allData.length === 0) {
                    updateStatus('dataStatus', 'warning', '‚ö†Ô∏è Sem dados');
                    updateStatus('processStatus', 'warning', '‚ö†Ô∏è Banco vazio');
                    document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Sem dados ¬∑ 0 registros';
                    return;
                }
                
                // Processar dados
                await processData();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                updateStatus('dataStatus', 'error', '‚ùå Erro ao carregar');
                throw error;
            }
        }

        // Processar dados carregados
        async function processData() {
            console.log('‚öôÔ∏è Processando dados...');
            
            try {
                // CORRE√á√ÉO CR√çTICA: Validar e converter datas ANTES de usar
                const validData = [];
                let invalidCount = 0;
                
                for (const record of allData) {
                    // Converter data para ISO
                    const isoDate = convertDateToISO(record.dia);
                    
                    if (isoDate) {
                        record.dia = isoDate;
                        validData.push(record);
                    } else {
                        invalidCount++;
                        console.warn('‚ö†Ô∏è Registro com data inv√°lida ignorado:', record.dia);
                    }
                }
                
                allData = validData;
                filteredData = [...allData];
                
                console.log(`‚úÖ Dados processados: ${allData.length} registros v√°lidos, ${invalidCount} inv√°lidos`);
                
                // Calcular per√≠odo
                await calculateDateRange();
                
                // Carregar op√ß√µes dos filtros
                await buildFilterOptions();
                
                // Calcular KPIs
                calculateKPIs();
                
                // Atualizar gr√°fico
                updateChart();
                
                // Atualizar status final
                updateStatus('dataStatus', 'success', `‚úÖ ${allData.length} registros`);
                updateStatus('processStatus', 'success', '‚úÖ Dados carregados');
                
            } catch (error) {
                console.error('‚ùå Erro ao processar dados:', error);
                updateStatus('processStatus', 'error', '‚ùå Erro no processamento');
                throw error;
            }
        }

        // Calcular per√≠odo dos dados
        async function calculateDateRange() {
            if (allData.length === 0) {
                document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Sem dados ¬∑ 0 registros';
                return;
            }
            
            try {
                // Encontrar datas m√≠nima e m√°xima
                const dates = allData.map(record => record.dia).filter(date => date);
                
                if (dates.length === 0) {
                    document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Datas inv√°lidas ¬∑ 0 registros';
                    return;
                }
                
                dates.sort();
                minISO = dates[0];
                maxISO = dates[dates.length - 1];
                
                console.log('üìÖ Per√≠odo calculado:', minISO, '‚Üí', maxISO);
                
                // Formatar datas para exibi√ß√£o
                const minFormatted = formatDateBR(minISO);
                const maxFormatted = formatDateBR(maxISO);
                
                document.getElementById('periodInfo').textContent = 
                    `üìÖ Per√≠odo: ${minFormatted} ‚Üí ${maxFormatted} ¬∑ ${allData.length} registros`;
                
                // CORRE√á√ÉO CR√çTICA: Definir datas nos campos SEM formata√ß√£o
                document.getElementById('dataInicial').value = minISO;
                document.getElementById('dataFinal').value = maxISO;
                
            } catch (error) {
                console.error('‚ùå Erro ao calcular per√≠odo:', error);
                document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Erro ao calcular ¬∑ 0 registros';
            }
        }

        // FUN√á√ÉO CORRIGIDA: Formatar data para exibi√ß√£o brasileira
        function formatDateBR(isoDate) {
            if (!isoDate) return '';
            
            try {
                const [year, month, day] = isoDate.split('-');
                return `${day}/${month}/${year}`;
            } catch (error) {
                console.error('‚ùå Erro ao formatar data:', isoDate, error);
                return isoDate;
            }
        }

        // Construir op√ß√µes dos filtros
        async function buildFilterOptions() {
            console.log('üîß Construindo op√ß√µes dos filtros...');
            
            try {
                // Unidades
                const unidades = [...new Set(allData.map(record => record.unidade))].filter(Boolean).sort();
                buildSelectOptions('filterUnidade', unidades);
                
                // Top 10 lojas por faturamento
                const lojasFaturamento = {};
                allData.forEach(record => {
                    const loja = record['Nome da loja'];
                    if (loja) {
                        lojasFaturamento[loja] = (lojasFaturamento[loja] || 0) + parseBRNumber(record.fat);
                    }
                });
                
                const topLojas = Object.entries(lojasFaturamento)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10)
                    .map(([loja]) => loja);
                
                buildSelectOptions('filterLoja', topLojas);
                
                // Canais de venda
                const canais = [...new Set(allData.map(record => record['Canal de venda']))].filter(Boolean).sort();
                buildSelectOptions('filterCanal', canais);
                
                // Formas de pagamento
                const pagamentos = [...new Set(allData.map(record => record.pagamento))].filter(Boolean).sort();
                buildSelectOptions('filterPagamento', pagamentos);
                
                console.log('‚úÖ Op√ß√µes dos filtros constru√≠das');
                
            } catch (error) {
                console.error('‚ùå Erro ao construir filtros:', error);
            }
        }

        // Construir op√ß√µes de um select
        function buildSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Manter primeira op√ß√£o (Todos/Todas)
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            // Adicionar novas op√ß√µes
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        /**
         * FUN√á√ÉO CORRIGIDA: Aplicar filtros
         * PROBLEMA RESOLVIDO: Usa valores ISO diretamente dos campos input
         */
        function applyFilters() {
            console.log('üîç Aplicando filtros...');
            
            try {
                // Obter valores dos filtros
                const unidade = document.getElementById('filterUnidade').value;
                const loja = document.getElementById('filterLoja').value;
                
                // CORRE√á√ÉO CR√çTICA: Usar valores ISO diretamente dos campos input type="date"
                const dataInicial = document.getElementById('dataInicial').value; // J√° est√° em formato ISO
                const dataFinal = document.getElementById('dataFinal').value;     // J√° est√° em formato ISO
                
                const turno = document.getElementById('filterTurno').value;
                const canal = document.getElementById('filterCanal').value;
                const pagamento = document.getElementById('filterPagamento').value;
                const cancelado = document.getElementById('filterCancelado').value;
                
                console.log('üìÖ Filtros aplicados:', { 
                    unidade, loja, dataInicial, dataFinal, turno, canal, pagamento, cancelado 
                });
                
                // Aplicar filtros
                filteredData = allData.filter(record => {
                    // Filtro de unidade
                    if (unidade && record.unidade !== unidade) return false;
                    
                    // Filtro de loja
                    if (loja && record['Nome da loja'] !== loja) return false;
                    
                    // CORRE√á√ÉO CR√çTICA: Filtros de data usando compara√ß√£o de strings ISO
                    if (dataInicial && record.dia < dataInicial) return false;
                    if (dataFinal && record.dia > dataFinal) return false;
                    
                    // Filtro de turno
                    if (turno && record.turno !== turno) return false;
                    
                    // Filtro de canal
                    if (canal && record['Canal de venda'] !== canal) return false;
                    
                    // Filtro de pagamento
                    if (pagamento && record.pagamento !== pagamento) return false;
                    
                    // Filtro de cancelado
                    if (cancelado !== '') {
                        const isCancelado = record.cancelado === true || record.cancelado === 'true';
                        if (cancelado === 'true' && !isCancelado) return false;
                        if (cancelado === 'false' && isCancelado) return false;
                    }
                    
                    return true;
                });
                
                console.log(`‚úÖ Filtros aplicados: ${filteredData.length} registros de ${allData.length} totais`);
                
                // Atualizar per√≠odo filtrado
                updateFilteredPeriod();
                
                // Recalcular KPIs
                calculateKPIs();
                
                // Atualizar gr√°fico
                updateChart();
                
            } catch (error) {
                console.error('‚ùå Erro ao aplicar filtros:', error);
            }
        }

        // Atualizar per√≠odo filtrado
        function updateFilteredPeriod() {
            if (filteredData.length === 0) {
                document.getElementById('periodInfo').textContent = 'üìÖ Per√≠odo: Sem dados ¬∑ 0 registros';
                return;
            }
            
            const dates = filteredData.map(record => record.dia).filter(date => date);
            dates.sort();
            
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            const minFormatted = formatDateBR(minDate);
            const maxFormatted = formatDateBR(maxDate);
            
            document.getElementById('periodInfo').textContent = 
                `üìÖ Per√≠odo: ${minFormatted} ‚Üí ${maxFormatted} ¬∑ ${filteredData.length} registros`;
        }

        // Limpar filtros
        function clearFilters() {
            console.log('üîÑ Limpando filtros...');
            
            // Resetar todos os filtros
            document.getElementById('filterUnidade').value = '';
            document.getElementById('filterLoja').value = '';
            document.getElementById('dataInicial').value = minISO;
            document.getElementById('dataFinal').value = maxISO;
            document.getElementById('filterPeriodo').value = '';
            document.getElementById('filterTurno').value = '';
            document.getElementById('filterCanal').value = '';
            document.getElementById('filterPagamento').value = '';
            document.getElementById('filterCancelado').value = '';
            
            // Aplicar filtros (sem filtros = todos os dados)
            applyFilters();
        }

        // Calcular KPIs
        function calculateKPIs() {
            console.log('üìä Calculando KPIs...');
            
            try {
                if (filteredData.length === 0) {
                    // Zerar todos os KPIs
                    document.getElementById('kpiPedidos').textContent = '-';
                    document.getElementById('kpiTicketMedio').textContent = 'R$ -';
                    document.getElementById('kpiFaturamento').textContent = 'R$ -';
                    document.getElementById('kpiFaturamentoDia').textContent = 'R$ -';
                    document.getElementById('kpiIncentivos').textContent = 'R$ -';
                    document.getElementById('kpiIncentivosPercent').textContent = '-%';
                    document.getElementById('kpiFrete').textContent = 'R$ -';
                    document.getElementById('kpiFaturamentoLiquido').textContent = 'R$ -';
                    
                    // Zerar comparativos
                    ['compPedidos', 'compTicketMedio', 'compFaturamento', 'compFaturamentoDia', 
                     'compIncentivos', 'compIncentivosPercent', 'compFrete', 'compFaturamentoLiquido'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.innerHTML = '<span class="comparison-neutral">‚Äî N/A</span>';
                        }
                    });
                    
                    return;
                }
                
                // Calcular KPIs
                const pedidos = filteredData.length;
                const faturamento = filteredData.reduce((sum, record) => sum + parseBRNumber(record.fat), 0);
                const desconto = filteredData.reduce((sum, record) => sum + parseBRNumber(record.des), 0);
                const frete = filteredData.reduce((sum, record) => sum + parseBRNumber(record.fre), 0);
                
                const ticketMedio = pedidos > 0 ? faturamento / pedidos : 0;
                const faturamentoLiquido = faturamento - desconto;
                const incentivosPercent = faturamento > 0 ? (desconto / faturamento) * 100 : 0;
                
                // Calcular dias √∫nicos para faturamento m√©dio por dia
                const diasUnicos = [...new Set(filteredData.map(record => record.dia))].length;
                const faturamentoDia = diasUnicos > 0 ? faturamento / diasUnicos : 0;
                
                // Atualizar KPIs na interface
                document.getElementById('kpiPedidos').textContent = pedidos.toLocaleString('pt-BR');
                document.getElementById('kpiTicketMedio').textContent = 'R$ ' + ticketMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiFaturamento').textContent = 'R$ ' + faturamento.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiFaturamentoDia').textContent = 'R$ ' + faturamentoDia.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiIncentivos').textContent = 'R$ ' + desconto.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiIncentivosPercent').textContent = incentivosPercent.toFixed(1) + '%';
                document.getElementById('kpiFrete').textContent = 'R$ ' + frete.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('kpiFaturamentoLiquido').textContent = 'R$ ' + faturamentoLiquido.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                console.log('‚úÖ KPIs calculados:', { pedidos, faturamento, ticketMedio, desconto, frete, faturamentoLiquido });
                
                // Calcular comparativos (implementa√ß√£o futura)
                updateComparisons();
                
            } catch (error) {
                console.error('‚ùå Erro ao calcular KPIs:', error);
            }
        }

        // Atualizar comparativos
        function updateComparisons() {
            // Por enquanto, mostrar N/A para todos os comparativos
            // Em implementa√ß√£o futura, calcular per√≠odo anterior equivalente
            ['compPedidos', 'compTicketMedio', 'compFaturamento', 'compFaturamentoDia', 
             'compIncentivos', 'compIncentivosPercent', 'compFrete', 'compFaturamentoLiquido'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<span class="comparison-neutral">‚Äî N/A</span>';
                }
            });
        }

        // Atualizar gr√°fico
        function updateChart() {
            console.log('üìà Atualizando gr√°fico...');
            
            try {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                // Destruir gr√°fico anterior se existir
                if (chart) {
                    chart.destroy();
                }
                
                if (filteredData.length === 0) {
                    // Gr√°fico vazio
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Receita Di√°ria',
                                data: [],
                                borderColor: 'rgba(102, 126, 234, 1)',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    labels: { color: 'white' }
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: 'white' },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: { 
                                    ticks: { color: 'white' },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                }
                            }
                        }
                    });
                    return;
                }
                
                // Agrupar dados por dia
                const dailyRevenue = {};
                filteredData.forEach(record => {
                    const day = record.dia;
                    if (day) {
                        dailyRevenue[day] = (dailyRevenue[day] || 0) + parseBRNumber(record.fat);
                    }
                });
                
                // Ordenar datas
                const sortedDays = Object.keys(dailyRevenue).sort();
                const revenues = sortedDays.map(day => dailyRevenue[day]);
                
                // Formatar labels
                const labels = sortedDays.map(day => formatDateBR(day));
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Receita Di√°ria',
                            data: revenues,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y: { 
                                ticks: { 
                                    color: 'white',
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico atualizado');
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar gr√°fico:', error);
            }
        }

        // Fun√ß√£o de debug
        function debugInfo() {
            console.log('üîç === DEBUG INFO ===');
            console.log('üìä Total de registros (SEM LIMITES):', allData.length);
            console.log('üîç Registros filtrados:', filteredData.length);
            console.log('üìÖ Per√≠odo:', minISO, '‚Üí', maxISO);
            
            if (filteredData.length > 0) {
                console.log('üìã Amostra de dados filtrados:', filteredData.slice(0, 3));
                
                // Verificar dados do dia 10/08/2025
                const testDate = '2025-08-10';
                const testData = filteredData.filter(record => record.dia === testDate);
                console.log(`üéØ Dados para ${testDate}:`, testData.length, 'registros');
                
                if (testData.length > 0) {
                    const totalPedidos = testData.length;
                    const totalFaturamento = testData.reduce((sum, record) => sum + parseBRNumber(record.fat), 0);
                    const totalDesconto = testData.reduce((sum, record) => sum + parseBRNumber(record.des), 0);
                    console.log(`üìä ${testDate} - Pedidos: ${totalPedidos}, Faturamento: R$ ${totalFaturamento.toFixed(2)}, Desconto: R$ ${totalDesconto.toFixed(2)}`);
                    
                    // Comparar com esperado
                    console.log('üéØ COMPARA√á√ÉO:');
                    console.log('Esperado: 563 pedidos, R$ 36.026,26, R$ 4.905,90');
                    console.log('Atual:', totalPedidos, 'pedidos, R$', totalFaturamento.toFixed(2), ', R$', totalDesconto.toFixed(2));
                    console.log('Correto?', totalPedidos === 563 && Math.abs(totalFaturamento - 36026.26) < 100);
                }
            }
            
            console.log('üîç === FIM DEBUG ===');
        }

        /**
         * FUN√á√ÉO CORRIGIDA: Importar CSV SEM LIMITES
         * MELHORADA PARA FUNCIONAR 100%
         */
        async function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo CSV.');
                return;
            }
            
            console.log('üìÅ Importando arquivo CSV SEM LIMITES:', file.name);
            
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const importStatus = document.getElementById('importStatus');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            importStatus.textContent = 'Iniciando importa√ß√£o SEM LIMITES...';
            
            try {
                Papa.parse(file, {
                    header: true,
                    delimiter: ';',
                    skipEmptyLines: true,
                    complete: async function(results) {
                        console.log('üìä Arquivo processado SEM LIMITES:', results.data.length, 'registros');
                        
                        if (results.errors.length > 0) {
                            console.warn('‚ö†Ô∏è Erros no parsing:', results.errors);
                        }
                        
                        let successCount = 0;
                        let errorCount = 0;
                        const batchSize = 100;
                        
                        for (let i = 0; i < results.data.length; i += batchSize) {
                            const batch = results.data.slice(i, i + batchSize);
                            const processedBatch = [];
                            
                            for (const row of batch) {
                                try {
                                    // CORRE√á√ÉO CR√çTICA: Usar fun√ß√£o de convers√£o testada
                                    const dataVenda = row['Data da venda'];
                                    const isoDate = convertDateToISO(dataVenda);
                                    
                                    if (!isoDate) {
                                        console.warn('‚ö†Ô∏è Data inv√°lida ignorada:', dataVenda);
                                        errorCount++;
                                        continue;
                                    }
                                    
                                    // Mapear campos
                                    const record = {
                                        dia: isoDate,
                                        unidade: row['unidade'] || '',
                                        'Nome da loja': row['Nome da loja'] || '',
                                        'Canal de venda': row['Canal de venda'] || '',
                                        pagamento: row['Pagamento'] || '',
                                        cancelado: row['Est√° cancelado'] === 'S',
                                        turno: determineTurno(dataVenda),
                                        pedidos: 1, // Cada linha √© um pedido
                                        fat: parseBRNumber(row['Total']),
                                        des: parseBRNumber(row['Desconto']),
                                        fre: parseBRNumber(row['Entrega']),
                                        hora: extractHour(dataVenda)
                                    };
                                    
                                    processedBatch.push(record);
                                    
                                } catch (error) {
                                    console.error('‚ùå Erro ao processar linha:', row, error);
                                    errorCount++;
                                }
                            }
                            
                            // Inserir lote
                            if (processedBatch.length > 0) {
                                try {
                                    const { error } = await supabase
                                        .from('vendas_kpi_daily_v2_data')
                                        .insert(processedBatch);
                                    
                                    if (error) {
                                        console.error('‚ùå Erro ao inserir lote:', error);
                                        errorCount += processedBatch.length;
                                    } else {
                                        successCount += processedBatch.length;
                                    }
                                } catch (error) {
                                    console.error('‚ùå Erro na inser√ß√£o:', error);
                                    errorCount += processedBatch.length;
                                }
                            }
                            
                            // Atualizar progresso
                            const progress = ((i + batchSize) / results.data.length) * 100;
                            progressBar.style.width = Math.min(progress, 100) + '%';
                            progressBar.textContent = Math.min(progress, 100).toFixed(0) + '%';
                            importStatus.textContent = `Processando SEM LIMITES: ${Math.min(i + batchSize, results.data.length)} de ${results.data.length}`;
                        }
                        
                        // Finalizar
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        importStatus.textContent = `Importa√ß√£o SEM LIMITES conclu√≠da! ${successCount} registros importados, ${errorCount} erros`;
                        
                        console.log(`‚úÖ Importa√ß√£o SEM LIMITES finalizada: ${successCount} sucessos, ${errorCount} erros`);
                        
                        // Recarregar dados
                        if (successCount > 0) {
                            setTimeout(() => {
                                loadData();
                            }, 2000);
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro na importa√ß√£o:', error);
                importStatus.textContent = 'Erro na importa√ß√£o: ' + error.message;
            }
        }
    </script>
</body>
</html>

