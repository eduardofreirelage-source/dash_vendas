<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas — Supabase (v17.2-MV-paged)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--ink:#0f172a;--muted:#6b7280;--bg:#f6f7fb;--card:#fff;--brd:#e5e7eb}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:var(--muted);font-size:12px}
      .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
      .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
      .title{font-size:12px;color:var(--muted)}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--brd);border-radius:999px;padding:6px 10px;background:#fff}
      .btn{cursor:pointer;border:1px solid var(--brd);background:#fff;border-radius:8px;padding:8px 10px}
      .btn:disabled{opacity:.6;cursor:not-allowed}
      select,input{border:1px solid var(--brd);border-radius:8px;padding:8px;background:#fff}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      canvas{width:100%;height:280px}
      @media (max-width:920px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:520px){.grid{grid-template-columns:1fr}}
      code.k{background:#eef2ff;padding:0 4px;border-radius:4px}
    </style>

    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <!-- Chart.js UMD -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Build <code class="k">v17.2-MV-paged</code> • fonte preferida: <code class="k">public.vendas_kpi_daily_v2</code></div>
          <div class="muted">URL: <code class="k" id="sb_url">—</code></div>
          <div class="muted">Período: <code class="k" id="periodo">—</code></div>
        </div>
        <div class="pill">
          <span class="muted">Modo</span>
          <label><input type="radio" name="modo" value="bruto" checked> Total (bruto)</label>
          <label><input type="radio" name="modo" value="liquido"> Líquido (Total − Entrega)</label>
        </div>
      </div>

      <!-- Filtros principais -->
      <div class="card" style="margin-top:12px">
        <div class="row">
          <div>
            <div class="title">Unidade</div>
            <select id="f_unidade">
              <option>Todas</option>
            </select>
          </div>

          <div>
            <div class="title">Período rápido (dias)</div>
            <div class="row">
              <button class="btn" data-quick="7">7</button>
              <button class="btn" data-quick="15">15</button>
              <button class="btn" data-quick="30">30</button>
              <button class="btn" data-quick="90">90</button>
              <button class="btn" data-quick="180">180</button>
              <button class="btn" data-quick="360">360</button>
            </div>
          </div>

          <div>
            <div class="title">De (dd/mm/aaaa)</div>
            <input id="f_de" placeholder="dd/mm/aaaa" />
          </div>
          <div>
            <div class="title">Até (dd/mm/aaaa)</div>
            <input id="f_ate" placeholder="dd/mm/aaaa" />
          </div>

          <div style="margin-left:auto;display:flex;gap:8px">
            <button id="btn_aplicar" class="btn">Aplicar</button>
            <button id="btn_limpar" class="btn">Limpar filtros</button>
            <button id="btn_recarregar" class="btn">Recarregar</button>
          </div>
        </div>
        <div class="muted" style="margin-top:6px">Se preencher as datas acima, o período rápido é ignorado.</div>
      </div>

      <!-- KPIs -->
      <div class="grid" style="margin-top:12px">
        <div class="card">
          <div class="title">Pedidos</div>
          <div class="val" id="k_ped">…</div>
          <div class="muted" id="k_ped_sub">—</div>
        </div>
        <div class="card">
          <div class="title">Faturamento</div>
          <div class="val" id="k_fat">…</div>
          <div class="muted" id="k_fat_sub">—</div>
        </div>
        <div class="card">
          <div class="title">Incentivos</div>
          <div class="val" id="k_des">…</div>
          <div class="muted" id="k_des_sub">—</div>
        </div>
        <div class="card">
          <div class="title">Frete</div>
          <div class="val" id="k_fre">…</div>
          <div class="muted" id="k_fre_sub">—</div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="card" style="margin-top:12px">
        <div class="title">Receita diária (R$)</div>
        <div style="position:relative"><canvas id="chart_line"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Totais por dia da semana (R$)</div>
        <div style="position:relative"><canvas id="chart_bar"></canvas></div>
      </div>

      <!-- Logs -->
      <div class="card" style="margin-top:12px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ========= CREDENCIAIS (as mesmas já usadas no seu projeto congelado) =========
      const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      // ========= HELPERS =========
      const elLog = document.getElementById("log");
      const elPeriodo = document.getElementById("periodo");
      const elUrl = document.getElementById("sb_url");
      function log(m){ elLog.textContent += "\\n" + m; elLog.scrollTop = elLog.scrollHeight; }

      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function pct(a,b){
        if(!isFinite(a)||!isFinite(b)||b===0) return {txt:"—",sign:0};
        const p=((a-b)/Math.abs(b))*100;
        const s=p>0?"+":(p<0?"":"");
        return {txt:`${s}${p.toFixed(1)}%`,sign:Math.sign(p)};
      }
      function arrow(sign){ return sign>0?"↑":(sign<0?"↓":"—"); }

      function toISO(d){ return d.toISOString().slice(0,10); }
      function parseBRDate(s){ // dd/mm/aaaa
        const m = /^\\s*(\\d{2})\\/(\\d{2})\\/(\\d{4})\\s*$/.exec(s||"");
        if(!m) return null;
        const [_,dd,mm,yyyy]=m;
        const d = new Date(Number(yyyy), Number(mm)-1, Number(dd));
        return isNaN(d.getTime())?null:d;
      }

      function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
      function daysBetween(a,b){ const MS=86400000; return Math.floor((b-a)/MS)+1; }

      // ========= SUPABASE CLIENT =========
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      elUrl.textContent = SUPABASE_URL.replace(/^https:\\/\\//,'');

      // ========= ESTADO =========
      const st = {
        unidade: "Todas",
        modo: "bruto",
        start: addDays(new Date(), -30),
        end: addDays(new Date(), -1),
        rowsNow: [],
        rowsPrev: [],
      };

      // ========= PAGINAÇÃO ROBUSTA (CORREÇÃO) =========
      // Lote real de 1000 (limite típico do PostgREST). Continua até não vir mais linhas.
      async function fetchPaged(buildQuery){
        const PAGE = 1000;
        let off = 0, all = [];
        for(;;){
          const { data, error } = await buildQuery().range(off, off + PAGE - 1);
          if(error) throw error;
          const rows = data || [];
          if(rows.length === 0) break;
          all.push(...rows);
          off += rows.length; // avança exatamente o que chegou
        }
        return all;
      }

      // ========= CONSULTAS =========
      function baseQuery(d1ISO, d2ISO, unidade){
        let q = supa.from("vendas_kpi_daily_v2")
          .select("dia,unidade,pedidos,fat,des,fre")
          .gte("dia", d1ISO).lte("dia", d2ISO);
        if(unidade && unidade !== "Todas"){
          q = q.eq("unidade", unidade);
        }
        return q;
      }

      async function loadUnits(){
        // Carrega unidades do período atual (suficiente) e de-duplca no cliente
        const d1 = toISO(st.start), d2 = toISO(st.end);
        const rows = await fetchPaged(()=> supa.from("vendas_kpi_daily_v2")
          .select("unidade")
          .gte("dia", d1).lte("dia", d2)
        );
        const set = new Set();
        rows.forEach(r=>{ if(r && r.unidade) set.add(r.unidade); });
        return ["Todas", ...Array.from(set).sort()];
      }

      async function loadWindow(d1, d2, unidade){
        const d1ISO = toISO(d1), d2ISO = toISO(d2);
        log(`[Query] vendas_kpi_daily_v2 | ${d1ISO} → ${d2ISO} | UNI=${unidade} | modo=${st.modo}`);
        const rows = await fetchPaged(()=> baseQuery(d1ISO, d2ISO, unidade));
        log(`[OK] Linhas (atual): ${rows.length.toLocaleString("pt-BR")}`);
        return rows;
      }

      async function loadPrevWindow(){
        const days = daysBetween(st.start, st.end);
        const endPrev = addDays(st.start, -1);
        const startPrev = addDays(endPrev, -(days-1));
        const rows = await loadWindow(startPrev, endPrev, st.unidade);
        log(`[Query] anterior: ${toISO(startPrev)} → ${toISO(endPrev)}`);
        return { rows, startPrev, endPrev };
      }

      // ========= KPIs & GRÁFICOS =========
      function sumAgg(rows){
        let ped=0,fat=0,des=0,fre=0;
        for(const r of rows){ ped += Number(r.pedidos)||0; fat += Number(r.fat)||0; des += Number(r.des)||0; fre += Number(r.fre)||0; }
        return {ped, fat, des, fre};
      }

      function applyModeFat(valFat, valFre){
        return st.modo==="liquido" ? (valFat - valFre) : valFat;
      }

      function setKPI(nowAgg, prevAgg){
        // pedidos
        const pNow = nowAgg.ped, pPrev = prevAgg.ped;
        const pp = pct(pNow, pPrev);
        document.getElementById("k_ped").textContent = fmtInt(pNow);
        document.getElementById("k_ped_sub").textContent = `${pp.txt} vs ant. • ant: ${fmtInt(pPrev)} ${arrow(pp.sign)}`;

        // faturamento (modo)
        const fNow = applyModeFat(nowAgg.fat, nowAgg.fre);
        const fPrev = applyModeFat(prevAgg.fat, prevAgg.fre);
        const pf = pct(fNow, fPrev);
        document.getElementById("k_fat").textContent = fmtBRL(fNow);
        document.getElementById("k_fat_sub").textContent = `${pf.txt} vs ant. • ant: ${fmtBRL(fPrev)} ${arrow(pf.sign)}`;

        // incentivos
        const dNow = nowAgg.des, dPrev = prevAgg.des;
        const pd = pct(dNow, dPrev);
        document.getElementById("k_des").textContent = fmtBRL(dNow);
        document.getElementById("k_des_sub").textContent = `${pd.txt} vs ant. • ant: ${fmtBRL(dPrev)} ${arrow(pd.sign)}`;

        // frete
        const rNow = nowAgg.fre, rPrev = prevAgg.fre;
        const pr = pct(rNow, rPrev);
        document.getElementById("k_fre").textContent = fmtBRL(rNow);
        document.getElementById("k_fre_sub").textContent = `${pr.txt} vs ant. • ant: ${fmtBRL(rPrev)} ${arrow(pr.sign)}`;
      }

      let chartLine = null, chartBar = null;

      function destroyCharts(){
        try{ if(chartLine){ chartLine.destroy(); chartLine=null; } }catch(_){}
        try{ if(chartBar){ chartBar.destroy(); chartBar=null; } }catch(_){}
      }

      function drawCharts(rows){
        destroyCharts();

        // Agrupar por dia
        const mapByDay = new Map(); // diaISO -> {fat, fre}
        for(const r of rows){
          const k = r.dia;
          if(!mapByDay.has(k)) mapByDay.set(k,{fat:0, fre:0});
          const acc = mapByDay.get(k);
          acc.fat += Number(r.fat)||0;
          acc.fre += Number(r.fre)||0;
        }
        const days = Array.from(mapByDay.keys()).sort();
        const serie = days.map(d=>{
          const v = mapByDay.get(d);
          return applyModeFat(v.fat, v.fre);
        });

        // Linha
        const ctx1 = document.getElementById("chart_line");
        chartLine = new Chart(ctx1, {
          type: "line",
          data: {
            labels: days,
            datasets: [{ label: "Receita diária", data: serie, tension:.25 }]
          },
          options: {
            responsive:true,
            maintainAspectRatio:false,
            interaction:{mode:"index",intersect:false},
            scales:{ y:{ ticks:{ callback:(v)=>fmtBRL(v) } } },
            plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>fmtBRL(ctx.parsed.y) } } }
          }
        });

        // Por dia da semana
        const week = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
        const sumWeek = [0,0,0,0,0,0,0];
        for(const [d,v] of mapByDay){
          const w = (new Date(d+"T00:00:00")).getDay();
          sumWeek[w] += applyModeFat(v.fat, v.fre);
        }
        const ctx2 = document.getElementById("chart_bar");
        chartBar = new Chart(ctx2, {
          type: "bar",
          data: { labels: week, datasets: [{ label:"Total por dia da semana", data: sumWeek }] },
          options: {
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>fmtBRL(ctx.parsed.y) } } },
            scales:{ y:{ ticks:{ callback:(v)=>fmtBRL(v) } } }
          }
        });
      }

      // ========= UI WIRES =========
      const elUni = document.getElementById("f_unidade");
      const elDe  = document.getElementById("f_de");
      const elAte = document.getElementById("f_ate");
      const btnAplicar = document.getElementById("btn_aplicar");
      const btnLimpar  = document.getElementById("btn_limpar");
      const btnRec     = document.getElementById("btn_recarregar");

      // Período inicial (últimos 30 dias)
      function setPeriodLabel(){ elPeriodo.textContent = `${toISO(st.start)} → ${toISO(st.end)}`; }

      // Botões rápidos
      document.querySelectorAll("button[data-quick]").forEach(b=>{
        b.onclick = async ()=>{
          const dd = Number(b.getAttribute("data-quick"));
          st.start = addDays(new Date(), -dd);
          st.end   = addDays(new Date(), -1);
          elDe.value = elAte.value = "";
          await go();
        };
      });

      // Modo (bruto/liquido)
      document.querySelectorAll("input[name=modo]").forEach(r=>{
        r.onchange = async ()=>{
          st.modo = r.value;
          // não recarrega do servidor: recalcula KPIs/gráficos com os dados já baixados
          drawCharts(st.rowsNow);
          const nowAgg = sumAgg(st.rowsNow);
          const prevAgg = sumAgg(st.rowsPrev);
          setKPI(nowAgg, prevAgg);
        };
      });

      btnAplicar.onclick = async ()=>{
        const d1 = parseBRDate(elDe.value);
        const d2 = parseBRDate(elAte.value);
        if(d1 && d2 && d1<=d2){
          st.start = d1; st.end = d2;
        }
        st.unidade = elUni.value || "Todas";
        await go();
      };

      btnLimpar.onclick = async ()=>{
        elUni.value = "Todas";
        elDe.value = elAte.value = "";
        st.unidade = "Todas";
        st.start = addDays(new Date(), -30);
        st.end   = addDays(new Date(), -1);
        await go();
      };

      btnRec.onclick = async ()=>{ await go(); };

      // ========= CICLO PRINCIPAL =========
      async function go(){
        try{
          setPeriodLabel();
          // carregar unidades para o período atual
          const units = await loadUnits();
          // repopula select sem duplicar
          const cur = st.unidade;
          elUni.innerHTML = "";
          for(const u of units){
            const opt = document.createElement("option");
            opt.textContent = u; opt.value = u;
            elUni.appendChild(opt);
          }
          elUni.value = units.includes(cur) ? cur : "Todas";

          // janela atual
          st.rowsNow = await loadWindow(st.start, st.end, elUni.value);
          // anterior
          const prev = await loadPrevWindow();
          st.rowsPrev = prev.rows;

          // KPIs & Charts
          const nowAgg = sumAgg(st.rowsNow);
          const prevAgg = sumAgg(st.rowsPrev);
          setKPI(nowAgg, prevAgg);
          drawCharts(st.rowsNow);
          log("[OK] KPIs e gráficos atualizados.");
        }catch(e){
          console.error(e);
          log("[ERRO] "+(e.message||String(e)));
        }
      }

      // ========= BOOT =========
      (async function boot(){
        log("[Boot] v17.2-MV-paged — sem ORDER/max; paginação 1000; gráficos estáveis.");
        // período default já setado (30 dias anteriores)
        setPeriodLabel();
        await go();
      })();
    </script>
  </body>
</html>
