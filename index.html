<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Dashboard Vendas</title>
    <link rel="icon" href="data:," />

    <!-- ======== COLOQUE SUAS CREDENCIAIS AQUI (ou use URL/localStorage) ======== -->
    <script>
      // Forma sem objeto literal (evita ":" problemático em alguns casos)
      // Substitua pelas SUAS credenciais reais:
      // Ex.: "https://abcd1234.supabase.co" e "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      window.ENV = window.ENV || {};
      window.ENV.VITE_SUPABASE_URL = https://uahmcfzerofhzjvlzrqc.supabase.co;
      window.ENV.VITE_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU;
    </script>

    <!-- Tailwind (CSS rápido) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel para JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <style>
      html, body, #root { height: 100%; }
    </style>
  </head>

  <body class="bg-gray-50">
    <div id="root" class="min-h-full"></div>

    <!-- App (JSX via Babel) -->
    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // ---------- Utils ----------
      const fmtInt = (v) =>
        new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(Math.round(Number(v) || 0));
      const fmtCur = (v) =>
        new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(v) || 0);

      function Card({ title, value, hint }) {
        return (
          <div className="rounded-lg bg-white shadow-sm border border-gray-200 p-5">
            <div className="text-sm text-gray-600">{title}</div>
            <div className="mt-1 text-2xl font-semibold text-gray-900 tabular-nums">{value}</div>
            {hint ? <div className="mt-1 text-xs text-gray-500">{hint}</div> : null}
          </div>
        );
      }

      function App() {
        const [status, setStatus] = useState("Inicializando…");
        const [error, setError] = useState("");
        const [kpis, setKpis] = useState({ pedidos: 0, faturamento: 0, descontos: 0, frete: 0, periodo: "" });

        // Tabela-fonte (ajuste se necessário)
        const TABLE_NAME = "vendas_import_csv";

        // ----- Credenciais (prioridade: URL > window.ENV > localStorage)
        function getEnv() {
          const qs = new URLSearchParams(location.search);
          const urlFromQs = qs.get("supabaseUrl");
          const anonFromQs = qs.get("anon");

          const urlFromHead = (window.ENV && window.ENV.VITE_SUPABASE_URL) || "";
          const anonFromHead = (window.ENV && window.ENV.VITE_SUPABASE_ANON_KEY) || "";

          const urlFromLs = localStorage.getItem("SUPABASE_URL");
          const anonFromLs = localStorage.getItem("SUPABASE_ANON_KEY");

          const url = urlFromQs || urlFromHead || urlFromLs || "";
          const anon = anonFromQs || anonFromHead || anonFromLs || "";
          return { url, anon };
        }

        const supabaseClient = useMemo(() => {
          try {
            const { url, anon } = getEnv();
            if (!url || !anon) return null;
            return window.supabase.createClient(url, anon);
          } catch {
            return null;
          }
        }, []);

        useEffect(() => {
          (async () => {
            try {
              const { url, anon } = getEnv();

              if (!url || !anon) {
                setStatus("Credenciais ausentes.");
                setError([
                  "Defina as credenciais de uma destas formas:",
                  "1) Edite o index.html e preencha window.ENV no <head>.",
                  "2) Use parâmetros na URL: ?supabaseUrl=...&anon=...",
                  "3) Pelo Console do navegador:",
                  "   localStorage.setItem('SUPABASE_URL','https://SEU-PROJETO.supabase.co')",
                  "   localStorage.setItem('SUPABASE_ANON_KEY','SUA-ANON-KEY-AQUI')",
                  "   e atualize a página.",
                ].join("\n"));
                return;
              }

              if (!supabaseClient) {
                setStatus("Falha ao criar cliente Supabase.");
                setError("Verifique se a URL e a ANON KEY estão corretas.");
                return;
              }

              setStatus("Conectando à Supabase…");

              // Último dia com venda
              const { data: last, error: e1 } = await supabaseClient
                .from(TABLE_NAME)
                .select("data_venda")
                .order("data_venda", { ascending: false })
                .limit(1);

              if (e1) throw e1;
              const lastDay = last?.[0]?.data_venda;
              if (!lastDay) {
                setStatus(`Conectado, mas não encontrei registros em ${TABLE_NAME}.`);
                return;
              }

              const end = new Date(lastDay + "T23:59:59");
              const start = new Date(end);
              start.setDate(end.getDate() - 29);
              const toISO = (d) => d.toISOString().slice(0, 10);

              setStatus(`Consultando KPIs em ${TABLE_NAME} de ${toISO(start)} até ${toISO(end)}…`);

              // Paginação simples
              let all = [];
              const pageSize = 5000;
              for (let from = 0; ; from += pageSize) {
                const to = from + pageSize - 1;
                const { data, error: e2 } = await supabaseClient
                  .from(TABLE_NAME)
                  .select("data_venda, valor_total, desconto, entrega", { count: "exact" })
                  .gte("data_venda", toISO(start))
                  .lte("data_venda", toISO(end))
                  .order("data_venda", { ascending: true })
                  .range(from, to);

                if (e2) throw e2;
                if (!data || data.length === 0) break;
                all = all.concat(data);
                if (data.length < pageSize) break;
              }

              const pedidos = all.length;
              const faturamento = all.reduce((s, r) => s + Number(r.valor_total || 0), 0);
              const descontos = all.reduce((s, r) => s + Number(r.desconto || 0), 0);
              const frete = all.reduce((s, r) => s + Number(r.entrega || 0), 0);

              setKpis({
                pedidos,
                faturamento,
                descontos,
                frete,
                periodo: `${toISO(start)} → ${toISO(end)}`
              });

              setStatus("Conectado e KPIs carregados com sucesso.");
              setError("");
            } catch (err) {
              console.error("[Supabase] Erro:", err);
              setStatus("Falha ao consultar a base.");
              setError(err?.message || String(err));
            }
          })();
        }, [supabaseClient]);

        const { url, anon } = getEnv();

        return (
          <div className="max-w-5xl mx-auto p-6">
            <header className="mb-6">
              <h1 className="text-3xl font-bold text-gray-900">Dashboard Vendas — GitHub Pages</h1>
              <p className="text-sm text-gray-600 mt-1">
                Fonte: <code className="text-gray-800">public.vendas_import_csv</code> (últimos 30 dias)
              </p>
            </header>

            <div className="rounded-lg border p-4 bg-white mb-6">
              <div className="text-sm text-gray-700">
                <span className="font-medium">Status:</span>{" "}
                <span className={error ? "text-rose-700" : "text-emerald-700"}>{status}</span>
              </div>
              <div className="text-xs text-gray-500 mt-1 space-y-1">
                <div>URL: <code>{url || "(não definida)"}</code></div>
                <div>ANON: <code>{anon ? "(definida)" : "(não definida)"}</code></div>
                {kpis.periodo ? <div>Período: <span className="tabular-nums">{kpis.periodo}</span></div> : null}
              </div>
              {error ? (
                <pre className="mt-3 text-xs text-rose-700 whitespace-pre-wrap bg-rose-50 p-2 rounded border border-rose-200">
{error}
                </pre>
              ) : null}
              {!url || !anon ? (
                <div className="mt-3 text-xs text-gray-500">
                  Você também pode informar credenciais via URL, por exemplo:<br />
                  <code>?supabaseUrl=https://SEU-PROJETO.supabase.co&anon=SUA-ANON-KEY</code><br />
                  ou salvar no navegador (Console):<br />
                  <code>localStorage.setItem('SUPABASE_URL','https://SEU-PROJETO.supabase.co')</code><br />
                  <code>localStorage.setItem('SUPABASE_ANON_KEY','SUA-ANON-KEY')</code>
                </div>
              ) : null}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card title="Pedidos" value={fmtInt(kpis.pedidos)} />
              <Card title="Faturamento" value={fmtCur(kpis.faturamento)} />
              <Card title="Incentivos" value={fmtCur(kpis.descontos)} />
              <Card title="Frete" value={fmtCur(kpis.frete)} />
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
