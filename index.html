<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas (Supabase) — v5</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <style>
      body{margin:0;background:#f6f7fb;color:#0f172a;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
      .wrap{max-width:960px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 4px}
      .muted{color:#6b7280;font-size:12px}
      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
      .card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
      .title{font-size:12px;color:#6b7280}
      .val{font-size:22px;font-weight:700;margin-top:4px}
      pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
      code{background:#eef2ff;padding:0 4px;border-radius:4px}
      @media (max-width:820px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
      @media (max-width:480px){.grid{grid-template-columns:1fr}}
    </style>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px">
        <div>
          <h1>Dashboard Vendas — Supabase</h1>
          <div class="muted">Fonte usada: <code id="fonte">detectando…</code></div>
          <div class="muted">Detecção automática de coluna de data • Build v5</div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="title">Status / Logs</div>
        <pre id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== CREDENCIAIS ======
      var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      // ====== UI helpers ======
      var elLog = document.getElementById("log");
      var elFonte = document.getElementById("fonte");
      function log(msg){ elLog.textContent += "\n" + msg; }
      function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
      function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
      function toNum(x){
        if(x==null||x==="")return 0;
        if(typeof x==="number")return x;
        var s=String(x).trim(); if(!s)return 0;
        var t=s.replace(/\./g,"").replace(/,/g,".");
        var n=Number(t); return isFinite(n)?n:0;
      }
      function toISO(d){ return d.toISOString().slice(0,10); }
      function qcol(c){ return /[^a-z0-9_]/i.test(c) ? '"' + c + '"' : c; } // p/ nomes com espaço

      // ====== Supabase client ======
      var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // Vamos usar apenas as tabelas do import CSV
      var TBL_CANDIDATAS = ["vendas_import_csv","VENDAS_IMPORT_CSV"];

      // 1) Detecta qual tabela existe e qual coluna é a de data
      async function detectarTabelaEColunaData(){
        for(const tbl of TBL_CANDIDATAS){
          // pega 1 linha para descobrir os nomes REAIS das colunas
          const r1 = await supa.from(tbl).select("*").limit(1);
          if(r1.error){ log(`[Detect] ${tbl} falhou: ${r1.error.message}`); continue; }
          if(!r1.data || !r1.data.length){ log(`[Detect] ${tbl} vazia.`); continue; }

          const row = r1.data[0];
          const cols = Object.keys(row);
          log(`[Detect] ${tbl} colunas: ${cols.join(", ")}`);

          // tenta achar a coluna de data por nomes comuns
          const preferidas = ["data_venda","Data da venda","Data venda","data","Data"];
          let colData = null;
          for(const guess of preferidas){
            if(cols.includes(guess)){ colData = guess; break; }
          }
          if(!colData){
            // fallback: qualquer coluna cujo valor pareça uma data (aaaa-mm-dd)
            for(const c of cols){
              const v = row[c];
              if(typeof v==="string" && /^\d{4}-\d{2}-\d{2}/.test(v)){ colData = c; break; }
            }
          }
          if(!colData){ log(`[Detect] ${tbl}: não achei coluna de data.`); continue; }

          // confirma a última data (ordenando por essa coluna)
          const r2 = await supa.from(tbl).select(qcol(colData)).not(colData, "is", null).order(colData, { ascending:false }).limit(1);
          if(r2.error){ log(`[Detect] ${tbl}: erro ao ordenar por ${colData}: ${r2.error.message}`); continue; }
          const last = r2.data && r2.data[0] ? String(Object.values(r2.data[0])[0]).slice(0,10) : null;
          if(!last){ log(`[Detect] ${tbl}: sem valor válido em ${colData}.`); continue; }

          return { tabela: tbl, colData, ultimaISO: last };
        }
        throw new Error("Nenhuma tabela/coluna de data detectada (import CSV).");
      }

      // 2) Busca paginada no intervalo
      async function buscarIntervalo(tbl, colData, deISO, ateISO){
        const page=10000; let acc=[], off=0;
        const sel = [colData,"valor_total","desconto","entrega","unidade"].map(qcol).join(",");
        for(;;){
          const qr = await supa.from(tbl)
            .select(sel, { count: "estimated" })
            .gte(colData, deISO)
            .lte(colData, ateISO)
            .range(off, off+page-1);
          if(qr.error) throw qr.error;
          const arr = qr.data||[];
          acc = acc.concat(arr);
          if(arr.length<page) break;
          off += page;
        }
        return acc;
      }

      (async function main(){
        try{
          log("[Boot] Iniciando… (v5, sem max())");

          const pick = await detectarTabelaEColunaData();
          const tbl = pick.tabela, colData = pick.colData, last = pick.ultimaISO;
          elFonte.textContent = `${tbl} (data: ${colData})`;
          log(`[Detect] Tabela: ${tbl} | Coluna data: ${colData} | Última: ${last}`);

          const end = new Date(last+"T23:59:59");
          const start = new Date(end); start.setDate(end.getDate()-29);
          document.getElementById("periodo").textContent = "Período: "+toISO(start)+" → "+toISO(end);
          log("[Query] Intervalo: "+toISO(start)+" → "+toISO(end));

          const rows = await buscarIntervalo(tbl, colData, toISO(start), toISO(end));
          log("[Query] Linhas: "+rows.length.toLocaleString("pt-BR"));

          let pedidos=rows.length, fat=0, desc=0, fre=0;
          for(const r of rows){
            fat  += toNum(r.valor_total);
            desc += toNum(r.desconto);
            fre  += toNum(r.entrega);
          }

          document.getElementById("k_ped").textContent = fmtInt(pedidos);
          document.getElementById("k_fat").textContent = fmtBRL(fat);
          document.getElementById("k_desc").textContent = fmtBRL(desc);
          document.getElementById("k_fre").textContent = fmtBRL(fre);

          log("[OK] KPIs preenchidos. Se estiver tudo certo, adiciono o filtro por UNIDADE.");
        }catch(e){
          log("[ERRO] "+(e.message||String(e)));
        }
      })();
    </script>
  </body>
</html>
