<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Debug Vendas – RPC Tester</title>
<style>
  :root{--bg:#0b1020;--panel:#151a2c;--muted:#8ea0c0;--accent:#34d399;--warn:#f59e0b;--err:#ef4444}
  body{background:var(--bg);color:#e5ecff;font-family:Inter,system-ui,Arial,sans-serif;margin:0}
  h1{font-size:18px;margin:16px 0}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #26314e;border-radius:14px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 240px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;background:#0e1426;color:#e5ecff;border:1px solid #2a375c;border-radius:10px;padding:10px;font-size:14px}
  textarea{min-height:100px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  button{background:#1b2440;border:1px solid #2f3b64;color:#e5ecff;padding:10px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);border-color:#24b57f;color:#092318;font-weight:600}
  button.warn{background:var(--warn);border-color:#d5890b;color:#1f1200}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .pill{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;background:#0f1630;border:1px solid #2a375c;color:#a2b4da;font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
  .ok{color:var(--accent)} .bad{color:var(--err)}
  .muted{color:var(--muted)}
  .hl{background:#09102a;padding:10px;border-radius:10px;border:1px dashed #33406b}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Debug de RPCs (KPIs e Gráficos) — Supabase</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Supabase URL</label>
        <input id="sb-url" placeholder="https://SEU-PROJ.supabase.co">
      </div>
      <div class="col">
        <label>Anon Key</label>
        <input id="sb-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
      </div>
      <div class="col" style="flex:0 0 160px;align-self:flex-end">
        <button class="primary" id="btn-save">Salvar Conexão</button>
      </div>
    </div>
    <div class="small muted">Dica: os valores ficam salvos no seu navegador (localStorage).</div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label>Data Inicial (p_dini)</label>
        <input type="date" id="dini">
      </div>
      <div>
        <label>Data Final (p_dfim)</label>
        <input type="date" id="dfim">
      </div>
      <div>
        <label>Unidades (p_unids) — lista separada por vírgula</label>
        <input id="unids" placeholder="ex.: uni.raja,uni.savassi">
      </div>
      <div>
        <label>Lojas (p_lojas)</label>
        <input id="lojas" placeholder="ex.: loja a,loja b">
      </div>
      <div>
        <label>Turnos (p_turnos)</label>
        <input id="turnos" placeholder="ex.: manhã,dia,noite">
      </div>
      <div>
        <label>Canais (p_canais)</label>
        <input id="canais" placeholder="ex.: ifood,anota.ai,telefone">
      </div>
      <div>
        <label>Pagamentos (p_pags)</label>
        <input id="pags" placeholder="ex.: pix,pago online">
      </div>
      <div>
        <label>Cancelado (p_cancelado)</label>
        <select id="cancelado">
          <option value="">Todos</option>
          <option>Não</option>
          <option>Sim</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn-kpi" class="primary">Chamar KPI (kpi_vendas_v2)</button>
      <button id="btn-dow">Chart DOW (chart_vendas_dow_v2)</button>
      <button id="btn-hora">Chart HORA (chart_vendas_hora_v2)</button>
      <button id="btn-mes">Chart MÊS (chart_vendas_mes_v2)</button>
      <button id="btn-base">Amostra BASE (contagem)</button>
      <button id="btn-clear" class="warn">Limpar Saída</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Parâmetros Enviados</label>
        <pre id="out-params" class="hl mono"></pre>
      </div>
      <div class="col">
        <label>Resumo</label>
        <div id="out-resumo" class="hl mono"></div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Resposta Completa</label>
      <textarea id="out-json" class="mono" spellcheck="false"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Smoke Test SQL A (via função) — copie no Editor SQL</label>
        <pre class="hl mono small" id="sql-a"></pre>
      </div>
      <div class="col">
        <label>Smoke Test SQL B (via view) — copie no Editor SQL</label>
        <pre class="hl mono small" id="sql-b"></pre>
      </div>
    </div>
    <div class="muted small">Se A == B, os filtros/base estão coerentes. Para trocar o período, ajuste as datas aqui em cima e o texto será atualizado.</div>
  </div>

  <div class="card">
    <b>Erros comuns</b>
    <ul class="small">
      <li>Rodar <span class="mono">const args = {...}</span> no Editor SQL &rarr; <span class="bad">vai dar syntax error</span>. Use no navegador (este HTML) ou no Console (F12).</li>
      <li>Arrays de filtros precisam ser enviados como lista JSON: <span class="mono">["pix","pago online"]</span>. Campo vazio = <span class="muted">null</span> (todos).</li>
      <li>Se criou/alterou uma função e o front deu 404, rode no SQL: <span class="mono">select pg_notify('pgrst','reload schema');</span></li>
    </ul>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);

function loadConn(){
  const url = localStorage.getItem('sb_url') || '';
  const key = localStorage.getItem('sb_key') || '';
  $('sb-url').value = url;
  $('sb-key').value = key;
}
function saveConn(){
  localStorage.setItem('sb_url',$('sb-url').value.trim());
  localStorage.setItem('sb_key',$('sb-key').value.trim());
  toast('Conexão salva.');
}
function toast(msg){ console.log('[toast]',msg); }

function toArrayOrNull(txt){
  const s = (txt||'').trim();
  if(!s) return null;
  const arr = s.split(',').map(x=>x.trim()).filter(Boolean);
  return arr.length? arr : null;
}

function params(){
  const p = {
    p_dini: $('dini').value || null,
    p_dfim: $('dfim').value || null,
    p_unids: toArrayOrNull($('unids').value?.toLowerCase()),
    p_lojas: toArrayOrNull($('lojas').value?.toLowerCase()),
    p_turnos: toArrayOrNull($('turnos').value?.toLowerCase()),
    p_canais: toArrayOrNull($('canais').value?.toLowerCase()),
    p_pags: toArrayOrNull($('pags').value?.toLowerCase()),
    p_cancelado: $('cancelado').value || null
  };
  $('out-params').textContent = JSON.stringify(p,null,2);
  // SQL textos
  const dini = p.p_dini || '2025-08-01';
  const dfim = p.p_dfim || '2025-08-31';
  $('sql-a').textContent =
`select
  sum(pedidos) as pedidos,
  sum(fat)     as fat,
  sum(des)     as des,
  sum(fre)     as fre
from public._vendas_base(date '${dini}', date '${dfim}', null,null,null,null,null,null);`;

  $('sql-b').textContent =
`select
  count(*)      as pedidos,
  sum(fat)      as fat,
  sum(des)      as des,
  sum(fre)      as fre
from public.vw_vendas
where dia between date '${dini}' and date '${dfim}';`;

  return p;
}

async function rpc(fn, args){
  const url = $('sb-url').value.trim().replace(/\/$/,'');
  const key = $('sb-key').value.trim();
  if(!url || !key){ alert('Informe URL e ANON KEY'); throw new Error('missing conn'); }
  const r = await fetch(`${url}/rest/v1/rpc/${fn}`,{
    method:'POST',
    headers:{
      'apikey': key,
      'Authorization': `Bearer ${key}`,
      'Content-Type':'application/json',
      'Prefer':'count=exact'
    },
    body: JSON.stringify(args)
  });
  const text = await r.text();
  let data=null;
  try{ data = text? JSON.parse(text): null; }catch(e){ /* mantém texto cru */ }
  if(!r.ok){
    $('out-json').value = text;
    $('out-resumo').innerHTML = `<span class="bad">[${fn}] ${r.status} ${r.statusText}</span>`;
    throw new Error(`[${fn}] ${text||r.statusText}`);
  }
  $('out-json').value = JSON.stringify(data,null,2);
  return data;
}

function resumoKPI(rows){
  if(!rows || !rows.length) return 'KPI vazio';
  const r = rows[0];
  return `pedidos=${r.pedidos ?? 0} fat=${r.fat ?? 0} des=${r.des ?? 0} fre=${r.fre ?? 0}`;
}
function resumoChart(rows, key){
  if(!rows) return 'Chart vazio';
  const n = rows.length;
  const total = rows.reduce((a,x)=>a + Number(x.total||0), 0);
  return `${key} pontos=${n} soma(total)=${total}`;
}

async function callKPI(){
  try{
    const p = params();
    const d = await rpc('kpi_vendas_v2', p);
    $('out-resumo').innerHTML = `<span class="ok">KPI OK</span> — ${resumoKPI(d)}`;
  }catch(e){ console.error(e); }
}
async function callDOW(){
  try{
    const p = params();
    const d = await rpc('chart_vendas_dow_v2', p);
    $('out-resumo').innerHTML = `<span class="ok">DOW OK</span> — ${resumoChart(d,'dow')}`;
  }catch(e){ console.error(e); }
}
async function callHORA(){
  try{
    const p = params();
    const d = await rpc('chart_vendas_hora_v2', p);
    $('out-resumo').innerHTML = `<span class="ok">HORA OK</span> — ${resumoChart(d,'hora')}`;
  }catch(e){ console.error(e); }
}
async function callMES(){
  try{
    const p = params();
    const d = await rpc('chart_vendas_mes_v2', p);
    $('out-resumo').innerHTML = `<span class="ok">MÊS OK</span> — ${resumoChart(d,'ym')}`;
  }catch(e){ console.error(e); }
}
async function callBASEcount(){
  try{
    const p = params();
    const d = await rpc('_vendas_base', p);
    const n = Array.isArray(d) ? d.length : 0;
    const soma = (Array.isArray(d)? d.reduce((a,x)=>a+Number(x.fat||0),0):0);
    $('out-resumo').innerHTML = `<span class="ok">BASE</span> — linhas=${n} soma(fat)=${soma}`;
  }catch(e){ console.error(e); }
}

$('btn-save').addEventListener('click', saveConn);
$('btn-kpi').addEventListener('click', callKPI);
$('btn-dow').addEventListener('click', callDOW);
$('btn-hora').addEventListener('click', callHORA);
$('btn-mes').addEventListener('click', callMES);
$('btn-base').addEventListener('click', callBASEcount);
$('btn-clear').addEventListener('click', ()=>{
  $('out-json').value = '';
  $('out-resumo').textContent = '';
  $('out-params').textContent = '';
});

function setDefaultDates(){
  const today = new Date();
  const dfim = today.toISOString().slice(0,10);
  const d0 = new Date(today); d0.setDate(d0.getDate()-30);
  const dini = d0.toISOString().slice(0,10);
  $('dini').value = dini; $('dfim').value = dfim;
}

loadConn();
setDefaultDates();
params(); // preencher SQL smoke tests
</script>
</body>
</html>
