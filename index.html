<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maestro Food Dashboard</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%23ff6b35"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root {
      --primary: #ff6b35;
      --primary-light: #ff8c5a;
      --primary-dark: #e55a2b;
      --secondary: #4a90e2;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1a202c;
      --text-muted: #64748b;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, var(--bg) 0%, #e2e8f0 100%);
      color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--primary);
      margin: 0 0 8px 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .status-badge.success {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.error {
      background: #fef2f2;
      color: #991b1b;
    }

    /* Filters */
    .filters-section {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .filters-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-weight: 600;
      color: var(--text);
      font-size: 0.875rem;
    }

    .filter-input {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background: var(--card);
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .filter-input:hover {
      border-color: #cbd5e1;
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
    }

    .kpi-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-muted);
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
      margin: 0;
      line-height: 1.2;
    }

    /* Chart */
    .chart-section {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .chart-container {
      height: 400px;
      position: relative;
    }

    /* Import Section */
    .import-section {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .import-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .import-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .import-badge {
      background: #fef3c7;
      color: #92400e;
      padding: 4px 12px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 24px;
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      background: #f8fafc;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .file-input-label:hover {
      border-color: var(--primary);
      background: #fef7f0;
    }

    .import-status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .import-status.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .import-status.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    /* Debug Button */
    .debug-btn {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 1000;
      background: var(--secondary);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
    }

    .debug-btn:hover {
      background: #357abd;
      transform: translateY(-1px);
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .header {
        padding: 24px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .header-info {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .kpi-value {
        font-size: 1.75rem;
      }
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header fade-in">
      <h1>üçΩÔ∏è Maestro Food Dashboard</h1>
      <div class="header-info">
        <div id="periodo" class="status-badge success">
          <div class="loading" id="loadingIndicator" style="display: none;"></div>
          <span>Per√≠odo: Carregando...</span>
        </div>
        <div id="srcInfo" class="status-badge success">
          <span>Fonte: Conectando...</span>
        </div>
      </div>
    </div>

    <!-- Debug Button -->
    <button class="debug-btn" onclick="debugInfo()">üîç Debug</button>

    <!-- Filters -->
    <div class="filters-section fade-in">
      <div class="filters-header">
        <h2 class="filters-title">üìä Filtros</h2>
        <button class="btn btn-secondary" onclick="clearFilters()">
          üîÑ Limpar Filtros
        </button>
      </div>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">üè¢ Unidade</label>
          <select class="filter-input" id="fUnidade" onchange="reload()">
            <option>Todas</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">üè™ Nome da Loja</label>
          <select class="filter-input" id="fLoja" onchange="reload()">
            <option>Todos</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">üìÖ Data Inicial</label>
          <input type="date" class="filter-input" id="fDini" onchange="reload()">
        </div>

        <div class="filter-group">
          <label class="filter-label">üìÖ Data Final</label>
          <input type="date" class="filter-input" id="fDfim" onchange="reload()">
        </div>

        <div class="filter-group">
          <label class="filter-label">‚ö° Per√≠odo R√°pido</label>
          <select class="filter-input" id="fQuick" onchange="applyQuickPeriod()">
            <option>√öltimos 30 dias</option>
            <option>√öltimos 60 dias</option>
            <option>√öltimos 90 dias</option>
            <option>Este m√™s</option>
            <option>√öltimo m√™s</option>
            <option>Este ano</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">üïê Turno</label>
          <select class="filter-input" id="fTurno" onchange="reload()">
            <option>Todos</option>
            <option>Manh√£</option>
            <option>Tarde</option>
            <option>Noite</option>
            <option>Madrugada</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">üì∫ Canal de Venda</label>
          <select class="filter-input" id="fCanal" onchange="reload()">
            <option>Todos</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">üí≥ Pagamento</label>
          <select class="filter-input" id="fPag" onchange="reload()">
            <option>Todos</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">‚ùå Cancelado</label>
          <select class="filter-input" id="fCanc" onchange="reload()">
            <option>Todos</option>
            <option>N√£o</option>
            <option>Sim</option>
          </select>
        </div>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid fade-in">
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üì¶ Pedidos</h3>
        <p class="kpi-value" id="kPedidos">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üéØ Ticket M√©dio</h3>
        <p class="kpi-value" id="kTicket">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üí∞ Faturamento</h3>
        <p class="kpi-value" id="kFat">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üìà Faturamento M√©dio/Dia</h3>
        <p class="kpi-value" id="kFatDia">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üéÅ Incentivos</h3>
        <p class="kpi-value" id="kDes">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üìä Incentivos %</h3>
        <p class="kpi-value" id="kDesPct">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üöö Frete</h3>
        <p class="kpi-value" id="kFre">‚Äî</p>
      </div>
      
      <div class="kpi-card slide-up">
        <h3 class="kpi-title">üíé Faturamento L√≠quido</h3>
        <p class="kpi-value" id="kFatLiq">‚Äî</p>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-section fade-in">
      <div class="chart-header">
        <h2 class="chart-title">üìà Receita Di√°ria</h2>
        <div class="status-badge success">
          <span>üí∞ Total</span>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <!-- Import Section -->
    <div class="import-section fade-in">
      <div class="import-header">
        <h2 class="import-title">üìÅ Importar CSV</h2>
        <div class="import-badge">Admin</div>
      </div>
      
      <div class="file-input-wrapper">
        <input type="file" class="file-input" id="csv" accept=".csv" onchange="handleFileSelect()">
        <label class="file-input-label" for="csv">
          <span style="font-size: 2rem;">üìÑ</span>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">Selecione um arquivo CSV</div>
            <div style="font-size: 0.875rem; color: var(--text-muted);">Arraste e solte ou clique para selecionar</div>
          </div>
        </label>
      </div>
      
      <button class="btn btn-primary" id="btnImport" onclick="importCSV()" style="margin-top: 16px; width: 100%;">
        üì§ Importar CSV (Incremental)
      </button>
      
      <div id="importStatus" class="import-status" style="display: none;"></div>
      
      <p style="margin-top: 16px; font-size: 0.875rem; color: var(--text-muted); line-height: 1.6;">
        <strong>‚ÑπÔ∏è Importa√ß√£o incremental:</strong> Os dados s√£o somados com deduplica√ß√£o por chave √∫nica 
        (dia, unidade, loja, hora, pagamento, canal). <br>
        <strong>üìã Campos obrigat√≥rios:</strong> Data da venda, unidade, Total. 
        <strong>üìã Campos opcionais:</strong> Entrega, Desconto, etc.
      </p>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
  // Global variables
  let supa, chart;
  let minISO = null, maxISO = null;

  // Configuration
  const SUPABASE_URL = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";

  // DOM Elements
  const $ = (id) => document.getElementById(id);
  const periodoEl = $("periodo");
  const srcInfo = $("srcInfo");
  const loadingIndicator = $("loadingIndicator");
  const uni = $("fUnidade");
  const loja = $("fLoja");
  const dini = $("fDini");
  const dfim = $("fDfim");
  const pr = $("fQuick");
  const turno = $("fTurno");
  const canal = $("fCanal");
  const pag = $("fPag");
  const canc = $("fCanc");
  const csv = $("csv");
  const btnImport = $("btnImport");
  const importStatus = $("importStatus");
  const kPedidos = $("kPedidos");
  const kTicket = $("kTicket");
  const kFat = $("kFat");
  const kFatDia = $("kFatDia");
  const kDes = $("kDes");
  const kDesPct = $("kDesPct");
  const kFre = $("kFre");
  const kFatLiq = $("kFatLiq");
  const chartEl = $("chart");

  // Utility Functions
  const fmtBRL = (v) => isFinite(v) ? v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : "‚Äî";
  const fmtPct = (v) => isFinite(v) ? (v * 100).toFixed(1).replace('.', ',') + '%' : "‚Äî";
  const onlyDate = (iso) => iso && iso.length >= 10 ? iso.slice(0, 10) : iso;
  
  const parseBR = (x) => {
    if (x == null || x === '') return 0;
    if (typeof x === 'number') return x;
    const s = String(x).trim().replace(/\./g, '').replace(',', '.');
    const n = Number(s);
    return isFinite(n) ? n : 0;
  };
  
  const norm = (s) => {
    return String(s ?? "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();
  };
  
  const stripBOM = (str) => {
    return str.charCodeAt(0) === 0xFEFF ? str.slice(1) : str;
  };
  
  const normCancel = (v) => {
    const s = String(v ?? "").trim().toLowerCase();
    if (v === true || s === "sim" || s === "s" || s === "1" || s === "true") return "Sim";
    return "N√£o";
  };

  function ddmmyyyyToISO(s) {
    if (!s) return null;
    const str = String(s).trim();
    const [datePart, timePart] = str.split(' ');
    
    if (!datePart) return null;
    
    const parts = datePart.split('/');
    if (parts.length !== 3) return null;
    
    const [day, month, year] = parts;
    if (!day || !month || !year) return null;
    
    const d = parseInt(day, 10);
    const m = parseInt(month, 10);
    const y = parseInt(year, 10);
    
    if (d < 1 || d > 31 || m < 1 || m > 12 || y < 1900) return null;
    
    return `${y.toString().padStart(4, '0')}-${m.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
  }

  // Wait for libraries and initialize
  (function waitForLibraries() {
    if (typeof supabase === 'undefined' || typeof Papa === 'undefined' || typeof Chart === 'undefined') {
      console.log('‚è≥ Aguardando bibliotecas...');
      setTimeout(waitForLibraries, 100);
      return;
    }
    
    console.log('üöÄ Iniciando Maestro Food Dashboard...');
    initDashboard();
  })();

  // Initialize Dashboard
  async function initDashboard() {
    try {
      // Initialize Supabase
      supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
        auth: { persistSession: true, autoRefreshToken: true }
      });

      console.log('‚úÖ Cliente Supabase inicializado');

      // Show loading
      showLoading(true);

      // Fetch min/max dates
      await fetchMinMax();

      // Build filter options
      await buildOptions();

      // Set default date range to last available date
      if (maxISO) {
        dfim.value = maxISO;
        // Set initial date to 30 days before max date or min date, whichever is later
        const maxDate = new Date(maxISO);
        const thirtyDaysAgo = new Date(maxDate.getTime() - (30 * 24 * 60 * 60 * 1000));
        const minDate = minISO ? new Date(minISO) : thirtyDaysAgo;
        const startDate = thirtyDaysAgo > minDate ? thirtyDaysAgo : minDate;
        dini.value = onlyDate(startDate.toISOString());
      }

      // Load data
      await reload();

      console.log('‚úÖ Dashboard inicializado com sucesso!');
      
    } catch (error) {
      console.error('‚ùå Erro ao inicializar dashboard:', error);
      showError('Erro ao inicializar dashboard');
    } finally {
      showLoading(false);
    }
  }

  // Fetch min/max dates
  async function fetchMinMax() {
    try {
      console.log('üìÖ Buscando per√≠odo dispon√≠vel...');
      
      const [minResult, maxResult] = await Promise.all([
        supa.from(TABLE).select('dia').order('dia', { ascending: true }).limit(1),
        supa.from(TABLE).select('dia').order('dia', { ascending: false }).limit(1)
      ]);

      if (!minResult.error && minResult.data?.length && !maxResult.error && maxResult.data?.length) {
        minISO = onlyDate(minResult.data[0].dia);
        maxISO = onlyDate(maxResult.data[0].dia);
        
        console.log('‚úÖ Per√≠odo dispon√≠vel:', minISO, '‚Üí', maxISO);
        
        updateStatus('success', `Per√≠odo: ${minISO} ‚Üí ${maxISO}`);
        srcInfo.innerHTML = '<span>‚úÖ Fonte: Supabase</span>';
        srcInfo.className = 'status-badge success';
      } else {
        throw new Error('Sem dados dispon√≠veis');
      }
    } catch (error) {
      console.error('‚ùå Erro ao buscar per√≠odo:', error);
      minISO = maxISO = null;
      updateStatus('error', 'Per√≠odo: Erro ao carregar');
      srcInfo.innerHTML = '<span>‚ùå Fonte: Erro</span>';
      srcInfo.className = 'status-badge error';
    }
  }

  // Build filter options
  async function buildOptions() {
    console.log('üîÑ Carregando op√ß√µes dos filtros...');
    
    try {
      // Load all filter options in parallel
      const [unidadesResult, lojasResult, canaisResult, pagamentosResult] = await Promise.all([
        // Unidades - get all distinct values
        supa.from(TABLE)
          .select('unidade')
          .not('unidade', 'is', null)
          .not('unidade', 'eq', ''),
        
        // Top lojas by revenue - get all data to calculate top lojas
        supa.from(TABLE)
          .select('"Nome da loja", fat')
          .not('Nome da loja', 'is', null)
          .not('Nome da loja', 'eq', '')
          .not('fat', 'is', null),
        
        // Canais - get all distinct values
        supa.from(TABLE)
          .select('"Canal de venda"')
          .not('Canal de venda', 'is', null)
          .not('Canal de venda', 'eq', ''),
        
        // Pagamentos - get all distinct values
        supa.from(TABLE)
          .select('pagamento')
          .not('pagamento', 'is', null)
          .not('pagamento', 'eq', '')
      ]);

      // Process Unidades
      if (!unidadesResult.error && unidadesResult.data) {
        const unidades = [...new Set(unidadesResult.data.map(x => x.unidade).filter(Boolean))];
        uni.innerHTML = '<option>Todas</option>' + unidades.map(v => `<option>${v}</option>`).join('');
        console.log('‚úÖ Unidades carregadas:', unidades.length);
      }

      // Process Lojas (Top 10 by revenue)
      if (!lojasResult.error && lojasResult.data) {
        const lojaRevenue = new Map();
        lojasResult.data.forEach(r => {
          const loja = r["Nome da loja"];
          const fat = parseBR(r.fat);
          lojaRevenue.set(loja, (lojaRevenue.get(loja) || 0) + fat);
        });
        
        const topLojas = Array.from(lojaRevenue.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([loja]) => loja);
        
        loja.innerHTML = '<option>Todos</option>' + topLojas.map(v => `<option>${v}</option>`).join('');
        console.log('‚úÖ Top lojas carregadas:', topLojas.length);
      }

      // Process Canais
      if (!canaisResult.error && canaisResult.data) {
        const canais = [...new Set(canaisResult.data.map(x => x["Canal de venda"]).filter(Boolean))];
        canal.innerHTML = '<option>Todos</option>' + canais.map(v => `<option>${v}</option>`).join('');
        console.log('‚úÖ Canais carregados:', canais.length);
      }

      // Process Pagamentos
      if (!pagamentosResult.error && pagamentosResult.data) {
        const pagamentos = [...new Set(pagamentosResult.data.map(x => x.pagamento).filter(Boolean))];
        pag.innerHTML = '<option>Todos</option>' + pagamentos.map(v => `<option>${v}</option>`).join('');
        console.log('‚úÖ Pagamentos carregados:', pagamentos.length);
      }

    } catch (error) {
      console.error('‚ùå Erro ao carregar filtros:', error);
    }
  }

  // Reload data with filters
  async function reload() {
    if (!minISO || !maxISO) {
      console.warn('‚ö†Ô∏è Sem dados dispon√≠veis');
      return;
    }

    try {
      console.log('üîÑ Recarregando dados...');
      showLoading(true);

      const a = dini.value || minISO;
      const b = dfim.value || maxISO;
      const uniSel = uni.value || 'Todas';
      const lojaSel = loja.value || 'Todos';
      const turnSel = turno.value || 'Todos';
      const canSel = canal.value || 'Todos';
      const pagSel = pag.value || 'Todos';
      const cancSel = canc.value || 'Todos';

      console.log('üìä Filtros aplicados:', {
        periodo: `${a} ‚Üí ${b}`,
        unidade: uniSel,
        loja: lojaSel,
        turno: turnSel,
        canal: canSel,
        pagamento: pagSel,
        cancelado: cancSel
      });

      // Build query
      let q = supa.from(TABLE).select('*').gte('dia', a).lte('dia', b);

      if (uniSel !== 'Todas') {
        q = q.eq('unidade', uniSel);
      }

      if (lojaSel !== 'Todos') {
        q = q.eq('Nome da loja', lojaSel);
      }

      if (turnSel !== 'Todos') {
        q = q.eq('turno', turnSel);
      }

      if (canSel !== 'Todos') {
        q = q.eq('Canal de venda', canSel);
      }

      if (pagSel !== 'Todos') {
        q = q.eq('pagamento', pagSel);
      }

      if (cancSel !== 'Todos') {
        q = q.eq('cancelado', cancSel);
      }

      // Load all data with pagination
      console.log('üîÑ Carregando todos os dados...');
      let allRows = [];
      let page = 0;
      const pageSize = 1000;
      let hasMore = true;

      while (hasMore) {
        const start = page * pageSize;
        const end = start + pageSize - 1;

        console.log(`üìÑ Carregando p√°gina ${page + 1} (registros ${start}-${end})...`);

        const r = await q.range(start, end);
        if (r.error) {
          console.error('‚ùå Erro na query:', r.error);
          throw r.error;
        }

        if (!r.data || r.data.length === 0) {
          hasMore = false;
          break;
        }

        allRows = allRows.concat(r.data);

        if (r.data.length < pageSize) {
          hasMore = false;
        } else {
          page++;
        }

        // Safety limit
        if (page > 100) {
          console.warn('‚ö†Ô∏è Limite de p√°ginas atingido (100 p√°ginas)');
          hasMore = false;
        }
      }

      console.log(`‚úÖ Total de registros carregados: ${allRows.length}`);

      // Process data
      const rows = allRows.map(x => ({
        dia: onlyDate(x.dia),
        pedidos: Number(x.pedidos) || 1,
        fat: parseBR(x.fat),
        fre: parseBR(x.fre),
        des: parseBR(x.des),
        unidade: x.unidade || '',
        loja: x["Nome da loja"] || '',
        turno: x.turno || '',
        canal: x["Canal de venda"] || '',
        pagamento: x.pagamento || '',
        cancelado: normCancel(x.cancelado)
      }));

      // Calculate KPIs
      const totalPedidos = rows.reduce((sum, r) => sum + r.pedidos, 0);
      const totalFat = rows.reduce((sum, r) => sum + r.fat, 0);
      const totalFre = rows.reduce((sum, r) => sum + r.fre, 0);
      const totalDes = rows.reduce((sum, r) => sum + r.des, 0);
      const totalFatLiq = totalFat - totalDes;
      const ticketMedio = totalPedidos > 0 ? totalFat / totalPedidos : 0;
      const desPercent = totalFat > 0 ? totalDes / totalFat : 0;

      // Group by day for chart
      const dailyData = new Map();
      rows.forEach(r => {
        const day = r.dia;
        if (!dailyData.has(day)) {
          dailyData.set(day, 0);
        }
        dailyData.set(day, dailyData.get(day) + r.fat);
      });

      const sortedDays = Array.from(dailyData.keys()).sort();
      const fatDiaMedio = sortedDays.length > 0 ? totalFat / sortedDays.length : 0;

      // Update KPIs
      kPedidos.textContent = totalPedidos.toLocaleString('pt-BR');
      kTicket.textContent = fmtBRL(ticketMedio);
      kFat.textContent = fmtBRL(totalFat);
      kFatDia.textContent = fmtBRL(fatDiaMedio);
      kDes.textContent = fmtBRL(totalDes);
      kDesPct.textContent = fmtPct(desPercent);
      kFre.textContent = fmtBRL(totalFre);
      kFatLiq.textContent = fmtBRL(totalFatLiq);

      // Update period display
      updateStatus('success', `Per√≠odo: ${a} ‚Üí ${b} ¬∑ ${allRows.length} registros`);

      // Update chart
      updateChart(sortedDays, sortedDays.map(day => dailyData.get(day)));

      console.log('‚úÖ Dados carregados com sucesso!');
      console.log('üìä KPIs calculados:', {
        pedidos: totalPedidos,
        faturamento: totalFat,
        ticketMedio: ticketMedio,
        incentivos: totalDes,
        frete: totalFre,
        faturamentoLiquido: totalFatLiq
      });

    } catch (error) {
      console.error('‚ùå Erro ao carregar dados:', error);
      showError('Erro ao carregar dados');
    } finally {
      showLoading(false);
    }
  }

  // Update chart
  function updateChart(labels, data) {
    const ctx = chartEl.getContext('2d');
    
    if (chart) {
      chart.destroy();
    }

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Receita (R$)',
          data: data,
          borderColor: '#ff6b35',
          backgroundColor: 'rgba(255, 107, 53, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#ff6b35',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              maxTicksLimit: 10
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: '#f1f5f9'
            },
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toLocaleString('pt-BR');
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
  }

  // Quick period selection
  function applyQuickPeriod() {
    if (!maxISO) return;

    const opt = pr.value;
    const end = new Date(maxISO);
    let start;

    if (opt === "√öltimos 60 dias") {
      start = new Date(end.getTime() - (59 * 24 * 60 * 60 * 1000));
    } else if (opt === "√öltimos 90 dias") {
      start = new Date(end.getTime() - (89 * 24 * 60 * 60 * 1000));
    } else if (opt === "Este m√™s") {
      start = new Date(end.getFullYear(), end.getMonth(), 1);
    } else if (opt === "√öltimo m√™s") {
      start = new Date(end.getFullYear(), end.getMonth() - 1, 1);
      end.setDate(0); // Last day of previous month
    } else if (opt === "Este ano") {
      start = new Date(end.getFullYear(), 0, 1);
    } else {
      // Default: √öltimos 30 dias
      start = new Date(end.getTime() - (29 * 24 * 60 * 60 * 1000));
    }

    dini.value = onlyDate(start.toISOString());
    dfim.value = onlyDate(end.toISOString());
    
    reload();
  }

  // Clear filters
  function clearFilters() {
    uni.value = 'Todas';
    loja.value = 'Todos';
    turno.value = 'Todos';
    canal.value = 'Todos';
    pag.value = 'Todos';
    canc.value = 'Todos';
    
    // Reset to default date range
    if (maxISO) {
      dfim.value = maxISO;
      const maxDate = new Date(maxISO);
      const thirtyDaysAgo = new Date(maxDate.getTime() - (29 * 24 * 60 * 60 * 1000));
      const minDate = minISO ? new Date(minISO) : thirtyDaysAgo;
      const startDate = thirtyDaysAgo > minDate ? thirtyDaysAgo : minDate;
      dini.value = onlyDate(startDate.toISOString());
    }
    
    reload();
  }

  // File handling
  function handleFileSelect() {
    const file = csv.files[0];
    if (file) {
      const fileName = file.name;
      const fileLabel = document.querySelector('.file-input-label');
      fileLabel.innerHTML = `
        <span style="font-size: 2rem;">‚úÖ</span>
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">${fileName}</div>
          <div style="font-size: 0.875rem; color: var(--text-muted);">Arquivo selecionado</div>
        </div>
      `;
    }
  }

  // Import CSV
  async function importCSV() {
    const file = csv.files[0];
    if (!file) {
      showImportStatus('error', '‚ùå Selecione um arquivo CSV primeiro');
      return;
    }

    try {
      showImportStatus('info', '‚è≥ Processando arquivo...');
      btnImport.disabled = true;
      btnImport.innerHTML = '<div class="loading"></div> Importando...';

      const text = await file.text();
      const cleanText = stripBOM(text);

      // Parse CSV
      const result = Papa.parse(cleanText, {
        header: true,
        skipEmptyLines: true,
        delimiter: '',
        newline: '',
        quoteChar: '"',
        escapeChar: '"',
        transformHeader: (header) => header.trim()
      });

      console.log('üìÑ Parse completo:', result.meta);
      console.log('üìä Linhas lidas:', result.data.length);

      if (result.errors.length > 0) {
        console.warn('‚ö†Ô∏è Erros no parse:', result.errors);
      }

      // Header mapping
      const headerMap = {
        'Data da venda': 'dia',
        'unidade': 'unidade',
        'Nome da loja': 'Nome da loja',
        'Turno': 'turno',
        'Canal de venda': 'Canal de venda',
        'Pagamento': 'pagamento',
        'Est√° cancelado': 'cancelado',
        'Total': 'fat',
        'Entrega': 'fre',
        'Desconto': 'des'
      };

      // Process rows
      const validRows = [];
      let processedCount = 0;

      for (const row of result.data) {
        processedCount++;

        // Map headers
        const mappedRow = {};
        for (const [csvHeader, dbField] of Object.entries(headerMap)) {
          if (row[csvHeader] !== undefined) {
            mappedRow[dbField] = row[csvHeader];
          }
        }

        // Validate required fields
        if (!mappedRow.dia || !mappedRow.unidade || !mappedRow.fat) {
          console.warn(`‚ö†Ô∏è Linha ${processedCount} ignorada - campos obrigat√≥rios ausentes:`, mappedRow);
          continue;
        }

        // Process data
        const processedRow = {
          dia: ddmmyyyyToISO(mappedRow.dia),
          unidade: String(mappedRow.unidade || '').trim(),
          'Nome da loja': String(mappedRow['Nome da loja'] || '').trim(),
          turno: String(mappedRow.turno || '').trim(),
          'Canal de venda': String(mappedRow['Canal de venda'] || '').trim(),
          pagamento: String(mappedRow.pagamento || '').trim(),
          cancelado: normCancel(mappedRow.cancelado),
          fat: parseBR(mappedRow.fat),
          fre: parseBR(mappedRow.fre),
          des: parseBR(mappedRow.des),
          pedidos: 1 // Default
        };

        if (!processedRow.dia) {
          console.warn(`‚ö†Ô∏è Linha ${processedCount} ignorada - data inv√°lida:`, mappedRow.dia);
          continue;
        }

        validRows.push(processedRow);
      }

      console.log(`‚úÖ Processadas ${validRows.length} linhas v√°lidas de ${processedCount} total`);

      if (validRows.length === 0) {
        showImportStatus('error', '‚ùå Nenhuma linha v√°lida encontrada no arquivo');
        return;
      }

      // Insert data
      const { data, error } = await supa.from(TABLE).upsert(validRows, {
        onConflict: 'dia,unidade,Nome da loja,pagamento,Canal de venda'
      });

      if (error) {
        console.error('‚ùå Erro ao inserir dados:', error);
        showImportStatus('error', `‚ùå Erro ao importar: ${error.message}`);
        return;
      }

      console.log('‚úÖ Importa√ß√£o conclu√≠da, atualizando dashboard...');
      showImportStatus('success', `‚úÖ ${validRows.length} registros importados com sucesso!`);

      // Refresh dashboard
      await fetchMinMax();
      await buildOptions();
      await reload();

    } catch (error) {
      console.error('‚ùå Erro na importa√ß√£o:', error);
      showImportStatus('error', `‚ùå Erro na importa√ß√£o: ${error.message}`);
    } finally {
      btnImport.disabled = false;
      btnImport.innerHTML = 'üì§ Importar CSV (Incremental)';
    }
  }

  // Debug function
  function debugInfo() {
    console.log('=== üîç DEBUG INFO ===');
    console.log('üìä TABLE:', TABLE);
    console.log('üìÖ minISO:', minISO);
    console.log('üìÖ maxISO:', maxISO);
    console.log('üéõÔ∏è Filtros atuais:', {
      unidade: uni.value,
      loja: loja.value,
      periodo: `${dini.value} ‚Üí ${dfim.value}`,
      turno: turno.value,
      canal: canal.value,
      pagamento: pag.value,
      cancelado: canc.value
    });
    console.log('üîó Supabase client:', supa);
    console.log('==================');
  }

  // Utility functions for UI
  function showLoading(show) {
    if (loadingIndicator) {
      loadingIndicator.style.display = show ? 'inline-block' : 'none';
    }
  }

  function updateStatus(type, message) {
    if (periodoEl) {
      periodoEl.innerHTML = `<span>${message}</span>`;
      periodoEl.className = `status-badge ${type}`;
    }
  }

  function showError(message) {
    updateStatus('error', `‚ùå ${message}`);
  }

  function showImportStatus(type, message) {
    if (importStatus) {
      importStatus.textContent = message;
      importStatus.className = `import-status ${type}`;
      importStatus.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          importStatus.style.display = 'none';
        }, 5000);
      }
    }
  }
  </script>
</body>
</html>

