<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--ink:#0f172a;--mut:#667085;--blue:#1a73e8;--bd:#e6eaf2;--r:14px}
  body{background:var(--bg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink)}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 4px 0}
  small{color:var(--mut)}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:14px}
  .row{display:grid;gap:10px}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  label{font-size:12px;color:var(--mut);display:block;margin-bottom:4px}
  input,select,button{border:1px solid var(--bd);border-radius:10px;padding:10px;background:#fff;width:100%}
  select[multiple]{height:120px}
  button{background:var(--blue);color:#fff;border:none;cursor:pointer}
  .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  .kpi h3{font-size:12px;color:var(--mut);margin:0 0 6px}
  .kpi b{font-size:20px}
  .right{text-align:right}
  .mut{color:var(--mut)}
  canvas{height:220px}
  @media (max-width:960px){.cols-4,.cols-3,.kpis{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food</h1>
  <small id="status">—</small>

  <div class="card" style="margin-top:10px">
    <div class="row cols-4">
      <div>
        <label>Unidade</label>
        <select id="fUnidade"></select>
      </div>
      <div>
        <label>Nome da loja (Top 10)</label>
        <select id="fLoja"></select>
      </div>
      <div>
        <label>De</label>
        <input id="fDini" type="date"/>
      </div>
      <div>
        <label>Até</label>
        <input id="fDfim" type="date"/>
      </div>
    </div>

    <div class="row cols-4" style="margin-top:8px">
      <div>
        <label>Período rápido</label>
        <select id="fQuick">
          <option>Últimos 30</option>
          <option>Últimos 60</option>
          <option selected>Últimos 90</option>
          <option>Este mês</option>
          <option>Último mês</option>
          <option>Este ano</option>
        </select>
      </div>
      <div>
        <label>Turno</label>
        <select id="fTurno" multiple>
          <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
        </select>
      </div>
      <div>
        <label>Canal de venda</label>
        <select id="fCanal" multiple></select>
      </div>
      <div>
        <label>Pagamento</label>
        <select id="fPag" multiple></select>
      </div>
    </div>

    <div class="row cols-3" style="margin-top:8px">
      <div>
        <label>Está cancelado?</label>
        <select id="fCanc">
          <option>Todos</option><option>Não</option><option>Sim</option>
        </select>
      </div>
      <div></div>
      <div class="right">
        <label>&nbsp;</label>
        <button id="btnLimpar" type="button">Limpar</button>
      </div>
    </div>
    <div class="mut" id="msg" style="margin-top:6px"></div>
  </div>

  <div class="kpis" style="margin-top:10px">
    <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
    <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
    <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
    <div class="card kpi"><h3>Faturamento Médio (dia)</h3><b id="kFatDia">—</b></div>
    <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
    <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
    <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
    <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="row cols-3" style="grid-template-columns:auto 120px">
      <b>Receita diária (R$)</b>
      <span class="right mut" id="resumo"></span>
    </div>
    <canvas id="chart" style="margin-top:8px"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(async function(){
  // ===== Config =====
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ===== DOM =====
  const $ = id=>document.getElementById(id);
  const statusEl=$("status"), msg=$("msg"), resumo=$("resumo");
  const dini=$("fDini"), dfim=$("fDfim"), pr=$("fQuick");
  const uni=$("fUnidade"), loja=$("fLoja"), turno=$("fTurno"), canal=$("fCanal"), pag=$("fPag"), canc=$("fCanc");
  const btnLimpar=$("btnLimpar");
  const kPedidos=$("kPedidos"), kTicket=$("kTicket"), kFat=$("kFat"), kFatDia=$("kFatDia"),
        kDes=$("kDes"), kDesPct=$("kDesPct"), kFre=$("kFre"), kFatLiq=$("kFatLiq");
  let chart;

  // ===== Utils =====
  const fmtBRL=v=> (isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—");
  const fmtPct=v=> (isFinite(v)? (v*100).toFixed(1).replace('.',',')+'%' : "—");
  const onlyDate=iso=> iso && iso.length>=10 ? iso.slice(0,10) : null;
  const norm = s => String(s??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const normCancel = v => (v===true || ['sim','s','1','true','y'].includes(norm(v))) ? 'Sim' : (v===false ? 'Não' : (['nao','não','n','0','false','','n\u00e3o'].includes(norm(v))?'Não':'Não'));

  function applyQuickDate(){
    const end=new Date(); let start;
    if(pr.value.startsWith("Últimos ")){
      const n=parseInt(pr.value.split(' ')[1],10);
      start=new Date(); start.setDate(end.getDate()-(n-1));
    }else if(pr.value==="Este mês"){
      start=new Date(end.getFullYear(),end.getMonth(),1);
    }else if(pr.value==="Último mês"){
      start=new Date(end.getFullYear(),end.getMonth()-1,1);
      const e=new Date(end.getFullYear(),end.getMonth(),0);
      dini.value=eis(start); dfim.value=eis(e); return;
    }else if(pr.value==="Este ano"){
      start=new Date(end.getFullYear(),0,1);
    }else{
      start=new Date(end.getFullYear(),end.getMonth(),end.getDate()-29);
    }
    dini.value=eis(start); dfim.value=eis(end);
  }
  const eis=d=> new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const getSel=m=> m.multiple? Array.from(m.selectedOptions).map(o=>o.value) : m.value;

  // ===== Carrega intervalo e total (exato) =====
  async function minmax(){
    const a=await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const b=await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    const c=await supa.from(TABLE).select('*',{count:'exact', head:true});
    const min=onlyDate(a.data?.[0]?.dia)||'—', max=onlyDate(b.data?.[0]?.dia)||'—', tot=c.count??'—';
    statusEl.textContent=`Período: ${min} → ${max} (${tot} linhas)`;
    if(!dini.value || !dfim.value){ applyQuickDate(); }
    return {min,max,tot};
  }

  // ===== Busca paginada (sem limite de 1000) =====
  async function fetchAll(a,b){
    const page=1000; let off=0, all=[]; msg.textContent='Carregando…';
    while(true){
      let q=supa.from(TABLE)
        .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
        .order('dia',{ascending:true})
        .gte('dia', a).lte('dia', b)
        .range(off, off+page-1);
      const {data, error} = await q;
      if(error){ msg.textContent='Erro ao carregar.'; console.error(error); break; }
      all = all.concat(data||[]);
      if(!data || data.length < page) break;
      off += page;
      msg.textContent = `Carregando… ${all.length.toLocaleString('pt-BR')} linhas`;
    }
    msg.textContent = `Concluído. ${all.length.toLocaleString('pt-BR')} linhas carregadas.`;
    return all.map(r=>({...r, dia:onlyDate(r.dia), cancelado:normCancel(r.cancelado)}));
  }

  // ===== Monta opções dos filtros a partir dos dados =====
  function buildOptions(rows){
    const setUni=new Set(['Todas']);
    const setCan=new Set(), setPag=new Set();
    const fatPorLoja=new Map();
    rows.forEach(r=>{
      if(r.unidade) setUni.add(r.unidade);
      if(r['Canal de venda']) setCan.add(r['Canal de venda']);
      if(r.pagamento) setPag.add(r.pagamento);
      if(r['Nome da loja']){
        fatPorLoja.set(r['Nome da loja'], (fatPorLoja.get(r['Nome da loja'])||0)+(Number(r.fat)||0));
      }
    });
    uni.innerHTML=[...setUni].sort().map(v=>`<option>${v}</option>`).join('');
    canal.innerHTML=[...setCan].sort().map(v=>`<option>${v}</option>`).join('');
    pag.innerHTML=[...setPag].sort().map(v=>`<option>${v}</option>`).join('');
    const top=[...fatPorLoja.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
    loja.innerHTML= ['Todos',...top].map(v=>`<option>${v}</option>`).join('');
  }

  // ===== KPIs & Gráfico =====
  function computeKPIs(rows){
    const pedidos=rows.reduce((s,r)=>s+(Number(r.pedidos)||0),0);
    const fat=rows.reduce((s,r)=>s+(Number(r.fat)||0),0);
    const des=rows.reduce((s,r)=>s+(Number(r.des)||0),0);
    const fre=rows.reduce((s,r)=>s+(Number(r.fre)||0),0);
    const fatliq=fat-des-fre;
    const dias=new Set(rows.map(r=>r.dia)).size||1;
    const ticket=pedidos? fat/pedidos : 0;
    const fatDia=fat/dias;
    const desPct=fat? des/fat : 0;

    kPedidos.textContent=pedidos.toLocaleString('pt-BR');
    kTicket.textContent=fmtBRL(ticket);
    kFat.textContent=fmtBRL(fat);
    kFatDia.textContent=fmtBRL(fatDia);
    kDes.textContent=fmtBRL(des);
    kDesPct.textContent=fmtPct(desPct);
    kFre.textContent=fmtBRL(fre);
    kFatLiq.textContent=fmtBRL(fatliq);
  }

  function drawChart(rows){
    const by=new Map();
    rows.forEach(r=> by.set(r.dia,(by.get(r.dia)||0)+(Number(r.fat)||0)));
    const labels=[...by.keys()].sort();
    const values=labels.map(d=>by.get(d));
    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Receita',data:values,tension:0.2}]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{y:{beginAtZero:true}}}});
    resumo.textContent = `${labels.length} dias`;
  }

  // ===== Fluxo =====
  let cacheAll=[]; // dados carregados no intervalo atual
  async function reload(){
    const a=dini.value, b=dfim.value;
    cacheAll = await fetchAll(a,b);
    buildOptions(cacheAll);
    applyFiltersAndRender();
  }

  function applyFiltersAndRender(){
    const uniSel=uni.value||'Todas';
    const lojaSel=loja.value||'Todos';
    const tSel=getSel(turno), cSel=getSel(canal), pSel=getSel(pag), cancSel=canc.value||'Todos';

    const rows = cacheAll.filter(r=>{
      if(uniSel!=='Todas' && norm(r.unidade)!==norm(uniSel)) return false;
      if(lojaSel!=='Todos' && norm(r["Nome da loja"])!==norm(lojaSel)) return false;
      if(tSel?.length && !tSel.includes(r.turno)) return false;
      if(cSel?.length && !cSel.includes(r["Canal de venda"])) return false;
      if(pSel?.length && !pSel.includes(r.pagamento)) return false;
      if(cancSel!=='Todos' && normCancel(r.cancelado)!==cancSel) return false;
      return true;
    });

    computeKPIs(rows);
    drawChart(rows);
  }

  // Eventos
  pr.addEventListener('change', ()=>{ applyQuickDate(); reload(); });
  [dini,dfim].forEach(e=> e.addEventListener('change', ()=> reload()));
  [uni,loja,turno,canal,pag,canc].forEach(e=> e.addEventListener('change', ()=> applyFiltersAndRender()));
  btnLimpar.addEventListener('click', ()=>{ uni.value='Todas'; loja.value='Todos'; turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value='Todos'; applyFiltersAndRender(); });

  await minmax();
  applyQuickDate();
  await reload();
})();
</script>
</body>
</html>
