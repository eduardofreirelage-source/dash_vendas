<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pratos & Mapa de Produção</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">FT</text></svg>'/>
<style>
:root{
  --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb;
  --wine:#7b1e3a; --ok:#059669; --err:#dc2626;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1280px;margin:28px auto;padding:0 18px}
h1{margin:0 0 8px;font-size:28px}
h3{margin:0 0 12px}
.status{font-size:13px;margin-left:8px}
.status.ok{color:var(--ok)} .status.err{color:var(--err)}
/* Tabs */
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
.tab{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.tab.active{background:#f1f5f9;font-weight:700}
.subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
.subtab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.subtab.active{background:#eef2f7;font-weight:700}
/* Cards / forms */
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:16px;}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
textarea{min-height:80px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.pri{background:var(--wine);color:#fff;border-color:var(--wine)}
.btn.ghost{background:#f8fafc}
.pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
.sep{height:1px;background:var(--line);margin:12px 0}
.hint{color:#64748b;font-size:12px}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi>span{padding:4px 8px;background:#f8fafc;border:1px solid var(--line);border-radius:8px;font-size:12px}
/* Tables */
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:middle}
th{background:#f8fafc}
.compact th,.compact td{padding:6px 8px}
.row-actions{display:flex;gap:6px;flex-wrap:wrap}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.pager .btn{padding:6px 10px}
details.summary{border:1px dashed var(--line);border-radius:12px;padding:12px;background:#fcfcfd}
details>summary{cursor:pointer;font-weight:600;list-style:none}
details>summary::-webkit-details-marker{display:none}
@media (max-width:980px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
@media print{.no-print{display:none !important} body{background:#fff} .section{box-shadow:none;border:none}}
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
    <h1>Pratos & Mapa de Produção</h1>
    <div id="status" class="status">Carregando…</div>
  </div>

  <!-- TABS PRINCIPAIS -->
  <div class="tabs">
    <button class="tab active" data-tab="tab-principal-pratos">Pratos</button>
    <button class="tab" data-tab="tab-principal-mapa">Mapa de Produção</button>
  </div>

  <!-- ========== ABA PRINCIPAL: PRATOS (com SUB-ABAS) ========== -->
  <div id="tab-principal-pratos" class="section">
    <div class="subtabs">
      <button class="subtab active" data-subtab="sub-pratos">Pratos</button>
      <button class="subtab" data-subtab="sub-comp">Componentes do Prato</button>
      <button class="subtab" data-subtab="sub-receitas">Receitas</button>
      <button class="subtab" data-subtab="sub-ingred">Ingredientes</button>
    </div>

    <!-- 1.1 PRATOS -->
    <div id="sub-pratos">
      <h3>Pratos</h3>
      <div class="grid">
        <div class="grid cols-2 no-print">
          <div><input id="prato-search" placeholder="Buscar prato cadastrado"></div>
          <div style="text-align:right"><button class="btn" id="btnNewPrato">+ Novo prato</button></div>
        </div>
        <div style="overflow:auto">
          <table id="tblPratos" class="compact">
            <thead><tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th class="no-print">Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pager no-print">
          <span class="pill" id="pageInfo">Página 1/1</span>
          <button class="btn" id="prevPage">◀</button>
          <button class="btn" id="nextPage">▶</button>
        </div>

        <div class="sep"></div>

        <!-- Editor abaixo da lista -->
        <div class="kpi" id="prato-kpi">
          <span id="kpi-custo">Custo: —</span>
          <span id="kpi-peso">Peso: —</span>
          <span id="kpi-atual">Última alteração: —</span>
        </div>
        <div class="grid cols-3">
          <div><label>Nome</label><input id="pr-nome" placeholder="Ex.: Strogonoff de frango"></div>
          <div><label>Categoria</label>
            <select id="pr-categ">
              <option value="PRATOS">PRATOS</option><option value="BEBIDAS">BEBIDAS</option>
              <option value="SOBREMESA">SOBREMESA</option><option value="ACOMPANHAMENTOS">ACOMPANHAMENTOS</option>
              <option value="OUTROS">OUTROS</option>
            </select>
          </div>
          <div><label>Peso do prato</label><input id="pr-peso" inputmode="decimal" placeholder="Ex.: 500 (g/ml)"></div>
        </div>
        <div class="grid cols-3">
          <div><label>Preço de venda (fator ou preço)</label><input id="pr-preco" inputmode="decimal" placeholder="Ex.: 3,2 (fator) ou 34,90 (R$)"></div>
          <div><label>Custo do prato (calculado)</label><input id="pr-custo" disabled></div>
          <div><label>Última alteração</label><input id="pr-upd" disabled></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn pri" id="btnSavePrato">Salvar</button>
          <button class="btn ghost" id="btnCancelPrato" style="display:none">Cancelar</button>
        </div>
        <div class="hint" id="prato-edit-hint"></div>

        <!-- Import painel no final -->
        <details class="summary" id="imp-pane">
          <summary>Pratos do Dashboard (clique para expandir/ocultar)</summary>
          <div class="grid cols-3" style="margin-top:10px">
            <div>
              <label>Filtrar por categoria</label>
              <select id="imp-categ">
                <option value="">Sem categoria</option>
                <option>PRATOS</option><option>BEBIDAS</option><option>SOBREMESA</option>
                <option>ACOMPANHAMENTOS</option><option>PROMOÇÕES</option><option>OUTROS</option>
              </select>
            </div>
            <div><label>Buscar no dashboard</label><input id="imp-search" placeholder="Ex.: Strogonoff"></div>
            <div style="align-self:end"><button class="btn" id="btnImpSyncAll">Sincronizar todos que faltam</button></div>
          </div>
          <div class="hint">Fonte: <code>vendas_pratos_pratos</code> (colunas: <code>prato</code> e opcional <code>categoria</code>)</div>
          <div style="overflow:auto;margin-top:8px">
            <table id="tblImp" class="compact">
              <thead><tr><th>Prato</th><th>Categoria</th><th>Situação</th><th class="no-print">Ação</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>

    <!-- 1.2 COMPONENTES -->
    <div id="sub-comp" style="display:none">
      <h3>Componentes do Prato</h3>
      <div class="grid cols-3">
        <div><label>Selecione o prato</label><select id="pc-prato"></select></div>
        <div style="align-self:end"><span class="pill">Após selecionar, edite abaixo</span></div>
      </div>
      <div class="sep"></div>
      <div class="pill" id="pc-title">Componentes — (nenhum prato selecionado)</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tblPc" class="compact">
          <thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Observações</th><th class="no-print">Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <details class="summary" id="pc-add-pane" style="margin-top:12px" open>
        <summary>Adicionar nova receita ao prato</summary>
        <div class="grid cols-4" style="margin-top:12px">
          <div><label>Receita</label><select id="pc-rec"></select></div>
          <div><label>Qtd por prato</label><input id="pc-qtd" inputmode="decimal" placeholder="Ex.: 220"></div>
          <div><label>Unidade</label>
            <select id="pc-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
          </div>
          <div><label>Observações</label><input id="pc-obs" placeholder="Opcional"></div>
        </div>
        <div style="margin-top:10px"><button class="btn pri" id="btnPcAdd">Adicionar Receita ao Prato</button></div>
      </details>
    </div>

    <!-- 1.3 RECEITAS -->
    <div id="sub-receitas" style="display:none">
      <h3>Receitas</h3>
      <div class="grid cols-3">
        <div><label>Selecionar receita para editar</label><select id="ri-receita"></select></div>
        <div style="align-self:end"><button class="btn" id="btnRecNew">+ Nova receita</button></div>
      </div>
      <div class="sep"></div>
      <div class="grid cols-4">
        <div><label>Nome</label><input id="rec-nome" placeholder="Ex.: Arroz Branco pronto"></div>
        <div><label>Rendimento (qtd)</label><input id="rec-rend-qtd" inputmode="decimal" placeholder="Ex.: 1000"></div>
        <div><label>Unidade do rendimento</label>
          <select id="rec-rend-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="porcao">porção</option></select>
        </div>
        <div><label>Perda global (%)</label><input id="rec-perda" inputmode="decimal" value="0"></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label>Observações</label><input id="rec-obs" placeholder="Opcional"></div>
        <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn pri" id="btnRecSave">Salvar alterações</button>
          <button class="btn ghost" id="btnRecCancel" style="display:none">Cancelar</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="pill">Componentes da receita selecionada</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tblRi" class="compact">
          <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th class="no-print">Ações</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <details class="summary" style="margin-top:12px">
        <summary>Adicionar novo componente</summary>
        <div class="grid cols-4" style="margin-top:10px">
          <div><label>Tipo</label>
            <select id="draft-tipo"><option value="INGREDIENTE">Ingrediente</option><option value="RECEITA">Sub-receita</option></select>
          </div>
          <div><label>Referência</label><select id="draft-ref"></select></div>
          <div><label>Qtd</label><input id="draft-qtd" inputmode="decimal" placeholder="Ex.: 300"></div>
          <div><label>Unidade</label>
            <select id="draft-und"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="L">L</option><option value="un">un</option><option value="porcao">porção</option></select>
          </div>
        </div>
        <div class="grid cols-2" style="margin-top:10px">
          <div><label>Perda da linha (%)</label><input id="draft-perda" inputmode="decimal" value="0"></div>
          <div style="align-self:end"><button class="btn" id="btnDraftAdd">Adicionar</button></div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="tblDraft" class="compact">
            <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th class="no-print">Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnDraftClear">Limpar</button>
          <button class="btn pri" id="btnDraftSave">Salvar itens</button>
        </div>
      </details>
    </div>

    <!-- 1.4 INGREDIENTES (resumo só para referência visual; CRUD pode ser adicionado depois) -->
    <div id="sub-ingred" style="display:none">
      <h3>Ingredientes (resumo)</h3>
      <div class="hint">Cadastro detalhado pode ser feito na sua tela de estoque; aqui usamos custos e unidade para compras.</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tblIngResumo" class="compact">
          <thead><tr><th>Nome</th><th>Unidade</th><th>Custo unitário</th><th>Ativo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ========== ABA PRINCIPAL: MAPA DE PRODUÇÃO (sub-abas) ========== -->
  <div id="tab-principal-mapa" class="section" style="display:none">
    <div class="subtabs">
      <button class="subtab active" data-subtab="sub-prev">Previsão</button>
      <button class="subtab" data-subtab="sub-compras">Compras</button>
    </div>

    <!-- 2.1 PREVISÃO -->
    <div id="sub-prev">
      <h3>Previsão de Produção</h3>
      <div class="grid cols-4">
        <div class="no-print">
          <label>Período rápido</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn" data-q="7">07</button><button class="btn" data-q="15">15</button>
            <button class="btn" data-q="30">30</button><button class="btn" data-q="60">60</button>
            <button class="btn" data-q="90">90</button><button class="btn" data-q="120">120</button>
          </div>
        </div>
        <div><label>Início</label><input id="pv-inicio" type="date"></div>
        <div><label>Fim</label><input id="pv-fim" type="date"></div>
        <div><label>Horizonte</label>
          <select id="pv-horizonte"><option value="1">1 dia</option><option value="3">3 dias</option><option value="5">5 dias</option><option value="7" selected>7 dias</option></select>
        </div>
      </div>
      <div class="grid cols-3 no-print" style="margin-top:10px">
        <div><button class="btn pri" id="btnGerarPrev">Gerar</button></div>
        <div><button class="btn" id="btnPrevToProd">Enviar para Produção</button></div>
        <div><button class="btn" id="btnPrevPDF">Exportar PDF</button></div>
      </div>
      <div class="hint">Fonte vendas: <code id="sales-source-label"></code> • As datas abaixo exibem o <b>dia da semana</b>.</div>

      <div id="prev-results" style="margin-top:10px;display:none">
        <div class="pill">Média diária por prato</div>
        <div style="overflow:auto;margin-top:6px">
          <table id="tblPrevPratosDia" class="compact">
            <thead><tr><th>Prato</th><th>Média/dia</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sep"></div>
        <div class="pill">Projeção total por prato</div>
        <div style="overflow:auto;margin-top:6px">
          <table id="tblPrevPratosTot" class="compact">
            <thead><tr><th>Prato</th><th>Total previsto</th><th>Horizonte</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sep"></div>
        <div class="pill">Produção diária — AGRUPADA por Receita</div>
        <div style="overflow:auto;margin-top:6px">
          <table id="tblPrevReceitasDia" class="compact">
            <thead><tr><th>Receita</th><th>Qtd/dia</th><th>Un</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sep"></div>
        <div class="pill">Produção TOTAL (horizonte) — AGRUPADA por Receita</div>
        <div style="overflow:auto;margin-top:6px">
          <table id="tblPrevReceitasTot" class="compact">
            <thead><tr><th>Receita</th><th>Qtd total</th><th>Un</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="sep"></div>
        <div class="pill">Calendário do Horizonte (com dia da semana)</div>
        <div style="overflow:auto;margin-top:6px">
          <table id="tblCalendario" class="compact">
            <thead><tr><th>Data</th><th>Dia da semana</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 2.2 COMPRAS -->
    <div id="sub-compras" style="display:none">
      <h3>Compras (a partir do plano da Produção)</h3>
      <div class="grid cols-3 no-print">
        <div><button class="btn" id="btnGerarCompras">Gerar</button></div>
        <div><button class="btn pri" id="btnComprasPDF">Exportar Lista de Compras (PDF)</button></div>
      </div>
      <div class="hint">Expande receitas → ingredientes (considera sub-receitas), normaliza g↔kg e ml↔L, soma e estima custo.</div>
      <div class="sep"></div>
      <div style="overflow:auto">
        <table id="tblCompras" class="compact">
          <thead><tr><th>Ingrediente</th><th>Quantidade</th><th>Un</th><th>Custo unit.</th><th>Custo total</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th colspan="4" style="text-align:right">Total estimado</th><th id="compras-total">R$ 0,00</th></tr></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ========= Supabase / fontes ========= */
  const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const DASHBOARD_PRATOS_SOURCE = 'vendas_pratos_pratos'; // prato, categoria
  const SALES_VIEW = 'vendas_pratos_view_only_pratos';   // data, prato, quantidade
  $('sales-source-label').textContent = SALES_VIEW;

  /* ========= Helpers ========= */
  const $ = (id)=> document.getElementById(id);
  const setStatus=(msg,cls)=>{ const el=$('status'); if(!el) return; el.textContent=msg; el.className='status'+(cls?(' '+cls):''); };
  const fmtBR = (n, max=3)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:max}).format(+n || 0);
  const moneyBR = (n)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(+n||0);
  const ptToNumber = (v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
  const addDays=(d,add)=>{ const x=new Date(d); x.setDate(x.getDate()+add); return x; };
  const toISODate=(d)=> new Date(d).toISOString().slice(0,10);
  const wd = (d)=> new Intl.DateTimeFormat('pt-BR',{weekday:'long'}).format(new Date(d));

  function printHTML(html){
    const w = window.open('', '_blank');
    w.document.write(`<html><head><title>Export</title><style>
      body{font-family:Arial,Helvetica,sans-serif;font-size:12px}
      h2{margin:0 0 6px}
      table{width:100%;border-collapse:collapse;margin:8px 0}
      th,td{border:1px solid #ddd;padding:6px 8px;text-align:left}
      th{background:#f3f4f6}
      .meta{font-size:12px;color:#444;margin-bottom:8px}
    </style></head><body>${html}</body></html>`);
    w.document.close(); w.focus(); w.print();
  }

  /* ========= Tabs principais & sub-abas ========= */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('.section').forEach(sec=>sec.style.display='none');
      $(id).style.display='block';
    });
  });
  // sub-abas (delegação por container)
  function wireSubtabs(containerId){
    const el = document.querySelector('#'+containerId);
    el.querySelectorAll('.subtab').forEach(b=>{
      b.addEventListener('click', ()=>{
        el.querySelectorAll('.subtab').forEach(s=>s.classList.remove('active'));
        b.classList.add('active');
        const target = b.dataset.subtab;
        // esconder todos os filhos diretos que são sub-seções
        Array.from(el.children).forEach(child=>{
          if(child.id && child.id.startsWith('sub-')) child.style.display='none';
        });
        $(target).style.display='block';
      });
    });
  }
  wireSubtabs('tab-principal-pratos');
  wireSubtabs('tab-principal-mapa');

  /* ================= PRATOS: lista + paginação ================= */
  let pratoData = []; let page = 1, pageSize = 10;

  function renderPratos(){
    const tb = $('tblPratos').querySelector('tbody');
    const filtro = ($('prato-search').value||'').toLowerCase();
    const filtered = pratoData.filter(p=>p.nome.toLowerCase().includes(filtro));
    const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
    if(page > totalPages) page = totalPages;
    tb.innerHTML='';
    filtered.slice((page-1)*pageSize, (page)*pageSize).forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.categoria||'—'}</td>
        <td>${p.receitas ?? 0}</td>
        <td>${p.ativo?'<span class="pill">Ativo</span>':'<span class="pill">Inativo</span>'}</td>
        <td class="row-actions no-print">
          <button class="btn" data-act="edit" data-id="${p.id}">Editar</button>
          <button class="btn" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
          <button class="btn" data-act="del" data-id="${p.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
    $('pageInfo').textContent = `Página ${page}/${totalPages}`;
    $('prevPage').disabled = page<=1; $('nextPage').disabled = page>=totalPages;
  }
  $('prevPage').addEventListener('click', ()=>{ if(page>1){ page--; renderPratos(); }});
  $('nextPage').addEventListener('click', ()=>{ page++; renderPratos(); });
  $('prato-search').addEventListener('input', ()=>{ page=1; renderPratos(); });

  async function loadPratosList(){
    const { data, error } = await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true});
    if(error){ setStatus('Crie a view v_pratos_resumo','err'); return; }
    pratoData = data || [];
    renderPratos();
    await fillOptionsFromQuery('pc-prato','pratos','id','nome',{ativo:true});
  }

  /* ===== Editor de prato ===== */
  let pratoEditId = null;
  function enterPratoEdit(row){
    pratoEditId = row?.id || null;
    $('pr-nome').value = row?.nome || '';
    $('pr-categ').value = row?.categoria || 'PRATOS';
    $('pr-peso').value  = row?.peso_prato ?? '';
    $('pr-preco').value = row?.preco_venda ?? '';
    $('pr-custo').value = row?.custo_total!=null ? 'R$ '+fmtBR(row.custo_total,3) : '';
    $('pr-upd').value   = row?.updated_at ? new Date(row.updated_at).toLocaleString('pt-BR') : '';
    $('prato-edit-hint').textContent = row ? 'Editando prato #'+row.id : 'Criando novo prato';
    $('btnCancelPrato').style.display = row ? 'inline-flex' : 'none';
    $('kpi-custo').textContent = 'Custo: '+($('pr-custo').value || '—');
    $('kpi-peso').textContent  = 'Peso: '+(($('pr-peso').value)||'—');
    $('kpi-atual').textContent = 'Última alteração: '+(($('pr-upd').value)||'—');
  }
  $('btnNewPrato').addEventListener('click', ()=>enterPratoEdit(null));
  $('btnCancelPrato').addEventListener('click', ()=>enterPratoEdit(null));

  $('tblPratos').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id, act = btn.dataset.act;
    if(act==='edit'){
      const { data, error } = await supa.from('pratos').select('*').eq('id', id).single();
      if(error){ alert(error.message||error); return; }
      enterPratoEdit(data);
    }else if(act==='toggle'){
      const { data } = await supa.from('pratos').select('ativo').eq('id', id).single();
      const { error } = await supa.from('pratos').update({ ativo: !data.ativo, updated_at: new Date().toISOString() }).eq('id', id);
      if(error){ alert(error.message||error); return; }
      await loadPratosList();
    }else if(act==='del'){
      if(!confirm('Excluir prato?')) return;
      const { error } = await supa.from('pratos').delete().eq('id', id);
      if(error){ alert(error.message||error); return; }
      await loadPratosList();
      enterPratoEdit(null);
    }
  });

  $('btnSavePrato').addEventListener('click', async ()=>{
    const payload = {
      nome: $('pr-nome').value.trim(),
      categoria: $('pr-categ').value,
      peso_prato: ptToNumber($('pr-peso').value),
      preco_venda: ptToNumber($('pr-preco').value),
      updated_at: new Date().toISOString()
    };
    if(!payload.nome){ alert('Informe o nome do prato'); return; }
    let error;
    if(pratoEditId){ ({ error } = await supa.from('pratos').update(payload).eq('id', pratoEditId)); }
    else{ ({ error } = await supa.from('pratos').insert(payload)); }
    if(error){ alert(error.message||error); return; }
    setStatus('Prato salvo','ok');
    await loadPratosList();
  });

  /* ================= IMPORTAÇÃO do dashboard ================= */
  async function loadDashPratos(){
    const tb = $('tblImp').querySelector('tbody');
    tb.innerHTML = '<tr><td colspan="4">Carregando…</td></tr>';
    const { data:dash, error } = await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato,categoria').limit(5000);
    if(error){ tb.innerHTML = '<tr><td colspan="4">Não foi possível ler '+DASHBOARD_PRATOS_SOURCE+'</td></tr>'; return; }
    const nomes = Array.from(new Set((dash||[]).map(r=>r.prato).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    const byCat = new Map(); (dash||[]).forEach(r=>{ const c=(r.categoria||'').toUpperCase()||''; if(!byCat.has(r.prato)) byCat.set(r.prato,c); });
    const { data:pr } = await supa.from('pratos').select('nome');
    const exist = new Set((pr||[]).map(p=>p.nome));
    const filtCat = ($('imp-categ').value||'').toUpperCase();
    const filtro = ($('imp-search').value||'').toLowerCase();
    tb.innerHTML='';
    nomes
      .filter(n=>n.toLowerCase().includes(filtro))
      .filter(n=>!filtCat || (byCat.get(n)||'')===filtCat)
      .forEach(n=>{
        const exists = exist.has(n);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${n}</td>
          <td><span class="pill">${byCat.get(n)||'N/D'}</span></td>
          <td>${exists?'<span class="pill">Já existe</span>':'<span class="pill">Falta importar</span>'}</td>
          <td>${exists?'-':`<button class="btn" data-act="imp-one" data-nome="${n.replace(/"/g,'&quot;')}" data-c="${byCat.get(n)||''}">Importar</button>`}</td>`;
        tb.appendChild(tr);
      });
  }
  $('imp-pane').addEventListener('toggle', (e)=>{ if(e.target.open){ loadDashPratos(); }});
  $('imp-categ').addEventListener('change', loadDashPratos);
  $('imp-search').addEventListener('input', loadDashPratos);
  $('tblImp').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(btn.dataset.act==='imp-one'){
      const nome = btn.dataset.nome;
      const categoria = btn.dataset.c || 'PRATOS';
      const { error } = await supa.from('pratos').insert({ nome, categoria });
      if(error && !String(error.message||'').includes('duplicate')){ alert(error.message||error); return; }
      await loadPratosList(); await loadDashPratos();
    }
  });
  $('btnImpSyncAll').addEventListener('click', async ()=>{
    const rows = Array.from($('tblImp').querySelectorAll('button[data-act="imp-one"]'));
    for(const b of rows){
      const nome = b.dataset.nome; const categoria = b.dataset.c || 'PRATOS';
      await supa.from('pratos').insert({ nome, categoria }).catch(()=>{});
    }
    await loadPratosList(); await loadDashPratos();
  });

  /* ================= COMPONENTES DO PRATO ================= */
  async function loadPratoCompList(){
    const prato_id = $('pc-prato').value;
    const tb = $('tblPc').querySelector('tbody');
    const title = $('pc-title');
    tb.innerHTML='';
    if(!prato_id){ title.textContent='Componentes — (nenhum prato selecionado)'; return; }
    const { data: p } = await supa.from('pratos').select('nome').eq('id', prato_id).single();
    title.textContent = 'Componentes — '+(p?.nome || '(desconhecido)');
    const { data, error } = await supa.from('prato_receitas').select('id, receita_id, qtd, unidade, obs').eq('prato_id', prato_id);
    if(error){ tb.innerHTML='<tr><td colspan="5">Erro ao listar</td></tr>'; return; }
    tb.innerHTML='';
    for(const row of (data||[])){
      const { data: rec } = await supa.from('receitas').select('nome').eq('id', row.receita_id).single();
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${rec?.nome || '(receita removida)'}</td>
        <td><input data-k="qtd" data-id="${row.id}" value="${row.qtd}"></td>
        <td>
          <select data-k="unidade" data-id="${row.id}">
            ${['g','kg','ml','L','porcao'].map(u=>`<option value="${u}" ${u===row.unidade?'selected':''}>${u}</option>`).join('')}
          </select>
        </td>
        <td><input data-k="obs" data-id="${row.id}" value="${row.obs||''}"></td>
        <td class="row-actions no-print">
          <button class="btn" data-act="pc-save" data-id="${row.id}">Salvar</button>
          <button class="btn" data-act="pc-del" data-id="${row.id}">Remover</button>
        </td>`;
      tb.appendChild(tr);
    }
  }
  $('pc-prato').addEventListener('change', loadPratoCompList);
  $('tblPc').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id, act = btn.dataset.act;
    if(act==='pc-del'){
      if(!confirm('Remover receita do prato?')) return;
      const { error } = await supa.from('prato_receitas').delete().eq('id', id);
      if(error){ alert(error.message||error); return; }
      await loadPratoCompList();
    }
    if(act==='pc-save'){
      const cells = Array.from($('tblPc').querySelectorAll(`[data-id="${id}"]`)).reduce((acc,el)=>{ acc[el.dataset.k]=el.value; return acc; },{});
      const payload = { qtd: ptToNumber(cells.qtd), unidade: cells.unidade, obs: cells.obs };
      const { error } = await supa.from('prato_receitas').update(payload).eq('id', id);
      if(error){ alert(error.message||error); return; }
      setStatus('Componente atualizado','ok');
    }
  });
  $('btnPcAdd').addEventListener('click', async ()=>{
    const prato_id = $('pc-prato').value;
    const receita_id = $('pc-rec').value;
    const qtd = ptToNumber($('pc-qtd').value);
    const unidade = $('pc-und').value;
    const obs = $('pc-obs').value.trim() || null;
    if(!prato_id || !receita_id || !qtd){ alert('Selecione prato/receita e informe quantidade'); return; }
    const { error } = await supa.from('prato_receitas').insert({ prato_id, receita_id, qtd, unidade, obs });
    if(error && !String(error.message||'').includes('duplicate')){ alert(error.message||error); return; }
    $('pc-qtd').value=''; $('pc-obs').value='';
    await loadPratoCompList();
  });

  /* ================= RECEITAS / INGREDIENTES (utilitários) ================= */
  async function fillOptions(selectId, items, valKey, labelKey){
    const sel = $(selectId); if(!sel) return;
    sel.innerHTML=''; (items||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
  }
  async function fillOptionsFromQuery(selectId, table, valKey, labelKey, whereEq){
    const sel = $(selectId); if(!sel) return;
    let q = supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true});
    if(whereEq){ Object.entries(whereEq).forEach(([k,v]) => q = q.eq(k, v)); }
    const { data } = await q;
    sel.innerHTML=''; (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
  }
  async function loadReceitasSelect(){
    await fillOptionsFromQuery('ri-receita','receitas','id','nome',{});
    await fillOptionsFromQuery('pc-rec','receitas','id','nome',{ativo:true});
  }
  async function loadIngResumo(){
    const tb = $('tblIngResumo').querySelector('tbody');
    const { data } = await supa.from('ingredientes').select('nome,unidade,custo_unitario,ativo').order('nome');
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.nome}</td><td>${r.unidade}</td><td>${moneyBR(r.custo_unitario||0)}</td><td>${r.ativo?'<span class="pill">Ativo</span>':'<span class="pill">Inativo</span>'}</td>`;
      tb.appendChild(tr);
    });
  }

  let receitaEditId = null;
  async function enterReceita(id){
    receitaEditId = id||null;
    if(!id){ $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs').value=''; $('tblRi').querySelector('tbody').innerHTML=''; return; }
    const { data, error } = await supa.from('receitas').select('*').eq('id', id).single();
    if(error){ alert(error.message||error); return; }
    $('rec-nome').value = data.nome || '';
    $('rec-rend-qtd').value = data.rendimento_qtd ?? '';
    $('rec-rend-und').value = data.unidade_rendimento || 'g';
    $('rec-perda').value = data.perda_pct ?? '0';
    $('rec-obs').value = data.obs || '';
    await loadReceitaItensTable();
  }
  $('ri-receita').addEventListener('change', ()=>enterReceita($('ri-receita').value));
  $('btnRecNew').addEventListener('click', async ()=>{
    const nome = prompt('Nome da nova receita:'); if(!nome) return;
    const { data, error } = await supa.from('receitas').insert({ nome, rendimento_qtd:0, unidade_rendimento:'g', perda_pct:0 }).select('id').single();
    if(error){ alert(error.message||error); return; }
    await loadReceitasSelect(); $('ri-receita').value = data.id; enterReceita(data.id); setStatus('Receita criada','ok');
  });
  $('btnRecSave').addEventListener('click', async ()=>{
    if(!receitaEditId){ alert('Selecione uma receita'); return; }
    const payload = {
      nome: $('rec-nome').value.trim(),
      rendimento_qtd: ptToNumber($('rec-rend-qtd').value),
      unidade_rendimento: $('rec-rend-und').value,
      perda_pct: ptToNumber($('rec-perda').value),
      obs: $('rec-obs').value.trim() || null
    };
    if(!payload.nome || !payload.rendimento_qtd){ alert('Informe nome e rendimento'); return; }
    const { error } = await supa.from('receitas').update(payload).eq('id', receitaEditId);
    if(error){ alert(error.message||error); return; }
    await loadReceitasSelect(); setStatus('Receita salva','ok');
  });

  async function loadReceitaItensTable(){
    const tb = $('tblRi').querySelector('tbody'); tb.innerHTML='';
    if(!receitaEditId) return;
    const { data, error } = await supa.from('receita_itens').select('*').eq('receita_id', receitaEditId);
    if(error){ tb.innerHTML='<tr><td colspan="6">Erro ao listar itens</td></tr>'; return; }
    for(const it of (data||[]).sort((a,b)=>a.tipo.localeCompare(b.tipo))){
      let nome='—';
      if(it.tipo==='INGREDIENTE'){ const { data:ing } = await supa.from('ingredientes').select('nome').eq('id', it.ref_id).single(); nome = ing?.nome || '(ingrediente removido)'; }
      else { const { data:rec } = await supa.from('receitas').select('nome').eq('id', it.ref_id).single(); nome = rec?.nome || '(receita removida)'; }
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${it.tipo}</td>
        <td>${nome}</td>
        <td><input data-k="qtd" data-id="${it.id}" value="${it.qtd}"></td>
        <td>
          <select data-k="unidade" data-id="${it.id}">
            ${['g','kg','ml','L','un','porcao'].map(u=>`<option value="${u}" ${u===it.unidade?'selected':''}>${u}</option>`).join('')}
          </select>
        </td>
        <td><input data-k="perda_pct" data-id="${it.id}" value="${it.perda_pct||0}"></td>
        <td class="row-actions no-print">
          <button class="btn" data-act="ri-save" data-id="${it.id}">Salvar</button>
          <button class="btn" data-act="ri-del" data-id="${it.id}">Remover</button>
        </td>`;
      tb.appendChild(tr);
    }
  }
  $('tblRi').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id, act = btn.dataset.act;
    if(act==='ri-del'){
      if(!confirm('Remover componente?')) return;
      const { error } = await supa.from('receita_itens').delete().eq('id', id);
      if(error){ alert(error.message||error); return; }
      await loadReceitaItensTable();
    }
    if(act==='ri-save'){
      const row = Array.from($('tblRi').querySelectorAll(`[data-id="${id}"]`)).reduce((acc,el)=>{ acc[el.dataset.k]=el.value; return acc; },{});
      const payload = { qtd: ptToNumber(row.qtd), unidade: row.unidade, perda_pct: ptToNumber(row.perda_pct) };
      const { error } = await supa.from('receita_itens').update(payload).eq('id', id);
      if(error){ alert(error.message||error); return; }
      setStatus('Linha atualizada','ok');
    }
  });

  // draft
  let draftItems = [];
  function renderDraft(){ const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML=''; draftItems.forEach((d,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${d.tipo}</td><td>${d.nome}</td><td>${fmtBR(d.qtd)}</td><td>${d.unidade}</td><td>${fmtBR(d.perda_pct)}%</td><td class="row-actions no-print"><button class="btn" data-act="rm" data-idx="${i}">Remover</button></td>`; tb.appendChild(tr); }); }
  async function refreshDraftRefs(){
    const tipo = $('draft-tipo').value;
    if(tipo==='INGREDIENTE'){ const { data } = await supa.from('ingredientes').select('id,nome').eq('ativo',true).order('nome'); fillOptions('draft-ref', data, 'id','nome'); }
    else { const { data } = await supa.from('receitas').select('id,nome').eq('ativo',true).order('nome'); fillOptions('draft-ref', data, 'id','nome'); }
  }
  $('draft-tipo').addEventListener('change', refreshDraftRefs);
  $('btnDraftAdd').addEventListener('click', async ()=>{
    if(!receitaEditId){ alert('Selecione uma receita'); return; }
    const tipo=$('draft-tipo').value; const ref_id=$('draft-ref').value; const qtd=ptToNumber($('draft-qtd').value); const unidade=$('draft-und').value; const perda_pct=ptToNumber($('draft-perda').value);
    if(!ref_id || !qtd){ alert('Selecione referência e informe quantidade'); return; }
    let nome=''; if(tipo==='INGREDIENTE'){ const { data } = await supa.from('ingredientes').select('nome').eq('id', ref_id).single(); nome=data?.nome||''; } else { const { data } = await supa.from('receitas').select('nome').eq('id', ref_id).single(); nome=data?.nome||''; }
    draftItems.push({ tipo, ref_id, nome, qtd, unidade, perda_pct }); $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft();
  });
  $('tblDraft').addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; if(b.dataset.act==='rm'){ draftItems.splice(+b.dataset.idx,1); renderDraft(); }});
  $('btnDraftClear').addEventListener('click', ()=>{ draftItems=[]; renderDraft(); });
  $('btnDraftSave').addEventListener('click', async ()=>{
    if(!receitaEditId || !draftItems.length) return;
    const payload = draftItems.map(d=>({ receita_id: receitaEditId, tipo:d.tipo, ref_id:d.ref_id, qtd:d.qtd, unidade:d.unidade, perda_pct:d.perda_pct }));
    const { error } = await supa.from('receita_itens').insert(payload);
    if(error){ alert(error.message||error); return; }
    draftItems=[]; renderDraft(); await loadReceitaItensTable(); setStatus('Itens adicionados','ok');
  });

  /* ================= PREVISÃO (cálculo) ================= */
  document.querySelectorAll('#sub-prev [data-q]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const q = +b.dataset.q;
      const fim = new Date(); const inicio = addDays(fim, -(q-1));
      $('pv-inicio').value = toISODate(inicio);
      $('pv-fim').value = toISODate(fim);
    });
  });

  async function getPratoReceitasMap(){
    const { data: prc } = await supa.from('prato_receitas').select('prato_id, receita_id, qtd, unidade');
    const { data: pratos } = await supa.from('pratos').select('id,nome');
    const { data: receitas } = await supa.from('receitas').select('id,nome');
    const pratoById = new Map((pratos||[]).map(p=>[p.id,p.nome]));
    const recById = new Map((receitas||[]).map(r=>[r.id,r.nome]));
    const map = new Map();
    (prc||[]).forEach(r=>{
      const pratoNome = pratoById.get(r.prato_id);
      const receitaNome = recById.get(r.receita_id);
      if(!pratoNome || !receitaNome) return;
      if(!map.has(pratoNome)) map.set(pratoNome, []);
      map.get(pratoNome).push({ receita: receitaNome, qtd: +r.qtd, un: r.unidade });
    });
    return map;
  }

  async function getMediaPorPrato(inicioISO, fimISO){
    const { data, error } = await supa
      .from(SALES_VIEW).select('data,prato,quantidade')
      .gte('data', inicioISO).lte('data', fimISO).limit(50000);
    if(error){ alert('Erro lendo vendas: '+(error.message||error)); return { medias:new Map(), dias:0 }; }
    const dias = Math.max(1, Math.round((new Date(fimISO)-new Date(inicioISO))/86400000)+1);
    const totPorPrato = new Map();
    (data||[]).forEach(r=>{
      const key = r.prato; const q = +r.quantidade || 0;
      totPorPrato.set(key, (totPorPrato.get(key)||0)+q);
    });
    const medias = new Map();
    totPorPrato.forEach((tot,prato)=>{ medias.set(prato, tot/dias); });
    return { medias, dias };
  }

  function fillTable(tbody, rows){ tbody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=r; tbody.appendChild(tr); }); }

  // estado de previsão e plano
  let previsaoReceitasDia = new Map(); // key: rec|un -> qtd/dia
  let previsaoReceitasTot = new Map(); // key: rec|un -> qtd total
  let previsaoHorizonte = 7;
  let previsaoPeriodo = {ini:'', fim:''};

  $('btnGerarPrev').addEventListener('click', async ()=>{
    const ini = $('pv-inicio').value; const fim = $('pv-fim').value;
    const horizonte = +$('pv-horizonte').value || 7;
    if(!ini || !fim){ alert('Defina início e fim'); return; }
    setStatus('Calculando previsão…','');

    const { medias } = await getMediaPorPrato(ini, fim);
    const map = await getPratoReceitasMap();

    previsaoReceitasDia = new Map(); previsaoReceitasTot = new Map();
    previsaoHorizonte = horizonte; previsaoPeriodo = {ini, fim};

    const rowsPrDia = [], rowsPrTot = [];
    medias.forEach((media, prato)=>{
      if(media<=0) return;
      rowsPrDia.push(`<tr><td>${prato}</td><td>${fmtBR(media,2)}</td></tr>`);
      rowsPrTot.push(`<tr><td>${prato}</td><td>${fmtBR(media*horizonte,2)}</td><td>${horizonte} dias</td></tr>`);
      const comps = map.get(prato) || [];
      comps.forEach(c=>{
        const key = c.receita+'|'+c.un;
        const addDia = media * c.qtd;
        const addTot = addDia * horizonte;
        previsaoReceitasDia.set(key, (previsaoReceitasDia.get(key)||0) + addDia);
        previsaoReceitasTot.set(key, (previsaoReceitasTot.get(key)||0) + addTot);
      });
    });

    const rowsRecDia = [], rowsRecTot = [];
    Array.from(previsaoReceitasDia.entries()).sort((a,b)=>a[0].localeCompare(b[0],'pt-BR')).forEach(([key,val])=>{
      const [rec,un]=key.split('|');
      rowsRecDia.push(`<tr><td>${rec}</td><td>${fmtBR(val,2)}</td><td>${un}</td></tr>`);
    });
    Array.from(previsaoReceitasTot.entries()).sort((a,b)=>a[0].localeCompare(b[0],'pt-BR')).forEach(([key,val])=>{
      const [rec,un]=key.split('|');
      rowsRecTot.push(`<tr><td>${rec}</td><td>${fmtBR(val,2)}</td><td>${un}</td></tr>`);
    });

    fillTable($('tblPrevPratosDia').querySelector('tbody'), rowsPrDia);
    fillTable($('tblPrevPratosTot').querySelector('tbody'), rowsPrTot);
    fillTable($('tblPrevReceitasDia').querySelector('tbody'), rowsRecDia);
    fillTable($('tblPrevReceitasTot').querySelector('tbody'), rowsRecTot);

    // calendário com weekday
    const calRows=[];
    for(let i=0;i<horizonte;i++){
      const dt = toISODate(addDays(new Date(), i));
      calRows.push(`<tr><td>${dt}</td><td>${wd(dt)}</td></tr>`);
    }
    fillTable($('tblCalendario').querySelector('tbody'), calRows);

    $('prev-results').style.display='block';
    setStatus('Pronto','ok');
  });

  // Export PDF da previsão
  $('btnPrevPDF').addEventListener('click', ()=>{
    if(!$('prev-results').style.display || $('prev-results').style.display==='none'){ alert('Gere a previsão primeiro.'); return; }
    const html = `
      <h2>Previsão de Produção</h2>
      <div class="meta">Base: ${previsaoPeriodo.ini} a ${previsaoPeriodo.fim} • Horizonte: ${previsaoHorizonte} dia(s)</div>
      <h3>Média diária por prato</h3>${$('tblPrevPratosDia').outerHTML}
      <h3>Projeção total por prato</h3>${$('tblPrevPratosTot').outerHTML}
      <h3>Produção diária (Receitas)</h3>${$('tblPrevReceitasDia').outerHTML}
      <h3>Produção TOTAL (Receitas)</h3>${$('tblPrevReceitasTot').outerHTML}
      <h3>Calendário</h3>${$('tblCalendario').outerHTML}
    `;
    printHTML(html);
  });

  // Plano de produção (reaproveita previsão total)
  let planoProducaoTotal = new Map();

  $('btnPrevToProd').addEventListener('click', ()=>{
    if(previsaoReceitasTot.size===0){ alert('Gere a previsão primeiro.'); return; }
    planoProducaoTotal = new Map(previsaoReceitasTot);
    // troca para sub-aba Compras (para depois gerar)
    document.querySelector('#tab-principal-mapa .subtab[data-subtab="sub-compras"]').click();
    setStatus('Plano carregado na Produção/Compras','ok');
  });

  /* ============ COMPRAS (expansão receitas → ingredientes) ============ */
  // caches
  let receitasCache = new Map();    // id -> {nome,rq,ur,perda}
  let ingredientesCache = new Map();// id -> {nome, un, custo, ativo}
  let itensCache = new Map();       // receita_id -> array

  async function ensureCaches(){
    if(receitasCache.size===0){
      const { data: r } = await supa.from('receitas').select('id,nome,rendimento_qtd,unidade_rendimento,perda_pct');
      (r||[]).forEach(x=> receitasCache.set(x.id, {nome:x.nome, rq:+(x.rendimento_qtd||0), ur:x.unidade_rendimento, perda:+(x.perda_pct||0)}));
    }
    if(ingredientesCache.size===0){
      const { data: i } = await supa.from('ingredientes').select('id,nome,unidade,custo_unitario,ativo');
      (i||[]).forEach(x=> ingredientesCache.set(x.id, {nome:x.nome, un:x.unidade, custo:+(x.custo_unitario||0), ativo: !!x.ativo}));
    }
    if(itensCache.size===0){
      const { data: it } = await supa.from('receita_itens').select('*');
      (it||[]).forEach(x=>{
        if(!itensCache.has(x.receita_id)) itensCache.set(x.receita_id, []);
        itensCache.get(x.receita_id).push(x);
      });
    }
  }
  function normQty(q, un){ if(un==='kg') return {q:q*1000, un:'g'}; if(un==='L') return {q:q*1000, un:'ml'}; return {q,un}; }

  async function expandReceitaToInsumos(recId, qtdRec){
    await ensureCaches();
    const out = new Map(); // key ing|un -> qtd
    const it = itensCache.get(recId) || [];
    for(const row of it){
      const perda = +row.perda_pct || 0;
      const fatorPerda = (100/(100 - Math.min(99.9, Math.max(0, perda))));
      const qtdNec = (+row.qtd || 0) * qtdRec * fatorPerda;
      if(row.tipo==='INGREDIENTE'){
        const ing = ingredientesCache.get(row.ref_id); if(!ing) continue;
        const n = normQty(qtdNec, row.unidade);
        const key = ing.nome + '|' + n.un;
        out.set(key, (out.get(key)||0) + n.q);
      }else{
        const sub = receitasCache.get(row.ref_id); if(!sub) continue;
        const lotes = sub.rq>0 ? (qtdNec / sub.rq) : qtdNec;
        const subOut = await expandReceitaToInsumos(row.ref_id, lotes);
        subOut.forEach((v,k)=> out.set(k, (out.get(k)||0)+v));
      }
    }
    return out;
  }

  $('btnGerarCompras').addEventListener('click', async ()=>{
    if(planoProducaoTotal.size===0){ alert('Carregue o plano via Previsão → Enviar para Produção'); return; }
    setStatus('Calculando compras…','');
    const { data: allRec } = await supa.from('receitas').select('id,nome');
    const idByName = new Map((allRec||[]).map(r=>[r.nome,r.id]));
    const compras = new Map(); // key ing|un -> {q,custo}
    for(const [key, qtdTotal] of planoProducaoTotal.entries()){
      const [recName] = key.split('|');
      const recId = idByName.get(recName); if(!recId) continue;
      const insumos = await expandReceitaToInsumos(recId, qtdTotal);
      insumos.forEach((q, k)=>{
        const [ingName] = k.split('|'); let custoUnit = 0;
        for(const v of ingredientesCache.values()){ if(v.nome===ingName){ custoUnit = v.custo; break; } }
        const comp = compras.get(k) || {q:0, custo:custoUnit};
        comp.q += q; comp.custo = custoUnit; compras.set(k, comp);
      });
    }
    const tb = $('tblCompras').querySelector('tbody'); tb.innerHTML='';
    let soma = 0;
    Array.from(compras.entries()).sort((a,b)=>a[0].localeCompare(b[0],'pt-BR')).forEach(([k, obj])=>{
      const [nome, un] = k.split('|'); const total = obj.custo * obj.q; soma += total;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${nome}</td><td>${fmtBR(obj.q,2)}</td><td>${un}</td><td>${moneyBR(obj.custo)}</td><td>${moneyBR(total)}</td>`;
      tb.appendChild(tr);
    });
    $('compras-total').textContent = moneyBR(soma);
    setStatus('Compras consolidadas','ok');
  });

  $('btnComprasPDF').addEventListener('click', ()=>{
    const html = `<h2>Lista de Compras</h2>${$('tblCompras').outerHTML}`;
    printHTML(html);
  });

  /* ================= INIT ================= */
  async function init(){
    try{
      const fim = new Date(); const ini = addDays(fim, -14);
      $('pv-inicio').value = toISODate(ini); $('pv-fim').value = toISODate(fim);
      await loadPratosList();
      await loadReceitasSelect();
      await loadIngResumo();
      setStatus('Pronto','ok');
    }catch(e){ setStatus(e.message,'err'); }
  }
  init();
});
</script>
</body>
</html>
