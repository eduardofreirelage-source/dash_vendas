<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Maestro Food — RPC</title>
  <!-- Favicon inline (sem 404) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--muted:#667085;--text:#0f172a;--blue:#1a73e8;--stroke:#e6eaf2;--radius:14px}
    body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:1100px;margin:24px auto 64px;padding:0 16px}
    h1{font-size:22px;margin:0 0 6px}
    .muted{color:var(--muted)}
    .row{display:grid;gap:10px}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:var(--radius);padding:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{width:100%;padding:9px 10px;border:1px solid var(--stroke);border-radius:10px;background:#fff}
    .btn{background:var(--blue);color:#fff;border:none;cursor:pointer}
    .btn.ghost{background:#eef3ff;color:#1747b7}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
    .kpi h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
    .kpi b{font-size:20px}
    .status{font-size:12px}
    @media (max-width:960px){.cols-4,.cols-3,.cols-2,.kpis{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Maestro Food — RPC</h1>
    <div class="status muted" id="status">Conectando…</div>

    <div class="card" style="margin-top:10px">
      <div class="row cols-4">
        <div><label>De</label><input type="date" id="dini"></div>
        <div><label>Até</label><input type="date" id="dfim"></div>
        <div>
          <label>Período rápido</label>
          <select id="quick">
            <option value="30">Últimos 30</option>
            <option value="60">Últimos 60</option>
            <option value="90" selected>Últimos 90</option>
            <option value="mes">Este mês</option>
            <option value="mesant">Último mês</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button class="btn" id="aplicar">Aplicar</button>
          <button class="btn ghost" id="limpar">Limpar</button>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div><label>Unidade</label><select id="fUni"><option value="">Todas</option></select></div>
        <div><label>Loja (Top 10, sem “Loja Centro”/vazias)</label><select id="fLoja"><option value="">Todas</option></select></div>
        <div><label>Cancelado?</label>
          <select id="fCanc">
            <option value="Todos">Todos</option>
            <option value="Não" selected>Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:10px">
        <div><label>Canal</label><select id="fCanal"><option value="">Todos</option></select></div>
        <div><label>Pagamento</label><select id="fPag"><option value="">Todos</option></select></div>
        <div><label>&nbsp;</label><small class="muted" id="periodo">Período: —</small></div>
      </div>
    </div>

    <div class="kpis" style="margin-top:10px">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
      <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
      <div class="card kpi"><h3>Fat. Líquido</h3><b id="kFatLiq">—</b></div>
      <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
      <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
      <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
      <div class="card kpi"><h3>Fat. Médio/Dia</h3><b id="kFatDia">—</b></div>
    </div>

    <div class="card" style="margin-top:10px">
      <b>Receita diária</b>
      <canvas id="chart" height="140" style="margin-top:8px"></canvas>
    </div>
  </div>

  <!-- libs ANTES do seu script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
  (function(){
    // ====== CONFIG ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
    const TABLE = "vendas_kpi_daily_v2_data";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ====== DOM ======
    const S = id => document.getElementById(id);
    const statusEl = S('status'), periodoEl = S('periodo');
    const dini = S('dini'), dfim = S('dfim'), quick = S('quick');
    const fUni = S('fUni'), fLoja = S('fLoja'), fCanal = S('fCanal'), fPag = S('fPag'), fCanc = S('fCanc');
    const kPedidos=S('kPedidos'), kTicket=S('kTicket'), kFat=S('kFat'), kFatLiq=S('kFatLiq'),
          kDes=S('kDes'), kDesPct=S('kDesPct'), kFre=S('kFre'), kFatDia=S('kFatDia');
    let chart=null, minISO=null, maxISO=null;

    // ====== UTILS ======
    const fmtBRL = v => isFinite(v) ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—";
    const fmtPct = v => isFinite(v) ? (v*100).toFixed(1).replace('.',',')+'%' : "—";
    const onlyISO = s => (s||'').slice(0,10);
    const norm = s => String(s??'').trim().toLowerCase();
    const isLojaBloqueada = name => {
      const n = norm(name);
      return !n || n === 'loja centro';
    };
    function setQuick(range){
      const end = maxISO ? new Date(maxISO) : new Date();
      let start = new Date(end);
      if(range==='mes'){ start = new Date(end.getFullYear(), end.getMonth(), 1); }
      else if(range==='mesant'){ start = new Date(end.getFullYear(), end.getMonth()-1, 1); end.setDate(0); }
      else { const n=parseInt(range||'90',10); start.setDate(end.getDate()-(n-1)); }
      dini.value = toISO(start); dfim.value = toISO(end);
    }
    function toISO(d){ const x=new Date(d); if(isNaN(x))return null; return x.toISOString().slice(0,10); }

    // ====== LOAD MIN/MAX ======
    async function findMinMax(){
      const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
      const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
      if(!a.error && a.data?.length){ minISO = onlyISO(a.data[0].dia); }
      if(!b.error && b.data?.length){ maxISO = onlyISO(b.data[0].dia); }
      if(minISO && maxISO){
        statusEl.textContent = `Fonte: ${TABLE} | Intervalo: ${minISO} → ${maxISO}`;
      } else {
        statusEl.textContent = 'Sem dados na fonte.';
      }
    }

    // ====== OPTIONS (leves) ======
    async function buildOptions(){
      // Unidades
      const u = await supa.from(TABLE).select('unidade').not('unidade','is',null).order('unidade',{ascending:true}).range(0, 99999);
      if(!u.error){
        const arr=[...new Set((u.data||[]).map(r=>r.unidade).filter(Boolean))];
        fUni.innerHTML = '<option value="">Todas</option>'+arr.map(v=>`<option>${v}</option>`).join('');
      }
      // Canal
      const c = await supa.from(TABLE).select('"Canal de venda"').order('Canal de venda',{ascending:true}).range(0, 99999);
      if(!c.error){
        const arr=[...new Set((c.data||[]).map(r=>r["Canal de venda"]).filter(Boolean))];
        fCanal.innerHTML = '<option value="">Todos</option>'+arr.map(v=>`<option>${v}</option>`).join('');
      }
      // Pagamento
      const p = await supa.from(TABLE).select('pagamento').order('pagamento',{ascending:true}).range(0, 99999);
      if(!p.error){
        const arr=[...new Set((p.data||[]).map(r=>r.pagamento).filter(Boolean))];
        fPag.innerHTML = '<option value="">Todos</option>'+arr.map(v=>`<option>${v}</option>`).join('');
      }
      // Lojas Top10 (EXCLUI “Loja Centro” e vazias)
      const pageSize = 20000;
      let from = 0, done=false;
      const acc = new Map();
      while(!done){
        const l = await supa.from(TABLE)
          .select('"Nome da loja",fat')
          .not('fat','is',null)
          .not('Nome da loja','is',null)
          .range(from, from+pageSize-1);
        if(l.error) break;
        (l.data||[]).forEach(r=>{
          const k = r["Nome da loja"];
          if(isLojaBloqueada(k)) return; // pula vazias/Loja Centro
          acc.set(k,(acc.get(k)||0)+(Number(r.fat)||0));
        });
        if(!l.data || l.data.length < pageSize) done = true;
        from += pageSize;
        if(from > 200000) done = true; // guarda-chuva
      }
      const top = Array.from(acc.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
      fLoja.innerHTML = '<option value="">Todas</option>'+top.map(v=>`<option>${v}</option>`).join('');
    }

    // ====== RPC HELPERS ======
    function lojaParam(){
      const v = S('fLoja').value || '';
      if(isLojaBloqueada(v)) return null; // segurança: nunca envia Loja Centro/vazio
      return v || null;
    }
    function arrOrNull(v){ return v ? [v] : null; }
    async function loadKPIs(d1,d2,uni,loja,canal,pag,canc){
      return supa.rpc('dash_kpis',{
        _dini:d1, _dfim:d2,
        _unidade: uni||null,
        _loja: loja,
        _canais: arrOrNull(canal),
        _pagamentos: arrOrNull(pag),
        _cancelado: canc||'Todos'
      });
    }
    async function loadSerie(d1,d2,uni,loja,canal,pag,canc){
      return supa.rpc('dash_serie',{
        _dini:d1, _dfim:d2,
        _unidade: uni||null,
        _loja: loja,
        _canais: arrOrNull(canal),
        _pagamentos: arrOrNull(pag),
        _cancelado: canc||'Todos'
      });
    }

    // ====== RENDER ======
    function renderKPIs(row,d1,d2){
      const pedidos = Number(row?.pedidos)||0;
      const fat = Number(row?.fat)||0;
      const des = Number(row?.descontos)||0;
      const fre = Number(row?.fretes)||0;
      const fatliq = isFinite(Number(row?.fat_liquido)) ? Number(row?.fat_liquido) : (fat - des - fre);
      const ticket = pedidos? fat/pedidos : 0;
      const dias = (()=>{ const a=new Date(d1), b=new Date(d2); return Math.floor((b-a)/86400000)+1; })();
      const fatDia = dias>0? fat/dias : 0;
      const desPct = fat? des/fat : 0;

      kPedidos.textContent = pedidos.toLocaleString('pt-BR');
      kTicket.textContent  = fmtBRL(ticket);
      kFat.textContent     = fmtBRL(fat);
      kFatLiq.textContent  = fmtBRL(fatliq);
      kDes.textContent     = fmtBRL(des);
      kDesPct.textContent  = fmtPct(desPct);
      kFre.textContent     = fmtBRL(fre);
      kFatDia.textContent  = fmtBRL(fatDia);
    }

    function renderChart(rows){
      const ctx = S('chart').getContext('2d');
      if(chart){ chart.destroy(); chart=null; }

      // Proteções contra “gráfico infinito”
      if(!rows || !Array.isArray(rows) || rows.length===0) return;

      const labels=[]; const values=[];
      for(const r of rows){
        const d = r?.dia; const v = Number(r?.fat);
        if(d && isFinite(v)){ labels.push(d); values.push(v); }
      }
      if(labels.length===0) return;

      chart = new Chart(ctx,{
        type:'line',
        data:{labels, datasets:[{label:'Receita', data:values, tension:0.2}]},
        options:{
          responsive:true, maintainAspectRatio:false,
          parsing:false, // usa arrays já validados
          scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>v.toLocaleString('pt-BR') } } }
        }
      });
    }

    // ====== RELOAD ======
    async function reload(){
      const d1 = dini.value || minISO;
      const d2 = dfim.value || maxISO;
      const uni = fUni.value || null;
      const loja= lojaParam();
      const canal=fCanal.value || null;
      const pag  =fPag.value || null;
      const canc = fCanc.value || 'Todos';
      periodoEl.textContent = `Período: ${d1??'—'} → ${d2??'—'}`;

      const k = await loadKPIs(d1,d2,uni,loja,canal,pag,canc);
      if(k.error){ console.error(k.error); renderKPIs({},d1,d2); }
      else { renderKPIs(k.data?.[0]||{}, d1,d2); }

      const s = await loadSerie(d1,d2,uni,loja,canal,pag,canc);
      if(s.error){ console.error(s.error); renderChart([]); }
      else { renderChart(s.data||[]); }
    }

    // ====== EVENTS ======
    S('aplicar').addEventListener('click', reload);
    S('limpar').addEventListener('click', ()=>{
      fUni.value=""; fLoja.value=""; fCanal.value=""; fPag.value=""; fCanc.value="Não";
      setQuick(quick.value); reload();
    });
    quick.addEventListener('change', ()=>{ setQuick(quick.value); reload(); });

    // ====== BOOT ======
    (async function boot(){
      statusEl.textContent = 'Conectado ao Supabase.';
      await findMinMax();
      if(!minISO || !maxISO){ renderChart([]); renderKPIs({},null,null); return; }
      dini.value=minISO; dfim.value=maxISO; setQuick(quick.value);
      await buildOptions();
      await reload();
    })();
  })();
  </script>
</body>
</html>
