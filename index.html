<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v17.2-MV-paged-fix3+layout+pr-dropdown)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#6b7280; --card:#fff; --brd:#e5e7eb; --up:#16a34a; --down:#dc2626; }
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 4px}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--brd);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:700;margin-top:4px;display:flex;align-items:baseline;gap:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    /* Filtros como boxes de tamanho similar */
    .filters .rowgrid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .filters .rowgrid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:10px}
    .filters .rowgrid5{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin-top:10px}
    .filters .rowgrid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:10px}
    .seg{display:flex;flex-direction:column;gap:6px}
    .seg .lbl{font-size:12px;color:var(--muted)}
    select,input[type="date"],button{font:inherit;padding:10px 12px;border:1px solid var(--brd);border-radius:10px;background:#fff;width:100%}
    button{cursor:pointer}
    .chartbox{position:relative;height:280px;width:100%}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    .delta{display:block;margin-top:4px}
    .delta.up{color:var(--up)} .delta.down{color:var(--down)}
    .delta .pct{font-weight:600}
    .miniDelta{font-size:12px;font-weight:700}
    .miniDelta.up{color:var(--up)} .miniDelta.down{color:var(--down)}
    .hidden{display:none}
    @media (max-width:980px){
      .filters .rowgrid4{grid-template-columns:repeat(2,minmax(0,1fr))}
      .filters .rowgrid5{grid-template-columns:repeat(3,minmax(0,1fr))}
      .filters .rowgrid3{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:560px){
      .filters .rowgrid2,.filters .rowgrid4,.filters .rowgrid5,.filters .rowgrid3{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <h1>Dashboard Vendas — Supabase <span class="muted">(v17.2-MV-paged-fix3)</span></h1>
        <div class="muted">Fonte: <code>public.vendas_kpi_daily_v2</code> (paginado)</div>
        <div class="muted" id="periodo">Período: —</div>
        <div class="muted" id="limites">Limites no banco: —</div>
      </div>
      <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
    </div>

    <!-- Filtros -->
    <div class="card filters" style="margin-top:12px">
      <!-- 1) Unidade e Modo -->
      <div class="rowgrid2">
        <div class="seg">
          <span class="lbl">Unidade</span>
          <select id="uni"></select>
        </div>
        <div class="seg">
          <span class="lbl">Modo</span>
          <select id="modo">
            <option value="bruto">Total (bruto)</option>
            <option value="liq">Líquido (Total - Entrega)</option>
          </select>
        </div>
      </div>

      <!-- 2) De, Até, Período rápido, Turno (+ Dia da semana ao final da linha para manter o filtro) -->
      <div class="rowgrid5">
        <div class="seg">
          <span class="lbl">De</span>
          <input id="dini" type="date" />
        </div>
        <div class="seg">
          <span class="lbl">Até</span>
          <input id="dfim" type="date" />
        </div>
        <div class="seg">
          <span class="lbl">Período rápido (dias)</span>
          <select id="prapido">
            <option value="">—</option>
            <option value="7">7</option>
            <option value="15">15</option>
            <option value="30" selected>30</option>
            <option value="90">90</option>
            <option value="180">180</option>
            <option value="360">360</option>
          </select>
        </div>
        <div class="seg hidden" id="segTurno">
          <span class="lbl">Turno</span>
          <select id="turno">
            <option value="todos" selected>Todos</option>
          </select>
        </div>
        <div class="seg" id="segDOW">
          <span class="lbl">Dia da semana</span>
          <select id="dow">
            <option value="todos" selected>Todos</option>
            <option value="uteis">Úteis (Seg–Sex)</option>
            <option value="fds">Fins de semana (Sáb–Dom)</option>
            <option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option>
            <option value="4">Qui</option><option value="5">Sex</option><option value="6">Sáb</option><option value="0">Dom</option>
          </select>
        </div>
      </div>

      <!-- 3) Canal de venda, Pagamento, Está cancelado -->
      <div class="rowgrid3">
        <div class="seg hidden" id="segCanal">
          <span class="lbl">Canal de venda</span>
          <select id="canal"><option value="todos" selected>Todos</option></select>
        </div>
        <div class="seg hidden" id="segPagto">
          <span class="lbl">Pagamento</span>
          <select id="pagto"><option value="todos" selected>Todos</option></select>
        </div>
        <div class="seg hidden" id="segCanc">
          <span class="lbl">Está cancelado</span>
          <select id="canc">
            <option value="todos" selected>Todos</option>
            <option value="sim">Somente cancelados</option>
            <option value="nao">Somente não cancelados</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="limpar" style="width:auto">Limpar filtros</button>
      </div>

      <div class="muted" style="margin-top:6px">
        Datas limitadas ao intervalo existente (ancoradas no último dia disponível por Unidade).
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid" style="margin-top:12px">
      <div class="card">
        <div class="title">Pedidos</div>
        <div class="val" id="k_ped">…</div>
        <div class="muted" id="k_ped_delta">—</div>
      </div>
      <div class="card">
        <div class="title">Faturamento</div>
        <div class="val" id="k_fat">…</div>
        <div class="muted" id="k_fat_delta">—</div>
      </div>
      <div class="card">
        <div class="title">Incentivos</div>
        <div class="val" id="k_des">…</div>
        <div class="muted" id="k_des_delta">—</div>
      </div>
      <div class="card">
        <div class="title">Frete</div>
        <div class="val" id="k_fre">…</div>
        <div class="muted" id="k_fre_delta">—</div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="card" style="margin-top:12px">
      <div class="title">Receita diária (R$)</div>
      <div class="chartbox"><canvas id="cLine"></canvas></div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title">Totais por dia da semana (R$)</div>
      <div class="chartbox"><canvas id="cBar"></canvas></div>
    </div>

    <!-- Logs -->
    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

<script>
(function(){
  if (window.__DASH_BOOTED__) return; window.__DASH_BOOTED__ = true;

  // ===== Credenciais =====
  var SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  var SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  var TABLE = "vendas_kpi_daily_v2";

  // ===== UI refs =====
  var elLog=document.getElementById("log"), elPeriodo=document.getElementById("periodo"), elLimites=document.getElementById("limites");
  var selUni=document.getElementById("uni"), dini=document.getElementById("dini"), dfim=document.getElementById("dfim");
  var modo=document.getElementById("modo"), prapido=document.getElementById("prapido"), selDOW=document.getElementById("dow");
  var segTurno=document.getElementById("segTurno"), segCanal=document.getElementById("segCanal"), segPagto=document.getElementById("segPagto"), segCanc=document.getElementById("segCanc");
  var selTurno=document.getElementById("turno"), selCanal=document.getElementById("canal"), selPagto=document.getElementById("pagto"), selCanc=document.getElementById("canc");

  // ===== Helpers =====
  function log(s){ elLog.textContent += "\n"+s; }
  function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
  function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
  function toISO(d){ return d.toISOString().slice(0,10); }
  function addDays(d, k){ var t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; }
  function sum(arr, key){ var s=0; for(var i=0;i<arr.length;i++) s+=Number(arr[i][key]||0); return s; }
  function debounce(fn, wait){ var t; return function(){ var a=arguments,c=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(c,a); }, wait); }; }
  function getDateFromInput(el){ if(!el.value) return null; return new Date(el.value+"T00:00:00Z"); }
  function setDateInput(el, iso){ el.value = iso || ""; if(dataMinISO) el.min = dataMinISO; if(dataMaxISO) el.max = dataMaxISO; }

  // ===== Supabase client =====
  var supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:false } });

  // ===== Estado =====
  var chartLine=null, chartBar=null, runId=0, drawing=false, dataMinISO=null, dataMaxISO=null;
  var schema = { turno:null, canal:null, pagamento:null, cancelado:null, cancelType:null };

  // ===== Consultas =====
  async function fetchPaged(startISO, endISO, unidade){
    var page=1000, off=0, out=[];
    for(;;){
      var q = supa.from(TABLE)
        .select("dia,unidade,pedidos,fat,des,fre")
        .gte("dia", startISO).lte("dia", endISO)
        .order("dia", {ascending:true}).range(off, off+page-1);
      if(unidade && unidade!=="Todas") q = q.eq("unidade", unidade);
      q = applyServerFilters(q);
      var r = await q; if(r.error){ throw r.error; }
      var a=r.data||[]; out = out.concat(a);
      if(a.length<page) break; off += page;
      if(off>500000){ log("[Warn] abortado por salvaguarda de paginação."); break; }
    }
    return out;
  }

  function applyServerFilters(q){
    if(schema.turno && selTurno.value!=="todos") q = q.eq(schema.turno, selTurno.value);
    if(schema.canal && selCanal.value!=="todos") q = q.eq(schema.canal, selCanal.value);
    if(schema.pagamento && selPagto.value!=="todos") q = q.eq(schema.pagamento, selPagto.value);
    if(schema.cancelado && selCanc.value!=="todos"){
      var val = selCanc.value==="sim";
      if(schema.cancelType==="bool"){ q = q.eq(schema.cancelado, val); }
      else if(schema.cancelType==="num"){ q = q.eq(schema.cancelado, val?1:0); }
      else if(schema.cancelType==="str"){
        q = q.in(schema.cancelado, val? ["Sim","sim","S","1","true","TRUE"] : ["Não","Nao","não","nao","N","0","false","FALSE"]);
      }else{ q = q.eq(schema.cancelado, val); }
    }
    return q;
  }

  // Unidades
  async function fetchUnidades(){
    var uniq={}, arr=["Todas"];
    function push(list){ (list||[]).forEach(function(row){ var u=(row.unidade||"").trim(); if(!u) return; if(!uniq[u]){ uniq[u]=1; arr.push(u); } }); }
    var today = new Date();
    var endISO = toISO(new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate())));
    var startISO = "2020-01-01";
    var r1 = await supa.from(TABLE).select("unidade").gte("dia", startISO).lte("dia", endISO).order("unidade",{ascending:true}).range(0,9999);
    if(!r1.error) push(r1.data);
    var r2 = await supa.from(TABLE).select("unidade").gte("dia", startISO).lte("dia", endISO).order("unidade",{ascending:false}).range(0,9999);
    if(!r2.error) push(r2.data);
    if(arr.length===1){ arr.push("Uni. Raja","Uni.Savassi"); }
    return arr;
  }

  // Limites por Unidade
  async function getDateBounds(unidade){
    var qMax = supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    var qMin = supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    if(unidade && unidade!=="Todas"){ qMax=qMax.eq("unidade",unidade); qMin=qMin.eq("unidade",unidade); }
    var [rMax,rMin]=await Promise.all([qMax,qMin]);
    if(rMax.error) throw rMax.error;
    if(rMin.error) throw rMin.error;
    return {
      maxISO: (rMax.data&&rMax.data[0])? rMax.data[0].dia : null,
      minISO: (rMin.data&&rMin.data[0])? rMin.data[0].dia : null
    };
  }

  async function refreshBounds(unidade){
    var b = await getDateBounds(unidade);
    dataMinISO = b.minISO; dataMaxISO = b.maxISO;
    if(!dataMaxISO || !dataMinISO){ elLimites.textContent="Limites no banco: — (sem dados)"; log("[Info] Sem dados para limites."); return; }
    elLimites.textContent = "Limites no banco: "+dataMinISO+" → "+dataMaxISO+(unidade && unidade!=="Todas" ? (" • Unidade: "+unidade) : " • Todas");
    setDateInput(dini, dataMinISO); setDateInput(dfim, dataMaxISO);
    log("[Bounds] "+elLimites.textContent);
  }

  // Schema (liga/desliga filtros)
  async function inspectSchema(unidade){
    var q = supa.from(TABLE).select("*").limit(1);
    if(unidade && unidade!=="Todas") q = q.eq("unidade",unidade);
    var r = await q; if(r.error){ log("[Schema] falhou: "+r.error.message); return; }
    var row = (r.data && r.data[0]) ? r.data[0] : {};
    function pick(keys){ for(var i=0;i<keys.length;i++){ if(keys[i] in row){ return keys[i]; } } return null; }
    schema.turno     = pick(["turno","periodo_turno","shift"]);
    schema.canal     = pick(["canal_venda","canal","origem","origem_pedido"]);
    schema.pagamento = pick(["pagamento","forma_pagamento","meio_pagamento","metodo_pagamento"]);
    schema.cancelado = pick(["cancelado","is_cancelado","cancel"]);
    schema.cancelType=null;
    if(schema.cancelado){
      var v=row[schema.cancelado];
      if(typeof v==="boolean") schema.cancelType="bool";
      else if(v===0||v===1)   schema.cancelType="num";
      else if(typeof v==="string") schema.cancelType="str";
    }
    segTurno.classList.toggle("hidden", !schema.turno);
    segCanal.classList.toggle("hidden", !schema.canal);
    segPagto.classList.toggle("hidden", !schema.pagamento);
    segCanc.classList.toggle("hidden", !schema.cancelado);
    log("[Schema] turno="+!!schema.turno+" canal="+!!schema.canal+" pagto="+!!schema.pagamento+" canc="+!!schema.cancelado);
  }

  // Distinct para dropdowns
  function setOptionsWithTodos(sel, items){
    var prev = sel.value || "todos";
    sel.innerHTML=""; var opt0=document.createElement("option"); opt0.value="todos"; opt0.textContent="Todos"; sel.appendChild(opt0);
    (items||[]).forEach(function(v){ var o=document.createElement("option"); o.value=String(v); o.textContent=String(v); sel.appendChild(o); });
    sel.value = [...Array.from(sel.options)].some(o=>o.value===prev) ? prev : "todos";
  }
  async function loadDistinct(col, sel, startISO, endISO, unidade){
    var uniq={}, out=[], page=1000, off=0;
    for(;;){
      var q = supa.from(TABLE).select(col).gte("dia", startISO).lte("dia", endISO).order(col,{ascending:true}).range(off, off+page-1);
      if(unidade && unidade!=="Todas") q = q.eq("unidade",unidade);
      var r = await q; if(r.error){ log("[Warn] distinct "+col+": "+r.error.message); break; }
      var a=r.data||[];
      for(var i=0;i<a.length;i++){ var v=a[i][col]; if(v===null||v===undefined||v==="") continue; if(!uniq[v]){ uniq[v]=1; out.push(v);} }
      if(a.length<page) break; off+=page; if(off>200000){ log("[Warn] distinct "+col+" abortado."); break; }
    }
    setOptionsWithTodos(sel, out);
  }
  async function refreshFilterOptions(startISO, endISO, unidade){
    var tasks=[];
    if(schema.turno)     tasks.push(loadDistinct(schema.turno, selTurno, startISO, endISO, unidade));
    if(schema.canal)     tasks.push(loadDistinct(schema.canal, selCanal, startISO, endISO, unidade));
    if(schema.pagamento) tasks.push(loadDistinct(schema.pagamento, selPagto, startISO, endISO, unidade));
    await Promise.all(tasks);
  }

  // ===== KPI + Gráficos =====
  function deltaCalc(cur, prev){ var pct=(prev>0)?((cur-prev)/prev*100):0; var arrow=pct>0?"▲":(pct<0?"▼":"•"); var klass=pct>0?"up":(pct<0?"down":""); return {pct,arrow,klass}; }
  function deltaMiniHTML(cur, prev){ var d=deltaCalc(cur, prev); return `<span class="miniDelta ${d.klass}">${d.arrow} ${d.pct.toFixed(1)}%</span>`; }
  function deltaDetailHTML(cur, prev, isMoney){ var d=deltaCalc(cur, prev); var prevFmt=isMoney?fmtBRL(prev):fmtInt(prev); var klass=d.klass?`delta ${d.klass}`:"delta"; return `<span class="${klass}"><span class="pct">${d.arrow} ${d.pct.toFixed(1)}%</span> <span class="muted">vs ant. • ant: ${prevFmt}</span></span>`; }
  function updateKPI(rows, rowsAnt){
    var ped=sum(rows,"pedidos"), fat=sum(rows,"fat"), des=sum(rows,"des"), fre=sum(rows,"fre");
    var pedA=sum(rowsAnt,"pedidos"), fatA=sum(rowsAnt,"fat"), desA=sum(rowsAnt,"des"), freA=sum(rowsAnt,"fre");
    var fatExibe=(modo.value==="liq")?(fat-fre):fat, fatAExibe=(modo.value==="liq")?(fatA-freA):fatA;
    document.getElementById("k_ped").innerHTML = fmtInt(ped)+" "+deltaMiniHTML(ped,pedA);
    document.getElementById("k_fat").innerHTML = fmtBRL(fatExibe)+" "+deltaMiniHTML(fatExibe,fatAExibe);
    document.getElementById("k_des").innerHTML = fmtBRL(des)+" "+deltaMiniHTML(des,desA);
    document.getElementById("k_fre").innerHTML = fmtBRL(fre)+" "+deltaMiniHTML(fre,freA);
    document.getElementById("k_ped_delta").innerHTML = deltaDetailHTML(ped,pedA,false);
    document.getElementById("k_fat_delta").innerHTML = deltaDetailHTML(fatExibe,fatAExibe,true);
    document.getElementById("k_des_delta").innerHTML = deltaDetailHTML(des,desA,true);
    document.getElementById("k_fre_delta").innerHTML = deltaDetailHTML(fre,freA,true);
  }

  function groupByDia(rows){
    var useLiq=(modo.value==="liq"); var m={}; rows.forEach(function(r){ var d=r.dia; if(!m[d]) m[d]=0; var val=Number(r.fat||0)-(useLiq?Number(r.fre||0):0); m[d]+=val; });
    var days=Object.keys(m).sort(); return {labels:days, values:days.map(function(d){return m[d];})};
  }
  function groupByDOW(rows){
    var useLiq=(modo.value==="liq"); var m=[0,0,0,0,0,0,0];
    rows.forEach(function(r){ var d=new Date(r.dia+"T00:00:00Z").getUTCDay(); var val=Number(r.fat||0)-(useLiq?Number(r.fre||0):0); m[d]+=val; });
    return {labels:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], values:m};
  }
  function drawCharts(rows){
    if(drawing) return; drawing=true;
    var l=groupByDia(rows), b=groupByDOW(rows);
    if(chartLine){ chartLine.destroy(); chartLine=null; } if(chartBar){ chartBar.destroy(); chartBar=null; }
    requestAnimationFrame(function(){
      var ctxL=document.getElementById("cLine").getContext("2d");
      chartLine=new window.Chart(ctxL,{type:"line",data:{labels:l.labels,datasets:[{label:"Receita diária",data:l.values}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
      var ctxB=document.getElementById("cBar").getContext("2d");
      chartBar=new window.Chart(ctxB,{type:"bar",data:{labels:b.labels,datasets:[{label:"Totais por dia da semana",data:b.values}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
      drawing=false;
    });
  }

  // ===== Filtro DOW (cliente) =====
  function mapDOWSelectionToList(){ var v=selDOW.value||"todos"; if(v==="todos") return [0,1,2,3,4,5,6]; if(v==="uteis") return [1,2,3,4,5]; if(v==="fds") return [6,0]; return [Number(v)]; }
  function applyDOWFilter(rows){ var keep={}; mapDOWSelectionToList().forEach(function(d){keep[d]=1;}); var out=[]; for(var j=0;j<rows.length;j++){ var dow=new Date(rows[j].dia+"T00:00:00Z").getUTCDay(); if(keep[dow]) out.push(rows[j]); } return out; }

  // ===== Datas =====
  function clampDateWithinBounds(d){ if(!d) return null; if(!dataMinISO||!dataMaxISO) return d; var min=new Date(dataMinISO+"T00:00:00Z"), max=new Date(dataMaxISO+"T00:00:00Z"); if(d<min) return min; if(d>max) return max; return d; }
  function validateInputsOrWarn(){
    if(!dataMinISO||!dataMaxISO) return true;
    var ps=getDateFromInput(dini), pe=getDateFromInput(dfim);
    if(ps&&pe){
      var s=clampDateWithinBounds(ps), e=clampDateWithinBounds(pe);
      if(s.getTime()!==ps.getTime()) log("[Aviso] 'De' ajustado para "+toISO(s));
      if(e.getTime()!==pe.getTime()) log("[Aviso] 'Até' ajustado para "+toISO(e));
      if(s>e){ log("[Erro] Intervalo inválido: 'De' > 'Até'."); return false; }
      setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
    }
    return true;
  }

  // ===== Fluxo principal =====
  async function recarregar(){
    const myRun=++runId;
    try{
      if(!dataMaxISO||!dataMinISO){ await refreshBounds(selUni.value||"Todas"); if(!dataMaxISO||!dataMinISO){ elPeriodo.textContent="Período: —"; log("[Info] Sem limites de data; abortando."); return; } }
      if(!validateInputsOrWarn()) return;

      // Determina datas (se PR selecionado, já terá preenchido os inputs)
      var ps=getDateFromInput(dini), pe=getDateFromInput(dfim), s,e;
      if(ps&&pe){ s=clampDateWithinBounds(ps); e=clampDateWithinBounds(pe); }
      else{
        e=new Date(dataMaxISO+"T00:00:00Z"); s=addDays(e,-29);
        var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate;
        setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
      }

      var startISO=toISO(s), endISO=toISO(e);
      var daysLen=Math.max(1, Math.round((e-s)/(24*3600*1000))+1);
      var prevEnd=addDays(s,-1), prevStart=addDays(prevEnd,-(daysLen-1));
      var prevStartISO=toISO(prevStart), prevEndISO=toISO(prevEnd);

      elPeriodo.textContent="Período: "+startISO+" → "+endISO+" (âncora: último no banco = "+dataMaxISO+")";
      var uniVal=selUni.value||"Todas";
      log("[Query] "+TABLE+" | "+startISO+" → "+endISO+" | UNI="+uniVal);

      var cur=await fetchPaged(startISO,endISO,uniVal==="Todas"?null:uniVal); if(myRun!==runId) return;
      var ant=await fetchPaged(prevStartISO,prevEndISO,uniVal==="Todas"?null:uniVal); if(myRun!==runId) return;

      var curF=applyDOWFilter(cur), antF=applyDOWFilter(ant);
      log("[OK] Linhas atual: "+cur.length.toLocaleString("pt-BR")+" → DOW: "+curF.length.toLocaleString("pt-BR"));
      log("[OK] Linhas anterior: "+ant.length.toLocaleString("pt-BR")+" → DOW: "+antF.length.toLocaleString("pt-BR"));

      updateKPI(curF,antF); drawCharts(curF);
    }catch(e){ if(myRun!==runId) return; console.error(e); log("[ERRO] "+(e.message||String(e))); }
  }
  var recarregarDebounced = debounce(recarregar,120);

  async function boot(){
    log("[Boot] v17.2-MV-paged-fix3 — layout ordenado + PR dropdown + setas inline");
    var opts=await fetchUnidades(); selUni.innerHTML=""; opts.forEach(function(u){ var o=document.createElement("option"); o.value=u; o.textContent=u; selUni.appendChild(o); }); selUni.value="Todas";

    await refreshBounds("Todas"); await inspectSchema("Todas");

    // datas padrão (PR 30 ancorado no último dia do banco)
    if(dataMaxISO&&dataMinISO){
      var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-29);
      var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate;
      setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
    }

    if(dataMaxISO&&dataMinISO){ await refreshFilterOptions(dini.value,dfim.value,selUni.value); }
    recarregar();
  }

  // ===== Eventos =====
  // PR dropdown: ao alterar, preenche as datas ancoradas no último dia do banco
  prapido.addEventListener("change", async function(){
    if(!prapido.value){ return; }
    if(!dataMaxISO||!dataMinISO){ await refreshBounds(selUni.value||"Todas"); if(!dataMaxISO) return; }
    var d=Number(prapido.value);
    var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e, -(d-1));
    var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate;
    setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
    // atualizar opções dependentes do período
    if(schema.turno || schema.canal || schema.pagamento){ await refreshFilterOptions(dini.value, dfim.value, selUni.value); }
    recarregarDebounced();
  });

  // Alterou datas manualmente -> PR fica “—”
  [dini, dfim].forEach(function(el){
    el.addEventListener("change", async function(){
      if(!validateInputsOrWarn()) return;
      prapido.value="";
      if(schema.turno || schema.canal || schema.pagamento){ await refreshFilterOptions(dini.value, dfim.value, selUni.value); }
      recarregarDebounced();
    });
  });

  selUni.addEventListener("change", async function(){
    await refreshBounds(selUni.value||"Todas"); await inspectSchema(selUni.value||"Todas");
    // reset para padrão desta unidade (respeitando PR atual, se houver)
    var d = Number(prapido.value||30);
    if(dataMaxISO&&dataMinISO){
      var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e, -(d-1));
      var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate;
      setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
      await refreshFilterOptions(dini.value, dfim.value, selUni.value);
    }
    recarregarDebounced();
  });

  ;[modo, selDOW, selTurno, selCanal, selPagto, selCanc].forEach(function(el){
    if(!el) return;
    el.addEventListener("change", function(){ recarregarDebounced(); });
  });

  document.getElementById("limpar").addEventListener("click", async function(){
    selUni.value="Todas"; prapido.value="30"; selDOW.value="todos";
    if(schema.turno) selTurno.value="todos"; if(schema.canal) selCanal.value="todos"; if(schema.pagamento) selPagto.value="todos"; if(schema.cancelado) selCanc.value="todos";
    modo.value="bruto";
    await refreshBounds("Todas");
    if(dataMaxISO&&dataMinISO){
      var e=new Date(dataMaxISO+"T00:00:00Z"), s=addDays(e,-29);
      var minDate=new Date(dataMinISO+"T00:00:00Z"); if(s<minDate) s=minDate;
      setDateInput(dini,toISO(s)); setDateInput(dfim,toISO(e));
      await refreshFilterOptions(dini.value, dfim.value, selUni.value);
    }
    recarregarDebounced();
  });

  // Start
  boot();
})();
</script>
</body>
</html>
