<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v17.2-MV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--card:#fff;--line:#e5e7eb}
    body{margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1060px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 2px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .title{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:22px;font-weight:700;margin-top:4px}
    .kpi .delta{font-size:12px;color:var(--muted);margin-top:2px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    select,input,button{font:inherit}
    select,input[type="date"]{border:1px solid var(--line);border-radius:8px;padding:8px;background:#fff}
    .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ghost{background:#fff}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chips .chip{border:1px solid var(--line);background:#fff;padding:6px 8px;border-radius:999px;cursor:pointer;font-size:12px}
    .chips .chip.active{background:#111827;color:#fff;border-color:#111827}
    canvas{max-height:340px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    @media (max-width:980px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid4{grid-template-columns:1fr}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js (gráficos estáveis) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted" id="src">Fonte: public.vendas_kpi_daily_v2</div>
        <div class="muted" id="periodo">Período: —</div>
      </div>
      <div class="muted">Build v17.2-MV (estável)</div>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <div>
          <label>Unidade</label>
          <select id="f_unidade"><option>Todas</option></select>
        </div>
        <div>
          <label>Período rápido (dias)</label>
          <div class="chips" id="chips_dias">
            <div class="chip" data-d="7">7</div>
            <div class="chip" data-d="15">15</div>
            <div class="chip active" data-d="30">30</div>
            <div class="chip" data-d="90">90</div>
            <div class="chip" data-d="180">180</div>
            <div class="chip" data-d="360">360</div>
          </div>
        </div>
        <div>
          <label>De (yyyy-mm-dd)</label>
          <input id="f_de" type="date" />
        </div>
        <div>
          <label>Até (yyyy-mm-dd)</label>
          <input id="f_ate" type="date" />
        </div>
        <div>
          <label>Modo de Faturamento</label>
          <div class="chips" id="chips_modo">
            <div class="chip active" data-m="bruto">Total (bruto)</div>
            <div class="chip" data-m="liquido">Líquido (Total − Entrega)</div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" id="btn_aplicar">Aplicar</button>
          <button class="btn ghost" id="btn_limpar">Limpar</button>
          <button class="btn primary" id="btn_reload">Recarregar</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid4" style="margin-top:12px">
      <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">…</div><div class="delta" id="d_ped">—</div></div>
      <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">…</div><div class="delta" id="d_fat">—</div></div>
      <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">…</div><div class="delta" id="d_des">—</div></div>
      <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">…</div><div class="delta" id="d_fre">—</div></div>
    </div>

    <!-- Gráficos -->
    <div class="card" style="margin-top:12px">
      <div class="title">Receita diária (R$)</div>
      <canvas id="chart_daily"></canvas>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title">Totais por dia da semana (R$)</div>
      <canvas id="chart_weekday"></canvas>
    </div>

    <!-- Logs -->
    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

  <script>
  // ====== CONFIG (use as suas credenciais) ======
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const SRC_TABLE     = "vendas_kpi_daily_v2";

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ====== UI helpers ======
  const $ = (id)=>document.getElementById(id);
  const elLog = $("log");
  function log(msg){ elLog.textContent += "\\n" + msg; }
  function clearLog(){ elLog.textContent = "Iniciando…"; }
  const fmtBRL = (n)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = (n)=> new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const toISO  = (d)=> d.toISOString().slice(0,10);
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  // ====== Estado filtros ======
  const state = {
    unidade: "Todas",
    diasRapidos: 30,
    de: null, ate: null,
    modo: "bruto",
  };

  // ====== Chart.js refs (para destruir antes de redesenhar) ======
  let chartDaily = null, chartWeek = null;

  // ====== Datas do período e anterior ======
  function computeRanges(){
    let de, ate;
    if($("f_de").value && $("f_ate").value){
      de = new Date($("f_de").value+"T00:00:00");
      ate= new Date($("f_ate").value+"T00:00:00");
    }else{
      ate = new Date(); // hoje
      de  = addDays(ate, - (state.diasRapidos-1) );
    }
    const lenDays = Math.round((ate - de)/86400000)+1;
    const antAte  = addDays(de, -1);
    const antDe   = addDays(antAte, -(lenDays-1));
    $("periodo").textContent = `Período: ${toISO(de)} → ${toISO(ate)}`;
    return { de, ate, antDe, antAte };
  }

  // ====== Paginação Genérica ======
  async function fetchPaged(buildQuery){
    const page=2000; let off=0, all=[];
    for(;;){
      let q = buildQuery().range(off, off+page-1);
      const { data, error } = await q;
      if(error) throw error;
      all = all.concat(data||[]);
      if(!data || data.length<page) break;
      off += page;
    }
    return all;
  }

  // ====== Carregar Unidades (dedupe robusto) ======
  async function loadUnits(){
    const { de, ate } = computeRanges();
    // Pega unidades do período largo (360d) para garantir lista completa
    const wideDe = addDays(ate, -359);
    const rows = await fetchPaged(()=> {
      let q = supa.from(SRC_TABLE)
        .select("unidade")
        .gte("dia", toISO(wideDe))
        .lte("dia", toISO(ate));
      return q;
    });
    const set = new Set();
    for(const r of rows){ if(r.unidade) set.add(r.unidade); }
    const list = Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    const sel = $("f_unidade");
    sel.innerHTML = `<option>Todas</option>` + list.map(u=>`<option>${u}</option>`).join("");
    // Seleciona a que estiver no estado (se existir)
    if(state.unidade!=="Todas" && list.includes(state.unidade)) sel.value = state.unidade;
  }

  // ====== Buscar dados (atual e anterior) ======
  async function fetchRangeData(de, ate, unidade){
    return await fetchPaged(()=> {
      let q = supa.from(SRC_TABLE)
        .select("dia,unidade,pedidos,fat,des,fre")
        .gte("dia", toISO(de))
        .lte("dia", toISO(ate))
        .order("dia", { ascending:true });
      if(unidade && unidade!=="Todas") q = q.eq("unidade", unidade);
      return q;
    });
  }

  // ====== Agregações ======
  function sumKPIs(rows, modo){
    let ped=0, fat=0, des=0, fre=0;
    for(const r of rows){
      ped += Number(r.pedidos)||0;
      fat += Number(r.fat)||0;
      des += Number(r.des)||0;
      fre += Number(r.fre)||0;
    }
    const fatShow = (modo==="liquido") ? (fat - fre) : fat;
    return { ped, fatShow, des, fre };
  }

  // ====== Desenhar gráficos ======
  function drawCharts(rows, modo){
    // dataset diário
    const byDate = new Map();
    for(const r of rows){
      const d = r.dia; // 'YYYY-MM-DD'
      const key = d;
      const val = (modo==="liquido") ? (Number(r.fat||0)-Number(r.fre||0)) : Number(r.fat||0);
      byDate.set(key, (byDate.get(key)||0) + val);
    }
    const dates = Array.from(byDate.keys()).sort();
    const dataDaily = dates.map(d => byDate.get(d));

    // por dia da semana
    const wdNames = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
    const wd = [0,0,0,0,0,0,0];
    for(const d of dates){
      const jsd = new Date(d+"T00:00:00");
      const w = jsd.getDay();
      wd[w] += byDate.get(d);
    }

    // Destroy antes (evita gráficos “infinitos”)
    if(chartDaily){ chartDaily.destroy(); chartDaily=null; }
    if(chartWeek){ chartWeek.destroy(); chartWeek=null; }

    // Line
    const ctx1 = document.getElementById("chart_daily");
    chartDaily = new Chart(ctx1, {
      type:"line",
      data:{ labels:dates, datasets:[{ label:"Receita diária", data:dataDaily, tension:.25 }]},
      options:{ responsive:true, maintainAspectRatio:false,
        scales:{ y:{ ticks:{ callback:v=>fmtBRL(v) } } },
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmtBRL(c.parsed.y) } } }
      }
    });

    // Bar por dia da semana
    const ctx2 = document.getElementById("chart_weekday");
    chartWeek = new Chart(ctx2, {
      type:"bar",
      data:{ labels:wdNames, datasets:[{ label:"Total por dia da semana", data:wd }]},
      options:{ responsive:true, maintainAspectRatio:false,
        scales:{ y:{ ticks:{ callback:v=>fmtBRL(v) } } },
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmtBRL(c.parsed.y) } } }
      }
    });
  }

  // ====== KPIs + gráficos (atual/ant) ======
  async function recarregar(){
    clearLog();
    log("[Boot] v17.2-MV — fonte fixa vendas_kpi_daily_v2; gráficos estáveis; paginação 2k");
    const { de, ate, antDe, antAte } = computeRanges();

    // Unidades (uma vez por período amplo)
    await loadUnits();

    log(`[Query] ${SRC_TABLE} | ${toISO(de)} → ${toISO(ate)} | UNI=${state.unidade} | modo=${state.modo}`);
    const atual = await fetchRangeData(de, ate, state.unidade);
    log(`[OK] Linhas (atual): ${atual.length.toLocaleString("pt-BR")}`);

    // Período anterior do mesmo tamanho
    log(`[Query] anterior: ${toISO(antDe)} → ${toISO(antAte)}`);
    const anterior = await fetchRangeData(antDe, antAte, state.unidade);
    log(`[OK] Linhas (ant): ${anterior.length.toLocaleString("pt-BR")}`);

    // KPIs
    const K1 = sumKPIs(atual, state.modo);
    const K0 = sumKPIs(anterior, state.modo);
    const pct = (a,b)=> (b===0?0:((a-b)/b*100));
    $("k_ped").textContent = fmtInt(K1.ped);
    $("k_fat").textContent = fmtBRL(K1.fatShow);
    $("k_des").textContent = fmtBRL(K1.des);
    $("k_fre").textContent = fmtBRL(K1.fre);
    $("d_ped").textContent = `${pct(K1.ped, K0.ped).toFixed(1)}% vs ant. • ant: ${fmtInt(K0.ped)}`;
    $("d_fat").textContent = `${pct(K1.fatShow, K0.fatShow).toFixed(1)}% vs ant. • ant: ${fmtBRL(K0.fatShow)}`;
    $("d_des").textContent = `${pct(K1.des, K0.des).toFixed(1)}% vs ant. • ant: ${fmtBRL(K0.des)}`;
    $("d_fre").textContent = `${pct(K1.fre, K0.fre).toFixed(1)}% vs ant. • ant: ${fmtBRL(K0.fre)}`;

    // Gráficos (diário e por dia da semana)
    drawCharts(atual, state.modo);

    log("[OK] KPIs e gráficos atualizados.");
  }

  // ====== UI events ======
  function wire(){
    // chips dias
    for(const el of document.querySelectorAll("#chips_dias .chip")){
      el.onclick = ()=> {
        for(const x of document.querySelectorAll("#chips_dias .chip")) x.classList.remove("active");
        el.classList.add("active");
        state.diasRapidos = Number(el.dataset.d)||30;
        // limpar datas manuais
        $("f_de").value = ""; $("f_ate").value="";
        recarregar();
      }
    }
    // chips modo
    for(const el of document.querySelectorAll("#chips_modo .chip")){
      el.onclick = ()=> {
        for(const x of document.querySelectorAll("#chips_modo .chip")) x.classList.remove("active");
        el.classList.add("active");
        state.modo = el.dataset.m;
        recarregar();
      }
    }
    $("f_unidade").onchange = ()=> {
      state.unidade = $("f_unidade").value || "Todas";
      recarregar();
    };
    $("btn_aplicar").onclick = ()=> {
      // se datas preenchidas, ignora rápido
      recarregar();
    };
    $("btn_limpar").onclick = ()=> {
      state.unidade="Todas"; $("f_unidade").value="Todas";
      state.diasRapidos=30;
      $("f_de").value=""; $("f_ate").value="";
      // modo permanece como está
      // reset chips dias
      for(const x of document.querySelectorAll("#chips_dias .chip")) x.classList.remove("active");
      document.querySelector('#chips_dias .chip[data-d="30"]').classList.add("active");
      recarregar();
    };
    $("btn_reload").onclick = recarregar;
  }

  // ====== Boot ======
  (async function boot(){
    wire();
    await recarregar();
  })();

  </script>
</body>
</html>
