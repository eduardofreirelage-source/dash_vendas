<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Vendas — Supabase (v16.3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;background:#f6f7fb;color:#0f172a;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .wrap{max-width:1050px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 4px}
    .muted{color:#6b7280;font-size:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,button{font:inherit;border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;background:#fff}
    button{cursor:pointer}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #d1d5db;background:#fff}
    .pill.active{background:#111827;color:#fff;border-color:#111827}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .title{font-size:12px;color:#6b7280}
    .val{font-size:22px;font-weight:700;margin-top:4px}
    pre{background:#0b1020;color:#d1e7ff;border:1px solid #1f2937;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    code{background:#eef2ff;padding:0 4px;border-radius:4px}
    .charts{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px">
      <div>
        <h1>Dashboard Vendas — Supabase</h1>
        <div class="muted">Build <b>v16.3</b> • fonte: <code id="fonte">public.vendas_kpi_daily</code></div>
        <div class="muted">URL: <code>uahmcfzerofhzjvlzrqc.supabase.co</code></div>
      </div>
      <div class="muted" id="periodo">Período: —</div>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="gap:12px">
        <div>
          <div class="title">Unidade</div>
          <select id="f_unidade">
            <option value="Todas">Todas</option>
          </select>
        </div>

        <div>
          <div class="title">Período rápido</div>
          <div class="row">
            <button class="pill" data-dias="7">7</button>
            <button class="pill" data-dias="15">15</button>
            <button class="pill active" data-dias="30">30</button>
            <button class="pill" data-dias="90">90</button>
            <button class="pill" data-dias="180">180</button>
            <button class="pill" data-dias="360">360</button>
          </div>
        </div>

        <div>
          <div class="title">Período entre datas</div>
          <div class="row">
            <input id="d_ini" placeholder="dd/mm/aaaa" size="11" />
            <input id="d_fim" placeholder="dd/mm/aaaa" size="11" />
            <button id="b_aplicar" class="pill">Aplicar</button>
          </div>
          <div class="muted">Se preencher as datas, o período rápido é ignorado.</div>
        </div>

        <div class="actions" style="margin-left:auto">
          <button id="b_recarregar">Recarregar</button>
          <button id="b_limpar" title="Volta unidade=Todas e período rápido=30d">Limpar filtros</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid">
      <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="muted" id="k_ped_vs">—</div></div>
      <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="muted" id="k_fat_vs">—</div></div>
      <div class="card"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="muted" id="k_des_vs">—</div></div>
      <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="muted" id="k_fre_vs">—</div></div>
    </div>

    <!-- Gráficos -->
    <div class="charts">
      <div class="card">
        <div class="title">Receita diária (R$)</div>
        <div id="c1_wrap"><canvas id="c1" height="120"></canvas></div>
      </div>
      <div class="card">
        <div class="title">Totais por dia da semana (R$)</div>
        <div id="c2_wrap"><canvas id="c2" height="120"></canvas></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">Status / Logs</div>
      <pre id="log">Iniciando…</pre>
    </div>
  </div>

  <script>
    // ====== CREDENCIAIS ======
    const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

    // ====== UI helpers ======
    const elLog = document.getElementById("log");
    const elPeriodo = document.getElementById("periodo");
    const elUni = document.getElementById("f_unidade");
    const pills = Array.from(document.querySelectorAll(".pill[data-dias]"));
    const dIni = document.getElementById("d_ini");
    const dFim = document.getElementById("d_fim");
    const bAplicar = document.getElementById("b_aplicar");
    const bRecarregar = document.getElementById("b_recarregar");
    const bLimpar = document.getElementById("b_limpar");

    function log(m){ elLog.textContent += "\n" + m; }
    function fmtBRL(n){ return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0); }
    function fmtInt(n){ return new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0)); }
    function toISO(d){ return d.toISOString().slice(0,10); }
    function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
    function parseDMY(s){
      if(!s) return null;
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2])-1, yy = Number(m[3]);
      const d = new Date(yy, mm, dd);
      if(d.getFullYear()!==yy || d.getMonth()!==mm || d.getDate()!==dd) return null;
      return d;
    }
    function pctDiff(cur, prev){
      if(!isFinite(cur) || !isFinite(prev) || prev===0) return "—";
      const p = ((cur - prev) / prev) * 100;
      const sign = p>0 ? "+" : "";
      return `${sign}${p.toFixed(1)}% vs ant.`;
    }
    function toNum(x){ const n = Number(x); return isFinite(n) ? n : 0; }

    // ====== Supabase client ======
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ====== Fonte fixa (evita regressão e duplicidade) ======
    const TABLE = "vendas_kpi_daily";

    // ====== Estado ======
    let daysQuick = 30;        // padrão
    let userStart = null;      // datas manuais (Date)
    let userEnd = null;

    // ====== Unidades (distinct da tabela fixa) ======
    async function loadUnidades(){
      const seen = new Set();
      const r = await supa.from(TABLE).select("unidade").neq("unidade","").limit(1000);
      if(r.error){ log("[Boot] erro ao carregar unidades: "+r.error.message); return; }
      elUni.innerHTML = `<option value="Todas">Todas</option>`;
      (r.data||[]).forEach(x=>{
        if(x.unidade && !seen.has(x.unidade)){ seen.add(x.unidade); elUni.insertAdjacentHTML("beforeend", `<option value="${x.unidade}">${x.unidade}</option>`); }
      });
      log(`[Boot] v16.3 — fonte fixa public.${TABLE} • unidades carregadas: ${seen.size}`);
    }

    // ====== Intervalos ======
    function getInterval(){
      let start, end;
      if(userStart && userEnd){
        start = new Date(userStart); end = new Date(userEnd);
        if(start > end){ const tmp = start; start = end; end = tmp; }
      }else{
        end = new Date(); end.setHours(0,0,0,0);
        start = addDays(end, -(daysQuick-1));
      }
      return { start, end };
    }
    function getPrevInterval(curStart, curEnd){
      const days = Math.round((curEnd - curStart)/86400000) + 1;
      const prevEnd = addDays(curStart, -1);
      const prevStart = addDays(prevEnd, -(days-1));
      return { prevStart, prevEnd, days };
    }

    // ====== Paginação ======
    async function fetchPaged(table, sel, filters, pageSize=2000){
      let acc=[], from=0, to=pageSize-1;
      for(;;){
        let q = supa.from(table).select(sel).range(from, to);
        for(const f of filters){ q = q[f.op](f.col, f.val); }
        const r = await q;
        if(r.error) throw r.error;
        const arr = r.data || [];
        acc = acc.concat(arr);
        if(arr.length < pageSize) break;
        from += pageSize; to += pageSize;
      }
      return acc;
    }

    // ====== KPIs/Gráficos ======
    let chart1 = null, chart2 = null;
    function resetCanvas(idWrap, id){
      const wrap = document.getElementById(idWrap);
      wrap.innerHTML = `<canvas id="${id}" height="120"></canvas>`;
      return document.getElementById(id);
    }
    function drawCharts(rows){
      const byDay = {};
      rows.forEach(r=>{
        const d = r.dia; // DATE no servidor
        byDay[d] = (byDay[d]||0) + toNum(r.fat);
      });
      const labels = Object.keys(byDay).sort();
      const data1  = labels.map(d=>byDay[d]);

      const c1El = resetCanvas("c1_wrap","c1");
      if(chart1) { chart1.destroy(); chart1 = null; }
      chart1 = new Chart(c1El.getContext("2d"), {
        type:"line",
        data:{ labels, datasets:[{label:"Faturamento diário", data:data1}]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{maxRotation:0}}}}
      });

      const semana = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];
      const byDow = Array(7).fill(0);
      rows.forEach(r=>{
        const d = new Date(r.dia+"T00:00:00Z");
        const dow = d.getUTCDay();
        byDow[dow] += toNum(r.fat);
      });

      const c2El = resetCanvas("c2_wrap","c2");
      if(chart2) { chart2.destroy(); chart2 = null; }
      chart2 = new Chart(c2El.getContext("2d"), {
        type:"bar",
        data:{ labels: semana, datasets:[{label:"Total por dia da semana", data:byDow}]},
        options:{ responsive:true, maintainAspectRatio:false }
      });
    }
    function sumKPIs(rows){
      let ped=0,fat=0,des=0,fre=0;
      for(const r of rows){
        ped += toNum(r.pedidos);
        fat += toNum(r.fat);
        des += toNum(r.des);
        fre += toNum(r.fre);
      }
      return { ped, fat, des, fre };
    }
    function applyKPIs(cur, prev){
      document.getElementById("k_ped").textContent = fmtInt(cur.ped);
      document.getElementById("k_fat").textContent = fmtBRL(cur.fat);
      document.getElementById("k_des").textContent = fmtBRL(cur.des);
      document.getElementById("k_fre").textContent = fmtBRL(cur.fre);
      document.getElementById("k_ped_vs").textContent = pctDiff(cur.ped, prev.ped);
      document.getElementById("k_fat_vs").textContent = pctDiff(cur.fat, prev.fat);
      document.getElementById("k_des_vs").textContent = pctDiff(cur.des, prev.des);
      document.getElementById("k_fre_vs").textContent = pctDiff(cur.fre, prev.fre);
    }

    async function go(){
      try{
        const { start, end } = getInterval();
        document.getElementById("periodo").textContent = `Período: ${toISO(start)} → ${toISO(end)}`;
        log(`[Query] public.${TABLE} | ${toISO(start)} → ${toISO(end)} | UNI=${elUni.value}`);

        const baseFilters = [
          {op:"gte", col:"dia", val: toISO(start)},
          {op:"lte", col:"dia", val: toISO(end)}
        ];
        if(elUni.value !== "Todas"){
          baseFilters.push({op:"eq", col:"unidade", val: elUni.value});
        }

        const sel = "dia,unidade,pedidos,fat,des,fre";

        const rowsCur = await fetchPaged(TABLE, sel, baseFilters, 2000);

        const { prevStart, prevEnd, days } = getPrevInterval(start, end);
        log(`[Info] Dias na janela: ${days}`);
        const prevFilters = [
          {op:"gte", col:"dia", val: toISO(prevStart)},
          {op:"lte", col:"dia", val: toISO(prevEnd)}
        ];
        if(elUni.value !== "Todas"){
          prevFilters.push({op:"eq", col:"unidade", val: elUni.value});
        }
        const rowsPrev = await fetchPaged(TABLE, sel, prevFilters, 2000);

        const curK = sumKPIs(rowsCur);
        const prevK = sumKPIs(rowsPrev);
        applyKPIs(curK, prevK);
        drawCharts(rowsCur);

        log(`[OK] Carregadas ${rowsCur.length.toLocaleString("pt-BR")} linhas (atual).`);
      }catch(e){
        console.error(e);
        log(`[ERRO] ${e.message||String(e)}`);
      }
    }

    // ====== Eventos ======
    pills.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        pills.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        daysQuick = Number(btn.dataset.dias);
        userStart = userEnd = null;
        dIni.value = ""; dFim.value = "";
        go();
      });
    });
    document.getElementById("b_aplicar").addEventListener("click", ()=>{
      const p1 = parseDMY(dIni.value.trim());
      const p2 = parseDMY(dFim.value.trim());
      if(!p1 || !p2){ alert("Preencha as duas datas no formato dd/mm/aaaa."); return; }
      userStart = p1; userEnd = p2;
      pills.forEach(b=>b.classList.remove("active"));
      go();
    });
    elUni.addEventListener("change", go);
    document.getElementById("b_recarregar").addEventListener("click", go);
    document.getElementById("b_limpar").addEventListener("click", ()=>{
      elUni.value = "Todas";
      daysQuick = 30;
      userStart = userEnd = null;
      dIni.value = ""; dFim.value = "";
      pills.forEach(b=>b.classList.remove("active"));
      const def = pills.find(b=>b.dataset.dias==="30");
      if(def) def.classList.add("active");
      go();
    });

    // ====== Boot ======
    (async function boot(){
      log("[Boot] v16.3 — fonte fixa vendas_kpi_daily (evita duplicidade >30d)");
      await loadUnidades();
      go();
    })();
  </script>
</body>
</html>
