<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Maestro Food</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect rx="18" width="100" height="100" fill="%232563eb"/><text x="50" y="60" font-size="52" text-anchor="middle" fill="white" font-family="Arial, Helvetica, sans-serif">MF</text></svg>' />
<style>
:root{--bg:#f6f7fb;--fg:#0f172a;--muted:#6b7280;--card:#fff;--brd:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#dc2626}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
.wrap{max-width:1200px;margin:24px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 2px}
.muted{color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
.topbar{display:flex;gap:8px;align-items:center}
button,select,input{font:inherit;padding:8px 10px;border:1px solid var(--brd);border-radius:10px;background:#fff}
button{cursor:pointer} button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.card{background:var(--card);border:1px solid var(--brd);border-radius:16px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
.grid{display:grid;gap:12px}
.grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.kpi .title{font-size:12px;color:var(--muted)} .kpi .val{font-weight:700;font-size:22px;margin-top:6px}
.kpi .delta{font-size:12px;margin-top:6px} .up{color:var(--good)} .down{color:var(--bad)}
.chartbox{position:relative;height:300px}
details.filter{border:1px solid var(--brd);border-radius:12px;background:#fff}
details.filter>summary{list-style:none;padding:12px 14px;cursor:pointer;font-weight:600;display:flex;justify-content:space-between}
details.filter[open]>summary{border-bottom:1px solid var(--brd)}
details.filter .body{padding:12px 14px}
.filters{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3}
.lbl{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden}
.pill button{border:0;padding:6px 10px;background:#fff} .pill .active{background:var(--accent);color:#fff}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.badge{font-size:12px;color:var(--muted)}
@media(max-width:920px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))}.filters{grid-template-columns:repeat(6,1fr)}}
@media(max-width:560px){.grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}.filters{grid-template-columns:repeat(4,1fr)}}
.gate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,#0b1020,#111827);z-index:9999}
.gate .box{width:360px;max-width:92vw;background:#fff;border:1px solid var(--brd);border-radius:14px;padding:18px}
.tabs{display:flex;border:1px solid var(--brd);border-radius:999px;overflow:hidden;margin-bottom:10px}
.tabs button{flex:1;border:0;background:#fff;padding:8px 10px}
.tabs .active{background:var(--accent);color:#fff}
.field{display:flex;flex-direction:column;margin-top:8px}.field label{font-size:12px;color:var(--muted);margin-bottom:4px}
.error{color:#b91c1c;font-size:12px;min-height:16px;margin-top:6px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<div class="wrap" id="app" style="display:none">
  <div class="toolbar">
    <div>
      <h1>Maestro Food</h1>
      <div class="muted" id="periodo">Período: —</div>
    </div>
    <div class="topbar">
      <span class="muted" id="who"></span>
      <button id="btnLogout">Sair</button>
    </div>
  </div>

  <details class="filter" open>
    <summary>FILTROS <span class="muted">|</span> <span id="btnClear" class="muted" style="cursor:pointer">Limpar</span></summary>
    <div class="body">
      <div class="filters">
        <div class="col-6"><label class="lbl">Unidade</label><select id="f_unidade"></select></div>
        <div class="col-6"><label class="lbl">Nome da loja (Top 10)</label><select id="f_loja"></select></div>

        <div class="col-3"><label class="lbl">De</label><input type="date" id="f_de"/></div>
        <div class="col-3"><label class="lbl">Até</label><input type="date" id="f_ate"/></div>
        <div class="col-3"><label class="lbl">Período rápido</label>
          <select id="f_pr"><option value="7">Últimos 7</option><option value="15">Últimos 15</option><option value="30" selected>Últimos 30</option><option value="90">Últimos 90</option><option value="180">Últimos 180</option></select>
        </div>
        <div class="col-3"><label class="lbl">Turno</label>
          <select id="f_turno"><option value="">Todos</option><option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option></select>
        </div>

        <div class="col-4"><label class="lbl">Canal de venda</label><select id="f_canal"><option value="">Todos</option></select></div>
        <div class="col-4"><label class="lbl">Pagamento</label><select id="f_pagamento"><option value="">Todos</option></select></div>
        <div class="col-4"><label class="lbl">Está cancelado?</label>
          <select id="f_cancelado"><option value="">Todos</option><option value="Não" selected>Não</option><option value="Sim">Sim</option></select>
        </div>

        <div class="col-12 card" style="border-style:dashed">
          <b>Admin</b> — Importar CSV (<i>Pasta2.csv</i>) • o intervalo do arquivo é limpo antes de inserir <span class="badge" id="importBadge"></span>
          <div class="row" style="margin-top:6px">
            <input type="file" id="csvfile" accept=".csv"/>
            <button id="btnImport">Importar CSV</button>
            <span class="muted" id="impMsg"></span>
          </div>
          <div class="hint">Limpo apenas o intervalo de datas do arquivo, insiro com deduplicação por chave (dia+unidade+loja+hora+pagamento+canal+Total+Entrega+Desconto).</div>
        </div>
      </div>
    </div>
  </details>

  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div><div class="delta" id="d_ped">—</div></div>
    <div class="card kpi"><div class="title">Ticket Médio</div><div class="val" id="k_tkm">—</div><div class="delta" id="d_tkm">—</div></div>
    <div class="card kpi"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div><div class="delta" id="d_fat">—</div></div>
    <div class="card kpi"><div class="title">Faturamento Médio (dia)</div><div class="val" id="k_fmd">—</div><div class="delta" id="d_fmd">—</div></div>
  </div>
  <div class="grid cols-4" style="margin-top:12px">
    <div class="card kpi"><div class="title">Incentivos</div><div class="val" id="k_des">—</div><div class="delta" id="d_des">—</div></div>
    <div class="card kpi"><div class="title">Incentivos %</div><div class="val" id="k_desp">—</div><div class="delta" id="d_desp">—</div></div>
    <div class="card kpi"><div class="title">Frete</div><div class="val" id="k_fre">—</div><div class="delta" id="d_fre">—</div></div>
    <div class="card kpi"><div class="title">Frete Médio</div><div class="val" id="k_frem">—</div><div class="delta" id="d_frem">—</div></div>
  </div>
  <div class="grid cols-2" style="margin-top:12px">
    <div class="card kpi"><div class="title">Faturamento Líquido</div><div class="val" id="k_fatl">—</div><div class="delta" id="d_fatl">—</div></div>
    <div class="card kpi"><div class="title">Faturamento Líquido %</div><div class="val" id="k_fatlp">—</div><div class="delta" id="d_fatlp">—</div></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="title">Receita diária</div>
      <div class="pill" data-target="lineMode">
        <button data-val="total" class="active">Total</button><button data-val="media">Média (7d)</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="cLine"></canvas></div>
    <div class="muted" style="font-size:11px;margin-top:4px">A sombra representa o período anterior.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="title">Receita por dia da semana</div>
      <div class="pill" data-target="dowMode">
        <button data-val="total" class="active">Total</button><button data-val="media">Média</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="cDowFat"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="title">Pedidos por dia da semana</div>
      <div class="pill" data-target="dowPedMode">
        <button data-val="total" class="active">Total</button><button data-val="media">Média</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="cDowPed"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="title">Receita por hora</div>
      <div class="pill" data-target="hourMode">
        <button data-val="total" class="active">Total</button><button data-val="media">Média</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="cHour"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="title">Receita por mês</div>
      <div class="pill" data-target="monMode">
        <button data-val="total" class="active">Total</button><button data-val="media">Média</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="cMonth"></canvas></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <div class="title">Top 10 Lojas</div>
      <div class="pill" data-target="topMode">
        <button data-val="total" class="active">Total</button><button data-val="media">Média</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="cTop"></canvas></div>
  </div>
</div>

<!-- Gate (auth) -->
<div class="gate" id="gate">
  <div class="box">
    <h3 style="margin:0 0 8px">Acesso</h3>
    <div class="tabs">
      <button id="tabLogin" class="active">Entrar</button>
      <button id="tabSignup">Criar conta</button>
    </div>
    <div class="field"><label>E-mail</label><input id="authEmail" type="email" autocomplete="email"></div>
    <div class="field"><label>Senha</label><input id="authPass" type="password" autocomplete="current-password"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnForgot" class="ghost">Esqueci a senha</button>
      <button id="btnSignup" style="display:none">Criar conta</button>
      <button id="btnLogin" class="primary">Entrar</button>
    </div>
    <div class="error" id="authErr"></div>
  </div>
</div>

<script>
(function(){
  // === Config ===
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";

  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{persistSession:true, autoRefreshToken:true} });

  // === Helpers ===
  const toISO = d => (d && !isNaN(d.getTime())) ? d.toISOString().slice(0,10) : null;
  const parseISO = s => new Date(s+"T00:00:00Z");
  const addDays = (d,k)=>{ const t=new Date(d); t.setUTCDate(t.getUTCDate()+k); return t; };
  const fmtBRL = n => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n)||0);
  const fmtInt = n => new Intl.NumberFormat("pt-BR",{maximumFractionDigits:0}).format(Math.round(Number(n)||0));
  const br2num = s => { if(s==null) return 0; let t=(""+s).trim().replace(/\./g,"").replace(",","."); let v=parseFloat(t); return isNaN(v)?0:v; };

  // === Colunas variáveis (case) ===
  const COLS = { loja:null, canal:null };
  const esc = name => `"${name}"`; // para usar no select

  async function detectColumns(){
    // tenta "Nome da loja", depois "Nome da Loja"
    let ok=null;
    for (const c of ["Nome da loja","Nome da Loja"]) {
      const r = await supa.from(TABLE).select(`${esc(c)}`).limit(1);
      if (!r.error) { ok=c; break; }
    }
    COLS.loja = ok || "Nome da Loja"; // fallback
    // idem para Canal de venda
    ok=null;
    for (const c of ["Canal de venda","Canal de Venda"]) {
      const r = await supa.from(TABLE).select(`${esc(c)}`).limit(1);
      if (!r.error) { ok=c; break; }
    }
    COLS.canal = ok || "Canal de venda";
  }

  // === Auth ===
  const gate=document.getElementById("gate"), app=document.getElementById("app"), who=document.getElementById("who"),
        authEmail=document.getElementById("authEmail"), authPass=document.getElementById("authPass"),
        btnLogin=document.getElementById("btnLogin"), btnSignup=document.getElementById("btnSignup"),
        btnForgot=document.getElementById("btnForgot"), authErr=document.getElementById("authErr"), btnLogout=document.getElementById("btnLogout");

  function showGate(){ gate.style.display="flex"; app.style.display="none"; }
  function hideGate(){ gate.style.display="none"; app.style.display="block"; }
  document.getElementById("tabLogin").onclick = ()=>{ btnLogin.style.display="inline-block"; btnSignup.style.display="none"; authErr.textContent=""; };
  document.getElementById("tabSignup").onclick= ()=>{ btnSignup.style.display="inline-block"; btnLogin.style.display="none"; authErr.textContent=""; };

  btnLogin.onclick = async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const {error}=await supa.auth.signInWithPassword({email,password:pass});
    if(error){ authErr.textContent=error.message; return; }
    afterLogin();
  };
  btnSignup.onclick = async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim(), pass=authPass.value||"";
    if(!email||!pass){ authErr.textContent="Informe e-mail e senha."; return; }
    const {error}=await supa.auth.signUp({email,password:pass});
    authErr.textContent = error ? error.message : "Conta criada. Verifique seu e-mail.";
  };
  btnForgot.onclick = async ()=>{
    authErr.textContent="";
    const email=(authEmail.value||"").trim();
    if(!email){ authErr.textContent="Informe seu e-mail para receber o link."; return; }
    const {error}=await supa.auth.resetPasswordForEmail(email,{redirectTo:location.href});
    authErr.textContent = error ? error.message : "Enviamos um link de redefinição.";
  };
  btnLogout.onclick = async ()=>{ await supa.auth.signOut(); showGate(); };

  async function afterLogin(){
    const {data:{user}} = await supa.auth.getUser();
    who.textContent = user?.email || "";
    hideGate();
    boot();
  }
  supa.auth.onAuthStateChange((_e, s)=>{ if(s) afterLogin(); else showGate(); });

  // === Filtros ===
  const periodoTxt=document.getElementById("periodo");
  const f_unidade=document.getElementById("f_unidade"), f_loja=document.getElementById("f_loja"),
        f_de=document.getElementById("f_de"), f_ate=document.getElementById("f_ate"), f_pr=document.getElementById("f_pr"),
        f_turno=document.getElementById("f_turno"), f_canal=document.getElementById("f_canal"),
        f_pagamento=document.getElementById("f_pagamento"), f_cancelado=document.getElementById("f_cancelado");

  document.getElementById("btnClear").onclick = ()=>{
    f_unidade.value=""; f_loja.value=""; f_turno.value=""; f_canal.value=""; f_pagamento.value=""; f_cancelado.value="Não";
    const end=maxISO?parseISO(maxISO):new Date(), start=addDays(end,-29);
    f_de.value=toISO(start); f_ate.value=toISO(end); f_pr.value="30"; reload();
  };
  [f_unidade,f_loja,f_de,f_ate,f_pr,f_turno,f_canal,f_pagamento,f_cancelado].forEach(el=> el.onchange=()=>reload());

  // === Import CSV ===
  const btnImport=document.getElementById("btnImport"), csvfile=document.getElementById("csvfile"),
        impMsg=document.getElementById("impMsg"), importBadge=document.getElementById("importBadge");

  btnImport.onclick = ()=>{
    const f = csvfile.files?.[0]; if(!f){ impMsg.textContent="Selecione o arquivo Pasta2.csv"; return; }
    impMsg.textContent="Lendo arquivo…";
    Papa.parse(f,{
      header:true, skipEmptyLines:true, delimiter:";", encoding:"UTF-8",
      complete: async res=>{
        try{
          const rows=res?.data||[];
          const need=["unidade","Nome da loja","Data da venda","Pagamento","Está cancelado","Total"];
          const cols=Object.keys(rows[0]||{});
          const ok = need.every(n=>cols.includes(n));
          if(!ok){ impMsg.textContent="Nada para importar (colunas do arquivo não foram reconhecidas)."; return; }

          // Converte → schema
          const out=[]; let minD=null, maxD=null; const seen=new Set();
          for(const r of rows){
            const dt=(r["Data da venda"]||"").trim();
            const m=dt.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/); if(!m) continue;
            const dia=`${m[3]}-${m[2]}-${m[1]}`, hora=parseInt(m[4],10);

            const unidade=(r["unidade"]||"").trim();
            const loja=(r["Nome da loja"]||"").trim();
            const canal=(r["Canal de venda"]||"").trim();
            const pagamento=(r["Pagamento"]||"").trim();
            const cancRaw=(r["Está cancelado"]||"").toString().trim().toUpperCase();
            const cancelado=(cancRaw==="S"||cancRaw==="SIM"||cancRaw==="TRUE"||cancRaw==="1")?"Sim":"Não";
            const fat=br2num(r["Total"]), fre=br2num(r["Entrega"]), des=br2num(r["Desconto"]);
            const turno=(r["Turno"]||"").trim() || (hora>=6&&hora<12?"Manhã":hora<18?"Tarde":hora<23?"Noite":"Madrugada");

            const partner=(r["Número do pedido no parceiro"]||"").trim();
            const key=[dia,unidade,loja,hora,pagamento,canal,fat,fre,des,partner].join("|");
            if(seen.has(key)) continue; seen.add(key);

            // objetos com nomes dinâmicos:
            const row={
              dia,unidade,pedidos:1,fat,des,fre,turno,pagamento,cancelado,hora,
              [COLS.loja]: loja,
              [COLS.canal]: canal
            };
            out.push(row);
            if(!minD||dia<minD) minD=dia; if(!maxD||dia>maxD) maxD=dia;
          }
          if(out.length===0){ impMsg.textContent="Nada para importar (após deduplicação)."; return; }

          impMsg.textContent=`Limpando ${minD} → ${maxD}…`;
          await supa.from(TABLE).delete().gte("dia",minD).lte("dia",maxD);

          impMsg.textContent=`Inserindo ${out.length.toLocaleString("pt-BR")}…`;
          const chunk=1000; let done=0;
          for(let i=0;i<out.length;i+=chunk){
            const slice=out.slice(i,i+chunk);
            const ins=await supa.from(TABLE).insert(slice);
            if(ins.error){ impMsg.textContent="Erro ao inserir: "+ins.error.message; return; }
            done+=slice.length; importBadge.textContent = `${Math.round(done/out.length*100)}%`;
          }
          importBadge.textContent="Importado."; impMsg.textContent="Concluído.";
          await loadLimits(); await reload();
        }catch(e){ impMsg.textContent="Erro: "+(e?.message||e); }
      },
      error: err=>{ impMsg.textContent="Erro ao ler CSV: "+(err?.message||err); }
    });
  };

  // === Carregamento / consultas ===
  let minISO=null, maxISO=null;
  let chartLine=null, chartDowFat=null, chartDowPed=null, chartHour=null, chartMonth=null, chartTop=null;
  let lineMode="total", dowMode="total", dowPedMode="total", hourMode="total", monMode="total", topMode="total";

  document.querySelectorAll(".pill").forEach(p=>{
    p.querySelectorAll("button").forEach(btn=>{
      btn.onclick=()=>{ p.querySelectorAll("button").forEach(b=>b.classList.remove("active")); btn.classList.add("active");
        const t=p.dataset.target,v=btn.dataset.val;
        if(t==="lineMode") lineMode=v; else if(t==="dowMode") dowMode=v; else if(t==="dowPedMode") dowPedMode=v;
        else if(t==="hourMode") hourMode=v; else if(t==="monMode") monMode=v; else if(t==="topMode") topMode=v;
        reload();
      };
    });
  });

  async function loadLimits(){
    // limites
    const min=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const max=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO=min.data?.[0]?.dia || toISO(new Date());
    maxISO=max.data?.[0]?.dia || toISO(new Date());

    // unidades
    const uni=await supa.from(TABLE).select("unidade").order("unidade",{ascending:true}).limit(10000);
    const uniqU=Array.from(new Set((uni.data||[]).map(r=>(r.unidade||"").trim()).filter(Boolean)));
    f_unidade.innerHTML = `<option value="">Todas</option>`+uniqU.map(u=>`<option>${u}</option>`).join("");

    // canais/pagamentos
    const cp=await supa.from(TABLE).select(`${esc(COLS.canal)},pagamento`).limit(50000);
    const uniqC=Array.from(new Set((cp.data||[]).map(r=>(r[COLS.canal]||"").trim()).filter(Boolean))).sort();
    const uniqP=Array.from(new Set((cp.data||[]).map(r=>(r["pagamento"]||"").trim()).filter(Boolean))).sort();
    f_canal.innerHTML=`<option value="">Todos</option>`+uniqC.map(v=>`<option>${v}</option>`).join("");
    f_pagamento.innerHTML=`<option value="">Todos</option>`+uniqP.map(v=>`<option>${v}</option>`).join("");

    // datas padrão
    const end=parseISO(maxISO), start=addDays(end,-29);
    f_de.value=toISO(start); f_ate.value=toISO(end);
    periodoTxt.textContent=`Período: ${f_de.value} → ${f_ate.value}`;
  }

  function movingAvg(a,w){ const out=[]; let acc=0; for(let i=0;i<a.length;i++){ acc+=a[i]; if(i>=w) acc-=a[i-w]; out.push(acc/Math.min(i+1,w)); } return out; }
  function destroy(c){ try{c?.destroy?.();}catch(_){ } return null; }
  function setDelta(el,cur,prev){ const p=prev>0?(cur-prev)/prev*100:0, arrow=p>=0?"▲":"▼"; el.innerHTML=`<span class="${p>=0?"up":"down"}">${(p>=0?"+":"")}${p.toFixed(1)}% ${arrow}</span>`; }

  function groupByDay(rows, field){ const m=new Map(); rows.forEach(r=>{ const k=r.dia; m.set(k,(m.get(k)||0)+Number(r[field]||0)); }); const labels=Array.from(m.keys()).sort(); const values=labels.map(k=>m.get(k)); return {labels, values}; }
  function drawBar(id, labels, totals, counts, mode){ const show=(mode==="media"); const vals=show? totals.map((v,i)=> (counts[i]?v/counts[i]:0)) : totals.slice(); return new Chart(document.getElementById(id),{type:"bar",data:{labels,datasets:[{data:vals}]},options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}}); }

  async function reload(){
    const de=f_de.value||minISO, ate=f_ate.value||maxISO;
    periodoTxt.textContent=`Período: ${de} → ${ate}`;
    const fields=`dia,unidade,pedidos,fat,des,fre,${esc(COLS.loja)},turno,${esc(COLS.canal)},pagamento,cancelado,hora`;
    let q = supa.from(TABLE).select(fields).gte("dia",de).lte("dia",ate).order("dia",{ascending:true});
    if(f_unidade.value)   q=q.eq("unidade",f_unidade.value);
    if(f_loja.value)      q=q.eq(COLS.loja,f_loja.value);
    if(f_turno.value)     q=q.eq("turno",f_turno.value);
    if(f_canal.value)     q=q.eq(COLS.canal,f_canal.value);
    if(f_pagamento.value) q=q.eq("pagamento",f_pagamento.value);
    if(f_cancelado.value) q=q.eq("cancelado",f_cancelado.value);

    const cur=await q.limit(200000); if(cur.error){ console.error(cur.error); return; }
    const rows=cur.data||[];

    // Popular lojas (top 10) no dropdown se vazio
    if(!f_loja.options.length){
      const byL=new Map(); rows.forEach(r=>{ const k=r[COLS.loja]; byL.set(k,(byL.get(k)||0)+Number(r.fat||0)); });
      const top=Array.from(byL.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]).filter(Boolean);
      f_loja.innerHTML = `<option value="">Todas</option>` + top.map(v=>`<option>${v}</option>`).join("");
    }

    // período anterior
    const d0=parseISO(de), d1=parseISO(ate), len=Math.max(1,Math.round((d1-d0)/(24*3600*1000))+1);
    const prevEnd=addDays(d0,-1), prevStart=addDays(prevEnd,-(len-1));
    let q2 = supa.from(TABLE).select(fields).gte("dia",toISO(prevStart)).lte("dia",toISO(prevEnd));
    if(f_unidade.value)   q2=q2.eq("unidade",f_unidade.value);
    if(f_loja.value)      q2=q2.eq(COLS.loja,f_loja.value);
    if(f_turno.value)     q2=q2.eq("turno",f_turno.value);
    if(f_canal.value)     q2=q2.eq(COLS.canal,f_canal.value);
    if(f_pagamento.value) q2=q2.eq("pagamento",f_pagamento.value);
    if(f_cancelado.value) q2=q2.eq("cancelado",f_cancelado.value);
    const ant=await q2.limit(200000); const rowsA=ant.data||[];

    // KPIs
    const sum=(a,k)=>a.reduce((s,r)=>s+Number(r[k]||0),0);
    const ped=sum(rows,"pedidos"), pedA=sum(rowsA,"pedidos");
    const fat=sum(rows,"fat"), fatA=sum(rowsA,"fat");
    const des=sum(rows,"des"), desA=sum(rowsA,"des");
    const fre=sum(rows,"fre"), freA=sum(rowsA,"fre");
    const dias=new Set(rows.map(r=>r.dia)).size||1, diasA=new Set(rowsA.map(r=>r.dia)).size||1;
    const tkm= ped>0? fat/ped:0, tkmA= pedA>0? fatA/pedA:0;
    const fmd= fat/dias, fmdA= fatA/diasA;
    const fatL=fat-des-fre-0.12*fat, fatLA=fatA-desA-freA-0.12*fatA;
    const desP=fat>0?(des/fat*100):0, desPA=fatA>0?(desA/fatA*100):0;
    const freM= ped>0? fre/ped:0, freMA= pedA>0? freA/pedA:0;
    const fatLP=fat>0?(fatL/fat*100):0, fatLPA=fatA>0?(fatLA/fatA*100):0;

    k_ped.textContent=fmtInt(ped); setDelta(d_ped,ped,pedA);
    k_tkm.textContent=fmtBRL(tkm); setDelta(d_tkm,tkm,tkmA);
    k_fat.textContent=fmtBRL(fat); setDelta(d_fat,fat,fatA);
    k_fmd.textContent=fmtBRL(fmd); setDelta(d_fmd,fmd,fmdA);
    k_des.textContent=fmtBRL(des); setDelta(d_des,des,desA);
    k_desp.textContent=desP.toFixed(1)+"%"; setDelta(d_desp,desP,desPA);
    k_fre.textContent=fmtBRL(fre); setDelta(d_fre,fre,freA);
    k_frem.textContent=fmtBRL(freM); setDelta(d_frem,freM,freMA);
    k_fatl.textContent=fmtBRL(fatL); setDelta(d_fatl,fatL,fatLA);
    k_fatlp.textContent=fatLP.toFixed(1)+"%"; setDelta(d_fatlp,fatLP,fatLPA);

    // Gráfico linha
    chartLine=destroy(chartLine);
    const by=groupByDay(rows,"fat"), byA=groupByDay(rowsA,"fat");
    const main=(lineMode==="media")? movingAvg(by.values,7): by.values;
    chartLine=new Chart(document.getElementById("cLine"),{type:"line",
      data:{labels:by.labels,datasets:[
        {data:byA.values,fill:true,borderWidth:0,backgroundColor:"rgba(2,132,199,.14)",pointRadius:0,tension:.2},
        {data:main,borderWidth:2,pointRadius:0,tension:.2}
      ]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // DOW fat/ped
    function groupDow(a,field){
      const lbl=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"], total=[0,0,0,0,0,0,0], counts=[0,0,0,0,0,0,0];
      const ds=Array.from(new Set(a.map(r=>r.dia))); ds.forEach(d=>counts[parseISO(d).getUTCDay()]++);
      a.forEach(r=>{ total[parseISO(r.dia).getUTCDay()]+=Number(r[field]||0); });
      return {labels:lbl, totals:total, counts};
    }
    chartDowFat=destroy(chartDowFat); const dowF=groupDow(rows,"fat"); chartDowFat=drawBar("cDowFat",dowF.labels,dowF.totals,dowF.counts,dowMode);
    chartDowPed=destroy(chartDowPed); const dowP=groupDow(rows,"pedidos"); chartDowPed=drawBar("cDowPed",dowP.labels,dowP.totals,dowP.counts,dowPedMode);

    // Hora
    chartHour=destroy(chartHour);
    const m=Array(24).fill(0), cnt=Array(24).fill(0), daysByHour=Array(24).fill(0).map(()=>new Set());
    rows.forEach(r=>{ if(r.hora==null) return; const h=+r.hora; if(h<0||h>23) return; m[h]+=Number(r.fat||0); daysByHour[h].add(r.dia); });
    const tDays=new Set(rows.map(r=>r.dia)).size||1; const L=[],T=[],C=[];
    for(let h=0;h<24;h++){ const act=daysByHour[h].size; if(act>=Math.ceil(tDays*0.5)&&m[h]>0){ L.push(String(h).padStart(2,"0")+":00"); T.push(m[h]); C.push(act);} }
    chartHour=drawBar("cHour",L,T,C,hourMode);

    // Mês
    chartMonth=destroy(chartMonth);
    const mm=new Map(), dd=new Map(); rows.forEach(r=>{ const ym=r.dia.slice(0,7); mm.set(ym,(mm.get(ym)||0)+Number(r.fat||0)); if(!dd.has(ym)) dd.set(ym,new Set()); dd.get(ym).add(r.dia); });
    const lab=Array.from(mm.keys()).sort(), tot=lab.map(k=>mm.get(k)), cts=lab.map(k=>dd.get(k).size);
    chartMonth=drawBar("cMonth",lab,tot,cts,monMode);

    // Top lojas
    chartTop=destroy(chartTop);
    const byL=new Map(); rows.forEach(r=>{ const k=r[COLS.loja]; byL.set(k,(byL.get(k)||0)+Number(r.fat||0)); });
    const top=Array.from(byL.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
    chartTop=new Chart(document.getElementById("cTop"),{type:"bar",
      data:{labels:top.map(x=>x[0]),datasets:[{data:(topMode==="media"? top.map(x=>x[1]/(dias||1)) : top.map(x=>x[1]))}]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}
    });
  }

  let maxISO=null;
  async function boot(){
    await detectColumns();            // <— resolve "Nome da loja"/"Nome da Loja" e "Canal de venda"/"Canal de Venda"
    // limites iniciais
    const min=await supa.from(TABLE).select("dia").order("dia",{ascending:true}).limit(1);
    const max=await supa.from(TABLE).select("dia").order("dia",{ascending:false}).limit(1);
    minISO=min.data?.[0]?.dia || toISO(new Date()); maxISO=max.data?.[0]?.dia || toISO(new Date());
    await loadLimits();
    await reload();
  }

  (async ()=>{ const {data:{session}}=await supa.auth.getSession(); if(session) afterLogin(); else showGate(); })();

})();
</script>
</body>
</html>
