<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Dashboard • Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) para layout rápido -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .card { @apply bg-white/80 backdrop-blur rounded-xl shadow p-4 border border-gray-100; }
    .chip { @apply inline-flex items-center px-2 py-1 rounded-md text-xs font-medium; }
    .chip-ok { @apply bg-green-100 text-green-700; }
    .chip-warn { @apply bg-yellow-100 text-yellow-700; }
    .chip-err { @apply bg-red-100 text-red-700; }
    .btn { @apply inline-flex items-center gap-2 px-3 py-2 rounded-md bg-gray-900 text-white hover:bg-gray-800 disabled:opacity-40; }
    .btn-light { @apply inline-flex items-center gap-2 px-3 py-2 rounded-md bg-gray-100 text-gray-800 hover:bg-gray-200; }
    .label { @apply text-xs text-gray-500; }
    .value { @apply text-2xl font-semibold tracking-tight; }
    .section-title { @apply text-sm font-semibold text-gray-700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kbd { @apply bg-gray-100 px-1 rounded border border-gray-300 text-xs; }
    .grid-auto { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    textarea.mono { white-space: pre; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">DASHBOARD</h1>
      <div class="flex items-center gap-2">
        <button id="btnRunTests" class="btn-light" title="Executa os testes e diagnóstico embutidos">
          🔬 Rodar testes
        </button>
        <button id="btnClear" class="btn-light" title="Limpa seleção de filtros">Limpar filtros</button>
        <span id="badgeRpc" class="chip chip-warn">RPC: —</span>
        <span id="badgeLastDay" class="chip chip-light">Último dia carregado: <span id="lastDay">—</span></span>
      </div>
    </header>

    <!-- Filtros: Data + Rápido -->
    <section class="card mb-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="section-title mb-1">Intervalo (início)</div>
          <input type="date" id="dtIni" class="w-full rounded-md border-gray-200 focus:ring-gray-900 focus:border-gray-900" />
        </div>
        <div>
          <div class="section-title mb-1">Intervalo (fim)</div>
          <input type="date" id="dtFim" class="w-full rounded-md border-gray-200 focus:ring-gray-900 focus:border-gray-900" />
        </div>
      </div>
      <div class="mt-3">
        <div class="section-title mb-1">Período rápido</div>
        <div class="flex gap-2">
          <button data-quick="7"  class="btn-light qbtn">07</button>
          <button data-quick="15" class="btn-light qbtn">15</button>
          <button data-quick="30" class="btn-light qbtn">30</button>
          <button data-quick="60" class="btn-light qbtn">60</button>
          <button data-quick="90" class="btn-light qbtn">90</button>
          <button data-quick="120" class="btn-light qbtn">120</button>
        </div>
      </div>
    </section>

    <!-- Filtros: Dimensões -->
    <section class="card mb-4">
      <div id="diagInline" class="text-sm mb-3 text-amber-700 hidden"></div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <div class="section-title mb-1">Unidade</div>
          <select id="selUnid" class="w-full rounded-md border-gray-200 focus:ring-gray-900 focus:border-gray-900">
            <option value="*">(todas)</option>
          </select>
        </div>
        <div>
          <div class="section-title mb-1">Nome da Loja</div>
          <select id="selLoja" class="w-full rounded-md border-gray-200">
            <option value="*">(todas)</option>
          </select>
        </div>
        <div>
          <div class="section-title mb-1">Turno da Venda</div>
          <select id="selTurno" class="w-full rounded-md border-gray-200">
            <option value="*">(todos)</option>
          </select>
        </div>
        <div>
          <div class="section-title mb-1">Canal de Venda</div>
          <select id="selCanal" class="w-full rounded-md border-gray-200">
            <option value="*">(todos)</option>
          </select>
        </div>
        <div>
          <div class="section-title mb-1">Tipo de Pagamento</div>
          <select id="selPag" class="w-full rounded-md border-gray-200">
            <option value="*">(todos)</option>
          </select>
        </div>
        <div>
          <div class="section-title mb-1">Cancelado</div>
          <select id="selCancel" class="w-full rounded-md border-gray-200">
            <option value="*">(todos)</option>
            <option value="Não" selected>Não</option>
            <option value="Sim">Sim</option>
          </select>
        </div>
      </div>
      <div class="mt-4 flex items-center gap-2">
        <button id="btnReload" class="btn">Atualizar</button>
        <span id="rpcStatus" class="chip chip-warn">Aguardando…</span>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid-auto mb-4">
      <div class="card">
        <div class="label">Pedidos</div>
        <div id="kpiPed" class="value">—</div>
        <div class="text-xs text-gray-500">Anterior: <span id="kpiPedPrev">—</span></div>
      </div>
      <div class="card">
        <div class="label">Ticket Médio</div>
        <div id="kpiTkt" class="value">—</div>
        <div class="text-xs text-gray-500">Anterior: <span id="kpiTktPrev">—</span></div>
      </div>
      <div class="card">
        <div class="label">Faturamento</div>
        <div id="kpiFat" class="value">—</div>
        <div class="text-xs text-gray-500">Anterior: <span id="kpiFatPrev">—</span></div>
      </div>
      <div class="card">
        <div class="label">% de Incentivos</div>
        <div id="kpiPerc" class="value">—</div>
        <div class="text-xs text-gray-500">Anterior: <span id="kpiPercPrev">—</span></div>
      </div>
      <div class="card">
        <div class="label">Frete</div>
        <div id="kpiFre" class="value">—</div>
        <div class="text-xs text-gray-500">Anterior: <span id="kpiFrePrev">—</span></div>
      </div>
      <div class="card">
        <div class="label">Pedidos Cancelados</div>
        <div id="kpiCanc" class="value">—</div>
        <div class="text-xs text-gray-500">Participação: <span id="kpiCancPart">—</span></div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="section-title">Vendas por dia da semana</div>
          <div><span id="chipDow" class="chip chip-warn">Total/Média</span></div>
        </div>
        <canvas id="chartDow" height="130"></canvas>
      </div>
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="section-title">Vendas por mês</div>
          <div><span id="chipMon" class="chip chip-warn">Total/Média</span></div>
        </div>
        <canvas id="chartMon" height="130"></canvas>
      </div>
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="section-title">Vendas por hora</div>
          <div><span id="chipHor" class="chip chip-warn">Total/Média</span></div>
        </div>
        <canvas id="chartHor" height="130"></canvas>
      </div>
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="section-title">Vendas por turno</div>
          <div><span id="chipTur" class="chip chip-warn">Total/Média</span></div>
        </div>
        <canvas id="chartTur" height="130"></canvas>
      </div>
    </section>

    <!-- Diagnóstico & Testes -->
    <section class="card">
      <h2 class="font-semibold mb-2">Diagnóstico & Testes</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="section-title mb-1">Parâmetros enviados às RPCs (payload)</div>
          <textarea id="txPayload" class="mono w-full h-64 rounded-md border-gray-200 p-2 text-sm" readonly></textarea>
        </div>
        <div>
          <div class="flex items-center gap-2 mb-2">
            <div class="section-title">Última RPC utilizada</div>
            <span id="lastRpc" class="chip chip-warn">—</span>
          </div>
          <div id="diagMsg" class="text-sm mb-3">Aguardando…</div>

          <div class="mb-2">
            <div class="section-title mb-1">Teste rápido (contagem REST)</div>
            <button id="btnQuick" class="btn-light">Quick TEST</button>
            <span id="quickBadge" class="chip chip-warn ml-2">—</span>
          </div>

          <div class="mb-2">
            <div class="section-title mb-1">Teste completo (soma local)</div>
            <button id="btnDeep" class="btn-light">Deep TEST</button>
            <span id="deepBadge" class="chip chip-warn ml-2">—</span>
          </div>

          <div class="section-title mb-1">Console</div>
          <textarea id="txConsole" class="mono w-full h-28 rounded-md border-gray-200 p-2 text-xs" readonly>-</textarea>
        </div>
      </div>

      <div class="mt-4">
        <div class="section-title mb-2">Testes por filtro (impacto esperado)</div>
        <div class="flex flex-wrap gap-2">
          <span id="tUnid" class="chip chip-warn">Unidade: sem seleção</span>
          <span id="tLoja"  class="chip chip-warn">Loja: sem seleção</span>
          <span id="tTurno" class="chip chip-warn">Turno: sem seleção</span>
          <span id="tCanal" class="chip chip-warn">Canal: sem seleção</span>
          <span id="tPag"   class="chip chip-warn">Pagamento: sem seleção</span>
        </div>
      </div>
    </section>
  </div>

<script>
/* ========= CONFIG ========= */
const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";       // <<< troque
const SUPABASE_ANON_KEY = "SEU-ANON-KEY";                     // <<< troque
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// nomes das RPCs com fallback (tenta sequência)
const RPCS = {
  kpi: ["kpi_vendas_v4", "kpi_vendas_v3", "kpi_vendas_v2", "kpi_vendas_v1", "kpi_vendas"],
  dow: ["chart_vendas_dow_v3","chart_vendas_dow_v2","chart_vendas_dow_v1"],
  mon: ["chart_vendas_month_v3","chart_vendas_month_v2","chart_vendas_month_v1","chart_vendas_mes_v3","chart_vendas_mes_v2","chart_vendas_mes_v1"],
  hor: ["chart_vendas_hour_v3","chart_vendas_hour_v2","chart_vendas_hora_v3","chart_vendas_hora_v2","chart_vendas_hora_v1"],
  tur: ["chart_vendas_turno_v3","chart_vendas_turno_v2","chart_vendas_turno_v1"]
};

// estado global mínimo
const S = {
  lastRpc: "—",
  payload: null,
  charts: {},
};

/* ========= HELPERS ========= */
const $ = (sel) => document.querySelector(sel);
const fmtMoney = (v) => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtPct   = (v) => v==null? "—" : (Number(v).toFixed(1).replace('.',',') + '%');
const todayISO = () => new Date().toISOString().slice(0,10);

function setBadge(el, kind, text) {
  el.className = "chip " + (kind==="ok"?"chip-ok": kind==="err"?"chip-err":"chip-warn");
  el.textContent = text;
}

function arrOrNull(v) {
  if (!v || v==="*") return null;
  return [v];
}

function buildPayloadFromUI() {
  const dini = $("#dtIni").value || todayISO();
  const dfim = $("#dtFim").value || todayISO();
  const p = {
    p_dini: dini,
    p_dfim: dfim,
    p_unids: arrOrNull($("#selUnid").value),
    p_lojas: arrOrNull($("#selLoja").value),
    p_turnos: arrOrNull($("#selTurno").value),
    p_canais: arrOrNull($("#selCanal").value),
    p_pags: arrOrNull($("#selPag").value),
    p_cancelado: ($("#selCancel").value==="*") ? null : $("#selCancel").value
  };
  S.payload = p;
  $("#txPayload").value = JSON.stringify(p,null,2);
  // chips “teste por filtro”
  setBadge($("#tUnid"), p.p_unids? "ok":"warn", p.p_unids? `Unidade: ${p.p_unids.join(',')}` : "Unidade: sem seleção");
  setBadge($("#tLoja"),  p.p_lojas?  "ok":"warn", p.p_lojas?  `Loja: ${p.p_lojas.join(',')}`  : "Loja: sem seleção");
  setBadge($("#tTurno"), p.p_turnos? "ok":"warn", p.p_turnos? `Turno: ${p.p_turnos.join(',')}` : "Turno: sem seleção");
  setBadge($("#tCanal"), p.p_canais? "ok":"warn", p.p_canais? `Canal: ${p.p_canais.join(',')}` : "Canal: sem seleção");
  setBadge($("#tPag"),   p.p_pags?   "ok":"warn", p.p_pags?   `Pag: ${p.p_pags.join(',')}`   : "Pagamento: sem seleção");
  return p;
}

async function callRPCWithFallback(names, payload) {
  let lastErr = null;
  for (const name of names) {
    try {
      const { data, error } = await sb.rpc(name, payload);
      if (error) { lastErr = error; continue; }
      S.lastRpc = name;
      $("#lastRpc").textContent = name;
      setBadge($("#badgeRpc"), "ok", "RPC: " + name);
      return data || [];
    } catch(err) {
      lastErr = err;
    }
  }
  setBadge($("#badgeRpc"), "err", "RPC: falhou");
  throw lastErr || new Error("Falha RPC");
}

function makeChart(id, label, labels, values) {
  if (S.charts[id]) S.charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  S.charts[id] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label, data: values }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

/* ========= DIM LISTS ========= */
async function loadDistinctInto(selectEl, column) {
  // busca direto da tabela base
  const { data, error } = await sb
    .from("vendas_xlsx")
    .select(column)
    .not(column, "is", null)
    .order(column, { ascending: true })
    .limit(2000); // defensivo
  if (error) { console.warn("dims", column, error); return; }
  const set = new Set();
  data.forEach(r => set.add(r[column]));
  const sel = $(selectEl);
  [...set].forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

/* ========= KPI + CHARTS ========= */
async function updateAll() {
  try {
    setBadge($("#rpcStatus"), "warn", "Atualizando…");
    const p = buildPayloadFromUI();

    // KPIs
    const kpi = await callRPCWithFallback(RPCS.kpi, p);
    // espera: [{ pedidos, fat, des, fre }]
    const ped = Number(kpi?.[0]?.pedidos||0);
    const fat = Number(kpi?.[0]?.fat||0);
    const des = Number(kpi?.[0]?.des||0);
    const fre = Number(kpi?.[0]?.fre||0);
    $("#kpiPed").textContent = ped.toLocaleString('pt-BR');
    $("#kpiFat").textContent = fmtMoney(fat);
    const ticket = ped ? fat / ped : 0;
    $("#kpiTkt").textContent = fmtMoney(ticket);
    const percInc = fat ? (des / fat * 100) : 0;
    $("#kpiPerc").textContent = fmtPct(percInc);
    $("#kpiFre").textContent = fmtMoney(fre);
    $("#kpiCanc").textContent = (p.p_cancelado==="Sim"? ped.toLocaleString('pt-BR') : "—");
    $("#kpiCancPart").textContent = (p.p_cancelado==="Sim" && fat? fmtPct( ped / Math.max(ped,1)*100 ) : "—");

    // DOW
    const dow = await callRPCWithFallback(RPCS.dow, p);
    makeChart("chartDow", "Total", dow.map(d=>["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][Number(d.dow)||0]), dow.map(d=>Number(d.total||0)));
    setBadge($("#chipDow"), "ok", "Total/Média");

    // MÊS
    const mon = await callRPCWithFallback(RPCS.mon, p);
    makeChart("chartMon", "Total", mon.map(d=>d.ym||""), mon.map(d=>Number(d.total||0)));
    setBadge($("#chipMon"), "ok", "Total/Média");

    // HORA
    const hor = await callRPCWithFallback(RPCS.hor, p);
    makeChart("chartHor", "Total", hor.map(d=>String(d.h).padStart(2,"0")), hor.map(d=>Number(d.total||0)));
    setBadge($("#chipHor"), "ok", "Total/Média");

    // TURNO
    const tur = await callRPCWithFallback(RPCS.tur, p);
    makeChart("chartTur", "Total", tur.map(d=>d.turno||""), tur.map(d=>Number(d.total||0)));
    setBadge($("#chipTur"), "ok", "Total/Média");

    setBadge($("#rpcStatus"), "ok", "OK");
    $("#diagMsg").textContent = "Consultas concluídas.";
  } catch (err) {
    console.error(err);
    $("#diagMsg").textContent = "ERRO: " + (err?.message||err);
    setBadge($("#rpcStatus"), "err", "Erro");
    setBadge($("#badgeRpc"), "err", "RPC: erro");
    logc("updateAll err", err);
  }
}

/* ========= TESTES ========= */
function logc(...args){ 
  const line = args.map(a => (typeof a==='string'? a : JSON.stringify(a))).join(' ');
  const ta = $("#txConsole");
  ta.value = (ta.value==="-"? "" : ta.value+"\n") + line;
}

async function quickTest() {
  try {
    const p = buildPayloadFromUI();
    // converte filtros para query REST
    let q = sb.from("vendas_xlsx").select("pedido_id", { count: "exact", head: true });
    if (p.p_dini) q = q.gte("dia", p.p_dini);
    if (p.p_dfim) q = q.lte("dia", p.p_dfim);
    if (p.p_unids) q = q.in("unidade", p.p_unids);
    if (p.p_lojas) q  = q.in("loja", p.p_lojas);
    if (p.p_turnos) q = q.in("turno", p.p_turnos);
    if (p.p_canais) q = q.in("canal", p.p_canais);
    if (p.p_pags) q   = q.in("pagamento_base", p.p_pags);
    if (p.p_cancelado!==null) q = q.eq("cancelado", p.p_cancelado);

    const { count, error } = await q;
    if (error) throw error;
    setBadge($("#quickBadge"), "ok", `Quick OK • linhas: ${count??"?"}`);
    logc("quick OK:", count);
  } catch (err) {
    setBadge($("#quickBadge"), "err", "Quick ERRO");
    logc("testQuick err", {message: err?.message||String(err)});
  }
}

async function deepTest() {
  try {
    const p = buildPayloadFromUI();

    // RPC: pega ped/fat
    const kpi = await callRPCWithFallback(RPCS.kpi, p);
    const pedR = Number(kpi?.[0]?.pedidos||0);
    const fatR = Number(kpi?.[0]?.fat||0);

    // Tabela: soma fat e conta ped
    let q = sb.from("vendas_xlsx").select("fat", { count:"exact" });
    if (p.p_dini) q = q.gte("dia", p.p_dini);
    if (p.p_dfim) q = q.lte("dia", p.p_dfim);
    if (p.p_unids) q = q.in("unidade", p.p_unids);
    if (p.p_lojas) q  = q.in("loja", p.p_lojas);
    if (p.p_turnos) q = q.in("turno", p.p_turnos);
    if (p.p_canais) q = q.in("canal", p.p_canais);
    if (p.p_pags) q   = q.in("pagamento_base", p.p_pags);
    if (p.p_cancelado!==null) q = q.eq("cancelado", p.p_cancelado);

    const { data, count, error } = await q.limit(100000); // limite defensivo
    if (error) throw error;
    const fatT = (data||[]).reduce((a,r)=> a + Number(r.fat||0), 0);

    const ok = (Math.abs(fatR - fatT) < 0.0001);
    const msg = `${ok?"Deep OK":"Deep ALERTA"} • RPC(ped:${pedR},fat:${fatR}) vs TBL(ped:${count},fat:${fatT})`;
    setBadge($("#deepBadge"), ok? "ok":"warn", msg);
    logc(msg);
  } catch (err) {
    setBadge($("#deepBadge"), "err", "Deep ERRO");
    logc("testDeep err", {message: err?.message||String(err)});
  }
}

/* ========= INIT ========= */
function setDateRange(days) {
  const df = new Date(); // hoje
  const di = new Date();
  di.setDate(df.getDate() - (Number(days)-1));
  $("#dtIni").value = di.toISOString().slice(0,10);
  $("#dtFim").value = df.toISOString().slice(0,10);
}

async function initDims() {
  // carrega listas dos filtros
  await Promise.all([
    loadDistinctInto("#selUnid", "unidade"),
    loadDistinctInto("#selLoja", "loja"),
    loadDistinctInto("#selCanal", "canal"),
    loadDistinctInto("#selTurno","turno"),
    loadDistinctInto("#selPag", "pagamento_base"),
  ]);
}

function wire() {
  document.querySelectorAll(".qbtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      setDateRange(b.dataset.quick);
      updateAll();
    });
  });
  $("#btnReload").addEventListener("click", updateAll);
  $("#btnClear").addEventListener("click", ()=>{
    document.querySelectorAll("select").forEach(s=> s.value="*");
    setDateRange(7);
    updateAll();
  });
  $("#btnQuick").addEventListener("click", quickTest);
  $("#btnDeep").addEventListener("click", deepTest);
  $("#btnRunTests").addEventListener("click", async()=>{
    await quickTest();
    await deepTest();
  });
  // muda filtros reativa
  ["selUnid","selLoja","selTurno","selCanal","selPag","selCancel","dtIni","dtFim"]
    .forEach(id=> $("#"+id).addEventListener("change", ()=> updateAll()));
}

(async function start(){
  // período padrão
  setDateRange(7);
  wire();
  await initDims();
  // último dia carregado (consulta simples)
  const { data } = await sb.from("vendas_xlsx").select("dia").order("dia", {ascending:false}).limit(1);
  $("#lastDay").textContent = data?.[0]?.dia || "—";
  // primeira atualização
  updateAll();
})();
</script>
</body>
</html>
