<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
<link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
<style>
:root{--bg:#f6f7fb;--fg:#0f172a;--muted:#667085;--card:#fff;--brd:#e5e7eb;--blue:#1a73e8;--radius:14px}
body{background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
.wrap{max-width:1100px;margin:22px auto;padding:0 16px}
h1{font-size:24px;margin:0 0 6px}
small.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--brd);border-radius:var(--radius);padding:14px;margin-top:12px}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select,button{font:inherit;border:1px solid var(--brd);border-radius:10px;padding:10px 12px;background:#fff;color:var(--fg);width:100%}
select[multiple]{height:140px}
button.primary{background:var(--blue);border-color:var(--blue);color:#fff;cursor:pointer}
.kpis{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
.kpi h3{font-size:12px;color:var(--muted);margin:0 0 8px}
.kpi b{font-size:22px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bad{color:#b91c1c}.ok{color:#16a34a}
.canvasBox{height:320px}
@media(max-width:960px){.grid.cols-4,.grid.cols-3,.grid.cols-2,.kpis{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Maestro Food</h1>
  <small id="headerInfo" class="muted">—</small>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <b>FILTROS</b>
      <button id="btnLimpar" class="primary" style="background:#eef2ff;border-color:#e5e7eb;color:#1747b7">Limpar</button>
    </div>

    <div class="grid cols-2" style="margin-top:8px">
      <div><label>Unidade</label><select id="fUnidade"><option>Todas</option></select></div>
      <div><label>Nome da loja (Top 10)</label><select id="fLoja"><option>Todos</option></select></div>
    </div>

    <div class="grid cols-4" style="margin-top:8px">
      <div><label>De</label><input id="fDini" type="date"/></div>
      <div><label>Até</label><input id="fDfim" type="date"/></div>
      <div>
        <label>Período rápido</label>
        <select id="fQuick">
          <option>Últimos 30</option>
          <option>Últimos 60</option>
          <option selected>Últimos 90</option>
          <option>Este mês</option>
          <option>Último mês</option>
          <option>Este ano</option>
        </select>
      </div>
      <div>
        <label>Turno</label>
        <select id="fTurno" multiple>
          <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
        </select>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:8px">
      <div><label>Canal de venda</label><select id="fCanal" multiple></select></div>
      <div><label>Pagamento</label><select id="fPag" multiple></select></div>
      <div><label>Está cancelado?</label>
        <select id="fCanc"><option>Todos</option><option>Não</option><option>Sim</option></select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <small id="srcInfo" class="muted">—</small>
    </div>
  </div>

  <div class="kpis" style="margin-top:12px">
    <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
    <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
    <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
    <div class="card kpi"><h3>Faturamento Médio (dia)</h3><b id="kFatDia">—</b></div>
    <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
    <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
    <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
    <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between">
      <b>Receita diária (R$)</b>
      <div class="row"><span id="dsTotal" class="ok">Total</span></div>
    </div>
    <div class="canvasBox"><canvas id="chart"></canvas></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
(function(){
  // ================= PROMPT MESTRE (invariantes) =================
  // - Nunca limitar a 1000: toda leitura é paginada até acabar (step=50k)
  // - Cada linha no banco = 1 pedido (não somar campo pedidos)
  // - KPIs: pedidos = rows.length; ticket = fat/pedidos; fat médio = fat/dias distintos
  // - "Cancelado" normalizado (Sim/Não/boolean/0/1)
  // - Gráfico: destruir antes de recriar; valores numéricos válidos; animação off

  // --------- CONFIG ---------
  const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
  const TABLE = "vendas_kpi_daily_v2_data";
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // --------- DOM ---------
  const $ = id => document.getElementById(id);
  const headerInfo = $("headerInfo"), srcInfo = $("srcInfo");
  const uni=$("fUnidade"), loja=$("fLoja"), dini=$("fDini"), dfim=$("fDfim");
  const pr=$("fQuick"), turno=$("fTurno"), canal=$("fCanal"), pag=$("fPag"), canc=$("fCanc");
  const btnLimpar=$("btnLimpar");
  const kPedidos=$("kPedidos"), kTicket=$("kTicket"), kFat=$("kFat"), kFatDia=$("kFatDia"),
        kDes=$("kDes"), kDesPct=$("kDesPct"), kFre=$("kFre"), kFatLiq=$("kFatLiq");
  const chartEl=$("chart"); let chart;

  // --------- UTILS ---------
  const fmtBRL=v=> (Number.isFinite(+v)? (+v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}):"—");
  const fmtPct=v=> (Number.isFinite(+v)? ((+v)*100).toFixed(1).replace('.',',')+'%':"—");
  const onlyDate=iso=> iso && String(iso).length>=10 ? String(iso).slice(0,10) : iso;
  const norm=s=> String(s??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
  const normCancel=v=>{const s=norm(v); if(v===true||s==='sim'||s==='s'||s==='1'||s==='true')return'Sim'; return'Não';};
  function applyQuick(){
    const end=new Date(); let start=new Date(end);
    const opt=pr.value;
    if(opt.startsWith("Últimos ")){ const n=parseInt(opt.split(' ')[1],10)||30; start.setDate(end.getDate()-(n-1)); }
    else if(opt==="Este mês"){ start=new Date(end.getFullYear(),end.getMonth(),1); }
    else if(opt==="Último mês"){ start=new Date(end.getFullYear(),end.getMonth()-1,1); const e=new Date(end.getFullYear(),end.getMonth(),0); dini.value=toISO(start); dfim.value=toISO(e); return; }
    else if(opt==="Este ano"){ start=new Date(end.getFullYear(),0,1); }
    dini.value=toISO(start); dfim.value=toISO(end);
  }
  const toISO=d=> new Date(d).toISOString().slice(0,10);
  const getSel = sel => sel.multiple ? Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean) : sel.value;

  // --------- PAGED QUERIES (SEM LIMITE) ---------
  async function fetchPaged(filters, selectCols){
    const size=50000; let from=0, out=[];
    for(;;){
      let q = supa.from(TABLE).select(selectCols).order('dia',{ascending:true}).range(from, from+size-1);
      q = q.gte('dia', filters.dini).lte('dia', filters.dfim);
      if (filters.uni && filters.uni!=='Todas') q = q.eq('unidade', filters.uni);
      if (filters.loja && filters.loja!=='Todos') q = q.eq('Nome da loja', filters.loja);
      if (filters.turnos?.length) q = q.in('turno', filters.turnos);
      if (filters.canais?.length) q = q.in('Canal de venda', filters.canais);
      if (filters.pags?.length) q = q.in('pagamento', filters.pags);
      if (filters.canc !== 'Todos') q = q.eq('cancelado', filters.canc);
      const { data, error } = await q;
      if (error){ console.error(error); break; }
      const arr = data||[];
      out.push(...arr);
      if (arr.length < size) break;
      from += size;
    }
    return out;
  }

  async function distinctPaged(col, diniISO, dfimISO){
    const size=50000; let from=0, set=new Set();
    for(;;){
      let q = supa.from(TABLE).select(col).not(col,'is',null).gte('dia',diniISO).lte('dia',dfimISO).order(col,{ascending:true}).range(from, from+size-1);
      const { data, error } = await q;
      if (error){ console.error(error); break; }
      const arr = (data||[]).map(x=>x[col]).filter(v=>v!==null && v!==undefined && v!=='');
      for(const v of arr) set.add(v);
      if ((data||[]).length < size) break;
      from += size;
    }
    return Array.from(set);
  }

  async function top10Lojas(diniISO, dfimISO){
    // pega loja + fat, pagina e soma local
    const size=50000; let from=0; const acc=new Map();
    for(;;){
      const { data, error } = await supa.from(TABLE)
        .select('"Nome da loja", fat')
        .not('Nome da loja','is',null)
        .not('fat','is',null)
        .gte('dia',diniISO).lte('dia',dfimISO)
        .range(from, from+size-1);
      if (error){ console.error(error); break; }
      for(const r of (data||[])){ const k=r["Nome da loja"]; const v=Number(r.fat)||0; acc.set(k,(acc.get(k)||0)+v); }
      if ((data||[]).length < size) break; from+=size;
    }
    return Array.from(acc.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
  }

  // --------- KPIs & CHART ---------
  function computeKPIs(rows){
    const pedidos = rows.length;
    const fat = rows.reduce((s,r)=> s + (Number(r.fat)||0), 0);
    const des = rows.reduce((s,r)=> s + (Number(r.des)||0), 0);
    const fre = rows.reduce((s,r)=> s + (Number(r.fre)||0), 0);
    const dias = new Set(rows.map(r=>r.dia)).size || 1;
    const ticket = pedidos ? (fat/pedidos) : 0;
    const fatDia = fat / dias;
    kPedidos.textContent = pedidos.toLocaleString('pt-BR');
    kTicket.textContent  = fmtBRL(ticket);
    kFat.textContent     = fmtBRL(fat);
    kFatDia.textContent  = fmtBRL(fatDia);
    kDes.textContent     = fmtBRL(des);
    kDesPct.textContent  = fmtPct(fat? des/fat : 0);
    kFre.textContent     = fmtBRL(fre);
    kFatLiq.textContent  = fmtBRL(fat - des - fre);
  }

  function drawChart(rows){
    // agrupa fat por dia
    const byDay = new Map();
    for(const r of rows){
      const d = r.dia;
      const v = Number(r.fat)||0;
      byDay.set(d, (byDay.get(d)||0) + v);
    }
    const labels = Array.from(byDay.keys()).sort();
    const values = labels.map(d=> byDay.get(d));

    // segurança contra infinito
    const safeVals = values.map(v=> Number.isFinite(v) ? v : 0);

    if (chart) { chart.destroy(); chart = null; }
    const ctx = chartEl.getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'Receita', data: safeVals, tension: 0.2 }] },
      options: {
        responsive:true, maintainAspectRatio:false, animation:false, parsing:false,
        scales:{ y:{ beginAtZero:true } },
        plugins:{ legend:{ display:false } }
      }
    });
  }

  // --------- OPTIONS ---------
  async function buildOptions(diniISO, dfimISO){
    // Unidade
    const unidades = await distinctPaged('unidade', diniISO, dfimISO);
    uni.innerHTML = `<option>Todas</option>` + unidades.map(v=>`<option>${v}</option>`).join('');

    // Canal
    const canais = await distinctPaged('Canal de venda', diniISO, dfimISO);
    canal.innerHTML = canais.map(v=>`<option>${v}</option>`).join('');

    // Pagamento
    const pags = await distinctPaged('pagamento', diniISO, dfimISO);
    pag.innerHTML = pags.map(v=>`<option>${v}</option>`).join('');

    // Lojas Top10 por fat
    const lojas = await top10Lojas(diniISO, dfimISO);
    loja.innerHTML = `<option>Todos</option>` + lojas.map(v=>`<option>${v}</option>`).join('');
  }

  // --------- RELOAD ---------
  async function reload(){
    const diniISO = dini.value, dfimISO = dfim.value;
    const filters = {
      dini: diniISO, dfim: dfimISO,
      uni: getSel(uni), loja: getSel(loja),
      turnos: getSel(turno), canais: getSel(canal), pags: getSel(pag),
      canc: canc.value || 'Todos'
    };

    // carrega linhas paginadas
    const rows = await fetchPaged(filters, 'dia,unidade,fat,des,fre,"Nome da loja","Canal de venda",pagamento,turno,cancelado');
    const rowsNorm = rows.map(r=> ({...r, dia: onlyDate(r.dia), cancelado: normCancel(r.cancelado)}));
    computeKPIs(rowsNorm);
    drawChart(rowsNorm);

    headerInfo.textContent = `Período: ${filters.dini} → ${filters.dfim} (${rowsNorm.length.toLocaleString('pt-BR')} linhas)`;
  }

  // --------- LIMITES DO BANCO + BOOT ---------
  async function boot(){
    // limites do banco
    const a = await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
    const b = await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
    const min = (a.data&&a.data[0])? onlyDate(a.data[0].dia):null;
    const max = (b.data&&b.data[0])? onlyDate(b.data[0].dia):null;
    const cnt = await supa.from(TABLE).select('dia',{count:'exact',head:true});

    srcInfo.innerHTML = `<span class="ok">Fonte OK</span> (${min||'—'} → ${max||'—'}) · linhas: ${cnt.count?.toLocaleString('pt-BR')}`;

    // datas iniciais
    applyQuick();

    // opções de filtros (no período selecionado)
    await buildOptions(dini.value, dfim.value);

    // listeners
    pr.addEventListener('change', ()=>{ applyQuick(); reload(); });
    [uni,loja,dini,dfim,turno,canal,pag,canc].forEach(el=> el.addEventListener('change', ()=>{ reload(); }));

    btnLimpar.addEventListener('click', async ()=>{
      uni.value='Todas'; loja.value='Todos'; turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value='Todos';
      applyQuick();
      await buildOptions(dini.value, dfim.value);
      reload();
    });

    // primeira carga
    reload();
  }

  boot();
})();
</script>
</body>
</html>
