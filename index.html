<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Vendas — CFO (v2.4.1 Light — Etapa 2.1)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%233b82f6"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --accent:#335dff; --accent-100:#eef2ff; --ok:#16a34a; --err:#dc2626; --ink:#0b1220;
  }
  *{box-sizing:border-box}
  html,body{background:linear-gradient(180deg,#f7f9ff 0%,#f6f8fb 60%,#f6f8fb 100%);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1220px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  h1{font-size:24px;margin:0 0 4px;color:var(--ink)}
  .muted{color:var(--muted)}
  .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px;color:#334155}
  .status{font-size:13px}
  .btn-link{color:#334155;text-decoration:underline;cursor:pointer;font-size:13px}
  .row{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(14, 23, 38, .06);margin-top:14px}
  .label{font-size:12px;color:#475569;margin-bottom:6px}
  /* Multiselect */
  .msel{position:relative}
  .msel-btn{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;color:#111827;text-align:left;cursor:pointer}
  .msel-btn:after{content:"▾";float:right;color:#334155}
  .msel-panel{position:absolute;z-index:50;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
  .msel.open .msel-panel{display:block}
  .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
  .msel-opt{display:flex;align-items:center;gap:8px;padding:6px 6px;border-radius:8px}
  .msel-opt:hover{background:#f1f5f9}
  input[type="date"], select.msel-btn{padding:12px 12px;border-radius:12px}

  /* KPIs – cartões com energia */
  .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  .kpi{
    position:relative;border:1px solid var(--line);border-radius:14px;background:
      linear-gradient(180deg,#fff 0%,#fbfdff 100%);
    padding:14px 14px 12px 14px; overflow:hidden;
  }
  .kpi:before{
    content:""; position:absolute; inset:auto -40% -60% auto; width:240px; height:240px;
    background:radial-gradient(ellipse at center, var(--accent-100), transparent 60%);
    transform:rotate(25deg);
  }
  .kpi .t{font-size:12px;color:#475569;margin-bottom:6px;display:flex;align-items:center;gap:6px}
  .kpi .v{font-size:22px;font-weight:800;color:#0b1220}
  .kpi .p{font-size:12px;color:#64748b;margin-top:2px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;margin-left:6px}
  .delta{font-weight:700}
  .up{color:var(--ok)} .down{color:var(--err)} .flat{color:#64748b}
  .spark{height:6px;background:linear-gradient(90deg,rgba(51,93,255,.2),rgba(51,93,255,.05));border-radius:999px;margin-top:8px}
  pre{white-space:pre-wrap;background:#f8fafc;color:#111827;border-radius:10px;padding:12px;overflow:auto;border:1px solid var(--line);max-height:360px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Dashboard Vendas — CFO <span class="badge">v2.4.1 Light — Etapa 2.1</span></h1>
      <div class="muted">Filtros automáticos e período rápido ancorado no último dia do banco. KPIs com comparação clara.</div>
    </div>
    <div>
      <a id="btnClear" class="btn-link">Limpar filtros</a>
      <span id="status" class="status muted" style="margin-left:8px;">—</span>
    </div>
  </header>

  <!-- ===== FILTROS (inalterados – sem retrocesso) ===== -->
  <div class="card">
    <div class="row cols-3">
      <div>
        <label class="label">Unidade(s)</label>
        <div id="ms-unidades" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Loja(s)</label>
        <div id="ms-lojas" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Turno(s)</label>
        <div id="ms-turnos" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
    </div>

    <div class="row cols-4" style="margin-top:12px;">
      <div>
        <label class="label">Período (De)</label>
        <input id="fDe" type="date" style="width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;color:#111827"/>
      </div>
      <div>
        <label class="label">Período (Até)</label>
        <input id="fAte" type="date" style="width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;color:#111827"/>
      </div>
      <div>
        <label class="label">Período Rápido</label>
        <select id="periodo" class="msel-btn" style="border:1px solid var(--line);border-radius:12px;background:#fff;">
          <option value="7">Últimos 7 dias</option>
          <option value="15">Últimos 15 dias</option>
          <option value="30" selected>Últimos 30 dias</option>
          <option value="60">Últimos 60 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="120">Últimos 120 dias</option>
          <option value="semana">Última semana</option>
          <option value="mes">Último mês</option>
          <option value="custom">Personalizado (usar datas)</option>
        </select>
        <div class="muted" id="periodoTexto" style="margin-top:4px;font-size:12px;">—</div>
      </div>
      <div></div>
    </div>

    <div class="row cols-3" style="margin-top:12px;">
      <div>
        <label class="label">Canal(is)</label>
        <div id="ms-canais" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Pagamento(s)</label>
        <div id="ms-pags" class="msel"><button type="button" class="msel-btn">Carregando…</button><div class="msel-panel"></div></div>
      </div>
      <div>
        <label class="label">Cancelado</label>
        <div id="ms-cancel" class="msel">
          <button type="button" class="msel-btn">Não</button>
          <div class="msel-panel">
            <div class="msel-opt"><input type="checkbox" value=""  id="c_all"><label for="c_all">Todos</label></div>
            <div class="msel-opt"><input type="checkbox" value="Não" id="c_nao" checked><label for="c_nao">Não</label></div>
            <div class="msel-opt"><input type="checkbox" value="Sim" id="c_sim"><label for="c_sim">Sim</label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== KPIs (novos cálculos) ===== -->
  <div class="card" id="kpiCard" style="display:none;">
    <b style="display:flex;align-items:center;gap:8px;">KPIs (com comparação)
      <span class="pill" title="Período atual vs. período anterior do mesmo tamanho">Δ período anterior</span>
    </b>
    <div class="kpis" style="margin-top:10px;">
      <div class="kpi">
        <div class="t">Pedidos <span id="d_ped" class="delta flat pill">—</span></div>
        <div class="v" id="k_ped">—</div>
        <div class="p">Anterior: <span id="p_ped">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Ticket Médio (Total ÷ pedidos) <span id="d_tkt" class="delta flat pill">—</span></div>
        <div class="v" id="k_tkt">—</div>
        <div class="p">Anterior: <span id="p_tkt">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Faturamento (Total) <span id="d_fat" class="delta flat pill">—</span></div>
        <div class="v" id="k_fat">—</div>
        <div class="p">Anterior: <span id="p_fat">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Faturamento Médio (Total ÷ dias) <span id="d_fatmed" class="delta flat pill">—</span></div>
        <div class="v" id="k_fatmed">—</div>
        <div class="p">Anterior: <span id="p_fatmed">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Incentivos (descontos) <span id="d_des" class="delta flat pill">—</span></div>
        <div class="v" id="k_des">—</div>
        <div class="p">Anterior: <span id="p_des">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Incentivos Média (% do faturamento) <span id="d_desperc" class="delta flat pill">—</span></div>
        <div class="v" id="k_desperc">—</div>
        <div class="p">Anterior: <span id="p_desperc">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Frete (total) <span id="d_fre" class="delta flat pill">—</span></div>
        <div class="v" id="k_fre">—</div>
        <div class="p">Anterior: <span id="p_fre">—</span></div>
        <div class="spark"></div>
      </div>

      <div class="kpi">
        <div class="t">Frete Médio (por pedido) <span id="d_fremed" class="delta flat pill">—</span></div>
        <div class="v" id="k_fremed">—</div>
        <div class="p">Anterior: <span id="p_fremed">—</span></div>
        <div class="spark"></div>
      </div>
    </div>
  </div>

  <!-- ===== DEBUG ===== -->
  <div class="card">
    <b>Resumo dos filtros aplicados</b>
    <pre id="out">{ }</pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script>
/* ====== CONFIG ====== */
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const $ = (id)=>document.getElementById(id);
const setStatus = (t,kind)=>{ const el=$('status'); el.textContent=t; el.style.color = kind==='err'?'#dc2626':(kind==='ok'?'#16a34a':'#6b7280'); };

/* ====== UTIL ====== */
const money = v => (v==null||!isFinite(+v)) ? 'R$ 0,00' : ('R$ ' + (+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}));
const num   = v => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
const pct   = v => (v==null||!isFinite(+v)) ? '0,0%' : ((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
function deltaTxt(curr, prev){ if(!isFinite(prev) || +prev===0) return {txt:'(—)', cls:'flat'}; const p=((curr-prev)/prev)*100; return {txt:`${p>=0?'↑':'↓'} ${Math.abs(p).toFixed(1)}%`, cls:(p>=0?'up':'down')}; }
function setDelta(el, curr, prev){ const d=deltaTxt(curr,prev); el.textContent=d.txt; el.className='delta '+d.cls; }
const dateISO = d => d.toISOString().slice(0,10);
function addDays(iso,n){ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return dateISO(d); }

/* ====== multiselect ====== */
function MultiSelect(rootId, placeholder='Selecionar'){
  const root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
  let options=[], selected=new Set(), filtered=[];
  function render(){
    panel.innerHTML=''; const q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar…';
    q.addEventListener('input',()=>{ filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase())); draw(); });
    panel.appendChild(q); draw();
  }
  function draw(){
    const box=document.createElement('div');
    (filtered.length?filtered:options).forEach((v,i)=>{
      const id=`${rootId}-${i}`; const row=document.createElement('div'); row.className='msel-opt';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v; cb.checked=selected.has(v);
      const lb=document.createElement('label'); lb.htmlFor=id; lb.textContent=v;
      cb.addEventListener('change',()=>{ cb.checked?selected.add(v):selected.delete(v); refresh(); applyAll(); });
      row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
    });
    const olds = Array.from(panel.querySelectorAll('.msel-opt')); olds.forEach(n=>n.remove());
    panel.appendChild(box);
  }
  function refresh(){
    btn.textContent = selected.size===0 ? placeholder :
                      selected.size===options.length ? `Todos (${selected.size})` :
                      `${selected.size} selecionado(s)`;
  }
  btn.addEventListener('click', ()=> root.classList.toggle('open'));
  document.addEventListener('click', (ev)=>{ if(!root.contains(ev.target)) root.classList.remove('open'); });

  return {
    setOptions(list, pre){ options=(list||[]).filter(Boolean); filtered=options.slice(); selected=new Set(pre||[]); render(); refresh(); },
    get(){ return Array.from(selected); },
    set(vals){ selected=new Set(vals||[]); refresh(); draw(); }
  };
}

/* ====== estado/período ====== */
const ms = {
  unidades: MultiSelect('ms-unidades','Todas as unidades'),
  lojas:    MultiSelect('ms-lojas','Todas as lojas'),
  turnos:   MultiSelect('ms-turnos','Todos os turnos'),
  canais:   MultiSelect('ms-canais','Todos os canais'),
  pags:     MultiSelect('ms-pags','Todos os pagamentos'),
  cancel:   MultiSelect('ms-cancel','Todos'),
};
let firstDay='', lastDay='';
const fDe=$('fDe'), fAte=$('fAte'), periodo=$('periodo'), periodoTexto=$('periodoTexto');

function rangeQuick(){
  const md=periodo.value, max=lastDay||dateISO(new Date()); let de=max, ate=max;
  if(['7','15','30','60','90','120'].includes(md)) de=addDays(max, -(Number(md)-1));
  else if(md==='semana'){ const d=new Date(max+'T00:00:00'); const dow=(d.getDay()+6)%7; de=addDays(max,-dow); }
  else if(md==='mes'){ const d=new Date(max+'T00:00:00'); d.setDate(1); de=dateISO(d); d.setMonth(d.getMonth()+1); d.setDate(0); ate=dateISO(d); }
  else if(md==='custom'){ return null; }
  return {de,ate};
}
function labelPeriodo(de,ate){ periodoTexto.textContent=`Período: ${de} → ${ate} (âncora no último dia do banco: ${lastDay||'—'})`; }

/* Parâmetros compatíveis com os RPCs existentes (sem retroceder) */
function buildParams(de,ate){
  const canc = ms.cancel.get();
  let p_cancelado = null;
  if (canc.length===1 && (canc[0]==='Não' || canc[0]==='Sim')) p_cancelado = canc[0];
  return {
    p_dini: de, p_dfim: ate,
    p_unids: ms.unidades.get().length ? ms.unidades.get() : null,
    p_canais:ms.canais.get().length   ? ms.canais.get()   : null,
    p_pags:  ms.pags.get().length     ? ms.pags.get()     : null,
    p_loja:  null,
    p_cancelado
  };
}

/* ====== opções ====== */
async function loadOptions(){
  setStatus('Carregando…');
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }

  const [u,l,t,c,p] = await Promise.all([
    supa.from('vw_vendas_unidades').select('unidade').order('unidade'),
    supa.from('vw_vendas_lojas').select('loja').order('loja'),
    supa.from('vw_vendas_turnos').select('turno').order('turno'),
    supa.from('vw_vendas_canais').select('canal').order('canal'),
    supa.from('vw_vendas_pagamentos').select('pagamento_base').order('pagamento_base'),
  ]);
  ms.unidades.setOptions((u.data||[]).map(r=>r.unidade));
  ms.lojas.setOptions((l.data||[]).map(r=>r.loja));
  ms.turnos.setOptions((t.data||[]).map(r=>r.turno));
  ms.canais.setOptions((c.data||[]).map(r=>r.canal));
  ms.pags.setOptions((p.data||[]).map(r=>r.pagamento_base));
  ms.cancel.setOptions(['','Não','Sim'], ['Não']);

  periodo.value='30'; applyQuick();
  setStatus('Opções carregadas.','ok');
}

/* ====== KPIs ====== */
function paintKPIs(nowRows, prevRows, lenNow, lenPrev){
  // agregação básica
  const agg = (rows)=> {
    let ped=0,fat=0,des=0,fre=0;
    for(const r of (rows||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; }
    return {ped,fat,des,fre};
  };
  const N = agg(nowRows), P = agg(prevRows);

  // definições pedidas
  const tktNow    = N.ped>0 ? (N.fat / N.ped) : 0;            // Total / pedidos
  const tktPrev   = P.ped>0 ? (P.fat / P.ped) : 0;

  const fatMedNow = lenNow>0 ? (N.fat / lenNow) : 0;          // Total / dias
  const fatMedPrev= lenPrev>0 ? (P.fat / lenPrev) : 0;

  const desPercNow = N.fat>0 ? (N.des/N.fat) : 0;
  const desPercPrev= P.fat>0 ? (P.des/P.fat) : 0;

  const freMedNow = N.ped>0 ? (N.fre/N.ped) : 0;
  const freMedPrev= P.ped>0 ? (P.fre/P.ped) : 0;

  $('kpiCard').style.display='block';

  $('k_ped').textContent   = num(N.ped);
  $('k_tkt').textContent   = money(tktNow);
  $('k_fat').textContent   = money(N.fat);
  $('k_fatmed').textContent= money(fatMedNow);
  $('k_des').textContent   = money(N.des);
  $('k_desperc').textContent = pct(desPercNow);
  $('k_fre').textContent   = money(N.fre);
  $('k_fremed').textContent= money(freMedNow);

  $('p_ped').textContent   = num(P.ped);
  $('p_tkt').textContent   = money(tktPrev);
  $('p_fat').textContent   = money(P.fat);
  $('p_fatmed').textContent= money(fatMedPrev);
  $('p_des').textContent   = money(P.des);
  $('p_desperc').textContent = pct(desPercPrev);
  $('p_fre').textContent   = money(P.fre);
  $('p_fremed').textContent= money(freMedPrev);

  setDelta($('d_ped'), N.ped, P.ped);
  setDelta($('d_tkt'), tktNow, tktPrev);
  setDelta($('d_fat'), N.fat, P.fat);
  setDelta($('d_fatmed'), fatMedNow, fatMedPrev);
  setDelta($('d_des'), N.des, P.des);
  setDelta($('d_desperc'), desPercNow, desPercPrev);
  setDelta($('d_fre'), N.fre, P.fre);
  setDelta($('d_fremed'), freMedNow, freMedPrev);
}

/* ====== aplicar ====== */
function applyQuick(){
  const r=rangeQuick();
  if(!r){ fDe.disabled=false; fAte.disabled=false; if(!fDe.value) fDe.value=lastDay; if(!fAte.value) fAte.value=lastDay; labelPeriodo(fDe.value,fAte.value); applyAll(); return; }
  fDe.value=r.de; fAte.value=r.ate; fDe.disabled=true; fAte.disabled=true; labelPeriodo(r.de,r.ate); applyAll();
}
function activateCustom(){ periodo.value='custom'; fDe.disabled=false; fAte.disabled=false; labelPeriodo(fDe.value,fAte.value); applyAll(); }

async function applyAll(){
  try{
    const de = fDe.value || firstDay; const ate = fAte.value || lastDay;

    // debug filtro
    const debug = {
      periodo:{ de, ate, mode: periodo.value },
      filtros:{
        unidades: ms.unidades.get().length? ms.unidades.get(): null,
        lojas:    ms.lojas.get().length   ? ms.lojas.get()   : null,
        turnos:   ms.turnos.get().length  ? ms.turnos.get()  : null,
        canais:   ms.canais.get().length  ? ms.canais.get()  : null,
        pagamentos: ms.pags.get().length ? ms.pags.get()    : null,
        cancelado: ms.cancel.get()
      }
    };
    $('out').textContent = JSON.stringify(debug, null, 2);

    const paramsNow = buildParams(de, ate);

    // período anterior com mesmo tamanho
    const dtDe = new Date(de+'T00:00:00'); const dtAte = new Date(ate+'T00:00:00');
    const lenNow = Math.round((dtAte-dtDe)/(1000*60*60*24))+1;
    const atePrevISO = new Date(dtDe.getTime() - 24*60*60*1000);
    const dePrevISO  = new Date(atePrevISO.getTime() - (lenNow-1)*24*60*60*1000);
    const paramsPrev = buildParams(dateISO(dePrevISO), dateISO(atePrevISO));
    const lenPrev = lenNow;

    setStatus('Consultando KPIs…');
    const [now, prev] = await Promise.all([
      supa.rpc('kpi_vendas', paramsNow),
      supa.rpc('kpi_vendas', paramsPrev)
    ]);
    if(now.error) throw now.error;
    if(prev.error) throw prev.error;

    paintKPIs(now.data||[], prev.data||[], lenNow, lenPrev);
    setStatus('OK','ok');
  }catch(e){
    console.error(e);
    setStatus('Erro: '+(e.message||e),'err');
  }
}

/* ====== eventos ====== */
$('btnClear').addEventListener('click', ()=>{
  ms.unidades.set([]); ms.lojas.set([]); ms.turnos.set([]);
  ms.canais.set([]); ms.pags.set([]); ms.cancel.set(['Não']);
  periodo.value='30'; applyQuick();
});
periodo.addEventListener('change', applyQuick);
fDe.addEventListener('change', activateCustom);
fAte.addEventListener('change', activateCustom);

/* ====== boot ====== */
(async function init(){
  const dr = await supa.from('vw_vendas_daterange').select('*').limit(1);
  if(dr.error){ setStatus('Erro datas: '+dr.error.message,'err'); return; }
  if(dr.data?.length){ firstDay=dr.data[0].min_dia; lastDay=dr.data[0].max_dia; }
  await loadOptions();
})();
</script>
</body>
</html>
