<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>Dashboard Vendas</title>

    <!-- ======== COLOQUE SUAS CREDENCIAIS AQUI ======== -->
    <script>
      window.ENV = {
        // SUBSTITUA pelas suas credenciais reais da Supabase:
        // Exemplo de URL: "https://abcd1234.supabase.co"
        VITE_SUPABASE_URL: "https://SEU-PROJETO.supabase.co",
        VITE_SUPABASE_ANON_KEY: "SUA-ANON-KEY-AQUI",
      };
    </script>

    <!-- Tailwind (estilo rápido sem build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel para permitir JSX diretamente no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Supabase JS UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

    <style>
      html, body, #root { height: 100%; }
    </style>
  </head>

  <body class="bg-gray-50">
    <div id="root" class="min-h-full"></div>

    <!-- App (JSX compilado via Babel no navegador) -->
    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // ---- Helpers visuais
      const fmtInt = (v) =>
        new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(
          Math.round(Number(v) || 0)
        );
      const fmtCur = (v) =>
        new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(Number(v) || 0);

      function Card({ title, value, hint }) {
        return (
          <div className="rounded-lg bg-white shadow-sm border border-gray-200 p-5">
            <div className="text-sm text-gray-600">{title}</div>
            <div className="mt-1 text-2xl font-semibold text-gray-900 tabular-nums">
              {value}
            </div>
            {hint ? (
              <div className="mt-1 text-xs text-gray-500">{hint}</div>
            ) : null}
          </div>
        );
      }

      function App() {
        const [envOk, setEnvOk] = useState(false);
        const [status, setStatus] = useState("Verificando ambiente…");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(true);

        const [kpis, setKpis] = useState({
          pedidos: 0,
          faturamento: 0,
          descontos: 0,
          frete: 0,
          periodo: "",
        });

        // cria cliente supabase
        const supabaseClient = useMemo(() => {
          try {
            const E = window.ENV || {};
            if (!E.VITE_SUPABASE_URL || !E.VITE_SUPABASE_ANON_KEY) return null;
            return window.supabase.createClient(
              E.VITE_SUPABASE_URL,
              E.VITE_SUPABASE_ANON_KEY
            );
          } catch {
            return null;
          }
        }, []);

        useEffect(() => {
          (async () => {
            // 1) validar ENV
            if (!window.ENV?.VITE_SUPABASE_URL || !window.ENV?.VITE_SUPABASE_ANON_KEY) {
              setEnvOk(false);
              setStatus("Configure window.ENV no <head> com sua URL e ANON KEY da Supabase.");
              setError("ENV ausente");
              setLoading(false);
              return;
            }
            setEnvOk(true);
            setStatus("Conectando à Supabase…");

            if (!supabaseClient) {
              setError("Falha ao criar o cliente Supabase.");
              setLoading(false);
              return;
            }

            try {
              // 2) obter último dia e montar período (últimos 30 dias até o último dia com venda)
              const { data: last, error: e1 } = await supabaseClient
                .from("vendas_import_csv")
                .select("data_venda")
                .order("data_venda", { ascending: false })
                .limit(1);

              if (e1) throw e1;
              const lastDay = last?.[0]?.data_venda;
              if (!lastDay) {
                setStatus("Conectado, mas não achei data_venda em vendas_import_csv.");
                setLoading(false);
                return;
              }

              const end = new Date(lastDay + "T23:59:59");
              const start = new Date(end);
              start.setDate(end.getDate() - 29);
              const toISO = (d) => d.toISOString().slice(0, 10);

              setStatus(
                `Consultando KPIs de ${toISO(start)} até ${toISO(end)}…`
              );

              // 3) pegar apenas colunas necessárias e reduzir no cliente (30 dias é leve)
              //    Tabela-fonte: vendas_import_csv (você confirmou que é onde estão os dados)
              let all = [];
              const pageSize = 5000;
              for (let from = 0; ; from += pageSize) {
                const to = from + pageSize - 1;
                const { data, error: e2 } = await supabaseClient
                  .from("vendas_import_csv")
                  .select("data_venda, valor_total, desconto, entrega", { count: "exact" })
                  .gte("data_venda", toISO(start))
                  .lte("data_venda", toISO(end))
                  .order("data_venda", { ascending: true })
                  .range(from, to);

                if (e2) throw e2;
                if (!data || data.length === 0) break;
                all = all.concat(data);
                if (data.length < pageSize) break;
              }

              const pedidos = all.length;
              const faturamento = all.reduce((s, r) => s + Number(r.valor_total || 0), 0);
              const descontos = all.reduce((s, r) => s + Number(r.desconto || 0), 0);
              const frete = all.reduce((s, r) => s + Number(r.entrega || 0), 0);

              setKpis({
                pedidos,
                faturamento,
                descontos,
                frete,
                periodo: `${toISO(start)} → ${toISO(end)}`,
              });

              setStatus("Conectado e carregado com sucesso.");
              setLoading(false);
            } catch (err) {
              console.error("[Supabase] Erro:", err);
              setError(err?.message || String(err));
              setStatus("Falha ao consultar a base.");
              setLoading(false);
            }
          })();
        }, [supabaseClient]);

        return (
          <div className="max-w-5xl mx-auto p-6">
            <header className="mb-6">
              <h1 className="text-3xl font-bold text-gray-900">Dashboard Vendas — Conexão Básica</h1>
              <p className="text-sm text-gray-600 mt-1">
                Fonte: <code className="text-gray-800">public.vendas_import_csv</code> (últimos 30 dias)
              </p>
            </header>

            <div className="rounded-lg border p-4 bg-white mb-6">
              <div className="text-sm text-gray-700">
                <span className="font-medium">Status:</span>{" "}
                <span className={error ? "text-rose-700" : "text-emerald-700"}>{status}</span>
              </div>
              <div className="text-xs text-gray-500 mt-1">
                URL: <code>{window.ENV?.VITE_SUPABASE_URL || "(ENV não definido)"}</code>
              </div>
              {error ? (
                <div className="mt-2 text-sm text-rose-700">
                  Erro: <code>{error}</code>
                </div>
              ) : null}
              {kpis.periodo ? (
                <div className="mt-2 text-xs text-gray-500">
                  Período: <span className="tabular-nums">{kpis.periodo}</span>
                </div>
              ) : null}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <Card title="Pedidos" value={fmtInt(kpis.pedidos)} />
              <Card title="Faturamento" value={fmtCur(kpis.faturamento)} />
              <Card title="Incentivos" value={fmtCur(kpis.descontos)} />
              <Card title="Frete" value={fmtCur(kpis.frete)} />
            </div>

            <div className="mt-8 text-xs text-gray-500">
              <p>
                Dica: se ver “ENV ausente”, edite o <code>index.html</code> e preencha{" "}
                <code>window.ENV</code> no &lt;head&gt; com seus valores reais da Supabase.
              </p>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
