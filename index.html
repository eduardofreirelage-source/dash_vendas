<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DASHBOARD ‚Äî CFO (v3.0 ‚Äî KPIs + filtros rankeados + gr√°ficos 12x12)</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%235b0a16"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb;
      --pri:#5b0a16; /* vinho escuro */
      --ok:#10b981; --down:#ef4444; --chip:#f6eff1; --bar:#334155;
      --pri-20:rgba(91,10,22,.18); --pri-10:rgba(91,10,22,.10);
      --grey:rgba(2,6,23,.55); --grey-10:rgba(2,6,23,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1220px;margin:28px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.clear{gap:6px}

    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px;transition:max-height .3s ease}
    .sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
    .sec-title{display:flex;align-items:center;gap:10px;font-weight:700}
    .ico{width:16px;height:16px;color:#475569}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    input[type="date"], .msel-btn, .input{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    .chip{padding:10px 0;border:1px solid var(--line);border-radius:10px;background:var(--chip);cursor:pointer;text-align:center;font-weight:700}
    .chip.active{background:var(--pri);border-color:var(--pri);color:#fff}

    /* multi-select */
    .msel{position:relative}
    .msel-btn{cursor:pointer;text-align:left}
    .msel-btn:after{content:"‚ñæ";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:260px;overflow:auto;padding:8px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
    .msel-opt:hover{background:#f3f4f6}

    /* KPIs */
    .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px 14px 12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05);cursor:pointer}
    .kpi .bar{position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:14px 0 0 14px;background:var(--bar)}
    .kpi.active{outline:2px solid var(--pri)}
    .kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center}
    .kpi h4 .spacer{flex:1}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .sub{font-size:12px;color:#667085;margin-top:2px}
    .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-weight:800;font-size:13px;margin-left:12px}
    .delta svg{width:12px;height:12px}
    .delta.up{color:var(--ok);border-color:#86efac}
    .delta.down{color:#ef4444;border-color:#fecaca}
    .delta.flat{color:#64748b}

    /* GR√ÅFICOS */
    .chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
    .chart-card.big{grid-column:span 2}
    .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer;font-weight:700}
    .seg button.active{background:var(--pri);color:#fff}
    .chart-box{height:280px}
    .chart-box canvas{display:block;width:100% !important;height:100% !important;}
    .diag{font-size:12px;color:#475569;margin-left:8px}

    /* auto-colapse dos filtros */
    .collapsible{position:relative;overflow:hidden;transition:max-height .35s ease}
    .collapsed{max-height:54px}
    .collapse-hint{font-size:12px;color:#7b8794;margin-left:8px}

    @media (max-width:1024px){
      .cols-3{grid-template-columns:repeat(2,1fr)}
      .cols-2{grid-template-columns:1fr}
      .krow{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:640px){
      .cols-3{grid-template-columns:1fr}
      .krow{grid-template-columns:1fr}
      .chart-grid{grid-template-columns:1fr}
      .chart-card.big{grid-column:auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>DASHBOARD</h1>
      <div class="upload-bar">
        <button id="btnUpload" class="btn">üì§ Carregar Excel</button>
        <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
      </div>
    </div>

    <!-- Filtros de Data -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
          Filtros de Data
        </div>
        <button id="btnClear" class="btn clear">‚úñ Limpar filtros</button>
      </div>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Intervalo (in√≠cio)</div>
          <input type="date" id="fDe">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Intervalo (fim)</div>
          <input type="date" id="fAte">
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Per√≠odo r√°pido</div>
          <div class="chips">
            <button class="chip" data-q="7">07</button>
            <button class="chip" data-q="15">15</button>
            <button class="chip active" data-q="30">30</button>
            <button class="chip" data-q="60">60</button>
            <button class="chip" data-q="90">90</button>
            <button class="chip" data-q="120">120</button>
          </div>
          <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div id="filtersSec" class="section collapsible">
      <div class="sec-head">
        <div class="sec-title">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v6l-4 2v-8L3 5z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
          Filtros <span class="collapse-hint">(recolhe ap√≥s 10s sem uso)</span>
        </div>
        <div>
          <span id="status" class="muted">‚Äî</span>
          <span id="diag" class="diag"></span>
          <div id="uploadInfo" class="upload-info"></div>
        </div>
      </div>
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Unidade</div>
          <div id="ms-unids" class="msel"><button class="msel-btn">Todas as unidades</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Nome da Loja</div>
          <div id="ms-lojas" class="msel"><button class="msel-btn">Todas as lojas</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Turno da Venda</div>
          <div id="ms-turnos" class="msel"><button class="msel-btn">Todos os turnos</button><div class="msel-panel"></div></div>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:10px;">
        <div>
          <div class="muted" style="margin-bottom:6px;">Canal de Venda</div>
          <div id="ms-canais" class="msel"><button class="msel-btn">Todos os canais</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Tipo de Pagamento</div>
          <div id="ms-pags" class="msel"><button class="msel-btn">Todos os tipos</button><div class="msel-panel"></div></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Cancelado</div>
          <div id="ms-cancel" class="msel">
            <button class="msel-btn">N√£o</button>
            <div class="msel-panel">
              <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
              <div class="msel-opt"><input type="checkbox" value="N√£o" checked><label>N√£o</label></div>
              <div class="msel-opt"><input type="checkbox" value="Nao"><label>Nao</label></div>
              <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="krow">
      <div class="kpi" data-metric="pedidos"><span class="bar"></span>
        <h4><span>Pedidos</span><span class="spacer"></span><span id="d_ped" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_ped">‚Äî</div>
        <div class="sub">Anterior: <span id="p_ped">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="ticket"><span class="bar"></span>
        <h4><span>Ticket M√©dio</span><span class="spacer"></span><span id="d_tkt" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_tkt">‚Äî</div>
        <div class="sub">Anterior: <span id="p_tkt">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="fat"><span class="bar"></span>
        <h4><span>Faturamento</span><span class="spacer"></span><span id="d_fat" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_fat">‚Äî</div>
        <div class="sub">Anterior: <span id="p_fat">‚Äî</span></div>
      </div>
    </div>

    <div class="krow" style="margin-top:12px;">
      <div class="kpi" data-metric="fatmed"><span class="bar"></span>
        <h4><span>Faturamento M√©dio</span><span class="spacer"></span><span id="d_fatmed" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_fatmed">‚Äî</div>
        <div class="sub">Anterior: <span id="p_fatmed">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="des"><span class="bar"></span>
        <h4><span>Incentivos</span><span class="spacer"></span><span id="d_des" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_des">‚Äî</div>
        <div class="sub">Anterior: <span id="p_des">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="desperc"><span class="bar"></span>
        <h4><span>% de Incentivos</span><span class="spacer"></span><span id="d_desperc" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_desperc">‚Äî</div>
        <div class="sub">Anterior: <span id="p_desperc">‚Äî</span></div>
      </div>
    </div>

    <div class="krow" style="margin-top:12px;">
      <div class="kpi" data-metric="fre"><span class="bar"></span>
        <h4><span>Frete</span><span class="spacer"></span><span id="d_fre" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_fre">‚Äî</div>
        <div class="sub">Anterior: <span id="p_fre">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="fremed"><span class="bar"></span>
        <h4><span>Frete M√©dio</span><span class="spacer"></span><span id="d_fremed" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_fremed">‚Äî</div>
        <div class="sub">Anterior: <span id="p_fremed">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="canc_ped"><span class="bar"></span>
        <h4><span>Pedidos Cancelados</span><span class="spacer"></span><span id="d_canc_ped" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_canc_ped">‚Äî</div>
        <div class="sub">Participa√ß√£o: <span id="k_canc_part">‚Äî</span> (Anterior: <span id="p_canc_part">‚Äî</span>)</div>
      </div>
    </div>

    <div class="krow" style="margin-top:12px;">
      <div class="kpi" data-metric="canc_val"><span class="bar"></span>
        <h4><span>Valor de Cancelados</span><span class="spacer"></span><span id="d_canc_val" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_canc_val">‚Äî</div>
        <div class="sub">Anterior: <span id="p_canc_val">‚Äî</span></div>
      </div>
      <div class="kpi" data-metric="roi"><span class="bar"></span>
        <h4><span>ROI</span><span class="spacer"></span><span id="d_roi" class="delta flat">‚Äî</span></h4>
        <div class="val" id="k_roi">‚Äî</div>
        <div class="sub">Anterior: <span id="p_roi">‚Äî</span></div>
      </div>
      <div></div>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">Gr√°ficos</div>
        <div class="seg" id="modeSeg">
          <button class="seg-btn active" data-mode="total">Total</button>
          <button class="seg-btn" data-mode="media">M√©dia</button>
        </div>
      </div>
      <div class="chart-grid">
        <div class="chart-card big">
          <div class="chart-head">
            <div class="muted">Vendas por m√™s ‚Äî √∫ltimos 12m √ó 12m anteriores</div>
          </div>
          <div class="chart-box"><canvas id="ch_month_big"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div class="muted">Vendas por dia da semana</div>
          </div>
          <div class="chart-box"><canvas id="ch_dow"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div class="muted">Vendas por hora (oculta horas sem venda)</div>
          </div>
          <div class="chart-box"><canvas id="ch_hour"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div class="muted">Vendas por turno (Dia 10‚Äì18 / Noite 18:01‚Äì23)</div>
          </div>
          <div class="chart-box"><canvas id="ch_turno"></canvas></div>
        </div>
      </div>
      <div id="periodoLegend" class="muted" style="margin-top:6px;font-size:12px;"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <script>
  /* ===================== CONFIG ===================== */
  const SUPABASE_URL  = 'https://msmyfxgrnuusnvoqyeuo.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===================== HELPERS ===================== */
  const $ = id => document.getElementById(id);
  const setStatus=(t,k)=>{ const el=$('status'); el.textContent=t; el.style.color=(k==='err'?'#ef4444':k==='ok'?'#10b981':'#667085'); };
  const setDiag=(msg)=>{ $('diag').textContent = msg || ''; };
  const info=(msg)=>{ $('uploadInfo').textContent = msg || ''; };

  const money=v=>(v==null||isNaN(v))?'‚Äî':v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:2});
  const intf=v=>(v==null||isNaN(v))?'‚Äî':Number(v).toLocaleString('pt-BR');
  const pct=v=>(v==null||isNaN(v))?'‚Äî':(Number(v).toFixed(1).replace('.',',')+'%');
  const clamp=(v,a,b)=>Math.min(Math.max(v,a),b);
  const toISO=d=>d.toISOString().slice(0,10);

  /* ===================== GLOBAL STATE ===================== */
  let lastDia = null;           // √∫ltima data existente na base
  let range = {de:null, ate:null, days:0, prevDe:null, prevAte:null, prevDays:0};
  let globalMode = 'total';     // 'total' | 'media'
  let focusMetric = 'fat';      // m√©trica ativa (KPIs clic√°veis)
  let baseCur = [];             // linhas per√≠odo atual
  let basePrev = [];            // linhas per√≠odo anterior
  let cache24m = [];            // linhas √∫ltimos 24 meses (para gr√°fico de m√™s e ranking)

  /* ===================== MULTI-SELECT WIDGET ===================== */
  function MultiSel(rootId, placeholder){
    const root=$(rootId);
    const btn=root.querySelector('.msel-btn');
    const panel=root.querySelector('.msel-panel');
    root.addEventListener('click',(e)=>{
      root.classList.toggle('open');
      e.stopPropagation();
      touchFilters();
    });
    document.addEventListener('click',()=>root.classList.remove('open'));
    const state=new Set();
    const render=(opts)=>{
      panel.innerHTML='';
      const search=document.createElement('input');
      search.placeholder='Pesquisar...'; search.className='msel-search';
      panel.appendChild(search);
      const box=document.createElement('div');
      panel.appendChild(box);
      const draw=(flt='')=>{
        box.innerHTML='';
        opts.filter(o=>o.label.toLowerCase().includes(flt.toLowerCase())).forEach(o=>{
          const row=document.createElement('div'); row.className='msel-opt';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.value=o.value;
          if(state.has(o.value)) cb.checked=true;
          const lb=document.createElement('label'); lb.textContent=`${o.label}${o.meta?` ‚Äî ${o.meta}`:''}`;
          row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
          cb.addEventListener('change',()=>{ cb.checked?state.add(o.value):state.delete(o.value); sync(); });
        });
      };
      search.addEventListener('input',()=>draw(search.value));
      draw();
    };
    const sync=()=>{
      btn.textContent = state.size ? `${state.size} selecionado(s)` : placeholder;
      root.dispatchEvent(new CustomEvent('change'));
      touchFilters();
    };
    return {
      render, get:()=>Array.from(state), set:(arr)=>{ state.clear(); arr.forEach(v=>state.add(v)); sync(); }
    };
  }

  const ms={
    unids: MultiSel('ms-unids','Todas as unidades'),
    lojas: MultiSel('ms-lojas','Todas as lojas'),
    canais: MultiSel('ms-canais','Todos os canais'),
    pags:  MultiSel('ms-pags','Todos os tipos'),
    turnos:MultiSel('ms-turnos','Todos os turnos'),
    cancel:MultiSel('ms-cancel','Todos')
  };

  /* ===================== AUTO-COLLAPSE DE FILTROS ===================== */
  let collapseTimer=null;
  const filtersSec = $('filtersSec');
  const restartCollapse=()=>{
    filtersSec.classList.remove('collapsed');
    if(collapseTimer) clearTimeout(collapseTimer);
    collapseTimer = setTimeout(()=>filtersSec.classList.add('collapsed'), 10000);
  };
  const touchFilters=()=>restartCollapse();
  restartCollapse();

  /* ===================== BUILD FILTERS (com OR para N√£o/Nao) ===================== */
  function buildFilters(query) {
    const selU = ms.unids.get();  if (selU.length) query = query.in('unidade', selU);
    const selL = ms.lojas.get();  if (selL.length) query = query.in('loja', selL);
    const selC = ms.canais.get(); if (selC.length) query = query.in('canal', selC);
    const selP = ms.pags.get();   if (selP.length) query = query.in('pagamento_base', selP);
    const selT = ms.turnos.get(); if (selT.length) query = query.in('turno', selT);

    const selCanc = ms.cancel.get().filter(v => v && v !== '');
    if (selCanc.length === 1) {
      const v = selCanc[0];
      if (v === 'N√£o' || v === 'Nao') query = query.or('cancelado.eq.N√£o,cancelado.eq.Nao');
      else if (v === 'Sim') query = query.eq('cancelado','Sim');
    }
    return query;
  }

  /* ===================== TURNOS: somente Dia/Noite ===================== */
  function normalizeTurno(hora){
    const h = Number(hora||0);
    // Dia 10:00‚Äì18:00 ; Noite 18:01‚Äì23:00 (demais hor√°rios s√£o desconsiderados)
    if (h>=10 && h<=18) return 'Dia';
    if (h>=19 && h<=23) return 'Noite';
    // 18:01‚Äì18:59 cai como Noite, mas s√≥ temos hora inteira; se 18, tratamos como Dia
    return 'Fora';
  }

  /* ===================== CHART COLORS ===================== */
  const colorNow   = getComputedStyle(document.documentElement).getPropertyValue('--pri').trim();
  const colorNowBg = getComputedStyle(document.documentElement).getPropertyValue('--pri-20').trim();
  const colorPrev  = 'rgba(2,6,23,.55)';
  const colorPrevBg= 'rgba(2,6,23,.10)';

  /* ===================== DATE / PERIOD ===================== */
  function setQuick(days){
    if(!lastDia) return;
    const ate = new Date(lastDia);
    const de  = new Date(ate); de.setDate(de.getDate()-(days-1));
    $('fDe').value = toISO(de);
    $('fAte').value = toISO(ate);
    updateRange();
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.dataset.q==days));
  }

  function updateRange(){
    const de  = new Date($('fDe').value);
    const ate = new Date($('fAte').value);
    const days = Math.ceil((ate-de)/86400000)+1;
    const prevAte = new Date(de); prevAte.setDate(prevAte.getDate()-1);
    const prevDe  = new Date(prevAte); prevDe.setDate(prevDe.getDate()-(days-1));
    range = {de:toISO(de), ate:toISO(ate), days, prevDe:toISO(prevDe), prevAte:toISO(prevAte), prevDays:days};
    $('periodoLegend').textContent = `Per√≠odo: ${range.de} ‚Üí ${range.ate} | Anterior: ${range.prevDe} ‚Üí ${range.prevAte}`;
  }

  async function loadLastDate(){
    const r = await supa.from('vendas_canon').select('dia').order('dia',{ascending:false}).limit(1).maybeSingle();
    if(r.error){ setStatus('Erro ao buscar √∫ltima data','err'); console.error(r.error); return; }
    lastDia = r.data?.dia;
    $('periodoInfo').textContent = `√öltimo dia carregado: ${lastDia||'‚Äî'}`;
  }

  /* ===================== DATA FETCHERS ===================== */
  async function fetchRows(rangeDe, rangeAte){
    let q = supa.from('vendas_canon').select('dia,hora,turno,unidade,loja,canal,pagamento_base,cancelado,fat,des,fre,pedido_id');
    if (rangeDe && rangeAte) q = q.gte('dia', rangeDe).lte('dia', rangeAte);
    q = buildFilters(q);
    const {data, error} = await q;
    if(error){ console.error(error); throw error; }
    // normaliza turno (apenas Dia/Noite; ignora outros)
    return (data||[]).map(r=>{
      const t = normalizeTurno(r.hora);
      return {...r, turno:t};
    }).filter(r=>r.turno!=='Fora');
  }

  function uniqPedidoUid(r){ return `${r.unidade||''}|${r.pedido_id||''}|${r.dia||''}`; }

  /* ===================== KPIs / AGG ===================== */
  function agg(rows){
    const pedidosSet = new Set();
    let fat=0, des=0, fre=0, canc_ped=0, canc_val=0;
    const allSet = new Set(); // todos pedidos incluindo cancelados
    rows.forEach(x=>{
      const id = uniqPedidoUid(x);
      allSet.add(id);
      if (x.cancelado==='Sim') {
        canc_val += Number(x.fat||0);
        canc_ped += 1; // 1 por linha (cada linha √© um pedido+itens j√° can√¥nico)
        return;
      }
      pedidosSet.add(id);
      fat += Number(x.fat||0);
      des += Number(x.des||0);
      fre += Number(x.fre||0);
    });
    const pedidos = pedidosSet.size;
    const ticket = pedidos ? fat/pedidos : 0;
    const freMed = pedidos ? fre/pedidos : 0;
    const fatMed = rows.length ? fat/uniqueDays(rows).length : 0;
    const desPerc= fat>0 ? (des/fat*100) : 0;
    const roi    = des>0 ? ((fat - des)/des*100) : 0;
    const partCanc = allSet.size>0 ? (canc_ped/allSet.size*100) : 0;
    return {pedidos,fat,des,fre,ticket,freMed,fatMed,desPerc,roi,canc_ped,canc_val,partCanc};
  }
  function uniqueDays(rows){ return Array.from(new Set(rows.map(r=>r.dia))); }

  function delta(a,b){ if(b===0 && a===0) return 0; if(b===0) return 100; return (a/b-1)*100; }

  function setDelta(elId, v){
    const el=$(elId); el.textContent = (v>0?'+':'')+ (v||0).toFixed(1).replace('.',',')+'%';
    el.classList.remove('up','down','flat');
    el.classList.add(v>0?'up':v<0?'down':'flat');
    el.title = `Comparado ao per√≠odo anterior (${range.prevDe} ‚Üí ${range.prevAte})`;
  }

  function paintKPIs(cur, prev){
    // pedidos
    $('k_ped').textContent = intf(cur.pedidos);
    $('p_ped').textContent = intf(prev.pedidos);
    setDelta('d_ped', delta(cur.pedidos, prev.pedidos));
    // ticket
    $('k_tkt').textContent = money(cur.ticket);
    $('p_tkt').textContent = money(prev.ticket);
    setDelta('d_tkt', delta(cur.ticket, prev.ticket));
    // faturamento
    $('k_fat').textContent = money(cur.fat);
    $('p_fat').textContent = money(prev.fat);
    setDelta('d_fat', delta(cur.fat, prev.fat));
    // fat m√©dio di√°rio
    $('k_fatmed').textContent = money(cur.fatMed);
    $('p_fatmed').textContent = money(prev.fatMed);
    setDelta('d_fatmed', delta(cur.fatMed, prev.fatMed));
    // incentivos
    $('k_des').textContent = money(cur.des);
    $('p_des').textContent = money(prev.des);
    setDelta('d_des', delta(cur.des, prev.des));
    // % incentivos
    $('k_desperc').textContent = pct(cur.desPerc);
    $('p_desperc').textContent = pct(prev.desPerc);
    setDelta('d_desperc', delta(cur.desPerc, prev.desPerc));
    // frete
    $('k_fre').textContent = money(cur.fre);
    $('p_fre').textContent = money(prev.fre);
    setDelta('d_fre', delta(cur.fre, prev.fre));
    // frete m√©dio
    $('k_fremed').textContent = money(cur.freMed);
    $('p_fremed').textContent = money(prev.freMed);
    setDelta('d_fremed', delta(cur.freMed, prev.freMed));
    // cancelados
    $('k_canc_ped').textContent = intf(cur.canc_ped);
    $('k_canc_part').textContent = pct(cur.partCanc);
    $('p_canc_part').textContent = pct(prev.partCanc);
    setDelta('d_canc_ped', delta(cur.canc_ped, prev.canc_ped));
    $('k_canc_val').textContent = money(cur.canc_val);
    $('p_canc_val').textContent = money(prev.canc_val);
    setDelta('d_canc_val', delta(cur.canc_val, prev.canc_val));
    // ROI
    $('k_roi').textContent = pct(cur.roi);
    $('p_roi').textContent = pct(prev.roi);
    setDelta('d_roi', delta(cur.roi, prev.roi));
  }

  /* ===================== CHARTS ===================== */
  let CH_MONTH, CH_DOW, CH_HOUR, CH_TURNO;

  function destroy(c){ if(c){ c.destroy(); } }

  function dataset(label, now, isPrev, periodLabel){
    return {
      label: label,
      data: now,
      borderColor: isPrev?colorPrev:colorNow,
      backgroundColor: isPrev?colorPrevBg:colorNowBg,
      borderWidth: 2,
      tension: .25,
      fill: true,
      pointRadius: 2,
      periodLabel
    };
  }

  function tooltipLabel(ctx){
    const ds = ctx.dataset;
    const val = ctx.parsed.y;
    // decide formato pela m√©trica ativa
    const moneyMetrics = ['fat','fatmed','des','fre','canc_val'];
    const percentMetrics = ['desperc','roi'];
    const intMetrics = ['pedidos','canc_ped'];
    let text;
    if (moneyMetrics.includes(focusMetric)) text = money(val);
    else if (percentMetrics.includes(focusMetric)) text = pct(val);
    else text = intf(val);
    const which = ds.label + (ds.periodLabel?` ‚Äî ${ds.periodLabel}`:'');
    return `${which}: ${text}`;
  }

  function valueForMetric(rows, byKey){
    // agrupa por chave (string) e aplica m√©trica + modo
    const map = new Map();
    const days = uniqueDays(rows).length || 1;
    const add=(k,row)=>{
      const cur = map.get(k)||{fat:0,des:0,fre:0,ped:new Set(),canc:0,canc_val:0};
      if(row.cancelado==='Sim'){
        cur.canc += 1;
        cur.canc_val += Number(row.fat||0);
      }else{
        cur.fat += Number(row.fat||0);
        cur.des += Number(row.des||0);
        cur.fre += Number(row.fre||0);
        cur.ped.add(uniqPedidoUid(row));
      }
      map.set(k,cur);
    };
    rows.forEach(r=> add(byKey(r), r));
    const keys = Array.from(map.keys());
    const vals = keys.map(k=>{
      const o = map.get(k);
      const pedidos = o.ped.size;
      const metrics = {
        pedidos: pedidos,
        fat: o.fat,
        des: o.des,
        fre: o.fre,
        ticket: pedidos? o.fat/pedidos : 0,
        fremed: pedidos? o.fre/pedidos : 0,
        fatmed: days? o.fat/days : 0,
        desperc: o.fat>0 ? (o.des/o.fat*100) : 0,
        roi: o.des>0 ? ((o.fat-o.des)/o.des*100) : 0,
        canc_ped: o.canc,
        canc_val: o.canc_val
      };
      return metrics[focusMetric] || o.fat;
    });
    if(globalMode==='media' && !['ticket','fremed','fatmed','desperc','roi'].includes(focusMetric)){
      // m√©dia por chave (dias)
      const d = days;
      return vals.map(v=> v/d);
    }
    return vals;
  }

  function buildMonthSeries(){
    // 24m ignorando filtro de data; respeita demais filtros
    const months = []; // 'YYYY-MM'
    const dEnd = new Date(lastDia);
    const dStart = new Date(dEnd); dStart.setMonth(dStart.getMonth()-23); // 24 meses
    const cursor = new Date(dStart);
    while(cursor<=dEnd){
      const ym = cursor.toISOString().slice(0,7);
      if(!months.includes(ym)) months.push(ym);
      cursor.setMonth(cursor.getMonth()+1);
    }
    const key = (r)=> r.dia.slice(0,7);
    const valsNow = valueForMetric(cache24m.filter(r=>{
      const ym = r.dia.slice(0,7);
      return months.includes(ym);
    }), key);
    // s√©rie anterior (12 meses imediatamente anteriores ao bloco dos 12 √∫ltimos)
    const last12 = months.slice(-12);
    const prev12 = months.slice(-24,-12);
    const idxMap = new Map(months.map((m,i)=>[m,i]));
    const arrNow = last12.map(m=>{
      const i = idxMap.get(m);
      return valsNow[i]||0;
    });
    const arrPrev = prev12.map(m=>{
      const i = idxMap.get(m);
      return valsNow[i]||0;
    });
    return {months:{prev:prev12, now:last12}, arrNow, arrPrev};
  }

  function updateCharts(){
    // DOW
    const days=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    const keyDow = r => (new Date(r.dia).getUTCDay()); // 0..6 (Dom..S√°b)
    const valsCurDow = valueForMetric(baseCur, r=>keyDow(r));
    const valsPrevDow= valueForMetric(basePrev,r=>keyDow(r));
    const arrNowDow = days.map((_,i)=> valsCurDow[i]||0);
    const arrPrevDow= days.map((_,i)=> valsPrevDow[i]||0);

    destroy(CH_DOW);
    CH_DOW = new Chart($('ch_dow'),{
      type:'line',
      data:{
        labels:days,
        datasets:[
          dataset('Atual',arrNowDow,false, `${range.de} ‚Üí ${range.ate}`),
          dataset('Anterior',arrPrevDow,true, `${range.prevDe} ‚Üí ${range.prevAte}`)
        ]
      },
      options:{
        plugins:{legend:{display:true}, tooltip:{callbacks:{label:tooltipLabel}}},
        scales:{y:{beginAtZero:true}}
      }
    });

    // HOUR (remove zero)
    const hours = Array.from({length:24},(_,h)=>h);
    const keyHour = r=> Number(r.hora||0);
    const valsCurH = valueForMetric(baseCur, keyHour);
    const valsPrevH= valueForMetric(basePrev,keyHour);
    const labsH=[], nowH=[], prevH=[];
    hours.forEach(h=>{
      const v1 = valsCurH[h]||0, v2 = valsPrevH[h]||0;
      if (v1!==0 || v2!==0){
        labsH.push(String(h).padStart(2,'0')+'h');
        nowH.push(v1); prevH.push(v2);
      }
    });

    destroy(CH_HOUR);
    CH_HOUR = new Chart($('ch_hour'),{
      type:'bar',
      data:{ labels:labsH, datasets:[
        dataset('Atual',nowH,false, `${range.de} ‚Üí ${range.ate}`),
        dataset('Anterior',prevH,true, `${range.prevDe} ‚Üí ${range.prevAte}`),
      ]},
      options:{plugins:{tooltip:{callbacks:{label:tooltipLabel}}}, scales:{y:{beginAtZero:true}}}
    });

    // TURNO
    const turnos=['Dia','Noite'];
    const keyTurno = r=> r.turno;
    const valsCurT = valueForMetric(baseCur,keyTurno);
    const valsPrevT= valueForMetric(basePrev,keyTurno);
    const arrNowT = turnos.map(t=> valsCurT[turnos.indexOf(t)]||0);
    const arrPrevT= turnos.map(t=> valsPrevT[turnos.indexOf(t)]||0);

    destroy(CH_TURNO);
    CH_TURNO = new Chart($('ch_turno'),{
      type:'bar',
      data:{ labels:turnos, datasets:[
        dataset('Atual',arrNowT,false, `${range.de} ‚Üí ${range.ate}`),
        dataset('Anterior',arrPrevT,true, `${range.prevDe} ‚Üí ${range.prevAte}`)
      ]},
      options:{plugins:{tooltip:{callbacks:{label:tooltipLabel}}}, scales:{y:{beginAtZero:true}}}
    });

    // MONTH 12√ó12 (sempre √∫ltimos 12m x 12m anteriores; ignora filtro de datas)
    const m = buildMonthSeries();
    destroy(CH_MONTH);
    CH_MONTH = new Chart($('ch_month_big'),{
      type:'line',
      data:{ labels:[...m.months.prev, ...m.months.now],
        datasets:[
          dataset('Anterior', m.arrPrev, true, '12m anteriores'),
          dataset('Atual',   m.arrNow,  false,'√∫ltimos 12m')
        ]
      },
      options:{plugins:{tooltip:{callbacks:{label:tooltipLabel}}}, scales:{y:{beginAtZero:true}}}
    });
  }

  /* ===================== RANKING PARA FILTROS ===================== */
  function rankOptions(rows, field){
    const map = new Map();
    rows.forEach(r=>{
      const k = String(r[field]||'').trim();
      if(!k) return;
      const o = map.get(k)||{k, fat:0, cnt:0};
      o.fat += Number(r.fat||0); o.cnt++;
      map.set(k,o);
    });
    return Array.from(map.values())
      .sort((a,b)=> b.fat-a.fat || b.cnt-a.cnt)
      .map(o=>({value:o.k, label:o.k, meta:intf(o.cnt)}));
  }

  function renderAllFilters(){
    // Unidades / Lojas / Canais / Pagamentos / Turnos (Dia|Noite fixos)
    ms.unids.render(rankOptions(cache24m,'unidade'));
    ms.lojas.render(rankOptions(cache24m,'loja'));
    ms.canais.render(rankOptions(cache24m,'canal'));
    ms.pags.render(rankOptions(cache24m,'pagamento_base'));
    ms.turnos.render([{value:'Dia',label:'Dia'},{value:'Noite',label:'Noite'}]);
  }

  /* ===================== LOAD & UPDATE ===================== */
  async function refreshAll(){
    try{
      setStatus('Atualizando...','');
      // busca linhas dos 24 meses p/ ranking e gr√°fico mensal (ignora datas dos filtros)
      const dEnd = lastDia;
      const dStart = toISO(new Date(new Date(lastDia).setMonth(new Date(lastDia).getMonth()-23)));
      cache24m = await fetchRows(dStart, dEnd);
      renderAllFilters();

      // per√≠odo atual e anterior (respeitando filtros)
      baseCur  = await fetchRows(range.de, range.ate);
      basePrev = await fetchRows(range.prevDe, range.prevAte);

      const A = agg(baseCur), B = agg(basePrev);
      paintKPIs(A,B);
      updateCharts();
      setStatus('OK ‚Äî gr√°ficos atualizados','ok');
    }catch(err){
      console.error(err);
      setStatus('Erro ao atualizar','err');
    }
  }

  /* ===================== EVENTS ===================== */
  document.querySelectorAll('.chip').forEach(c=> c.addEventListener('click',()=>{ setQuick(Number(c.dataset.q)); refreshAll(); }));
  $('fDe').addEventListener('change', ()=>{ updateRange(); refreshAll(); });
  $('fAte').addEventListener('change', ()=>{ updateRange(); refreshAll(); });
  $('btnClear').addEventListener('click', ()=>{
    ms.unids.set([]); ms.lojas.set([]); ms.canais.set([]); ms.pags.set([]); ms.turnos.set([]); ms.cancel.set(['N√£o']);
    refreshAll();
  });

  Object.values(ms).forEach(m=> $(m===ms.unids?'ms-unids':m===ms.lojas?'ms-lojas':m===ms.canais?'ms-canais':m===ms.pags?'ms-pags':m===ms.turnos?'ms-turnos':'ms-cancel')
    .addEventListener('change', ()=>{ refreshAll(); }));

  // KPI clique -> foco de m√©trica
  document.querySelectorAll('.kpi').forEach(k=>{
    k.addEventListener('click',()=>{
      document.querySelectorAll('.kpi').forEach(x=>x.classList.remove('active'));
      k.classList.add('active');
      focusMetric = k.dataset.metric || 'fat';
      updateCharts();
    });
  });

  // Modo Total/M√©dia global
  document.querySelectorAll('#modeSeg .seg-btn').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('#modeSeg .seg-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      globalMode = b.dataset.mode;
      updateCharts();
    });
  });

  /* ===================== BOOT ===================== */
  (async ()=>{
    await loadLastDate();
    setQuick(30);      // per√≠odo r√°pido padr√£o, √¢ncorado no √∫ltimo dia da base
    await refreshAll(); // primeira carga
  })();
  </script>
</body>
</html>
