<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Maestro Food — Importador XLSX (foco em upload)</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
<style>
  :root{--bg:#0b1220;--card:#121a2b;--muted:#92a0b6;--text:#e9eef6;--acc:#2ea779;--err:#e5484d;--warn:#f0b429;--stroke:#23304a}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 4px}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;margin-top:12px}
  .row{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#0f172a;color:var(--text)}
  .btn{background:var(--acc);border:none;color:#fff;cursor:pointer}
  .btn.ghost{background:#1c263d;color:#b7c4d9}
  .inline{display:flex;gap:8px;align-items:center}
  .right{text-align:right}
  pre{white-space:pre-wrap;background:#0f172a;color:#d6e3ff;border-radius:10px;padding:10px;overflow:auto;border:1px solid var(--stroke)}
  .ok{color:#1dd1a1}.warn{color:var(--warn)}.err{color:var(--err)}
  .progress{height:10px;background:#0f172a;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .bar{height:10px;background:var(--acc);width:0%}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--stroke);padding:6px 8px}
  th{background:#0f172a}
</style>
</head>
<body>
<div class="container">
  <h1>Maestro Food — Importador XLSX</h1>
  <div class="muted">Lê Excel, separa <b>dia/hora</b>, valida e grava em <code>public.vendas_xlsx</code>.</div>

  <div class="card">
    <div class="row cols-2">
      <div>
        <label>Arquivo XLSX</label>
        <input id="file" type="file" accept=".xlsx"/>
      </div>
      <div>
        <label>Aba (sheet)</label>
        <select id="sheet"></select>
      </div>
    </div>
    <div class="inline" style="margin-top:10px;">
      <button id="btnRead" class="btn">1) Ler planilha</button>
      <button id="btnSend" class="btn">2) Enviar ao Supabase</button>
      <button id="btnHealth" class="btn ghost">Healthcheck</button>
    </div>
    <div class="card" style="margin-top:12px;">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status" class="muted" style="margin-top:6px;"></div>
    </div>
  </div>

  <div class="card">
    <b>Mapeamento detectado</b>
    <pre id="mapping">(vazio)</pre>
  </div>

  <div class="card">
    <b>Relatório de validação</b>
    <pre id="report">(vazio)</pre>
  </div>

  <div class="card">
    <b>Preview (até 10 linhas válidas)</b>
    <pre id="preview">(vazio)</pre>
  </div>

  <div class="card">
    <b>Healthcheck do banco</b>
    <pre id="health">(clique em Healthcheck)</pre>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>

<script>
/** ====== CONFIG ====== **/
const SUPABASE_URL  = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';
const TABLE = 'vendas_xlsx';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** ====== DOM ====== **/
const $ = (id)=>document.getElementById(id);
const file = $('file'), sheetSel = $('sheet');
const btnRead = $('btnRead'), btnSend = $('btnSend'), btnHealth = $('btnHealth');
const statusEl = $('status'), bar = $('bar');
const mappingEl = $('mapping'), reportEl = $('report'), previewEl = $('preview'), healthEl = $('health');

/** ====== STATE ====== **/
let wb = null, wbSheets = [], rowsRaw = [], rowsValid = [], rowsInvalid = [], headerMap = null;

/** ====== UTILS ====== **/
const norm = (s)=> String(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
const onlyDateISO = (iso)=> iso && iso.length>=10 ? iso.slice(0,10) : null;
function parseMoney(v){
  if(v==null || v==='') return 0;
  if(typeof v==='number') return v;
  let s = String(v).trim();
  // remove tudo exceto dígitos, vírgula, ponto e sinal
  s = s.replace(/[^0-9,.\-]/g,'');
  // se tem mais de um separador, assume último como decimal
  const lastComma = s.lastIndexOf(',');
  const lastDot   = s.lastIndexOf('.');
  if (lastComma > lastDot) { // vírgula é decimal
    s = s.replace(/\./g,'').replace(',','.');
  } else { // ponto é decimal
    s = s.replace(/,/g,'');
  }
  const n = Number(s);
  return isFinite(n)? n : 0;
}
function toISOfromBrOrISO(s){
  if(!s) return null;
  const str = String(s).trim();
  // dd/mm/yyyy hh:mm
  const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2}))?/);
  if(m){
    const d = m[1].padStart(2,'0'), M = m[2].padStart(2,'0'), y = m[3];
    const hh = m[4]? m[4].padStart(2,'0') : '00';
    const mm = m[5]? m[5] : '00';
    return `${y}-${M}-${d}T${hh}:${mm}:00`;
  }
  // yyyy-mm-dd...
  if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.length>10 ? str : (str+'T00:00:00');
  return null;
}
function hourFromDateText(s){
  const m = String(s??'').match(/(\d{1,2}):(\d{2})/);
  if(!m) return -1;
  const h = parseInt(m[1],10);
  return isFinite(h)? h : -1;
}
function turnoFromHour(h){
  if(h<0) return null;
  if(h>=6 && h<12) return 'Manhã';
  if(h>=12 && h<18) return 'Tarde';
  if(h>=18 && h<24) return 'Noite';
  return 'Madrugada';
}
function normCancel(v){
  const s = norm(v);
  if (v===true || s==='sim' || s==='s' || s==='1' || s==='true') return 'Sim';
  return 'Não';
}
function pagamentoBase(p){
  const s = String(p??'').split(',')[0].trim();
  return s || null;
}
function setStatus(txt, cls){
  statusEl.textContent = txt;
  statusEl.className = cls? cls : 'muted';
}
function setBar(pct){
  bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
}

/** ====== HEADER MAP ====== **/
function buildHeaderMap(cols){
  // mapa de sinônimos -> destino
  const dict = [
    {std:'dia_src', list:['data da venda','data','dt venda','dt_venda']},
    {std:'unidade', list:['unidade','codigo da loja','código da loja','cod loja','cod_loja','filial']},
    {std:'Nome da loja', list:['nome da loja','loja','nome_loja']},
    {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda']},
    {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento']},
    {std:'des', list:['desconto','des']},
    {std:'fre', list:['entrega','frete','valor entregador']},
    {std:'fat', list:['total','valor total','faturamento','total taxa de serviço + total?']},
    {std:'cancelado', list:['esta cancelado','está cancelado','cancelado']},
    {std:'turno', list:['turno']},
    {std:'pedido_id', list:['pedido','numero do pedido','número do pedido','numero do pedido no parceiro']},
  ];
  const out = {};
  const lower = cols.map(c=>({orig:c, key:norm(c)}));
  for(const d of dict){
    for(const cand of d.list){
      const hit = lower.find(x=> x.key===cand);
      if(hit){ out[d.std] = hit.orig; break; }
    }
  }
  // faltantes
  const required = ['dia_src','unidade','fat'];
  const missing = required.filter(k=> !out[k]);
  return {map: out, missing};
}

/** ====== XLSX LOAD ====== **/
file.addEventListener('change', async ()=>{
  wb = null; wbSheets = []; sheetSel.innerHTML = '';
  rowsRaw = rowsValid = rowsInvalid = []; headerMap = null;
  mappingEl.textContent = '(vazio)'; reportEl.textContent='(vazio)'; previewEl.textContent='(vazio)';
  setStatus('Lendo arquivo…','muted'); setBar(0);
  const f = file.files?.[0];
  if(!f){ setStatus('Selecione um .xlsx', 'warn'); return; }
  try{
    const buf = await f.arrayBuffer();
    wb = XLSX.read(buf, {cellDates:false, cellText:false});
    wbSheets = wb.SheetNames || [];
    if(!wbSheets.length){ setStatus('XLSX sem abas.', 'err'); return; }
    // popular select de abas
    sheetSel.innerHTML = wbSheets.map(n=>`<option>${n}</option>`).join('');
    // escolher a aba com mais linhas
    let best = wbSheets[0], maxRows = -1;
    for(const name of wbSheets){
      const sh = wb.Sheets[name];
      const json = XLSX.utils.sheet_to_json(sh, {defval:''});
      if(json.length > maxRows){ maxRows=json.length; best=name; }
    }
    sheetSel.value = best;
    setStatus(`Arquivo carregado. ${wbSheets.length} abas. Selecionada: ${best}.`, 'ok');
  }catch(e){
    console.error(e);
    setStatus('Falha ao ler XLSX.', 'err');
  }
});

btnRead.addEventListener('click', ()=>{
  if(!wb){ setStatus('Carregue o .xlsx primeiro.', 'warn'); return; }
  const name = sheetSel.value || wbSheets[0];
  const sh = wb.Sheets[name];
  const json = XLSX.utils.sheet_to_json(sh, {defval:''}); // cabeçalho na 1ª linha
  rowsRaw = json;
  if(rowsRaw.length===0){
    setStatus('Nada para importar (planilha vazia).', 'warn');
    reportEl.textContent = JSON.stringify({linhas:0}, null, 2);
    return;
  }
  // header map
  const cols = Object.keys(rowsRaw[0]||{});
  const hm = buildHeaderMap(cols);
  headerMap = hm.map;
  mappingEl.textContent = JSON.stringify({detectado: headerMap, faltando: hm.missing}, null, 2);
  if(hm.missing.length){
    setStatus('Faltam colunas obrigatórias no XLSX: '+hm.missing.join(', '), 'err');
  } else {
    // validar/processar
    processRows();
  }
});

function processRows(){
  rowsValid=[]; rowsInvalid=[];
  let i=0;
  for(const r of rowsRaw){
    i++;
    try{
      const dsrc = r[headerMap.dia_src];
      const iso = toISOfromBrOrISO(dsrc);
      const dia = onlyDateISO(iso);
      const hora = hourFromDateText(dsrc);
      const unidade = String(r[headerMap.unidade]??'').trim();
      const loja = r[headerMap['Nome da loja']];
      const canal = r[headerMap['Canal de venda']];
      const pagamento = r[headerMap['pagamento']];
      const des = parseMoney(r[headerMap['des']]);
      const fre = parseMoney(r[headerMap['fre']]);
      const fat = parseMoney(r[headerMap['fat']]);
      const cancelado = normCancel(r[headerMap['cancelado']]);
      const turno = r[headerMap['turno']] || turnoFromHour(hora);
      const pedidoId = r[headerMap['pedido_id']] || null;

      if(!dia || !unidade || !isFinite(fat)){
        rowsInvalid.push({linha:i, motivo:'campos obrigatórios ausentes/invalidos', dia, unidade, fat_raw:r[headerMap['fat']]});
        continue;
      }
      const pagaBase = pagamentoBase(pagamento);
      const rk = [dia, unidade, (loja||''), (isFinite(hora)?hora:-1), (pagaBase||''), (canal||''), (pedidoId||'')].join('|');
      rowsValid.push({
        dia, hora: isFinite(hora)?hora:-1, unidade,
        "Nome da loja": loja||null,
        "Canal de venda": canal||null,
        pagamento: pagamento||null,
        pagamento_base: pagaBase||null,
        cancelado, turno: turno||null,
        pedidos: 1,
        fat, des, fre,
        row_key: rk
      });
    }catch(e){
      rowsInvalid.push({linha:i, motivo:'exceção no parse', erro: String(e)});
    }
  }

  const rep = {
    'Linhas na planilha': rowsRaw.length,
    'Válidas (importáveis)': rowsValid.length,
    'Inválidas/ignoradas': rowsInvalid.length
  };
  reportEl.textContent = JSON.stringify(rep, null, 2);
  previewEl.textContent = JSON.stringify(rowsValid.slice(0,10), null, 2);
  if(rowsValid.length===0){
    setStatus('Nada para importar (tudo inválido/ignorado).', 'warn');
  } else {
    setStatus('Validação OK. Pronto para enviar.', 'ok');
  }
}

/** ====== ENVIAR AO SUPABASE (chunked) ====== **/
btnSend.addEventListener('click', async ()=>{
  if(rowsValid.length===0){ setStatus('Nada válido para enviar.', 'warn'); return; }
  setStatus('Iniciando envio…', 'muted'); setBar(0);
  const chunk = 1000;
  let sent=0, deleted=0, errs=0;
  for(let i=0;i<rowsValid.length;i+=chunk){
    const batch = rowsValid.slice(i, i+chunk);
    // dedup manual: delete por row_key antes
    const keys = [...new Set(batch.map(x=>x.row_key))];
    let del = await supa.from(TABLE).delete().in('row_key', keys);
    if(del.error){ console.warn('Delete falhou', del.error); } else { deleted += del.count||0; }

    const ins = await supa.from(TABLE).insert(batch);
    if(ins.error){ console.error(ins.error); errs += batch.length; }
    else { sent += batch.length; }
    setBar(((i+batch.length)/rowsValid.length)*100);
    setStatus(`Enviado ${sent}/${rowsValid.length} · erros ${errs}`, errs? 'warn':'muted');
    // yield
    await new Promise(r=>setTimeout(r, 30));
  }
  setStatus(`Concluído. Enviadas ${sent} linhas. Erros ${errs}.`, errs? 'warn':'ok');
});

/** ====== HEALTHCHECK ====== **/
btnHealth.addEventListener('click', async ()=>{
  healthEl.textContent = 'Consultando…';
  const a = await supa.from(TABLE).select('dia', {count:'exact', head:false}).order('dia',{ascending:true}).limit(1);
  const b = await supa.from(TABLE).select('dia', {count:'exact', head:false}).order('dia',{ascending:false}).limit(1);
  if(a.error || b.error){
    healthEl.textContent = JSON.stringify({error_a:a.error, error_b:b.error}, null, 2);
    return;
  }
  const min = a.data?.[0]?.dia || null;
  const c = await supa.from(TABLE).select('count', {count:'exact', head:true});
  const max = b.data?.[0]?.dia || null;
  healthEl.textContent = JSON.stringify({
    tabela: TABLE,
    intervalo: {min_dia: min, max_dia: max},
    total: c.count ?? null
  }, null, 2);
});
</script>
</body>
</html>
