<script>
async function applyAll(){
  try{
    const de = fDe.value || firstDay;
    const ate= fAte.value || lastDay;
    const len = (new Date(ate)-new Date(de))/86400000 + 1;

    setStatus('Consultando…');

    // 1) Tenta a rota rápida (única chamada)
    const fast = await supa.rpc('kpi_v2', buildParams(de,ate));
    if (!fast.error && fast.data) {
      const rows = fast.data; // 4 linhas
      const get = (s,g)=> rows.find(r=>r.scope===s && r.grp===g) || {pedidos:0,fat:0,des:0,fre:0};

      const now  = get('now','all');
      const prev = get('prev','all');
      const cNow = get('now','canc');
      const cPre = get('prev','canc');

      // derivados
      const tktN     = now.pedidos>0 ? (now.fat/now.pedidos) : 0;
      const tktP     = prev.pedidos>0 ? (prev.fat/prev.pedidos) : 0;
      const fatMedN  = len>0 ? (now.fat/len) : 0;
      const fatMedP  = len>0 ? (prev.fat/len) : 0;
      const desPercN = now.fat>0 ? (now.des/now.fat) : 0;
      const desPercP = prev.fat>0 ? (prev.des/prev.fat) : 0;
      const freMedN  = now.pedidos>0 ? (now.fre/now.pedidos) : 0;
      const freMedP  = prev.pedidos>0 ? (prev.fre/prev.pedidos) : 0;
      const partCN   = now.pedidos>0 ? (cNow.pedidos/now.pedidos) : 0;
      const partCP   = prev.pedidos>0 ? (cPre.pedidos/prev.pedidos) : 0;

      // pintar
      $('k_ped').textContent = (now.pedidos||0).toLocaleString('pt-BR');
      $('p_ped').textContent = (prev.pedidos||0).toLocaleString('pt-BR');
      deltaBadge($('d_ped'), now.pedidos||0, prev.pedidos||0);

      $('k_fat').textContent = money(now.fat);  $('p_fat').textContent = money(prev.fat);
      deltaBadge($('d_fat'), now.fat, prev.fat);

      $('k_des').textContent = money(now.des);  $('p_des').textContent = money(prev.des);
      deltaBadge($('d_des'), now.des, prev.des);

      $('k_desperc').textContent = ((desPercN*100).toFixed(1)).replace('.',',')+'%';
      $('p_desperc').textContent = ((desPercP*100).toFixed(1)).replace('.',',')+'%';
      deltaBadge($('d_desperc'), desPercN, desPercP);

      $('k_tkt').textContent = money(tktN);  $('p_tkt').textContent = money(tktP);
      deltaBadge($('d_tkt'), tktN, tktP);

      $('k_fatmed').textContent = money(fatMedN);  $('p_fatmed').textContent = money(fatMedP);
      deltaBadge($('d_fatmed'), fatMedN, fatMedP);

      $('k_fre').textContent = money(now.fre);  $('p_fre').textContent = money(prev.fre);
      deltaBadge($('d_fre'), now.fre, prev.fre);

      $('k_fremed').textContent = money(freMedN);  $('p_fremed').textContent = money(freMedP);
      deltaBadge($('d_fremed'), freMedN, freMedP);

      $('k_canc_ped').textContent = (cNow.pedidos||0).toLocaleString('pt-BR');
      deltaBadge($('d_canc_ped'), cNow.pedidos||0, cPre.pedidos||0);

      $('k_canc_val').textContent = money(cNow.fat);  $('p_canc_val').textContent = money(cPre.fat);
      deltaBadge($('d_canc_val'), cNow.fat, cPre.fat);

      $('k_canc_part').textContent = ((partCN*100).toFixed(2)).replace('.',',')+'%';
      $('p_canc_part').textContent = ((partCP*100).toFixed(2)).replace('.',',')+'%';

      setStatus('OK','ok');
      return; // fim do caminho rápido
    }

    // 2) Fallback (mantém 100% compatível caso kpi_v2 não exista)
    const atePrevISO=new Date(new Date(de+'T00:00:00').getTime()-86400000);
    const dePrevISO=new Date(atePrevISO.getTime()-((len-1)*86400000));
    const dePrev=iso(dePrevISO), atePrev=iso(atePrevISO);

    const [now,prev,cNow,cPrev] = await Promise.all([
      supa.rpc('kpi_vendas', buildParams(de,ate)),
      supa.rpc('kpi_vendas', buildParams(dePrev,atePrev)),
      supa.rpc('kpi_vendas', buildParams(de,ate,'Sim')),
      supa.rpc('kpi_vendas', buildParams(dePrev,atePrev,'Sim')),
    ]);
    if(now.error) throw now.error; if(prev.error) throw prev.error;
    if(cNow.error) throw cNow.error; if(cPrev.error) throw cPrev.error;

    // ... (use o mesmo bloco de pintura acima, agregando os arrays)
    // (mantive para brevidade – você já tem esse trecho em produção)
    setStatus('OK (fallback)','ok');

  }catch(e){ console.error(e); setStatus('Erro: '+(e.message||e),'err'); }
}
</script>
