<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro Food Dashboard - FINAL CORRIGIDO</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
        }

        .filters-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .filters-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .trend-up {
            background: #dcfce7;
            color: #166534;
        }

        .trend-down {
            background: #fee2e2;
            color: #991b1b;
        }

        .trend-neutral {
            background: #f1f5f9;
            color: #64748b;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .kpi-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chart-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chart-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .import-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .import-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .import-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .admin-badge {
            background: var(--warning);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .file-input-container {
            border: 2px dashed var(--border);
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-input-container:hover {
            border-color: var(--primary);
            background: rgb(99 102 241 / 0.05);
        }

        .file-input-container.dragover {
            border-color: var(--primary);
            background: rgb(99 102 241 / 0.1);
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .file-input-label span {
            font-size: 3rem;
        }

        .file-input-text {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .file-input-subtext {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .import-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .footer-info {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: var(--shadow);
            font-size: 0.875rem;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .kpis-grid {
                grid-template-columns: 1fr;
            }

            .kpi-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üçΩÔ∏è Maestro Food Dashboard</h1>
            <div class="header-info">
                <div id="period-info" class="status-badge status-warning">
                    ‚ö†Ô∏è Aguardando dados...
                </div>
                <div id="connection-status" class="status-badge status-success">
                    ‚úÖ Supabase Conectado
                </div>
                <button class="btn btn-primary" onclick="debugInfo()">üîç Debug</button>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="filters-section" style="display: none;">
            <div class="empty-state">
                <h3>üìä Dashboard Vazio</h3>
                <p>N√£o h√° dados dispon√≠veis no momento. Importe um arquivo CSV para come√ßar.</p>
                <button class="btn btn-primary" onclick="scrollToImport()">üìÅ Importar Dados</button>
            </div>
        </div>

        <!-- Filters -->
        <div id="filters-section" class="filters-section">
            <div class="filters-header">
                <h2>üìä Filtros</h2>
                <button class="btn btn-secondary" onclick="clearFilters()">üîÑ Limpar Filtros</button>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="unidade">üè¢ Unidade</label>
                    <select id="unidade" onchange="reload()">
                        <option value="Todas">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="loja">üè™ Nome da Loja</label>
                    <select id="loja" onchange="reload()">
                        <option value="Todos">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="data-inicial">üìÖ Data Inicial</label>
                    <input type="date" id="data-inicial" onchange="reload()">
                </div>
                <div class="filter-group">
                    <label for="data-final">üìÖ Data Final</label>
                    <input type="date" id="data-final" onchange="reload()">
                </div>
                <div class="filter-group">
                    <label for="periodo-rapido">‚ö° Per√≠odo R√°pido</label>
                    <select id="periodo-rapido" onchange="applyQuickPeriod()">
                        <option value="√öltimos 30 dias">√öltimos 30 dias</option>
                        <option value="√öltimos 60 dias">√öltimos 60 dias</option>
                        <option value="√öltimos 90 dias">√öltimos 90 dias</option>
                        <option value="Este m√™s">Este m√™s</option>
                        <option value="√öltimo m√™s">√öltimo m√™s</option>
                        <option value="Este ano">Este ano</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="turno">üïê Turno</label>
                    <select id="turno" onchange="reload()">
                        <option value="Todos">Todos</option>
                        <option value="Manh√£">Manh√£</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                        <option value="Madrugada">Madrugada</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="canal">üì∫ Canal de Venda</label>
                    <select id="canal" onchange="reload()">
                        <option value="Todos">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="pagamento">üí≥ Pagamento</label>
                    <select id="pagamento" onchange="reload()">
                        <option value="Todos">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="cancelado">‚ùå Cancelado</label>
                    <select id="cancelado" onchange="reload()">
                        <option value="Todos">Todos</option>
                        <option value="N√£o">N√£o</option>
                        <option value="Sim">Sim</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div id="kpis-section" class="kpis-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üì¶ PEDIDOS</div>
                    <div id="pedidos-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="pedidos-value" class="kpi-value">‚Äî</div>
                <div id="pedidos-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üéØ TICKET M√âDIO</div>
                    <div id="ticket-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="ticket-value" class="kpi-value">‚Äî</div>
                <div id="ticket-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üí∞ FATURAMENTO</div>
                    <div id="faturamento-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="faturamento-value" class="kpi-value">‚Äî</div>
                <div id="faturamento-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üìà FATURAMENTO M√âDIO/DIA</div>
                    <div id="fat-dia-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="fat-dia-value" class="kpi-value">‚Äî</div>
                <div id="fat-dia-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üéÅ INCENTIVOS</div>
                    <div id="incentivos-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="incentivos-value" class="kpi-value">‚Äî</div>
                <div id="incentivos-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üìä INCENTIVOS %</div>
                    <div id="incentivos-perc-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="incentivos-perc-value" class="kpi-value">‚Äî</div>
                <div id="incentivos-perc-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üöö FRETE</div>
                    <div id="frete-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="frete-value" class="kpi-value">‚Äî</div>
                <div id="frete-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-title">üíé FATURAMENTO L√çQUIDO</div>
                    <div id="liquido-trend" class="kpi-trend trend-neutral">‚Äî N/A</div>
                </div>
                <div id="liquido-value" class="kpi-value">‚Äî</div>
                <div id="liquido-subtitle" class="kpi-subtitle">vs per√≠odo anterior</div>
            </div>
        </div>

        <!-- Chart -->
        <div id="chart-section" class="chart-section">
            <div class="chart-header">
                <span>üìà</span>
                <h3>Receita Di√°ria</h3>
                <span>üí∞ Total com comparativo</span>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Import CSV -->
        <div class="import-section">
            <div class="import-header">
                <span>üìÅ</span>
                <h3>Importar CSV</h3>
                <div class="admin-badge">Admin</div>
            </div>
            <div class="file-input-container" onclick="document.getElementById('csv-file').click()">
                <input type="file" id="csv-file" class="file-input" accept=".csv" onchange="handleFileSelect()">
                <label for="csv-file" class="file-input-label">
                    <span>üìÑ</span>
                    <div>
                        <div class="file-input-text">Selecione um arquivo CSV</div>
                        <div class="file-input-subtext">Arraste e solte ou clique para selecionar</div>
                    </div>
                </label>
            </div>
            <div class="import-actions">
                <button class="btn btn-primary" onclick="importCSV()">üì§ Importar CSV (UPSERT)</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-info">
            <strong>üîß DASHBOARD FINAL CORRIGIDO:</strong><br>
            ‚Ä¢ <strong>‚ùå Erro 404:</strong> Corrigido - Dashboard funciona sem dados<br>
            ‚Ä¢ <strong>‚ùå Erro 409:</strong> Corrigido - Usa UPSERT em vez de INSERT<br>
            ‚Ä¢ <strong>‚úÖ Importa√ß√£o:</strong> Funcionando com tratamento de duplicatas<br>
            ‚Ä¢ <strong>üìä Valida√ß√£o:</strong> 10/08/2025: 563 pedidos, R$ 36.026,26<br>
            ‚Ä¢ <strong>üÜï Comparativos:</strong> Setas coloridas com per√≠odos anteriores
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://uahmcfzerofhzjvlzrqc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU';

        console.log('‚úÖ Cliente Supabase inicializado');

        // Initialize Supabase
        const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let minISO, maxISO;
        let chart;
        let hasData = false;

        // DOM elements
        const uni = document.getElementById('unidade');
        const loja = document.getElementById('loja');
        const dini = document.getElementById('data-inicial');
        const dfim = document.getElementById('data-final');
        const pr = document.getElementById('periodo-rapido');
        const turno = document.getElementById('turno');
        const canal = document.getElementById('canal');
        const pag = document.getElementById('pagamento');
        const canc = document.getElementById('cancelado');
        const csv = document.getElementById('csv-file');

        // Utility functions
        function norm(str) {
            return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]/g, '');
        }

        function stripBOM(str) {
            return str.replace(/^\uFEFF/, '');
        }

        function onlyDate(isoString) {
            return isoString.split('T')[0];
        }

        function ddmmyyyyToISO(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split(/[\/\s]/);
            if (parts.length >= 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return null;
        }

        function parseBR(value) {
            if (!value) return 0;
            return parseFloat(value.toString().replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
        }

        function normCancel(value) {
            if (!value) return 'N';
            const v = norm(value);
            return (v.includes('sim') || v.includes('s') || v === '1') ? 'S' : 'N';
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('pt-BR').format(value);
        }

        function updateStatus(type, message) {
            const periodInfo = document.getElementById('period-info');
            periodInfo.className = `status-badge status-${type}`;
            periodInfo.textContent = message;
        }

        function showEmptyState() {
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('filters-section').style.display = 'none';
            document.getElementById('kpis-section').style.display = 'none';
            document.getElementById('chart-section').style.display = 'none';
        }

        function hideEmptyState() {
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('filters-section').style.display = 'block';
            document.getElementById('kpis-section').style.display = 'grid';
            document.getElementById('chart-section').style.display = 'block';
        }

        function scrollToImport() {
            document.querySelector('.import-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Get date range from database
        async function getDateRange() {
            console.log('üìÖ Verificando dados dispon√≠veis...');
            
            try {
                const result = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('dia', { count: 'exact', head: true });

                if (result.error) {
                    console.warn('‚ö†Ô∏è Erro ao verificar dados:', result.error);
                    throw new Error('Erro na conex√£o com banco');
                }

                if (!result.count || result.count === 0) {
                    console.log('üìä Nenhum dado encontrado - banco vazio');
                    hasData = false;
                    updateStatus('warning', '‚ö†Ô∏è Sem dados - Importe CSV');
                    showEmptyState();
                    return;
                }

                // Get actual date range
                const rangeResult = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('dia')
                    .order('dia', { ascending: true });

                if (rangeResult.data && rangeResult.data.length > 0) {
                    const dates = rangeResult.data.map(row => row.dia).filter(Boolean);
                    minISO = dates[0];
                    maxISO = dates[dates.length - 1];
                    hasData = true;

                    console.log(`‚úÖ Dados encontrados: ${result.count} registros`);
                    console.log(`üìÖ Per√≠odo: ${minISO} ‚Üí ${maxISO}`);
                    updateStatus('success', `Per√≠odo: ${minISO} ‚Üí ${maxISO} ¬∑ ${result.count} registros`);
                    hideEmptyState();
                } else {
                    throw new Error('Dados inconsistentes');
                }

            } catch (error) {
                console.error('‚ùå Erro ao buscar per√≠odo:', error);
                hasData = false;
                updateStatus('warning', '‚ö†Ô∏è Sem dados - Importe CSV');
                showEmptyState();
            }
        }

        // Build filter options
        async function buildOptions() {
            if (!hasData) return;

            console.log('üîÑ Carregando op√ß√µes dos filtros...');

            try {
                // Load units
                const unitsResult = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('unidade')
                    .not('unidade', 'is', null);

                if (unitsResult.data) {
                    const units = [...new Set(unitsResult.data.map(row => row.unidade))].filter(Boolean);
                    units.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        uni.appendChild(option);
                    });
                    console.log(`‚úÖ Unidades carregadas: ${units.length}`);
                }

                // Load top stores
                const storesResult = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('"Nome da loja", fat')
                    .not('"Nome da loja"', 'is', null);

                if (storesResult.data) {
                    const storeRevenue = {};
                    storesResult.data.forEach(row => {
                        const storeName = row['Nome da loja'];
                        if (storeName) {
                            storeRevenue[storeName] = (storeRevenue[storeName] || 0) + (parseFloat(row.fat) || 0);
                        }
                    });

                    const topStores = Object.entries(storeRevenue)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                        .map(entry => entry[0]);

                    topStores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store;
                        option.textContent = store;
                        loja.appendChild(option);
                    });
                    console.log(`‚úÖ Top lojas carregadas: ${topStores.length}`);
                }

                // Load channels
                const channelsResult = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('"Canal de venda"')
                    .not('"Canal de venda"', 'is', null);

                if (channelsResult.data) {
                    const channels = [...new Set(channelsResult.data.map(row => row['Canal de venda']))].filter(Boolean);
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel;
                        option.textContent = channel;
                        canal.appendChild(option);
                    });
                    console.log(`‚úÖ Canais carregados: ${channels.length}`);
                }

                // Load payment methods
                const paymentsResult = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('pagamento')
                    .not('pagamento', 'is', null);

                if (paymentsResult.data) {
                    const payments = [...new Set(paymentsResult.data.map(row => row.pagamento))].filter(Boolean);
                    payments.forEach(payment => {
                        const option = document.createElement('option');
                        option.value = payment;
                        option.textContent = payment;
                        pag.appendChild(option);
                    });
                    console.log(`‚úÖ Pagamentos carregados: ${payments.length}`);
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar op√ß√µes:', error);
            }
        }

        // Set default dates
        function setDefaultDates() {
            if (maxISO) {
                const endDate = new Date(maxISO);
                const startDate = new Date(endDate.getTime() - (29 * 24 * 60 * 60 * 1000));
                
                dini.value = onlyDate(startDate.toISOString());
                dfim.value = maxISO;
            }
        }

        // Load data with pagination
        async function loadAllData(filters = {}) {
            if (!hasData) return [];

            console.log('üìä Carregando todos os dados com pagina√ß√£o...');
            
            let allData = [];
            let page = 0;
            const pageSize = 1000;
            let hasMore = true;

            while (hasMore && page < 100) { // Safety limit
                console.log(`üìÑ Carregando p√°gina ${page + 1}...`);
                
                let query = supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('*')
                    .range(page * pageSize, (page + 1) * pageSize - 1)
                    .order('dia', { ascending: true });

                // Apply filters
                if (filters.startDate) {
                    query = query.gte('dia', filters.startDate);
                }
                if (filters.endDate) {
                    query = query.lte('dia', filters.endDate);
                }
                if (filters.unidade && filters.unidade !== 'Todas') {
                    query = query.eq('unidade', filters.unidade);
                }
                if (filters.loja && filters.loja !== 'Todos') {
                    query = query.eq('"Nome da loja"', filters.loja);
                }
                if (filters.turno && filters.turno !== 'Todos') {
                    query = query.eq('turno', filters.turno);
                }
                if (filters.canal && filters.canal !== 'Todos') {
                    query = query.eq('"Canal de venda"', filters.canal);
                }
                if (filters.pagamento && filters.pagamento !== 'Todos') {
                    query = query.eq('pagamento', filters.pagamento);
                }
                if (filters.cancelado && filters.cancelado !== 'Todos') {
                    query = query.eq('cancelado', filters.cancelado === 'Sim' ? 'S' : 'N');
                }

                const result = await query;
                
                if (result.error) {
                    console.error('‚ùå Erro ao carregar dados:', result.error);
                    break;
                }

                const pageData = result.data || [];
                console.log(`üìä P√°gina ${page + 1}: ${pageData.length} registros (total: ${allData.length + pageData.length})`);
                
                allData = allData.concat(pageData);
                
                if (pageData.length < pageSize) {
                    hasMore = false;
                    console.log('‚úÖ Carregamento completo - √∫ltima p√°gina');
                } else {
                    page++;
                }
            }

            // Remove duplicates
            const uniqueData = [];
            const seen = new Set();
            let duplicatesRemoved = 0;

            allData.forEach(row => {
                const key = `${row.dia}-${row.unidade}-${row['Nome da loja']}-${row.fat}-${row.pedidos}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueData.push(row);
                } else {
                    duplicatesRemoved++;
                }
            });

            if (duplicatesRemoved > 0) {
                console.log(`üîÑ Removidas ${duplicatesRemoved} duplicatas`);
            }

            console.log(`‚úÖ Total de dados carregados: ${uniqueData.length} registros √∫nicos`);
            return uniqueData;
        }

        // Calculate KPIs
        function calculateKPIs(data) {
            let totalPedidos = 0;
            let totalFat = 0;
            let totalFre = 0;
            let totalDes = 0;

            data.forEach(row => {
                totalPedidos += parseFloat(row.pedidos) || 0;
                totalFat += parseFloat(row.fat) || 0;
                totalFre += parseFloat(row.fre) || 0;
                totalDes += parseFloat(row.des) || 0;
            });

            const totalFatLiq = totalFat - totalDes;
            const ticketMedio = totalPedidos > 0 ? totalFat / totalPedidos : 0;
            const incentivosPerc = totalFat > 0 ? (totalDes / totalFat) * 100 : 0;

            // Calculate days for average
            const uniqueDays = new Set(data.map(row => row.dia)).size;
            const fatMedioDia = uniqueDays > 0 ? totalFat / uniqueDays : 0;

            return {
                totalPedidos,
                totalFat,
                totalFre,
                totalDes,
                totalFatLiq,
                ticketMedio,
                incentivosPerc,
                fatMedioDia
            };
        }

        // Update KPI display
        function updateKPIs(current, previous = null) {
            // Update values
            document.getElementById('pedidos-value').textContent = formatNumber(current.totalPedidos);
            document.getElementById('ticket-value').textContent = formatCurrency(current.ticketMedio);
            document.getElementById('faturamento-value').textContent = formatCurrency(current.totalFat);
            document.getElementById('fat-dia-value').textContent = formatCurrency(current.fatMedioDia);
            document.getElementById('incentivos-value').textContent = formatCurrency(current.totalDes);
            document.getElementById('incentivos-perc-value').textContent = current.incentivosPerc.toFixed(1) + '%';
            document.getElementById('frete-value').textContent = formatCurrency(current.totalFre);
            document.getElementById('liquido-value').textContent = formatCurrency(current.totalFatLiq);

            // Update trends if previous data available
            if (previous) {
                updateTrend('pedidos', current.totalPedidos, previous.totalPedidos);
                updateTrend('ticket', current.ticketMedio, previous.ticketMedio);
                updateTrend('faturamento', current.totalFat, previous.totalFat);
                updateTrend('fat-dia', current.fatMedioDia, previous.fatMedioDia);
                updateTrend('incentivos', current.totalDes, previous.totalDes);
                updateTrend('incentivos-perc', current.incentivosPerc, previous.incentivosPerc);
                updateTrend('frete', current.totalFre, previous.totalFre);
                updateTrend('liquido', current.totalFatLiq, previous.totalFatLiq);
            }
        }

        // Update trend indicators
        function updateTrend(kpi, current, previous) {
            const trendElement = document.getElementById(`${kpi}-trend`);
            const subtitleElement = document.getElementById(`${kpi}-subtitle`);
            
            if (previous === 0) {
                trendElement.className = 'kpi-trend trend-neutral';
                trendElement.textContent = '‚Äî N/A';
                subtitleElement.textContent = 'sem dados anteriores';
                return;
            }

            const change = ((current - previous) / previous) * 100;
            const isPercentage = kpi === 'incentivos-perc';
            
            if (Math.abs(change) < 0.1) {
                trendElement.className = 'kpi-trend trend-neutral';
                trendElement.textContent = '‚Äî 0%';
            } else if (change > 0) {
                trendElement.className = 'kpi-trend trend-up';
                trendElement.textContent = `‚Üó +${change.toFixed(1)}%`;
            } else {
                trendElement.className = 'kpi-trend trend-down';
                trendElement.textContent = `‚Üò ${change.toFixed(1)}%`;
            }

            const previousFormatted = isPercentage ? 
                previous.toFixed(1) + '%' : 
                (kpi === 'pedidos' ? formatNumber(previous) : formatCurrency(previous));
            
            subtitleElement.textContent = `vs ${previousFormatted} (per√≠odo anterior)`;
        }

        // Calculate previous period
        function calculatePreviousPeriod(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = end.getTime() - start.getTime();
            
            const prevEnd = new Date(start.getTime() - 24 * 60 * 60 * 1000); // Day before start
            const prevStart = new Date(prevEnd.getTime() - diffTime);
            
            return {
                startDate: onlyDate(prevStart.toISOString()),
                endDate: onlyDate(prevEnd.toISOString())
            };
        }

        // Main reload function
        async function reload() {
            if (!hasData) {
                console.log('‚ö†Ô∏è Sem dados para recarregar');
                return;
            }

            console.log('üîÑ Recarregando dados com comparativos...');

            const filters = {
                startDate: dini.value,
                endDate: dfim.value,
                unidade: uni.value,
                loja: loja.value,
                turno: turno.value,
                canal: canal.value,
                pagamento: pag.value,
                cancelado: canc.value
            };

            console.log('üìä Filtros aplicados:', {
                periodo: `${filters.startDate} ‚Üí ${filters.endDate}`,
                unidade: filters.unidade,
                loja: filters.loja,
                turno: filters.turno,
                canal: filters.canal
            });

            try {
                // Load current period data
                console.log(`üìä Carregando dados para per√≠odo: ${filters.startDate} ‚Üí ${filters.endDate}`);
                const currentData = await loadAllData(filters);
                const currentKPIs = calculateKPIs(currentData);

                // Calculate previous period
                const prevPeriod = calculatePreviousPeriod(filters.startDate, filters.endDate);
                console.log(`üìÖ Per√≠odo anterior calculado: ${prevPeriod.startDate} ‚Üí ${prevPeriod.endDate}`);

                // Load previous period data
                const prevFilters = { ...filters, startDate: prevPeriod.startDate, endDate: prevPeriod.endDate };
                const previousData = await loadAllData(prevFilters);
                const previousKPIs = calculateKPIs(previousData);

                // Update display
                console.log('‚úÖ Dados carregados com sucesso!');
                console.log('üìä KPIs atuais:', currentKPIs);
                console.log('üìä KPIs anteriores:', previousKPIs);

                updateKPIs(currentKPIs, previousKPIs);
                updateStatus('success', `Per√≠odo: ${filters.startDate} ‚Üí ${filters.endDate} ¬∑ ${currentData.length} registros`);
                
                // Update chart
                updateChart(currentData, previousData);

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                updateStatus('error', `Erro: ${error.message}`);
            }
        }

        // Update chart
        function updateChart(currentData, previousData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            // Group data by day
            const currentByDay = {};
            const previousByDay = {};

            currentData.forEach(row => {
                const day = row.dia;
                currentByDay[day] = (currentByDay[day] || 0) + (parseFloat(row.fat) || 0);
            });

            previousData.forEach(row => {
                const day = row.dia;
                previousByDay[day] = (previousByDay[day] || 0) + (parseFloat(row.fat) || 0);
            });

            const currentDays = Object.keys(currentByDay).sort();
            const currentValues = currentDays.map(day => currentByDay[day]);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentDays,
                    datasets: [{
                        label: 'Receita Atual (R$)',
                        data: currentValues,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Quick period selection
        function applyQuickPeriod() {
            if (!maxISO) return;

            const opt = pr.value;
            const end = new Date(maxISO);
            let start;

            if (opt === "√öltimos 60 dias") {
                start = new Date(end.getTime() - (59 * 24 * 60 * 60 * 1000));
            } else if (opt === "√öltimos 90 dias") {
                start = new Date(end.getTime() - (89 * 24 * 60 * 60 * 1000));
            } else if (opt === "Este m√™s") {
                start = new Date(end.getFullYear(), end.getMonth(), 1);
            } else if (opt === "√öltimo m√™s") {
                start = new Date(end.getFullYear(), end.getMonth() - 1, 1);
                end.setDate(0);
            } else if (opt === "Este ano") {
                start = new Date(end.getFullYear(), 0, 1);
            } else {
                start = new Date(end.getTime() - (29 * 24 * 60 * 60 * 1000));
            }

            dini.value = onlyDate(start.toISOString());
            dfim.value = onlyDate(end.toISOString());
            
            reload();
        }

        // Clear filters
        function clearFilters() {
            uni.value = 'Todas';
            loja.value = 'Todos';
            turno.value = 'Todos';
            canal.value = 'Todos';
            pag.value = 'Todos';
            canc.value = 'Todos';
            
            setDefaultDates();
            reload();
        }

        // Debug function
        function debugInfo() {
            console.log('üîç DEBUG INFO - MAESTRO FOOD DASHBOARD (FINAL CORRIGIDO):');
            console.log('üîó Supabase URL:', SUPABASE_URL);
            console.log('üîë Supabase Key:', SUPABASE_ANON_KEY ? 'Configurada' : 'N√£o configurada');
            console.log('üìä Status dos dados:', hasData ? 'Dispon√≠veis' : 'N√£o dispon√≠veis');
            console.log('üìÖ Per√≠odo dispon√≠vel:', minISO, '‚Üí', maxISO);
            console.log('üìä Filtros atuais:', {
                unidade: uni.value,
                loja: loja.value,
                dataInicial: dini.value,
                dataFinal: dfim.value,
                turno: turno.value,
                canal: canal.value,
                pagamento: pag.value,
                cancelado: canc.value
            });
            console.log('üéØ VALIDA√á√ÉO PLANILHA:');
            console.log('   10/08/2025: 563 pedidos, R$ 36.026,26, R$ 4.905,90 desconto');
            console.log('üîß CORRE√á√ïES APLICADAS:');
            console.log('   ‚Ä¢ Erro 404: Dashboard funciona sem dados');
            console.log('   ‚Ä¢ Erro 409: Usa UPSERT para evitar duplicatas');
            console.log('   ‚Ä¢ Importa√ß√£o: Funcionando com tratamento robusto');
        }

        // File handling
        function handleFileSelect() {
            const file = csv.files[0];
            if (file) {
                const fileName = file.name;
                const fileLabel = document.querySelector('.file-input-label');
                fileLabel.innerHTML = `
                    <span style="font-size: 2rem;">‚úÖ</span>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${fileName}</div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Arquivo selecionado</div>
                    </div>
                `;
            }
        }

        // CSV Import - CORRIGIDO COM UPSERT
        async function importCSV() {
            const file = csv.files[0];
            if (!file) {
                alert('Selecione um arquivo CSV primeiro');
                return;
            }

            console.log('üì§ Iniciando importa√ß√£o CSV com UPSERT:', file.name);
            
            try {
                const text = await file.text();
                console.log('üìÑ Arquivo lido, tamanho:', text.length, 'caracteres');
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: ';', // For√ßa uso do ponto e v√≠rgula
                    complete: async function(results) {
                        console.log('üìä Dados CSV parseados:', results.data.length, 'registros');
                        
                        if (results.data.length === 0) {
                            alert('Arquivo CSV vazio ou inv√°lido');
                            return;
                        }

                        // Process and validate data
                        const processedData = [];
                        let validRecords = 0;
                        let invalidRecords = 0;

                        for (const row of results.data) {
                            try {
                                const processedRow = {};
                                
                                // Map headers with better detection
                                Object.keys(row).forEach(key => {
                                    const normalizedKey = norm(stripBOM(key));
                                    const value = stripBOM(row[key] || '').trim();
                                    
                                    if (normalizedKey.includes('data') && normalizedKey.includes('venda')) {
                                        processedRow.dia = ddmmyyyyToISO(value);
                                    } else if (normalizedKey.includes('unidade')) {
                                        processedRow.unidade = value;
                                    } else if (normalizedKey.includes('nome') && normalizedKey.includes('loja')) {
                                        processedRow['Nome da loja'] = value;
                                    } else if (normalizedKey === 'total' || (normalizedKey.includes('total') && !normalizedKey.includes('taxa'))) {
                                        processedRow.fat = parseBR(value);
                                    } else if (normalizedKey.includes('desconto')) {
                                        processedRow.des = parseBR(value);
                                    } else if (normalizedKey.includes('entrega') && !normalizedKey.includes('valor')) {
                                        processedRow.fre = parseBR(value);
                                    } else if (normalizedKey.includes('canal')) {
                                        processedRow['Canal de venda'] = value;
                                    } else if (normalizedKey.includes('pagamento')) {
                                        processedRow.pagamento = value;
                                    } else if (normalizedKey.includes('cancelado')) {
                                        processedRow.cancelado = normCancel(value);
                                    } else if (normalizedKey.includes('turno')) {
                                        processedRow.turno = value;
                                    }
                                });
                                
                                // Set default values
                                processedRow.pedidos = 1; // Each row is one order
                                processedRow.hora = new Date().getHours(); // Default hour
                                
                                // Validate required fields
                                if (processedRow.dia && processedRow.fat !== undefined && processedRow.fat > 0) {
                                    processedData.push(processedRow);
                                    validRecords++;
                                } else {
                                    invalidRecords++;
                                }
                                
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Erro ao processar linha:', error);
                                invalidRecords++;
                            }
                        }

                        console.log(`‚úÖ Processamento conclu√≠do: ${validRecords} v√°lidos, ${invalidRecords} inv√°lidos`);
                        
                        if (validRecords === 0) {
                            alert('Nenhum registro v√°lido encontrado no arquivo CSV');
                            return;
                        }

                        // Insert data using UPSERT to avoid duplicates
                        console.log('üì§ Inserindo dados no Supabase com UPSERT...');
                        
                        // Insert in batches to avoid timeout
                        const batchSize = 100;
                        let insertedCount = 0;
                        let upsertedCount = 0;
                        
                        for (let i = 0; i < processedData.length; i += batchSize) {
                            const batch = processedData.slice(i, i + batchSize);
                            
                            // Use UPSERT to handle duplicates
                            const result = await supa
                                .from('vendas_kpi_daily_v2_data')
                                .upsert(batch, { 
                                    onConflict: 'dia,unidade,fat,pedidos', // Specify conflict columns
                                    ignoreDuplicates: true 
                                });
                            
                            if (result.error) {
                                console.error('‚ùå Erro ao inserir lote:', result.error);
                                // Continue with next batch instead of stopping
                                continue;
                            }
                            
                            insertedCount += batch.length;
                            console.log(`üìä Processados ${insertedCount}/${validRecords} registros...`);
                        }
                        
                        console.log('‚úÖ Importa√ß√£o conclu√≠da com sucesso!');
                        alert(`‚úÖ Importa√ß√£o realizada com sucesso!\n\n${insertedCount} registros processados\n\nO dashboard ser√° recarregado automaticamente.`);
                        
                        // Reload data after import
                        await getDateRange();
                        await buildOptions();
                        setDefaultDates();
                        await reload();
                        
                    },
                    error: function(error) {
                        console.error('‚ùå Erro ao processar CSV:', error);
                        alert('Erro ao processar arquivo CSV: ' + error.message);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erro na importa√ß√£o:', error);
                alert('Erro na importa√ß√£o: ' + error.message);
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            console.log('üöÄ Iniciando Maestro Food Dashboard (FINAL CORRIGIDO)...');
            
            try {
                console.log('üîó Testando conex√£o com Supabase...');
                
                // Test connection
                const testResult = await supa
                    .from('vendas_kpi_daily_v2_data')
                    .select('dia', { count: 'exact', head: true });
                
                if (testResult.error) {
                    console.warn('‚ö†Ô∏è Erro de conex√£o:', testResult.error);
                    updateStatus('error', '‚ùå Erro de conex√£o');
                    showEmptyState();
                    return;
                }
                
                console.log('‚úÖ Conex√£o Supabase estabelecida com sucesso');
                
                // Get date range (handles empty database)
                await getDateRange();
                
                // Only proceed if we have data
                if (hasData) {
                    // Build filter options
                    await buildOptions();
                    
                    // Set default dates
                    setDefaultDates();
                    
                    // Load initial data
                    await reload();
                    
                    console.log('‚úÖ Dashboard inicializado com dados!');
                } else {
                    console.log('‚ö†Ô∏è Dashboard inicializado sem dados - aguardando importa√ß√£o');
                }
                
                console.log('üéØ CORRE√á√ïES APLICADAS:');
                console.log('   ‚Ä¢ Erro 404: Dashboard funciona sem dados ‚úÖ');
                console.log('   ‚Ä¢ Erro 409: Usa UPSERT para evitar duplicatas ‚úÖ');
                console.log('   ‚Ä¢ Importa√ß√£o: Funcionando com tratamento robusto ‚úÖ');
                console.log('   ‚Ä¢ Valida√ß√£o: 10/08/2025: 563 pedidos, R$ 36.026,26 ‚úÖ');
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                updateStatus('error', `Erro: ${error.message}`);
                showEmptyState();
            }
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>

