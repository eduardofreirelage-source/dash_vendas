<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Vendas • Dashboard + Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- evita 404 do favicon -->
  <link rel="icon" href="data:,">
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
  <!-- SheetJS para XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --fg:#f9fafb; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --accent:#38bdf8; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .wrap { max-width:1200px; margin:24px auto; padding:0 16px; }
    h1{ font-size:20px; margin:0 0 16px; }
    .row{ display:flex; gap:16px; flex-wrap:wrap; }
    .card{ background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:14px; }
    .grow{ flex:1 1 0; min-width:260px }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px }
    input,select,button{ background:#0b1220; color:var(--fg); border:1px solid #283042; border-radius:10px; padding:8px 10px; }
    select[multiple]{ height:140px; }
    button{ cursor:pointer; }
    button.primary{ background:linear-gradient(135deg,#0ea5e9,#22d3ee); border:0; color:black; font-weight:700 }
    .kpi{ display:grid; grid-template-columns:repeat(4, minmax(140px,1fr)); gap:14px; }
    .kpi .tile{ padding:12px; border-radius:12px; background:#0b1220; border:1px solid #1f2937 }
    .kpi .big{ font-size:18px; font-weight:800 }
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) } .muted{ color:var(--muted) }
    pre#debug{ white-space:pre-wrap; max-height:340px; overflow:auto; background:#0b1220; padding:12px; border-radius:10px; border:1px solid #1f2937 }
    .row .card h2{ margin:0 0 10px; font-size:16px }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
    .bar{ display:flex; gap:8px; flex-wrap:wrap }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Vendas — Upload, Filtros & KPI</h1>

  <!-- Conexão + Datas -->
  <div class="row">
    <div class="card">
      <h2>Conexão</h2>
      <div class="grid2">
        <div>
          <label>Supabase URL</label>
          <input id="sbUrl" value="https://uahmcfzerofhzjvlzrqc.supabase.co" style="width:360px">
        </div>
        <div>
          <label>Anon Key</label>
          <input id="sbKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU" style="width:560px">
        </div>
      </div>
      <div class="bar" style="margin-top:10px">
        <button id="btnConnect" class="primary">Conectar / Ping</button>
        <span class="hint">O ping usa <code>data_venda</code> (não depende de <code>id</code>).</span>
      </div>
    </div>

    <div class="card grow">
      <h2>Período</h2>
      <div class="grid2">
        <div>
          <label>De</label>
          <input id="dini" type="date">
        </div>
        <div>
          <label>Até</label>
          <input id="dfim" type="date">
        </div>
      </div>
      <div class="bar" style="margin-top:10px">
        <button id="btnAutoDates">Auto (min/max)</button>
        <button id="btnLoadFilters">Recarregar listas</button>
        <span class="hint">Busca min/max direto da tabela <code>vendas_import_csv_v2</code>.</span>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="row">
    <div class="card grow">
      <h2>Filtros</h2>
      <div class="row">
        <div>
          <label>Unidades</label>
          <select id="selUnid" multiple></select>
        </div>
        <div>
          <label>Lojas</label>
          <select id="selLoja" multiple></select>
        </div>
        <div>
          <label>Turnos</label>
          <select id="selTurno" multiple></select>
        </div>
        <div>
          <label>Canais</label>
          <select id="selCanal" multiple></select>
        </div>
        <div>
          <label>Pagamentos</label>
          <select id="selPag" multiple></select>
        </div>
      </div>
      <div class="bar" style="margin-top:10px">
        <button id="btnKpi" class="primary">Calcular KPI + Smoke</button>
        <span class="hint">Os filtros enviam arrays <code>text[]</code> (lowercase) para os RPCs v2.</span>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row">
    <div class="card grow">
      <h2>KPIs</h2>
      <div class="kpi">
        <div class="tile">
          <div class="muted">Pedidos</div>
          <div id="kpiPed" class="big">—</div>
        </div>
        <div class="tile">
          <div class="muted">Faturamento</div>
          <div id="kpiFat" class="big">—</div>
        </div>
        <div class="tile">
          <div class="muted">Descontos</div>
          <div id="kpiDes" class="big">—</div>
        </div>
        <div class="tile">
          <div class="muted">Frete</div>
          <div id="kpiFre" class="big">—</div>
        </div>
      </div>
      <div class="hint" id="smoke">Smoke: —</div>
    </div>
  </div>

  <!-- Upload Excel -->
  <div class="row">
    <div class="card grow">
      <h2>Upload Excel → public.vendas_import_csv_v2</h2>
      <div class="row">
        <div>
          <label>Arquivo (.xlsx)</label>
          <input id="fileXlsx" type="file" accept=".xlsx" />
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="bar">
            <button id="btnValidar">Validar arquivo</button>
            <button id="btnCarregar" class="primary">Carregar no banco</button>
          </div>
        </div>
      </div>
      <div class="hint" style="margin-top:6px">
        Mapeamento automático das colunas (exige <b>Data</b> com data+hora). Ex.: <code>01/05/2025 11:01</code>
      </div>
      <pre id="preview" class="card" style="margin-top:10px; background:#0b1220"></pre>
    </div>
  </div>

  <!-- Debug -->
  <div class="row">
    <div class="card grow">
      <h2>Debug</h2>
      <pre id="debug"></pre>
    </div>
  </div>
</div>

<script>
(function(){
  // Estado
  let supabaseClient = null;
  let lastRows = []; // linhas parseadas do Excel (após validação)
  const TBL = 'vendas_import_csv_v2';

  const $ = (id)=>document.getElementById(id);
  const addLog = (msg) => {
    const ts = new Date().toTimeString().slice(0,8);
    $('debug').textContent = `[${ts}] ${msg}\n` + $('debug').textContent;
  };

  const money = (n)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n||0);

  // Inicial
  $('btnConnect').onclick = connectAndPing;
  $('btnAutoDates').onclick = autoDates;
  $('btnLoadFilters').onclick = () => loadFilters();
  $('btnKpi').onclick = runKpiAndSmoke;
  $('btnValidar').onclick = validarArquivo;
  $('btnCarregar').onclick = carregarBanco;

  // Conexão / Ping
  async function connectAndPing(){
    try{
      const url = $('sbUrl').value.trim();
      const key = $('sbKey').value.trim();
      supabaseClient = supabase.createClient(url, key, { auth: { persistSession:false }});
      addLog('✅ Supabase client ok');

      // Ping sem depender de 'id'
      const { data, error } = await supabaseClient
        .from(TBL)
        .select('data_venda')
        .limit(1);

      if(error) addLog(`⚠️ ping erro\n${JSON.stringify(error,null,2)}`);
      else addLog('✅ ping ok');
    }catch(e){
      console.error(e);
      addLog(`❌ erro conectar\n${e.message||e}`);
    }
  }

  // Datas min/max a partir da tabela
  async function autoDates(){
    if(!supabaseClient){ await connectAndPing(); }
    const hdr = { count:'exact' };
    const qmin = supabaseClient.from(TBL).select('data_venda').order('data_venda',{ascending:true}).limit(1);
    const qmax = supabaseClient.from(TBL).select('data_venda').order('data_venda',{ascending:false}).limit(1);
    const [rmin,rmax] = await Promise.all([qmin, qmax]);
    const min = rmin.data?.[0]?.data_venda || '';
    const max = rmax.data?.[0]?.data_venda || '';
    if(min) $('dini').value = min;
    if(max) $('dfim').value = max;
    addLog(`🗓️ Intervalo auto {"minDia":"${min}","maxDia":"${max}"}`);
  }

  // Helpers de filtros
  const norm = (s)=> (s ?? '').toString().trim().toLowerCase();
  function getSelValues(id){
    const opts = Array.from($(id).selectedOptions||[]);
    if(opts.length===0) return null;
    return opts.map(o => norm(o.value)).filter(Boolean);
  }
  function setOptions(id, values){
    const sel = $(id);
    sel.innerHTML = '';
    values.forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
  }

  // Carrega listas (distintos) da própria tabela no período
  async function loadFilters(){
    if(!supabaseClient){ await connectAndPing(); }
    const dini = $('dini').value || '1900-01-01';
    const dfim = $('dfim').value || '3000-12-31';

    async function distinct(col){
      const { data, error } = await supabaseClient
        .from(TBL)
        .select(col)
        .gte('data_venda', dini)
        .lte('data_venda', dfim)
        .limit(100000);
      if(error){ addLog(`⚠️ distinct ${col} ${JSON.stringify(error)}`); return []; }
      const set = new Set();
      (data||[]).forEach(r=>{
        const v = (r[col] ?? '').toString().trim();
        if(v) set.add(v);
      });
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    }

    const [unids,lojas,turnos,canais,pags] = await Promise.all([
      distinct('unidade'),
      distinct('loja'),
      distinct('turno'),
      distinct('canal'),
      distinct('pagamento')
    ]);

    setOptions('selUnid', unids);
    setOptions('selLoja', lojas);
    setOptions('selTurno', turnos);
    setOptions('selCanal', canais);
    setOptions('selPag', pags);

    addLog(`🔎 Listas carregadas {\n  "unids": ${unids.length},\n  "lojas": ${lojas.length},\n  "turnos": ${turnos.length},\n  "canais": ${canais.length},\n  "pags": ${pags.length}\n}`);
  }

  // Chama KPIs e gráficos (RPC v2)
  async function runKpiAndSmoke(){
    if(!supabaseClient){ await connectAndPing(); }
    const dini = $('dini').value || '1900-01-01';
    const dfim = $('dfim').value || '3000-12-31';

    const p_unids = getSelValues('selUnid');
    const p_lojas = getSelValues('selLoja');
    const p_turnos = getSelValues('selTurno');
    const p_canais = getSelValues('selCanal');
    const p_pags  = getSelValues('selPag');
    const p_cancelado = null; // você pode ligar a um checkbox depois

    const args = { p_dini:dini, p_dfim:dfim, p_unids, p_lojas, p_turnos, p_canais, p_pags, p_cancelado };

    // KPI
    const k = await supabaseClient.rpc('kpi_vendas_v2', args);
    if(k.error){ addLog(`❌ KPI erro\n${JSON.stringify(k.error,null,2)}`); return; }
    const kpi = Array.isArray(k.data)? k.data[0] : k.data;
    $('kpiPed').textContent = (kpi?.pedidos ?? 0).toLocaleString('pt-BR');
    $('kpiFat').textContent = money(kpi?.fat ?? 0);
    $('kpiDes').textContent = money(kpi?.des ?? 0);
    $('kpiFre').textContent = money(kpi?.fre ?? 0);

    // Smoke: soma dos gráficos deve bater com KPI.fat
    const [d,m,h] = await Promise.all([
      supabaseClient.rpc('chart_vendas_dow_v2', args),
      supabaseClient.rpc('chart_vendas_mes_v2', args),
      supabaseClient.rpc('chart_vendas_hora_v2', args)
    ]);
    const sum = (arr, key) => (Array.isArray(arr)? arr.reduce((a,r)=>a + Number(r[key]||0), 0) : 0);
    const dow = sum(d.data||[], 'total');
    const mes = sum(m.data||[], 'total');
    const hora= sum(h.data||[], 'total');
    const fat = Number(kpi?.fat || 0);
    const ok = Math.abs(dow-fat)<0.01 && Math.abs(mes-fat)<0.01 && Math.abs(hora-fat)<0.01;

    $('smoke').innerHTML = `🧪 Smoke { "dow": ${dow.toFixed(2)}, "mes": ${mes.toFixed(2)}, "hora": ${hora.toFixed(2)}, "fat": ${fat.toFixed(2)}, "ok": ${ok} }`;
    addLog(`→ KPI params ${JSON.stringify(args,null,2)}`);
  }

  // ====== UPLOAD XLSX ======
  function parseExcelToRows(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type:'array' });
          const sheetName = wb.SheetNames[0]; // usa a primeira (ex.: UNIFICADA)
          const ws = wb.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(ws, { defval:null, raw:true });

          // Mapeia colunas (aceita variações) e converte "Data" => data_venda/hora
          const out = json.map((r)=>{
            // data/hora
            let dtRaw = r['Data'] ?? r['data'] ?? r['data_venda'] ?? null;
            let data_venda = null, hora = null;
            if(dtRaw){
              if(typeof dtRaw === 'string'){
                // tenta "dd/mm/yyyy HH:MM"
                const m = dtRaw.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
                if(m){
                  const [_,dd,mm,yyyy,HH,MM] = m;
                  data_venda = `${yyyy}-${mm}-${dd}`;
                  hora = parseInt(HH,10);
                }else{
                  // tenta Date parse do Excel
                  const d = new Date(dtRaw);
                  if(!isNaN(d)){
                    data_venda = d.toISOString().slice(0,10);
                    hora = d.getHours();
                  }
                }
              }else if(typeof dtRaw === 'number'){
                // Excel serial date
                const d = XLSX.SSF.parse_date_code(dtRaw);
                if(d){
                  const yyyy = String(d.y);
                  const mm   = String(d.m).padStart(2,'0');
                  const dd   = String(d.d).padStart(2,'0');
                  const HH   = String(d.H).padStart(2,'0');
                  data_venda = `${yyyy}-${mm}-${dd}`;
                  hora = parseInt(HH,10);
                }
              }
            }

            const unidade   = r['Unidade'] ?? r['unidade'] ?? null;
            const loja      = r['loja'] ?? r['Nome da loja'] ?? r['Nome da Loja'] ?? r['Consumidor'] ?? null;
            const canal     = r['Canal'] ?? r['Canal de venda'] ?? r['canal'] ?? null;
            const cancelado = (()=>{
              const v = (r['Cancelado'] ?? r['Está cancelado'] ?? r['cancelado'] ?? '').toString().trim().toLowerCase();
              if(v === 's' || v === 'sim' || v === 'true' || v === '1') return true;
              if(v === 'n' || v === 'não' || v === 'nao' || v === 'false' || v === '0') return false;
              return false; // default
            })();
            const itens     = Number(r['Itens'] ?? r['itens'] ?? r['Pedido'] ?? 1) || 1;
            const total     = Number(r['Total'] ?? r['total'] ?? 0) || 0;
            const des       = Number(r['Desconto'] ?? r['des'] ?? r['desconto'] ?? 0) || 0;
            const fre       = Number(r['Entrega'] ?? r['fre'] ?? r['entrega'] ?? 0) || 0;
            const turno     = r['Turno'] ?? r['turno'] ?? null;
            const pagamento = r['Pagamento'] ?? r['pagamento'] ?? null;

            return {
              data_venda, hora,
              unidade, loja, canal,
              cancelado, itens, total, des, fre,
              turno, pagamento
            };
          }).filter(x => x.data_venda && x.hora !== null);

          resolve({ rows: out, sheet: sheetName, totalLinhas: json.length });
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  async function validarArquivo(){
    try{
      if(!supabaseClient){ await connectAndPing(); }
      const f = $('fileXlsx').files?.[0];
      if(!f){ addLog('⚠️ Selecione um arquivo .xlsx'); return; }

      const { rows, sheet, totalLinhas } = await parseExcelToRows(f);
      lastRows = rows;

      // Prévia (5 linhas)
      $('preview').textContent = [
        `📄 Arquivo lido { "nome": "${f.name}", "sheet": "${sheet}", "linhas": ${totalLinhas} }`,
        '🔧 Amostra mapeada (5 primeiras):',
        JSON.stringify(rows.slice(0,5), null, 2)
      ].join('\n');

      addLog(`📄 Arquivo lido\n${JSON.stringify({nome:f.name,sheet,linhas:totalLinhas},null,2)}`);
      addLog(`✅ Prévia pronta (${rows.length} linhas válidas com data/hora)`);
    }catch(e){
      console.error(e);
      addLog(`❌ Validação falhou\n${e.message||e}`);
    }
  }

  async function carregarBanco(){
    try{
      if(!supabaseClient){ await connectAndPing(); }
      if(!lastRows.length){ addLog('⚠️ Valide o arquivo antes de carregar.'); return; }

      // Verifica acesso / política
      const ping = await supabaseClient.from(TBL).select('data_venda').limit(1);
      if(ping.error){ addLog(`⚠️ Tabela inacessível\n${JSON.stringify(ping.error,null,2)}`); return; }
      addLog('✅ Tabela acessível');

      // Inserção em lotes
      const BATCH = 2000;
      let ok=0, fail=0;
      for(let i=0; i<lastRows.length; i+=BATCH){
        const slice = lastRows.slice(i, i+BATCH);
        const { error } = await supabaseClient.from(TBL).insert(slice, { returning:'minimal' });
        if(error){
          fail += slice.length;
          addLog(JSON.stringify({ lote:[i, Math.min(i+BATCH,lastRows.length)], error }, null, 2));
        }else{
          ok += slice.length;
          addLog(JSON.stringify({ lote:[i, Math.min(i+BATCH,lastRows.length)] }, null, 2));
        }
      }
      addLog(`📦 Inserção concluída\n${JSON.stringify({ok, fail}, null, 2)}`);

      // Após carga, ajustar datas e filtros
      await autoDates();
      await loadFilters();
    }catch(e){
      console.error(e);
      addLog(`❌ Carga falhou\n${e.message||e}`);
    }
  }

  // Auto: conecta e tenta popular datas/filtros
  (async()=>{
    await connectAndPing();
    await autoDates().catch(()=>{});
    await loadFilters().catch(()=>{});
  })();

})();
</script>
</body>
</html>
