<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Vendas (Supabase)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <style>
      :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280; }
      html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif; }
      .wrap { max-width: 960px; margin: 24px auto; padding: 0 16px; }
      .h1 { font-size: 24px; font-weight: 700; margin: 0 0 4px; }
      .muted { color: var(--muted); font-size: 12px; }
      .grid { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:12px; margin-top:12px; }
      .card { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
      .title { font-size:12px; color:var(--muted); }
      .val { font-size:22px; font-weight:700; margin-top:4px; }
      pre.log { background:#0b1020; color:#d1e7ff; padding:12px; border-radius:8px; overflow:auto; border:1px solid #1f2937; }
      code { background:#eef2ff; padding:0 4px; border-radius:4px; }
      @media (max-width: 820px) { .grid{grid-template-columns: repeat(2,minmax(0,1fr));} }
      @media (max-width: 480px) { .grid{grid-template-columns: 1fr;} }
    </style>
    <!-- Supabase UMD (sem build, sem Babel) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;">
        <div>
          <div class="h1">Dashboard Vendas — Supabase</div>
          <div class="muted">Fonte automática: tenta <code>public.vendas</code>; se vazia, usa <code>public.vendas_import_csv</code>.</div>
        </div>
        <div class="muted" id="periodo">Período: —</div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="card"><div class="title">Pedidos</div><div class="val" id="k_ped">—</div></div>
        <div class="card"><div class="title">Faturamento</div><div class="val" id="k_fat">—</div></div>
        <div class="card"><div class="title">Incentivos</div><div class="val" id="k_desc">—</div></div>
        <div class="card"><div class="title">Frete</div><div class="val" id="k_fre">—</div></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="title">Status / Logs</div>
        <pre class="log" id="log">Iniciando…</pre>
      </div>
    </div>

    <script>
      // ====== SUAS CREDENCIAIS (fixas, sem objeto literal pra não dar erro de sintaxe) ======
      const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";

      const logEl = document.getElementById("log");
      const out = (msg) => { logEl.textContent += "\\n" + msg; };
      logEl.textContent = "[Boot] Carregando…";

      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // formatação
      const fmtBRL = (n) => new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(Number(n)||0);
      const fmtInt = (n) => new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(Math.round(Number(n)||0));

      // leitura robusta (aceita número ou string "123,45"/"123.45")
      function toNum(x) {
        if (x == null || x === "") return 0;
        if (typeof x === "number") return x;
        const s = String(x).trim();
        if (!s) return 0;
        // tenta manter ponto como decimal, e se houver vírgula decimal, troca por ponto
        const t = s.replace(/\\./g, "").replace(/,/g, ".");
        const n = Number(t);
        return Number.isFinite(n) ? n : 0;
      }

      async function pickTable() {
        // tenta public.vendas
        out("[Detect] Tentando usar tabela/view: public.vendas …");
        let { data, error } = await supa.from("vendas").select("data_venda").limit(1);
        if (!error && Array.isArray(data) && data.length > 0) {
          out("[Detect] OK: usando public.vendas");
          return "vendas";
        }
        if (error) out("[Detect] vendas erro: " + (error.message || JSON.stringify(error)));

        // fallback para public.vendas_import_csv
        out("[Detect] Tentando public.vendas_import_csv …");
        ({ data, error } = await supa.from("vendas_import_csv").select("data_venda").limit(1));
        if (!error && Array.isArray(data) && data.length > 0) {
          out("[Detect] OK: usando public.vendas_import_csv");
          return "vendas_import_csv";
        }
        if (error) out("[Detect] vendas_import_csv erro: " + (error.message || JSON.stringify(error)));

        throw new Error("Nenhuma tabela com dados encontrada (vendas / vendas_import_csv).");
      }

      async function getLastDay(tbl) {
        const { data, error } = await supa.from(tbl).select("data_venda").order("data_venda", { ascending:false }).limit(1);
        if (error) throw error;
        const last = data?.[0]?.data_venda;
        if (!last) throw new Error(`Tabela ${tbl} não possui data_venda.`);
        return last; // "YYYY-MM-DD"
      }

      async function fetchRange(tbl, fromISO, toISO) {
        const page = 5000;
        let outRows = [];
        for (let from = 0; ; from += page) {
          const to = from + page - 1;
          const { data, error } = await supa
            .from(tbl)
            .select("data_venda, valor_total, desconto, entrega", { count: "exact" })
            .gte("data_venda", fromISO)
            .lte("data_venda", toISO)
            .order("data_venda", { ascending: true })
            .range(from, to);
          if (error) throw error;
          if (!data || data.length === 0) break;
          outRows = outRows.concat(data);
          if (data.length < page) break;
        }
        return outRows;
      }

      (async function main() {
        try {
          out("[Boot] Iniciando…");
          const tbl = await pickTable();
          const last = await getLastDay(tbl);
          out(`[Info] Último dia com venda em ${tbl}: ${last}`);

          const end = new Date(last + "T23:59:59");
          const start = new Date(end); start.setDate(end.getDate() - 29);
          const toISO = (d) => d.toISOString().slice(0,10);

          document.getElementById("periodo").textContent = "Período: " + toISO(start) + " → " + toISO(end);
          out(`[Query] Intervalo: ${toISO(start)} → ${toISO(end)}`);

          const rows = await fetchRange(tbl, toISO(start), toISO(end));
          out(`[Query] Linhas retornadas: ${rows.length.toLocaleString("pt-BR")}`);

          let pedidos = rows.length;
          let faturamento = 0, descontos = 0, frete = 0;
          for (const r of rows) {
            faturamento += toNum(r.valor_total);
            descontos  += toNum(r.desconto);
            frete      += toNum(r.entrega);
          }

          document.getElementById("k_ped").textContent = fmtInt(pedidos);
          document.getElementById("k_fat").textContent = fmtBRL(faturamento);
          document.getElementById("k_desc").textContent = fmtBRL(descontos);
          document.getElementById("k_fre").textContent = fmtBRL(frete);

          out("[OK] KPIs calculados com sucesso.");
        } catch (err) {
          out("[ERRO] " + (err?.message || String(err)));
        }
      })();
    </script>
  </body>
</html>
