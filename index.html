<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maestro Food</title>
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><circle cx="64" cy="64" r="62" fill="%231a73e8"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="64" fill="white">M</text></svg>'/>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--muted:#667085;--text:#0f172a;--blue:#1a73e8;--stroke:#e6eaf2;--radius:14px}
    body{background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .container{max-width:1200px;margin:24px auto 64px;padding:0 16px}
    h1{font-size:24px;font-weight:700;margin:8px 0 4px}
    small.muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:14px}
    .card.dashed{border-style:dashed}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,button{appearance:none;border:1px solid var(--stroke);background:#fff;color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
    select[multiple]{height:140px}
    .inline{display:flex;gap:10px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#eef3ff;color:#1747b7}
    .grid-kpi{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .kpi h3{font-size:12px;color:var(--muted);margin:0 0 8px}
    .kpi b{font-size:22px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef3ff;color:#1747b7;font-weight:600}
    .right{text-align:right}
    .hint{color:var(--muted);font-size:12px}
    .status{font-size:12px}
    @media (max-width:960px){.grid-kpi{grid-template-columns:repeat(2,1fr)}.cols-4,.cols-3,.cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>Maestro Food</h1>
    <small id="periodo" class="muted">Período: —</small>

    <details id="fx" class="card" open>
      <summary class="inline" style="justify-content:space-between;">
        <b>FILTROS</b>
        <div class="inline">
          <button id="btnLimpar" class="btn ghost" type="button">Limpar</button>
        </div>
      </summary>

      <div class="row cols-2" style="margin-top:12px;">
        <div><label>Unidade</label><select id="fUnidade"></select></div>
        <div><label>Nome da loja</label><select id="fLoja"></select></div>
      </div>

      <div class="row cols-4" style="margin-top:8px;">
        <div><label>De</label><input id="fDini" type="date"/></div>
        <div><label>Até</label><input id="fDfim" type="date"/></div>
        <div>
          <label>Período rápido</label>
          <select id="fQuick">
            <option selected>Últimos 30</option>
            <option>Últimos 60</option>
            <option>Últimos 90</option>
            <option>Este mês</option>
            <option>Último mês</option>
            <option>Este ano</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="fTurno" multiple>
            <option>Manhã</option><option>Tarde</option><option>Noite</option><option>Madrugada</option>
          </select>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px;">
        <div><label>Canal de venda</label><select id="fCanal" multiple></select></div>
        <div><label>Pagamento</label><select id="fPag" multiple></select></div>
        <div>
          <label>Está cancelado?</label>
          <select id="fCanc"><option>Todos</option><option>Não</option><option>Sim</option></select>
        </div>
      </div>

      <div class="card dashed" style="margin-top:12px;">
        <div class="row cols-2">
          <div class="inline"><label style="margin:0;">Admin — Importar CSV (<b>Pasta2.csv</b>)</label></div>
          <div class="right status" id="importStatus"></div>
        </div>
        <div class="inline" style="margin-top:8px;">
          <input id="csv" type="file" accept=".csv,text/csv"/>
          <button id="btnImport" class="btn" type="button">Importar CSV (incremental)</button>
        </div>
        <p class="hint" style="margin-top:8px;">
          Limpo apenas o intervalo de datas do arquivo e insiro com deduplicação por chave composta
          (<b>dia + unidade + "Nome da loja" + hora + pagamento + "Canal de venda"</b>).
          Mínimo aceito no CSV: <b>Data/Dia</b>, <b>unidade</b>, <b>Total/fat</b>.
        </p>
      </div>
    </details>

    <div class="grid-kpi" style="margin-top:14px;">
      <div class="card kpi"><h3>Pedidos</h3><b id="kPedidos">—</b></div>
      <div class="card kpi"><h3>Ticket Médio</h3><b id="kTicket">—</b></div>
      <div class="card kpi"><h3>Faturamento</h3><b id="kFat">—</b></div>
      <div class="card kpi"><h3>Faturamento Médio (dia)</h3><b id="kFatDia">—</b></div>
      <div class="card kpi"><h3>Incentivos</h3><b id="kDes">—</b></div>
      <div class="card kpi"><h3>Incentivos %</h3><b id="kDesPct">—</b></div>
      <div class="card kpi"><h3>Frete</h3><b id="kFre">—</b></div>
      <div class="card kpi"><h3>Faturamento Líquido</h3><b id="kFatLiq">—</b></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="inline" style="justify-content:space-between;">
        <b>Receita diária (R$)</b>
        <div class="inline">
          <span class="pill">Total</span>
        </div>
      </div>
      <div style="height:320px;margin-top:8px;">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Bibliotecas (sem defer/async) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <!-- App -->
  <script>
  (function startWhenReady(){
    function ready(){ return typeof window.supabase !== "undefined"; }
    if(!ready()){ window.addEventListener('load', ()=>{ if(ready()) boot(); }); } else { boot(); }

    function boot(){
      // ===== CONFIG =====
      const SUPABASE_URL  = "https://uahmcfzerofhzjvlzrqc.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaG1jZnplcm9maHpqdmx6cnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTg2MzQsImV4cCI6MjA3MDczNDYzNH0.lPVr3wmrXAmSMY5j7JFy6mI87T3I2TxhVKV-gLc7_VU";
      const TABLE  = "vendas_kpi_daily_v2_data";   // use a TABELA (não view)
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

      // ===== DOM =====
      const el=(id)=>document.getElementById(id);
      const periodoEl=el("periodo");
      const uni=el("fUnidade"), loja=el("fLoja"), dini=el("fDini"), dfim=el("fDfim"),
            pr=el("fQuick"), turno=el("fTurno"), canal=el("fCanal"), pag=el("fPag"), canc=el("fCanc");
      const btnLimpar=el("btnLimpar"), csv=el("csv"), btnImport=el("btnImport"), importStatus=el("importStatus");
      const kPedidos=el("kPedidos"), kTicket=el("kTicket"), kFat=el("kFat"), kFatDia=el("kFatDia"),
            kDes=el("kDes"), kDesPct=el("kDesPct"), kFre=el("kFre"), kFatLiq=el("kFatLiq");
      const chartEl=el("chart"); let chart=null;

      // ===== STATE =====
      let minISO=null, maxISO=null, lastData=[];

      // ===== HELPERS =====
      const fmtBRL=(v)=> (isFinite(v)? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : "—");
      const fmtPct=(v)=> (isFinite(v)? (v*100).toFixed(1).replace('.',',')+'%' : "—");
      const toISO=(d)=>{ try{ const t=new Date(d); if(!isFinite(t)) return null; return t.toISOString().slice(0,10);}catch(_){return null;} };
      const onlyDateISO=(iso)=> iso && iso.length>=10 ? iso.slice(0,10) : iso;
      const parseBR=(x)=>{ if(x==null||x==='')return 0; if(typeof x==='number')return x; const s=String(x).trim().replace(/\./g,'').replace(',','.'); const n=Number(s); return isFinite(n)?n:0; };
      const norm=(s)=> String(s??"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();
      const normCancel=(v)=>{const s=String(v??"").trim().toLowerCase(); if(v===true||s==="sim"||s==="s"||s==="1"||s==="true")return"Sim"; return"Não";};
      function ddmmyyyyToISO(s){ if(!s)return null; const str=String(s).trim(); const [datePart,timePart]=str.split(' '); const [d,m,y]=datePart.split('/'); const day=+d, mon=+m, yr=+y; if(!day||!mon||!yr||mon<1||mon>12||day<1||day>31) return null; const iso=`${String(yr).padStart(4,'0')}-${String(mon).padStart(2,'0')}-${String(day).padStart(2,'0')}`; const test=new Date(iso); if(test.getUTCFullYear()!==yr || (test.getUTCMonth()+1)!==mon || test.getUTCDate()!==day) return null; return `${iso}${timePart? 'T'+timePart+':00' : 'T00:00:00'}`;}
      function hourFromDateText(s){ const str=String(s??''); const parts=str.split(' '); if(parts[1]&&parts[1].includes(':')){ const [hh]=parts[1].split(':'); const h=parseInt(hh,10); return isFinite(h)?h:-1 } return -1 }
      function applyQuickDate(){ if(!maxISO||!minISO){ const end=new Date(); const start=new Date(end); start.setDate(end.getDate()-29); dini.value=toISO(start); dfim.value=toISO(end); return; } const opt=pr.value; const end=new Date(maxISO); let start; if(opt.startsWith("Últimos ")){ const n=parseInt(opt.split(' ')[1],10)||30; start=new Date(end); start.setDate(end.getDate()-(n-1)); } else if(opt==="Este mês"){ start=new Date(end.getFullYear(),end.getMonth(),1); } else if(opt==="Último mês"){ start=new Date(end.getFullYear(),end.getMonth()-1,1); const e=new Date(end.getFullYear(),end.getMonth(),0); dini.value=toISO(start); dfim.value=toISO(e); return; } else if(opt==="Este ano"){ start=new Date(end.getFullYear(),0,1); } else { start=new Date(end); start.setDate(end.getDate()-29); } dini.value=toISO(start); dfim.value=toISO(end); }

      async function fetchAll(q, step=50000){
        let from = 0, to = step-1, out = [];
        for(;;){
          const { data, error } = await q.range(from, to);
          if (error){ console.error('[fetchAll]', error); break; }
          out = out.concat(data||[]);
          if (!data || data.length < step) break;
          from += step; to += step;
          if (from > 1_000_000){ console.warn('[fetchAll] stop safeguard'); break; }
        }
        return out;
      }

      async function fetchMinMax(){
        const a=await supa.from(TABLE).select('dia').order('dia',{ascending:true}).limit(1);
        const b=await supa.from(TABLE).select('dia').order('dia',{ascending:false}).limit(1);
        if(!a.error && a.data?.length && !b.error && b.data?.length){
          minISO=onlyDateISO(a.data[0].dia); maxISO=onlyDateISO(b.data[0].dia);
          dini.min=minISO; dfim.min=minISO; dini.max=maxISO; dfim.max=maxISO;
        }else{
          minISO=maxISO=null;
        }
      }

      async function buildOptions(){
        // Unidade
        { let q=supa.from(TABLE).select('unidade').not('unidade','is',null).order('unidade',{ascending:true});
          const arr = (await fetchAll(q, 50000)).map(x=>x.unidade).filter(Boolean);
          const uniq=[...new Set(arr)];
          uni.innerHTML=`<option>Todas</option>` + uniq.map(v=>`<option>${v}</option>`).join('');
        }
        // Pagamento
        { let q=supa.from(TABLE).select('pagamento').not('pagamento','is',null).order('pagamento',{ascending:true});
          const arr=(await fetchAll(q, 50000)).map(x=>x.pagamento).filter(Boolean);
          const uniq=[...new Set(arr)];
          pag.innerHTML=uniq.map(v=>`<option>${v}</option>`).join('');
        }
        // Canal (aspas)
        { let q=supa.from(TABLE).select('"Canal de venda"').order('Canal de venda',{ascending:true});
          const arr=(await fetchAll(q, 50000)).map(x=>x["Canal de venda"]).filter(Boolean);
          const uniq=[...new Set(arr)];
          canal.innerHTML=uniq.map(v=>`<option>${v}</option>`).join('');
        }
        // Lojas (todas; se ficar pesado, vira top 100 por receita)
        { let q=supa.from(TABLE).select('"Nome da loja"').order('Nome da loja',{ascending:true});
          const arr=(await fetchAll(q, 50000)).map(x=>x["Nome da loja"]).filter(Boolean);
          const uniq=[...new Set(arr)];
          loja.innerHTML = `<option>Todos</option>` + uniq.map(v=>`<option>${v}</option>`).join('');
        }
      }

      function inDateRange(iso,a,b){ return (!a||iso>=a)&&(!b||iso<=b); }
      function computeKPIs(rows){
        const pedidos=rows.reduce((s,r)=>s+(Number(r.pedidos)||0),0);
        const fat=rows.reduce((s,r)=>s+(Number(r.fat)||0),0);
        const des=rows.reduce((s,r)=>s+(Number(r.des)||0),0);
        const fre=rows.reduce((s,r)=>s+(Number(r.fre)||0),0);
        const fatliq=fat-des-fre; const dias=new Set(rows.map(r=>r.dia)).size||1;
        const ticket=pedidos?fat/pedidos:0; const fatDia=fat/dias; const desPct=fat?(des/fat):0;
        kPedidos.textContent=pedidos.toLocaleString('pt-BR'); kTicket.textContent=fmtBRL(ticket);
        kFat.textContent=fmtBRL(fat); kFatDia.textContent=fmtBRL(fatDia);
        kDes.textContent=fmtBRL(des); kDesPct.textContent=fmtPct(desPct);
        kFre.textContent=fmtBRL(fre); kFatLiq.textContent=fmtBRL(fatliq);
      }

      function drawChart(rows){
        const byDay = new Map();
        for(const r of rows){
          const d=r.dia; const v=Number(r.fat)||0;
          if(!d || !isFinite(v) || Math.abs(v)>1e12) continue;
          byDay.set(d, (byDay.get(d)||0)+v);
        }
        let pairs = Array.from(byDay.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        if(pairs.length>365){ const step=Math.ceil(pairs.length/360); pairs=pairs.filter((_,i)=>i%step===0); }
        const labels=pairs.map(p=>p[0]); const values=pairs.map(p=>p[1]);

        if(chart) chart.destroy();
        chart = new Chart(chartEl.getContext('2d'), {
          type:'line',
          data:{labels, datasets:[{label:'Receita', data:values, pointRadius:0, borderWidth:2, tension:0.2}]},
          options:{
            responsive:true, maintainAspectRatio:false, parsing:false, animation:false,
            plugins:{ legend:{display:false}, decimation:{enabled:true, algorithm:'lttb', samples:300} },
            scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>Intl.NumberFormat('pt-BR',{notation:'compact',maximumFractionDigits:1}).format(v)} } }
          }
        });
      }

      async function reload(){
        if(!minISO || !maxISO){ periodoEl.textContent='Sem dados.'; computeKPIs([]); if(chart) chart.destroy(); return; }

        const a = dini.value || minISO;
        const b = dfim.value || maxISO;
        const uniSel  = uni.value  || 'Todas';
        const lojaSel = loja.value || 'Todos';
        const turnSel = Array.from(turno.selectedOptions).map(o=>o.value);
        const canSel  = Array.from(canal.selectedOptions).map(o=>o.value);
        const pagSel  = Array.from(pag.selectedOptions).map(o=>o.value);
        const cancSel = (canc.value || 'Todos');

        let q = supa.from(TABLE)
          .select('dia,unidade,pedidos,fat,des,fre,"Nome da loja",turno,"Canal de venda",pagamento,cancelado,hora')
          .gte('dia', a).lte('dia', b)
          .order('dia',{ascending:true});

        if (uniSel  !== 'Todas') q = q.eq('unidade', uniSel);
        if (lojaSel !== 'Todos') q = q.eq('Nome da loja', lojaSel);
        if (turnSel.length)       q = q.in('turno', turnSel);
        if (canSel.length)        q = q.in('Canal de venda', canSel);
        if (pagSel.length)        q = q.in('pagamento', pagSel);
        if (cancSel !== 'Todos')  q = q.eq('cancelado', cancSel);

        const rows = await fetchAll(q, 50000);

        const clean = (rows||[]).map(r=>({
          dia: r?.dia ? r.dia.slice(0,10) : null,
          unidade: r?.unidade ?? null,
          fat: Number(r?.fat) || 0,
          pedidos: Number(r?.pedidos) || 0,
          des: Number(r?.des) || 0,
          fre: Number(r?.fre) || 0,
          turno: r?.turno ?? null,
          pagamento: r?.pagamento ?? null,
          'Canal de venda': r?.['Canal de venda'] ?? null,
          'Nome da loja': r?.['Nome da loja'] ?? null,
          cancelado: r?.cancelado ?? 'Não',
          hora: (Number(r?.hora) % 24 + 24) % 24
        })).filter(r=> r.dia && isFinite(r.fat));

        lastData = clean;
        periodoEl.textContent = `Período: ${a} → ${b} (${clean.length.toLocaleString('pt-BR')} linhas)`;
        computeKPIs(clean);
        drawChart(clean);
      }

      // ===== IMPORT CSV =====
      const mapHeader = (h)=>{
        const key = norm(h);
        const cand = [
          {std:'dia', list:['dia','data','data da venda','data de venda','data_venda','datadavenda','date']},
          {std:'unidade', list:['unidade','filial','unidades','uni','store']},
          {std:'pedidos', list:['pedidos','pedido','qtd','qtde','quantidade','orders','qty']},
          {std:'fat', list:['fat','faturamento','total','valor total','valor','total geral','revenue','sales']},
          {std:'des', list:['des','desconto','discount']},
          {std:'fre', list:['fre','frete','entrega','delivery','shipping']},
          {std:'turno', list:['turno','shift','periodo','período']},
          {std:'Nome da loja', list:['nome da loja','nome loja','loja','nomedaloja','nome_da_loja','store_name']},
          {std:'Canal de venda', list:['canal de venda','canal','canal de vendas','canal_venda','channel','sales_channel']},
          {std:'pagamento', list:['pagamento','forma de pagamento','meio de pagamento','payment','payment_method']},
          {std:'cancelado', list:['esta cancelado','está cancelado','cancelado','cancelada','cancelled','canceled']},
          {std:'hora', list:['hora','horario','horário','hour','time']},
        ];
        for(const c of cand){ if(c.list.includes(key)) return c.std; }
        return h;
      };

      btnImport.addEventListener('click', async ()=>{
        const file=csv.files?.[0];
        if(!file){ importStatus.textContent='Selecione um CSV.'; importStatus.style.color='#b91c1c'; return; }
        importStatus.textContent='Lendo arquivo…'; importStatus.style.color='#1a73e8';

        // streaming + dedup + flush por lotes
        let minFileISO=null, maxFileISO=null;
        const seen=new Set();           // chaves vistas no arquivo inteiro
        let batchMap=new Map();         // dedup intra-lote
        const BATCH=10000;

        async function flush(){
          if(batchMap.size===0) return;
          const rows=[...batchMap.values()];
          // upsert com conflito na chave composta
          const onC='dia,unidade,"Nome da loja",hora,pagamento,"Canal de venda"';
          const r = await supa.from(TABLE).upsert(rows, { onConflict:onC });
          if(r.error){ console.error(r.error); importStatus.textContent='Erro ao inserir (verifique RLS/índice único).'; importStatus.style.color='#b91c1c'; throw r.error; }
          batchMap.clear();
        }

        function pushRow(r){
          const key=[r.dia,r.unidade,r["Nome da loja"],r.hora,r.pagamento,r["Canal de venda"]].join('|');
          if(seen.has(key)){
            // soma nos agregados
            const cur=batchMap.get(key);
            if(cur){
              cur.pedidos=(cur.pedidos||0)+(r.pedidos||0);
              cur.fat=(cur.fat||0)+(r.fat||0);
              cur.des=(cur.des||0)+(r.des||0);
              cur.fre=(cur.fre||0)+(r.fre||0);
              cur.cancelado=r.cancelado||cur.cancelado;
            }
            return;
          }
          seen.add(key);
          batchMap.set(key, r);
          if(batchMap.size>=BATCH){
            // flush assíncrono sequencial
            pendingPromises = pendingPromises.then(()=>flush());
          }
        }

        let totalKept=0;
        let pendingPromises = Promise.resolve();

        Papa.parse(file,{
          header:true, skipEmptyLines:'greedy', transformHeader:mapHeader,
          step: function(row, parser){
            const r=row.data||{};
            // dia -> ISO
            let diaValue = r.dia || r['Data da venda'] || r['data'] || r['Data'];
            let diaIso = null;
            if(diaValue){
              diaIso = String(diaValue).includes('/') ? ddmmyyyyToISO(diaValue) : toISO(diaValue);
            }
            if(!diaIso){ return; }
            const diaOnly = onlyDateISO(diaIso);
            if(!diaOnly){ return; }

            // hora
            const hora = ('hora' in r) ? (parseInt(r.hora,10)||-1) : hourFromDateText(diaValue);

            // valores
            const fat = parseBR(r.fat || r['Total'] || r.total || 0);
            if(!isFinite(fat)) return;
            const des = parseBR(r.des || r['Desconto'] || r.desconto || 0);
            const fre = parseBR(r.fre || r['Entrega']  || r.entrega  || r.frete || 0);
            const unidade = String(r.unidade || r.Unidade || '').trim();
            if(!unidade) return;

            const obj = {
              dia: diaOnly,
              unidade,
              pedidos: Math.max(1, Number(r.pedidos)||1),
              fat: fat,
              des: Math.max(0, des),
              fre: Math.max(0, fre),
              turno: r.turno || r.Turno || null,
              pagamento: r.pagamento || r.Pagamento || null,
              "Canal de venda": r["Canal de venda"] || r.Canal || null,
              "Nome da loja": r["Nome da loja"] || r.Loja || null,
              cancelado: normCancel(r.cancelado || r['Está cancelado']),
              hora: isFinite(hora)?hora:-1
            };

            // stats de janela
            if(!minFileISO || obj.dia<minFileISO) minFileISO=obj.dia;
            if(!maxFileISO || obj.dia>maxFileISO) maxFileISO=obj.dia;

            pushRow(obj);
            totalKept++;
            if(totalKept%20000===0){
              importStatus.textContent = `Processando ${totalKept.toLocaleString('pt-BR')}…`;
            }
          },
          complete: async ()=>{
            try{
              await pendingPromises; // garante últimos flushes do tamanho
              await flush();

              if(!minFileISO || !maxFileISO){
                importStatus.textContent='Nada para importar (linhas inválidas).'; importStatus.style.color='#b91c1c'; return;
              }

              // limpa janela do arquivo ANTES do novo insert (idempotente)
              importStatus.textContent = `Limpando janela ${minFileISO} → ${maxFileISO}…`;
              await supa.from(TABLE).delete().gte('dia', minFileISO).lte('dia', maxFileISO);

              // re-inserir tudo que acumulamos (seen + batchMap já upsertados)
              // nada a fazer — o upsert foi feito no fluxo

              importStatus.textContent = `Importado: ${totalKept.toLocaleString('pt-BR')} linhas (janela ${minFileISO} → ${maxFileISO}).`;
              importStatus.style.color='#16a34a';

              await fetchMinMax();
              applyQuickDate();
              await buildOptions();
              await reload();
            }catch(e){
              console.error(e);
              importStatus.textContent='Erro ao finalizar importação.';
              importStatus.style.color='#b91c1c';
            }
          },
          error: function(err){
            console.error(err);
            importStatus.textContent='Erro ao ler arquivo CSV';
            importStatus.style.color='#b91c1c';
          }
        });
      });

      // ===== EVENTS =====
      pr.addEventListener("change", ()=>{ applyQuickDate(); reload(); fx.open=false; });
      [uni,loja,dini,dfim,turno,canal,pag,canc].forEach(e=> e.addEventListener("change", ()=>{ reload(); fx.open=false; }));
      btnLimpar.addEventListener('click', ()=>{ uni.value='Todas'; loja.value='Todos'; turno.selectedIndex=-1; canal.selectedIndex=-1; pag.selectedIndex=-1; canc.value='Todos'; applyQuickDate(); reload(); });

      // ===== BOOT =====
      (async function(){
        await fetchMinMax();
        if(minISO && maxISO){ applyQuickDate(); } else { periodoEl.textContent='Sem dados.'; }
        await buildOptions();
        await reload();
      })();
    }
  })();
  </script>
</body>
</html>
