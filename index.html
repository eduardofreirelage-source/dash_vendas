<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Debug Vendas — KPIs & Charts</title>
<style>
  :root{--bg:#0b1020;--panel:#151a2c;--muted:#8ea0c0;--accent:#34d399;--warn:#f59e0b;--err:#ef4444}
  body{background:var(--bg);color:#e5ecff;font-family:Inter,system-ui,Arial,sans-serif;margin:0}
  .wrap{max-width:1150px;margin:24px auto;padding:0 16px}
  h1{font-size:18px;margin:16px 0}
  .card{background:var(--panel);border:1px solid #26314e;border-radius:14px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 240px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;background:#0e1426;color:#e5ecff;border:1px solid #2a375c;border-radius:10px;padding:10px;font-size:14px}
  textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  button{background:#1b2440;border:1px solid #2f3b64;color:#e5ecff;padding:10px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);border-color:#24b57f;color:#082814;font-weight:600}
  button.warn{background:var(--warn);border-color:#d5890b;color:#1f1200}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .hl{background:#09102a;padding:10px;border-radius:10px;border:1px dashed #33406b}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .small{font-size:12px}
  .ok{color:var(--accent)} .bad{color:var(--err)}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Debug Vendas — KPIs & Charts (Supabase)</h1>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Supabase URL</label>
        <input id="sb-url" placeholder="https://SEU-PROJ.supabase.co">
      </div>
      <div class="col">
        <label>Anon Key</label>
        <input id="sb-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." />
      </div>
      <div class="col" style="flex:0 0 160px;align-self:flex-end">
        <button class="primary" id="btn-save">Salvar Conexão</button>
      </div>
    </div>
    <div class="small muted">Os valores ficam salvos no localStorage deste navegador.</div>
  </div>

  <div class="card">
    <div class="grid">
      <div>
        <label>Data Inicial (p_dini)</label>
        <input type="date" id="dini">
      </div>
      <div>
        <label>Data Final (p_dfim)</label>
        <input type="date" id="dfim">
      </div>
      <div>
        <label>Unidades (p_unids) — vírgula</label>
        <input id="unids" placeholder="ex.: uni.raja,uni.savassi">
      </div>
      <div>
        <label>Lojas (p_lojas)</label>
        <input id="lojas" placeholder="ex.: loja a,loja b">
      </div>
      <div>
        <label>Turnos (p_turnos)</label>
        <input id="turnos" placeholder="ex.: dia,noite">
      </div>
      <div>
        <label>Canais (p_canais)</label>
        <input id="canais" placeholder="ex.: ifood,telefone">
      </div>
      <div>
        <label>Pagamentos (p_pags)</label>
        <input id="pags" placeholder="ex.: pix,pago online">
      </div>
      <div>
        <label>Cancelado (p_cancelado)</label>
        <select id="cancelado">
          <option value="">Todos</option>
          <option>Não</option>
          <option>Sim</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn-kpi" class="primary">KPI (kpi_vendas_v2)</button>
      <button id="btn-dow">DOW (chart_vendas_dow_v2)</button>
      <button id="btn-hora">HORA (chart_vendas_hora_v2)</button>
      <button id="btn-mes">MÊS (chart_vendas_mes_v2)</button>
      <button id="btn-base">BASE (linhas & soma)</button>
      <button id="btn-vw-count">VW CONTAGEM (REST)</button>
      <button id="btn-vw-turno">VW DISTINCT TURNO (REST)</button>
      <button id="btn-clear" class="warn">Limpar</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col">
        <label>Parâmetros Enviados</label>
        <pre id="out-params" class="hl mono"></pre>
      </div>
      <div class="col">
        <label>Resumo</label>
        <div id="out-resumo" class="hl mono"></div>
      </div>
    </div>
    <div style="margin-top:10px">
      <label>Resposta Completa</label>
      <textarea id="out-json" class="mono" spellcheck="false"></textarea>
    </div>
  </div>

  <div class="card">
    <b>Notas rápidas</b>
    <ul class="small">
      <li>Se `KPI` retornar tudo `0` e `VW CONTAGEM` retornar > 0, o problema está no RPC/filtro. Se ambos retornarem 0, é o recorte de datas/filtros.</li>
      <li>Valores vazios nos inputs viram <span class="muted">null</span> (sem filtro). Use listas com vírgula para filtrar.</li>
      <li>Após criar/alterar função, rode: <span class="mono">select pg_notify('pgrst','reload schema');</span></li>
    </ul>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
function loadConn(){
  $('sb-url').value = localStorage.getItem('sb_url') || '';
  $('sb-key').value = localStorage.getItem('sb_key') || '';
}
function saveConn(){
  localStorage.setItem('sb_url',$('sb-url').value.trim());
  localStorage.setItem('sb_key',$('sb-key').value.trim());
  $('out-resumo').textContent = 'Conexão salva.';
}
function toArrayOrNull(txt){
  const s = (txt||'').trim();
  if(!s) return null;
  const arr = s.split(',').map(x=>x.trim().toLowerCase()).filter(Boolean);
  return arr.length? arr : null;
}
function params(){
  const p = {
    p_dini: $('dini').value || null,
    p_dfim: $('dfim').value || null,
    p_unids: toArrayOrNull($('unids').value),
    p_lojas: toArrayOrNull($('lojas').value),
    p_turnos: toArrayOrNull($('turnos').value),
    p_canais: toArrayOrNull($('canais').value),
    p_pags: toArrayOrNull($('pags').value),
    p_cancelado: $('cancelado').value || null
  };
  $('out-params').textContent = JSON.stringify(p,null,2);
  return p;
}
function setDefaultDates(){
  const today=new Date(); const dfim=today.toISOString().slice(0,10);
  const d0=new Date(today); d0.setDate(d0.getDate()-30);
  const dini=d0.toISOString().slice(0,10);
  $('dini').value=dini; $('dfim').value=dfim;
}

async function rpc(fn,args){
  const url = $('sb-url').value.trim().replace(/\/$/,'');
  const key = $('sb-key').value.trim();
  if(!url || !key){ alert('Informe URL e ANON KEY'); throw new Error('missing conn'); }
  const r = await fetch(`${url}/rest/v1/rpc/${fn}`,{
    method:'POST',
    headers:{
      apikey:key,
      Authorization:`Bearer ${key}`,
      'Content-Type':'application/json',
      Prefer:'count=exact'
    },
    body:JSON.stringify(args)
  });
  const text = await r.text();
  let data=null; try{ data = text? JSON.parse(text): null; }catch(e){}
  if(!r.ok){
    $('out-json').value = text;
    $('out-resumo').innerHTML = `<span class="bad">[${fn}] ${r.status} ${r.statusText}</span>`;
    throw new Error(`[${fn}] ${text||r.statusText}`);
  }
  $('out-json').value = JSON.stringify(data,null,2);
  return data;
}
function resumoKPI(rows){
  if(!rows || !rows.length) return 'KPI vazio';
  const r=rows[0]||{};
  return `pedidos=${r.pedidos??0} fat=${r.fat??0} des=${r.des??0} fre=${r.fre??0}`;
}
function resumoChart(rows,key){
  const n=Array.isArray(rows)? rows.length:0;
  const soma=Array.isArray(rows)? rows.reduce((a,x)=>a+Number(x.total||0),0):0;
  return `${key} pontos=${n} soma(total)=${soma}`;
}

async function callKPI(){ try{
  const d = await rpc('kpi_vendas_v2', params());
  $('out-resumo').innerHTML = `<span class="ok">KPI OK</span> — ${resumoKPI(d)}`;
}catch(e){ console.error(e); }}

async function callDOW(){ try{
  const d = await rpc('chart_vendas_dow_v2', params());
  $('out-resumo').innerHTML = `<span class="ok">DOW OK</span> — ${resumoChart(d,'dow')}`;
}catch(e){ console.error(e); }}

async function callHORA(){ try{
  const d = await rpc('chart_vendas_hora_v2', params());
  $('out-resumo').innerHTML = `<span class="ok">HORA OK</span> — ${resumoChart(d,'hora')}`;
}catch(e){ console.error(e); }}

async function callMES(){ try{
  const d = await rpc('chart_vendas_mes_v2', params());
  $('out-resumo').innerHTML = `<span class="ok">MÊS OK</span> — ${resumoChart(d,'ym')}`;
}catch(e){ console.error(e); }}

async function callBASE(){ try{
  const d = await rpc('_vendas_base', params());
  const n = Array.isArray(d)? d.length:0;
  const soma = Array.isArray(d)? d.reduce((a,x)=>a+Number(x.fat||0),0):0;
  $('out-resumo').innerHTML = `<span class="ok">BASE</span> — linhas=${n} soma(fat)=${soma}`;
}catch(e){ console.error(e); }}

/* ------- Testes diretos na VIEW via REST (contagem e distinct turno) ------- */
function qs(obj){
  const parts=[];
  for(const [k,v] of Object.entries(obj)){ if(v!==undefined && v!==null) parts.push(`${encodeURIComponent(k)}=${encodeURIComponent(v)}`); }
  return parts.join('&');
}
function inList(arr){
  // PostgREST in.(v1,v2) (sem aspas; use lower no backend pra garantir match)
  return `in.(${arr.map(x=>x.replaceAll(',','')).join(',')})`;
}
async function vwCount(){
  const url = $('sb-url').value.trim().replace(/\/$/,'');
  const key = $('sb-key').value.trim();
  const p = params();
  const q = {};
  if(p.p_dini) q['dia']=`gte.${p.p_dini}`;
  if(p.p_dfim) q['dia']= (q['dia']? q['dia']+`,lte.${p.p_dfim}` : `lte.${p.p_dfim}`);
  if(p.p_unids) q['unidade']= inList(p.p_unids);
  if(p.p_lojas) q['loja']= inList(p.p_lojas);
  if(p.p_turnos) q['turno']= inList(p.p_turnos);
  if(p.p_canais) q['canal']= inList(p.p_canais);
  if(p.p_pags) q['pagamento_base']= inList(p.p_pags);
  if(p.p_cancelado) q['cancelado']= `eq.${p.p_cancelado}`;
  const qsStr = qs(q);
  const r = await fetch(`${url}/rest/v1/vw_vendas?select=row_key&${qsStr}`,{
    method:'GET',
    headers:{ apikey:key, Authorization:`Bearer ${key}`, Prefer:'count=exact' }
  });
  const cr = r.headers.get('content-range')||'';
  // form: 0-xx/NNN
  let total=null;
  const m = cr.match(/\/(\d+)\s*$/); if(m) total = Number(m[1]);
  const txt = await r.text(); let data=null; try{ data=txt? JSON.parse(txt):null; }catch(e){}
  $('out-json').value = data? JSON.stringify(data.slice(0,10),null,2) : txt;
  $('out-resumo').innerHTML = r.ok
    ? `<span class="ok">VW OK</span> — total=${total} (mostrando até 10 ids)`
    : `<span class="bad">VW FAIL</span> — ${r.status} ${r.statusText}`;
}
async function vwDistinctTurno(){
  const url = $('sb-url').value.trim().replace(/\/$/,'');
  const key = $('sb-key').value.trim();
  const r = await fetch(`${url}/rest/v1/vw_vendas?select=turno&distinct=true&order=turno.asc&limit=50`,{
    headers:{ apikey:key, Authorization:`Bearer ${key}` }
  });
  const txt = await r.text(); let data=null; try{ data=txt? JSON.parse(txt):null; }catch(e){}
  $('out-json').value = data? JSON.stringify(data,null,2) : txt;
  $('out-resumo').innerHTML = r.ok
    ? `<span class="ok">VW DISTINCT</span> — ${Array.isArray(data)? data.length:0} valores`
    : `<span class="bad">VW DISTINCT FAIL</span> — ${r.status} ${r.statusText}`;
}

$('btn-save').addEventListener('click', saveConn);
$('btn-kpi').addEventListener('click', callKPI);
$('btn-dow').addEventListener('click', callDOW);
$('btn-hora').addEventListener('click', callHORA);
$('btn-mes').addEventListener('click', callMES);
$('btn-base').addEventListener('click', callBASE);
$('btn-vw-count').addEventListener('click', vwCount);
$('btn-vw-turno').addEventListener('click', vwDistinctTurno);
$('btn-clear').addEventListener('click', ()=>{ $('out-params').textContent=''; $('out-resumo').textContent=''; $('out-json').value=''; });

loadConn();
setDefaultDates();
params();
</script>
</body>
</html>
