<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DASH PRATOS — KPIs e Gráficos (v1.0 — import robusto + RPCs)</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">PRT</text></svg>'/>
  <!-- Chart.js, Supabase e XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --ok:#10b981; --down:#ef4444; --chip:#fef2f2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .wrap{max-width:1220px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.5px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;gap:12px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    .pad{padding:14px}
    .muted{color:var(--muted)}
    .topbar{display:grid;gap:12px}
    .cfg, .filters, .actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    input[type=text], input[type=date], select{
      border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;min-width:180px;outline:none
    }
    button{
      background:var(--wine);color:#fff;border:0;border-radius:10px;padding:9px 14px;cursor:pointer;font-weight:600
    }
    button.secondary{background:#fff;border:1px solid var(--line);color:var(--ink)}
    button.ghost{background:transparent;border:1px dashed var(--line);color:var(--muted)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .chip.active{background:var(--chip);border-color:#fbd5d5}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
    .kpi{padding:14px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .kpi h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.6px}
    .kpi .val{font-size:22px;font-weight:800}
    .delta{font-size:12px;margin-left:8px}
    .delta.ok{color:var(--ok)} .delta.down{color:var(--down)}
    canvas{width:100%;height:340px}
    .section-title{font-weight:700;margin:0 0 8px 0}
    .flex{display:flex;gap:12px}
    .grow{flex:1}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .status{font-size:12px;color:var(--muted)}
    .footer{margin-top:18px;color:var(--muted);font-size:12px}
    .help{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;background:#eef2ff;border:1px solid #dbeafe;color:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px}
    .warn{color:#b45309}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>DASH PRATOS — KPIs & Gráficos</h1>
        <div class="help">Conecte ao Supabase, importe o Excel (aba <b>base 1</b>) e selecione o período.</div>
      </div>
      <div class="flex">
        <button id="btnUpload">Importar Excel</button>
        <input type="file" id="fileExcel" accept=".xlsx,.xls,.csv" class="hidden"/>
      </div>
    </header>

    <div class="card pad topbar">
      <div class="cfg">
        <span class="pill">Config Supabase</span>
        <input id="inpUrl" type="text" placeholder="https://xxxx.supabase.co" />
        <input id="inpAnon" type="text" placeholder="Anon Key" />
        <button id="btnSaveCfg" class="secondary">Salvar</button>
        <button id="btnTest" class="ghost">Testar conexão</button>
        <span id="lblStatus" class="status"></span>
      </div>

      <div class="filters">
        <span class="pill">Período</span>
        <button class="chip" data-range="7">7 dias</button>
        <button class="chip active" data-range="30">30 dias</button>
        <button class="chip" data-range="60">60 dias</button>
        <button class="chip" data-range="90">90 dias</button>
        <input type="date" id="dtIni">
        <input type="date" id="dtFim">
        <button id="btnAplicar" class="secondary">Aplicar</button>
      </div>

      <div class="actions">
        <span class="pill">Filtros</span>
        <select id="selUnid" multiple title="Unidades"></select>
        <select id="selCat" multiple title="Categorias"></select>
        <select id="selPrato" multiple title="Pratos"></select>
        <button id="btnLimpar" class="ghost">Limpar filtros</button>
        <span id="lblResumo" class="status"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="kpis">
        <div class="kpi">
          <h3>Quantidade (Período)</h3>
          <div class="val" id="kpiQtd">—</div>
          <span class="delta" id="kpiQtdDelta"></span>
        </div>
        <div class="kpi">
          <h3>Quantidade (Período Anterior)</h3>
          <div class="val" id="kpiQtdPrev">—</div>
        </div>
        <div class="kpi">
          <h3>Pratos Únicos (Período)</h3>
          <div class="val" id="kpiUnique">—</div>
          <span class="delta" id="kpiUniqueDelta"></span>
        </div>
        <div class="kpi">
          <h3>Pratos Únicos (Período Anterior)</h3>
          <div class="val" id="kpiUniquePrev">—</div>
        </div>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:12px">
      <div class="card pad">
        <div class="section-title">Vendas por Dia da Semana (atual × anterior)</div>
        <canvas id="chartDOW"></canvas>
      </div>
      <div class="card pad">
        <div class="section-title">Mensal (12m) — Atual × Janela Anterior</div>
        <canvas id="chartMonthly"></canvas>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:12px">
      <div class="card pad">
        <div class="section-title">Top 10 — Mais vendidos</div>
        <table class="table" id="tblMais">
          <thead><tr><th>Prato</th><th>Quantidade</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card pad">
        <div class="section-title">Top 10 — Menos vendidos</div>
        <table class="table" id="tblMenos">
          <thead><tr><th>Prato</th><th>Quantidade</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <b>Observações</b>: Este HTML espera os RPCs no Supabase:
      <code>get_pratos_kpis</code>, <code>get_pratos_dow_chart</code>, <code>get_pratos_top10_chart</code>, <code>get_monthly_sales_chart_data</code>.
      Use o SQL que enviei para criar tudo. O import aceita datas em serial Excel, ISO (AAAA-MM-DD) e DD/MM/AA(AA).
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const fmtInt = (n)=>Number(n||0).toLocaleString('pt-BR');
    const todayISO = ()=>new Date().toISOString().slice(0,10);
    const addDays = (iso, n)=> {
      const d = new Date(iso+"T00:00:00");
      d.setDate(d.getDate()+n);
      return d.toISOString().slice(0,10);
    };

    function normalize(s){
      return String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toLowerCase().replace(/[^a-z0-9]/g,'');
    }

    function fromExcelSerialToISO(n){
      const ms = Math.round((Number(n) - 25569) * 86400) * 1000;
      const d  = new Date(ms);
      if (isNaN(d)) return null;
      return d.toISOString().slice(0,10);
    }

    function parseXlsxDate(v){
      if (v == null || v === '') return null;
      if (typeof v === 'number') return fromExcelSerialToISO(v);
      const s = String(v).trim();

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // ISO

      let m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})$/);
      if (m) {
        let [_, d, mo, y] = m;
        if (y.length === 2) y = '20' + y;
        return `${y.padStart(4,'0')}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`;
      }

      const d2 = new Date(s);
      return isNaN(d2) ? null : d2.toISOString().slice(0,10);
    }

    // ===== Estado global =====
    let supa = null;
    let chartDOW = null, chartMonthly = null;
    let currentRangeDays = 30;

    // ===== Setup inicial =====
    (function init(){
      // carregar config
      $('inpUrl').value  = localStorage.getItem('SUPA_URL')  || '';
      $('inpAnon').value = localStorage.getItem('SUPA_ANON') || '';
      bindEvents();

      // default período: últimos 30d
      $('dtFim').value = todayISO();
      $('dtIni').value = addDays(todayISO(), -29);

      if ($('inpUrl').value && $('inpAnon').value){
        createClient();
        refreshAll().catch(console.error);
      }
    })();

    function bindEvents(){
      $('btnSaveCfg').addEventListener('click', saveCfg);
      $('btnTest').addEventListener('click', testConn);
      $('btnAplicar').addEventListener('click', ()=>refreshAll());
      $('btnLimpar').addEventListener('click', clearFilters);

      $$('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          $$('.chip').forEach(x=>x.classList.remove('active'));
          ch.classList.add('active');
          currentRangeDays = Number(ch.dataset.range);
          $('dtFim').value = todayISO();
          $('dtIni').value = addDays(todayISO(), -(currentRangeDays-1));
          refreshAll();
        });
      });

      $('btnUpload').addEventListener('click', ()=> $('fileExcel').click());
      $('fileExcel').addEventListener('change', onExcelSelected);
    }

    function saveCfg(){
      localStorage.setItem('SUPA_URL', $('inpUrl').value.trim());
      localStorage.setItem('SUPA_ANON', $('inpAnon').value.trim());
      createClient();
      $('lblStatus').textContent = 'Config salva.';
      setTimeout(()=> $('lblStatus').textContent='', 2000);
    }

    function createClient(){
      const url = localStorage.getItem('SUPA_URL');
      const anon= localStorage.getItem('SUPA_ANON');
      if (!url || !anon){ $('lblStatus').textContent='URL/Anon vazios'; return; }
      supa = window.supabase.createClient(url, anon);
    }

    async function testConn(){
      try{
        $('lblStatus').textContent = 'Testando...';
        if (!supa) createClient();
        const { data, error } = await supa.from('vendas_pratos_daterange').select('*').limit(1);
        if (error) throw error;
        $('lblStatus').textContent = 'Conexão OK.';
      }catch(e){
        console.error(e);
        $('lblStatus').innerHTML = 'Falhou <span class="warn">(veja o console)</span>';
      }finally{
        setTimeout(()=> $('lblStatus').textContent='', 3000);
      }
    }

    function selections(sel){
      // retorna array de valores selecionados ou null
      const vals = Array.from(sel.selectedOptions).map(o=>o.value).filter(Boolean);
      return vals.length ? vals : null;
    }

    function summaryFilters(){
      const un = selections($('selUnid'));
      const ca = selections($('selCat'));
      const pr = selections($('selPrato'));
      const parts = [];
      if (un) parts.push(`Unid: ${un.length}`);
      if (ca) parts.push(`Cat: ${ca.length}`);
      if (pr) parts.push(`Pratos: ${pr.length}`);
      $('lblResumo').textContent = parts.length ? parts.join(' · ') : 'Sem filtros';
      return {un, ca, pr};
    }

    function clearFilters(){
      ['selUnid','selCat','selPrato'].forEach(id=>{
        const el=$(id);
        Array.from(el.options).forEach(o=>o.selected=false);
      });
      refreshAll();
    }

    // ===== Import Excel (robusto) =====
    async function onExcelSelected(ev){
      const file = ev.target.files[0];
      if (!file) return;

      const btn = $('btnUpload');
      btn.textContent = 'Importando...';
      btn.disabled = true;

      try{
        if (!supa) createClient();
        if (!supa) throw new Error('Config Supabase ausente.');

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheetName = workbook.SheetNames.includes('base 1') ? 'base 1' : workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        // raw:true para manter número (datas em serial Excel)
        const rows = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: null });
        if (!rows.length) throw new Error('Planilha vazia.');

        const headers = Object.keys(rows[0] || {});
        const hmap = {}; headers.forEach(h=> hmap[normalize(h)] = h);

        const pick = (cands)=>{
          for(const c of cands){
            const key = normalize(c);
            if (hmap[key]) return hmap[key];
          }
          return null;
        };

        const dateKey  = pick(['data','data da venda','dia','dt','dt_venda']);
        const unitKey  = pick(['unidade','loja','filial']);
        const dishKey  = pick(['prato','produto','item','itens e opcoes','itens e opções']);
        const catKey   = pick(['categoria','grupo','departamento','secao','seção']);
        const qtyKey   = pick(['quantidade_vendida','quantidade','qtd','qtde','qde','qtd_vendida']);

        if (!dateKey) throw new Error('Coluna de data não encontrada (ex.: "Data").');
        if (!qtyKey)  throw new Error('Coluna de quantidade não encontrada (ex.: "Quantidade"/"Qtd").');

        const linhas = rows.map(r=>{
          const iso = parseXlsxDate(r[dateKey]);
          if (!iso) return null;
          const q = Number(r[qtyKey]) || 0;
          return {
            data: iso,
            unidade: unitKey ? (r[unitKey] ?? null) : null,
            prato:   dishKey ? (r[dishKey] ?? null) : null,
            categoria: catKey ? (r[catKey] ?? null) : null,
            quantidade: q
          };
        }).filter(Boolean);

        if (!linhas.length) throw new Error('Nenhuma linha com data válida foi encontrada.');

        // Inserção em lotes
        const CHUNK = 500;
        let ok = 0;
        for (let i=0;i<linhas.length;i+=CHUNK){
          const chunk = linhas.slice(i, i+CHUNK);
          const { error } = await supa.from('vendas_pratos').insert(chunk);
          if (error) throw new Error(error.message);
          ok += chunk.length;
        }

        alert(`Importado com sucesso: ${ok} linhas.`);
        await refreshAll();

      }catch(e){
        console.error('[Import error]', e);
        alert(`Falha na importação: ${e.message}`);
      }finally{
        btn.textContent = 'Importar Excel';
        btn.disabled = false;
        ev.target.value = '';
      }
    }

    // ===== Carregar filtros e dados =====
    async function ensureDateRange(){
      // tenta pegar min/max da view; se não existir/dados vazios, usa últimos 30d
      try{
        const { data, error } = await supa.from('vendas_pratos_daterange').select('*').limit(1);
        if (!error && data && data.length){
          const r = data[0];
          if (r.min_data && r.max_data){
            $('dtIni').value = r.min_data;
            $('dtFim').value = r.max_data;
            return;
          }
        }
      }catch(_){}
      $('dtFim').value = todayISO();
      $('dtIni').value = addDays(todayISO(), -29);
    }

    async function loadFilterOptions(){
      // Unidades
      try{
        const { data } = await supa.from('vendas_pratos_unidades').select('unidade').order('unidade', { ascending:true });
        fillSelect($('selUnid'), (data||[]).map(r=>r.unidade).filter(Boolean));
      }catch(e){ console.warn('Unidades view não disponível', e); }
      // Categorias
      try{
        const { data } = await supa.from('vendas_pratos_categorias').select('categoria').order('categoria', { ascending:true });
        fillSelect($('selCat'), (data||[]).map(r=>r.categoria).filter(Boolean));
      }catch(e){ console.warn('Categorias view não disponível', e); }
      // Pratos
      try{
        const { data } = await supa.from('vendas_pratos_pratos').select('prato').order('prato', { ascending:true });
        fillSelect($('selPrato'), (data||[]).map(r=>r.prato).filter(Boolean));
      }catch(e){ console.warn('Pratos view não disponível', e); }
    }

    function fillSelect(sel, arr){
      sel.innerHTML = '';
      arr.forEach(v=>{
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    }

    async function refreshAll(){
      if (!supa) createClient();
      if (!supa) { alert('Configure o Supabase primeiro.'); return; }

      // se datas vazias, tenta range
      if (!$('dtIni').value || !$('dtFim').value) await ensureDateRange();

      summaryFilters();
      await Promise.all([
        loadFilterOptions(),
        updateKPIs(),
        updateDOW(),
        updateMonthly(),
        updateTop10()
      ]);
    }

    function currentParams(){
      const de_iso = $('dtIni').value;
      const ate_iso = $('dtFim').value;
      const fs = summaryFilters();
      return {
        de_iso, ate_iso,
        unids_filter: fs.un,
        cats_filter: fs.ca,
        pratos_filter: fs.pr,
        is_pratos_only: false
      };
    }

    async function updateKPIs(){
      try{
        const p = currentParams();
        const { data, error } = await supa.rpc('get_pratos_kpis', p);
        if (error) throw error;
        const r = (data && data[0]) ? data[0] : {current_total:0,prev_total:0,current_unique:0,prev_unique:0};

        $('kpiQtd').textContent = fmtInt(r.current_total);
        $('kpiQtdPrev').textContent = fmtInt(r.prev_total);
        $('kpiUnique').textContent = fmtInt(r.current_unique);
        $('kpiUniquePrev').textContent = fmtInt(r.prev_unique);

        const delta = (cur, prev)=>{
          const d = prev ? ((cur - prev)/prev)*100 : (cur>0?100:0);
          return `${d>=0?'+':''}${d.toFixed(1)}%`;
        };
        $('kpiQtdDelta').textContent = delta(r.current_total, r.prev_total);
        $('kpiQtdDelta').className = 'delta ' + (r.current_total>=r.prev_total?'ok':'down');

        $('kpiUniqueDelta').textContent = delta(r.current_unique, r.prev_unique);
        $('kpiUniqueDelta').className = 'delta ' + (r.current_unique>=r.prev_unique?'ok':'down');

      }catch(e){
        console.error('KPIs error', e);
        $('kpiQtd').textContent = '—';
        $('kpiQtdPrev').textContent = '—';
        $('kpiUnique').textContent = '—';
        $('kpiUniquePrev').textContent = '—';
        $('kpiQtdDelta').textContent = '';
        $('kpiUniqueDelta').textContent = '';
      }
    }

    async function updateDOW(){
      try{
        const p = currentParams();
        const { data, error } = await supa.rpc('get_pratos_dow_chart', p);
        if (error) throw error;
        const days = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
        const labels = data.map(r=>days[r.dow||0]);
        const cur = data.map(r=>r.current||0);
        const prv = data.map(r=>r.previous||0);

        if (chartDOW) chartDOW.destroy();
        const ctx = document.getElementById('chartDOW').getContext('2d');
        chartDOW = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label:'Atual', data:cur },
              { label:'Anterior', data:prv }
            ]
          },
          options: {
            responsive:true,
            maintainAspectRatio:false,
            scales:{ x:{ stacked:false }, y:{ beginAtZero:true } },
            plugins:{ legend:{ position:'bottom' } }
          }
        });
      }catch(e){
        console.error('DOW error', e);
        if (chartDOW){ chartDOW.destroy(); chartDOW=null; }
      }
    }

    async function updateMonthly(){
      try{
        const p0 = currentParams();
        const p = {
          end_date_iso: p0.ate_iso,
          unids_filter: p0.unids_filter,
          cats_filter: p0.cats_filter,
          pratos_filter: p0.pratos_filter,
          is_pratos_only: p0.is_pratos_only
        };
        const { data, error } = await supa.rpc('get_monthly_sales_chart_data', p);
        if (error) throw error;
        const labels = data.map(r=> r.period?.slice(0,7) ); // YYYY-MM
        const cur = data.map(r=> r.current_total||0);
        const prv = data.map(r=> r.prev_total||0);

        if (chartMonthly) chartMonthly.destroy();
        const ctx = document.getElementById('chartMonthly').getContext('2d');
        chartMonthly = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label:'Atual', data:cur, tension:.25 },
              { label:'Anterior', data:prv, tension:.25 }
            ]
          },
          options: {
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom' } },
            scales:{ y:{ beginAtZero:true } }
          }
        });
      }catch(e){
        console.error('Monthly error', e);
        if (chartMonthly){ chartMonthly.destroy(); chartMonthly=null; }
      }
    }

    async function updateTop10(){
      try{
        const p = currentParams();
        const { data, error } = await supa.rpc('get_pratos_top10_chart', p);
        if (error) throw error;

        const mais = (data && data.mais_vendidos) ? data.mais_vendidos : [];
        const menos = (data && data.menos_vendidos) ? data.menos_vendidos : [];

        fillTopTable($('tblMais').querySelector('tbody'), mais);
        fillTopTable($('tblMenos').querySelector('tbody'), menos);
      }catch(e){
        console.error('Top10 error', e);
        $('tblMais').querySelector('tbody').innerHTML = '';
        $('tblMenos').querySelector('tbody').innerHTML = '';
      }
    }

    function fillTopTable(tbody, arr){
      tbody.innerHTML = '';
      arr.forEach(r=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = r.prato ?? '—';
        const td2 = document.createElement('td'); td2.textContent = fmtInt(r.total ?? 0);
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
