<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dash Pratos</title>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#ef4444;
      --c-now:#7b1e3a; --c-prev:#9ca3af;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; height: 100%; overflow: hidden;}
    .wrap{display:flex;flex-direction:column;min-height:100vh; height: 100%; overflow: hidden;}
    .main{flex:1;min-width:0;display:flex;flex-direction:column; overflow-y: auto; padding-bottom: 60px;}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:16px;margin-bottom:8px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px; font-size:16px; font-weight: 700; color: var(--ink);}
    .section{order:2;padding:0 16px 12px 16px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;transition:.2s;position:relative}
    .kpi h4{margin:0 0 4px 0;color:var(--muted);font-size:11px;display:flex;align-items:center;gap:6px;}
    .kpi h4 .spacer { flex-grow: 1; }
    .kpi .val{font-size:22px;font-weight:500;letter-spacing:-.5px}
    .kpi .sub{font-size:10px;color:var(--muted);margin-top:4px}
    .delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:700;font-size:10px;margin-left:6px;background:rgba(148,163,184,.15);color:#6b7280}
    .delta svg{width:10px;height:10px;fill:currentColor}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .delta.down{background:rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.25); color: var(--down); }
    .charts-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px; flex: 1;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column; min-height: 200px; }
    .card .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .title{font-weight:700; color: var(--ink)}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:4px 8px;border:0;background:#fff;font-weight:700;color:#475569;cursor:pointer; font-size: 10px;}
    .seg button.active{background:var(--wine);color:#fff}
    .chart-box{position:relative;flex-grow:1;min-height:180px;}
    .chart-box canvas{display:block;width:100%;height:100%}
    @media (max-width:1200px){ .kpis{grid-template-columns:repeat(2,1fr)} .charts-grid{grid-template-columns:1fr} }
    @media (max-width: 768px) { .kpis{ grid-template-columns: 1fr; } .top { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="main main-content">
      <div class="top">
        <div class="brand">Dashboard de Pratos</div>
        <div class="seg" id="segDowMode">
            <button data-mode="TOTAL" class="active">TOTAL</button>
            <button data-mode="MEDIA">MÉDIA</button>
        </div>
      </div>
      <section class="section">
        <div class="kpis">
          <div class="kpi"><h4><span>Itens Vendidos</span><span class="spacer"></span><span id="d_qtd" class="delta flat">—</span></h4><div class="val" id="k_qtd">—</div><div class="sub">Anterior: <span id="p_qtd">—</span></div></div>
          <div class="kpi"><h4><span>Pratos/Itens Únicos</span><span class="spacer"></span><span id="d_pratos_unicos" class="delta flat">—</span></h4><div class="val" id="k_pratos_unicos">—</div><div class="sub">Anterior: <span id="p_pratos_unicos">—</span></div></div>
          <div class="kpi"><h4><span>Média Diária</span><span class="spacer"></span><span id="d_media_diaria" class="delta flat">—</span></h4><div class="val" id="k_media_diaria">—</div><div class="sub">Anterior: <span id="p_media_diaria">—</span></div></div>
        </div>
        <div class="card" style="margin-bottom: 10px;">
            <div class="head"><div class="title">Vendas por Mês</div></div>
            <div class="chart-box" style="height: 184px; min-height: 184px;"><canvas id="ch_month"></canvas></div>
        </div>
        <div class="charts-grid">
            <div class="card">
              <div class="head"><div class="title">Vendas por Dia da Semana</div></div>
              <div class="chart-box"><canvas id="ch_dow"></canvas></div>
            </div>
            <div class="card">
                <div class="head">
                    <div class="title">Top 10 Pratos</div>
                    <div class="seg" id="segTop10">
                        <button data-mode="MAIS" class="active">Mais Vendidos</button>
                        <button data-mode="MENOS">Menos Vendidos</button>
                    </div>
                </div>
                <div class="chart-box"><canvas id="ch_top10"></canvas></div>
            </div>
        </div>
      </section>
    </main>
  </div>
  <style>
    .fx-filters-bar{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--line); padding:8px 14px; height:56px; display:flex; align-items:center; justify-content:space-between; }
    .fx-fb-left{display:flex; align-items:center; gap:10px; min-width:0; flex:1}
    .fx-fb-label{font-weight:700; color:var(--ink); font-size:12px; white-space:nowrap;}
    .fx-chips{display:flex; gap:8px; overflow:auto; scrollbar-width:none}
    .fx-chips::-webkit-scrollbar{display:none}
    .fx-chip{flex:0 0 auto; padding:6px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; color:#334155; font-weight:700; cursor:pointer; font-size:11px}
    .fx-chip.active{background:var(--wine); color:#fff; border-color:var(--wine)}
    .fx-fb-right{display:flex; align-items:center; gap:8px}
    .fx-iconbtn{display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer}
    .fx-textbtn{padding:8px 14px; border:1px solid var(--line); background:#fff; color:#334155; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px; display: inline-flex; align-items: center; gap: 6px;}
    .fx-dropup{ position:fixed; left:8px; right:8px; bottom:60px; z-index:40; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,.08); padding:0; display:none; }
    .fx-dropup.fx-show{display:block; animation:fx-pop .15s ease-out}
    @keyframes fx-pop{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    .fx-du-head{position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line); padding:8px 10px; display:flex; align-items:center; justify-content:space-between; border-top-left-radius:12px; border-top-right-radius:12px}
    .fx-du-title{font-weight:900; color:#334155; font-size:12px}
    .fx-du-body{padding:10px 10px; display:flex; flex-direction:column; gap:10px;}
    .fx-du-sec{display:flex; flex-direction:column; gap:8px}
    .fx-du-sec + .fx-du-sec{padding-top:8px; border-top:1px dashed var(--line)}
    .fx-du-sec h4{margin:0; font-size:11.5px; letter-spacing:.2px; text-transform:uppercase; color:#475569}
    .fx-du-grid{display:grid; grid-template-columns:repeat(12,1fr); gap:8px; align-items:end}
    .fx-field{display:flex; flex-direction:column; gap:4px; min-width:0}
    .fx-label{font-size:10px; color:#64748b}
    .fx-input{ height:30px; padding:4px 8px; border:1px solid var(--line); border-radius:8px; background:#fff; font:inherit }
    .fx-period-line{ display:grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end; }
    .fx-quickwrap{ margin-top: 0; }
    .fx-quick-hint{font-size:10px; color:#94a3b8; white-space:nowrap; margin-right: 10px;}
    .fx-seg{border-radius:10px; display:inline-flex; border:1px solid var(--line); background:#fff; white-space:nowrap; overflow:hidden}
    .fx-seg button{ height:30px; min-width:44px; padding:0 10px; border:0; background:transparent; cursor:pointer; font-weight:800; color:#475569; font-size:10px }
    .fx-seg button + button{border-left:1px solid var(--line)}
    .fx-seg button.fx-active{background:var(--wine); color:#fff}
    .msel{position:relative}
    .msel-btn{width:100%; text-align: left; height:30px; padding:4px 8px; border:1px solid var(--line); border-radius:8px; background:#fff; font:inherit; cursor: pointer;}
    .msel-btn:after{content:"▾";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:40;bottom:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
    .msel-opt:hover{background:#f3f4f6}
  </style>

  <footer class="fx-filters-bar" aria-label="Barra de filtros">
    <div class="fx-fb-left">
      <div class="fx-fb-label">Filtros:</div>
      <div class="fx-chips" id="fxQuickChips">
          <button class="fx-chip" data-win="today">Hoje</button>
          <button class="fx-chip" data-win="yesterday">Ontem</button>
          <button class="fx-chip" data-win="lastMonth">Último mês</button>
          <button class="fx-chip" data-win="lastYear">Último ano</button>
      </div>
    </div>
    <div class="fx-fb-right">
      <button class="fx-iconbtn" id="fxBtnMore" title="Mais filtros" aria-haspopup="dialog" aria-expanded="false">
        <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" height="16px" width="16px"><path d="M3 6h18M7 12h10M10 18h4"/></svg>
      </button>
      <button class="fx-textbtn" id="btnUpload">Importar</button>
      <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
      <button class="fx-textbtn" id="fxBtnReset">Limpar</button>
    </div>
  </footer>

  <div class="fx-dropup" id="fxDropup" role="dialog" aria-modal="true" aria-labelledby="fxDuTitle">
    <div class="fx-du-head">
      <div class="fx-du-title" id="fxDuTitle">Filtros Avançados</div>
    </div>
    <div class="fx-du-body">
      <section class="fx-du-sec" aria-labelledby="fxSecPeriodo">
        <h4 id="fxSecPeriodo">Período Manual</h4>
        <div class="fx-period-line">
          <div class="fx-field"><label class="fx-label">Data inicial</label><input type="date" id="fxDuStart" class="fx-input"></div>
          <div class="fx-field"><label class="fx-label">Data final</label><input type="date" id="fxDuEnd" class="fx-input"></div>
          <div class="fx-quickwrap">
            <span class="fx-quick-hint">Rápido</span>
            <div class="fx-seg" id="fxDuQuickDays">
              <button data-win="7">07</button><button data-win="15">15</button><button data-win="30" class="fx-active">30</button>
              <button data-win="60">60</button><button data-win="90">90</button><button data-win="120">120</button>
            </div>
          </div>
        </div>
      </section>
      <section class="fx-du-sec" aria-labelledby="fxSecAnaliticos">
        <h4 id="fxSecAnaliticos">Analíticos</h4>
        <div class="fx-du-grid">
          <div class="fx-field" style="grid-column:span 4"><label class="fx-label">Unidade</label><div id="ms-unids" class="msel"><button class="msel-btn">Todas</button><div class="msel-panel"></div></div></div>
          <div class="fx-field" style="grid-column:span 4"><label class="fx-label">Categoria</label><div id="ms-cats" class="msel"><button class="msel-btn">Todas</button><div class="msel-panel"></div></div></div>
          <div class="fx-field" style="grid-column:span 4"><label class="fx-label">Prato</label><div id="ms-pratos" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div></div>
          <div class="fx-field" style="grid-column:span 12; padding-top: 8px;">
            <label style="display:flex;align-items:center;gap:8px; cursor: pointer; font-size: 12px;"><input type="checkbox" id="onlyPratos"> Filtrar apenas itens da categoria "PRATOS"</label>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  "use strict";
  /* ===================== CONFIG ===================== */
  const SUPABASE_URL  = 'https://tykdmxaqvqwskpmdiekw.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5a2RteGFxdnF3c2twbWRpZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTg2NDYsImV4cCI6MjA3Mjg3NDY0Nn0.XojR4nVx_Hr4FtZa1eYi3jKKSVVPokG23jrJtm8_3ps';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===================== CHART DEFAULTS ===================== */
  Chart.defaults.font.family = '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif';
  Chart.defaults.color = '#334155';
  Chart.defaults.plugins.legend.position = 'top';
  Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.95)';
  Chart.defaults.datasets.bar.borderRadius = 6;
  Chart.defaults.datasets.bar.borderSkipped = false;
  Chart.defaults.devicePixelRatio = Math.max(1, window.devicePixelRatio || 1);

  /* ===================== HELPERS ===================== */
  const $ = id => document.getElementById(id);
  const num = v => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
  const toast = (msg,type='info')=>{ console[type==='error'?'error':'info'](`[Status] [${type}]: ${msg}`); };
  
  // Função auxiliar robusta: busca o valor em um objeto tentando várias chaves possíveis (EN/PT).
  const getField = (obj, keys) => { 
    if (!obj) return undefined;
    for (const k of keys) { 
        if (Object.prototype.hasOwnProperty.call(obj, k)) return obj[k]; 
    } 
    return undefined; 
  };
   
  // Funções de data usam UTC (T12:00:00Z) para evitar inconsistências de fuso horário.
  function getTodayISO(baseDate) {
    const d = baseDate ? new Date(baseDate + 'T12:00:00Z') : new Date();
    if (!baseDate) {
        d.setHours(12, 0, 0, 0);
    }
    return d.toISOString().split('T')[0];
  }

  function daysLen(de, ate) {
    if (!de || !ate) return 0;
    const d1 = new Date(de + 'T12:00:00Z');
    const d2 = new Date(ate + 'T12:00:00Z');
    return Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
  }

  function formatYM(isoStr){
    if (!isoStr) return '';
    const d = new Date(isoStr + 'T12:00:00Z');
    const m = d.getUTCMonth();
    const y = String(d.getUTCFullYear()).slice(-2);
    const n = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    return `${n[m]}/${y}`;
  }

  const rmAcc = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
   
  function fxDispatchApply(){
      const payload = { start: $('fxDuStart').value, end: $('fxDuEnd').value };
      document.dispatchEvent(new CustomEvent('filters:apply', { detail: payload }));
  }

  /* ===================== MULTISELECT ===================== */
  function MultiSelect(rootId, placeholder){
    // ... (Código do MultiSelect inalterado, omitido para brevidade) ...
  }

  /* ===================== ESTADO ===================== */
  let lastDay='';
  let dowMode = 'TOTAL';
  let top10Mode = 'MAIS';
  const ms = {
    unids: MultiSelect('ms-unids', 'Todas as Unidades'),
    cats:  MultiSelect('ms-cats', 'Todas as Categorias'),
    pratos: MultiSelect('ms-pratos', 'Todos os Pratos')
  };

  $('onlyPratos').addEventListener('change', fxDispatchApply);
  $('segDowMode').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    [...e.currentTarget.children].forEach(b=>b.classList.toggle('active', b===btn));
    dowMode = btn.dataset.mode;
    fxDispatchApply();
  });
  $('segTop10').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    [...e.currentTarget.children].forEach(b=>b.classList.toggle('active', b===btn));
    top10Mode = btn.dataset.mode;
    fxDispatchApply();
  });

  /* ===================== KPI & CHARTS ===================== */
  function upSVG(){return '<svg viewBox="0 0 20 20"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>';}
  function downSVG(){return '<svg viewBox="0 0 20 20"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>';}
  function deltaBadge(el,curr,prev){
    // Trata o caso onde curr e prev são 0
    if (curr === 0 && prev === 0) {
        el.textContent='0.0%'; el.className='delta flat'; return;
    }
    if(!isFinite(prev)||+prev===0){ el.textContent='—'; el.className='delta flat'; return; }
    const p=((curr-prev)/prev)*100;
    el.innerHTML=(p>=0? upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%';
    el.className='delta '+(p>=0?'up':'down');
  }

  function renderChart(canvasId, type, labels, datasets, options = {}) {
    const canvas = $(canvasId);
    if (!canvas) return;
    if (canvas.__chart) { try { canvas.__chart.destroy(); } catch(e){} }
    const ctx = canvas.getContext('2d');
    canvas.__chart = new Chart(ctx, {
      type,
      data: { labels, datasets },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        scales: type === 'bar' ? { y: { beginAtZero: true }, x: { grid: { display: false } } } : {},
        plugins: { legend: { display: datasets.length > 1 } },
        ...options
      }
    });
  }
   
  // ATUALIZAÇÃO: Torna a leitura dos KPIs robusta (PT/EN e tratamento de nulos)
  function updateKPIs(kpisData, len) {
    const kpis = kpisData || {};
    
    // Busca os valores usando getField para suportar variações nos nomes das colunas SQL
    const current_total = getField(kpis, ['current_total', 'total_atual', 'total', 'current']) || 0;
    const prev_total = getField(kpis, ['prev_total', 'previous_total', 'total_anterior', 'previous']) || 0;
    const current_unique = getField(kpis, ['current_unique', 'unicos_atual', 'unicos']) || 0;
    const prev_unique = getField(kpis, ['prev_unique', 'previous_unique', 'unicos_anterior']) || 0;

    const mediaDiaria = len > 0 && current_total > 0 ? Math.round(current_total / len) : 0;
    const prevMediaDiaria = len > 0 && prev_total > 0 ? Math.round(prev_total / len) : 0;
    
    $('k_qtd').textContent = num(current_total);
    $('p_qtd').textContent = num(prev_total);
    deltaBadge($('d_qtd'), current_total, prev_total);
    
    $('k_pratos_unicos').textContent = num(current_unique);
    $('p_pratos_unicos').textContent = num(prev_unique);
    deltaBadge($('d_pratos_unicos'), current_unique, prev_unique);
    
    $('k_media_diaria').textContent = num(mediaDiaria);
    $('p_media_diaria').textContent = num(prevMediaDiaria);
    deltaBadge($('d_media_diaria'), mediaDiaria, prevMediaDiaria);
  }

  // ATUALIZAÇÃO: Robustez na leitura dos dados do Top 10.
  function updateTop10Chart(data) {
    // Verifica se as listas existem, considerando possíveis variações de nome
    const maisVendidos = getField(data, ['mais_vendidos', 'most_sold', 'mais']) || [];
    const menosVendidos = getField(data, ['menos_vendidos', 'least_sold', 'menos']) || [];

    const mapItem = (x) => ({
        prato: getField(x, ['prato', 'dish', 'item']),
        total: getField(x, ['total', 'quantidade', 'quantity', 'qtd'])
    });

    if (top10Mode === 'MAIS') {
        const mapped = maisVendidos.map(mapItem);
        renderChart('ch_top10', 'bar', mapped.map(x => x.prato), [{ label: 'Qtd', data: mapped.map(x => x.total), backgroundColor: '#7b1e3a' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
    } else { 
        const mapped = menosVendidos.map(mapItem);
        renderChart('ch_top10', 'bar', mapped.map(x => x.prato), [{ label: 'Qtd', data: mapped.map(x => x.total), backgroundColor: '#9ca3af' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
    }
  }

  // ATUALIZAÇÃO: Robustez na leitura dos dados de Dia da Semana (DoW) e correção no cálculo da média do período anterior.
  function updateDowChart(data, len) {
    const dowLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
    let nowData = Array(7).fill(0), prevData = Array(7).fill(0);
    
    for (let item of (data || [])) {
        // Usa getField para encontrar o índice DoW e os valores
        const dowIndex = getField(item, ['dow', 'dia_semana_idx', 'dia_semana', 'ds']);
        const currentVal = getField(item, ['current', 'atual', 'total']);
        const previousVal = getField(item, ['previous', 'anterior', 'prev_total']);

        if (dowIndex !== undefined && dowIndex >= 0 && dowIndex < 7) {
            nowData[dowIndex] = currentVal || 0;
            prevData[dowIndex] = previousVal || 0;
        }
    }

    if (dowMode === 'MEDIA' && len > 0) {
        const de = $('fxDuStart').value, ate = $('fxDuEnd').value;
        
        // Calcula ocorrências no período atual
        const occNow = Array(7).fill(0);
        let d = new Date(de+'T12:00:00Z'), end = new Date(ate+'T12:00:00Z');
        while (d <= end) { occNow[d.getUTCDay()]++; d.setUTCDate(d.getUTCDate()+1); }
         
        // Calcula ocorrências no período anterior
        const occPrev = Array(7).fill(0);
        d = new Date(de+'T12:00:00Z');
        d.setUTCDate(d.getUTCDate() - len); // Início do período anterior
        const startPrev = new Date(d.getTime());

        // O período anterior termina um dia antes do início do período atual
        const endPrev = new Date(de+'T12:00:00Z');
        endPrev.setUTCDate(endPrev.getUTCDate() - 1);
        
        d = startPrev;
        while (d <= endPrev) { occPrev[d.getUTCDay()]++; d.setUTCDate(d.getUTCDate()+1); }
         
        nowData = nowData.map((v,i)=> occNow[i] > 0 ? Math.round(v/occNow[i]) : 0);
        prevData = prevData.map((v,i)=> occPrev[i] > 0 ? Math.round(v/occPrev[i]) : 0);
    }
    renderChart('ch_dow', 'bar', dowLabels, [{ label: 'Atual', data: nowData, backgroundColor: '#7b1e3a' }, { label: 'Anterior', data: prevData, backgroundColor: '#9ca3af' }]);
  }

    /* FUNÇÃO AUXILIAR PARA PREPARAR FILTROS */
    function prepareFilters() {
        const unids = ms.unids.get();
        const pratos = ms.pratos.get();
        let cats = ms.cats.get();
        const isPratosOnly = $('onlyPratos').checked;

        let catsFilter = null;

        if (isPratosOnly) {
            // Se "Apenas Pratos" está marcado, forçamos a categoria para 'PRATOS'.
            catsFilter = ['PRATOS'];
        } else if (cats.length > 0) {
            catsFilter = cats;
        }

        return {
            _unidades: unids.length > 0 ? unids : null,
            _categorias: catsFilter,
            _pratos: pratos.length > 0 ? pratos : null
        };
    }

  // ATUALIZAÇÃO: Robustez na leitura dos dados Mensais.
  async function updateMonthChart(endDate) {
      try {
        const filters = prepareFilters();

        /* Mapeamento para a assinatura esperada pelo SQL */
        const params = {
            _ate: endDate,
            _unidades: filters._unidades,
            _categorias: filters._categorias,
            _pratos: filters._pratos,
            _de: null, // O backend calcula os 12 meses anteriores se _de for null
            _incluir_zero: false
        };

        const { data, error } = await supa.rpc('get_monthly_sales_chart_data', params);
        if (error) throw error;

        // Mapeamento robusto dos resultados (PT/EN)
        const labels = (data || []).map(d => formatYM(getField(d, ['period','month','mes','data', 'periodo'])));
        const nowData = (data || []).map(d => getField(d, ['current_total','total','current','total_atual','atual']) || 0);
        const prevData = (data || []).map(d => getField(d, ['previous_total','prev_total','previous','total_anterior','anterior']) || 0);

        renderChart('ch_month', 'bar', labels, [
          { label: 'Últimos 12M', data: nowData, backgroundColor: '#7b1e3a' },
          { label: '12M Anteriores', data: prevData, backgroundColor: '#9ca3af' }
        ], { plugins: { legend: { display: false } } });
      } catch (e) { console.error('Erro ao carregar gráfico mensal:', e); toast('Erro ao carregar gráfico mensal', 'error');
        renderChart('ch_month', 'bar', [], []);
      }
  }

  /* ===================== LOOP PRINCIPAL ===================== */
  async function applyAll(details) {
    try {
      const de = details.start, ate = details.end;
      if (!de || !ate || new Date(de+'T12:00:00Z') > new Date(ate+'T12:00:00Z')) { return; }
      const len = daysLen(de, ate);
       
      const filters = prepareFilters();

      /* Mapeamento para a assinatura esperada pelo SQL */
      const commonParams = {
          _de: de,
          _ate: ate,
          _unidades: filters._unidades,
          _categorias: filters._categorias,
          _pratos: filters._pratos
      };

      console.info(`[Debug] Aplicando filtros. Período: ${de} até ${ate} (${len} dias).`);

      const [kpisResult, dowResult, top10Result] = await Promise.allSettled([
          supa.rpc('get_pratos_kpis', commonParams).then(res => res.data?.[0]),
          supa.rpc('get_pratos_dow_chart', commonParams),
          supa.rpc('get_pratos_top10_chart', commonParams).then(res => res.data)
      ]);

      // ATUALIZAÇÃO: Processamento robusto dos resultados (sucesso, falha ou vazio)

      // KPIs
      if (kpisResult.status === 'fulfilled' && kpisResult.value) {
        updateKPIs(kpisResult.value, len);
      } else {
        if (kpisResult.status === 'rejected') {
            console.error("Erro ao buscar KPIs:", kpisResult.reason);
        } else {
            console.warn("[Debug] KPIs não retornaram dados para o período (resultado vazio). Zerando KPIs.");
        }
        // Se falhou ou veio vazio (undefined), zera os KPIs
        updateKPIs(null, len); 
      }

      // Gráfico DOW
      if (dowResult.status === 'fulfilled' && dowResult.value?.data) {
        updateDowChart(dowResult.value.data, len);
      } else {
        if (dowResult.status === 'rejected') console.error("Erro ao buscar dados DOW:", dowResult.reason);
        updateDowChart([], len); // Limpa o gráfico
      }

      // Gráfico Top 10
      if (top10Result.status === 'fulfilled' && top10Result.value) {
        updateTop10Chart(top10Result.value);
      } else {
        if (top10Result.status === 'rejected') console.error("Erro ao buscar dados Top 10:", top10Result.reason);
        updateTop10Chart(null); // Limpa o gráfico
      }
       
      updateMonthChart(ate);

    } catch (e) { console.error('Erro crítico no applyAll:', e); toast('Erro ao aplicar filtros', 'error'); }
  }

  /* ===================== INICIALIZAÇÃO E CONTROLES DA UI ===================== */
  
  async function safeSelectDistinct({ table, column }) {
    // ... (Função inalterada, omitida para brevidade) ...
  }

  async function reloadFilterOptions() {
    // ... (Função inalterada, omitida para brevidade) ...
  }

  /* ===================== FUNÇÃO INIT (CORRIGIDA E ROBUSTA) ===================== */
  // ATUALIZAÇÃO: Lógica de fallback robusta para encontrar a data mais recente.
  async function init() {
    try {
      console.info('[Status] [info]: Inicializando aplicação...');
      let last = null;
      
      // 1. Tenta view dedicada (Ideal)
      try {
        const { data: d1, error: e1 } = await supa.from('vendas_pratos_daterange').select('max_data').limit(1);
        if (!e1 && d1?.length && d1[0].max_data) {
            last = d1[0].max_data;
        }
      } catch (e) { console.warn('[Init] Erro ao acessar vendas_pratos_daterange:', e); }

      // 2. FALLBACK: Tenta a Materialized View
      if (!last) {
        try {
            const { data: d2, error: e2 } = await supa.from('mv_vp_daily_v2')
                .select('data')
                .not('data', 'is', null)
                .order('data', { ascending: false })
                .limit(1);
            if (!e2 && d2?.length) {
                last = d2[0].data;
            }
        } catch (e) { console.warn('[Init] Erro ao acessar mv_vp_daily_v2:', e); }
      }

      // 3. ÚLTIMO FALLBACK: Tenta a tabela raw (Garantia se dados foram recém importados)
      if (!last) {
        try {
            const { data: d3, error: e3 } = await supa.from('vendas_pratos')
                .select('data')
                .not('data', 'is', null)
                .order('data', { ascending: false })
                .limit(1);
            if (!e3 && d3?.length) {
                last = d3[0].data;
            }
        } catch (e) { console.warn('[Init] Erro ao acessar vendas_pratos:', e); }
      }
      
      // Se tudo falhar (banco vazio), usa hoje.
      lastDay = last || getTodayISO();

      await reloadFilterOptions();
       
      document.dispatchEvent(new Event('filters:init'));
      console.info(`[Status] [ok]: Dados atualizados. Data de referência (lastDay): ${lastDay}`);

    } catch (e) { console.error(e); toast('Falha na inicialização', 'error'); }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ... (Controles da UI e Event Listeners - Código omitido para brevidade, pois não foi alterado significativamente) ...

    // IMPORTANTE: A função de importação foi mantida intacta conforme solicitado.
    // ... (Código da função de importação omitido para brevidade) ...
  });
  </script>
</body>
</html>
