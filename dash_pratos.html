<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js" async defer></script>

<style>
    /* v10.8: Encapsulation Refactor (Prefix: dpv-) */
    .dpv-root {
      /* Cores Verificadas */
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#ef4444;
      --c-now:#7b1e3a; --c-prev:#9ca3af;
      
      /* Styles are relative to the root container. */
      background:var(--bg);
      color:var(--ink);
      font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      height: 100%; /* Occupy container height */
      min-height: 600px; /* Ensures minimum functional height */
      overflow: hidden;
      position: relative; /* Creates context for absolute children (dropup) */
    }

    .dpv-root *{box-sizing:border-box}

    .dpv-wrap{display:flex;flex-direction:column; height: 100%; overflow: hidden;}
    /* Main content area handles internal scrolling */
    .dpv-main{flex:1;min-width:0;display:flex;flex-direction:column; overflow-y: auto;}
    .dpv-top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:16px;margin-bottom:8px;justify-content:space-between}
    .dpv-brand{display:flex;align-items:center;gap:10px; font-size:16px; font-weight: 700; color: var(--ink);}
    .dpv-brand.loading::after { content: ' Atualizando...'; font-size: 11px; font-weight: 400; color: var(--muted); }
    .dpv-section{order:2;padding:0 16px 12px 16px}
    .dpv-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .dpv-kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;transition:.2s;position:relative}
    .dpv-kpi h4{margin:0 0 4px 0;color:var(--muted);font-size:11px;display:flex;align-items:center;gap:6px;}
    .dpv-kpi h4 .dpv-spacer { flex-grow: 1; }
    .dpv-kpi .dpv-val{font-size:22px;font-weight:500;letter-spacing:-.5px; color: var(--ink);}
    .dpv-kpi .dpv-sub{font-size:10px;color:var(--muted);margin-top:4px}
    .dpv-delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:700;font-size:10px;margin-left:6px;background:rgba(148,163,184,.15);color:#6b7280}
    .dpv-delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .dpv-delta.down{background:rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.25); color: var(--down); }
    .dpv-charts-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px; flex: 1;}
    .dpv-card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column; min-height: 200px; }
    .dpv-card .dpv-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px; flex-shrink: 0;}
    .dpv-title{font-weight:700; color: var(--ink)}
    .dpv-seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .dpv-seg button{padding:4px 8px;border:0;background:#fff;font-weight:700;color:#475569;cursor:pointer; font-size: 10px;}
    .dpv-seg button:disabled { opacity: 0.6; cursor: default; }
    .dpv-seg button.active{background:var(--wine);color:#fff}
    .dpv-chart-box{position:relative;flex-grow:1;min-height:180px;}
    .dpv-chart-box canvas{display:block;width:100%;height:100%}
    .dpv-chart-message { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: var(--muted); text-align: center; padding: 16px; background: rgba(255,255,255,0.8); }

    /* Media queries adaptadas para o componente */
    @media (max-width:1200px){ .dpv-root .dpv-kpis{grid-template-columns:repeat(2,1fr)} .dpv-root .dpv-charts-grid{grid-template-columns:1fr} }
    @media (max-width: 768px) { .dpv-root .dpv-kpis{ grid-template-columns: 1fr; } .dpv-root .dpv-top { flex-direction: column; align-items: flex-start; gap: 8px; } .dpv-root .dpv-charts-grid{grid-template-columns:1fr} }
  
    .dpv-spinner { animation: dpv-spin 1s linear infinite; }
    @keyframes dpv-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* LAYOUT DO TOP 10 */
    .dpv-top10-header-row, .dpv-top10-row { display: flex; align-items: center; padding: 0 8px; flex-shrink: 0; }
    .dpv-top10-header-row { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--line); padding-bottom: 6px; margin-bottom: 2px; }
    .dpv-top10-list-body { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; overflow-y: auto; }
    .dpv-top10-row { flex-shrink: 0; min-height: 28px; border-bottom: 1px solid #f0f2f5; font-size: 11px; }
    .dpv-top10-row:last-child { border-bottom: none; }
    .dpv-top10-col-rank { flex: 0 0 30px; font-weight: 700; text-align: center; color: var(--muted); }
    .dpv-top10-col-prato { flex: 1 1 auto; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; padding-right: 8px; }
    .dpv-top10-col-qty { flex: 0 0 50px; text-align: right; font-weight: 700; }

    /* Estilos dos Filtros (FX) - Mantém prefixo FX pois são elementos de UI específicos */
    /* Filter bar is sticky relative to the component's bottom */
    .fx-filters-bar{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--line); padding:8px 14px; height:56px; display:flex; align-items:center; justify-content:space-between; }
    .fx-fb-left{display:flex; align-items:center; gap:10px; min-width:0; flex:1}
    .fx-fb-label{font-weight:700; color:var(--ink); font-size:12px; white-space:nowrap;}
    .fx-chips{display:flex; gap:8px; overflow:auto; scrollbar-width:none}
    .fx-chips::-webkit-scrollbar{display:none}
    .fx-chip{flex:0 0 auto; padding:6px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; color:#334155; font-weight:700; cursor:pointer; font-size:11px}
    .fx-chip:disabled { opacity: 0.6; cursor: default; }
    .fx-chip.active{background:var(--wine); color:#fff; border-color:var(--wine)}
    .fx-fb-right{display:flex; align-items:center; gap:8px}
    .fx-iconbtn{display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer}
    .fx-iconbtn:disabled { opacity: 0.6; cursor: default; }
    .fx-textbtn{padding:8px 14px; border:1px solid var(--line); background:#fff; color:#334155; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px; display: inline-flex; align-items: center; gap: 6px;}
    .fx-textbtn:disabled { opacity: 0.6; cursor: default; }
    /* Dropup is absolute positioned relative to the component root (.dpv-root) */
    .fx-dropup{ position:absolute; left:8px; right:8px; bottom:60px; /* Height of filter bar + margin */ z-index:40; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,.08); padding:0; display:none; max-height: 80vh; overflow-y: auto; }
    .fx-dropup.fx-show{display:block; animation:fx-pop .15s ease-out}
    @keyframes fx-pop{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    .fx-du-head{position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line); padding:8px 10px; display:flex; align-items:center; justify-content:space-between; border-top-left-radius:12px; border-top-right-radius:12px}
    .fx-du-title{font-weight:900; color:#334155; font-size:12px}
    .fx-du-body{padding:10px 10px; display:flex; flex-direction:column; gap:10px;}
    .fx-du-sec{display:flex; flex-direction:column; gap:8px}
    .fx-du-sec + .fx-du-sec{padding-top:8px; border-top:1px dashed var(--line)}
    .fx-du-sec h4{margin:0; font-size:11.5px; letter-spacing:.2px; text-transform:uppercase; color:#475569}
    .fx-du-grid{display:grid; grid-template-columns:repeat(12,1fr); gap:8px; align-items:end}
    .fx-field{display:flex; flex-direction:column; gap:4px; min-width:0}
    .fx-label{font-size:10px; color:#64748b}
    .fx-input{ height:30px; padding:4px 8px; border:1px solid var(--line); border-radius:8px; background:#fff; font:inherit }
    .fx-input:disabled { background: #f0f0f0; cursor: default; }
    .fx-period-line{ display:grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end; }
    .fx-seg{border-radius:10px; display:inline-flex; border:1px solid var(--line); background:#fff; white-space:nowrap; overflow:hidden}
    .fx-seg button{ height:30px; min-width:44px; padding:0 10px; border:0; background:transparent; cursor:pointer; font-weight:800; color:#475569; font-size:10px }
    .fx-seg button:disabled { opacity: 0.6; cursor: default; }
    .fx-seg button.fx-active{background:var(--wine); color:#fff}
    
    /* Estilos para MultiSelect (msel) */
    .msel{position:relative}
    .msel-btn{width:100%; text-align: left; height:30px; padding:4px 8px; border:1px solid var(--line); border-radius:8px; background:#fff; font:inherit; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .msel-btn:disabled { background: #f0f0f0; cursor: default; }
    .msel-btn:after{content:"▾";float:right;color:#475569; margin-left: 8px;}
    .msel-panel{position:absolute;z-index:45;bottom:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:250px;overflow:hidden;padding:8px;display:none; flex-direction: column;}
    .msel.open .msel-panel{display:flex}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px; flex-shrink: 0; font-size: 11px;}
    .msel-options-list { overflow-y: auto; flex-grow: 1; }
    .msel-opt{display:flex;align-items:center;gap:8px;padding:5px 6px;border-radius:6px; cursor: pointer; font-size: 11px;}
    .msel-opt:hover{background:#f3f4f6}
    .msel-opt input[type="checkbox"] { margin: 0; flex-shrink: 0; cursor: pointer; }
    .msel-opt span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>

<div class="dpv-root" id="dpvRoot_v10_8">
  <div class="dpv-wrap">
    <main class="dpv-main dpv-main-content">
      <div class="dpv-top">
        <div class="dpv-brand" id="brandHeader">Dashboard de Pratos (v10.8)</div>
        <div class="dpv-seg" id="segDowMode" title="Modo de visualização para Vendas por Dia da Semana">
            <button data-mode="TOTAL" class="active">TOTAL</button>
            <button data-mode="MEDIA">MÉDIA</button>
        </div>
      </div>
      <section class="dpv-section">
        <div class="dpv-kpis">
          <div class="dpv-kpi"><h4><span>Itens Vendidos</span><span class="dpv-spacer"></span><span id="d_qtd" class="dpv-delta flat">—</span></h4><div class="dpv-val" id="k_qtd">—</div><div class="dpv-sub">Anterior: <span id="p_qtd">—</span></div></div>
          <div class="dpv-kpi"><h4><span>Pratos/Itens Únicos</span><span class="dpv-spacer"></span><span id="d_pratos_unicos" class="dpv-delta flat">—</span></h4><div class="dpv-val" id="k_pratos_unicos">—</div><div class="dpv-sub">Anterior: <span id="p_pratos_unicos">—</span></div></div>
          <div class="dpv-kpi"><h4><span>Média Diária</span><span class="dpv-spacer"></span><span id="d_media_diaria" class="dpv-delta flat">—</span></h4><div class="dpv-val" id="k_media_diaria">—</div><div class="dpv-sub">Anterior: <span id="p_media_diaria">—</span></div></div>
        </div>
        <div class="dpv-card" style="margin-bottom: 10px;">
            <div class="dpv-head"><div class="dpv-title">Vendas por Mês</div></div>
            <div class="dpv-chart-box" id="box_month" style="height: 184px; min-height: 184px;"><canvas id="ch_month"></canvas></div>
        </div>
        <div class="dpv-charts-grid">
            <div class="dpv-card">
                <div class="dpv-head">
                    <div class="dpv-title">Vendas por Dia da Semana</div>
                </div>
              <div class="dpv-chart-box" id="box_dow"><canvas id="ch_dow"></canvas></div>
            </div>
            <div class="dpv-card">
                <div class="dpv-head">
                    <div class="dpv-title">Top 10 Pratos</div>
                    <div class="dpv-seg" id="segTop10">
                        <button data-mode="MAIS" class="active">Mais Vendidos</button>
                        <button data-mode="MENOS">Menos Vendidos</button>
                    </div>
                </div>
                <div class="dpv-top10-header-row">
                  <span class="dpv-top10-col-rank">#</span>
                  <span class="dpv-top10-col-prato">Prato</span>
                  <span class="dpv-top10-col-qty">Qtd.</span>
                </div>
                <div id="top10-list-body" class="dpv-top10-list-body">
                   <div style="text-align: center; padding: 20px; color: var(--muted);">Carregando...</div>
                </div>
            </div>
        </div>
      </section>
    </main>

      <footer class="fx-filters-bar" aria-label="Barra de filtros" id="fxFiltersBar">
        <div class="fx-fb-left">
          <div class="fx-fb-label">Filtros:</div>
          <div class="fx-chips" id="fxQuickChips">
              <button class="fx-chip" data-win="today">Hoje (Dados)</button>
              <button class="fx-chip" data-win="yesterday">Ontem (Dados)</button>
              <button class="fx-chip" data-win="lastMonth">Mês Anterior</button>
              <button class="fx-chip" data-win="lastYear">Ano Anterior</button>
          </div>
        </div>
        <div class="fx-fb-right">
          <button class="fx-iconbtn" id="fxBtnMore" title="Mais filtros" aria-haspopup="dialog" aria-expanded="false">
            <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" height="16px" width="16px"><path d="M3 6h18M7 12h10M10 18h4"/></svg>
          </button>
          <button class="fx-textbtn" id="btnUpload">
            <span id="uploadText">Importar</span>
             <svg id="uploadSpinner" class="dpv-spinner" fill="none" viewBox="0 0 24 24" height="14px" width="14px" style="display:none;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" opacity="0.75"></path></svg>
          </button>
          <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
          <button class="fx-textbtn" id="fxBtnReset">Limpar</button>
        </div>
      </footer>
  </div> <div class="fx-dropup" id="fxDropup" role="dialog" aria-modal="true" aria-labelledby="fxDuTitle">
        <div class="fx-du-head">
          <div class="fx-du-title" id="fxDuTitle">Filtros Avançados</div>
        </div>
        <div class="fx-du-body">
          <section class="fx-du-sec" aria-labelledby="fxSecPeriodo">
            <h4 id="fxSecPeriodo">Período Manual</h4>
            <div class="fx-period-line">
              <div class="fx-field"><label class="fx-label">Data inicial</label><input type="date" id="fxDuStart" class="fx-input"></div>
              <div class="fx-field"><label class="fx-label">Data final</label><input type="date" id="fxDuEnd" class="fx-input"></div>
              <div class="fx-quickwrap">
                <div class="fx-seg" id="fxDuQuickDays">
                  <button data-win="7">07</button><button data-win="15">15</button><button data-win="30" class="fx-active">30</button>
                  <button data-win="60">60</button><button data-win="90">90</button><button data-win="120">120</button>
                </div>
              </div>
            </div>
          </section>
          <section class="fx-du-sec" aria-labelledby="fxSecAnaliticos">
            <h4 id="fxSecAnaliticos">Analíticos</h4>
            <div class="fx-du-grid">
              <div class="fx-field" style="grid-column:span 4"><label class="fx-label">Unidade</label><div id="ms-unids" class="msel" data-singular="Unidade"><button class="msel-btn">Carregando...</button><div class="msel-panel"></div></div></div>
              <div class="fx-field" style="grid-column:span 4"><label class="fx-label">Categoria</label><div id="ms-cats" class="msel" data-singular="Categoria"><button class="msel-btn">Carregando...</button><div class="msel-panel"></div></div></div>
              <div class="fx-field" style="grid-column:span 4"><label class="fx-label">Prato</label><div id="ms-pratos" class="msel" data-singular="Prato"><button class="msel-btn">Carregando...</button><div class="msel-panel"></div></div></div>
            </div>
          </section>
        </div>
      </div>
</div> <script>
(function() {
    // v10.8: Encapsulated in IIFE for scope isolation.

    const APP_VERSION = 'v10.8';
    const APP_ID = 'dpvRoot_v10_8'; // Must match the ID of the root container

    // Initialization Guard and Context Setup
    const appContainer = document.getElementById(APP_ID);
    if (!appContainer) {
        console.error(`[${APP_VERSION}] [ERRO] Container principal não encontrado: #${APP_ID}`);
        return;
    }
    // Prevents re-initialization if the script runs again on the same element
    if (appContainer.dataset.initialized === 'true') {
        console.warn(`[${APP_VERSION}] Aviso: Tentativa de inicialização duplicada bloqueada.`);
        return;
    }
    appContainer.dataset.initialized = 'true';

    /* ===================== CONFIG (PROJETO ESTOQUE) ===================== */
    const SUPABASE_URL_ESTOQUE  = 'https://tykdmxaqvqwskpmdiekw.supabase.co';
    const SUPABASE_ANON_ESTOQUE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5a2RteGFxdnF3c2twbWRpZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTg2NDYsImV4cCI6MjA3Mjg3NDY0Nn0.XojR4nVx_Hr4FtZa1eYi3jKKSVVPokG23jrJtm8_3ps';

    // Dependency Check
    if (typeof window.supabase === 'undefined' || typeof window.Chart === 'undefined') {
        console.error(`[${APP_VERSION}] [CRÍTICO] Dependências (Supabase ou Chart.js) não carregadas.`);
        // Optionally display an error message in the UI
        return;
    }
    const supaEstoque = window.supabase.createClient(SUPABASE_URL_ESTOQUE, SUPABASE_ANON_ESTOQUE);

    /* ===================== HELPERS GERAIS ===================== */
    // v10.8: Scoped DOM selectors - Crucial for integration
    const $ = id => appContainer.querySelector(`#${id}`);
    const $$ = sel => appContainer.querySelectorAll(sel);
    const num = (v, decimals = 0) => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  
    // Global State within IIFE
    let isCurrentlyLoading = false;
    let lastDay = '';
    let chartMonth, chartDow;
    let filterUnidades, filterCategorias, filterPratos;

    // Helpers de Data (UTC)
    function getDateUTC(input) {
        /* ... (Código de data mantido igual) ... */
        let d;
        if (typeof input === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(input)) {
            d = new Date(input + 'T12:00:00Z'); 
        } else if (input instanceof Date) {
            d = new Date(Date.UTC(input.getUTCFullYear(), input.getUTCMonth(), input.getUTCDate(), 12, 0, 0));
        } else {
            const now = new Date();
            d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0));
        }
        return isNaN(d.getTime()) ? getDateUTC(new Date()) : d;
    }

    function getDateISO(dateObj) {
        return getDateUTC(dateObj).toISOString().split('T')[0];
    }

    function formatMonthName(isoMonth) {
        /* ... (Código mantido igual) ... */
        if (!isoMonth || !/^\d{4}-\d{2}$/.test(isoMonth)) return isoMonth;
        const [year, monthIndex] = isoMonth.split('-').map(Number);
        const date = new Date(Date.UTC(year, monthIndex - 1, 1));
        const monthName = date.toLocaleString('pt-BR', { month: 'long', timeZone: 'UTC' });
        return monthName.charAt(0).toUpperCase() + monthName.slice(1);
    }
  

    /* ===================== COMPONENTE MULTI-SELECT (MSel) ===================== */
    class MultiSelect {
        /* ... (Código do MultiSelect com suporte a 'silent' - Mantido) ... */
        constructor(containerId, onChangeCallback) {
            this.container = $(containerId);
            if (!this.container) return;
            this.onChange = onChangeCallback;
            this.btn = this.container.querySelector('.msel-btn');
            this.panel = this.container.querySelector('.msel-panel');
            this.labelSingular = this.container.dataset.singular || 'Item';
            this.options = [];
            this.selected = new Set();
            this.isOpen = false;
            this.initialized = false;
            this.initEvents();
        }
        initEvents() {
            this.btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!this.initialized || this.btn.disabled) return;
                this.toggle();
            });
            this.panel.addEventListener('click', (e) => {
                const opt = e.target.closest('.msel-opt');
                if (opt) {
                    const value = opt.dataset.value;
                    const checkbox = opt.querySelector('input[type="checkbox"]');
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    this.handleSelection(value, checkbox.checked, false);
                }
            });
            this.panel.addEventListener('click', (e) => e.stopPropagation());
        }
        initialize(optionsList) {
            this.options = optionsList.sort((a, b) => a.localeCompare(b));
            this.renderPanel();
            this.initialized = true;
            this.updateButtonText();
        }
        toggle() { this.isOpen ? this.close() : this.open(); }
        open() {
            // v10.8: Dispara evento no documento para coordenação global entre MSels
            document.dispatchEvent(new CustomEvent('msel:closeAll', { detail: { except: this.container.id, context: APP_ID } }));
            this.container.classList.add('open');
            this.isOpen = true;
            const searchInput = this.panel.querySelector('.msel-search');
            if (searchInput) {
                searchInput.value = '';
                this.filterOptions('');
                setTimeout(() => searchInput.focus(), 10);
            }
        }
        close() {
            this.container.classList.remove('open');
            this.isOpen = false;
        }
        renderPanel() {
            let html = `<input type="search" class="msel-search" placeholder="Pesquisar...">`;
            html += `<div class="msel-options-list">`;
            if (this.options.length === 0) {
                html += `<div style="text-align: center; padding: 10px; color: var(--muted); font-size: 11px;">Nenhuma opção disponível</div>`;
            } else {
                this.options.forEach(option => {
                    const safeOption = option.replace(/"/g, '&quot;');
                    const isChecked = this.selected.has(option) ? 'checked' : '';
                    html += `<label class="msel-opt" data-value="${safeOption}"><input type="checkbox" ${isChecked}><span>${safeOption}</span></label>`;
                });
            }
            html += `</div>`;
            this.panel.innerHTML = html;
            const searchInput = this.panel.querySelector('.msel-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => this.filterOptions(e.target.value));
            }
        }
        filterOptions(query) {
            const filter = query.toLowerCase();
            const opts = this.panel.querySelectorAll('.msel-opt');
            opts.forEach(opt => {
                const text = opt.dataset.value.toLowerCase();
                opt.style.display = text.includes(filter) ? 'flex' : 'none';
            });
        }
        handleSelection(value, isSelected, silent = false) {
            if (isSelected) {
                this.selected.add(value);
            } else {
                this.selected.delete(value);
            }
            this.updateButtonText();
            if (this.onChange && !silent) this.onChange();
        }
        updateButtonText() {
            const count = this.selected.size;
            if (count === 0) {
                this.btn.textContent = "Todos";
            } else if (count === 1) {
                this.btn.textContent = Array.from(this.selected)[0];
            } else {
                this.btn.textContent = `${count} ${this.labelSingular}s Selec.`;
            }
        }
        getSelected() {
            return this.selected.size > 0 ? Array.from(this.selected) : null;
        }
        reset(silent = false) {
            const hadSelection = this.selected.size > 0;
            this.selected.clear();
            if (this.initialized) {
                this.renderPanel();
                this.updateButtonText();
            }
            if (this.onChange && !silent && hadSelection) this.onChange();
        }
    }

    /* ===================== LÓGICA DOS FILTROS (FX) ===================== */

    // v10.8: fxDispatchApply apenas constrói o payload e dispara o evento. O controle de loading fica no applyAll.
    function fxDispatchApply(){
        const startInput = $('fxDuStart');
        const endInput = $('fxDuEnd');
        if (!startInput || !endInput || !startInput.value || !endInput.value) return;

        if (startInput.value > endInput.value) {
            alert("A data inicial não pode ser posterior à data final.");
            return;
        }

        const payload = { 
            start: startInput.value, 
            end: endInput.value,
            unidades: filterUnidades ? filterUnidades.getSelected() : null,
            categorias: filterCategorias ? filterCategorias.getSelected() : null,
            pratos: filterPratos ? filterPratos.getSelected() : null,
        };
        
        // Dispara evento no container do componente
        appContainer.dispatchEvent(new CustomEvent('filters:apply', { detail: payload }));
    }

    function fxSetRange(start, end) {
        /* ... (Código mantido) ... */
        const startInput = $('fxDuStart');
        const endInput = $('fxDuEnd');
        if (startInput && endInput) {
            startInput.value = getDateISO(start);
            endInput.value = getDateISO(end);
        }
    }

    function fxSetToLastMonthWithData(baseDateStr) {
        /* ... (Código mantido) ... */
        const baseDate = getDateUTC(baseDateStr);
        const year = baseDate.getUTCFullYear();
        const month = baseDate.getUTCMonth(); 
        let startYear = year;
        let startMonth = month - 1;
        if (startMonth < 0) {
            startMonth = 11;
            startYear -= 1;
        }
        const startOfLastMonth = new Date(Date.UTC(startYear, startMonth, 1));
        const endOfLastMonth = new Date(Date.UTC(year, month, 0)); 
        fxSetRange(startOfLastMonth, endOfLastMonth);
        $$('#fxQuickChips button').forEach(b => b.classList.remove('active'));
        const lastMonthBtn = appContainer.querySelector('#fxQuickChips button[data-win="lastMonth"]');
        if (lastMonthBtn) lastMonthBtn.classList.add('active');
        $$('#fxDuQuickDays button').forEach(b => b.classList.remove('fx-active'));
    }

    function setupFilterInteractions() {
        /* ... (Lógica de interação mantida, usando seletores escopados $ e $$) ... */
        const fx = {
            $btnMore: $('fxBtnMore'), $dropup: $('fxDropup'), $quickChips: $('fxQuickChips'),
            $quickDays: $('fxDuQuickDays'), $start: $('fxDuStart'), $end: $('fxDuEnd'), $btnReset: $('fxBtnReset')
        };

        // 1. Toggle do Dropup
        fx.$btnMore.addEventListener('click', (e) => {
            e.stopPropagation();
            if (fx.$btnMore.disabled) return;
            const isShown = fx.$dropup.classList.toggle('fx-show');
            fx.$btnMore.setAttribute('aria-expanded', isShown);
        });

        // v10.8: Listener global (no documento) para fechar o dropup ao clicar fora
        document.addEventListener('click', (e) => {
            if (fx.$dropup.classList.contains('fx-show')) {
                // Fecha se clicou fora do dropup E fora do botão que o abriu
                if (!fx.$dropup.contains(e.target) && !fx.$btnMore.contains(e.target)) {
                    fx.$dropup.classList.remove('fx-show');
                    fx.$btnMore.setAttribute('aria-expanded', false);
                }
            }
            
            // Dispara evento global para fechar MSels se o clique foi dentro do componente
            if (appContainer.contains(e.target)) {
                document.dispatchEvent(new CustomEvent('msel:closeAll', { detail: { context: APP_ID } }));
            }
        });

        fx.$dropup.addEventListener('click', (e) => {
            if (!e.target.closest('.msel')) {
                 e.stopPropagation();
            }
        });

        // 2. Botões Rápidos (Otimizado com silent=true)
        fx.$quickChips.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn || btn.classList.contains('active') || btn.disabled) return;

            $$('#fxQuickChips button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            $$('#fxDuQuickDays button').forEach(b => b.classList.remove('fx-active'));

            // Resetar filtros analíticos (silent=true)
            if (filterUnidades) filterUnidades.reset(true);
            if (filterCategorias) {
                filterCategorias.reset(true);
                const defaultCategory = filterCategorias.options.find(cat => cat.toLowerCase() === 'pratos');
                 if (defaultCategory) {
                    filterCategorias.handleSelection(defaultCategory, true, true);
                }
            }
            if (filterPratos) filterPratos.reset(true);

            const win = btn.dataset.win;
            const baseDate = getDateUTC(lastDay);
            let start, end;

            switch(win) {
                case 'today': start = end = baseDate; break;
                case 'yesterday':
                    start = new Date(baseDate.getTime());
                    start.setUTCDate(baseDate.getUTCDate() - 1);
                    end = start;
                    break;
                case 'lastMonth':
                    fxSetToLastMonthWithData(lastDay);
                    fxDispatchApply();
                    return;
                case 'lastYear':
                    const year = baseDate.getUTCFullYear() - 1;
                    start = new Date(Date.UTC(year, 0, 1));
                    end = new Date(Date.UTC(year, 11, 31));
                    break;
            }

            if (start && end) {
                fxSetRange(start, end);
                fxDispatchApply();
            }
        });

        // 3. Segmento de Dias Rápidos e 4. Mudanças Manuais (Mantido)
        // ... (Lógica de QuickDays e HandleDateChange mantida, usando $ e $$ escopados) ...
        fx.$quickDays.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn || btn.disabled) return;
            $$('#fxDuQuickDays button').forEach(b => b.classList.remove('fx-active'));
            btn.classList.add('fx-active');
            const days = parseInt(btn.dataset.win);
            const currentEndStr = fx.$end.value || lastDay;
            const end = getDateUTC(currentEndStr);
            const start = new Date(end.getTime());
            start.setUTCDate(end.getUTCDate() - (days - 1));
            fxSetRange(start, end);
            $$('#fxQuickChips button').forEach(b => b.classList.remove('active'));
            fxDispatchApply();
        });

        const handleDateChange = () => {
            if (fx.$start.value && fx.$end.value) {
                $$('#fxQuickChips button').forEach(b => b.classList.remove('active'));
                $$('#fxDuQuickDays button').forEach(b => b.classList.remove('fx-active'));
                fxDispatchApply();
            }
        };
        fx.$start.addEventListener('change', handleDateChange);
        fx.$end.addEventListener('change', handleDateChange);

        // 5. Botão Limpar (Reset)
        fx.$btnReset.addEventListener('click', () => {
            if (fx.$btnReset.disabled) return;
            fxSetToLastMonthWithData(lastDay);
            // (Reset silent=true)
            if (filterUnidades) filterUnidades.reset(true);
            if (filterCategorias) {
                filterCategorias.reset(true);
                const defaultCategory = filterCategorias.options.find(cat => cat.toLowerCase() === 'pratos');
                 if (defaultCategory) filterCategorias.handleSelection(defaultCategory, true, true);
            }
            if (filterPratos) filterPratos.reset(true);

            fxDispatchApply();
            fx.$dropup.classList.remove('fx-show');
            fx.$btnMore.setAttribute('aria-expanded', false);
        });
    }

    /* ===================== ESTADO E GRÁFICOS ===================== */

    // Funções de Renderização e Estado

    function setChartMessage(boxId, message) {
        /* ... (Código mantido, usa dpv-chart-message) ... */
        const box = $(boxId);
        if (!box) return;
        let msgDiv = box.querySelector('.dpv-chart-message');
        if (message) {
            if (!msgDiv) {
                msgDiv = document.createElement('div');
                msgDiv.className = 'dpv-chart-message';
                box.appendChild(msgDiv);
            }
            msgDiv.textContent = message;
            msgDiv.style.display = 'flex';
        } else if (msgDiv) {
            msgDiv.style.display = 'none';
        }
    }

    // v10.8: Gerencia o estado de carregamento e a flag global
    function setLoadingState(isLoading) {
        isCurrentlyLoading = isLoading; // Update state flag

        // Seleciona elementos interativos (incluindo os prefixados dpv- e fx-)
        const elementsToDisable = appContainer.querySelectorAll('.fx-filters-bar button, .dpv-seg button, .fx-input, .msel-btn');
        elementsToDisable.forEach(el => {
            // Mantém o botão de upload habilitado, a menos que ele próprio esteja processando
            if (el.id !== 'btnUpload') {
                 el.disabled = isLoading;
            }
        });

        // Indicador de loading no header (dpv-brand)
        const brand = $('brandHeader');
        if (isLoading) {
            brand.classList.add('loading');
            // Mostra "Carregando..." nos gráficos se for a primeira carga
            if (!chartMonth) setChartMessage('box_month', 'Carregando dados...');
            if (!chartDow) setChartMessage('box_dow', 'Carregando dados...');
        } else {
            brand.classList.remove('loading');
        }
    }
  
    function handleApiError(error) {
        console.error(`[${APP_VERSION}] Erro na API:`, error);
        alert(`Falha ao buscar dados do servidor:\n${error.message || error.toString()}`);
        setLoadingState(false);
    }
  
    function updateKpis(kpis) {
        /* ... (Código mantido) ... */
        if (!kpis) kpis = {};
        const c_qtd = kpis.vendas_atual || 0;
        const p_qtd = kpis.vendas_anterior || 0;
        const c_unicos = kpis.pratos_unicos_atual || 0;
        const p_unicos = kpis.pratos_unicos_anterior || 0;
        const c_media = kpis.media_diaria_atual || 0;
        const p_media = kpis.media_diaria_anterior || 0;

        $('k_qtd').textContent = num(c_qtd);
        $('p_qtd').textContent = num(p_qtd);
        updateDelta('d_qtd', c_qtd, p_qtd);

        $('k_pratos_unicos').textContent = num(c_unicos);
        $('p_pratos_unicos').textContent = num(p_unicos);
        updateDelta('d_pratos_unicos', c_unicos, p_unicos);

        $('k_media_diaria').textContent = num(c_media, 1);
        $('p_media_diaria').textContent = num(p_media, 1);
        updateDelta('d_media_diaria', c_media, p_media);
    }

    function updateDelta(elId, current, previous) {
        /* ... (Código mantido, usa dpv-delta classes) ... */
        const el = $(elId);
        if (!el) return;
        el.classList.remove('up', 'down', 'flat');
        current = +current;
        previous = +previous;

        if (current > previous && previous > 0) {
            const delta = ((current - previous) / previous) * 100;
            el.classList.add('up');
            el.textContent = `+${num(delta, 1)}%`;
        } else if (current < previous && previous > 0) {
            const delta = ((previous - current) / previous) * 100;
            el.classList.add('down');
            el.textContent = `-${num(delta, 1)}%`;
        } else {
            el.classList.add('flat');
            el.textContent = '—';
        }
    }

    // Renderiza o gráfico de Vendas por Mês
    function renderMonthChart(data) {
        /* ... (Código mantido, usa window.Chart) ... */
        if (chartMonth) chartMonth.destroy();
        setChartMessage('box_month', null);

        if (!data || !Array.isArray(data) || data.length === 0) {
            setChartMessage('box_month', 'Nenhum dado mensal encontrado.');
            return;
        }

        const ctx = $('ch_month').getContext('2d');
        const labels = data.map(d => formatMonthName(d.mes)); 
        const currentData = data.map(d => d.vendas_atual || 0);
        const previousData = data.map(d => d.vendas_anterior || 0);
        
        chartMonth = new window.Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Período Atual', data: currentData, backgroundColor: 'var(--wine)', borderRadius: 4 },
                    { label: 'Período Anterior', data: previousData, backgroundColor: 'var(--c-prev)', borderRadius: 4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    // Renderiza o gráfico de Vendas por Dia da Semana (DOW)
    function renderDowChart(data, mode = 'TOTAL') {
        /* ... (Código mantido, usa window.Chart) ... */
        if (chartDow) chartDow.destroy();
        setChartMessage('box_dow', null);

        if (!data || !Array.isArray(data) || data.length === 0) {
            setChartMessage('box_dow', 'Nenhum dado semanal encontrado.');
            return;
        }

        const label = (mode === 'MEDIA') ? 'Média de Itens Vendidos' : 'Total de Itens Vendidos';
        const ctx = $('ch_dow').getContext('2d');
        const labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        
        const sortedData = labels.map(dayName => {
            const dayData = data.find(d => d.dia_semana_nome === dayName);
            if (dayData) {
                if (mode === 'MEDIA') {
                    return dayData.media_vendida ?? 0;
                } else {
                    return dayData.total_vendido ?? 0;
                }
            }
            return 0;
        });

        chartDow = new window.Chart(ctx, {
            // ... (Configuração do Chart DOW mantida)
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label, data: sortedData,
                    backgroundColor: 'rgba(123, 30, 58, 0.7)', borderColor: 'var(--wine)', borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } },
                plugins: { tooltip: { callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.x !== null) {
                                    const value = (mode === 'MEDIA') ? num(context.parsed.x, 2) : num(context.parsed.x, 0);
                                    label += value;
                                }
                                return label;
                            }
                } } }
            }
        });
    }

    function renderTop10(data, mode) {
        /* ... (Código mantido, usa classes dpv-top10) ... */
        const listBody = $('top10-list-body');
        if (!listBody) return;

        if (!data || !Array.isArray(data) || data.length === 0) {
            listBody.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--muted); font-size: 11px;">Nenhum dado encontrado.</div>`;
            return;
        }

        data.sort((a, b) => {
            if (mode === 'MAIS') return b.total_vendido - a.total_vendido;
            else return a.total_vendido - b.total_vendido;
        });

        let html = '';
        data.slice(0, 10).forEach((item, index) => {
            html += `
                <div class="dpv-top10-row">
                    <span class="dpv-top10-col-rank">${index + 1}</span>
                    <span class="dpv-top10-col-prato" title="${item.prato}">${item.prato}</span>
                    <span class="dpv-top10-col-qty">${num(item.total_vendido)}</span>
                </div>
            `;
        });
        listBody.innerHTML = html;
    }


    // Função principal de busca de dados
    async function applyAll(payload) {
        if (!payload || !payload.start || !payload.end) return;

        // v10.8: Proteção contra requisições duplicadas (Resolve o Deadlock)
        if (isCurrentlyLoading) {
            console.warn(`[${APP_VERSION}] Tentativa de busca bloqueada: Carregamento já em progresso.`);
            return;
        }
        
        console.log(`[${APP_VERSION}] Buscando dados...`, payload);
        
        const emptyData = {
            kpis: {}, sales_by_month: [], sales_by_dow: [],
            top_10_mais_vendidos: [], top_10_menos_vendidos: []
        };
        let dashboardData = emptyData;

        try {
            setLoadingState(true);

            const { data: rawData, error } = await supaEstoque.rpc('get_sales_dashboard_data', {
                start_date: payload.start,
                end_date: payload.end,
                unidades_filter: payload.unidades,
                categorias_filter: payload.categorias,
                pratos_filter: payload.pratos
            });

            if (error) throw error;

            // Normalização da Resposta
            if (Array.isArray(rawData) && rawData.length > 0 && rawData[0] != null) {
                dashboardData = rawData[0];
            } else if (rawData && typeof rawData === 'object' && !Array.isArray(rawData) && Object.keys(rawData).length > 0) {
                dashboardData = rawData;
            } else {
                console.warn(`[${APP_VERSION}] Aviso: A consulta não retornou dados.`);
            }

            dashboardData = { ...emptyData, ...dashboardData };

        } catch (e) {
            handleApiError(e);
            return;
        } finally {
            // Garante que o estado de carregamento seja sempre finalizado
            setLoadingState(false);
        }

        // Atualiza os KPIs e Gráficos
        updateKpis(dashboardData.kpis);
        renderMonthChart(dashboardData.sales_by_month);

        // Pega o modo atual do DOW (Total/Media)
        const activeDowBtn = appContainer.querySelector('#segDowMode button.active');
        const dowMode = activeDowBtn ? activeDowBtn.dataset.mode : 'TOTAL';
        renderDowChart(dashboardData.sales_by_dow, dowMode);

        // Pega o modo atual do Top 10 (Mais/Menos)
        const activeTop10Btn = appContainer.querySelector('#segTop10 button.active');
        const top10Mode = activeTop10Btn ? activeTop10Btn.dataset.mode : 'MAIS';
        const top10Data = (top10Mode === 'MAIS') ? dashboardData.top_10_mais_vendidos : dashboardData.top_10_menos_vendidos;
        renderTop10(top10Data, top10Mode);
        
        // Armazena no container local
        appContainer.currentData = dashboardData;
        console.info(`[Status ${APP_VERSION}] [ok]: Dados atualizados.`);
    }


    /* ===================== LÓGICA DE IMPORTAÇÃO ===================== */
  
    // Helpers de Parsing (Mantidos)
    function parseExcelDate(serial) {
        /* ... (Código mantido) ... */
        if (typeof serial !== 'number' || !isFinite(serial)) return null;
        const excelEpochDiff = 25569; 
        const millisecondsPerDay = 24 * 60 * 60 * 1000;
        const timestamp = (serial - excelEpochDiff) * millisecondsPerDay;
        const date = new Date(timestamp);
        return isNaN(date.getTime()) ? null : date;
    }

    function parseBrazilianDate(dateString) {
        /* ... (Código mantido) ... */
        if (typeof dateString !== 'string') return null;
        const normalizedString = dateString.trim().split(' ')[0];
        const parts = normalizedString.split('/');
        if (parts.length !== 3) return null;
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        let year = parseInt(parts[2], 10);
        if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
        if (year >= 0 && year < 100) year += (year < 50) ? 2000 : 1900;
        if (month < 1 || month > 12 || day < 1 || day > 31 || year < 1900) return null;
        const date = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
        if (date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) return null;
        return date;
    }

    // v10.8: Cheque de XLSX movido para dentro do listener de clique/change.
    async function setupImportFeature() {
        const btnUpload = $('btnUpload');
        const fileInput = $('fileExcel');
        const uploadText = $('uploadText');
        const uploadSpinner = $('uploadSpinner');

        if (!btnUpload || !fileInput) return;

        btnUpload.addEventListener('click', () => {
            if (btnUpload.disabled) return;

            // Verifica a disponibilidade do XLSX no momento do clique
            if (typeof window.XLSX === 'undefined') {
                alert("A biblioteca de importação (XLSX) ainda não foi carregada ou falhou ao carregar. Por favor, aguarde alguns segundos ou recarregue a página.");
                return;
            }

            fileInput.click();
        });

        fileInput.addEventListener('change', async (event) => {
            // Verifica novamente
            if (typeof window.XLSX === 'undefined') {
                alert("Erro crítico: A biblioteca de importação (XLSX) não está disponível.");
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            btnUpload.disabled = true;
            uploadText.textContent = 'Processando...';
            uploadSpinner.style.display = 'inline-block';

            try {
                // 1. Leitura do Arquivo (Usando window.XLSX)
                /* ... (Lógica de leitura e processamento mantida) ... */
                const data = await file.arrayBuffer();
                const readOptions = { type: 'array', cellDates: false };
                if (file.name.toLowerCase().endsWith('.csv')) readOptions.type = 'binary';

                const workbook = window.XLSX.read(data, readOptions);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rawData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, defval: null });

                if (rawData.length <= 1) throw new Error("O arquivo está vazio ou contém apenas o cabeçalho.");

                // 2. Processamento e Validação
                rawData.shift();
                const processedData = rawData.map((row, index) => {
                    if (row.length < 5 || row[1] == null || row[2] == null) return null;
                    const rawDate = row[0];
                    let date;
                    if (typeof rawDate === 'string') date = parseBrazilianDate(rawDate);
                    if (!date && typeof rawDate === 'number') date = parseExcelDate(rawDate); 
                    if (!date && rawDate) {
                         const parsedDate = new Date(rawDate);
                         if (!isNaN(parsedDate.getTime())) date = parsedDate;
                    }
                    if (!date) {
                        console.warn(`[Importação] Linha ${index + 2} ignorada: data inválida (${rawDate}).`);
                        return null;
                    }
                    const quantity = parseInt(row[4], 10);
                    if (isNaN(quantity) || quantity <= 0) return null;

                    return {
                        data: getDateISO(date),
                        unidade: String(row[1]).trim(),
                        prato: String(row[2]).trim(),
                        categoria: row[3] ? String(row[3]).trim() : 'N/A',
                        quantidade: quantity
                    };
                }).filter(item => item !== null);

                if (processedData.length === 0) throw new Error("Nenhum dado válido encontrado no arquivo.");

                // 3. Upload em Lotes
                uploadText.textContent = 'Enviando...';
                const BATCH_SIZE = 500;
                let totalInserted = 0;
                for (let i = 0; i < processedData.length; i += BATCH_SIZE) {
                    const batch = processedData.slice(i, i + BATCH_SIZE);
                    const { data, error } = await supaEstoque.from('vendas_pratos').insert(batch).select();
                    if (error) throw new Error(`Falha ao enviar lote: ${error.message}`);
                    if (data) totalInserted += data.length;
                }

                alert(`${totalInserted} registros importados com sucesso!\n\nAtualizando dashboard...`);
                window.location.reload();

            } catch (error) {
                console.error(`[${APP_VERSION}] Erro na importação:`, error);
                alert(`Falha na importação:\n${error.message}`);
            } finally {
                // Reset do estado
                btnUpload.disabled = false;
                uploadText.textContent = 'Importar';
                uploadSpinner.style.display = 'none';
                fileInput.value = '';
            }
        });
    }


    /* ===================== INICIALIZAÇÃO E CONTROLES DA UI ===================== */
  
    function setupUIControls() {
        // Top 10 Segmented Control (dpv-seg)
        const segTop10 = $('segTop10');
        if (segTop10) {
            segTop10.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn || btn.classList.contains('active') || btn.disabled) return;

                $$('#segTop10 button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const mode = btn.dataset.mode;
                // Usa os dados armazenados no container
                if (appContainer.currentData) {
                    const top10Data = (mode === 'MAIS') ? appContainer.currentData.top_10_mais_vendidos : appContainer.currentData.top_10_menos_vendidos;
                    renderTop10(top10Data, mode);
                }
            });
        }

        // DOW Mode (Total vs Media) Segmented Control (dpv-seg)
        const segDowMode = $('segDowMode');
        if (segDowMode) {
            segDowMode.addEventListener('click', (e) => {
                 const btn = e.target.closest('button');
                if (!btn || btn.classList.contains('active') || btn.disabled) return;

                $$('#segDowMode button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Usa os dados armazenados no container
                if (appContainer.currentData && appContainer.currentData.sales_by_dow) {
                    renderDowChart(appContainer.currentData.sales_by_dow, btn.dataset.mode);
                }
            });
        }
    }

    // Função de inicialização principal
    async function init() {
        try {
            console.info(`[Status ${APP_VERSION}] [info]: Inicializando aplicação...`);
            
            // v10.8: Desabilita a UI inicialmente (sem setar a flag isCurrentlyLoading para evitar deadlock)
            setLoadingState(true); 

            // 1. Inicializar componentes MultiSelect
            filterUnidades = new MultiSelect('ms-unids', fxDispatchApply);
            filterCategorias = new MultiSelect('ms-cats', fxDispatchApply);
            filterPratos = new MultiSelect('ms-pratos', fxDispatchApply);

            setupUIControls();

            // v10.8: Listener global (no documento) para fechar MSels corretamente entre componentes
            document.addEventListener('msel:closeAll', (e) => {
                const detail = e.detail || {};
                const exceptId = detail.except;
                
                [filterUnidades, filterCategorias, filterPratos].forEach(ms => {
                    // Garante que o MS pertence a este componente antes de fechar
                    if (ms && ms.isOpen && ms.container.id !== exceptId && appContainer.contains(ms.container)) {
                        ms.close();
                    }
                });
            });

            // 2. Buscar Data Máxima e Opções de Filtro
            const [dateResult, filterResult] = await Promise.all([
                supaEstoque.from('vendas_pratos_daterange').select('max_data').maybeSingle(),
                supaEstoque.rpc('get_filter_options')
            ]);

            // Processar Data Máxima
            /* ... (Lógica de data mantida) ... */
            if (dateResult.error || !dateResult.data || !dateResult.data.max_data) {
                console.warn(`[${APP_VERSION}] Aviso: Falha ao buscar data mais recente. Usando data atual.`);
                lastDay = getDateISO();
            } else {
                lastDay = dateResult.data.max_data;
            }
            console.info(`[Status ${APP_VERSION}] Data base definida para: ${lastDay}`);

            // Processar Opções de Filtro
            /* ... (Lógica de inicialização de filtros mantida) ... */
            if (filterResult.error) {
                console.error(`[${APP_VERSION}] Erro ao carregar opções de filtro.`);
                filterUnidades.initialize([]); filterCategorias.initialize([]); filterPratos.initialize([]);
            } else {
                const optionsData = (Array.isArray(filterResult.data) && filterResult.data.length > 0) ? filterResult.data[0] : filterResult.data;
                if (optionsData && typeof optionsData === 'object') {
                    filterUnidades.initialize(optionsData.unidades || []);
                    filterCategorias.initialize(optionsData.categorias || []);
                    filterPratos.initialize(optionsData.pratos || []);
                    const defaultCategory = (optionsData.categorias || []).find(cat => cat.toLowerCase() === 'pratos');
                    if (defaultCategory) {
                        filterCategorias.selected.add(defaultCategory);
                        filterCategorias.updateButtonText();
                    }
                }
            }

            // v10.8: Habilita a UI antes de disparar a primeira busca.
            setLoadingState(false); 

            // 3. Dispara o evento de inicialização dos filtros
            appContainer.dispatchEvent(new Event('filters:init'));
            
        } catch (e) { 
            console.error(`[${APP_VERSION}] Erro crítico na inicialização:`, e);
            handleApiError(new Error("Falha crítica na inicialização da aplicação."));
        }
    }

    // Inicialização principal do script
    console.log(`[DIAGNÓSTICO ${APP_VERSION}] Script iniciado (via IIFE).`);

    // Configura os listeners principais no container do componente
    appContainer.addEventListener('filters:apply', (e) => {
        applyAll(e.detail);
    });

    appContainer.addEventListener('filters:init', () => {
        setupFilterInteractions(); 
        fxSetToLastMonthWithData(lastDay); 
        fxDispatchApply(); // Dispara a busca inicial
    });

    // Configura a Importação
    setupImportFeature();

    init(); // Inicia o processo

})(); // Fim da IIFE (v10.8)
</script>
