<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dash Pratos</title>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#ef4444;
      --c-now:#7b1e3a; --c-prev:#9ca3af;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; height: 100%; overflow: hidden;}
    .wrap{display:flex;flex-direction:column;min-height:100vh; height: 100%; overflow: hidden;}
    .main{flex:1;min-width:0;display:flex;flex-direction:column; overflow-y: auto; padding-bottom: 60px;}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:16px;margin-bottom:8px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px; font-size:16px; font-weight: 700; color: var(--ink);}
    .section{order:2;padding:0 16px 12px 16px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;transition:.2s;position:relative}
    .kpi h4{margin:0 0 4px 0;color:var(--muted);font-size:11px;display:flex;align-items:center;gap:6px;}
    .kpi h4 .spacer { flex-grow: 1; }
    .kpi .val{font-size:22px;font-weight:500;letter-spacing:-.5px}
    .kpi .sub{font-size:10px;color:var(--muted);margin-top:4px}
    .delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:700;font-size:10px;margin-left:6px;background:rgba(148,163,184,.15);color:#6b7280}
    .delta svg{width:10px;height:10px;fill:currentColor}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .delta.down{background:rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.25); color: var(--down); }
    .charts-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px; flex: 1;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column; min-height: 200px; }
    .card .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px; flex-shrink: 0;}
    .title{font-weight:700; color: var(--ink)}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:4px 8px;border:0;background:#fff;font-weight:700;color:#475569;cursor:pointer; font-size: 10px;}
    .seg button.active{background:var(--wine);color:#fff}
    .chart-box{position:relative;flex-grow:1;min-height:180px;}
    .chart-box canvas{display:block;width:100%;height:100%}
    .chart-message { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: var(--muted); text-align: center; padding: 16px; }

    @media (max-width:1200px){ .kpis{grid-template-columns:repeat(2,1fr)} .charts-grid{grid-template-columns:1fr} }
    @media (max-width: 768px) { .kpis{ grid-template-columns: 1fr; } .top { flex-direction: column; align-items: flex-start; } }
  
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ESTILOS DA CAIXA DE DIÁLOGO (MODAL) E TOP 10 */
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: center; justify-content: center; }
    .modal-backdrop.modal-show { display: flex; }
    .modal-content { background: var(--card); padding: 16px 20px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .modal-content h4 { margin: 0 0 8px 0; font-size: 14px; }
    .modal-content p { margin: 0 0 16px 0; font-size: 11px; color: var(--muted); }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .fx-textbtn.secondary { background: #e5e7eb; }
    .top10-header-row, .top10-row { display: flex; align-items: center; padding: 0 8px; flex-shrink: 0; }
    .top10-header-row { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--line); padding-bottom: 6px; margin-bottom: 2px; }
    .top10-list-body { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
    .top10-row { flex-grow: 1; border-bottom: 1px solid #f0f2f5; font-size: 11px; }
    .top10-row:last-child { border-bottom: none; }
    .top10-col-rank { flex: 0 0 30px; font-weight: 700; text-align: center; color: var(--muted); }
    .top10-col-prato { flex: 1 1 auto; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; padding-right: 8px; }
    .top10-col-qty { flex: 0 0 50px; text-align: right; font-weight: 700; }
    .top10-row[data-rank="1"] .top10-col-rank { color: #d4af37; font-size: 14px; }
    .top10-row[data-rank="2"] .top10-col-rank { color: #c0c0c0; font-size: 13px; }
    .top10-row[data-rank="3"] .top10-col-rank { color: #cd7f32; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="main main-content">
      <div class="top">
        <div class="brand">Dashboard de Pratos</div>
        <div class="seg" id="segDowMode">
            <button data-mode="TOTAL" class="active">TOTAL</button>
            <button data-mode="MEDIA">MÉDIA</button>
        </div>
      </div>
      <section class="section">
        <div class="kpis">
          <div class="kpi"><h4><span>Itens Vendidos</span><span class="spacer"></span><span id="d_qtd" class="delta flat">—</span></h4><div class="val" id="k_qtd">—</div><div class="sub">Anterior: <span id="p_qtd">—</span></div></div>
          <div class="kpi"><h4><span>Pratos/Itens Únicos</span><span class="spacer"></span><span id="d_pratos_unicos" class="delta flat">—</span></h4><div class="val" id="k_pratos_unicos">—</div><div class="sub">Anterior: <span id="p_pratos_unicos">—</span></div></div>
          <div class="kpi"><h4><span>Média Diária</span><span class="spacer"></span><span id="d_media_diaria" class="delta flat">—</span></h4><div class="val" id="k_media_diaria">—</div><div class="sub">Anterior: <span id="p_media_diaria">—</span></div></div>
        </div>
        <div class="card" style="margin-bottom: 10px;">
            <div class="head"><div class="title">Vendas por Mês</div></div>
            <div class="chart-box" id="box_month" style="height: 184px; min-height: 184px;"><canvas id="ch_month"></canvas></div>
        </div>
        <div class="charts-grid">
            <div class="card">
                <div class="head">
                    <div class="title">Vendas por Dia da Semana</div>
                    <button id="btnExportDow" class="fx-iconbtn" title="Exportar Média Semanal (CSV)" style="width: 28px; height: 28px;">
                        <svg id="iconDownload" fill="currentColor" viewBox="0 0 20 20" height="14px" width="14px"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg>
                        <svg id="iconSpinner" class="spinner" fill="none" viewBox="0 0 24 24" height="16px" width="16px" style="display:none;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" opacity="0.75"></path></svg>
                    </button>
                </div>
              <div class="chart-box" id="box_dow"><canvas id="ch_dow"></canvas></div>
            </div>
            <div class="card">
                <div class="head">
                    <div class="title">Top 10 Pratos</div>
                    <div class="seg" id="segTop10">
                        <button data-mode="MAIS" class="active">Mais Vendidos</button>
                        <button data-mode="MENOS">Menos Vendidos</button>
                    </div>
                </div>
                <div class="top10-header-row">
                  <span class="top10-col-rank">#</span>
                  <span class="top10-col-prato">Prato</span>
                  <span class="top10-col-qty">Qtd.</span>
                </div>
                <div id="top10-list-body" class="top10-list-body">
                   <div style="text-align: center; padding: 20px; color: var(--muted);">Carregando...</div>
                </div>
            </div>
        </div>
      </section>
    </main>
  </div>
  
  <style>
    .fx-filters-bar{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--line); padding:8px 14px; height:56px; display:flex; align-items:center; justify-content:space-between; }
    .fx-fb-left{display:flex; align-items:center; gap:10px; min-width:0; flex:1}
    .fx-fb-label{font-weight:700; color:var(--ink); font-size:12px; white-space:nowrap;}
    .fx-chips{display:flex; gap:8px; overflow:auto; scrollbar-width:none}
    .fx-chips::-webkit-scrollbar{display:none}
    .fx-chip{flex:0 0 auto; padding:6px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; color:#334155; font-weight:700; cursor:pointer; font-size:11px}
    .fx-chip.active{background:var(--wine); color:#fff; border-color:var(--wine)}
    .fx-fb-right{display:flex; align-items:center; gap:8px}
    .fx-iconbtn{display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer}
    .fx-textbtn{padding:8px 14px; border:1px solid var(--line); background:#fff; color:#334155; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px; display: inline-flex; align-items: center; gap: 6px;}
    /* ... (Restante dos estilos FX omitidos) ... */
  </style>

  <footer class="fx-filters-bar" aria-label="Barra de filtros">
    </footer>

  <div class="fx-dropup" id="fxDropup" role="dialog" aria-modal="true" aria-labelledby="fxDuTitle">
     </div>

  <div id="exportModal" class="modal-backdrop">
     </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  /* ===================== CONFIG (PROJETO ESTOQUE) ===================== */
  const SUPABASE_URL_ESTOQUE  = 'https://tykdmxaqvqwskpmdiekw.supabase.co';
  const SUPABASE_ANON_ESTOQUE = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5a2RteGFxdnF3c2twbWRpZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTg2NDYsImV4cCI6MjA3Mjg3NDY0Nn0.XojR4nVx_Hr4FtZa1eYi3jKKSVVPokG23jrJtm8_3ps';
  const supaEstoque = window.supabase.createClient(SUPABASE_URL_ESTOQUE, SUPABASE_ANON_ESTOQUE);

  /* ===================== HELPERS ===================== */
  const $ = id => document.getElementById(id);
  const $$ = sel => document.querySelectorAll(sel);
  const num = (v, decimals = 0) => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
  
  // Funções de Data e Filtros (Omitidas por brevidade, assumindo que estão corretas como nas versões anteriores)
  function getDateISO(baseDate) { /* ... (Implementação anterior) ... */ }
  function fxDispatchApply() { /* ... (Implementação anterior) ... */ }
  function fxSetRange(start, end) { /* ... (Implementação anterior) ... */ }
  function fxSetToLastMonthWithData(baseDateStr) { /* ... (Implementação anterior) ... */ }

  
  /* ===================== ESTADO E GRÁFICOS ===================== */
  let lastDay = '';
  let chartMonth, chartDow;

  // Helper para gerenciar mensagens nos gráficos (erro ou vazio)
  function setChartMessage(boxId, message) {
    const box = $(boxId);
    if (!box) return;
    const existingMessage = box.querySelector('.chart-message');
    if (existingMessage) {
        box.removeChild(existingMessage);
    }
    if (message) {
        box.insertAdjacentHTML('beforeend', `<div class="chart-message">${message}</div>`);
    }
  }

  // Função principal de busca de dados (CORRIGIDA)
  async function applyAll(startDate, endDate) {
      if (!startDate || !endDate) return;
      
      console.log(`[v9.1] Buscando dados de ${startDate} a ${endDate}`);
      setLoadingState(true);

      // Chama a função RPC. Renomeamos 'data' para 'rawData'.
      const { data: rawData, error } = await supaEstoque.rpc('get_sales_dashboard_data', {
          start_date: startDate,
          end_date: endDate
      });

      setLoadingState(false);

      if (error) {
          handleApiError(error);
          return;
      }

      // >>>>> CORREÇÃO DO ERRO data.map (Normalização da Resposta) <<<<<
      // O Supabase pode retornar um objeto único OU um array contendo o objeto (causa do erro).
      let dashboardData;

      if (Array.isArray(rawData) && rawData.length > 0) {
          // Cenário onde a resposta veio envolvida em um Array
          console.log("[DIAGNÓSTICO] Dados recebidos em formato Array, extraindo primeiro elemento.");
          dashboardData = rawData[0];
      } else if (rawData && typeof rawData === 'object' && !Array.isArray(rawData) && Object.keys(rawData).length > 0) {
          // Cenário onde a resposta é o próprio objeto
          dashboardData = rawData;
      } else {
          // Cenário onde a resposta é nula, vazia ou inesperada
          console.error("[v9.1] Resposta do RPC em formato inesperado ou vazia:", rawData);
          alert("Falha ao carregar dados: Resposta do servidor inválida ou vazia.");
          // Renderiza estado vazio
          updateKpis({});
          renderMonthChart([]);
          renderDowChart([]);
          renderTop10([], 'MAIS');
          return;
      }
      // >>>>> FIM DA CORREÇÃO <<<<<


      // Verifica se a função SQL retornou um erro interno
      if (dashboardData.error) {
        console.error("[v9.1] Erro interno na função SQL:", dashboardData.error);
        alert(`ERRO NO SQL DO SERVIDOR (Verifique nomes de tabelas/colunas):\n\n${dashboardData.error}`);
      }
      
      // Atualiza os KPIs e Gráficos
      updateKpis(dashboardData.kpis);
      renderMonthChart(dashboardData.sales_by_month);
      renderDowChart(dashboardData.sales_by_dow);

      // Define o estado do Top 10
      const activeTop10Btn = document.querySelector('#segTop10 button.active');
      const mode = activeTop10Btn ? activeTop10Btn.dataset.mode : 'MAIS';
      const top10Data = (mode === 'MAIS') ? dashboardData.top_10_mais_vendidos : dashboardData.top_10_menos_vendidos;
      renderTop10(top10Data, mode);
      
      // Armazena dados para alternância
      window.dashboardData = dashboardData;
      console.info('[Status v9.1] [ok]: Dados atualizados.');
  }

  // Funções de Estado e Tratamento de Erro (Melhoradas)
  function setLoadingState(isLoading) {
    const listBody = $('top10-list-body');
    if (isLoading) {
        $('k_qtd').textContent = '...';
        // ... (outros KPIs)
        setChartMessage('box_month', 'Carregando...');
        setChartMessage('box_dow', 'Carregando...');
        if (listBody) {
            listBody.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--muted);">Carregando...</div>`;
        }
    } else {
        setChartMessage('box_month', null);
        setChartMessage('box_dow', null);
    }
  }

  function handleApiError(error) {
    console.error("[v9.1] Erro ao buscar dados do dashboard (RPC). Detalhes:", error);
    
    // Atualiza a UI para refletir o erro
    $('k_qtd').textContent = '—';
    // ... (outros KPIs)
    setChartMessage('box_month', 'Falha ao carregar.');
    setChartMessage('box_dow', 'Falha ao carregar.');
    const listBody = $('top10-list-body');
    if (listBody) {
        listBody.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--down);">Falha ao carregar dados.</div>`;
    }

    if (error.message && error.message.includes('Failed to fetch')) {
        alert("ERRO DE REDE (Failed to fetch): Não foi possível conectar ao Supabase.\n\nVerifique sua conexão com a internet ou as configurações de CORS no projeto (ex: permitir o domínio Vercel).");
    } else {
        alert(`Falha ao carregar dados: ${error.message || 'Erro desconhecido'} (Código: ${error.code || 'N/A'})`);
    }
  }
  
  // Funções de Renderização (Com robustez adicionada)
  function updateKpis(kpis) {
      // (Implementação robusta anterior)
      if (!kpis || typeof kpis !== 'object' || Object.keys(kpis).length === 0) {
        // Resetar KPIs para 0
        return;
      }
      // ... (Atualização dos valores dos KPIs)
  }
  
  function updateDelta(elId, current, previous) { /* ... (Implementação anterior) ... */ }

  // >>>>> CORREÇÃO ADICIONAL: Validação de Array antes do .map() <<<<<
  function renderMonthChart(data) {
    if (chartMonth) chartMonth.destroy();
    setChartMessage('box_month', null);

    // Verificação de robustez: Garante que 'data' seja um Array válido.
    if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn("[v9.1] Dados do gráfico mensal inválidos ou vazios.");
        setChartMessage('box_month', 'Nenhum dado mensal encontrado.');
        return; // Sai da função se não houver dados válidos
    }

    const ctx = $('ch_month').getContext('2d');
    // As linhas abaixo agora são seguras, pois 'data' é um array válido
    const labels = data.map(d => d.mes);
    const currentData = data.map(d => d.vendas_atual);
    const previousData = data.map(d => d.vendas_anterior);
    
    chartMonth = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Período Atual', data: currentData, backgroundColor: 'var(--wine)', borderRadius: 4 },
                { label: 'Período Anterior', data: previousData, backgroundColor: 'var(--c-prev)', borderRadius: 4 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
  }

  function renderDowChart(data) {
    if (chartDow) chartDow.destroy();
    setChartMessage('box_dow', null);

    // Verificação de robustez
    if (!data || !Array.isArray(data)) {
        data = [];
    }

    if (data.length === 0) {
        setChartMessage('box_dow', 'Nenhum dado semanal encontrado.');
    }

    const ctx = $('ch_dow').getContext('2d');
    const labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    const sortedData = labels.map(label => data.find(d => d.dia_semana_nome === label) || { total_vendido: 0 });

    chartDow = new Chart(ctx, {
        // ... (Configuração do gráfico Dow)
    });
  }

  function renderTop10(data, mode) {
      const listBody = $('top10-list-body');
      if (!listBody) return;
      listBody.innerHTML = '';

      // Verificação de robustez
      if (!data || !Array.isArray(data) || data.length === 0) {
          listBody.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--muted);">Nenhum prato encontrado no período.</div>`;
          return;
      }
      
      // ... (Lógica de renderização do Top 10)
  }

  /* ===================== INICIALIZAÇÃO E CONTROLES DA UI ===================== */
  async function init() {
    try {
      console.info('[Status v9.1] [info]: Inicializando aplicação...');
      // Tenta buscar a data mais recente. Usamos .maybeSingle() para otimizar a busca de uma única linha.
      // Isso retorna o objeto diretamente, sem array wrapper.
      const { data, error } = await supaEstoque.from('vendas_pratos_daterange').select('max_data').maybeSingle();
      
      if (error) {
          // Tratamento para erros (incluindo 'Failed to fetch' se for capturado aqui)
          console.warn(`[v9.1] Aviso na inicialização: Falha ao buscar data mais recente. Verifique a view 'vendas_pratos_daterange', permissões ou conexão/CORS. Erro: ${error.message}`);
          lastDay = getDateISO(); // Fallback para data atual
      } else if (data && data.max_data) {
          lastDay = data.max_data;
      } else {
          console.warn("[v9.1] Tabela/View de vendas vazia ou data máxima nula.");
          lastDay = getDateISO(); // Fallback para data atual
      }
      
      console.info(`[Status v9.1] Data base definida para: ${lastDay}`);
      document.dispatchEvent(new Event('filters:init'));
      
    } catch (e) { 
        // Captura erros inesperados que o SDK pode não ter tratado internamente (como alguns 'Failed to fetch')
        console.error("[v9.1] Erro crítico na inicialização:", e);
        
        if (e.message && e.message.includes('Failed to fetch')) {
            alert("Falha Crítica de Rede (Failed to fetch) ao inicializar.\n\nVerifique sua conexão com a internet e as configurações de CORS no Supabase (ex: permitir o domínio Vercel).");
        } else {
            alert("Falha crítica ao inicializar o Dashboard.");
        }

        // Tenta continuar com fallback mesmo após erro crítico
        lastDay = getDateISO();
        document.dispatchEvent(new Event('filters:init'));
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log("[DIAGNÓSTICO v9.1] Script final iniciado.");

    // Listeners de Eventos (Sem alterações)
    document.addEventListener('filters:apply', (e) => {
        applyAll(e.detail.start, e.detail.end);
    });

    document.addEventListener('filters:init', () => {
        fxSetToLastMonthWithData(lastDay); 
        fxDispatchApply();
    });

    const segTop10 = $('segTop10');
    if (segTop10) {
        segTop10.addEventListener('click', (e) => {
            // ... (Lógica do listener do Top 10)
        });
    }

    init(); // Inicia o processo de inicialização
  });
  
  </script>
</body>
</html>
