<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  /* ===================== CONFIG ===================== */
  const SUPABASE_URL  = 'https://tykdmxaqvqwskpmdiekw.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5a2RteGFxdnF3c2twbWRpZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTg2NDYsImV4cCI6MjA3Mjg3NDY0Nn0.XojR4nVx_Hr4FtZa1eYi3jKKSVVPokG23jrJtm8_3ps';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===================== CHART DEFAULTS ===================== */
  Chart.defaults.font.family = '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif';
  Chart.defaults.color = '#334155';
  Chart.defaults.plugins.legend.position = 'top';
  Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.95)';
  Chart.defaults.datasets.bar.borderRadius = 6;
  Chart.defaults.datasets.bar.borderSkipped = false;
  Chart.defaults.devicePixelRatio = Math.max(1, window.devicePixelRatio || 1);

  /* ===================== HELPERS ===================== */
  const $ = id => document.getElementById(id);
  const num = v => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
  
  function getTodayISO(baseDate) {
    const d = baseDate ? new Date(baseDate + 'T12:00:00Z') : new Date();
    d.setHours(12, 0, 0, 0);
    return d.toISOString().split('T')[0];
  }

  function daysLen(de, ate) {
    if (!de || !ate) return 0;
    const d1 = new Date(de + 'T12:00:00Z');
    const d2 = new Date(ate + 'T12:00:00Z');
    return Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
  }

  function formatYM(isoStr){
    if (!isoStr) return '';
    const d = new Date(isoStr + 'T12:00:00Z');
    const m = d.getMonth();
    const y = String(d.getFullYear()).slice(-2);
    const n = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    return `${n[m]}/${y}`;
  }

  const rmAcc = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  
  function fxDispatchApply(){
      const payload = { start: $('fxDuStart').value, end: $('fxDuEnd').value };
      document.dispatchEvent(new CustomEvent('filters:apply', { detail: payload }));
  }

  /* ===================== MULTISELECT ===================== */
  function MultiSelect(rootId, placeholder){
    const root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
    let options=[], selected=new Set(), filtered=[];
    function render(){
      panel.innerHTML='';
      const q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar…';
      q.addEventListener('input',()=>{filtered=options.filter(v=>rmAcc(v).toLowerCase().includes(rmAcc(q.value).toLowerCase())); drawOptions();});
      panel.appendChild(q);
      drawOptions();
    }
    function drawOptions(){
      panel.querySelectorAll('.msel-opt-box').forEach(n=>n.remove());
      const box=document.createElement('div'); box.className = 'msel-opt-box';
      (filtered.length > 0 ? filtered : options).forEach(v=>{
        const row=document.createElement('div'); row.className='msel-opt';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=selected.has(v);
        const lb=document.createElement('label'); lb.textContent=v;
        cb.addEventListener('change',()=>{
            cb.checked?selected.add(v):selected.delete(v); 
            refresh();
            fxDispatchApply();
        });
        row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
      });
      panel.appendChild(box);
    }
    function refresh(){ btn.textContent = selected.size===0 ? placeholder : `${selected.size} selecionado(s)`; }
    btn.addEventListener('click',()=>root.classList.toggle('open'));
    document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) root.classList.remove('open'); });
    return {
      setOptions(list){ options=(list||[]).filter(v=>v!=null).map(String).sort((a,b)=>a.localeCompare(b,'pt-BR')); filtered=options.slice(); selected=new Set([...selected].filter(v=>options.includes(v))); render(); refresh(); },
      get(){return [...selected];},
      set(vals){selected=new Set((vals||[]).map(String)); refresh(); drawOptions();},
      clear(){ this.set([]); }
    };
  }

  /* ===================== ESTADO ===================== */
  let lastDay='';
  let dowMode = 'TOTAL';
  let top10Mode = 'MAIS';
  const ms = {
    unids: MultiSelect('ms-unids', 'Todas as Unidades'),
    cats:  MultiSelect('ms-cats', 'Todas as Categorias'),
    pratos: MultiSelect('ms-pratos', 'Todos os Pratos')
  };

  $('onlyPratos').addEventListener('change', fxDispatchApply);
  $('segDowMode').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    [...e.currentTarget.children].forEach(b=>b.classList.toggle('active', b===btn));
    dowMode = btn.dataset.mode;
    fxDispatchApply();
  });
  $('segTop10').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    [...e.currentTarget.children].forEach(b=>b.classList.toggle('active', b===btn));
    top10Mode = btn.dataset.mode;
    fxDispatchApply();
  });

  /* ===================== KPI & CHARTS ===================== */
  function upSVG(){return '<svg viewBox="0 0 20 20"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>';}
  function downSVG(){return '<svg viewBox="0 0 20 20"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>';}
  function deltaBadge(el,curr,prev){
    if(!isFinite(prev)||+prev===0){ el.textContent='—'; el.className='delta flat'; return; }
    const p=((curr-prev)/prev)*100;
    el.innerHTML=(p>=0? upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%';
    el.className='delta '+(p>=0?'up':'down');
  }

  function renderChart(canvasId, type, labels, datasets, options = {}) {
    const canvas = $(canvasId);
    if (!canvas) return;
    if (canvas.__chart) { try { canvas.__chart.destroy(); } catch(e){} }
    const ctx = canvas.getContext('2d');
    canvas.__chart = new Chart(ctx, {
      type,
      data: { labels, datasets },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        scales: type === 'bar' ? { y: { beginAtZero: true }, x: { grid: { display: false } } } : {},
        plugins: { legend: { display: datasets.length > 1 } },
        ...options
      }
    });
  }
  
  function updateKPIs(kpis, len) {
    const mediaDiaria = len > 0 ? Math.round(kpis.current_total / len) : 0;
    const prevMediaDiaria = len > 0 ? Math.round(kpis.prev_total / len) : 0;
    $('k_qtd').textContent = num(kpis.current_total);
    $('p_qtd').textContent = num(kpis.prev_total);
    deltaBadge($('d_qtd'), kpis.current_total, kpis.prev_total);
    $('k_pratos_unicos').textContent = num(kpis.current_unique);
    $('p_pratos_unicos').textContent = num(kpis.prev_unique);
    deltaBadge($('d_pratos_unicos'), kpis.current_unique, kpis.prev_unique);
    $('k_media_diaria').textContent = num(mediaDiaria);
    $('p_media_diaria').textContent = num(prevMediaDiaria);
    deltaBadge($('d_media_diaria'), mediaDiaria, prevMediaDiaria);
  }

  function updateTop10Chart(data) {
    const maisVendidos = data?.mais_vendidos || [];
    const menosVendidos = data?.menos_vendidos || [];
    if (top10Mode === 'MAIS') {
        renderChart('ch_top10', 'bar', maisVendidos.map(x => x.prato), [{ label: 'Qtd', data: maisVendidos.map(x => x.total), backgroundColor: '#7b1e3a' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
    } else { 
        renderChart('ch_top10', 'bar', menosVendidos.map(x => x.prato), [{ label: 'Qtd', data: menosVendidos.map(x => x.total), backgroundColor: '#9ca3af' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
    }
  }

  function updateDowChart(data, len) {
    const dowLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
    let nowData = Array(7).fill(0), prevData = Array(7).fill(0);
    for (let item of (data || [])) {
        nowData[item.dow] = item.current;
        prevData[item.dow] = item.previous;
    }

    if (dowMode === 'MEDIA') {
        const de = $('fxDuStart').value, ate = $('fxDuEnd').value;
        const occNow = Array(7).fill(0);
        let d = new Date(de+'T12:00:00Z'), end = new Date(ate+'T12:00:00Z');
        while (d <= end) { occNow[d.getUTCDay()]++; d.setUTCDate(d.getUTCDate()+1); }
        
        const occPrev = Array(7).fill(0);
        d = new Date(de+'T12:00:00Z');
        d.setUTCDate(d.getUTCDate() - len);
        const endPrev = new Date(d);
        endPrev.setUTCDate(d.getUTCDate() + len - 1);
        while (d <= endPrev) { occPrev[d.getUTCDay()]++; d.setUTCDate(d.getUTCDate()+1); }
        
        nowData = nowData.map((v,i)=> occNow[i] > 0 ? Math.round(v/occNow[i]) : 0);
        prevData = prevData.map((v,i)=> occPrev[i] > 0 ? Math.round(v/occPrev[i]) : 0);
    }
    renderChart('ch_dow', 'bar', dowLabels, [{ label: 'Atual', data: nowData, backgroundColor: '#7b1e3a' }, { label: 'Anterior', data: prevData, backgroundColor: '#9ca3af' }]);
  }

  async function updateMonthChart(endDate) {
      try {
        const params = {
            end_date_iso: endDate,
            unids_filter: ms.unids.get().length > 0 ? ms.unids.get() : null,
            cats_filter: ms.cats.get().length > 0 ? ms.cats.get() : null,
            pratos_filter: ms.pratos.get().length > 0 ? ms.pratos.get() : null,
            is_pratos_only: $('onlyPratos').checked
        };
        const { data, error } = await supa.rpc('get_monthly_sales_chart_data', params);
        if (error) throw error;

        const labels = (data || []).map(d => formatYM(d.period));
        const nowData = (data || []).map(d => d.current_total);
        const prevData = (data || []).map(d => d.prev_total);

        renderChart('ch_month', 'bar', labels, [
          { label: 'Últimos 12M', data: nowData, backgroundColor: '#7b1e3a' },
          { label: '12M Anteriores', data: prevData, backgroundColor: '#9ca3af' }
        ], { plugins: { legend: { display: false } } });
      } catch (e) { console.error("Erro ao carregar gráfico mensal:", e); }
  }

  /* ===================== LOOP PRINCIPAL ===================== */
  async function applyAll(details) {
    try {
      const de = details.start, ate = details.end;
      if (!de || !ate || new Date(de) > new Date(ate)) { return; }
      const len = daysLen(de, ate);
      
      const commonParams = {
          de_iso: de, ate_iso: ate,
          unids_filter: ms.unids.get().length > 0 ? ms.unids.get() : null,
          cats_filter: ms.cats.get().length > 0 ? ms.cats.get() : null,
          pratos_filter: ms.pratos.get().length > 0 ? ms.pratos.get() : null,
          is_pratos_only: $('onlyPratos').checked
      };

      const [kpisResult, dowResult, top10Result] = await Promise.allSettled([
          supa.rpc('get_pratos_kpis', commonParams).then(res => res.data[0]),
          supa.rpc('get_pratos_dow_chart', commonParams),
          supa.rpc('get_pratos_top10_chart', commonParams).then(res => res.data)
      ]);

      if (kpisResult.status === 'fulfilled' && kpisResult.value) {
        updateKPIs(kpisResult.value, len);
      }
      if (dowResult.status === 'fulfilled' && dowResult.value.data) {
        updateDowChart(dowResult.value.data, len);
      }
      if (top10Result.status === 'fulfilled' && top10Result.value) {
        updateTop10Chart(top10Result.value);
      }
      
      updateMonthChart(ate);

    } catch (e) { console.error("Erro no applyAll:", e); }
  }

  /* ===================== INICIALIZAÇÃO E CONTROLES DA UI ===================== */
  async function reloadFilterOptions() {
    const [unids, cats, pratos] = await Promise.all([
      supa.from('vendas_pratos_unidades').select('unidade'),
      supa.from('vendas_pratos_categorias').select('categoria'),
      supa.from('vendas_pratos_pratos').select('prato')
    ]);
    ms.unids.setOptions((unids.data?.map(r => r.unidade) || []).filter(Boolean));
    ms.cats.setOptions(cats.data?.map(r => r.categoria).filter(c => c !== null) || []);
    ms.pratos.setOptions(pratos.data?.map(r => r.prato).filter(p => p !== null) || []);
  }

  async function init() {
    try {
      console.info('[Status] [info]: Inicializando aplicação...');
      const { data, error } = await supa.from('vendas_pratos_daterange').select('max_data').limit(1);
      if (error) throw error;
      lastDay = (data?.length && data[0].max_data) ? data[0].max_data : getTodayISO();
      await reloadFilterOptions();
      
      document.dispatchEvent(new Event('filters:init'));
      console.info('[Status] [ok]: Dados atualizados.');

    } catch (e) { console.error(e); }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const fx = {
      $drop: $('fxDropup'), $btnMore: $('fxBtnMore'), $btnReset: $('fxBtnReset'),
      $start: $('fxDuStart'), $end: $('fxDuEnd'),
      $days: $('fxDuQuickDays'), $chips: $('fxQuickChips')
    };

    function fxFmt(date){ return date.toISOString().split('T')[0]; }
    function fxSetRange(start,end){ fx.$start.value = fxFmt(start); fx.$end.value = fxFmt(end); }
    
    function fxSetToLastMonthWithData(baseDateStr) {
        if (!baseDateStr || baseDateStr.startsWith('1970')) return fxLastNDays(30);
        const baseDate = new Date(baseDateStr + 'T12:00:00Z');
        const year = baseDate.getUTCFullYear();
        const month = baseDate.getUTCMonth();
        
        const start = new Date(Date.UTC(year, month, 1));
        const end = new Date(Date.UTC(year, month + 1, 0));
        
        fxSetRange(start, end);
        [...fx.$chips.children, ...fx.$days.children].forEach(b => b.classList.remove('active'));
    }

    function setNamedPeriod(win) {
        const baseDate = new Date(lastDay + 'T12:00:00Z');
        let start, end;
        if (win === 'today') { start = end = baseDate; } 
        else if (win === 'yesterday') {
            start = new Date(baseDate);
            start.setUTCDate(baseDate.getUTCDate() - 1);
            end = start;
        } else if (win === 'lastMonth') {
            start = new Date(Date.UTC(baseDate.getUTCFullYear(), baseDate.getUTCMonth() - 1, 1));
            end = new Date(Date.UTC(baseDate.getUTCFullYear(), baseDate.getUTCMonth(), 0));
        } else if (win === 'lastYear') {
            const y = baseDate.getUTCFullYear() - 1;
            start = new Date(Date.UTC(y, 0, 1));
            end = new Date(Date.UTC(y, 11, 31));
        }
        if (start && end) { fxSetRange(start, end); fxDispatchApply(); }
    }
    
    function fxLastNDays(n){
      const end = new Date(lastDay + 'T12:00:00Z');
      const start = new Date(end);
      start.setUTCDate(end.getUTCDate() - (n - 1));
      fxSetRange(start, end);
    }

    function fxShowDrop(show){
      fx.$drop.classList.toggle('fx-show', show);
      fx.$btnMore.setAttribute('aria-expanded', show?'true':'false');
      if(show) fx.$start?.focus();
    }
    
    fx.$btnMore.addEventListener('click', ()=> fxShowDrop(!fx.$drop.classList.contains('fx-show')));
    document.addEventListener('click', (e)=>{ if(!fx.$drop.classList.contains('fx-show')) return; if(!(fx.$drop.contains(e.target) || fx.$btnMore.contains(e.target))) fxShowDrop(false); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && fx.$drop.classList.contains('fx-show')) fxShowDrop(false) });
    
    const clearActiveChips = () => [...fx.$chips.children, ...fx.$days.children].forEach(b => b.classList.remove('active'));

    fx.$chips.addEventListener('click', e => {
        const btn = e.target.closest('button'); if (!btn) return;
        clearActiveChips();
        btn.classList.add('active');
        setNamedPeriod(btn.dataset.win);
    });
    fx.$start.addEventListener('change', () => { clearActiveChips(); fxDispatchApply(); });
    fx.$end.addEventListener('change', () => { clearActiveChips(); fxDispatchApply(); });
    fx.$days.addEventListener('click', (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      clearActiveChips();
      b.classList.add('active');
      const n=parseInt(b.dataset.win,10); 
      if(!isNaN(n)) { fxLastNDays(n); fxDispatchApply(); }
    });
    fx.$btnReset.addEventListener('click', ()=>{
      Object.values(ms).forEach(m => m.clear());
      $('onlyPratos').checked = false;
      fxSetToLastMonthWithData(lastDay);
      fxDispatchApply();
    });

    document.addEventListener('filters:apply', (e) => { if(e.detail) { applyAll(e.detail); } });
    
    document.addEventListener('filters:init', () => {
        fxSetToLastMonthWithData(lastDay);
        fxDispatchApply();
    });

    init();
  });
  
  // ===================== LÓGICA DE UPLOAD FINAL E CORRIGIDA PARA SEUS DADOS =====================
  $('btnUpload').addEventListener('click', () => $('fileExcel').click());
  $('fileExcel').addEventListener('change', async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    
    const btn = $('btnUpload');
    btn.textContent = 'Importando...';
    btn.disabled = true;

    try {
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      
      const json_data = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null, dateNF: 'dd/mm/yy' });

      if (json_data.length === 0) throw new Error("O arquivo está vazio ou em um formato inválido.");
      
      const headers = Object.keys(json_data[0]);
      const findHeader = (possibleNames) => {
          for (const name of possibleNames) {
              const found = headers.find(h => h.toLowerCase().trim() === name);
              if (found) return found;
          }
          return null;
      };

      const dateKey = findHeader(['data', 'data da venda']);
      const unitKey = findHeader(['unidade']);
      const dishKey = findHeader(['prato']);
      const categoryKey = findHeader(['categoria']);
      const quantityKey = findHeader(['quantidade_vendida', 'quantidade', 'qtd']);

      if (!dateKey) throw new Error(`Coluna de data não encontrada. Verifique se seu arquivo possui a coluna 'data' ou 'data da venda'.`);
      if (!quantityKey) throw new Error(`Coluna de quantidade não encontrada. Verifique se seu arquivo possui a coluna 'quantidade' ou 'quantidade_vendida'.`);
      
      // ===== NOVA FUNÇÃO DE DATA =====
      const parseDate = (dateValue) => {
        if (!dateValue) return null;
        let s = String(dateValue).trim();

        // Tenta extrair uma data como dd/mm/yy ou dd-mm-yy do final da string.
        // Isso remove textos como "quarta-feira, " do início.
        const match = s.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})$/);
        if (match) {
          s = match[0]; // Usa apenas a parte da data, ex: "01/01/25"
        }

        const parts = s.split(/[\/\-]/);
        if (parts.length === 3) {
            let [day, month, year] = parts;

            if (year.length === 2) {
              year = '20' + year; // Converte '25' para '2025'
            }
            
            const monthInt = parseInt(month, 10);
            const dayInt = parseInt(day, 10);
            const yearInt = parseInt(year, 10);

            if (monthInt >= 1 && monthInt <= 12 && dayInt >= 1 && dayInt <= 31 && yearInt > 1900) {
              // Formata para YYYY-MM-DD, que é o padrão do Supabase
              return `${year}-${String(monthInt).padStart(2, '0')}-${String(dayInt).padStart(2, '0')}`;
            }
        }
        
        console.warn('Formato de data inválido, não foi possível converter:', dateValue);
        return null;
      };

      const dadosFormatados = json_data.map(linha => {
        const dataValue = linha[dateKey];
        if (dataValue === null || typeof dataValue === 'undefined') return null;
        
        const parsedDate = parseDate(dataValue);
        if (!parsedDate) return null;

        return {
          data: parsedDate,
          unidade: unitKey ? linha[unitKey] : null,
          prato: dishKey ? linha[dishKey] : null,
          categoria: categoryKey ? linha[categoryKey] : null,
          quantidade: parseInt(linha[quantityKey], 10) || 0
        };
      }).filter(Boolean);

      if (dadosFormatados.length === 0) throw new Error("Nenhuma linha com dados de data válidos foi encontrada no arquivo.");

      const CHUNK_SIZE = 500;
      for (let i = 0; i < dadosFormatados.length; i += CHUNK_SIZE) {
          const chunk = dadosFormatados.slice(i, i + CHUNK_SIZE);
          const { error } = await supa.from('vendas_pratos').insert(chunk);
          if (error) throw new Error(`Erro ao importar lote para o banco: ${error.message}`);
      }

      alert(`Importação concluída! ${dadosFormatados.length} linhas inseridas.`);
      window.location.reload();

    } catch (e) {
      console.error(e);
      alert(`Falha na importação: ${e.message}`);
    } finally {
      btn.textContent = 'Importar';
      btn.disabled = false;
      ev.target.value = '';
    }
  });
  </script>
