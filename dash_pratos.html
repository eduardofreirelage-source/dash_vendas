<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dash Pratos</title>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#ef4444;
      --c-now:#7b1e3a; --c-prev:#9ca3af;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; height: 100%; overflow: hidden;}
    .wrap{display:flex;flex-direction:column;min-height:100vh; height: 100%; overflow: hidden;}
    .main{flex:1;min-width:0;display:flex;flex-direction:column; overflow-y: auto; padding-bottom: 60px;}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:16px;margin-bottom:8px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px; font-size:16px; font-weight: 700; color: var(--ink);}
    .section{order:2;padding:0 16px 12px 16px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;transition:.2s;position:relative}
    .kpi h4{margin:0 0 4px 0;color:var(--muted);font-size:11px;display:flex;align-items:center;gap:6px;}
    .kpi h4 .spacer { flex-grow: 1; }
    .kpi .val{font-size:22px;font-weight:500;letter-spacing:-.5px}
    .kpi .sub{font-size:10px;color:var(--muted);margin-top:4px}
    .delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:700;font-size:10px;margin-left:6px;background:rgba(148,163,184,.15);color:#6b7280}
    .delta svg{width:10px;height:10px;fill:currentColor}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .delta.down{background:rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.25); color: var(--down); }
    .charts-grid{display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px; flex: 1;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column; min-height: 200px; }
    .card .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .title{font-weight:700; color: var(--ink)}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:4px 8px;border:0;background:#fff;font-weight:700;color:#475569;cursor:pointer; font-size: 10px;}
    .seg button.active{background:var(--wine);color:#fff}
    .chart-box{position:relative;flex-grow:1;min-height:180px;}
    .chart-box canvas{display:block;width:100%;height:100%}
    .fx-filters-bar{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--line); padding:8px 14px; height:56px; display:flex; align-items:center; justify-content:space-between; }
    .fx-fb-left{display:flex; align-items:center; gap:10px; min-width:0; flex:1}
    .fx-fb-label{font-weight:700; color:var(--ink); font-size:12px; white-space:nowrap;}
    .fx-chips{display:flex; gap:8px; overflow:auto; scrollbar-width:none}
    .fx-chips::-webkit-scrollbar{display:none}
    .fx-chip{flex:0 0 auto; padding:6px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; color:#334155; font-weight:700; cursor:pointer; font-size:11px}
    .fx-chip.active{background:var(--wine); color:#fff; border-color:var(--wine)}
    .fx-fb-right{display:flex; align-items:center; gap:8px}
    .fx-iconbtn{display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer}
    .fx-textbtn{padding:8px 14px; border:1px solid var(--line); background:#fff; color:#334155; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px; display: inline-flex; align-items: center; gap: 6px;}
    .fx-dropup{ position:fixed; left:8px; right:8px; bottom:60px; z-index:40; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,.08); padding:0; display:none; }
    .fx-dropup.fx-show{display:block; animation:fx-pop .15s ease-out}
    @keyframes fx-pop{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    @media (max-width:1200px){ .kpis{grid-template-columns:repeat(2,1fr)} .charts-grid{grid-template-columns:1fr} }
    @media (max-width: 768px) { .kpis{ grid-template-columns: 1fr; } .top { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="main main-content">
      <div class="top">
        <div class="brand">Dashboard de Vendas</div>
        <div class="seg" id="segDowMode">
            <button data-mode="TOTAL" class="active">TOTAL</button>
            <button data-mode="MEDIA">MÉDIA</button>
        </div>
      </div>
      <section class="section">
        <div class="kpis">
          <div class="kpi"><h4><span>Itens Vendidos</span><span class="spacer"></span><span id="d_qtd" class="delta flat">—</span></h4><div class="val" id="k_qtd">—</div><div class="sub">Anterior: <span id="p_qtd">—</span></div></div>
          <div class="kpi"><h4><span>Pratos Únicos</span><span class="spacer"></span><span id="d_pratos_unicos" class="delta flat">—</span></h4><div class="val" id="k_pratos_unicos">—</div><div class="sub">Anterior: <span id="p_pratos_unicos">—</span></div></div>
          <div class="kpi"><h4><span>Média Diária</span><span class="spacer"></span><span id="d_media_diaria" class="delta flat">—</span></h4><div class="val" id="k_media_diaria">—</div><div class="sub">Anterior: <span id="p_media_diaria">—</span></div></div>
        </div>
        <div class="card" style="margin-bottom: 10px;">
            <div class="head"><div class="title">Vendas por Mês</div></div>
            <div class="chart-box" style="height: 184px; min-height: 184px;"><canvas id="ch_month"></canvas></div>
        </div>
        <div class="charts-grid">
            <div class="card">
              <div class="head"><div class="title">Vendas por Dia da Semana</div></div>
              <div class="chart-box"><canvas id="ch_dow"></canvas></div>
            </div>
            <div class="card">
                <div class="head">
                    <div class="title">Top 10 Pratos</div>
                    <div class="seg" id="segTop10">
                        <button data-mode="MAIS" class="active">Mais Vendidos</button>
                        <button data-mode="MENOS">Menos Vendidos</button>
                    </div>
                </div>
                <div class="chart-box"><canvas id="ch_top10"></canvas></div>
            </div>
        </div>
      </section>
    </main>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
  /* ===================== CONFIG ===================== */
  const SUPABASE_URL  = 'https://tykdmxaqvqwskpmdiekw.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5a2RteGFxdnF3c2twbWRpZWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyOTg2NDYsImV4cCI6MjA3Mjg3NDY0Nn0.XojR4nVx_Hr4FtZa1eYi3jKKSVVPokG23jrJtm8_3ps';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===================== CHART DEFAULTS ===================== */
  Chart.defaults.font.family = '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif';
  Chart.defaults.color = '#334155';
  Chart.defaults.plugins.legend.position = 'top';
  Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.95)';
  Chart.defaults.datasets.bar.borderRadius = 6;
  Chart.defaults.datasets.bar.borderSkipped = false;
  Chart.defaults.devicePixelRatio = Math.max(1, window.devicePixelRatio || 1);

  /* ===================== HELPERS ===================== */
  const $ = id => document.getElementById(id);
  const num = v => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');
  
  function getTodayISO() {
    const d = new Date();
    d.setHours(12, 0, 0, 0);
    return d.toISOString().split('T')[0];
  }

  function daysLen(de, ate) {
    if (!de || !ate) return 0;
    const d1 = new Date(de + 'T12:00:00Z');
    const d2 = new Date(ate + 'T12:00:00Z');
    return Math.round((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
  }
  
  function formatYM(isoStr){
    if (!isoStr) return '';
    const d = new Date(isoStr + '-01T12:00:00Z');
    const m = d.getMonth();
    const y = String(d.getFullYear()).slice(-2);
    const n = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    return `${n[m]}/${y}`;
  }

  /* ===================== ESTADO ===================== */
  let lastDay = getTodayISO();
  let dowMode = 'TOTAL';
  let top10Mode = 'MAIS';
  const filters = { start: '', end: '' }; // Filtros avançados podem ser adicionados aqui

  /* ===================== KPI & CHARTS ===================== */
  function upSVG(){return '<svg viewBox="0 0 20 20"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>';}
  function downSVG(){return '<svg viewBox="0 0 20 20"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>';}
  function deltaBadge(el,curr,prev){
    if(!isFinite(prev)||+prev===0 || !isFinite(curr)){ el.textContent='—'; el.className='delta flat'; return; }
    const p=((curr-prev)/Math.abs(prev))*100;
    el.innerHTML=(p>=0? upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%';
    el.className='delta '+(p>=0?'up':'down');
  }

  function renderChart(canvasId, type, labels, datasets, options = {}) {
    const canvas = $(canvasId);
    if (!canvas) return;
    if (canvas.__chart) { try { canvas.__chart.destroy(); } catch(e){} }
    const ctx = canvas.getContext('2d');
    canvas.__chart = new Chart(ctx, {
      type,
      data: { labels, datasets },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        scales: type === 'bar' ? { y: { beginAtZero: true }, x: { grid: { display: false } } } : {},
        plugins: { legend: { display: datasets.length > 1 } },
        ...options
      }
    });
  }
  
  function updateKPIs(kpis, len) {
    const mediaDiaria = len > 0 ? (kpis.current_total || 0) / len : 0;
    const prevMediaDiaria = len > 0 ? (kpis.prev_total || 0) / len : 0;
    $('k_qtd').textContent = num(kpis.current_total);
    $('p_qtd').textContent = num(kpis.prev_total);
    deltaBadge($('d_qtd'), kpis.current_total, kpis.prev_total);
    $('k_pratos_unicos').textContent = num(kpis.current_unique);
    $('p_pratos_unicos').textContent = num(kpis.prev_unique);
    deltaBadge($('d_pratos_unicos'), kpis.current_unique, kpis.prev_unique);
    $('k_media_diaria').textContent = num(mediaDiaria.toFixed(1));
    $('p_media_diaria').textContent = num(prevMediaDiaria.toFixed(1));
    deltaBadge($('d_media_diaria'), mediaDiaria, prevMediaDiaria);
  }

  function updateTop10Chart(data) {
    const maisVendidos = data?.mais_vendidos || [];
    const menosVendidos = data?.menos_vendidos || [];
    if (top10Mode === 'MAIS') {
        renderChart('ch_top10', 'bar', maisVendidos.map(x => x.prato), [{ label: 'Qtd', data: maisVendidos.map(x => x.total), backgroundColor: '#7b1e3a' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
    } else { 
        renderChart('ch_top10', 'bar', menosVendidos.map(x => x.prato), [{ label: 'Qtd', data: menosVendidos.map(x => x.total), backgroundColor: '#9ca3af' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
    }
  }

  function updateDowChart(data, len) {
    const dowLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
    let nowData = Array(7).fill(0), prevData = Array(7).fill(0);
    (data || []).forEach(d => {
        if (d.dia_semana >= 0 && d.dia_semana <= 6) {
            nowData[d.dia_semana] = d.current;
            prevData[d.dia_semana] = d.previous;
        }
    });
    // Lógica de Média pode ser adicionada aqui se necessário
    renderChart('ch_dow', 'bar', dowLabels, [{ label: 'Atual', data: nowData, backgroundColor: '#7b1e3a' }, { label: 'Anterior', data: prevData, backgroundColor: '#9ca3af' }]);
  }

  async function updateMonthChart(endDate) {
      try {
        const { data, error } = await supa.rpc('get_monthly_sales_chart_data', {end_date_iso: endDate});
        if (error) throw error;

        const labels = (data || []).map(d => formatYM(d.period));
        const nowData = (data || []).map(d => d.current_total);
        const prevData = (data || []).map(d => d.prev_total);

        renderChart('ch_month', 'bar', labels, [
          { label: 'Últimos 12M', data: nowData, backgroundColor: '#7b1e3a' },
          { label: '12M Anteriores', data: prevData, backgroundColor: '#9ca3af' }
        ], { plugins: { legend: { display: false } } });
      } catch (e) { console.error("Erro ao carregar gráfico mensal:", e); }
  }

  /* ===================== LOOP PRINCIPAL ===================== */
  async function applyAll(details) {
    try {
      const de = details.start, ate = details.end;
      if (!de || !ate || new Date(de) > new Date(ate)) { return; }
      const len = daysLen(de, ate);
      
      const params = { de_iso: de, ate_iso: ate };

      const [kpisResult, dowResult, top10Result] = await Promise.all([
          supa.rpc('get_pratos_kpis', params),
          supa.rpc('get_pratos_dow_chart', params),
          supa.rpc('get_pratos_top10_chart', params)
      ]);
      
      if (kpisResult.data) updateKPIs(kpisResult.data, len);
      if (dowResult.data) updateDowChart(dowResult.data, len);
      if (top10Result.data) updateTop10Chart(top10Result.data);
      
      updateMonthChart(ate);

    } catch (e) { console.error("Erro no applyAll:", e); }
  }

  /* ===================== INICIALIZAÇÃO E CONTROLES DA UI ===================== */
  async function init() {
    try {
      const { data, error } = await supa.from('vendas_pratos_raw').select('data').order('data', { ascending: false }).limit(1).single();
      if (error) throw error;
      lastDay = data ? data.data : getTodayISO();
      document.dispatchEvent(new Event('filters:init'));
    } catch (e) { 
        lastDay = getTodayISO();
        document.dispatchEvent(new Event('filters:init'));
        console.warn("Nenhum dado de venda encontrado, usando data de hoje. Adicione dados na tabela 'vendas_pratos_raw'.");
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Esconder barra de filtros inferior, já que não estamos usando os filtros avançados.
    const filterBar = document.querySelector('.fx-filters-bar');
    if (filterBar) filterBar.style.display = 'none';
    
    // Configurar período padrão para últimos 30 dias na inicialização
    document.addEventListener('filters:init', () => {
        const end = new Date(lastDay + 'T12:00:00Z');
        const start = new Date(end);
        start.setDate(end.getDate() - 29);
        filters.start = start.toISOString().split('T')[0];
        filters.end = end.toISOString().split('T')[0];
        applyAll(filters);
    });

    $('segDowMode').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      [...e.currentTarget.children].forEach(b=>b.classList.toggle('active', b===btn));
      dowMode = btn.dataset.mode;
      applyAll(filters);
    });

    $('segTop10').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      [...e.currentTarget.children].forEach(b=>b.classList.toggle('active', b===btn));
      top10Mode = btn.dataset.mode;
      applyAll(filters);
    });

    init();
  });
  </script>
</body>
</html>
