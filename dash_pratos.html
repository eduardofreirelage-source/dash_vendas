<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dash Pratos</title>
  <style>
    :root{--bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#ef4444; --c-now:#7b1e3a; --c-prev:#9ca3af;}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:11px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; height: 100%; overflow: hidden;}
    .wrap{display:flex;flex-direction:column;min-height:100vh; height: 100%; overflow: hidden;}
    .main{flex:1;min-width:0;display:flex;flex-direction:column; overflow-y: auto; padding-bottom: 60px;}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:16px;margin-bottom:8px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px; font-size:16px; font-weight: 700; color: var(--ink);}
    .status-bar { font-size: 13px; color: var(--muted); }
    .section{order:2;padding:0 16px 12px 16px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;transition:.2s;position:relative}
    .kpi h4{margin:0 0 4px 0;color:var(--muted);font-size:11px;display:flex;align-items:center;gap:6px;}
    .kpi h4 .spacer { flex-grow: 1; }
    .kpi .val{font-size:22px;font-weight:500;letter-spacing:-.5px}
    .kpi .sub{font-size:10px;color:var(--muted);margin-top:4px}
    .delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:700;font-size:10px;margin-left:6px;background:rgba(148,163,184,.15);color:#6b7280}
    .delta svg{width:10px;height:10px;fill:currentColor}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:var(--wine)}
    .delta.down{background:rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.25); color: var(--down); }
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column; min-height: 200px; }
    .card .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .title{font-weight:700; color: var(--ink)}
    .seg button{padding:4px 8px;border:0;background:#fff;font-weight:700;color:#475569;cursor:pointer; font-size: 10px;}
    .seg button.active{background:var(--wine);color:#fff}
    .chart-box{position:relative;flex-grow:1;min-height:180px;}
    .chart-box canvas{display:block;width:100%;height:100%}
    .fx-filters-bar{ position:sticky; bottom:0; z-index:30; background:#fff; border-top:1px solid var(--line); padding:8px 14px; height:56px; display:flex; align-items:center; justify-content:space-between; }
    .fx-textbtn{padding:8px 14px; border:1px solid var(--line); background:#fff; color:#334155; border-radius:8px; font-weight:700; cursor:pointer; font-size:11px; display: inline-flex; align-items: center; gap: 6px;}
    @media (max-width: 768px) { .kpis{ grid-template-columns: 1fr; } .top { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="main main-content">
      <div class="top">
        <div class="brand">Dashboard de Pratos</div>
        <div id="status-dash" class="status-bar">Carregando...</div>
      </div>
      <section class="section">
        <div class="kpis">
          <div class="kpi"><h4><span>Itens Vendidos</span></h4><div class="val" id="k_qtd">—</div></div>
          <div class="kpi"><h4><span>Pratos Únicos</span></h4><div class="val" id="k_pratos_unicos">—</div></div>
          <div class="kpi"><h4><span>Média Diária</span></h4><div class="val" id="k_media_diaria">—</div></div>
        </div>
        </section>
    </main>
  </div>
  
  <footer class="fx-filters-bar" aria-label="Barra de filtros">
      <button class="fx-textbtn" id="btnUpload">Importar Planilha</button>
      <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    /* ===================== CONFIGURAÇÃO DA API ===================== */
    // ATENÇÃO: SUBSTITUA ESTES VALORES PELOS SEUS DADOS REAIS DO PAINEL SUPABASE
    const SUPABASE_URL  = 'SUA_URL_COPIADA_AQUI';
    const SUPABASE_ANON = 'SUA_CHAVE_ANON_COPIADA_AQUI';
    // ===============================================================

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    const $ = id => document.getElementById(id);
    const setStatus=(msg,cls)=>{const el=$('status-dash'); if(!el) return; el.textContent=msg; el.style.color=(cls==='err'?'var(--down)':cls==='ok'?'var(--ok)':'var(--muted)');};
    const num = v => (v==null||!isFinite(+v)) ? '0' : (+v).toLocaleString('pt-BR');

    async function updateDashboard() {
        try {
            setStatus('Calculando KPIs...');
            const today = new Date().toISOString().split('T')[0];
            const { data, error } = await supa.rpc('get_pratos_kpis', { de_iso: '2000-01-01', ate_iso: today });
            if (error) throw error;

            const { data: countData, error: countError } = await supa.from('vendas_pratos').select('*', { count: 'exact', head: true });
            if (countError) throw countError;
            const totalDays = new Date(today) - new Date('2025-01-01');
            const days = Math.ceil(totalDays / (1000 * 60 * 60 * 24));
            
            $('k_qtd').textContent = num(data.current_total);
            $('k_pratos_unicos').textContent = num(data.current_unique);
            $('k_media_diaria').textContent = num(data.current_total / days);
            setStatus(`Analisando ${countData.count} registros.`, 'ok');
        } catch(e) {
            console.error("Erro ao atualizar dashboard:", e);
            setStatus(e.message, 'err');
        }
    }
  
    $('btnUpload').addEventListener('click', ()=> $('fileExcel').click());
    $('fileExcel').addEventListener('change', async (ev)=>{
      const file = ev.target.files[0];
      if (!file) return;

      const btn = $('btnUpload');
      const originalText = btn.textContent;
      btn.textContent = 'Enviando...';
      btn.disabled = true;
      setStatus('Lendo planilha...');

      try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(worksheet);
          
          if (json.length === 0) throw new Error("A planilha está vazia ou em formato inválido.");

          const columnMapping = {
              data_venda: ['Data', 'data'],
              prato: ['DESCRIÇÃO', 'Descricao', 'Descrição', 'Nome do Prato', 'Produto'],
              categoria: ['CATEGORIA', 'Categoria'],
              unidade: ['UNIDADE', 'Unidade', 'Loja'],
              quantidade: ['QUANT', 'Quantidade', 'Qtd', 'quant'],
              preco_total: ['VALOR', 'Valor', 'Preço Total', 'Total']
          };

          const getValue = (row, field) => {
              for (const alias of columnMapping[field]) {
                  if (row[alias] !== undefined) return row[alias];
              }
              return undefined;
          };
          
          const rowsToInsert = json.map(row => {
              const dateValue = getValue(row, 'data_venda');
              let date;
              if (typeof dateValue === 'number') { date = new Date(Math.round((dateValue - 25569) * 86400 * 1000)); } 
              else { date = new Date(dateValue); }
              if (isNaN(date.getTime())) return null;

              const quantityStr = String(getValue(row, 'quantidade') || '0').replace(',', '.');
              const priceStr = String(getValue(row, 'preco_total') || '0').replace(',', '.');

              return {
                  data_venda: date.toISOString().split('T')[0],
                  prato: getValue(row, 'prato'),
                  categoria: getValue(row, 'categoria'),
                  unidade: getValue(row, 'unidade'),
                  quantidade: parseFloat(quantityStr),
                  preco_total: parseFloat(priceStr)
              };
          }).filter(row => row && row.prato && !isNaN(row.quantidade) && !isNaN(row.preco_total));

          if (rowsToInsert.length === 0) {
              throw new Error("Nenhuma linha válida para importar foi encontrada. Verifique os nomes das colunas (Data, DESCRIÇÃO, etc).");
          }
          
          setStatus(`Enviando ${rowsToInsert.length} registros...`);
          const BATCH_SIZE = 500;
          for (let i = 0; i < rowsToInsert.length; i += BATCH_SIZE) {
              const batch = rowsToInsert.slice(i, i + BATCH_SIZE);
              const { error } = await supa.from('vendas_pratos').insert(batch);
              if (error) throw error;
          }
          
          setStatus(`${rowsToInsert.length} registros importados com sucesso!`, 'ok');
          await updateDashboard();

      } catch (e) {
          console.error("Erro no upload:", e);
          const errorMessage = e.code === 'PGRST205' ? `Erro de Banco de Dados: A tabela 'vendas_pratos' não foi encontrada.` : e.message;
          setStatus(`Erro ao importar: ${errorMessage}`, 'err');
      } finally {
          btn.textContent = originalText;
          btn.disabled = false;
          ev.target.value = '';
      }
    });

    async function init() {
        try {
            if (SUPABASE_URL === 'SUA_URL_COPIADA_AQUI' || SUPABASE_ANON === 'SUA_CHAVE_ANON_COPIADA_AQUI') {
                throw new Error("As credenciais do Supabase não foram configuradas.");
            }
            await updateDashboard();
        } catch(e) {
            setStatus(e.message, 'err');
        }
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
