<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Dash Pratos - MODO DIAGNÓSTICO</title>
  <style>:root{--bg:#f7f7fa;--card:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--wine:#7b1e3a;--down:#ef4444}*{box-sizing:border-box}html,body{margin:0;font:14px/1.5 sans-serif;background:var(--bg);color:var(--ink);display:flex;align-items:center;justify-content:center;height:100%} .diag-box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:24px;text-align:center;max-width:400px} h1{margin:0 0 8px 0;font-size:18px} p{margin:0 0 16px 0;color:var(--muted)} button{padding:10px 16px;border:0;background:var(--wine);color:#fff;font-weight:700;border-radius:8px;cursor:pointer}</style>
</head>
<body>
  <div class="diag-box">
    <h1>Modo de Diagnóstico de Arquivo</h1>
    <p>Esta página irá analisar seu arquivo CSV/Excel para encontrar a linha com a data mais recente, que está causando o problema. Nenhum dado será salvo no banco de dados.</p>
    <button id="btnAnalisar">Analisar Arquivo</button>
    <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    document.getElementById('btnAnalisar').addEventListener('click', () => document.getElementById('fileExcel').click());
    document.getElementById('fileExcel').addEventListener('change', async (ev) => {
      const file = ev.target.files[0];
      if (!file) return;

      const btn = document.getElementById('btnAnalisar');
      btn.textContent = 'Analisando...';
      btn.disabled = true;

      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const json_data = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });

        if (json_data.length === 0) throw new Error("O arquivo está vazio.");
        
        const headers = Object.keys(json_data[0]);
        const findHeader = (possibleNames) => {
          for (const name of possibleNames) {
            const found = headers.find(h => h.toLowerCase().trim() === name);
            if (found) return found;
          }
          return null;
        };

        const dateKey = findHeader(['data', 'data da venda']);
        if (!dateKey) throw new Error(`A coluna de data não foi encontrada no arquivo.`);

        const parseDate = (dateValue) => {
          const s = String(dateValue);
          const parts = s.split(/[\/\-\.]/);
          if (parts.length === 3) {
            let day = parts[0], month = parts[1], year = parts[2];
            if (year.length === 2) year = '20' + year;
            if (parseInt(month,10) > 0 && parseInt(month,10) <= 12 && parseInt(day,10) > 0 && parseInt(day,10) <= 31) {
              return `${year.padStart(4, '20')}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
          }
          return null;
        };

        let maxDate = new Date(0);
        let linhaProblematica = null;
        let indiceProblematica = -1;

        json_data.forEach((linha, index) => {
          const dataOriginal = linha[dateKey];
          if (dataOriginal) {
            const dataConvertidaStr = parseDate(dataOriginal);
            if (dataConvertidaStr) {
              const currentDate = new Date(dataConvertidaStr + 'T12:00:00Z');
              if (currentDate > maxDate) {
                maxDate = currentDate;
                linhaProblematica = linha;
                indiceProblematica = index;
              }
            }
          }
        });

        if (!linhaProblematica) throw new Error("Nenhuma data válida pôde ser lida do arquivo.");

        const dataOriginalProblemática = linhaProblematica[dateKey];
        const dataConvertidaProblemática = maxDate.toISOString().split('T')[0];

        alert(
          `--- ANÁLISE DO ARQUIVO CONCLUÍDA ---\n\n` +
          `A data mais recente encontrada foi: ${dataConvertidaProblemática}\n\n` +
          `Esta data foi gerada a partir da linha número ${indiceProblematica + 2} do seu arquivo, que contém o seguinte valor na coluna "${dateKey}":\n` +
          `--> "${dataOriginalProblemática}"\n\n` +
          `Conteúdo completo da linha problemática:\n` +
          `${JSON.stringify(linhaProblematica, null, 2)}`
        );

      } catch (e) {
        alert(`Erro na análise: ${e.message}`);
      } finally {
        btn.textContent = 'Analisar Arquivo';
        btn.disabled = false;
        ev.target.value = '';
      }
    });
  </script>
</body>
</html>
