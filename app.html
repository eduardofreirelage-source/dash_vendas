<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1" name="viewport"/>
    <title>Mapa de Produ√ß√£o</title>
    <link href='data:image/svg+xml,&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"&gt;&lt;rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/&gt;&lt;text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white"&gt;MP&lt;/text&gt;&lt;/svg&gt;' rel="icon"/>
    <link rel="stylesheet" href="estoque_styles.css?v=8.1">
</head>
<body>
<main class="main">
    <div class="top">
        <div class="brand">
            <div class="logo">MP</div>
            <div>
                <h1 style="font-size:18px; margin:0; line-height:1.2">Mapa de Produ√ß√£o</h1>
                <div class="hint" style="margin:0;">Ficha t√©cnica, previs√£o e compras</div>
            </div>
        </div>
        <nav class="tabs" id="main-tabs">
            <button class="active" data-tab="cadastros">Cadastros</button>
            <button data-tab="producao">Produ√ß√£o</button>
            <button data-tab="compras">Compras</button>
            <button data-tab="estoque">Estoque</button>
        </nav>
        <div class="status-bar">
            <div id="status">Carregando‚Ä¶</div>
        </div>
    </div>

    <div class="content-wrap">
    
    <section class="tab-content active" id="tab-cadastros">
        <div class="section" id="section-cadastros">
            <nav class="subtabs" id="cadastro-subtabs">
                <button class="active" data-subtab="pratos">Pratos</button>
                <button data-subtab="componentes">Componentes</button>
                <button data-subtab="receitas">Receitas</button>
                <button data-subtab="ingredientes">Ingredientes</button>
                <button class="chip" data-subtab="um">Unidades de Medida</button>
                <button class="chip" data-subtab="unidades">Locais/Unidades</button>
                <button class="chip" data-subtab="categorias">Categorias</button>
            </nav>

            <div class="subpage active" id="sub-pratos">
                <div class="actions-bar">
                    <h2>Pratos</h2>
                    <div class="right">
                        <button class="btn" id="btnImportarPratos">üì• Importar de Vendas</button>
                        <button class="btn pri" id="btnNovoPrato">‚ûï Novo Prato</button>
                    </div>
                </div>
                <div class="editor-container" id="prato-editor-container">
                    <h3 id="prato-form-title">Novo Prato</h3>
                    <form id="form-prato" class="form-grid">
                        <input type="hidden" name="id">
                        <div class="form-span-col-2">
                            <label for="prato-nome">Nome do Prato</label>
                            <input type="text" id="prato-nome" name="nome" required>
                        </div>
                        <div>
                            <label for="prato-cat">Categoria</label>
                            <select id="prato-cat" name="categoria_id"></select>
                        </div>
                        <div>
                            <label for="prato-preco">Pre√ßo de Venda</label>
                            <input type="number" id="prato-preco" name="preco_venda" step="0.01" min="0" data-type="number">
                        </div>
                        <div class="form-span-col-2">
                            <label><input type="checkbox" name="ativo" checked> Ativo</label>
                        </div>
                        <div class="right form-span-col-2">
                            <button type="button" class="btn" id="btnCancelarPrato">Cancelar</button>
                            <button type="submit" class="btn pri">Salvar Prato</button>
                        </div>
                    </form>
                </div>
                <div class="editor-container" id="prato-import-container">
                     <h3>Importar Pratos N√£o Cadastrados</h3>
                     <p class="hint">Busca na sua tabela de vendas por pratos que foram vendidos mas ainda n√£o existem no cadastro de pratos.</p>
                     <div class="import-error-box" id="import-error-detail" style="display: none;">
                        <strong>Erro ao buscar pratos:</strong>
                        <p id="import-error-message" style="margin: 8px 0;"></p>
                        <div id="import-sql-fix" style="display:none;">
                            <p><strong>Solu√ß√£o:</strong> Execute o seguinte c√≥digo SQL no Editor SQL do Supabase:</p>
                            <pre><code>CREATE OR REPLACE FUNCTION get_unregistered_dishes()...</code></pre>
                        </div>
                    </div>
                     <div id="import-loader" style="display: none; text-align: center; padding: 20px;">Carregando...</div>
                     <div class="table-container" style="max-height: 300px;">
                        <table id="tblImportPratos">
                            <thead><tr><th style="width: 50px;"><input type="checkbox" id="importCheckAll"></th><th>Nome do Prato Vendido</th><th>Categoria Sugerida</th></tr></thead>
                            <tbody></tbody>
                        </table>
                     </div>
                     <div class="right">
                        <button type="button" class="btn" id="btnCancelImport">Cancelar</button>
                        <button type="button" class="btn pri" id="btnConfirmImport" disabled>Importar Selecionados</button>
                     </div>
                </div>
                <div class="table-container">
                    <table id="tblPratos">
                        <thead><tr><th>Nome</th><th>Categoria</th><th>Pre√ßo Venda</th><th>N¬∫ Receitas</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="subpage" id="sub-componentes">
                 <div class="actions-bar"><h2>Componentes do Prato (Receitas)</h2></div>
                 <div class="form-grid" style="align-items: flex-end; margin-bottom: 16px;">
                    <div><label for="cp-prato">Selecione o Prato</label><select id="cp-prato"></select></div>
                    <div><label for="cp-receita">Adicionar Receita</label><select id="cp-receita"></select></div>
                    <div><label for="cp-qtd">Quantidade</label><input type="number" id="cp-qtd" value="1" step="0.001" min="0.001"></div>
                    <div><button class="btn pri" id="btnAddPrComp">Adicionar Componente</button></div>
                 </div>
                 <div class="table-container">
                    <table id="tblPrComp">
                        <thead><tr><th>Nome da Receita</th><th>Quantidade</th><th>A√ß√µes</th></tr></thead>
                        <tbody><tr><td colspan="3" style="text-align: center;">Selecione um prato para ver seus componentes.</td></tr></tbody>
                    </table>
                 </div>
            </div>

            <div class="subpage" id="sub-receitas">
                 <div class="actions-bar"><h2>Receitas (Ficha T√©cnica)</h2><div class="right"><button class="btn pri" id="btnShowNewRecipeForm">‚ûï Nova Receita</button></div></div>
                <div class="editor-container" id="recipe-editor-container">
                    <h3 id="recipe-form-title">Nova Receita</h3>
                    <form id="form-receita">
                        <input type="hidden" name="id">
                        <div class="form-grid">
                            <div class="form-span-col-2"><label for="rec-nome">Nome da Receita</label><input type="text" id="rec-nome" name="nome" required></div>
                            <div><label for="rec-rend">Rendimento</label><input type="number" name="rendimento" id="rec-rend" step="0.001" min="0" required></div>
                            <div><label for="rec-rend-und">Unidade de Rendimento</label><input type="text" name="unidade_rendimento" id="rec-rend-und" placeholder="ex: kg, L, un" required></div>
                            <div class="form-span-col-2"><label><input type="checkbox" name="ativo" checked> Ativo</label></div>
                        </div>
                    </form>
                    <div class="sep"></div>
                    <h4>Itens da Receita</h4>
                    <div class="form-grid" style="align-items: flex-end; margin-bottom: 16px;">
                        <div><label for="draft-tipo">Tipo</label><select id="draft-tipo"><option value="INGREDIENTE">Ingrediente</option><option value="RECEITA">Sub-receita</option></select></div>
                        <div><label for="draft-ref">Item</label><select id="draft-ref"></select></div>
                        <div><label for="draft-qtd">Quantidade</label><input type="number" id="draft-qtd" step="0.001" min="0"></div>
                        <div><label for="draft-und">Unidade</label><select id="draft-und"></select></div>
                        <div><button type="button" class="btn pri" id="btnDraftAdd">Adicionar Item</button></div>
                    </div>
                    <div class="table-container" style="max-height: 250px;">
                        <table id="tblDraft">
                            <thead><tr><th>Tipo</th><th>Nome</th><th>Qtd.</th><th>Un.</th><th>A√ß√µes</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="right">
                        <button type="button" class="btn" id="btnCancelRecEdit">Cancelar</button>
                        <button type="submit" form="form-receita" class="btn pri">Salvar Receita</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="tblRec">
                        <thead><tr><th>Nome</th><th>Rendimento</th><th>N¬∫ Itens</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="subpage" id="sub-ingredientes">
                 <div class="actions-bar"><h2>Ingredientes</h2><div class="right"><button class="btn pri" id="btnShowNewIngredienteForm">‚ûï Novo Ingrediente</button></div></div>
                <div class="editor-container" id="ingrediente-editor-container">
                    <h3 id="ingrediente-form-title">Novo Ingrediente</h3>
                    <form id="form-ingrediente" class="form-grid">
                        <input type="hidden" name="id">
                        <div class="form-span-col-2"><label for="ing-nome">Nome</label><input type="text" id="ing-nome" name="nome" required></div>
                        <div><label for="ing-categoria">Categoria</label><select id="ing-categoria" name="categoria_id"></select></div>
                        <div><label for="ing-unidade-medida">Unidade de Medida (Estoque)</label><select id="ing-unidade-medida" name="unidade_medida_id" required></select></div>
                        <div><label for="ing-custo">Custo Unit√°rio (R$)</label><input type="number" id="ing-custo" name="custo_unitario" step="0.001" min="0" data-type="number"></div>
                        <div><label for="ing-pedido">Ponto de Pedido (Estoque M√≠nimo)</label><input type="number" id="ing-pedido" name="ponto_pedido" step="0.001" min="0" data-type="number"></div>
                        <div class="form-span-col-2"><label><input type="checkbox" name="ativo" checked> Ativo</label></div>
                        <div class="right form-span-col-2">
                            <button type="button" class="btn" id="btnCancelIngEdit">Cancelar</button>
                            <button type="submit" class="btn pri">Salvar Ingrediente</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table id="tblIng">
                        <thead><tr><th>Nome</th><th>Categoria</th><th>Un. Medida</th><th>Custo Unit√°rio</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="subpage" id="sub-um">
                <div class="actions-bar"><h2>Unidades de Medida</h2><div class="right"><button class="btn pri" id="btnShowNewUmForm">‚ûï Nova Unidade</button></div></div>
                <div class="editor-container" id="um-editor-container">
                    <h3 id="um-form-title">Nova Unidade de Medida</h3>
                    <form id="form-um" class="form-grid">
                        <input type="hidden" name="id">
                        <div><label for="um-nome">Nome</label><input type="text" id="um-nome" name="nome" required></div>
                        <div><label for="um-sigla">Sigla</label><input type="text" id="um-sigla" name="sigla" required></div>
                        <div><label for="um-base">Unidade Base</label><input type="text" id="um-base" name="base" placeholder="Ex: g, ml, un"></div>
                        <div><label for="um-fator">Fator de Convers√£o para Base</label><input type="number" id="um-fator" name="fator" step="any" min="0" data-type="number"></div>
                        <div class="form-span-col-2"><label><input type="checkbox" name="ativo" checked> Ativo</label></div>
                        <div class="right form-span-col-2">
                            <button type="button" class="btn" id="btnCancelUmEdit">Cancelar</button>
                            <button type="submit" class="btn pri">Salvar Unidade</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table id="tbl-um">
                        <thead><tr><th>Sigla</th><th>Nome</th><th>Base</th><th>Fator</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="subpage" id="sub-unidades">
                 <div class="actions-bar"><h2>Locais/Unidades de Estoque</h2><div class="right"><button class="btn pri" id="btnShowNewUnidadesForm">‚ûï Novo Local</button></div></div>
                 <div class="editor-container" id="unidades-editor-container">
                    <h3 id="unidades-form-title">Novo Local</h3>
                    <form id="form-unidades" class="form-grid">
                        <input type="hidden" name="id">
                        <div class="form-span-col-2"><label for="un-nome">Nome do Local</label><input type="text" id="un-nome" name="nome" required></div>
                        <div class="form-span-col-2"><label><input type="checkbox" name="ativo" checked> Ativo</label></div>
                        <div class="right form-span-col-2">
                            <button type="button" class="btn" id="btnCancelUnidadesEdit">Cancelar</button>
                            <button type="submit" class="btn pri">Salvar Local</button>
                        </div>
                    </form>
                 </div>
                 <div class="table-container">
                    <table id="tbl-unidades">
                        <thead><tr><th>Nome</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                 </div>
            </div>

            <div class="subpage" id="sub-categorias">
                 <div class="actions-bar"><h2>Categorias</h2><div class="right"><button class="btn pri" id="btnShowNewCategoriasForm">‚ûï Nova Categoria</button></div></div>
                 <div class="editor-container" id="categorias-editor-container">
                    <h3 id="categorias-form-title">Nova Categoria</h3>
                    <form id="form-categorias" class="form-grid">
                        <input type="hidden" name="id">
                        <div><label for="cat-nome">Nome da Categoria</label><input type="text" id="cat-nome" name="nome" required></div>
                        <div><label for="cat-tipo">Tipo</label><select id="cat-tipo" name="tipo" required><option value="INGREDIENTE">Ingrediente</option><option value="PRATO">Prato</option></select></div>
                        <div class="form-span-col-2"><label><input type="checkbox" name="ativo" checked> Ativo</label></div>
                        <div class="right form-span-col-2">
                            <button type="button" class="btn" id="btnCancelCategoriasEdit">Cancelar</button>
                            <button type="submit" class="btn pri">Salvar Categoria</button>
                        </div>
                    </form>
                 </div>
                 <div class="table-container">
                    <table id="tbl-categorias">
                        <thead><tr><th>Nome</th><th>Tipo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                 </div>
            </div>
        </div>
    </section>

    <section class="tab-content" id="tab-producao">
        <div class="section">
            <div class="actions-bar"><h2>Previs√£o de Vendas</h2><div class="filters-container"><div><label for="prev-data-inicio">Data In√≠cio</label><input type="date" id="prev-data-inicio"></div><div><label for="prev-data-fim">Data Fim</label><input type="date" id="prev-data-fim"></div><div><label for="cat-filter">Categoria de Prato</label><select id="cat-filter"><option value="">Todas as Categorias</option></select></div></div><div class="right"><button class="btn pri" id="btnCalcularPrev">Calcular</button></div></div>
            <div class="table-container"><table id="tbl-previsao"><thead><tr><th>Nome do Prato</th><th>Total Vendido no Per√≠odo</th><th>Previs√£o Ajustada (Di√°ria)</th></tr></thead><tbody><tr><td colspan="3" style="text-align: center; padding: 20px;">Selecione o per√≠odo e clique em Calcular.</td></tr></tbody></table></div>
        </div>
    </section>

    <section class="tab-content" id="tab-compras">
        <div class="section">
             <div class="actions-bar"><h2>Sugest√µes de Compra</h2><div class="right"><button class="btn" id="btnRefreshSuggestions">üîÑ Atualizar</button></div></div>
            <p class="hint">Itens que est√£o abaixo do ponto de pedido (Estoque M√≠nimo) definido no cadastro de Ingredientes.</p>
            <div class="table-container"><table id="tbl-sugestoes"><thead><tr><th>Ingrediente</th><th>Estoque Atual</th><th>Ponto de Pedido</th><th>Sugest√£o de Compra</th><th>√öltimo Fornecedor</th></tr></thead><tbody></tbody></table></div>
        </div>
    </section>

    <section class="tab-content" id="tab-estoque">
        <div class="section">
            <nav class="subtabs" id="estoque-subtabs"><button class="active" data-subtab="movimentar">Movimentar</button><button data-subtab="geral">Saldo Geral</button><button data-subtab="lotes">Saldo por Lotes</button><button data-subtab="historico">Hist√≥rico</button></nav>
            <div class="subpage active" id="sub-movimentar">
                <div class="actions-bar"><h2>Movimenta√ß√£o de Estoque</h2></div>
                <div class="quick-actions-bar" id="quick-actions-bar">
                    <span class="quick-actions-label">A√ß√µes R√°pidas:</span>
                    <button class="btn quick-btn" data-quickmov="ENTRADA">‚ûï Entrada</button>
                    <button class="btn quick-btn" data-quickmov="SAIDA">‚ûñ Sa√≠da</button>
                    <button class="btn quick-btn" data-quickmov="AJUSTE">üîß Ajuste</button>
                    <button class="btn quick-btn" data-quickmov="TRANSFERENCIA">‚û°Ô∏è Transfer√™ncia</button>
                    <button class="btn quick-btn" data-quickmov="PRODUCAO">üç≥ Produ√ß√£o</button>
                </div>
                <form id="form-movimentacao"><div class="form-grid">
                    <div><label for="mov-tipo">Tipo de Movimenta√ß√£o</label><select id="mov-tipo" name="tipo" required><option value="">Selecione...</option><option value="ENTRADA">Entrada (Compra)</option><option value="SAIDA">Sa√≠da (Uso/Perda)</option><option value="AJUSTE">Ajuste de Invent√°rio</option><option value="TRANSFERENCIA">Transfer√™ncia entre Unidades</option><option value="PRODUCAO">Produ√ß√£o (Baixa de ingredientes)</option></select></div>
                    <div><label for="mov-item">Item (Ingrediente ou Receita)</label><select id="mov-item" name="item_id" required></select></div>
                    <div><label for="mov-qtd">Quantidade</label><input type="number" id="mov-qtd" name="quantidade" step="0.001" min="0.001" required></div>
                    <div id="field-custo" style="display: none;"><label for="mov-custo">Custo Unit√°rio (R$)</label><input type="number" id="mov-custo" name="custo_unitario" step="0.01" min="0" data-type="number"></div>
                    <div id="field-origem" style="display: none;"><label for="mov-unidade-origem">Unidade de Origem</label><select id="mov-unidade-origem" name="unidade_origem_id"></select></div>
                    <div id="field-destino" style="display: none;"><label for="mov-unidade-destino">Unidade de Destino</label><select id="mov-unidade-destino" name="unidade_destino_id"></select></div>
                    <div id="field-validade" style="display: none;"><label for="mov-validade">Data de Validade</label><input type="date" id="mov-validade" name="data_validade"></div>
                    <div class="form-span-col-2"><label for="mov-obs">Observa√ß√£o</label><input type="text" id="mov-obs" name="obs"></div>
                </div><div class="right"><button type="button" class="btn" id="btnMovCancel">Limpar</button><button type="submit" class="btn pri">Registrar Movimenta√ß√£o</button></div></form>
            </div>
            <div class="subpage" id="sub-geral"><div class="table-container"><table id="tblEstoqueGeral"><thead><tr><th>Item</th><th>Qtd. Total</th><th>Un. Medida</th><th>Custo M√©dio</th></tr></thead><tbody></tbody></table></div></div>
            <div class="subpage" id="sub-lotes"><div class="table-container"><table id="tblEstoqueLotes"><thead><tr><th>Item</th><th>Qtd.</th><th>Un. Medida</th><th>Custo Unit.</th><th>Validade</th><th>Local</th></tr></thead><tbody></tbody></table></div></div>
            <div class="subpage" id="sub-historico"><div class="table-container"><table id="tblHistorico"><thead><tr><th>Data/Hora</th><th>Tipo</th><th>Item</th><th>Quantidade</th><th>Origem/Destino</th><th>Usu√°rio</th><th>Obs.</th></tr></thead><tbody></tbody></table></div></div>
        </div>
    </section>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="app.js?v=9.0-final"></script>
</body>
</html>
