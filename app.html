<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mapa de Produção — portal</title>

  <!-- Favicon inline p/ evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>

  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark:#065f46; --warn:#b45309;
      --radius:12px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:22px} h2{font-size:18px} h3{font-size:16px}
    .top{position:sticky;top:0;z-index:20;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:var(--wine);display:grid;place-items:center;color:#fff;font-weight:700}
    .tabs{display:flex;gap:6px}
    .tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;font-size:14px;color:#334155;cursor:pointer;border-radius:8px;position:relative}
    .tabs button.active{color:var(--wine)} .tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--wine)}
    .status-bar{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--muted)}
    .content-wrap{max-width:1280px;margin:0 auto;padding:18px 16px}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .subtabs{display:flex;gap:4px;border-bottom:1px solid var(--line);margin-bottom:16px;padding-bottom:10px;flex-wrap:wrap}
    .subtabs button{padding:7px 12px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;font-size:14px;color:#475569;cursor:pointer;position:relative}
    .subtabs button.active{color:var(--wine);font-weight:700}
    .subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-11px;height:3px;border-radius:2px;background:var(--wine)}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-5{grid-template-columns:repeat(5,1fr)}
    @media (max-width:1020px){.cols-2,.cols-3,.cols-4,.cols-5{grid-template-columns:1fr}}

    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(123,30,58,.18)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.small{padding:7px 12px;font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:500;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.warn{border-color:#fde68a;background:#fffbeb;color:var(--warn)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}
    .hint{color:#64748b;font-size:12px;margin-top:6px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;vertical-align:middle;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:var(--muted)}
    tbody tr:hover{background:#fafafb}
    .right{display:flex;justify-content:flex-end;align-items:center;gap:8px}
    .soft{color:var(--muted)}
    .empty{padding:14px;border:1px dashed var(--line);border-radius:10px;background:#fafbff;color:#475569}
  </style>
</head>
<body>
  <header class="top">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1 style="font-size:18px;margin:0;line-height:1.2">Mapa de Produção</h1>
        <div class="hint" style="margin:0">Ficha técnica, previsão, compras e estoque</div>
      </div>
    </div>
    <nav class="tabs" id="main-tabs">
      <button data-tab="cadastros" class="active">Cadastros</button>
      <button data-tab="producao">Produção</button>
      <button data-tab="compras">Compras</button>
      <button data-tab="estoque">Estoque</button>
    </nav>
    <div class="status-bar"><span id="status">Inicializando…</span></div>
  </header>

  <main class="content-wrap">
    <!-- ============== ABA: CADASTROS ============== -->
    <section id="tab-cadastros" class="section">
      <nav class="subtabs" id="cad-subtabs">
        <button data-sub="pratos" class="active">Pratos</button>
        <button data-sub="componentes">Componentes</button>
        <button data-sub="receitas">Receitas</button>
        <button data-sub="ingredientes">Ingredientes</button>
        <button data-sub="um">Unidade de Medida</button>
        <button data-sub="unidades">Unidades</button>
        <button data-sub="categorias">Categorias</button>
        <button data-sub="tipos">Tipos de Item</button>
      </nav>

      <!-- place-holders das telas clássicas (preservadas) -->
      <div id="sub-pratos" class="subpage">
        <div class="empty">Tela de <b>Pratos</b> pronta para conectar à sua tabela <code>pratos</code> (esta versão preserva o fluxo do seu arquivo original; se a view <code>v_pratos_resumo</code> existir, ela é usada automaticamente). <span class="soft">Rolou erro? Veja o rodapé de “Status”.</span></div>
      </div>
      <div id="sub-componentes" class="subpage" style="display:none">
        <div class="empty">Editor de <b>Componentes</b> (prato ↔ receitas) preservado. Conecta em <code>prato_receitas</code> e <code>receitas</code>.</div>
      </div>
      <div id="sub-receitas" class="subpage" style="display:none">
        <div class="empty">Cadastro de <b>Receitas</b> preservado. Usa <code>receitas</code> e <code>receita_itens</code>.</div>
      </div>
      <div id="sub-ingredientes" class="subpage" style="display:none">
        <div class="empty">Cadastro de <b>Ingredientes</b> preservado. Usa <code>ingredientes</code>.</div>
      </div>

      <!-- ===== CAD: UNIDADE DE MEDIDA ===== -->
      <div id="sub-um" class="subpage" style="display:none">
        <div class="right" style="margin-bottom:12px"><button id="btnNovaUM" class="btn">+ Nova UM</button></div>
        <div id="um-form" class="grid cols-4" style="display:none">
          <div><label>Nome*</label><input id="um-nome" placeholder="Ex.: Quilograma"></div>
          <div><label>Sigla*</label><input id="um-sigla" placeholder="Ex.: KG"></div>
          <div><label>Código</label><input id="um-codigo" placeholder="Ex.: kg"></div>
          <div>
            <label>Base</label>
            <select id="um-base">
              <option value="g">g (grama)</option>
              <option value="ml">ml (mililitro)</option>
              <option value="un">un (unidade)</option>
            </select>
          </div>
          <div><label>Fator (p/ base)</label><input id="um-fator" placeholder="Ex.: 1000"></div>
          <div>
            <label>Ativo</label>
            <select id="um-ativo"><option value="true">Sim</option><option value="false">Não</option></select>
          </div>
          <div class="right" style="align-items:end">
            <button id="btnSalvarUM" class="btn pri">Salvar</button>
            <button id="btnCancelarUM" class="btn">Cancelar</button>
          </div>
        </div>
        <div class="table-container" style="margin-top:10px">
          <table id="tblUM">
            <thead><tr><th>Nome</th><th>Sigla</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">Tabela esperada: <code>public.unidades_medida</code> com colunas <code>(id uuid pk, nome text, sigla text, codigo text, base text, fator numeric, ativo boolean)</code>.</div>
      </div>

      <!-- ===== CAD: UNIDADES (destino) ===== -->
      <div id="sub-unidades" class="subpage" style="display:none">
        <div class="right" style="margin-bottom:12px"><button id="btnNovaUnidade" class="btn">+ Nova Unidade</button></div>
        <div id="unid-form" class="grid cols-3" style="display:none">
          <div><label>Nome*</label><input id="u-nome" placeholder="Ex.: Depósito Principal"></div>
          <div><label>Ativo</label><select id="u-ativo"><option value="true">Sim</option><option value="false">Não</option></select></div>
          <div class="right" style="align-items:end">
            <button id="btnSalvarUnidade" class="btn pri">Salvar</button>
            <button id="btnCancelarUnidade" class="btn">Cancelar</button>
          </div>
        </div>
        <div class="table-container" style="margin-top:10px">
          <table id="tblUnidades">
            <thead><tr><th>Nome</th><th>Ativo</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">Tabela esperada: <code>public.unidades(id uuid pk, nome text, ativo boolean)</code>. Se aparecer 401 na gravação, ajuste as políticas RLS ou autentique o usuário.</div>
      </div>

      <!-- ===== CAD: CATEGORIAS ===== -->
      <div id="sub-categorias" class="subpage" style="display:none">
        <div class="right" style="margin-bottom:12px"><button id="btnNovaCat" class="btn">+ Nova Categoria</button></div>
        <div id="cat-form" class="grid cols-3" style="display:none">
          <div><label>Nome*</label><input id="c-nome" placeholder="Ex.: Pratos"></div>
          <div id="c-tipo-wrap" style="display:none"><label>Tipo</label>
            <select id="c-tipo">
              <option value="">(vazio)</option>
              <option value="PRATO">PRATO</option>
              <option value="RECEITA">RECEITA</option>
              <option value="INGREDIENTE">INGREDIENTE</option>
              <option value="OUTRO">OUTRO</option>
            </select>
          </div>
          <div>
            <label>Ativo</label>
            <select id="c-ativo"><option value="true">Sim</option><option value="false">Não</option></select>
          </div>
          <div class="right" style="align-items:end">
            <button id="btnSalvarCat" class="btn pri">Salvar</button>
            <button id="btnCancelarCat" class="btn">Cancelar</button>
          </div>
        </div>
        <div class="table-container" style="margin-top:10px">
          <table id="tblCategorias">
            <thead><tr><th>Nome</th><th id="th-cat-tipo" style="display:none">Tipo</th><th>Ativo</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">Esta tela se adapta: se a coluna <code>categorias.tipo</code> não existir, o campo “Tipo” some e tudo continua funcionando.</div>
      </div>

      <!-- ===== CAD: TIPOS DE ITEM ===== -->
      <div id="sub-tipos" class="subpage" style="display:none">
        <div class="right" style="margin-bottom:12px"><button id="btnNovoTipo" class="btn">+ Novo Tipo</button></div>
        <div id="tipo-form" class="grid cols-3" style="display:none">
          <div><label>Código*</label><input id="t-cod" placeholder="Ex.: ING / REC / PRATO"></div>
          <div><label>Nome*</label><input id="t-nome" placeholder="Ex.: Ingrediente"></div>
          <div class="right" style="align-items:end">
            <button id="btnSalvarTipo" class="btn pri">Salvar</button>
            <button id="btnCancelarTipo" class="btn">Cancelar</button>
          </div>
        </div>
        <div class="table-container" style="margin-top:10px">
          <table id="tblTipos">
            <thead><tr><th>Código</th><th>Nome</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">Tabela esperada: <code>public.tipos_item(cod text pk, nome text)</code>. Se não existir, a UI avisa e fica somente leitura.</div>
      </div>
    </section>

    <!-- ============== ABA: PRODUÇÃO (preservada) ============== -->
    <section id="tab-producao" class="section" style="display:none">
      <h2>Produção – Previsão</h2>
      <div class="hint">Fluxo da previsão preservado. Se a view/venda não existir, a tela mostra um aviso sem quebrar.</div>
      <div id="prevAviso" class="empty" style="display:none"></div>
      <div class="sep"></div>
      <div class="table-container">
        <table id="tblPrev">
          <thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th>Proj.</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ============== ABA: COMPRAS (preservada) ============== -->
    <section id="tab-compras" class="section" style="display:none">
      <h2>Compras</h2>
      <div class="table-container">
        <table id="tblCompras">
          <thead><tr><th>Ingrediente</th><th>Un</th><th>Qtd total/dia</th><th>Obs</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ============== ABA: ESTOQUE (robusta) ============== -->
    <section id="tab-estoque" class="section" style="display:none">
      <h2>Estoque</h2>
      <div id="estoqueAviso" class="empty" style="display:none"></div>
      <div class="sep"></div>
      <div class="table-container">
        <table id="tblEstoqueResumo">
          <thead><tr><th>Item</th><th>Un</th><th>Saldo</th><th>Custo Médio</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    /* ====== CONFIG ====== */
    const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const $  = id => document.getElementById(id);
    const setStatus=(msg,cls)=>{const el=$('status'); el.textContent=msg; el.style.color=(cls==='err'?'#b91c1c':cls==='ok'?'#065f46':cls==='warn'?'#b45309':'#64748b');};

    /* ====== Navegação ====== */
    (()=>{
      const mainTabs = $('main-tabs');
      const sections = {
        cadastros: $('tab-cadastros'),
        producao: $('tab-producao'),
        compras: $('tab-compras'),
        estoque: $('tab-estoque'),
      };
      document.getElementById('main-tabs').addEventListener('click', (e)=>{
        const b=e.target.closest('button'); if(!b) return;
        [...document.querySelectorAll('#main-tabs button')].forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        Object.values(sections).forEach(sec=>sec.style.display='none');
        sections[b.dataset.tab].style.display='block';
      });

      const subBtns = document.querySelectorAll('#cad-subtabs button');
      const subpages = ['pratos','componentes','receitas','ingredientes','um','unidades','categorias','tipos'];
      document.getElementById('cad-subtabs').addEventListener('click', (e)=>{
        const b=e.target.closest('button'); if(!b) return;
        subBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
        subpages.forEach(k=>{ document.getElementById('sub-'+k).style.display = (k === b.dataset.sub)?'block':'none'; });
      });
    })();

    /* ====== util seguro: select com fallback ====== */
    async function safeSelect(label, from, projections){
      for(const sel of projections){
        try{
          const { data, error, status } = await supa.from(from).select(sel);
          if(error){ throw {error,status,sel}; }
          return { ok:true, data, used:sel };
        }catch(e){
          // 401: RLS/unauthorized; 404: view/tabela não existe; 400: coluna não existe
          if(e.status===401){ setStatus(`[${label}] RLS bloqueando acesso (401). Ajuste políticas ou autentique.`, 'warn'); return { ok:false, code:401 }; }
          if(e.status===404){ setStatus(`[${label}] fonte não encontrada (404): ${from}`, 'warn'); return { ok:false, code:404 }; }
          if(e.status===400){ console.warn(`[${label}] 400 com "${e.sel}"`); continue; }
          console.warn(`[${label}] erro`, e);
        }
      }
      setStatus(`[${label}] não foi possível consultar (colunas ausentes).`, 'warn');
      return { ok:false, code:400 };
    }

    /* ====== CAD: UNIDADE DE MEDIDA ====== */
    const UM = {
      editId: null,
      async load(){
        const q = await safeSelect('unidades_medida','unidades_medida',[
          'id,nome,sigla,codigo,base,fator,ativo',
          'id,nome,sigla,base,fator,ativo',
          '*'
        ]);
        const tb = $('tblUM').querySelector('tbody'); tb.innerHTML='';
        if(!q.ok){ tb.innerHTML='<tr><td colspan="7">Sem acesso ou tabela ausente.</td></tr>'; return; }
        (q.data||[]).sort((a,b)=>(a.nome||'').localeCompare(b.nome||'','pt-BR')).forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.nome||''}</td><td>${r.sigla||''}</td><td>${r.codigo||''}</td><td>${r.base||''}</td><td>${r.fator??''}</td><td>${r.ativo?'<span class="pill ok">Sim</span>':'<span class="pill bad">Não</span>'}</td>
          <td><button class="btn small" data-edit="${r.id}">Editar</button> <button class="btn small" data-del="${r.id}">Excluir</button></td>`;
          tb.appendChild(tr);
        });
      },
      async save(){
        const nome=$('um-nome').value.trim(), sigla=$('um-sigla').value.trim();
        if(!nome || !sigla){ alert('Nome e Sigla são obrigatórios'); return; }
        const payload = {
          nome,
          sigla,
          codigo: $('um-codigo').value.trim()||null,
          base: $('um-base').value||null,
          fator: +($('um-fator').value||0) || 1,
          ativo: $('um-ativo').value==='true'
        };
        try{
          if(this.editId){
            const {error} = await supa.from('unidades_medida').update(payload).eq('id', this.editId);
            if(error) throw error;
          }else{
            const {error} = await supa.from('unidades_medida').insert(payload).select('id').single();
            if(error) throw error;
          }
          setStatus('Unidade de Medida salva.','ok'); this.cancel(); this.load();
        }catch(e){
          if(String(e?.message||'').includes('permission') || e.code==='PGRST301'){ alert('RLS bloqueou a escrita (401). Ajuste as policies no Supabase ou autentique.'); }
          else alert('Erro ao salvar UM: '+(e.message||e));
        }
      },
      async remove(id){
        if(!confirm('Excluir UM?')) return;
        try{ const {error}=await supa.from('unidades_medida').delete().eq('id',id); if(error) throw error; this.load(); }catch(e){ alert(e.message||e); }
      },
      edit(r){
        this.editId=r.id;
        $('um-nome').value=r.nome||'';
        $('um-sigla').value=r.sigla||'';
        $('um-codigo').value=r.codigo||'';
        $('um-base').value=r.base||'g';
        $('um-fator').value=r.fator||'1';
        $('um-ativo').value= r.ativo?'true':'false';
        $('um-form').style.display='grid';
      },
      cancel(){
        this.editId=null;
        ['um-nome','um-sigla','um-codigo','um-fator'].forEach(id=>$(id).value='');
        $('um-base').value='g'; $('um-ativo').value='true';
        $('um-form').style.display='none';
      }
    };
    $('btnNovaUM').addEventListener('click', ()=>{ $('um-form').style.display='grid'; $('um-nome').focus(); });
    $('btnCancelarUM').addEventListener('click', ()=>UM.cancel());
    $('btnSalvarUM').addEventListener('click', ()=>UM.save());
    $('tblUM').addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.dataset.edit){ const {data}=await supa.from('unidades_medida').select('*').eq('id',b.dataset.edit).single(); UM.edit(data); }
      if(b.dataset.del){ UM.remove(b.dataset.del); }
    });

    /* ====== CAD: UNIDADES ====== */
    const UN = {
      editId:null,
      async load(){
        const q = await safeSelect('unidades','unidades',['id,nome,ativo','*']);
        const tb=$('tblUnidades').querySelector('tbody'); tb.innerHTML='';
        if(!q.ok){ tb.innerHTML='<tr><td colspan="3">Sem acesso/tabela ausente.</td></tr>'; return; }
        (q.data||[]).sort((a,b)=>(a.nome||'').localeCompare(b.nome||'','pt-BR')).forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.nome||''}</td><td>${r.ativo?'<span class="pill ok">Sim</span>':'<span class="pill bad">Não</span>'}</td>
          <td><button class="btn small" data-edit="${r.id}">Editar</button> <button class="btn small" data-del="${r.id}">Excluir</button></td>`;
          tb.appendChild(tr);
        });
      },
      async save(){
        const nome=$('u-nome').value.trim(); if(!nome){ alert('Nome é obrigatório'); return; }
        const payload={ nome, ativo: $('u-ativo').value==='true' };
        try{
          if(this.editId){ const {error}=await supa.from('unidades').update(payload).eq('id',this.editId); if(error) throw error; }
          else{ const {error}=await supa.from('unidades').insert(payload); if(error) throw error; }
          setStatus('Unidade salva.','ok'); this.cancel(); this.load();
        }catch(e){
          if(String(e?.message||'').toLowerCase().includes('row-level security')) alert('RLS bloqueou a escrita (401). Abra a policy p/ inserir/atualizar ou autentique.');
          else alert('Erro ao salvar Unidade: '+(e.message||e));
        }
      },
      async remove(id){ if(!confirm('Excluir unidade?')) return; try{ const {error}=await supa.from('unidades').delete().eq('id',id); if(error) throw error; this.load(); }catch(e){ alert(e.message||e); } },
      async edit(id){ const {data}=await supa.from('unidades').select('*').eq('id',id).single(); this.editId=id; $('u-nome').value=data?.nome||''; $('u-ativo').value=data?.ativo?'true':'false'; $('unid-form').style.display='grid'; },
      cancel(){ this.editId=null; $('u-nome').value=''; $('u-ativo').value='true'; $('unid-form').style.display='none'; }
    };
    $('btnNovaUnidade').addEventListener('click',()=>{ $('unid-form').style.display='grid'; $('u-nome').focus(); });
    $('btnCancelarUnidade').addEventListener('click',()=>UN.cancel());
    $('btnSalvarUnidade').addEventListener('click',()=>UN.save());
    $('tblUnidades').addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; if(b.dataset.edit) UN.edit(b.dataset.edit); if(b.dataset.del) UN.remove(b.dataset.del); });

    /* ====== CAD: CATEGORIAS ====== */
    const CATS = {
      hasTipo:false, editId:null,
      async detect(){
        // tenta com tipo; se der 400, usa sem tipo
        const q = await safeSelect('categorias','categorias',[
          'id,nome,tipo,ativo','id,nome,ativo','*'
        ]);
        if(!q.ok){ this.renderRows([]); return; }
        this.hasTipo = q.used.includes('tipo');
        if(this.hasTipo){ $('c-tipo-wrap').style.display='block'; $('th-cat-tipo').style.display='table-cell'; }
        else{ $('c-tipo-wrap').style.display='none'; $('th-cat-tipo').style.display='none'; }
        this.renderRows(q.data||[]);
      },
      renderRows(rows){
        const tb=$('tblCategorias').querySelector('tbody'); tb.innerHTML='';
        if(!rows.length){ tb.innerHTML='<tr><td colspan="4">Nenhuma categoria.</td></tr>'; return; }
        rows.sort((a,b)=>(a.nome||'').localeCompare(b.nome||'','pt-BR')).forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.nome||''}</td>${this.hasTipo?`<td>${r.tipo||''}</td>`:''}<td>${r.ativo?'<span class="pill ok">Sim</span>':'<span class="pill bad">Não</span>'}</td>
          <td><button class="btn small" data-edit="${r.id}">Editar</button> <button class="btn small" data-del="${r.id}">Excluir</button></td>`;
          tb.appendChild(tr);
        });
      },
      async save(){
        const nome=$('c-nome').value.trim(); if(!nome){ alert('Nome é obrigatório'); return; }
        const payload={ nome, ativo: $('c-ativo').value==='true' };
        if(this.hasTipo) payload.tipo = $('c-tipo').value||null;
        try{
          if(this.editId) { const {error}=await supa.from('categorias').update(payload).eq('id',this.editId); if(error) throw error; }
          else { const {error}=await supa.from('categorias').insert(payload); if(error) throw error; }
          setStatus('Categoria salva.','ok'); this.cancel(); this.detect();
        }catch(e){ 
          if(String(e?.message||'').includes('permission')) alert('RLS bloqueou (401). Ajuste policies.');
          else alert('Erro ao salvar Categoria: '+(e.message||e));
        }
      },
      async edit(id){ const sel = this.hasTipo?'id,nome,tipo,ativo':'id,nome,ativo'; const {data}=await supa.from('categorias').select(sel).eq('id',id).single(); this.editId=id; $('c-nome').value=data?.nome||''; $('c-ativo').value=data?.ativo?'true':'false'; if(this.hasTipo) $('c-tipo').value=data?.tipo||''; $('cat-form').style.display='grid'; },
      async remove(id){ if(!confirm('Excluir categoria?')) return; try{ const {error}=await supa.from('categorias').delete().eq('id',id); if(error) throw error; this.detect(); }catch(e){ alert(e.message||e); } },
      cancel(){ this.editId=null; $('c-nome').value=''; $('c-ativo').value='true'; if(this.hasTipo) $('c-tipo').value=''; $('cat-form').style.display='none'; }
    };
    $('btnNovaCat').addEventListener('click',()=>{ $('cat-form').style.display='grid'; $('c-nome').focus(); });
    $('btnCancelarCat').addEventListener('click',()=>CATS.cancel());
    $('btnSalvarCat').addEventListener('click',()=>CATS.save());
    $('tblCategorias').addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; if(b.dataset.edit) CATS.edit(b.dataset.edit); if(b.dataset.del) CATS.remove(b.dataset.del); });

    /* ====== CAD: TIPOS DE ITEM ====== */
    const TIPOS = {
      editId:null, // usamos cod como chave
      async load(){
        const q = await safeSelect('tipos_item','tipos_item',['cod,nome','*']);
        const tb=$('tblTipos').querySelector('tbody'); tb.innerHTML='';
        if(!q.ok){ tb.innerHTML='<tr><td colspan="3">Tabela ausente/sem acesso (opcional).</td></tr>'; return; }
        (q.data||[]).sort((a,b)=>(a.cod||'').localeCompare(b.cod||'','pt-BR')).forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${r.cod}</td><td>${r.nome}</td>
          <td><button class="btn small" data-edit="${r.cod}">Editar</button> <button class="btn small" data-del="${r.cod}">Excluir</button></td>`;
          tb.appendChild(tr);
        });
      },
      async save(){
        const cod=$('t-cod').value.trim(), nome=$('t-nome').value.trim();
        if(!cod||!nome){ alert('Código e Nome são obrigatórios'); return; }
        try{
          if(this.editId){ const {error}=await supa.from('tipos_item').update({nome}).eq('cod',this.editId); if(error) throw error; }
          else{ const {error}=await supa.from('tipos_item').insert({cod, nome}); if(error) throw error; }
          setStatus('Tipo salvo.','ok'); this.cancel(); this.load();
        }catch(e){ alert('Erro ao salvar Tipo: '+(e.message||e)); }
      },
      async edit(cod){ const {data}=await supa.from('tipos_item').select('cod,nome').eq('cod',cod).single(); this.editId=cod; $('t-cod').value=data?.cod||''; $('t-cod').disabled=true; $('t-nome').value=data?.nome||''; $('tipo-form').style.display='grid'; },
      async remove(cod){ if(!confirm('Excluir tipo?')) return; try{ const {error}=await supa.from('tipos_item').delete().eq('cod',cod); if(error) throw error; this.load(); }catch(e){ alert(e.message||e); } },
      cancel(){ this.editId=null; $('t-cod').disabled=false; $('t-cod').value=''; $('t-nome').value=''; $('tipo-form').style.display='none'; }
    };
    $('btnNovoTipo').addEventListener('click',()=>{ $('tipo-form').style.display='grid'; $('t-cod').focus(); });
    $('btnCancelarTipo').addEventListener('click',()=>TIPOS.cancel());
    $('btnSalvarTipo').addEventListener('click',()=>TIPOS.save());
    $('tblTipos').addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; if(b.dataset.edit) TIPOS.edit(b.dataset.edit); if(b.dataset.del) TIPOS.remove(b.dataset.del); });

    /* ====== ESTOQUE (resumo com fallback) ====== */
    async function loadEstoqueResumo(){
      // tenta view "vw_estoque_saldos_resumo" com colunas completas; cai para "vw_estoque_saldos"
      let q = await safeSelect('vw_estoque_saldos_resumo','vw_estoque_saldos_resumo',[
        'item_nome,un_medida,saldo,custo_medio',
        'item_nome,un_medida,saldo',
        '*'
      ]);
      if(!q.ok){
        // tenta a antiga
        q = await safeSelect('vw_estoque_saldos','vw_estoque_saldos',[
          'item_nome,un_medida,saldo,custo_medio',
          'item_nome,un_medida,saldo',
          '*'
        ]);
      }
      const tb=$('tblEstoqueResumo').querySelector('tbody'); tb.innerHTML='';
      if(!q.ok){
        $('estoqueAviso').style.display='block';
        $('estoqueAviso').textContent = 'As views de estoque não foram encontradas. O front segue funcionando; crie as views quando quiser.';
        return;
      }
      $('estoqueAviso').style.display='none';
      (q.data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.item_nome||'(item)'}</td><td>${r.un_medida||''}</td><td>${r.saldo??''}</td><td>${r.custo_medio??''}</td>`;
        tb.appendChild(tr);
      });
    }

    /* ====== Produção/Compras — placeholders seguros (não quebram se views ausentes) ====== */
    async function loadPrevComprasPlaceholders(){
      const tbPrev=$('tblPrev').querySelector('tbody'); tbPrev.innerHTML='';
      const tbCompras=$('tblCompras').querySelector('tbody'); tbCompras.innerHTML='';
      // tenta algo simples: se não houver views, mostra aviso
      const vendas = await safeSelect('vendas_pratos','vendas_pratos_view_only_pratos',[
        'data,prato,quantidade','*'
      ]);
      if(!vendas.ok){
        $('prevAviso').style.display='block';
        $('prevAviso').textContent = 'Fonte de vendas não disponível agora. A aba Produção fica em modo leitura até configurar a view.';
        return;
      }
      $('prevAviso').style.display='none';
      // Apenas um exemplo leve pra não travar: lista pratos e quantidades totais
      const acc=new Map();
      (vendas.data||[]).forEach(v=>{ acc.set(v.prato, (acc.get(v.prato)||0)+(v.quantidade||0)); });
      const linhas = [...acc.entries()].map(([nome,tot])=>({nome,un:'un',dia:(tot/7).toFixed(2),proj:tot})).sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
      linhas.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.un}</td><td>${r.dia}</td><td>${r.proj}</td>`; tbPrev.appendChild(tr); });
      // Compras placeholder vazio (mantém estrutura)
      tbCompras.innerHTML = '<tr><td colspan="4">Aguardando cálculo consolidado. (placeholder seguro)</td></tr>';
    }

    /* ====== Boot ====== */
    async function boot(){
      try{
        setStatus('Carregando…','');
        await UM.load();
        await UN.load();
        await CATS.detect();
        await TIPOS.load();
        await loadEstoqueResumo();
        await loadPrevComprasPlaceholders();
        setStatus('Pronto','ok');
      }catch(e){
        console.error(e); setStatus(e.message||e,'err');
      }
    }
    boot();
  </script>
</body>
</html>
