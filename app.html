<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mapa de Produ√ß√£o ‚Äî Restaurado</title>
  <!-- Favicon embutido (evita 404) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark:#065f46; --wine-dark:#881337;
      --radius:12px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:20px} h2{font-size:18px} h3{font-size:16px}
    html, body { height: 100vh; overflow: hidden; }
    body { display:flex; flex-direction:column; }
    .main{ display:flex; flex-direction:column; height:100%; flex:1; min-height:0; }
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:var(--wine);display:grid;place-items:center;color:#fff;font-weight:700}
    .tabs{display:flex;gap:6px;border:0;background:transparent;flex-wrap:wrap}
    .tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;font-size:14px;color:#334155;cursor:pointer;border-radius:8px;position:relative}
    .tabs button.active{color:var(--wine)}
    .tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--wine)}
    .status-bar{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted)}
    .content-wrap{max-width:1280px;margin:0 auto;padding:18px 16px;flex:1;min-height:0;width:100%;}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);width:100%;height:100%;overflow:auto}
    .tab-content{display:none;height:100%}
    .tab-content.active{display:block}
    .subtabs{display:flex;gap:6px;border-bottom:1px solid var(--line);margin-bottom:14px;padding-bottom:8px;flex-wrap:wrap}
    .subtabs button{padding:6px 10px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;font-size:14px;color:#475569;cursor:pointer;position:relative}
    .subtabs button.active{color:var(--wine);font-weight:700}
    .subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-9px;height:3px;border-radius:2px;background:var(--wine)}
    .subpage{display:none}
    .subpage.active{display:block;animation:fadeIn .2s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(123,30,58,.18)}
    select[multiple]{height:120px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.small{padding:6px 10px;font-size:12px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:1020px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:500;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:var(--down)}
    .pill.warn{border-color:#fde68a;background:#fefce8;color:#a16207}
    .hint{color:#64748b;font-size:12px;margin-top:4px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:middle;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:#475569}
    tbody tr:hover{background:#fafafb}
    tbody tr:last-child td{border-bottom:0}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .nowrap{white-space:nowrap}
    .filters-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;padding:12px;background:var(--bg);border-radius:var(--radius);margin-bottom:16px}
    /* Cards KPI Vis√£o Estoque */
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:8px}
    .kpi .pill{justify-content:center}
  </style>
</head>
<body>
<main class="main">
  <div class="top">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1 style="margin:0;line-height:1.1">Mapa de Produ√ß√£o</h1>
        <div class="hint" style="margin:0">Ficha t√©cnica, previs√£o, compras e estoque</div>
      </div>
    </div>
    <nav class="tabs" id="main-tabs">
      <button data-tab="cadastros" class="active">Cadastros</button>
      <button data-tab="producao">Produ√ß√£o</button>
      <button data-tab="compras">Compras</button>
      <button data-tab="estoque">Estoque</button>
    </nav>
    <div class="status-bar">
      <span id="status">Pronto</span>
    </div>
  </div>

  <div class="content-wrap">
    <!-- ===== ABA CADASTROS ===== -->
    <section id="tab-cadastros" class="tab-content active">
      <div class="section">
        <nav class="subtabs" id="cadastro-subtabs">
          <button data-subtab="pratos" class="active">Pratos</button>
          <button data-subtab="componentes">Componentes</button>
          <button data-subtab="receitas">Receitas</button>
          <button data-subtab="ingredientes">Ingredientes</button>
          <!-- NOVOS cadastros -->
          <button data-subtab="um">Unidade de Medida</button>
          <button data-subtab="unidades">Unidades</button>
          <button data-subtab="categorias">Categorias</button>
          <button data-subtab="tipos-item">Tipos de Item</button>
        </nav>

        <!-- PRATOS -->
        <div id="sub-pratos" class="subpage active">
          <div class="grid cols-2">
            <div><input id="pratos-search" placeholder="Buscar prato..."></div>
            <div class="right"><button id="btnNovoPrato" class="btn pri">+ Novo prato</button></div>
          </div>
          <div class="sep"></div>
          <div class="grid cols-2" style="align-items:end">
            <div>
              <label>Filtrar categoria</label>
              <select id="pratos-cat-filter"><option value="">Todas</option></select>
            </div>
            <div class="right">
              <span class="pill" id="pratos-page-info">P√°gina 1/1</span>
              <div class="row-actions"><button class="btn small" id="pratos-prev">‚óÄ</button><button class="btn small" id="pratos-next">‚ñ∂</button></div>
            </div>
          </div>
          <div class="table-container" style="max-height:280px;">
            <table id="tblPratos"><thead><tr><th>Nome</th><th>Categoria</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>

          <div class="sep"></div>
          <h3 id="prato-form-title">Editar prato</h3>
          <div class="grid cols-4">
            <div><label>Nome</label><input id="prato-nome"></div>
            <div><label>Categoria</label><select id="prato-cat"></select></div>
            <div><label>Peso un.</label><select id="prato-peso-un"><option>g</option><option>ml</option></select></div>
            <div><label>Qtd</label><input id="prato-peso" placeholder="500"></div>
          </div>
          <div class="grid cols-4" style="margin-top:8px;align-items:end">
            <div><label>Pre√ßo venda</label><input id="prato-preco" placeholder="34,90 ou 3,2(fator)"></div>
            <div><label>Custo (calc.)</label><input id="prato-custo" disabled placeholder="R$ 0,00"></div>
            <div><label>√öltima altera√ß√£o</label><input id="prato-ultima" disabled placeholder="‚Äî"></div>
            <div class="right">
              <button id="btnSalvarPrato" class="btn pri">Salvar</button>
              <button id="btnCancelarPrato" class="btn">Cancelar</button>
            </div>
          </div>
        </div>

        <!-- COMPONENTES DO PRATO -->
        <div id="sub-componentes" class="subpage">
          <h2>Componentes do Prato</h2>
          <div class="grid cols-2">
            <div><label>Prato</label><select id="cp-prato"><option value="">Selecione...</option></select></div>
            <div class="right" style="align-self:end"><span class="pill" id="cp-info">‚Äî</span></div>
          </div>
          <div id="componentes-editor" style="display:none">
            <div class="sep"></div>
            <div class="grid cols-4">
              <div><label>Receita</label><select id="cp-receita"></select></div>
              <div><label>Qtd por prato</label><input id="cp-qtd" placeholder="220"></div>
              <div><label>Un</label><select id="cp-und"><option>g</option><option>ml</option><option>porcao</option></select></div>
              <div class="right" style="align-self:end"><button id="btnAddPrComp" class="btn pri">Adicionar</button></div>
            </div>
            <div class="table-container" style="margin-top:10px;max-height:260px">
              <table id="tblPrComp"><thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>

        <!-- RECEITAS -->
        <div id="sub-receitas" class="subpage">
          <div class="right" style="margin-bottom:10px"><button id="btnShowNewRecipeForm" class="btn pri">+ Nova Receita</button></div>
          <div id="recipe-editor-container" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:12px">
            <h3 id="recipe-form-title">Nova Receita</h3>
            <div class="grid cols-3">
              <div><label>Nome</label><input id="rec-nome"></div>
              <div><label>Rendimento (qtd)</label><input id="rec-rend-qtd"></div>
              <div><label>Unidade</label><select id="rec-rend-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
            </div>
            <div class="grid cols-3" style="margin-top:8px">
              <div><label>Perda global (%)</label><input id="rec-perda" value="0"></div>
              <div><label>Obs</label><input id="rec-obs"></div>
              <div></div>
            </div>
            <div class="sep"></div>
            <h4>Itens</h4>
            <div class="grid cols-4">
              <div><label>Tipo</label><select id="draft-tipo"><option>INGREDIENTE</option><option>RECEITA</option></select></div>
              <div><label>Refer√™ncia</label><select id="draft-ref"></select></div>
              <div><label>Qtd</label><input id="draft-qtd"></div>
              <div><label>Un</label><select id="draft-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px;align-items:end">
              <div><label>Perda linha (%)</label><input id="draft-perda" value="0"></div>
              <div class="right">
                <button id="btnDraftAdd" class="btn">Adicionar Item</button>
                <button id="btnDraftClear" class="btn">Limpar Itens</button>
              </div>
            </div>
            <div class="table-container" style="margin-top:8px;max-height:180px">
              <table id="tblDraft"><thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="right" style="margin-top:10px">
              <button id="btnSaveRec" class="btn pri">Salvar</button>
              <button id="btnUpdateRec" class="btn pri" style="display:none">Atualizar</button>
              <button id="btnCancelRecEdit" class="btn">Cancelar</button>
            </div>
          </div>
          <div class="table-container">
            <table id="tblRec"><thead><tr><th>Nome</th><th>Rendimento</th><th>Itens</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- INGREDIENTES -->
        <div id="sub-ingredientes" class="subpage">
          <div class="right" style="margin-bottom:10px"><button id="btnShowNewIngredienteForm" class="btn pri">+ Novo Ingrediente</button></div>
          <div id="ingrediente-editor-container" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:12px">
            <h3 id="ingrediente-form-title">Novo Ingrediente</h3>
            <div class="grid cols-4">
              <div><label>Nome</label><input id="ing-nome"></div>
              <div><label>Categoria</label><select id="ing-categoria"></select></div>
              <div><label>Unidade</label><select id="ing-und"><option>g</option><option selected>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
              <div><label>Custo unit√°rio</label><input id="ing-custo" placeholder="0,0123"></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px;align-items:end">
              <div><label>Obs</label><input id="ing-obs"></div>
              <div class="right">
                <button id="btnSaveIng" class="btn pri">Salvar</button>
                <button id="btnCancelIngEdit" class="btn">Cancelar</button>
              </div>
            </div>
          </div>
          <div class="grid cols-2" style="align-items:end"><div class="pill">Ingredientes cadastrados</div><div class="right"><input id="ing-search" placeholder="Buscar..."></div></div>
          <div class="table-container" style="margin-top:8px"><table id="tblIng"><thead><tr><th>Nome</th><th>Categoria</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- NOVO: UNIDADES DE MEDIDA -->
        <div id="sub-um" class="subpage">
          <div class="right" style="margin-bottom:10px"><button id="btnShowUMForm" class="btn pri">+ Nova UM</button></div>
          <div id="um-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:12px">
            <h3 id="um-form-title">Nova Unidade de Medida</h3>
            <div class="grid cols-4">
              <div><label>Nome</label><input id="um-nome" placeholder="Quilograma"></div>
              <div><label>Sigla</label><input id="um-sigla" placeholder="KG"></div>
              <div><label>C√≥digo</label><input id="um-codigo" placeholder="kg"></div>
              <div><label>Base</label><select id="um-base"><option value="">‚Äî</option><option value="g">g</option><option value="ml">ml</option><option value="un">un</option></select></div>
            </div>
            <div class="grid cols-3" style="margin-top:8px;align-items:end">
              <div><label>Fator (p/ base)</label><input id="um-fator" placeholder="1000"></div>
              <div></div>
              <div class="right">
                <button id="btnSaveUM" class="btn pri">Salvar</button>
                <button id="btnCancelUM" class="btn">Cancelar</button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblUM"><thead><tr><th>Nome</th><th>Sigla</th><th>C√≥digo</th><th>Base</th><th>Fator</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- NOVO: UNIDADES (destino) -->
        <div id="sub-unidades" class="subpage">
          <div class="right" style="margin-bottom:10px"><button id="btnShowUnForm" class="btn pri">+ Nova Unidade</button></div>
          <div id="un-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:12px">
            <h3 id="un-form-title">Nova Unidade</h3>
            <div class="grid cols-3">
              <div><label>Nome</label><input id="un-nome" placeholder="Dep√≥sito Principal"></div>
              <div><label>Ativo</label><select id="un-ativo"><option value="true">Sim</option><option value="false">N√£o</option></select></div>
              <div class="right" style="align-self:end">
                <button id="btnSaveUn" class="btn pri">Salvar</button>
                <button id="btnCancelUn" class="btn">Cancelar</button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblUnidades"><thead><tr><th>Nome</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- NOVO: CATEGORIAS -->
        <div id="sub-categorias" class="subpage">
          <div class="right" style="margin-bottom:10px"><button id="btnShowCatForm" class="btn pri">+ Nova Categoria</button></div>
          <div id="cat-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:12px">
            <h3 id="cat-form-title">Nova Categoria</h3>
            <div class="grid cols-4">
              <div><label>Nome</label><input id="cat-nome"></div>
              <div><label>Tipo</label><select id="cat-tipo"><option value="PRATO">PRATO</option><option value="INGREDIENTE">INGREDIENTE</option><option value="OUTRO">OUTRO</option></select></div>
              <div><label>Ativo</label><select id="cat-ativo"><option value="true">Sim</option><option value="false">N√£o</option></select></div>
              <div class="right" style="align-self:end">
                <button id="btnSaveCat" class="btn pri">Salvar</button>
                <button id="btnCancelCat" class="btn">Cancelar</button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblCategorias"><thead><tr><th>Nome</th><th>Tipo</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- NOVO: TIPOS DE ITEM -->
        <div id="sub-tipos-item" class="subpage">
          <div class="right" style="margin-bottom:10px"><button id="btnShowTipoForm" class="btn pri">+ Novo Tipo</button></div>
          <div id="tipo-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:12px">
            <h3 id="tipo-form-title">Novo Tipo de Item</h3>
            <div class="grid cols-4">
              <div><label>C√≥digo</label><input id="tipo-codigo" placeholder="ING / REC / PRD"></div>
              <div><label>Nome</label><input id="tipo-nome" placeholder="Ingrediente"></div>
              <div><label>Ativo</label><select id="tipo-ativo"><option value="true">Sim</option><option value="false">N√£o</option></select></div>
              <div class="right" style="align-self:end">
                <button id="btnSaveTipo" class="btn pri">Salvar</button>
                <button id="btnCancelTipo" class="btn">Cancelar</button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblTipos"><thead><tr><th>C√≥digo</th><th>Nome</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== ABA PRODU√á√ÉO ===== -->
    <section id="tab-producao" class="tab-content">
      <div class="section">
        <h2>Previs√£o de Produ√ß√£o</h2>
        <div class="grid cols-4" style="align-items:end">
          <div><label>M√©dia √∫ltimos (dias)</label><input id="win-dias" type="number" value="7" min="1"></div>
          <div><label>Projetar (dias)</label><input id="proj-dias" type="number" value="7" min="1"></div>
          <div><label>Categorias</label><select id="cat-filter" multiple></select></div>
          <div class="right"><button id="btnCalcularPrev" class="btn pri">Calcular</button></div>
        </div>
        <div class="hint" id="prev-hint-top"></div>
        <div class="sep"></div>
        <h3>M√©dia de Vendas por Prato</h3>
        <div class="table-container" style="max-height:240px">
          <table id="tblResumoPratos"><thead><tr><th>Prato</th><th>Categoria</th><th>M√©dia/Dia</th><th id="th-proj-prato">Proje√ß√£o</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="sep"></div>
        <h3>Produ√ß√£o por Receita</h3>
        <div class="table-container" style="max-height:280px">
          <table id="tblPrev"><thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th id="th-proj">Qtd/Proje√ß√£o</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="hint" id="prev-hint"></div>
      </div>
    </section>

    <!-- ===== ABA COMPRAS ===== -->
    <section id="tab-compras" class="tab-content">
      <div class="section">
        <h3>Sugest√µes de Compra</h3>
        <div class="hint">Calculado com base no saldo, ponto de pedido, consumo e lead time.</div>
        <div class="right" style="margin:10px 0">
          <button id="btnRefreshSuggestions" class="btn">Atualizar</button>
          <button id="btnExportSuggestions" class="btn">Exportar CSV</button>
        </div>
        <div class="table-container">
          <table id="tblSugestoes"><thead><tr><th>Item</th><th>Status</th><th>Saldo</th><th>Ponto Pedido</th><th>Consumo/Dia</th><th>Sugest√£o</th><th>M√∫ltiplo</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- ===== ABA ESTOQUE ===== -->
    <section id="tab-estoque" class="tab-content">
      <div class="section">
        <nav class="subtabs" id="estoque-subtabs">
          <button data-subtab="visao" class="active">Vis√£o Geral</button>
          <button data-subtab="mov">Movimentar</button>
          <button data-subtab="benef">Beneficiar</button>
          <button data-subtab="inv">Invent√°rio</button>
          <button data-subtab="param">Par√¢metros</button>
          <button data-subtab="anom">Anomalias (IA)</button>
        </nav>

        <!-- Vis√£o Geral (layout melhorado) -->
        <div id="sub-visao" class="subpage active">
          <div class="kpi">
            <div class="pill bad">Cr√≠ticos: <b id="estoq-kpi-criticos">0</b></div>
            <div class="pill warn">Abaixo Min: <b id="estoq-kpi-min">0</b></div>
            <div class="pill">Acima M√°x: <b id="estoq-kpi-max">0</b></div>
            <div class="pill warn">Venc.&lt;7d: <b id="estoq-kpi-venc7">0</b></div>
            <div class="pill">Ajustes(30d): <b id="estoq-kpi-ajustes">R$ 0,00</b></div>
          </div>
          <div class="filters-bar">
            <div><label>Unidade</label><select id="filtro-unidade-estoque"></select></div>
            <div><label>Categoria</label><select id="filtro-categoria-estoque"></select></div>
            <div><label>Status</label><select id="filtro-status-estoque"><option value="">Todos</option><option>CR√çTICO</option><option>ABAIXO DO M√çNIMO</option><option>OK</option></select></div>
          </div>
          <h4>Saldo Atual</h4>
          <div class="table-container" style="max-height:220px">
            <table id="tblSaldo"><thead><tr><th>Item</th><th>Tipo</th><th>Unidade</th><th>Saldo</th><th>Custo M√©dio</th><th>Valor</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="sep"></div>
          <h4>Saldo por Lote</h4>
          <div class="table-container" style="max-height:220px">
            <table id="tblSaldoLotes"><thead><tr><th>Item</th><th>Lote</th><th>Validade</th><th>Saldo</th><th>UM</th><th>Custo Unit.</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Movimentar -->
        <div id="sub-mov" class="subpage">
          <h3>Opera√ß√µes</h3>
          <div class="grid cols-4">
            <button class="btn" data-mov-type="ENTRADA">üì• Entrada</button>
            <button class="btn" data-mov-type="SAIDA">üì§ Sa√≠da</button>
            <button class="btn" data-mov-type="TRANSFERENCIA">üîÑ Transfer√™ncia</button>
            <button class="btn" data-mov-type="AJUSTE">‚úçÔ∏è Ajuste</button>
          </div>
          <div id="mov-form-container" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-top:12px">
            <h3 id="mov-form-title"></h3>
            <form id="frmMov">
              <div class="grid cols-2">
                <div id="mov-unidade-origem-group"><label>Unidade Origem</label><select id="mov-unidade-origem"></select></div>
                <div id="mov-unidade-destino-group"><label>Unidade Destino</label><select id="mov-unidade-destino"></select></div>
              </div>
              <div class="grid cols-2" style="margin-top:8px">
                <div><label>Tipo Item</label><select id="mov-item-tipo"><option value="ING">Ingrediente</option><option value="REC">Receita</option></select></div>
                <div><label>Item</label><select id="mov-item"></select></div>
              </div>
              <div class="grid cols-3" style="margin-top:8px">
                <div><label>Quantidade</label><input id="mov-qtd" type="number" step="0.01" min="0"></div>
                <div><label>Un. Medida</label><input id="mov-un" placeholder="kg, g, L, ml, un"></div>
                <div id="mov-ajuste-sinal-group"><label>Tipo Ajuste</label><select id="mov-ajuste-sinal"><option value="+">Positivo (+)</option><option value="-">Negativo (-)</option></select></div>
              </div>
              <div class="grid cols-2" style="margin-top:8px">
                <div><label>Lote</label><input id="mov-lote"></div>
                <div><label>Validade</label><input id="mov-validade" type="date"></div>
              </div>
              <div class="grid cols-2" style="margin-top:8px">
                <div><label>Custo Unit√°rio</label><input id="mov-custo" type="number" step="0.0001"></div>
                <div><label>Documento/Obs</label><input id="mov-doc" placeholder="NF, motivo..."></div>
              </div>
              <div class="right" style="margin-top:10px">
                <button id="btnMovSubmit" type="submit" class="btn pri">Registrar</button>
                <button id="btnMovCancel" type="button" class="btn">Cancelar</button>
              </div>
            </form>
          </div>

          <div class="sep"></div>
          <h4>√öltimas 20 Movimenta√ß√µes</h4>
          <div class="table-container" style="max-height:240px">
            <table id="tblMovRecentes"><thead><tr><th>TS</th><th>Tipo</th><th>Item</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Demais subp√°ginas (placeholders preservados) -->
        <div id="sub-benef" class="subpage"><p>Beneficiamento (em breve)</p></div>
        <div id="sub-inv" class="subpage"><p>Invent√°rio (em breve)</p></div>
        <div id="sub-param" class="subpage"><p>Par√¢metros (em breve)</p></div>
        <div id="sub-anom" class="subpage"><p>Anomalias com IA (em breve)</p></div>
      </div>
    </section>
  </div>
</main>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ========= Config Supabase (mesmo projeto do seu arquivo) ========= */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ========= Helpers ========= */
const $  = (id)=> document.getElementById(id);
const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
const setStatus=(msg,cls)=>{ const el=$('status'); if(!el) return; el.textContent=msg; el.style.color=(cls==='err'?'var(--down)':cls==='ok'?'var(--ok)':'var(--muted)'); };
const fmt=(n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
const ptToNumber=(v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };

/* ========= Navega√ß√£o (abas e sub-abas) ========= */
function setupRouting() {
  const mainTabsContainer = $('main-tabs');
  const mainContents = $$('.tab-content');
  mainTabsContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('button'); if(!btn) return;
    const tabId = btn.dataset.tab;
    mainTabsContainer.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    mainContents.forEach(c=> c.classList.toggle('active', c.id === 'tab-' + tabId));
  });
  const setupSubTabs = (containerId, selectorPrefix) => {
    const container = $(containerId);
    container?.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      container.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = 'sub-' + btn.dataset.subtab;
      $$(selectorPrefix + ' .subpage').forEach(p=> p.classList.toggle('active', p.id === target));
    });
  };
  setupSubTabs('cadastro-subtabs', '#tab-cadastros');
  setupSubTabs('estoque-subtabs',  '#tab-estoque');
}
document.addEventListener('DOMContentLoaded', setupRouting);

/* ========= Utilidades de dados ========= */
async function safeSelect({table, select='*', orderBy, asc=true, filters=[]}) {
  try {
    let q = supa.from(table).select(select);
    if(orderBy) q = q.order(orderBy, {ascending: asc});
    for(const f of filters){ q = q.eq(f.col, f.val); }
    const {data, error, status} = await q;
    if(error){ throw {message:error.message, status}; }
    return data || [];
  } catch(err){
    console.warn(`[${table}]`, err);
    setStatus(`Erro lendo ${table}: ${err.message||err}`, 'err');
    return [];
  }
}
async function safeInsert(table, payload){
  const {error, status} = await supa.from(table).insert(payload);
  if(error) throw {message:error.message, status};
}
async function safeUpdate(table, payload, by){
  let q = supa.from(table).update(payload);
  Object.entries(by).forEach(([k,v])=> q=q.eq(k,v));
  const {error, status} = await q;
  if(error) throw {message:error.message, status};
}
async function safeDelete(table, by) {
  let q = supa.from(table).delete();
  Object.entries(by).forEach(([k,v])=> q=q.eq(k,v));
  const {error, status} = await q;
  if(error) throw {message:error.message, status};
}

/* ========= CADASTROS: Pratos ========= */
let pratos=[], pratosPage=1; const PAGE_SIZE=10; let pratoEditId=null;
async function loadCategoriasTo(selectId, includeAll=false) {
  const sel=$(selectId); if(!sel) return;
  sel.innerHTML = includeAll ? '<option value="">Todas</option>' : '';
  const data = await safeSelect({table:'categorias', select:'id,nome,tipo,ativo', orderBy:'nome'});
  (data||[]).forEach(c=>{
    const o=document.createElement('option'); o.value=c.nome; o.textContent=c.nome; sel.appendChild(o);
  });
}
async function loadPratos(){
  const tb=$('tblPratos').querySelector('tbody'); tb.innerHTML='<tr><td colspan="4">Carregando‚Ä¶</td></tr>';
  let data = await safeSelect({table:'pratos',select:'id,nome,categoria,ativo',orderBy:'nome'});
  pratos = data;
  renderPratos();
}
function renderPratos(){
  const term = $('pratos-search').value?.toLowerCase().trim()||'';
  const cat  = $('pratos-cat-filter').value||'';
  const filtered = pratos.filter(p => (!cat || p.categoria===cat) && (!term || (p.nome||'').toLowerCase().includes(term)));
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(pratosPage>totalPages) pratosPage=totalPages;
  const pageItems=filtered.slice((pratosPage-1)*PAGE_SIZE,(pratosPage-1)*PAGE_SIZE+PAGE_SIZE);
  const tb=$('tblPratos').querySelector('tbody'); tb.innerHTML='';
  pageItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.nome||'‚Äî'}</td><td>${p.categoria||'‚Äî'}</td>
      <td>${p.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${p.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${p.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
  $('pratos-page-info').textContent=`P√°gina ${pratosPage}/${totalPages}`;
  $('pratos-prev').disabled=pratosPage<=1; $('pratos-next').disabled=pratosPage>=totalPages;
}
$('pratos-prev').onclick=()=>{ pratosPage=Math.max(1,pratosPage-1); renderPratos(); };
$('pratos-next').onclick=()=>{ pratosPage+=1; renderPratos(); };
$('pratos-search').oninput=()=>{ pratosPage=1; renderPratos(); };
$('pratos-cat-filter').onchange=()=>{ pratosPage=1; renderPratos(); };

$('btnNovoPrato').onclick=()=>{
  pratoEditId=null;
  $('prato-form-title').textContent='Novo prato';
  $('prato-nome').value=''; $('prato-cat').value=''; $('prato-peso-un').value='g'; $('prato-peso').value='';
  $('prato-preco').value=''; $('prato-custo').value=''; $('prato-ultima').value='';
};
$('btnCancelarPrato').onclick=()=> $('btnNovoPrato').click();
$('tblPratos').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){
    const p=pratos.find(x=> String(x.id)===String(id)); if(!p) return;
    pratoEditId=p.id; $('prato-form-title').textContent='Editar prato';
    $('prato-nome').value=p.nome||''; $('prato-cat').value=p.categoria||''; $('prato-peso-un').value='g'; $('prato-peso').value='';
    $('prato-preco').value=''; $('prato-custo').value=''; $('prato-ultima').value='';
  }
  if(act==='toggle'){ try{ await safeUpdate('pratos',{ativo:!(pratos.find(x=>x.id===id)?.ativo)}, {id}); await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
  if(act==='del'){ if(!confirm('Excluir prato?')) return; try{ await safeDelete('pratos',{id}); await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
});
$('btnSalvarPrato').onclick=async ()=>{
  const payload={
    nome: $('prato-nome').value.trim(),
    categoria: $('prato-cat').value || null,
    peso: ptToNumber($('prato-peso').value),
    peso_un: $('prato-peso-un').value,
    preco_venda: $('prato-preco').value.trim() || null
  };
  if(!payload.nome){ alert('Informe o nome'); return; }
  try{
    if(pratoEditId){ await safeUpdate('pratos',payload,{id:pratoEditId}); }
    else{ await safeInsert('pratos',{...payload,ativo:true}); }
    await loadPratos();
    $('btnNovoPrato').click();
    setStatus('Prato salvo','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
};

/* ========= Componentes do Prato ========= */
async function loadPratoCompTable(){
  const prato_id=$('cp-prato').value; const tb=$('tblPrComp').querySelector('tbody'); tb.innerHTML='';
  if(!prato_id){ $('componentes-editor').style.display='none'; return; }
  $('componentes-editor').style.display='block';
  try{
    const data = await safeSelect({table:'prato_receitas', select:'id,receita_id,qtd,unidade', filters:[{col:'prato_id',val:prato_id}]});
    tb.innerHTML='';
    for(const r of data){
      const rec = await safeSelect({table:'receitas', select:'nome', filters:[{col:'id',val:r.receita_id}]});
      const nome = rec?.[0]?.nome || '(removida)';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${nome}</td><td>${fmt(r.qtd)}</td><td>${r.unidade}</td>
        <td class="row-actions"><button class="btn small" data-del="${r.id}">Remover</button></td>`;
      tb.appendChild(tr);
    }
  }catch(e){ tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>'; }
}
$('cp-prato')?.addEventListener('change', loadPratoCompTable);
$('btnAddPrComp')?.addEventListener('click', async ()=>{
  const prato_id=$('cp-prato').value, receita_id=$('cp-receita').value, qtd=ptToNumber($('cp-qtd').value), unidade=$('cp-und').value;
  if(!prato_id||!receita_id||!qtd) return alert('Selecione prato/receita e informe quantidade');
  try{
    await safeInsert('prato_receitas',{prato_id,receita_id,qtd,unidade});
    $('cp-qtd').value=''; await loadPratoCompTable();
  }catch(e){ alert(e.message||e); }
});
document.addEventListener('click', async (e)=>{
  const b=e.target.closest('#tblPrComp button[data-del]'); if(!b) return;
  if(!confirm('Remover receita do prato?')) return;
  try{ await safeDelete('prato_receitas',{id:b.dataset.del}); await loadPratoCompTable(); }catch(e){ alert(e.message||e); }
});

/* ========= Receitas ========= */
let recEditId=null, draftItems=[];
async function refreshDraftRefs(){
  const tipo=$('draft-tipo').value;
  if(tipo==='INGREDIENTE'){ await fillOptionsFrom('ingredientes','draft-ref','id','nome',{ativo:true}); }
  else { await fillOptionsFrom('receitas','draft-ref','id','nome',{ativo:true}); }
}
function renderDraft(){
  const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML='';
  draftItems.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${it.tipo}</td><td>${it.nome}</td><td>${fmt(it.qtd)}</td><td>${it.unidade}</td><td>${fmt(it.perda_pct)}%</td>
      <td class="row-actions"><button class="btn small" data-rm="${i}">Remover</button></td>`;
    tb.appendChild(tr);
  });
}
document.addEventListener('click',(e)=>{ const b=e.target.closest('#tblDraft button[data-rm]'); if(!b) return; draftItems.splice(+b.dataset.rm,1); renderDraft(); });
$('draft-tipo')?.addEventListener('change',refreshDraftRefs);
$('btnDraftAdd').onclick=async ()=>{
  const tipo=$('draft-tipo').value, ref_id=$('draft-ref').value, qtd=ptToNumber($('draft-qtd').value), unidade=$('draft-und').value, perda_pct=ptToNumber($('draft-perda').value);
  if(!ref_id||!qtd) return alert('Selecione a refer√™ncia e quantidade');
  let nome='';
  if(tipo==='INGREDIENTE'){ const r=await safeSelect({table:'ingredientes',select:'nome',filters:[{col:'id',val:ref_id}]}); nome=r?.[0]?.nome||''; }
  else { const r=await safeSelect({table:'receitas',select:'nome',filters:[{col:'id',val:ref_id}]}); nome=r?.[0]?.nome||''; }
  draftItems.push({tipo,ref_id,nome,qtd,unidade,perda_pct}); $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft();
};
$('btnDraftClear').onclick=()=>{ draftItems=[]; renderDraft(); };

$('btnSaveRec').onclick=async ()=>{
  const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null;
  if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
  try{
    const {data:ins,error}=await supa.from('receitas').insert({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).select('id').single();
    if(error) throw error;
    if(draftItems.length){
      const payload=draftItems.map(d=>({receita_id:ins.id,tipo:d.tipo,ref_id:d.ref_id,qtd:d.qtd,unidade:d.unidade,perda_pct:d.perda_pct}));
      await safeInsert('receita_itens',payload);
    }
    $('btnCancelRecEdit').click();
    await loadReceitas();
    setStatus('Receita salva','ok');
  }catch(e){ alert(e.message||e); }
};
$('btnUpdateRec').onclick=async ()=>{
  if(!recEditId) return;
  const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null;
  if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
  try{
    await safeUpdate('receitas',{nome,rendimento_qtd,unidade_rendimento,perda_pct,obs},{id:recEditId});
    await loadReceitas(); setStatus('Receita atualizada','ok');
  }catch(e){ alert(e.message||e); }
};
$('btnCancelRecEdit').onclick=()=>{
  recEditId=null; $('recipe-editor-container').style.display='none';
  $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs').value='';
  draftItems=[]; renderDraft();
  $('btnSaveRec').style.display='inline-flex'; $('btnUpdateRec').style.display='none';
};
$('btnShowNewRecipeForm').onclick=()=>{
  $('recipe-editor-container').style.display='block';
  $('recipe-form-title').textContent='Nova Receita';
  $('btnSaveRec').style.display='inline-flex';
  $('btnUpdateRec').style.display='none';
  refreshDraftRefs();
};
async function loadReceitas(){
  const tb=$('tblRec').querySelector('tbody'); tb.innerHTML='<tr><td colspan="5">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'v_receitas_resumo', select:'id,nome,rendimento_qtd,unidade_rendimento,itens,ativo', orderBy:'nome'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.nome}</td><td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td><td>${r.itens}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="5">Crie a view <b>v_receitas_resumo</b> ou libere acesso.</td></tr>';
  }
  await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true});
  await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true});
}
$('tblRec').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='toggle'){ try{ const cur = (await safeSelect({table:'receitas',select:'ativo',filters:[{col:'id',val:id}]}))?.[0]?.ativo; await safeUpdate('receitas',{ativo:!cur},{id}); await loadReceitas(); }catch(e){ alert(e.message||e); } }
  if(act==='del'){ if(!confirm('Excluir receita?')) return; try{ await safeDelete('receitas',{id}); await loadReceitas(); }catch(e){ alert(e.message||e); } }
  if(act==='edit'){
    const r = (await safeSelect({table:'receitas',select:'id,nome,rendimento_qtd,unidade_rendimento,perda_pct,obs',filters:[{col:'id',val:id}]}))?.[0];
    if(!r) return;
    recEditId=r.id; $('recipe-editor-container').style.display='block'; $('recipe-form-title').textContent='Editar Receita';
    $('btnSaveRec').style.display='none'; $('btnUpdateRec').style.display='inline-flex';
    $('rec-nome').value=r.nome||''; $('rec-rend-qtd').value=r.rendimento_qtd||''; $('rec-rend-und').value=r.unidade_rendimento||'g'; $('rec-perda').value=r.perda_pct||0; $('rec-obs').value=r.obs||'';
    draftItems=[]; renderDraft(); refreshDraftRefs();
  }
});

/* ========= Fill select util ========= */
async function fillOptionsFrom(table, selId, valKey, labelKey, whereEq){
  const sel=$(selId); if(!sel) return; sel.innerHTML='<option value="">Carregando‚Ä¶</option>';
  try{
    let q=supa.from(table).select(`${valKey},${labelKey}`);
    if(labelKey) q=q.order(labelKey, {ascending:true});
    if(whereEq){ Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v)); }
    const {data,error}=await q;
    if(error) throw error;
    sel.innerHTML='<option value="">Selecione</option>';
    (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
  }catch(e){ sel.innerHTML='<option value="">(erro)</option>'; }
}

/* ========= Ingredientes ========= */
$('btnShowNewIngredienteForm').onclick=()=>{
  $('ingrediente-editor-container').style.display='block';
  $('ingrediente-form-title').textContent='Novo Ingrediente';
  $('ing-nome').value=''; $('ing-categoria').value=''; $('ing-und').value='kg'; $('ing-custo').value=''; $('ing-obs').value='';
};
$('btnCancelIngEdit').onclick=()=>{ $('ingrediente-editor-container').style.display='none'; };
$('btnSaveIng').onclick=async ()=>{
  const payload={
    nome:$('ing-nome').value.trim(),
    categoria:$('ing-categoria').value||null,
    unidade:$('ing-und').value,
    custo_unitario: ptToNumber($('ing-custo').value),
    obs:$('ing-obs').value.trim()||null,
    ativo:true
  };
  if(!payload.nome){ alert('Informe o nome'); return; }
  try{ await safeInsert('ingredientes',payload); $('btnCancelIngEdit').click(); await loadIngredientes(); setStatus('Ingrediente salvo','ok'); }catch(e){ alert(e.message||e); }
};
async function loadIngredientes(){
  const tb=$('tblIng').querySelector('tbody'); tb.innerHTML='<tr><td colspan="6">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'ingredientes', select:'id,nome,categoria,unidade,custo_unitario,ativo', orderBy:'nome'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.nome}</td><td>${r.categoria||'‚Äî'}</td><td>${r.unidade}</td><td>R$ ${fmt(r.custo_unitario)}</td>
        <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions"><button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button><button class="btn small" data-act="del" data-id="${r.id}">Excluir</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ tb.innerHTML='<tr><td colspan="6">Erro/Tabela n√£o encontrada: <b>ingredientes</b></td></tr>'; }
}
$('tblIng').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='toggle'){ const cur=(await safeSelect({table:'ingredientes',select:'ativo',filters:[{col:'id',val:id}]}))?.[0]?.ativo; try{ await safeUpdate('ingredientes',{ativo:!cur},{id}); await loadIngredientes(); }catch(e){ alert(e.message||e); } }
  if(act==='del'){ if(!confirm('Excluir ingrediente?')) return; try{ await safeDelete('ingredientes',{id}); await loadIngredientes(); }catch(e){ alert(e.message||e); } }
});

/* ========= NOVOS Cadastros ========= */
// UM
let umEditId=null;
$('btnShowUMForm').onclick=()=>{ umEditId=null; $('um-editor').style.display='block'; $('um-form-title').textContent='Nova Unidade de Medida';
  $('um-nome').value=''; $('um-sigla').value=''; $('um-codigo').value=''; $('um-base').value=''; $('um-fator').value=''; };
$('btnCancelUM').onclick=()=>{ $('um-editor').style.display='none'; };
$('btnSaveUM').onclick=async ()=>{
  const payload={
    nome:$('um-nome').value.trim(), sigla:$('um-sigla').value.trim(),
    codigo:$('um-codigo').value.trim()||null, base:$('um-base').value||null,
    fator: $('um-fator').value? Number($('um-fator').value): null,
    ativo:true
  };
  if(!payload.nome||!payload.sigla){ alert('Nome e Sigla s√£o obrigat√≥rios'); return; }
  try{
    if(umEditId) await safeUpdate('unidades_medida',payload,{id:umEditId});
    else await safeInsert('unidades_medida',payload);
    $('btnCancelUM').click(); await loadUM(); setStatus('UM salva','ok');
  }catch(e){ alert(e.message||e); }
};
async function loadUM(){
  const tb=$('tblUM').querySelector('tbody'); tb.innerHTML='<tr><td colspan="7">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'unidades_medida', select:'id,nome,sigla,codigo,base,fator,ativo', orderBy:'nome'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.nome}</td><td>${r.sigla||'‚Äî'}</td><td>${r.codigo||'‚Äî'}</td><td>${r.base||'‚Äî'}</td><td>${r.fator??'‚Äî'}</td>
        <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-um="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-um="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-um="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){ tb.innerHTML='<tr><td colspan="7">Tabela <b>unidades_medida</b> ausente ou sem permiss√£o.</td></tr>'; }
}
document.addEventListener('click', async (e)=>{
  const b=e.target.closest('#tblUM button[data-um]'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.um;
  if(act==='toggle'){ const cur=(await safeSelect({table:'unidades_medida',select:'ativo',filters:[{col:'id',val:id}]}))?.[0]?.ativo; try{ await safeUpdate('unidades_medida',{ativo:!cur},{id}); await loadUM(); }catch(e){ alert(e.message||e); } }
  if(act==='del'){ if(!confirm('Excluir unidade de medida?')) return; try{ await safeDelete('unidades_medida',{id}); await loadUM(); }catch(e){ alert(e.message||e); } }
  if(act==='edit'){
    const r=(await safeSelect({table:'unidades_medida',select:'*',filters:[{col:'id',val:id}]}))?.[0]; if(!r) return;
    umEditId=r.id; $('um-editor').style.display='block'; $('um-form-title').textContent='Editar Unidade de Medida';
    $('um-nome').value=r.nome||''; $('um-sigla').value=r.sigla||''; $('um-codigo').value=r.codigo||''; $('um-base').value=r.base||''; $('um-fator').value=r.fator??'';
  }
});

// Unidades (destino)
let unEditId=null;
$('btnShowUnForm').onclick=()=>{ unEditId=null; $('un-editor').style.display='block'; $('un-form-title').textContent='Nova Unidade'; $('un-nome').value=''; $('un-ativo').value='true'; };
$('btnCancelUn').onclick=()=>{ $('un-editor').style.display='none'; };
$('btnSaveUn').onclick=async ()=>{
  const payload={ nome:$('un-nome').value.trim(), ativo:$('un-ativo').value==='true' };
  if(!payload.nome){ alert('Informe o nome'); return; }
  try{
    if(unEditId) await safeUpdate('unidades',payload,{id:unEditId});
    else await safeInsert('unidades',payload);
    $('btnCancelUn').click(); await loadUnidades(); setStatus('Unidade salva','ok');
  }catch(e){ alert(e.message||e); }
};
async function loadUnidades(){
  const tb=$('tblUnidades').querySelector('tbody'); tb.innerHTML='<tr><td colspan="3">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'unidades', select:'id,nome,ativo', orderBy:'nome'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.nome}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-un="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-un="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-un="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){ tb.innerHTML='<tr><td colspan="3">Tabela <b>unidades</b> ausente ou RLS negou (401).</td></tr>'; }
}
document.addEventListener('click', async (e)=>{
  const b=e.target.closest('#tblUnidades button[data-un]'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.un;
  if(act==='toggle'){ const cur=(await safeSelect({table:'unidades',select:'ativo',filters:[{col:'id',val:id}]}))?.[0]?.ativo; try{ await safeUpdate('unidades',{ativo:!cur},{id}); await loadUnidades(); }catch(e){ alert(e.message||e); } }
  if(act==='del'){ if(!confirm('Excluir unidade?')) return; try{ await safeDelete('unidades',{id}); await loadUnidades(); }catch(e){ alert(e.message||e); } }
  if(act==='edit'){
    const r=(await safeSelect({table:'unidades',select:'*',filters:[{col:'id',val:id}]}))?.[0]; if(!r) return;
    unEditId=r.id; $('un-editor').style.display='block'; $('un-form-title').textContent='Editar Unidade';
    $('un-nome').value=r.nome||''; $('un-ativo').value=r.ativo?'true':'false';
  }
});

// Categorias
let catEditId=null;
$('btnShowCatForm').onclick=()=>{ catEditId=null; $('cat-editor').style.display='block'; $('cat-form-title').textContent='Nova Categoria'; $('cat-nome').value=''; $('cat-tipo').value='PRATO'; $('cat-ativo').value='true'; };
$('btnCancelCat').onclick=()=>{ $('cat-editor').style.display='none'; };
$('btnSaveCat').onclick=async ()=>{
  const payload={ nome:$('cat-nome').value.trim(), tipo:$('cat-tipo').value, ativo:$('cat-ativo').value==='true' };
  if(!payload.nome){ alert('Informe o nome'); return; }
  try{
    if(catEditId) await safeUpdate('categorias',payload,{id:catEditId});
    else await safeInsert('categorias',payload);
    $('btnCancelCat').click(); await loadCategorias(); await loadCategoriasTo('pratos-cat-filter', true); await loadCategoriasTo('prato-cat');
    setStatus('Categoria salva','ok');
  }catch(e){ alert(e.message||e); }
};
async function loadCategorias(){
  const tb=$('tblCategorias').querySelector('tbody'); tb.innerHTML='<tr><td colspan="4">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'categorias', select:'id,nome,tipo,ativo', orderBy:'nome'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.nome}</td><td>${r.tipo||'‚Äî'}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-cat="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-cat="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-cat="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){ tb.innerHTML='<tr><td colspan="4">Tabela <b>categorias</b> ausente ou erro de permiss√£o.</td></tr>'; }
}
document.addEventListener('click', async (e)=>{
  const b=e.target.closest('#tblCategorias button[data-cat]'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.cat;
  if(act==='toggle'){ const cur=(await safeSelect({table:'categorias',select:'ativo',filters:[{col:'id',val:id}]}))?.[0]?.ativo; try{ await safeUpdate('categorias',{ativo:!cur},{id}); await loadCategorias(); }catch(e){ alert(e.message||e); } }
  if(act==='del'){ if(!confirm('Excluir categoria?')) return; try{ await safeDelete('categorias',{id}); await loadCategorias(); }catch(e){ alert(e.message||e); } }
  if(act==='edit'){
    const r=(await safeSelect({table:'categorias',select:'*',filters:[{col:'id',val:id}]}))?.[0]; if(!r) return;
    catEditId=r.id; $('cat-editor').style.display='block'; $('cat-form-title').textContent='Editar Categoria';
    $('cat-nome').value=r.nome||''; $('cat-tipo').value=r.tipo||'PRATO'; $('cat-ativo').value=r.ativo?'true':'false';
  }
});

// Tipos de Item
let tipoEditId=null;
$('btnShowTipoForm').onclick=()=>{ tipoEditId=null; $('tipo-editor').style.display='block'; $('tipo-form-title').textContent='Novo Tipo'; $('tipo-codigo').value=''; $('tipo-nome').value=''; $('tipo-ativo').value='true'; };
$('btnCancelTipo').onclick=()=>{ $('tipo-editor').style.display='none'; };
$('btnSaveTipo').onclick=async ()=>{
  const payload={ codigo:$('tipo-codigo').value.trim(), nome:$('tipo-nome').value.trim(), ativo:$('tipo-ativo').value==='true' };
  if(!payload.codigo||!payload.nome){ alert('C√≥digo e Nome obrigat√≥rios'); return; }
  try{
    if(tipoEditId) await safeUpdate('tipos_item',payload,{id:tipoEditId});
    else await safeInsert('tipos_item',payload);
    $('btnCancelTipo').click(); await loadTipos(); setStatus('Tipo salvo','ok');
  }catch(e){ alert(e.message||e); }
};
async function loadTipos(){
  const tb=$('tblTipos').querySelector('tbody'); tb.innerHTML='<tr><td colspan="4">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'tipos_item', select:'id,codigo,nome,ativo', orderBy:'codigo'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.codigo}</td><td>${r.nome}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-tipo="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-tipo="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-tipo="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){ tb.innerHTML='<tr><td colspan="4">Tabela <b>tipos_item</b> ausente.</td></tr>'; }
}
document.addEventListener('click', async (e)=>{
  const b=e.target.closest('#tblTipos button[data-tipo]'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.tipo;
  if(act==='toggle'){ const cur=(await safeSelect({table:'tipos_item',select:'ativo',filters:[{col:'id',val:id}]}))?.[0]?.ativo; try{ await safeUpdate('tipos_item',{ativo:!cur},{id}); await loadTipos(); }catch(e){ alert(e.message||e); } }
  if(act==='del'){ if(!confirm('Excluir tipo?')) return; try{ await safeDelete('tipos_item',{id}); await loadTipos(); }catch(e){ alert(e.message||e); } }
  if(act==='edit'){
    const r=(await safeSelect({table:'tipos_item',select:'*',filters:[{col:'id',val:id}]}))?.[0]; if(!r) return;
    tipoEditId=r.id; $('tipo-editor').style.display='block'; $('tipo-form-title').textContent='Editar Tipo';
    $('tipo-codigo').value=r.codigo||''; $('tipo-nome').value=r.nome||''; $('tipo-ativo').value=r.ativo?'true':'false';
  }
});

/* ========= Produ√ß√£o (Preservado) ========= */
async function preencherCategoriasProducao(){
  const data=await safeSelect({table:'pratos',select:'categoria',orderBy:'categoria'});
  const cats=[...new Set((data||[]).map(x=>x.categoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
  const sel=$('cat-filter'); sel.innerHTML='';
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}
async function obterUltimaDataVenda(){
  try{
    const {data,error}=await supa.from('vendas_pratos_view_only_pratos').select('data').order('data',{ascending:false}).limit(1).maybeSingle();
    if(error) throw error; return data?.data || new Date().toISOString().slice(0,10);
  }catch{ return new Date().toISOString().slice(0,10); }
}
$('btnCalcularPrev').onclick=async ()=>{
  const win=Math.max(1,+$('win-dias').value||7), proj=Math.max(1,+$('proj-dias').value||7);
  $('th-proj').textContent=`Qtd/Proje√ß√£o (${proj} dias)`; $('th-proj-prato').textContent=`Proje√ß√£o (${proj} dias)`;
  const refReal=await obterUltimaDataVenda(); $('prev-hint-top').textContent=`√öltima data com lan√ßamento: ${refReal}`;
  // Vendas
  const fim = new Date(refReal), ini=new Date(refReal); ini.setDate(fim.getDate()-(win-1));
  const isoIni=ini.toISOString().slice(0,10), isoFim=refReal;
  const {data:vendas,error:errV}=await supa.from('vendas_pratos_view_only_pratos').select('data,prato,quantidade').gte('data',isoIni).lte('data',isoFim);
  if(errV){ setStatus('Erro ao ler vendas: '+errV.message,'err'); return; }
  const {data:pratosTbl}=await supa.from('pratos').select('id,nome,categoria');
  const porPrato=new Map();
  const selCats = new Set(Array.from($('cat-filter').selectedOptions||[]).map(o=>o.value));
  const catOf = new Map((pratosTbl||[]).map(p=>[p.nome,p.categoria||'OUTROS']));
  vendas?.forEach(v=>{ if(selCats.size && !selCats.has(catOf.get(v.prato))) return; porPrato.set(v.prato,(porPrato.get(v.prato)||0)+(+v.quantidade||0)); });
  const mediaPrato = [...porPrato.entries()].map(([nome,tot])=>({nome,cat:catOf.get(nome)||'‚Äî',md:tot/win,proj:(tot/win)*proj})).sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
  const tbResumo=$('tblResumoPratos').querySelector('tbody'); tbResumo.innerHTML=''; mediaPrato.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.cat}</td><td>${fmt(r.md)}</td><td>${fmt(r.proj)}</td>`; tbResumo.appendChild(tr); });
  // Por receita (simplificado e robusto; requer prato_receitas)
  const idsPrato = new Set((pratosTbl||[]).filter(p=> mediaPrato.find(m=>m.nome===p.nome)).map(p=>p.id));
  const prc = (await supa.from('prato_receitas').select('prato_id,receita_id,qtd,unidade').in('prato_id',[...idsPrato])).data||[];
  const nomeToId=new Map((pratosTbl||[]).map(p=>[p.nome,p.id]));
  const mediaByNome=new Map(mediaPrato.map(m=>[m.nome,m.md]));
  const recAgg=new Map();
  prc.forEach(r=>{
    const pratoNome = (pratosTbl||[]).find(p=>p.id===r.prato_id)?.nome;
    const md = mediaByNome.get(pratoNome)||0;
    const cur=recAgg.get(r.receita_id)||{perDia:0,un:r.unidade||'g'}; cur.perDia += md*(+r.qtd||0); recAgg.set(r.receita_id,cur);
  });
  const recIds=[...recAgg.keys()];
  const meta=(await supa.from('receitas').select('id,nome').in('id',recIds)).data||[];
  const metaMap=new Map(meta.map(r=>[r.id,r.nome]));
  const tb=$('tblPrev').querySelector('tbody'); tb.innerHTML='';
  [...recAgg.entries()].map(([id,a])=>({nome:metaMap.get(id)||('Receita '+id),un:a.un,dia:a.perDia,proj:a.perDia*proj}))
    .sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'))
    .forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.un}</td><td>${fmt(r.dia)}</td><td>${fmt(r.proj)}</td>`; tb.appendChild(tr); });
  $('prev-hint').textContent = `Janela: ${isoIni} ‚Üí ${isoFim}. Proje√ß√£o ${proj}d.`;
};

/* ========= Compras (Sugest√µes) ========= */
async function loadSugestoes(){
  const tb=$('tblSugestoes').querySelector('tbody'); tb.innerHTML='<tr><td colspan="7">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'mv_sugestoes_compra', select:'item_nome,status,saldo,ponto_pedido,consumo_dia,sugerido_compra,multiplo_compra'});
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.item_nome}</td><td>${r.status}</td><td>${fmt(r.saldo)}</td><td>${fmt(r.ponto_pedido||0)}</td><td>${fmt(r.consumo_dia||0)}</td><td>${fmt(r.sugerido_compra||0)}</td><td>${fmt(r.multiplo_compra||1)}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="7">Crie a <b>mv_sugestoes_compra</b> e fun√ß√µes relacionadas, ou libere acesso.</td></tr>';
  }
}
$('btnRefreshSuggestions').onclick=loadSugestoes;
$('btnExportSuggestions').onclick=()=>{
  const rows=[['Item','Status','Saldo','Ponto Pedido','Consumo/Dia','Sugest√£o','M√∫ltiplo']];
  $$('#tblSugestoes tbody tr').forEach(tr=>{
    rows.push(Array.from(tr.children).map(td=>td.textContent));
  });
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='sugestoes_compra.csv'; a.click(); URL.revokeObjectURL(url);
};

/* ========= Estoque: Vis√£o & Movimentar ========= */
async function loadVisaoEstoque(){
  // Filtros (unidades e categorias)
  await fillOptionsFrom('unidades','filtro-unidade-estoque','id','nome');
  await fillOptionsFrom('categorias','filtro-categoria-estoque','nome','nome');
  // Saldos
  const tb=$('tblSaldo').querySelector('tbody'); tb.innerHTML='<tr><td colspan="6">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'vw_estoque_saldos', select:'item_nome,item_tipo,unidade_nome,saldo,custo_medio,valor'});
    tb.innerHTML = '';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.item_nome}</td><td>${r.item_tipo}</td><td>${r.unidade_nome}</td><td>${fmt(r.saldo)}</td><td>R$ ${fmt(r.custo_medio||0)}</td><td>R$ ${fmt(r.valor||0)}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="6">Crie as views <b>vw_estoque_saldos</b> e <b>vw_estoque_saldos_resumo</b>.</td></tr>';
  }
  // Lotes
  const tbl=$('tblSaldoLotes').querySelector('tbody'); tbl.innerHTML='<tr><td colspan="6">Carregando‚Ä¶</td></tr>';
  try{
    const data = await safeSelect({table:'vw_estoque_saldos_resumo', select:'item_nome,lote,validade,saldo,un_medida,custo_unit'});
    tbl.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.item_nome}</td><td>${r.lote||'‚Äî'}</td><td>${r.validade||'‚Äî'}</td><td>${fmt(r.saldo)}</td><td>${r.un_medida||'‚Äî'}</td><td>R$ ${fmt(r.custo_unit||0)}</td>`;
      tbl.appendChild(tr);
    });
  }catch(e){
    tbl.innerHTML='<tr><td colspan="6">(sem dados)</td></tr>';
  }
}
function setupMovUI(){
  const cont=$('sub-mov');
  cont.addEventListener('click',(e)=>{
    const btn=e.target.closest('button[data-mov-type]'); if(!btn) return;
    const type=btn.dataset.movType;
    $('mov-form-container').style.display='block';
    $('mov-form-title').textContent = ({
      'ENTRADA':'Registrar ENTRADA',
      'SAIDA':'Registrar SA√çDA',
      'TRANSFERENCIA':'Registrar TRANSFER√äNCIA',
      'AJUSTE':'Registrar AJUSTE'
    })[type] || 'Movimenta√ß√£o';

    // mostra/oculta campos conforme opera√ß√£o
    $('mov-unidade-destino-group').style.display = (type==='TRANSFERENCIA') ? '' : 'none';
    $('mov-ajuste-sinal-group').style.display   = (type==='AJUSTE') ? '' : 'none';
    $('mov-custo').parentElement.style.display  = (type==='ENTRADA') ? '' : 'none';
  });
  $('btnMovCancel').onclick=()=>{ $('mov-form-container').style.display='none'; };

  // Carregar combos
  fillOptionsFrom('unidades','mov-unidade-origem','id','nome');
  fillOptionsFrom('unidades','mov-unidade-destino','id','nome');
  fillOptionsFrom('ingredientes','mov-item','id','nome',{ativo:true});

  $('frmMov').addEventListener('submit', async (e)=>{
    e.preventDefault();
    try{
      const origem=$('mov-unidade-origem').value||null;
      const destino=$('mov-unidade-destino').value||null;
      const qtd=Number($('mov-qtd').value||0);
      const un=$('mov-un').value||'un';
      const tipoItem=$('mov-item-tipo').value||'ING';
      const item=$('mov-item').value;
      const lote=$('mov-lote').value||null;
      const val=$('mov-validade').value||null;
      const custo=Number($('mov-custo').value||0);
      const doc=$('mov-doc').value||null;

      if(!origem || !item || !qtd) { alert('Origem, item e quantidade s√£o obrigat√≥rios'); return; }

      // Determina tipo final
      const mode = $('mov-form-title').textContent;
      let tipo = 'ENTRADA';
      if(mode.includes('SA√çDA')) tipo='SAIDA';
      if(mode.includes('TRANSFER√äNCIA')) tipo='TRANSF_SAIDA'; // e depois uma TRANSF_ENTRADA
      if(mode.includes('AJUSTE')) tipo = ($('mov-ajuste-sinal').value==='+') ? 'AJUSTE_POSITIVO' : 'AJUSTE_NEGATIVO';

      // Inser√ß√µes (simples e robustas)
      const base = {
        unidade_id: origem, item_tipo: tipoItem, item_id: item, un, un_medida: un,
        qtd, tipo, custo_unit: (tipo==='ENTRADA'? custo:null), lote, validade: val, ref_doc: doc, usuario: 'app'
      };
      await safeInsert('mov_estoque',{...base, id: crypto.randomUUID(), ts: new Date().toISOString()});
      if(mode.includes('TRANSFER√äNCIA')){
        // segunda perna
        if(!destino){ alert('Selecione a Unidade Destino'); return; }
        await safeInsert('mov_estoque',{...base, unidade_id: destino, tipo:'TRANSF_ENTRADA', id: crypto.randomUUID(), ts: new Date().toISOString()});
      }
      setStatus('Movimenta√ß√£o registrada','ok');
      $('frmMov').reset(); $('mov-form-container').style.display='none';
      await loadMovRecentes();
      await loadVisaoEstoque();
    }catch(err){ alert(err.message||err); }
  });
}
async function loadMovRecentes(){
  const tb=$('tblMovRecentes').querySelector('tbody'); tb.innerHTML='<tr><td colspan="5">Carregando‚Ä¶</td></tr>';
  try{
    const {data,error}=await supa.from('mov_estoque').select('ts,tipo,item_tipo,item_id,qtd,unidade_id').order('ts',{ascending:false}).limit(20);
    if(error) throw error;
    tb.innerHTML='';
    for(const r of (data||[])){
      let itemNome='(item)'; if(r.item_tipo==='ING'){ const i=await supa.from('ingredientes').select('nome').eq('id',r.item_id).maybeSingle(); itemNome=i.data?.nome||'(ingrediente)'; }
      const un=await supa.from('unidades').select('nome').eq('id',r.unidade_id).maybeSingle();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${new Date(r.ts).toLocaleString('pt-BR')}</td><td>${r.tipo}</td><td>${itemNome}</td><td>${fmt(r.qtd)}</td><td>${un.data?.nome||'‚Äî'}</td>`;
      tb.appendChild(tr);
    }
  }catch(e){ tb.innerHTML='<tr><td colspan="5">(sem dados)</td></tr>'; }
}

/* ========= Boot ========= */
async function boot(){
  setStatus('Carregando‚Ä¶');
  await loadCategoriasTo('pratos-cat-filter', true);
  await loadCategoriasTo('prato-cat');
  await loadPratos();
  await loadReceitas();
  await fillOptionsFrom('categorias','ing-categoria','nome','nome');
  await loadIngredientes();
  await loadUM();
  await loadUnidades();
  await loadCategorias();
  await loadTipos();
  await preencherCategoriasProducao();
  await loadVisaoEstoque();
  setupMovUI();
  await loadMovRecentes();
  setStatus('Pronto','ok');
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
