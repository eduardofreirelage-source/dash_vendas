<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Gestão • Estoque & Cadastros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%230944D8"/><path d="M16 36l12 12L48 20" stroke="white" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>' />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b1020; --panel:#121833; --muted:#8ea5ff; --text:#e7ecff; --accent:#7aa2ff; --ok:#00d48a; --warn:#ffd15a; --err:#ff6b6b;
      --line:#1c2549; --btn:#1b2350; --btnh:#22306e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1024);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(9,16,48,.7);backdrop-filter: blur(6px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    nav.tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--line);background:var(--btn);border-radius:8px;cursor:pointer;user-select:none}
    .tab.active{background:var(--btnh);border-color:#2b3a80}
    .grid{display:grid;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .title{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1 1 180px}
    label{font-size:12px;color:#bfc9ff;margin-bottom:4px;display:block}
    input[type="text"], input[type="number"], select{
      width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--line);background:#0d1330;color:var(--text);outline:none
    }
    input[type="checkbox"]{transform:scale(1.2);vertical-align:middle}
    button{padding:10px 14px;border:1px solid var(--line);background:var(--btn);color:var(--text);border-radius:10px;cursor:pointer}
    button.primary{background:#2642cc;border-color:#3151ff}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{font-size:12px;color:#bfc9ff;text-transform:uppercase;letter-spacing:.04em}
    tr:hover td{background:#0f1842}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .caps{letter-spacing:.04em;text-transform:uppercase}
    .subtabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#0f1640;cursor:pointer}
    .subtab.active{background:#16205b;border-color:#2b3a80}
    .toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:999}
    .toast .t{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);min-width:280px}
    .t.ok{border-color:#124c3a;background:#0d2e25}
    .t.err{border-color:#5b1d2a;background:#2a0f16}
    .t.warn{border-color:#5b4a1d;background:#2a2410}
    .flex-end{display:flex;gap:8px;justify-content:flex-end}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .search{display:flex;gap:8px}
    .search input{flex:1}
    .empty{padding:20px;color:#9db0ff;text-align:center}
    @media (max-width:760px){ .row{flex-direction:column} }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Gestão • <span class="muted">Estoque & Cadastros</span></h1>
    <nav class="tabs" id="mainTabs">
      <div class="tab active" data-target="tab-home">Visão Geral</div>
      <div class="tab" data-target="tab-cadastros">Cadastros</div>
      <div class="tab" data-target="tab-estoque">Estoque</div>
    </nav>
  </div>
</header>

<main class="wrap grid" style="grid-template-columns: 1fr;">
  <!-- Visão Geral -->
  <section class="panel" id="tab-home">
    <div class="title"><h2 style="margin:0">Visão Geral</h2><span class="pill" id="envPill">—</span></div>
    <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(260px,1fr));">
      <div class="panel">
        <h3 style="margin-top:0">Estoque (resumo)</h3>
        <div id="homeEstoque"></div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">Atalhos</h3>
        <div class="row">
          <button class="primary" data-open="cad-um">Unidades de Medida</button>
          <button data-open="cad-unidades">Unidades (destino)</button>
          <button data-open="cad-categorias">Categorias</button>
          <button data-open="cad-tipos">Tipos de Item</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Cadastros -->
  <section class="panel" id="tab-cadastros" style="display:none">
    <div class="title"><h2 style="margin:0">Cadastros</h2></div>
    <div class="subtabs" id="subTabs">
      <div class="subtab active" data-sub="cad-um">Unidades de Medida</div>
      <div class="subtab" data-sub="cad-unidades">Unidades (destino)</div>
      <div class="subtab" data-sub="cad-categorias">Categorias</div>
      <div class="subtab" data-sub="cad-tipos">Tipos de Item</div>
    </div>

    <!-- UM -->
    <div class="panel" id="cad-um">
      <div class="title"><h3 style="margin:0">Unidades de Medida</h3></div>
      <div class="row">
        <div>
          <label>Sigla</label>
          <input id="um-sigla" type="text" placeholder="ex.: KG" />
        </div>
        <div>
          <label>Nome</label>
          <input id="um-nome" type="text" placeholder="Quilograma" />
        </div>
        <div>
          <label>Código</label>
          <input id="um-codigo" type="text" placeholder="kg" />
        </div>
        <div>
          <label>Base</label>
          <select id="um-base">
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="un">un</option>
          </select>
        </div>
        <div>
          <label>Fator</label>
          <input id="um-fator" type="number" step="0.000001" value="1" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label>Ativo</label><input id="um-ativo" type="checkbox" checked />
        </div>
      </div>
      <div class="flex-end" style="margin-top:8px">
        <button id="um-clear">Limpar</button>
        <button class="primary" id="um-save">Salvar</button>
      </div>
      <div style="margin-top:14px" id="um-list"></div>
    </div>

    <!-- Unidades (destino) -->
    <div class="panel" id="cad-unidades" style="display:none">
      <div class="title"><h3 style="margin:0">Unidades (destino)</h3></div>
      <div class="row">
        <div>
          <label>Nome</label>
          <input id="unid-nome" type="text" placeholder="Depósito A / Loja Centro" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label>Ativo</label><input id="unid-ativo" type="checkbox" checked />
        </div>
      </div>
      <div class="flex-end" style="margin-top:8px">
        <button id="unid-clear">Limpar</button>
        <button class="primary" id="unid-save">Salvar</button>
      </div>
      <div style="margin-top:14px" id="unid-list"></div>
    </div>

    <!-- Categorias -->
    <div class="panel" id="cad-categorias" style="display:none">
      <div class="title"><h3 style="margin:0">Categorias</h3></div>
      <div class="row">
        <div>
          <label>Nome</label>
          <input id="cat-nome" type="text" placeholder="Alimentos / Bebidas / ..." />
        </div>
        <div>
          <label>Tipo</label>
          <select id="cat-tipo">
            <option value="INGREDIENTE">INGREDIENTE</option>
            <option value="PRATO">PRATO</option>
            <option value="COMPONENTE">COMPONENTE</option>
            <option value="RECEITA">RECEITA</option>
          </select>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label>Ativo</label><input id="cat-ativo" type="checkbox" checked />
        </div>
      </div>
      <div class="flex-end" style="margin-top:8px">
        <button id="cat-clear">Limpar</button>
        <button class="primary" id="cat-save">Salvar</button>
      </div>
      <div style="margin-top:14px" id="cat-list"></div>
    </div>

    <!-- Tipos de Item -->
    <div class="panel" id="cad-tipos" style="display:none">
      <div class="title"><h3 style="margin:0">Tipos de Item</h3><span class="muted">(tabela: <code>item_tipos</code>)</span></div>
      <div class="row">
        <div>
          <label>Nome</label>
          <input id="tipo-nome" type="text" placeholder="ING / REC / PRD ..." />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <label>Ativo</label><input id="tipo-ativo" type="checkbox" checked />
        </div>
      </div>
      <div class="flex-end" style="margin-top:8px">
        <button id="tipo-clear">Limpar</button>
        <button class="primary" id="tipo-save">Salvar</button>
      </div>
      <div style="margin-top:14px" id="tipo-list"></div>
      <div class="muted" style="margin-top:8px">Se a tabela não existir, os botões continuarão exibindo o erro; crie <code>public.item_tipos(id uuid pk default gen_random_uuid(), nome text unique not null, ativo boolean not null default true)</code> para habilitar.</div>
    </div>
  </section>

  <!-- Estoque -->
  <section class="panel" id="tab-estoque" style="display:none">
    <div class="title"><h2 style="margin:0">Estoque</h2></div>
    <div class="panel">
      <div class="row search">
        <input id="stk-q" type="text" placeholder="Buscar por nome…" />
        <button id="stk-reload">Atualizar</button>
      </div>
      <div id="stk-list" style="margin-top:12px"></div>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
/** ========= CONFIG ========= **/
const SUPABASE_URL = "https://SEU-PROJETO.supabase.co"; // <<<<<< AJUSTE AQUI
const SUPABASE_ANON_KEY = "SEU-ANON-KEY";                // <<<<<< AJUSTE AQUI

/** ========= CORE ========= **/
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const Toast = {
  box: document.getElementById('toast'),
  show(msg, type='ok'){
    const t = document.createElement('div');
    t.className = 't ' + type;
    t.textContent = msg;
    this.box.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 4000);
  }
};

function setEnvPill(){
  const pill = document.getElementById('envPill');
  const url = new URL(SUPABASE_URL);
  pill.textContent = url.hostname.split('.')[0]; // subdomínio do projeto
}

/** Helpers supabase **/
async function sSelect(table, selectCols, opts={}){
  const q = supabase.from(table).select(selectCols);
  if (opts.order) q.order(opts.order, { ascending: opts.ascending ?? true });
  if (opts.eq) for (const [k,v] of Object.entries(opts.eq)) q.eq(k,v);
  const { data, error } = await q;
  if (error){ console.warn(`[${table}]`, error); throw error; }
  return data;
}
async function sInsert(table, rows){
  const { data, error } = await supabase.from(table).insert(rows).select();
  if (error){ console.warn(`[${table}] insert`, error); throw error; }
  return data;
}
async function sUpdate(table, values, where){
  let q = supabase.from(table).update(values);
  for (const [k,v] of Object.entries(where)) q = q.eq(k,v);
  const { data, error } = await q.select();
  if (error){ console.warn(`[${table}] update`, error); throw error; }
  return data;
}

/** ========= UI TABS ========= **/
function wireTabs(){
  const mainTabs = document.getElementById('mainTabs').querySelectorAll('.tab');
  mainTabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      mainTabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('main > section.panel').forEach(sec=>sec.style.display='none');
      document.getElementById(t.dataset.target).style.display = '';
    });
  });
  // atalhos
  document.querySelectorAll('[data-open]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelector('.tab[data-target="tab-cadastros"]').click();
      document.querySelector(`.subtab[data-sub="${btn.dataset.open}"]`).click();
    });
  });

  // Subtabs
  const subTabs = document.getElementById('subTabs').querySelectorAll('.subtab');
  subTabs.forEach(st=>{
    st.addEventListener('click', ()=>{
      subTabs.forEach(x=>x.classList.remove('active'));
      st.classList.add('active');
      document.querySelectorAll('#tab-cadastros > .panel[id^="cad-"]').forEach(sec=>sec.style.display='none');
      document.getElementById(st.dataset.sub).style.display = '';
    });
  });
}

/** ========= Visão Geral ========= **/
async function loadHome(){
  const box = document.getElementById('homeEstoque');
  box.innerHTML = '<div class="muted">Carregando…</div>';
  try{
    const data = await sSelect('vw_estoque_saldos_resumo', 'item_nome,lote,validade,saldo,un_medida,custo_unit');
    if (!data.length){ box.innerHTML = '<div class="empty">Sem dados.</div>'; return; }
    const top = data.slice(0,6).map(r=>`
      <tr>
        <td>${esc(r.item_nome)}</td>
        <td class="muted">${r.un_medida ?? ''}</td>
        <td>${fmtNum(r.saldo)}</td>
        <td class="muted">${r.custo_unit != null ? 'R$ '+fmtMoney(r.custo_unit) : '—'}</td>
      </tr>`).join('');
    box.innerHTML = `<table>
      <thead><tr><th>Item</th><th>UN</th><th>Saldo</th><th>Custo Unit</th></tr></thead>
      <tbody>${top}</tbody>
    </table>`;
  }catch(e){
    box.innerHTML = `<div class="t err">Erro ao carregar estoque: ${esc(e.message||e.status||e)}</div>`;
  }
}

/** ========= Cadastros: UM ========= **/
let UM_EDIT_ID = null;
function uiUM(rows){
  if (!rows.length) return '<div class="empty">Nenhuma unidade de medida cadastrada.</div>';
  return `<table>
    <thead><tr><th>Sigla</th><th>Nome</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th></th></tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td class="caps">${esc(r.sigla||'')}</td>
          <td>${esc(r.nome||'')}</td>
          <td>${esc(r.codigo||'')}</td>
          <td>${esc(r.base||'')}</td>
          <td>${fmtNum(r.fator ?? 1)}</td>
          <td>${r.ativo ? '<span class="badge ok">Ativo</span>' : '<span class="badge">Inativo</span>'}</td>
          <td><button data-edit-um="${r.id}">Editar</button></td>
        </tr>`).join('')}
    </tbody>
  </table>`;
}
async function loadUM(){
  const cont = document.getElementById('um-list');
  cont.innerHTML = '<div class="muted">Carregando…</div>';
  try{
    const rows = await sSelect('unidades_medida', 'id,nome,sigla,codigo,base,fator,ativo', { order:'nome' });
    cont.innerHTML = uiUM(rows);
    cont.querySelectorAll('[data-edit-um]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const row = rows.find(x=>x.id===btn.dataset.editUm);
        if (!row) return;
        UM_EDIT_ID = row.id;
        setVal('um-sigla', row.sigla);
        setVal('um-nome', row.nome);
        setVal('um-codigo', row.codigo);
        setVal('um-base', row.base);
        setVal('um-fator', row.fator ?? 1);
        setChecked('um-ativo', !!row.ativo);
      });
    });
  }catch(e){
    cont.innerHTML = `<div class="t err">Erro: ${esc(e.message||e.status||e)}</div>`;
  }
}
async function saveUM(){
  const payload = {
    sigla: getVal('um-sigla')?.toUpperCase().trim(),
    nome: getVal('um-nome')?.trim(),
    codigo: getVal('um-codigo')?.toLowerCase().trim(),
    base: getVal('um-base'),
    fator: Number(getVal('um-fator')||1),
    ativo: isChecked('um-ativo')
  };
  if (!payload.nome || !payload.sigla || !payload.codigo){ Toast.show('Preencha Sigla, Nome e Código.', 'warn'); return; }
  try{
    dis('#um-save', true);
    if (UM_EDIT_ID){
      await sUpdate('unidades_medida', payload, { id: UM_EDIT_ID });
      Toast.show('Unidade de medida atualizada.');
    }else{
      await sInsert('unidades_medida', [payload]);
      Toast.show('Unidade de medida criada.');
    }
    clearUM(); loadUM();
  }catch(e){ Toast.show('Erro ao salvar UM: '+(e.message||e.status||e), 'err'); }
  finally{ dis('#um-save', false); }
}
function clearUM(){
  UM_EDIT_ID = null;
  setVal('um-sigla',''); setVal('um-nome',''); setVal('um-codigo',''); setVal('um-fator','1'); setVal('um-base','g'); setChecked('um-ativo', true);
}

/** ========= Cadastros: Unidades ========= **/
let UNID_EDIT_ID = null;
function uiUnidades(rows){
  if (!rows.length) return '<div class="empty">Nenhuma unidade cadastrada.</div>';
  return `<table>
    <thead><tr><th>Nome</th><th>Ativo</th><th></th></tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${esc(r.nome||'')}</td>
          <td>${r.ativo ? '<span class="badge ok">Ativo</span>' : '<span class="badge">Inativo</span>'}</td>
          <td><button data-edit-unid="${r.id}">Editar</button></td>
        </tr>`).join('')}
    </tbody>
  </table>`;
}
async function loadUnidades(){
  const cont = document.getElementById('unid-list');
  cont.innerHTML = '<div class="muted">Carregando…</div>';
  try{
    const rows = await sSelect('unidades', 'id,nome,ativo', { order:'nome' });
    cont.innerHTML = uiUnidades(rows);
    cont.querySelectorAll('[data-edit-unid]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const row = rows.find(x=>x.id===btn.dataset.editUnid);
        if (!row) return;
        UNID_EDIT_ID = row.id;
        setVal('unid-nome', row.nome);
        setChecked('unid-ativo', !!row.ativo);
      });
    });
  }catch(e){
    cont.innerHTML = `<div class="t err">Erro: ${esc(e.message||e.status||e)}</div>`;
  }
}
async function saveUnidade(){
  const payload = { nome: getVal('unid-nome')?.trim(), ativo: isChecked('unid-ativo') };
  if (!payload.nome){ Toast.show('Informe o nome da unidade (destino).', 'warn'); return; }
  try{
    dis('#unid-save', true);
    if (UNID_EDIT_ID){
      await sUpdate('unidades', payload, { id: UNID_EDIT_ID });
      Toast.show('Unidade atualizada.');
    }else{
      await sInsert('unidades', [payload]);
      Toast.show('Unidade criada.');
    }
    clearUnidade(); loadUnidades();
  }catch(e){ Toast.show('Erro ao salvar Unidade: '+(e.message||e.status||e), 'err'); }
  finally{ dis('#unid-save', false); }
}
function clearUnidade(){ UNID_EDIT_ID=null; setVal('unid-nome',''); setChecked('unid-ativo', true); }

/** ========= Cadastros: Categorias ========= **/
let CAT_EDIT_ID = null;
function uiCategorias(rows){
  if (!rows.length) return '<div class="empty">Nenhuma categoria cadastrada.</div>';
  return `<table>
    <thead><tr><th>Nome</th><th>Tipo</th><th>Ativo</th><th></th></tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${esc(r.nome||'')}</td>
          <td class="caps">${esc(r.tipo||'')}</td>
          <td>${r.ativo ? '<span class="badge ok">Ativo</span>' : '<span class="badge">Inativo</span>'}</td>
          <td><button data-edit-cat="${r.id}">Editar</button></td>
        </tr>`).join('')}
    </tbody>
  </table>`;
}
async function loadCategorias(){
  const cont = document.getElementById('cat-list');
  cont.innerHTML = '<div class="muted">Carregando…</div>';
  try{
    const rows = await sSelect('categorias', 'id,nome,tipo,ativo', { order:'nome' });
    cont.innerHTML = uiCategorias(rows);
    cont.querySelectorAll('[data-edit-cat]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const row = rows.find(x=>x.id===btn.dataset.editCat);
        if (!row) return;
        CAT_EDIT_ID = row.id;
        setVal('cat-nome', row.nome);
        setVal('cat-tipo', row.tipo);
        setChecked('cat-ativo', !!row.ativo);
      });
    });
  }catch(e){
    cont.innerHTML = `<div class="t err">Erro: ${esc(e.message||e.status||e)}</div>`;
  }
}
async function saveCategoria(){
  const payload = {
    nome: getVal('cat-nome')?.trim(),
    tipo: getVal('cat-tipo'),
    ativo: isChecked('cat-ativo')
  };
  if (!payload.nome){ Toast.show('Informe o nome da categoria.', 'warn'); return; }
  try{
    dis('#cat-save', true);
    if (CAT_EDIT_ID){
      await sUpdate('categorias', payload, { id: CAT_EDIT_ID });
      Toast.show('Categoria atualizada.');
    }else{
      await sInsert('categorias', [payload]);
      Toast.show('Categoria criada.');
    }
    clearCategoria(); loadCategorias();
  }catch(e){ Toast.show('Erro ao salvar Categoria: '+(e.message||e.status||e), 'err'); }
  finally{ dis('#cat-save', false); }
}
function clearCategoria(){ CAT_EDIT_ID=null; setVal('cat-nome',''); setVal('cat-tipo','INGREDIENTE'); setChecked('cat-ativo', true); }

/** ========= Cadastros: Tipos de Item ========= **/
let TIPO_EDIT_ID = null;
function uiTipos(rows){
  if (!rows.length) return '<div class="empty">Nenhum tipo de item cadastrado.</div>';
  return `<table>
    <thead><tr><th>Nome</th><th>Ativo</th><th></th></tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td class="caps">${esc(r.nome||'')}</td>
          <td>${r.ativo ? '<span class="badge ok">Ativo</span>' : '<span class="badge">Inativo</span>'}</td>
          <td><button data-edit-tipo="${r.id}">Editar</button></td>
        </tr>`).join('')}
    </tbody>
  </table>`;
}
async function loadTipos(){
  const cont = document.getElementById('tipo-list');
  cont.innerHTML = '<div class="muted">Carregando…</div>';
  try{
    const rows = await sSelect('item_tipos', 'id,nome,ativo', { order:'nome' });
    cont.innerHTML = uiTipos(rows);
    cont.querySelectorAll('[data-edit-tipo]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const row = rows.find(x=>x.id===btn.dataset.editTipo);
        if (!row) return;
        TIPO_EDIT_ID = row.id;
        setVal('tipo-nome', row.nome);
        setChecked('tipo-ativo', !!row.ativo);
      });
    });
  }catch(e){
    cont.innerHTML = `<div class="t err">Erro: ${esc(e.message||e.status||e)}</div>`;
  }
}
async function saveTipo(){
  const payload = { nome: getVal('tipo-nome')?.trim(), ativo: isChecked('tipo-ativo') };
  if (!payload.nome){ Toast.show('Informe o nome do tipo (ex.: ING, REC).', 'warn'); return; }
  try{
    dis('#tipo-save', true);
    if (TIPO_EDIT_ID){
      await sUpdate('item_tipos', payload, { id: TIPO_EDIT_ID });
      Toast.show('Tipo de item atualizado.');
    }else{
      await sInsert('item_tipos', [payload]);
      Toast.show('Tipo de item criado.');
    }
    clearTipo(); loadTipos();
  }catch(e){ Toast.show('Erro ao salvar Tipo de Item: '+(e.message||e.status||e), 'err'); }
  finally{ dis('#tipo-save', false); }
}
function clearTipo(){ TIPO_EDIT_ID=null; setVal('tipo-nome',''); setChecked('tipo-ativo', true); }

/** ========= Estoque ========= **/
function uiEstoque(rows){
  if (!rows.length) return '<div class="empty">Sem movimentações consolidadas.</div>';
  return `<table>
    <thead>
      <tr><th>Item</th><th>Lote</th><th>Validade</th><th>Saldo</th><th>UN</th><th>Custo Unit</th></tr>
    </thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${esc(r.item_nome||'')}</td>
          <td>${esc(r.lote ?? '—')}</td>
          <td>${r.validade ? esc(r.validade) : '—'}</td>
          <td>${fmtNum(r.saldo)}</td>
          <td>${esc(r.un_medida||'')}</td>
          <td>${r.custo_unit != null ? 'R$ '+fmtMoney(r.custo_unit) : '—'}</td>
        </tr>`).join('')}
    </tbody>
  </table>`;
}
async function loadEstoque(){
  const cont = document.getElementById('stk-list');
  cont.innerHTML = '<div class="muted">Carregando…</div>';
  try{
    const all = await sSelect('vw_estoque_saldos_resumo', 'item_nome,lote,validade,saldo,un_medida,custo_unit');
    const q = getVal('stk-q')?.toLowerCase().trim();
    const rows = q ? all.filter(r => (r.item_nome||'').toLowerCase().includes(q)) : all;
    cont.innerHTML = uiEstoque(rows);
  }catch(e){
    cont.innerHTML = `<div class="t err">Erro ao carregar estoque: ${esc(e.message||e.status||e)}</div>`;
  }
}

/** ========= Utils ========= **/
function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function getVal(id){ return document.getElementById(id)?.value ?? ''; }
function setVal(id,v){ const el=document.getElementById(id); if(el) el.value = v ?? ''; }
function isChecked(id){ return !!document.getElementById(id)?.checked; }
function setChecked(id, v){ const el=document.getElementById(id); if(el) el.checked = !!v; }
function dis(sel, on){ const el = document.querySelector(sel); if(el) el.disabled = !!on; }
function fmtNum(n){ const v = Number(n ?? 0); return Number.isNaN(v) ? '0' : v.toLocaleString('pt-BR'); }
function fmtMoney(n){ const v = Number(n ?? 0); return Number.isNaN(v) ? '0,00' : v.toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 }); }

/** ========= Boot ========= **/
function wireActions(){
  document.getElementById('um-save').addEventListener('click', saveUM);
  document.getElementById('um-clear').addEventListener('click', clearUM);
  document.getElementById('unid-save').addEventListener('click', saveUnidade);
  document.getElementById('unid-clear').addEventListener('click', clearUnidade);
  document.getElementById('cat-save').addEventListener('click', saveCategoria);
  document.getElementById('cat-clear').addEventListener('click', clearCategoria);
  document.getElementById('tipo-save').addEventListener('click', saveTipo);
  document.getElementById('tipo-clear').addEventListener('click', clearTipo);
  document.getElementById('stk-reload').addEventListener('click', loadEstoque);
  document.getElementById('stk-q').addEventListener('input', ()=>loadEstoque());
}
async function boot(){
  setEnvPill();
  wireTabs();
  wireActions();
  // Carregar primeiras visões
  await Promise.allSettled([ loadHome(), loadUM(), loadUnidades(), loadCategorias(), loadTipos() ]);
  await loadEstoque();
  Toast.show('Pronto. Conectado ao Supabase.', 'ok');
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
