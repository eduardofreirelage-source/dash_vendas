<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa de Produção • Cadastros & Estoque</title>
  <!-- Favicon embutido (evita 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23741624'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='36' fill='white'%3EMP%3C/text%3E%3C/svg%3E">
  <!-- Pico.css: leve, bonito, sem dependências -->
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">
  <style>
    :root{--cor: #741624;}
    header{border-bottom:1px solid #eee;margin-bottom:1rem}
    .tabs{display:flex; gap:.5rem; border-bottom:1px solid #eee; margin:.25rem 0 1rem 0; padding-bottom:.25rem; overflow:auto}
    .tabs button{background:transparent; border:none; padding:.5rem .75rem; border-radius:.5rem; font-weight:600; color:#666}
    .tabs button.active{background:var(--cor); color:#fff}
    .subtabs{display:flex; gap:.25rem; margin:.5rem 0 1rem 0; overflow:auto}
    .subtabs button{background:#f5f6f7; border:1px solid #e5e7eb; padding:.4rem .6rem; border-radius:.5rem; font-weight:600}
    .subtabs button.active{background:#111; color:#fff; border-color:#111}
    .card{border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem; background:#fff}
    .muted{color:#6b7280}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:.4rem; font-size:.75rem; background:#eef2ff}
    .ok{color:#16a34a}.warn{color:#d97706}.err{color:#dc2626}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:.75rem}
    .grid-3{display:grid; grid-template-columns: repeat(3,1fr); gap:.75rem}
    .grid-4{display:grid; grid-template-columns: repeat(4,1fr); gap:.75rem}
    .table-wrapper{overflow:auto}
    table{white-space:nowrap}
    .row-actions{display:flex; gap:.4rem; justify-content:flex-end}
    .ghost{opacity:.5; pointer-events:none}
    .small{font-size:.875rem}
    .right{float:right}
    .danger{background:#fee2e2; border-color:#fecaca}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; background:#0b1020; color:#f6f7fb; border-radius:.5rem; padding:.75rem; overflow:auto}
    .sticky-actions{position:sticky; bottom:0; background:#fff; padding-top:.5rem; border-top:1px solid #eee}
  </style>
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
<header class="container">
  <nav>
    <ul>
      <li><strong>Mapa de Produção</strong> <span class="badge">v1 (cadastros estáveis)</span></li>
    </ul>
    <ul>
      <li><details role="list">
        <summary>Conexão</summary>
        <form id="cfgForm" class="grid-1" onsubmit="saveConfig(event)" style="min-width:300px">
          <label>SUPABASE URL
            <input id="cfgUrl" type="url" placeholder="https://XYZ.supabase.co">
          </label>
          <label>Anon Key
            <input id="cfgKey" type="text" placeholder="ey...">
          </label>
          <small class="muted">Dica: salve aqui e recarregue. Ou passe via querystring <code>?sbUrl=...&sbKey=...</code></small>
          <div class="row-actions">
            <button type="submit">Salvar</button>
          </div>
        </form>
      </details></li>
    </ul>
  </nav>
</header>

<main class="container">

  <!-- Abas principais -->
  <div class="tabs" id="mainTabs">
    <button data-tab="producao" class="active">Produção</button>
    <button data-tab="estoque">Estoque</button>
    <button data-tab="debug">Debug</button>
  </div>

  <!-- Produção -->
  <section id="tab-producao">
    <div class="card">
      <h3>Cadastros</h3>

      <!-- Sub-abas -->
      <div class="subtabs" id="cadSubTabs">
        <button data-sub="um" class="active">Unidade de Medida</button>
        <button data-sub="unidades">Unidades</button>
        <button data-sub="categorias">Categorias</button>
        <button data-sub="tipos">Tipos de Item</button>
      </div>

      <!-- UM -->
      <div id="sub-um">
        <article class="card">
          <h5>Nova UM</h5>
          <div class="grid-4">
            <label>Nome
              <input id="umNome" placeholder="Quilograma">
            </label>
            <label>Sigla
              <input id="umSigla" placeholder="KG">
            </label>
            <label>Código
              <input id="umCodigo" placeholder="kg">
            </label>
            <label>Base
              <select id="umBase">
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="un">un</option>
              </select>
            </label>
          </div>
          <div class="grid-4" style="margin-top:.5rem">
            <label>Fator (p/ base)
              <input id="umFator" type="number" step="0.000001" value="1">
            </label>
            <label>Ativo
              <select id="umAtivo">
                <option value="true" selected>Sim</option>
                <option value="false">Não</option>
              </select>
            </label>
          </div>
          <div class="row-actions sticky-actions">
            <button onclick="saveUM()">Salvar</button>
            <button class="secondary" onclick="clearUM()">Cancelar</button>
          </div>
        </article>

        <div class="table-wrapper card" style="margin-top:1rem">
          <h5>Unidades de Medida</h5>
          <table>
            <thead>
              <tr>
                <th>Nome</th><th>Sigla</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="umRows"><tr><td colspan="7" class="muted">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Unidades -->
      <div id="sub-unidades" class="hidden">
        <article class="card">
          <h5>Nova Unidade</h5>
          <div class="grid-3">
            <label>Nome
              <input id="uNome" placeholder="Depósito Principal">
            </label>
            <label>Ativo
              <select id="uAtivo">
                <option value="true" selected>Sim</option>
                <option value="false">Não</option>
              </select>
            </label>
          </div>
          <div class="row-actions sticky-actions">
            <button onclick="saveUnidade()">Salvar</button>
            <button class="secondary" onclick="clearUnidade()">Cancelar</button>
          </div>
        </article>

        <div class="table-wrapper card" style="margin-top:1rem">
          <h5>Unidades</h5>
          <table>
            <thead>
            <tr><th>Nome</th><th>Ativo</th><th class="right">Ações</th></tr>
            </thead>
            <tbody id="uRows"><tr><td colspan="3" class="muted">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Categorias -->
      <div id="sub-categorias" class="hidden">
        <article class="card">
          <h5>Nova Categoria</h5>
          <div class="grid-3">
            <label>Nome
              <input id="cNome" placeholder="Massas">
            </label>
            <label>Tipo (opcional)
              <input id="cTipo" placeholder="PRATO/ING/COMP..." />
              <small class="muted">Se sua tabela <code>categorias</code> não tiver coluna <code>tipo</code>, eu ignoro esse campo automaticamente.</small>
            </label>
            <label>Ativo
              <select id="cAtivo">
                <option value="true" selected>Sim</option>
                <option value="false">Não</option>
              </select>
            </label>
          </div>
          <div class="row-actions sticky-actions">
            <button onclick="saveCategoria()">Salvar</button>
            <button class="secondary" onclick="clearCategoria()">Cancelar</button>
          </div>
        </article>

        <div class="table-wrapper card" style="margin-top:1rem">
          <h5>Categorias</h5>
          <table>
            <thead>
            <tr><th>Nome</th><th>Tipo</th><th>Ativo</th><th class="right">Ações</th></tr>
            </thead>
            <tbody id="cRows"><tr><td colspan="4" class="muted">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Tipos de Item -->
      <div id="sub-tipos" class="hidden">
        <article class="card">
          <h5>Novo Tipo de Item</h5>
          <div class="grid-3">
            <label>Código
              <input id="tCodigo" placeholder="PRATO / ING / COMP">
            </label>
            <label>Nome
              <input id="tNome" placeholder="Prato / Ingrediente / Componente">
            </label>
            <label>Ativo
              <select id="tAtivo">
                <option value="true" selected>Sim</option>
                <option value="false">Não</option>
              </select>
            </label>
          </div>
          <div class="row-actions sticky-actions">
            <button onclick="saveTipo()">Salvar</button>
            <button class="secondary" onclick="clearTipo()">Cancelar</button>
          </div>
        </article>

        <div class="table-wrapper card" style="margin-top:1rem">
          <h5>Tipos de Item</h5>
          <table>
            <thead>
            <tr><th>Código</th><th>Nome</th><th>Ativo</th><th class="right">Ações</th></tr>
            </thead>
            <tbody id="tRows"><tr><td colspan="4" class="muted">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>

  <!-- Estoque (visão/resumo - carrega se as views existirem) -->
  <section id="tab-estoque" class="hidden">
    <div class="card">
      <h3>Visão de Estoque</h3>
      <div id="estoquePainel" class="muted">Carregando...</div>
      <div id="estoqueTabela" class="table-wrapper card hidden" style="margin-top:1rem">
        <table>
          <thead>
          <tr><th>Item</th><th>Lote</th><th>Validade</th><th>Saldo</th><th>UM</th><th>Custo</th></tr>
          </thead>
          <tbody id="estoqueRows"></tbody>
        </table>
      </div>
      <article id="viewMissing" class="card danger hidden">
        <strong>Views ausentes</strong>
        <p>Não encontrei <code>vw_estoque_saldos</code> e/ou <code>vw_estoque_saldos_resumo</code>. Crie-as com os exemplos abaixo (ou adapte às suas tabelas):</p>
        <pre class="code" id="sqlViews"></pre>
      </article>
    </div>
  </section>

  <!-- Debug / RLS -->
  <section id="tab-debug" class="hidden">
    <div class="card">
      <h3>Diagnóstico</h3>
      <div id="diag"></div>

      <article id="rlsBox" class="card danger hidden" style="margin-top:1rem">
        <h4>Políticas RLS necessárias</h4>
        <p>Seu banco respondeu <code>401/403</code> numa operação. Copie/cole as políticas abaixo para liberar o CRUD do usuário anônimo <em>(apenas para este ambiente — ajuste para produção)</em>:</p>
        <details open>
          <summary><strong>unidades_medida</strong></summary>
          <pre class="code" id="sqlRlsUM"></pre>
        </details>
        <details open>
          <summary><strong>unidades</strong></summary>
          <pre class="code" id="sqlRlsUnidades"></pre>
        </details>
        <details open>
          <summary><strong>categorias</strong></summary>
          <pre class="code" id="sqlRlsCategorias"></pre>
        </details>
        <details open>
          <summary><strong>tipos_item</strong></summary>
          <pre class="code" id="sqlRlsTipos"></pre>
        </details>
      </article>
    </div>
  </section>

</main>

<script>
/**
 * ========= CONFIG =========
 * Preencha aqui ou use o menu “Conexão” no topo (salva no localStorage) ou querystring ?sbUrl=...&sbKey=...
 */
let SUPABASE_URL  = "";  // ex.: "https://rqeagimulvgfecvuzubk.supabase.co"
let SUPABASE_ANON = "";  // sua anon key

// carrega config do localStorage / querystring (prioridade)
(function initConfig(){
  const qs = new URLSearchParams(location.search);
  const L = localStorage;
  const url = qs.get("sbUrl") || L.getItem("sbUrl") || SUPABASE_URL;
  const key = qs.get("sbKey") || L.getItem("sbKey") || SUPABASE_ANON;
  if (url) SUPABASE_URL  = url;
  if (key) SUPABASE_ANON = key;
  document.getElementById("cfgUrl").value = SUPABASE_URL || "";
  document.getElementById("cfgKey").value = SUPABASE_ANON || "";
})();
function saveConfig(e){
  e.preventDefault();
  const url = document.getElementById("cfgUrl").value.trim();
  const key = document.getElementById("cfgKey").value.trim();
  localStorage.setItem("sbUrl", url);
  localStorage.setItem("sbKey", key);
  alert("Config salva. Recarregando…");
  location.reload();
}

// cliente supabase
let supa = null;
function supaClient(){
  if (!SUPABASE_URL || !SUPABASE_ANON) {
    alert("Configure SUPABASE URL e Anon Key (menu Conexão).");
    throw new Error("Faltou config");
  }
  if (!supa) supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {auth: {persistSession:false}});
  return supa;
}

/** Helpers REST tolerantes a schema (select='*' e order no cliente) */
async function restGet(table, {limit=1000} = {}){
  const url = `${SUPABASE_URL}/rest/v1/${table}?select=*&limit=${limit}`;
  const res = await fetch(url, {headers: {apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}`}});
  if (!res.ok){
    const msg = await safeMsg(res);
    throw new Error(`[${table}] ${msg}`);
  }
  return res.json();
}
async function restInsert(table, rows){
  const url = `${SUPABASE_URL}/rest/v1/${table}?select=*`;
  const res = await fetch(url, {
    method:"POST",
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: `Bearer ${SUPABASE_ANON}`,
      "Content-Type":"application/json",
      Prefer:"return=representation"
    },
    body: JSON.stringify(Array.isArray(rows)? rows : [rows])
  });
  if (!res.ok){
    await handleRlsIfNeeded(table, res);
    const msg = await safeMsg(res);
    throw new Error(`[${table}] ${msg}`);
  }
  return res.json();
}
async function restUpdate(table, match, patch){
  const url = `${SUPABASE_URL}/rest/v1/${table}?select=*` + buildMatch(match);
  const res = await fetch(url, {
    method:"PATCH",
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: `Bearer ${SUPABASE_ANON}`,
      "Content-Type":"application/json",
      Prefer:"return=representation"
    },
    body: JSON.stringify(patch)
  });
  if (!res.ok){
    await handleRlsIfNeeded(table, res);
    const msg = await safeMsg(res);
    throw new Error(`[${table}] ${msg}`);
  }
  return res.json();
}
async function restDelete(table, match){
  const url = `${SUPABASE_URL}/rest/v1/${table}` + buildMatch(match);
  const res = await fetch(url, {
    method:"DELETE",
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: `Bearer ${SUPABASE_ANON}`,
      Prefer:"return=representation"
    }
  });
  if (!res.ok){
    await handleRlsIfNeeded(table, res);
    const msg = await safeMsg(res);
    throw new Error(`[${table}] ${msg}`);
  }
  return res.json();
}
function buildMatch(match){
  if (!match) return "";
  const qs = Object.entries(match).map(([k,v])=> `${encodeURIComponent(k)}=eq.${encodeURIComponent(v)}`).join("&");
  return "?" + qs;
}
async function safeMsg(res){
  let msg = `HTTP ${res.status}`;
  try{ const j = await res.json(); if (j?.message) msg += `: ${j.message}` }catch{}
  return msg;
}

/** Se der 401/403, exibimos as RLS sugeridas */
async function handleRlsIfNeeded(table, res){
  if (res.status===401 || res.status===403){
    document.getElementById("rlsBox").classList.remove("hidden");
    // SQLs
    const anon = 'anon'; // role padrão pública
    const sqlTemplate = (tbl) => `
alter table ${tbl} enable row level security;

drop policy if exists "${tbl}_sel" on ${tbl};
drop policy if exists "${tbl}_ins" on ${tbl};
drop policy if exists "${tbl}_upd" on ${tbl};
drop policy if exists "${tbl}_del" on ${tbl};

create policy "${tbl}_sel" on ${tbl}
for select
to public
using (true);

create policy "${tbl}_ins" on ${tbl}
for insert
to ${anon}
with check (true);

create policy "${tbl}_upd" on ${tbl}
for update
to ${anon}
using (true)
with check (true);

create policy "${tbl}_del" on ${tbl}
for delete
to ${anon}
using (true);
`.trim();

    document.getElementById("sqlRlsUM").textContent = sqlTemplate("public.unidades_medida");
    document.getElementById("sqlRlsUnidades").textContent = sqlTemplate("public.unidades");
    document.getElementById("sqlRlsCategorias").textContent = sqlTemplate("public.categorias");
    document.getElementById("sqlRlsTipos").textContent = sqlTemplate("public.tipos_item");
  }
}

/** ========= Navegação ========= */
function showTab(id){
  ["producao","estoque","debug"].forEach(t=>{
    document.getElementById(`tab-${t}`).classList.toggle("hidden", t!==id);
    document.querySelector(`#mainTabs button[data-tab="${t}"]`).classList.toggle("active", t===id);
  });
}
document.getElementById("mainTabs").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-tab]"); if(!btn) return;
  showTab(btn.dataset.tab);
  if (btn.dataset.tab==="estoque") bootEstoque();
});
function showSub(id){
  ["um","unidades","categorias","tipos"].forEach(s=>{
    document.getElementById(`sub-${s}`).classList.toggle("hidden", s!==id);
    document.querySelector(`#cadSubTabs button[data-sub="${s}"]`).classList.toggle("active", s===id);
  });
}
document.getElementById("cadSubTabs").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-sub]"); if(!btn) return;
  showSub(btn.dataset.sub);
});

/** ========= Cadastros ========= */
// UM
async function loadUM(){
  const rows = await restGet("unidades_medida");
  rows.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));
  const tb = document.getElementById("umRows");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.nome)}</td>
      <td>${esc(r.sigla)}</td>
      <td>${esc(r.codigo)}</td>
      <td>${esc(r.base)}</td>
      <td>${fmtNum(r.fator)}</td>
      <td>${r.ativo? "Sim":"Não"}</td>
      <td>
        <div class="row-actions">
          <button class="secondary small" onclick='editUM(${JSON.stringify(r)})'>Editar</button>
          <button class="secondary small" onclick='delUM("${r.id}")'>Excluir</button>
        </div>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="7" class="muted">Vazio</td></tr>`;
}
function clearUM(){
  ["umNome","umSigla","umCodigo","umFator"].forEach(id=> document.getElementById(id).value="");
  document.getElementById("umBase").value="g";
  document.getElementById("umAtivo").value="true";
  delete window.__umEditingId;
}
function editUM(r){
  window.__umEditingId = r.id;
  document.getElementById("umNome").value   = r.nome||"";
  document.getElementById("umSigla").value  = r.sigla||"";
  document.getElementById("umCodigo").value = r.codigo||"";
  document.getElementById("umBase").value   = r.base||"g";
  document.getElementById("umFator").value  = r.fator||1;
  document.getElementById("umAtivo").value  = String(!!r.ativo);
}
async function saveUM(){
  const nome = val("umNome"), sigla = val("umSigla");
  if (!nome || !sigla) return alert("Nome e Sigla são obrigatórios");
  const row = {
    nome,
    sigla,
    codigo: (val("umCodigo")||sigla||"").toLowerCase(),
    base: (val("umBase")||"").toLowerCase(),
    fator: Number(val("umFator")||1),
    ativo: val("umAtivo")==="true"
  };
  try{
    if (window.__umEditingId) {
      await restUpdate("unidades_medida", {id: window.__umEditingId}, row);
    } else {
      await restInsert("unidades_medida", row);
    }
    clearUM(); await loadUM();
  }catch(err){ alert("Erro ao salvar UM: " + err.message); }
}
async function delUM(id){
  if (!confirm("Excluir esta UM?")) return;
  try{ await restDelete("unidades_medida", {id}); await loadUM(); }
  catch(err){ alert("Erro ao excluir UM: " + err.message); }
}

// Unidades
async function loadUnidades(){
  const rows = await restGet("unidades");
  rows.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));
  const tb = document.getElementById("uRows");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.nome)}</td>
      <td>${r.ativo? "Sim":"Não"}</td>
      <td>
        <div class="row-actions">
          <button class="secondary small" onclick='editUnidade(${JSON.stringify(r)})'>Editar</button>
          <button class="secondary small" onclick='delUnidade("${r.id}")'>Excluir</button>
        </div>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="3" class="muted">Vazio</td></tr>`;
}
function clearUnidade(){ delete window.__uEditingId; document.getElementById("uNome").value=""; document.getElementById("uAtivo").value="true"; }
function editUnidade(r){ window.__uEditingId = r.id; document.getElementById("uNome").value = r.nome||""; document.getElementById("uAtivo").value= String(!!r.ativo); }
async function saveUnidade(){
  const row = {nome: val("uNome"), ativo: val("uAtivo")==="true"};
  if (!row.nome) return alert("Informe o nome da Unidade");
  try{
    if (window.__uEditingId) await restUpdate("unidades", {id: window.__uEditingId}, row);
    else await restInsert("unidades", row);
    clearUnidade(); await loadUnidades();
  }catch(err){ alert("Erro ao salvar Unidade: " + err.message); }
}
async function delUnidade(id){
  if (!confirm("Excluir esta Unidade?")) return;
  try{ await restDelete("unidades", {id}); await loadUnidades(); }
  catch(err){ alert("Erro ao excluir Unidade: " + err.message); }
}

// Categorias (coluna 'tipo' é opcional)
let categoriasTemTipo = true;
async function loadCategorias(){
  const rows = await restGet("categorias").catch(e=>{
    // se a tabela existe mas não tem 'tipo', o GET com select=* funciona;
    // o problema acontecia quando ORDER pedia 'tipo'. Aqui não pedimos ORDER na API.
    throw e;
  });
  // detectar se tem a coluna tipo
  categoriasTemTipo = rows.length ? Object.prototype.hasOwnProperty.call(rows[0], "tipo") : categoriasTemTipo;
  rows.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));
  const tb = document.getElementById("cRows");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.nome)}</td>
      <td>${esc(categoriasTemTipo? r.tipo : "")}</td>
      <td>${r.ativo? "Sim":"Não"}</td>
      <td>
        <div class="row-actions">
          <button class="secondary small" onclick='editCategoria(${JSON.stringify(r)})'>Editar</button>
          <button class="secondary small" onclick='delCategoria("${r.id}")'>Excluir</button>
        </div>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="muted">Vazio</td></tr>`;
}
function clearCategoria(){ delete window.__cEditingId; ["cNome","cTipo"].forEach(id=> document.getElementById(id).value=""); document.getElementById("cAtivo").value="true"; }
function editCategoria(r){ window.__cEditingId=r.id; document.getElementById("cNome").value=r.nome||""; document.getElementById("cTipo").value=r.tipo||""; document.getElementById("cAtivo").value= String(!!r.ativo); }
async function saveCategoria(){
  const row = {nome: val("cNome"), ativo: val("cAtivo")==="true"};
  if (categoriasTemTipo && val("cTipo")) row.tipo = val("cTipo");
  if (!row.nome) return alert("Informe o nome da Categoria");
  try{
    if (window.__cEditingId) await restUpdate("categorias", {id: window.__cEditingId}, row);
    else await restInsert("categorias", row);
    clearCategoria(); await loadCategorias();
  }catch(err){ alert("Erro ao salvar Categoria: " + err.message); }
}
async function delCategoria(id){
  if (!confirm("Excluir esta Categoria?")) return;
  try{ await restDelete("categorias", {id}); await loadCategorias(); }
  catch(err){ alert("Erro ao excluir Categoria: " + err.message); }
}

// Tipos de Item
async function loadTipos(){
  // nome sugerido: tipos_item (ajuste se o seu for diferente)
  const rows = await restGet("tipos_item");
  rows.sort((a,b)=> (a.codigo||"").localeCompare(b.codigo||""));
  const tb = document.getElementById("tRows");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${esc(r.codigo)}</td>
      <td>${esc(r.nome)}</td>
      <td>${r.ativo? "Sim":"Não"}</td>
      <td>
        <div class="row-actions">
          <button class="secondary small" onclick='editTipo(${JSON.stringify(r)})'>Editar</button>
          <button class="secondary small" onclick='delTipo("${r.id}")'>Excluir</button>
        </div>
      </td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="muted">Vazio</td></tr>`;
}
function clearTipo(){ delete window.__tEditingId; ["tCodigo","tNome"].forEach(id=> document.getElementById(id).value=""); document.getElementById("tAtivo").value="true"; }
function editTipo(r){ window.__tEditingId=r.id; document.getElementById("tCodigo").value=r.codigo||""; document.getElementById("tNome").value=r.nome||""; document.getElementById("tAtivo").value= String(!!r.ativo); }
async function saveTipo(){
  const row = {codigo: val("tCodigo"), nome: val("tNome"), ativo: val("tAtivo")==="true"};
  if (!row.codigo || !row.nome) return alert("Informe Código e Nome");
  try{
    if (window.__tEditingId) await restUpdate("tipos_item", {id: window.__tEditingId}, row);
    else await restInsert("tipos_item", row);
    clearTipo(); await loadTipos();
  }catch(err){ alert("Erro ao salvar Tipo de Item: " + err.message); }
}
async function delTipo(id){
  if (!confirm("Excluir este Tipo?")) return;
  try{ await restDelete("tipos_item", {id}); await loadTipos(); }
  catch(err){ alert("Erro ao excluir Tipo: " + err.message); }
}

/** ========= Estoque ========= */
let estoqueBooted = false;
async function bootEstoque(){
  if (estoqueBooted) return;
  estoqueBooted = true;
  const panel = document.getElementById("estoquePainel");
  panel.textContent = "Consultando views…";
  try{
    // Tenta a resumo; se 404, cai no catch e mostra SQL
    const resumo = await fetch(`${SUPABASE_URL}/rest/v1/vw_estoque_saldos_resumo?select=*`, {
      headers: {apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}`}
    });
    if (!resumo.ok){
      const msg = await safeMsg(resumo);
      if (resumo.status===404 || /does not exist/i.test(msg)){
        showMissingViews();
        panel.textContent = "Views ausentes.";
        return;
      } else {
        throw new Error(msg);
      }
    }
    const data = await resumo.json();
    if (!data.length){
      panel.textContent = "Sem dados de estoque.";
    } else {
      panel.textContent = "";
      document.getElementById("estoqueTabela").classList.remove("hidden");
      const tb = document.getElementById("estoqueRows");
      tb.innerHTML = data.map(r=>`
        <tr>
          <td>${esc(r.item_nome||r.item_id||"(item)")}</td>
          <td>${esc(r.lote ?? "")}</td>
          <td>${esc(r.validade ?? "")}</td>
          <td>${fmtNum(r.saldo)}</td>
          <td>${esc(r.un_medida)}</td>
          <td>${fmtNum(r.custo_unit)}</td>
        </tr>
      `).join("");
    }
  }catch(err){
    panel.innerHTML = `<span class="err">Erro: ${esc(err.message)}</span>`;
  }
}
function showMissingViews(){
  document.getElementById("viewMissing").classList.remove("hidden");
  const sql = `
-- Exemplo de view de saldos (adapte aos seus nomes)
create or replace view public.vw_estoque_saldos as
select
  m.item_tipo,
  m.item_id,
  m.un_medida,
  m.lote,
  m.validade,
  sum(case when m.tipo in ('ENTRADA','TRANSFER_ENTRADA','BENEF_ENTRADA','AJUSTE_POSITIVO','INVENTARIO') then m.qtd
           when m.tipo in ('SAIDA','TRANSFER_SAIDA','BENEF_SAIDA','AJUSTE_NEGATIVO') then -m.qtd
           else 0 end) as saldo,
  avg(nullif(m.custo_unit,0)) as custo_unit
from public.mov_estoque m
group by 1,2,3,4,5;

create or replace view public.vw_estoque_saldos_resumo as
select
  coalesce(i.nome,'(item)') as item_nome,
  s.*
from public.vw_estoque_saldos s
left join public.ingredientes i on i.id = s.item_id and s.item_tipo='ING';
`;
  document.getElementById("sqlViews").textContent = sql.trim();
}

/** ========= Util ========= */
function val(id){ return document.getElementById(id).value.trim(); }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function fmtNum(n){ const x = Number(n); return isFinite(x)? x.toString() : ""; }

// boot
async function boot(){
  // conexões
  try{ supaClient(); }catch{ return; }

  // abas default
  showTab("producao"); showSub("um");

  // carregamentos
  const diag = document.getElementById("diag");
  diag.innerHTML = `<div class="muted small">SB URL: ${esc(SUPABASE_URL)}</div>`;

  try{ await loadUM(); }catch(e){ alert(e.message); }
  try{ await loadUnidades(); }catch(e){ alert(e.message); }
  try{ await loadCategorias(); }catch(e){ alert(e.message); }
  try{ await loadTipos(); }catch(e){ alert(e.message); }
}
document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
