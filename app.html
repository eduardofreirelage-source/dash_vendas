<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mapa de Produção — v2.8</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    /* ===== Design Tokens (do dash_vendas) ===== */
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark: #065f46; --wine-dark: #881337;
      --radius:12px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:22px} h2{font-size:18px} h3{font-size:16px}

    /* ===== Layout Principal (do dash_vendas) ===== */
    html, body {
      height: 100vh;
      overflow: hidden; /* Impede a rolagem na página principal */
    }
    body {
      display: flex;
      flex-direction: column;
    }
    .main{
      display: flex;
      flex-direction: column;
      height: 100%;
      flex: 1;
      min-height: 0;
    }
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:var(--wine);display:grid;place-items:center;color:#fff;font-weight:700}
    .tabs{display:flex;gap:6px;border:0;background:transparent}
    .tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;font-size:14px;color:#334155;cursor:pointer;border-radius:8px;position:relative}
    .tabs button.active{background:transparent;color:var(--wine)} .tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--wine)}
    .status-bar { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--muted); }

    .content-wrap{
      max-width:1280px;
      margin:0 auto;
      padding:18px 16px;
      flex: 1; /* Ocupa o espaço restante */
      min-height: 0; /* Essencial para o flexbox funcionar corretamente */
      width: 100%;
    }
    .section{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);
      width: 100%;
      height: 100%; /* Ocupa 100% do pai (.tab-content) */
      overflow-y: auto;
    }
    #section-cadastros, #section-estoque {
      display: flex;
      flex-direction: column;
      overflow-y: hidden; /* A rolagem será gerenciada pela sub-página */
    }
    .tab-content{
      display:none;
      height: 100%; /* Garante que o conteúdo da aba ocupe todo o espaço do content-wrap */
    }
    .tab-content.active{display:block}

    /* ===== Sub-Navegação (para Cadastros) ===== */
    .subtabs{display:flex;gap:4px;border-bottom:1px solid var(--line);margin-bottom:16px;padding-bottom:10px; flex-wrap: wrap;}
    .subtabs button{padding:7px 12px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;font-size:14px;color:#475569;cursor:pointer;position: relative;}
    .subtabs button:hover{background:#f8fafc;color: var(--wine-dark);}
    .subtabs button.active{background:transparent;border-color:transparent;color:var(--wine); font-weight: 700;}
    .subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-11px;height:3px;border-radius:2px;background:var(--wine)}
    .subpage{display:none}
    .subpage.active{
      display:block; 
      animation:fadeIn .3s;
      /* Força a sub-página a ocupar o espaço disponível e ter sua própria rolagem */
      flex-grow: 1;
      overflow-y: auto;
      min-height: 0;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* ===== Componentes (fusão de app e dash) ===== */
    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(123,30,58,.25)}
    select[multiple]{height:120px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px; white-space: nowrap;}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.small{padding:7px 12px;font-size:13px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .right{display:flex;justify-content:flex-end;align-items:center;gap:8px}

    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-5{grid-template-columns:repeat(5, 1fr)}


    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 12px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:500;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:var(--wine-dark)}
    .pill.warn{border-color:#fde68a;background:#fefce8;color:#a16207;}

    
    .hint{color:#64748b;font-size:12px;margin-top:4px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;vertical-align:middle;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:var(--muted)}
    tbody tr:hover{background:#fafafb}
    tbody tr:last-child td{border-bottom:0}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .nowrap{white-space:nowrap}
    .soft{color:var(--muted)}

    details.dash{border:1px dashed #cbd5e1;padding:14px;border-radius:12px;background:#fafbff}
    summary{cursor:pointer;font-weight:600}

    #qr-video { border: 1px solid var(--line); border-radius: var(--radius); width: 100%; max-width: 400px; display: none; }

    /* Estilos para Aba de Estoque Movimentar */
    .mov-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px;}
    .mov-actions .btn { padding: 20px; font-size: 16px; font-weight: 700; flex-direction: column; height: 100px;}
    #mov-form-container { border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; display: none; }

    .filters-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 12px; background-color: var(--bg); border-radius: var(--radius); margin-bottom: 16px; }

    @media (max-width:1020px){.cols-2,.cols-3,.cols-4,.cols-5{grid-template-columns:1fr}}
  </style>
</head>
<body>
<main class="main">
  <div class="top">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1 style="font-size:18px; margin:0; line-height:1.2">Mapa de Produção</h1>
        <div class="hint" style="margin:0">Ficha técnica, previsão e compras</div>
      </div>
    </div>
    <nav class="tabs" id="main-tabs">
      <button data-tab="cadastros" class="active">Cadastros</button>
      <button data-tab="producao">Produção</button>
      <button data-tab="compras">Compras</button>
      <button data-tab="estoque">Estoque</button>
    </nav>
    <div class="status-bar">
      <div id="status">Carregando…</div>
    </div>
  </div>

  <div class="content-wrap">
    
    <!-- ===== ABA CADASTROS ===== -->
    <section id="tab-cadastros" class="tab-content active">
      <div class="section" id="section-cadastros">
        <nav class="subtabs" id="cadastro-subtabs">
          <button data-subtab="pratos" class="active">Pratos</button>
          <button data-subtab="componentes">Componentes</button>
          <button data-subtab="receitas">Receitas</button>
          <button data-subtab="ingredientes">Ingredientes</button>
        </nav>

        <!-- Sub: PRATOS -->
        <div id="sub-pratos" class="subpage active">
          <div class="grid cols-2">
            <div>
              <input id="pratos-search" placeholder="Buscar prato cadastrado...">
            </div>
            <div class="right"><button id="btnNovoPrato" class="btn pri">+ Novo prato</button></div>
          </div>
          <div class="sep"></div>
          <div class="grid cols-2" style="margin:6px 0; align-items:flex-end;">
            <div>
              <label>Filtrar categoria</label>
              <select id="pratos-cat-filter"><option value="">Todas</option><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMOÇÕES</option><option>OUTROS</option></select>
            </div>
            <div class="right">
              <span class="pill" id="pratos-page-info">Página 1/1</span>
              <div class="row-actions"><button class="btn small" id="pratos-prev">◀</button><button class="btn small" id="pratos-next">▶</button></div>
            </div>
          </div>
          <div class="table-container" style="max-height:420px;">
            <table id="tblPratos"><thead><tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
          </div>

          <div class="sep"></div>
          <h3 id="prato-form-title">Editar prato</h3>
          <div class="grid cols-4">
            <div><label>Nome</label><input id="prato-nome" placeholder="Ex.: Strogonoff de frango"></div>
            <div><label>Categoria</label><select id="prato-cat"><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMOÇÕES</option><option>OUTROS</option></select></div>
            <div><label>Peso do prato</label><select id="prato-peso-un"><option>g</option><option>ml</option></select></div>
            <div><label>Qtd</label><input id="prato-peso" placeholder="Ex.: 500"></div>
          </div>
           <div class="grid cols-2" style="margin-top:10px;">
              <div><label>Cód. Barras</label><input id="prato-codigo-barras" disabled></div>
              <div><label>QR Code</label><input id="prato-qrcode" disabled></div>
          </div>
           <div style="margin-top:10px;">
             <label>Descrição para o cardápio</label>
             <textarea id="prato-descricao" rows="3" placeholder="Descreva o prato para seus clientes... ou deixe que a IA sugira!"></textarea>
          </div>
          <div class="grid cols-4" style="margin-top:10px; align-items:flex-end;">
            <div><label>Preço de venda (fator ou R$)</label><input id="prato-preco" placeholder="Ex.: 3,2 (fator) ou 34,90 (R$)"></div>
            <div><label>Custo do prato (calculado)</label><input id="prato-custo" disabled placeholder="R$ 0,00"></div>
            <div><label>Última alteração</label><input id="prato-ultima" disabled placeholder="—"></div>
            <div class="right">
                <button id="btnGenerateDesc" class="btn">✨ Sugerir (IA)</button>
                <button id="btnSalvarPrato" class="btn pri">Salvar</button>
                <button id="btnCancelarPrato" class="btn">Cancelar</button>
            </div>
          </div>

          <div class="sep"></div>
          <details class="dash" id="dash-import">
            <summary>Importar Pratos do Dashboard (clique para expandir)</summary>
            <div class="grid cols-3" style="margin-top:10px; align-items:flex-end;">
              <div><label>Categoria (da fonte)</label><select id="dash-cat"><option value="">Sem categoria</option><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMOÇÕES</option><option>OUTROS</option></select></div>
              <div><label>Buscar no dashboard</label><input id="dash-search" placeholder="Digite para filtrar…"></div>
              <div class="right"><button id="btnSyncAll" class="btn">Sincronizar</button></div>
            </div>
            <div class="table-container" style="overflow:auto;margin-top:10px;max-height:300px;">
              <table id="tblDash"><thead><tr><th>Prato (dashboard)</th><th>Categoria</th><th>Situação</th><th>Ação</th></tr></thead><tbody></tbody></table>
            </div>
          </details>
        </div>

        <!-- Sub: COMPONENTES -->
        <div id="sub-componentes" class="subpage">
          <h2>Componentes do Prato</h2>
          <div class="grid cols-2">
            <div>
              <label>Selecione um prato para ver ou adicionar componentes</label>
              <select id="cp-prato"><option value="">Selecione...</option></select>
            </div>
          </div>
          <div id="componentes-editor" style="display: none;">
            <div class="sep"></div>
            <h4>Adicionar Nova Receita ao Prato</h4>
            <div class="grid cols-4">
              <div><label>Receita</label><select id="cp-receita"></select></div>
              <div><label>Qtd por prato</label><input id="cp-qtd" placeholder="Ex.: 220"></div>
              <div><label>Unidade</label><select id="cp-und"><option>g</option><option>ml</option><option>porcao</option></select></div>
              <div class="right" style="align-self: flex-end;">
                <button id="btnAddPrComp" class="btn pri">Adicionar</button>
              </div>
            </div>
             <div class="grid cols-2" style="margin-top:10px; align-items:flex-end;">
              <div><label>Observações</label><input id="cp-obs" placeholder="Opcional"></div>
            </div>
            <div class="sep"></div>
            <h4>Receitas Atuais do Prato</h4>
            <div class="table-container" style="max-height:420px"><table id="tblPrComp"><thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>

        <!-- Sub: RECEITAS -->
        <div id="sub-receitas" class="subpage">
          <h2>Gerenciamento de Receitas</h2>
          
          <div class="right" style="margin-bottom: 16px;">
            <button id="btnShowNewRecipeForm" class="btn pri">+ Nova Receita</button>
          </div>

          <!-- FORMULÁRIO DE NOVA/EDIÇÃO (oculto por padrão) -->
          <div id="recipe-editor-container" style="display: none; border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; margin-bottom: 24px;">
              <h3 id="recipe-form-title">Nova Receita</h3>
              <div class="grid cols-3">
                  <div><label>Nome da receita</label><input id="rec-nome" placeholder="Ex.: Arroz Branco pronto"></div>
                  <div><label>Rendimento (qtd)</label><input id="rec-rend-qtd" placeholder="Ex.: 1000"></div>
                  <div><label>Unidade rendimento</label><select id="rec-rend-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option value="porcao">porção</option></select></div>
              </div>
              <div class="grid cols-3" style="margin-top:10px;">
                  <div><label>Perda global (%)</label><input id="rec-perda" value="0"></div>
                  <div><label>Cód. Barras</label><input id="rec-codigo-barras" disabled></div>
                  <div><label>QR Code</label><input id="rec-qrcode" disabled></div>
              </div>
               <div><label>Observações</label><input id="rec-obs" placeholder="Opcional"></div>
              <div style="margin-top:10px;">
                  <label>Modo de Preparo</label>
                  <textarea id="rec-preparo" rows="6" placeholder="Descreva o passo-a-passo ou clique para gerar..."></textarea>
              </div>
              <div class="sep"></div>
              <h4>Itens da Receita</h4>
              <div class="grid cols-4">
                  <div><label>Tipo</label><select id="draft-tipo"><option>INGREDIENTE</option><option>RECEITA</option></select></div>
                  <div><label>Referência</label><select id="draft-ref"></select></div>
                  <div><label>Qtd</label><input id="draft-qtd" placeholder="Ex.: 300"></div>
                  <div><label>Unidade</label><select id="draft-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
              </div>
              <div class="grid cols-2" style="margin-top:10px; align-items:flex-end;">
                  <div><label>Perda da linha (%)</label><input id="draft-perda" value="0"></div>
                  <div class="right">
                      <button id="btnDraftAdd" class="btn">Adicionar Item</button>
                      <button id="btnDraftClear" class="btn">Limpar Itens</button>
                  </div>
              </div>
              <div class="table-container" style="margin-top:8px;max-height:200px"><table id="tblDraft"><thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
              <div class="sep"></div>
              <div class="right">
                  <button id="btnGeneratePreparo" class="btn">✨ Gerar Preparo (IA)</button>
                  <button id="btnSaveRec" class="btn pri">Salvar</button>
                  <button id="btnUpdateRec" class="btn pri" style="display:none">Atualizar</button>
                  <button id="btnCancelRecEdit" class="btn">Cancelar</button>
              </div>
          </div>

          <!-- LISTA DE RECEITAS CADASTRADAS -->
          <h3>Receitas Cadastradas</h3>
          <div class="table-container">
              <table id="tblRec"><thead><tr><th>Nome</th><th>Rendimento</th><th>Itens</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- Sub: INGREDIENTES -->
        <div id="sub-ingredientes" class="subpage">
           <h2>Gerenciamento de Ingredientes</h2>
           <div class="right" style="margin-bottom: 16px;">
            <button id="btnShowNewIngredienteForm" class="btn pri">+ Novo Ingrediente</button>
          </div>
          <div id="ingrediente-editor-container" style="display: none; border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; margin-bottom: 24px;">
              <h3 id="ingrediente-form-title">Novo Ingrediente</h3>
              <div class="grid cols-4">
                <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"></div>
                <div><label>Categoria</label><select id="ing-categoria"><option>Alimentos</option><option>Bebidas</option><option>Descartáveis</option><option>Proteínas</option><option>Outros</option></select></div>
                <div><label>Unidade</label><select id="ing-und"><option>g</option><option selected>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
                <div><label>Custo unitário</label><input id="ing-custo" placeholder="Ex.: 0,0123"></div>
              </div>
               <div class="grid cols-2" style="margin-top:10px;">
                  <div><label>Cód. Barras</label><input id="ing-codigo-barras" disabled></div>
                  <div><label>QR Code</label><input id="ing-qrcode" disabled></div>
              </div>
              <div class="grid cols-2" style="margin-top:10px; align-items:flex-end;">
                <div><label>Observações</label><input id="ing-obs" placeholder="Opcional"></div>
                <div class="right"><button id="btnSaveIng" class="btn pri">Salvar</button><button id="btnCancelIngEdit" class="btn">Cancelar</button></div>
              </div>
          </div>

          <div class="grid cols-2"><div class="pill">Ingredientes cadastrados</div><div class="right"><input id="ing-search" placeholder="Buscar..."></div></div>
          <div class="table-container" style="margin-top:6px;"><table id="tblIng"><thead><tr><th>Nome</th><th>Categoria</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>
    </section>

    <!-- ===== ABA PRODUÇÃO ===== -->
    <section id="tab-producao" class="tab-content">
      <div class="section">
        <h2>Mapa de Produção – Previsão</h2>
        <div class="grid cols-4" style="align-items:flex-end;">
          <div>
            <label>Média dos últimos (dias)</label>
            <input id="win-dias" type="number" min="1" step="1" value="7" />
          </div>
          <div>
            <label>Projetar próximos (dias)</label>
            <input id="proj-dias" type="number" min="1" step="1" value="7" />
          </div>
          <div>
            <label>Filtrar Categorias de Pratos</label>
            <select id="cat-filter" multiple></select>
          </div>
          <div class="right">
            <button id="btnCalcularPrev" class="btn pri">Calcular</button>
          </div>
        </div>
        <div class="hint" id="prev-hint-top"></div>

        <div class="grid cols-3" style="margin-top:10px">
          <div class="pill"><span class="soft">Dias analisados:</span> <span id="kpi-dias" style="font-weight:600">—</span></div>
          <div class="pill"><span class="soft">Pratos considerados:</span> <span id="kpi-pratos" style="font-weight:600">—</span></div>
          <div class="pill"><span class="soft">Receitas consolidadas:</span> <span id="kpi-rec" style="font-weight:600">—</span></div>
        </div>

        <div class="sep"></div>
        <h3>Resumo — Média de Vendas por Prato</h3>
        <div class="table-container" style="max-height:300px;">
          <table id="tblResumoPratos">
            <thead><tr><th>Prato</th><th>Categoria</th><th>Média/Dia</th><th id="th-proj-prato">Projeção</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="sep"></div>
        <h3>Produção consolidada por Receita</h3>
        <div class="table-container" style="max-height:360px;">
          <table id="tblPrev">
            <thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th id="th-proj">Qtd/Projeção</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="right" style="margin-top:12px"><button id="btnExportPrev" class="btn">Exportar PDF</button></div>
        <div class="hint" id="prev-hint"></div>
      </div>
    </section>

    <!-- ===== ABA COMPRAS (agora Sugestões de Compra) ===== -->
    <section id="tab-compras" class="tab-content">
       <div class="section">
        <h3>Sugestões de Compra</h3>
         <div class="hint">Calculado com base no estoque atual, ponto de pedido, consumo médio e lead time.</div>
        <div class="right" style="margin: 16px 0;">
            <button id="btnRefreshSuggestions" class="btn">Atualizar Sugestões</button>
            <button id="btnExportSuggestions" class="btn">Exportar CSV</button>
        </div>
        <div class="table-container">
            <table id="tblSugestoes">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Status</th>
                        <th>Saldo Atual</th>
                        <th>Ponto Pedido</th>
                        <th>Consumo Médio/Dia</th>
                        <th>Sugestão (Qtd)</th>
                        <th>Múltiplo Compra</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
    </section>

    <!-- ===== ABA ESTOQUE ===== -->
    <section id="tab-estoque" class="tab-content">
       <div class="section" id="section-estoque">
        <nav class="subtabs" id="estoque-subtabs">
          <button data-subtab="estoque-visao" class="active">Visão Geral</button>
          <button data-subtab="estoque-mov">Movimentar</button>
          <button data-subtab="estoque-benef">Beneficiar</button>
          <button data-subtab="estoque-inv">Inventário</button>
          <button data-subtab="estoque-param">Parâmetros</button>
          <button data-subtab="estoque-anom">Anomalias (IA)</button>
        </nav>

        <!-- Sub: Visão Geral -->
        <div id="sub-estoque-visao" class="subpage active">
            <div class="grid cols-5">
                <div class="pill bad">Críticos: <b id="estoq-kpi-criticos">0</b></div>
                <div class="pill warn">Abaixo Mín.: <b id="estoq-kpi-min">0</b></div>
                <div class="pill">Acima Máx.: <b id="estoq-kpi-max">0</b></div>
                <div class="pill warn">Venc. &lt; 7d: <b id="estoq-kpi-venc7">0</b></div>
                <div class="pill">Ajustes (30d): <b id="estoq-kpi-ajustes">R$ 0,00</b></div>
            </div>
            <div class="filters-bar">
                <div><label>Filtrar por Unidade</label><select id="filtro-unidade-estoque"></select></div>
                <div><label>Filtrar por Categoria</label><select id="filtro-categoria-estoque"></select></div>
                <div><label>Filtrar por Status</label><select id="filtro-status-estoque"><option value="">Todos</option><option value="CRÍTICO">Crítico</option><option value="ABAIXO DO MÍNIMO">Abaixo do Mínimo</option><option value="OK">OK</option></select></div>
            </div>
            <h4>Saldo Atual por Item</h4>
            <div class="table-container" style="max-height: 250px;">
                <table id="tblSaldo"><thead><tr><th>Item</th><th>Tipo</th><th>Unidade</th><th>Saldo</th><th>Custo Médio</th><th>Valor Total</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="sep"></div>
            <h4>Saldo Detalhado por Lote</h4>
            <div class="table-container" style="max-height: 250px;">
                <table id="tblSaldoLotes"><thead><tr><th>Item</th><th>Lote</th><th>Validade</th><th>Saldo</th><th>Unidade</th><th>Custo Unit.</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <!-- Sub: Movimentar (NOVO LAYOUT OTIMIZADO) -->
        <div id="sub-estoque-mov" class="subpage">
            <h3>Operações de Estoque</h3>
            <div class="mov-actions">
                <button class="btn" data-mov-type="ENTRADA"><span>📥</span> Entrada</button>
                <button class="btn" data-mov-type="SAIDA"><span>📤</span> Saída</button>
                <button class="btn" data-mov-type="TRANSFERENCIA"><span>🔄</span> Transferência</button>
                <button class="btn" data-mov-type="AJUSTE"><span>✍️</span> Ajuste</button>
            </div>
            
            <div id="mov-form-container">
                <h3 id="mov-form-title"></h3>
                <form id="frmMov">
                    <!-- Campos Comuns -->
                    <div class="grid cols-2">
                        <div id="mov-unidade-origem-group"><label>Unidade Origem</label><select id="mov-unidade-origem"></select></div>
                        <div id="mov-unidade-destino-group"><label>Unidade Destino</label><select id="mov-unidade-destino"></select></div>
                    </div>
                    <div class="grid cols-2" style="margin-top:10px">
                         <div><label>Item</label><select id="mov-item"></select></div>
                         <div><label>Tipo Item</label><select id="mov-item-tipo"><option value="ING">Ingrediente</option><option value="REC">Receita</option></select></div>
                    </div>
                    <div class="grid cols-2" style="margin-top:10px">
                        <div><label>Lote</label><input id="mov-lote" placeholder="Lote do produto"></div>
                        <div id="mov-validade-group"><label>Validade</label><input id="mov-validade" type="date"></div>
                    </div>
                     <div class="grid cols-3" style="margin-top:10px">
                        <div><label>Quantidade</label><input id="mov-qtd" type="number" placeholder="0,00"></div>
                        <div id="mov-ajuste-sinal-group"><label>Tipo de Ajuste</label><select id="mov-ajuste-sinal"><option value="+">Positivo (+)</option><option value="-">Negativo (-)</option></select></div>
                        <div><label>Un. Medida</label><input id="mov-un" placeholder="kg, L, un"></div>
                    </div>
                    <div style="margin-top:10px" id="mov-custo-group"><label>Custo Unitário</label><input id="mov-custo" type="number" placeholder="0,00"></div>
                    <div style="margin-top:10px"><label>Documento/Observação</label><input id="mov-doc" placeholder="Nota Fiscal, Motivo, etc."></div>
                    
                    <div class="right" style="margin-top:16px;">
                        <button id="btnMovScan" type="button" class="btn">📷 Scan QR</button>
                        <button id="btnMovSubmit" type="submit" class="btn pri">Registrar</button>
                        <button id="btnMovCancel" type="button" class="btn">Cancelar</button>
                    </div>
                </form>
                <video id="qr-video"></video>
                <div id="qr-result" class="hint" style="margin-top: 8px;"></div>
            </div>
            <div class="sep"></div>
            <h4>Últimas 20 Movimentações</h4>
            <div class="table-container" style="max-height: 300px;">
                 <table id="tblMovRecentes"><thead><tr><th>TS</th><th>Tipo</th><th>Item</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
        
        <div id="sub-estoque-benef" class="subpage"><p>Funcionalidade de Beneficiamento será desenvolvida aqui.</p></div>
        <div id="sub-estoque-inv" class="subpage"><p>Funcionalidade de Inventário será desenvolvida aqui.</p></div>
        <div id="sub-estoque-param" class="subpage"><p>Funcionalidade de Parâmetros de Estoque será desenvolvida aqui.</p></div>
        <div id="sub-estoque-anom" class="subpage"><p>Funcionalidade de Anomalias (IA) será desenvolvida aqui.</p></div>
       </div>
    </section>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
/* ===== ROTEAMENTO POR ABAS ===== */
function setupRouting() {
  const mainTabsContainer = document.getElementById('main-tabs');
  const mainContents = document.querySelectorAll('.tab-content');
  
  const setupSubTabs = (containerId, contentSelector) => {
      const container = document.getElementById(containerId);
      const contents = document.querySelectorAll(contentSelector);
      if (!container) return;
      
      container.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const subTabId = btn.dataset.subtab;

        container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        contents.forEach(content => {
          content.classList.toggle('active', content.id === 'sub-' + subTabId);
        });
      });
  };

  mainTabsContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const tabId = btn.dataset.tab;

    mainTabsContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    mainContents.forEach(content => {
      content.classList.toggle('active', content.id === 'tab-' + tabId);
    });
  });
  
  setupSubTabs('cadastro-subtabs', '#tab-cadastros .subpage');
  setupSubTabs('estoque-subtabs', '#tab-estoque .subpage');
}
document.addEventListener('DOMContentLoaded', setupRouting);

/* ===== Gemini API Integration ===== */
async function callGemini(prompt, button) {
    const originalButtonText = button.innerHTML;
    button.innerHTML = '✨ Gerando...';
    button.disabled = true;

    const apiKey = ""; // Será substituído pelo ambiente de execução
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
        }

        const result = await response.json();
        const candidate = result.candidates?.[0];

        if (candidate && candidate.content?.parts?.[0]?.text) {
            return candidate.content.parts[0].text;
        } else {
            console.error('Unexpected API response structure:', result);
            throw new Error('Não foi possível extrair o texto da resposta da API.');
        }
    } catch (error) {
        console.error('Error calling Gemini API:', error);
        setStatus('Erro na API Gemini: ' + error.message, 'err');
        return null;
    } finally {
        button.innerHTML = originalButtonText;
        button.disabled = false;
    }
}


/* ===== Helpers ===== */
const $  = (id)=> document.getElementById(id);
const $$ = (sel,root=document)=> Array.from(root.querySelectorAll(sel));
const setStatus=(msg,cls)=>{const el=$('status'); if(!el) return; el.textContent=msg; el.style.color=(cls==='err'?'var(--down)':cls==='ok'?'var(--ok)':'var(--muted)');};
const fmt=(n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
const ptToNumber=(v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
const todayStr=()=> new Date().toISOString().slice(0,10);
const weekDayPt=(iso)=> new Date(iso+'T00:00:00').toLocaleDateString('pt-BR',{weekday:'long'});

/* ===== Supabase ===== */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== Estado PRATOS (lista/paginação) ===== */
let pratos=[], pratosPage=1; const PAGE_SIZE=10; let pratoEditId=null;
function renderPratos(){
  const term=$('pratos-search').value?.toLowerCase().trim()||'';
  const catF= $('pratos-cat-filter').value||'';
  const filtered=pratos.filter(p=>(!catF||String(p.categoria||'')===catF) && (!term||String(p.nome).toLowerCase().includes(term)));
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(pratosPage>totalPages) pratosPage=totalPages;
  const pageItems=filtered.slice((pratosPage-1)*PAGE_SIZE,(pratosPage-1)*PAGE_SIZE+PAGE_SIZE);
  const tb=$('tblPratos').querySelector('tbody'); tb.innerHTML='';
  pageItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.nome}</td><td>${p.categoria||'—'}</td><td>${p.receitas ?? '—'}</td>
      <td>${p.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions"><button class="btn small" data-act="edit" data-id="${p.id}">Editar</button>
      <button class="btn small" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
      <button class="btn small" data-act="del" data-id="${p.id}">Excluir</button></td>`;
    tb.appendChild(tr);
  });
  $('pratos-page-info').textContent=`Página ${pratosPage}/${totalPages}`;
  $('pratos-prev').disabled=pratosPage<=1; $('pratos-next').disabled=pratosPage>=totalPages;
}
$('pratos-prev').addEventListener('click',()=>{ pratosPage=Math.max(1,pratosPage-1); renderPratos(); });
$('pratos-next').addEventListener('click',()=>{ pratosPage=pratosPage+1; renderPratos(); });
$('pratos-search').addEventListener('input',()=>{ pratosPage=1; renderPratos(); });
$('pratos-cat-filter').addEventListener('change',()=>{ pratosPage=1; renderPratos(); });

/* ===== CRUD PRATOS ===== */
$('btnNovoPrato').addEventListener('click',()=>{ 
    pratoEditId=null; 
    $('prato-form-title').textContent='Novo prato'; 
    $('prato-nome').value=''; 
    $('prato-cat').value='PRATOS'; 
    $('prato-peso').value=''; 
    $('prato-peso-un').value='g'; 
    $('prato-preco').value=''; 
    $('prato-custo').value=''; 
    $('prato-ultima').value=''; 
    $('prato-descricao').value = '';
    $('prato-codigo-barras').value = '';
    $('prato-qrcode').value = '';
});
$('btnCancelarPrato').addEventListener('click',()=> $('btnNovoPrato').click());
$('tblPratos').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){ 
      const p=pratos.find(x=>String(x.id)===String(id)); 
      if(!p) return; 
      pratoEditId=p.id; 
      $('prato-form-title').textContent='Editar prato'; 
      $('prato-nome').value=p.nome||''; 
      $('prato-cat').value=p.categoria||'PRATOS'; 
      $('prato-peso').value=p.peso??''; 
      $('prato-peso-un').value=p.peso_un||'g'; 
      $('prato-preco').value=p.preco_venda??''; 
      $('prato-custo').value=p.custo??''; 
      $('prato-ultima').value=p.updated_at?new Date(p.updated_at).toLocaleString('pt-BR'):'—'; 
      $('prato-descricao').value = p.descricao || '';
      $('prato-codigo-barras').value = p.codigo_barras || '';
      $('prato-qrcode').value = p.qrcode || '';
    }
  if(act==='toggle'){ try{ const p=pratos.find(x=>String(x.id)===String(id)); const {error}=await supa.from('pratos').update({ativo:!p.ativo}).eq('id',id); if(error) throw error; await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
  if(act==='del'){ if(!confirm('Excluir prato?')) return; try{ const {error}=await supa.from('pratos').delete().eq('id',id); if(error) throw error; await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
});
$('btnSalvarPrato').addEventListener('click',async ()=>{
  const nome=$('prato-nome').value.trim(); if(!nome){ alert('Informe o nome do prato'); return; }
  const basePayload={ 
      nome, 
      categoria:$('prato-cat').value, 
      peso:ptToNumber($('prato-peso').value), 
      peso_un:$('prato-peso-un').value, 
      preco_venda:$('prato-preco').value.trim(),
      descricao: $('prato-descricao').value.trim() || null
  };
  try{
    if(pratoEditId){ 
        const {error}=await supa.from('pratos').update(basePayload).eq('id',pratoEditId); 
        if(error) throw error; 
    } else { 
        const newBarcode = `BAR-${crypto.randomUUID()}`;
        const newQrcode = `QR-${crypto.randomUUID()}`;
        const insertPayload = {
            ...basePayload,
            codigo_barras: newBarcode,
            qrcode: newQrcode,
            ativo:true
        };
        const {error}=await supa.from('pratos').insert(insertPayload); 
        if(error) throw error; 
    }
    await loadPratos(); 
    $('btnNovoPrato').click();
    setStatus('Prato salvo','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
});

/* ===== Import do Dashboard de Pratos ===== */
const DASHBOARD_PRATOS_SOURCE='vendas_pratos_pratos';
async function loadDash(){
  const tb=$('tblDash')?.querySelector('tbody'); if(!tb) return;
  tb.innerHTML='<tr><td colspan="4">Carregando…</td></tr>';
  try{
    let dash=null, err=null; ({data:dash, error:err}=await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato,categoria')); if(err){ ({data:dash, error:err}=await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato')); }
    if(err) throw err;
    const {data:pr}=await supa.from('pratos').select('id,nome'); const exist=new Set((pr||[]).map(p=>p.nome));
    const cat=$('dash-cat').value?.toUpperCase()||''; const term=$('dash-search').value?.toLowerCase().trim()||'';
    tb.innerHTML='';
    (dash||[]).filter(r=> (!cat||String(r.categoria||'').toUpperCase()===cat) && (!term||String(r.prato||'').toLowerCase().includes(term)) )
      .forEach(r=>{
        const already=exist.has(r.prato);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.prato}</td><td>${r.categoria||'<span class="soft">N/D</span>'}</td>
          <td>${already?'<span class="pill">Já existe</span>':'<span class="pill">Falta importar</span>'}</td>
          <td>${already?'-':`<button class="btn small" data-import="${r.prato.replace(/"/g,'&quot;')}" data-cat="${(r.categoria||'PRATOS').replace(/"/g,'&quot;')}">Importar</button>`}</td>`;
        tb.appendChild(tr);
      });
  }catch(e){ tb.innerHTML='<tr><td colspan="4">Não foi possível ler a fonte do dashboard.</td></tr>'; }
}
document.addEventListener('click', e=>{
  const b=e.target.closest('#tblDash button[data-import]'); if(!b) return;
  (async ()=>{
    const {error}=await supa.from('pratos').insert({nome:b.dataset.import,categoria:b.dataset.cat||'PRATOS',ativo:true});
    if(error && !String(error.message||'').includes('duplicate')) return alert(error.message||error);
    await loadPratos(); await loadDash();
  })();
});

/* ===== Componentes ===== */
async function loadPratoCompTable(){
  const prato_id=$('cp-prato').value; 
  const tb=$('tblPrComp').querySelector('tbody'); 
  tb.innerHTML='';
  if(!prato_id) return;
  try{
    const {data, error}=await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id',prato_id);
    if(error) throw error;
    for(const row of (data||[])){
      const {data:rec}=await supa.from('receitas').select('nome').eq('id',row.receita_id).single();
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${rec?.nome||'(removida)'}</td><td>${fmt(row.qtd)}</td><td>${row.unidade}</td><td class="row-actions"><button class="btn small" data-del="${row.id}">Remover</button></td>`;
      tb.appendChild(tr);
    }
  }catch(ex){ tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>'; }
}
$('cp-prato')?.addEventListener('change', () => {
    const pratoId = $('cp-prato').value;
    const editor = $('componentes-editor');
    if (pratoId) {
        editor.style.display = 'block';
        loadPratoCompTable();
    } else {
        editor.style.display = 'none';
    }
});

$('btnAddPrComp')?.addEventListener('click',async ()=>{
  const prato_id=$('cp-prato').value, receita_id=$('cp-receita').value, qtd=ptToNumber($('cp-qtd').value), unidade=$('cp-und').value, obs=$('cp-obs').value.trim()||null;
  if(!prato_id||!receita_id||!qtd){ return alert('Selecione prato/receita e informe quantidade'); }
  const {error}=await supa.from('prato_receitas').insert({prato_id,receita_id,qtd,unidade,obs});
  if(error && !String(error.message||'').includes('duplicate')) return alert(error.message||error);
  $('cp-qtd').value=''; $('cp-obs').value=''; await loadPratoCompTable();
});
document.addEventListener('click', async e=>{
  const b=e.target.closest('#tblPrComp button[data-del]'); if(!b) return;
  if(!confirm('Remover receita do prato?')) return;
  const {error}=await supa.from('prato_receitas').delete().eq('id',b.dataset.del);
  if(error) return alert(error.message||error);
  await loadPratoCompTable();
});

/* ===== Receitas (cadastro) ===== */
let recEditId=null, draftItems=[];
async function refreshDraftRefs(){ const tipo=$('draft-tipo').value; if(tipo==='INGREDIENTE') await fillOptionsFrom('ingredientes','draft-ref','id','nome',{ativo:true}); else await fillOptionsFrom('receitas','draft-ref','id','nome',{ativo:true}); }
function renderDraft(){ const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML=''; draftItems.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.tipo}</td><td>${it.nome}</td><td>${fmt(it.qtd)}</td><td>${it.unidade}</td><td>${fmt(it.perda_pct)}%</td><td class="row-actions"><button class="btn small" data-rm="${i}">Remover</button></td>`; tb.appendChild(tr); }); }
$('draft-tipo')?.addEventListener('change',refreshDraftRefs);
document.addEventListener('click',e=>{ const b=e.target.closest('#tblDraft button[data-rm]'); if(!b) return; draftItems.splice(+b.dataset.rm,1); renderDraft(); });
$('btnDraftAdd')?.addEventListener('click',async ()=>{ const tipo=$('draft-tipo').value, ref_id=$('draft-ref').value, qtd=ptToNumber($('draft-qtd').value), unidade=$('draft-und').value, perda_pct=ptToNumber($('draft-perda').value); if(!ref_id||!qtd) return alert('Selecione a referência e informe a quantidade'); let nome=''; if(tipo==='INGREDIENTE'){ const {data}=await supa.from('ingredientes').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; } else { const {data}=await supa.from('receitas').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; } draftItems.push({tipo,ref_id,nome,qtd,unidade,perda_pct}); $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft(); });
$('btnDraftClear')?.addEventListener('click',()=>{ draftItems=[]; renderDraft(); });

$('btnSaveRec')?.addEventListener('click',async ()=>{
  const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null, modo_preparo = $('rec-preparo').value.trim()||null;
  if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
  const newBarcode = `BAR-${crypto.randomUUID()}`;
  const newQrcode = `QR-${crypto.randomUUID()}`;
  const payload = {
      nome, rendimento_qtd, unidade_rendimento, perda_pct, obs, modo_preparo,
      codigo_barras: newBarcode,
      qrcode: newQrcode
  };
  const {data:ins,error}=await supa.from('receitas').insert(payload).select('id').single(); if(error) return alert(error.message||error);
  if(draftItems.length){ const payload=draftItems.map(d=>({receita_id:ins.id,tipo:d.tipo,ref_id:d.ref_id,qtd:d.qtd,unidade:d.unidade,perda_pct:d.perda_pct})); const {error:err2}=await supa.from('receita_itens').insert(payload); if(err2) alert('Receita salva, erro ao salvar itens: '+(err2.message||err2)); }
  $('btnCancelRecEdit').click();
  await loadReceitas(); setStatus('Receita salva','ok');
});
$('btnUpdateRec')?.addEventListener('click',async ()=>{ 
    if(!recEditId) return; 
    const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null, modo_preparo = $('rec-preparo').value.trim()||null; 
    if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento'); 
    const payload = {
        nome, rendimento_qtd, unidade_rendimento, perda_pct, obs, modo_preparo
    };
    const {error}=await supa.from('receitas').update(payload).eq('id',recEditId); 
    if(error) return alert(error.message||error); 
    await loadReceitas(); 
    setStatus('Receita atualizada','ok'); 
});
$('btnCancelRecEdit').addEventListener('click',()=>{ 
    recEditId=null; 
    $('recipe-editor-container').style.display = 'none';
    $('recipe-form-title').textContent = 'Nova Receita';
    $('rec-nome').value=''; 
    $('rec-rend-qtd').value=''; 
    $('rec-rend-und').value='g';
    $('rec-perda').value='0'; 
    $('rec-obs').value=''; 
    $('rec-preparo').value='';
    $('rec-codigo-barras').value = '';
    $('rec-qrcode').value = '';
    draftItems = [];
    renderDraft();
    
    $('btnSaveRec').style.display='inline-flex'; 
    $('btnUpdateRec').style.display='none'; 
});


async function fillOptionsFrom(table, selId, valKey, labelKey, whereEq){
  const sel=$(selId); if(!sel) return; sel.innerHTML='<option value="">Carregando…</option>';
  try{ let q=supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true}); if(whereEq) Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v)); const {data,error}=await q; if(error) throw error; sel.innerHTML='<option value="">Selecione</option>'; (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); }); }catch(e){ sel.innerHTML='<option value="">(n/d)</option>'; }
}
async function loadReceitas(){
  const tb=$('tblRec').querySelector('tbody'); tb.innerHTML='<tr><td colspan="6">Carregando…</td></tr>';
  try{ const {data,error}=await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true}); if(error) throw error;
    tb.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td><td>${r.itens}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td><td class="row-actions"><button class="btn small" data-act="edit" data-id="${r.id}">Editar</button><button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button><button class="btn small" data-act="del" data-id="${r.id}">Excluir</button></td>`; tb.appendChild(tr); });
  }catch(e){ tb.innerHTML='<tr><td colspan="6">Crie a view v_receitas_resumo e adicione os campos de código</td></tr>'; }
  await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true}); await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true}); 
}
async function loadIngredientes(){
  const tb=$('tblIng').querySelector('tbody'); tb.innerHTML='<tr><td colspan="5">Carregando…</td></tr>';
  try{ const {data,error}=await supa.from('ingredientes').select('*').order('nome',{ascending:true}); if(error) throw error;
    tb.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.categoria || '—'}</td><td>${r.unidade}</td><td>R$ ${fmt(r.custo_unitario)}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td><td class="row-actions"><button class="btn small" data-act="edit" data-id="${r.id}">Editar</button><button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button><button class="btn small" data-act="del" data-id="${r.id}">Excluir</button></td>`; tb.appendChild(tr); });
  }catch(e){ tb.innerHTML='<tr><td colspan="5">Erro/Tabela não encontrada: ingredientes</td></tr>'; }
}

/* ===== Unidades ===== */
function toBase(value,unit){ const u=(unit||'').toLowerCase(); if(u==='kg') return {v:value*1000,u:'g'}; if(u==='l') return {v:value*1000,u:'ml'}; if(u==='porcao') return {v:value,u:'un'}; return {v:value,u:(u==='ml'||u==='l')?'ml':(u==='kg'||u==='g')?'g':unit}; }

/* ===== PREVISÃO ===== */
async function preencherCategorias(){
  const sel=$('cat-filter'); sel.innerHTML='';
  const {data}=await supa.from('pratos').select('categoria').not('categoria','is',null);
  const cats=[...new Set((data||[]).map(x=>x.categoria||'OUTROS'))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
}
async function obterUltimaDataVenda(){
  const {data,error}=await supa.from('vendas_pratos_view_only_pratos').select('data').order('data',{ascending:false}).limit(1).maybeSingle();
  if(error) return todayStr();
  return data?.data || todayStr();
}
async function calcularPrevisaoReal(){
  const win = Math.max(1, +$('win-dias').value||7);
  const proj = Math.max(1, +$('proj-dias').value||7);
  const refReal = await obterUltimaDataVenda();
  $('prev-hint-top').textContent = `Usando como referência a última data com lançamento: ${refReal} (${weekDayPt(refReal)}).`;

  setStatus('Calculando…','');
  $('th-proj').textContent = `Qtd/Projeção (${proj} dias)`;
  $('th-proj-prato').textContent = `Projeção (${proj} dias)`;

  const fim = new Date(refReal);
  const ini = new Date(refReal); ini.setDate(fim.getDate()-(win-1));
  const isoIni = ini.toISOString().slice(0,10), isoFim = refReal;

  const {data:vendas,error:errV}=await supa
    .from('vendas_pratos_view_only_pratos')
    .select('data,prato,quantidade')
    .gte('data',isoIni).lte('data',isoFim);
  if(errV){ setStatus('Erro ao ler vendas: '+(errV.message||errV),'err'); return; }

  const {data:pratosTbl}=await supa.from('pratos').select('id,nome,categoria');
  const nomeToId = new Map((pratosTbl||[]).map(p=>[p.nome,p.id]));
  const nomeToCat= new Map((pratosTbl||[]).map(p=>[p.nome,p.categoria||'OUTROS']));
  const selCats = new Set(Array.from($('cat-filter').selectedOptions||[]).map(o=>o.value));
  const filtraCat = (pratoNome)=> selCats.size? selCats.has(nomeToCat.get(pratoNome)||'OUTROS') : true;

  const porPrato = new Map();
  (vendas||[]).forEach(v=>{
    if(!filtraCat(v.prato)) return;
    porPrato.set(v.prato,(porPrato.get(v.prato)||0)+(v.quantidade||0));
  });
  const mediaPratoDia = new Map([...porPrato.entries()].map(([p,tot])=> [p, tot / win] ));
  const pratoIds = [...mediaPratoDia.keys()].map(n=> nomeToId.get(n)).filter(Boolean);

  const tbResumo=$('tblResumoPratos').querySelector('tbody'); tbResumo.innerHTML='';
  [...mediaPratoDia.entries()]
    .map(([nome,md])=>({nome,cat:nomeToCat.get(nome)||'—', md, proj: md*proj}))
    .sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'))
    .forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${r.cat}</td><td>${fmt(r.md)}</td><td>${fmt(r.proj)}</td>`;
      tbResumo.appendChild(tr);
    });

  let pratoReceitas=[];
  if(pratoIds.length){
    const {data:prc}=await supa.from('prato_receitas').select('prato_id,receita_id,qtd,unidade').in('prato_id',pratoIds);
    pratoReceitas = prc||[];
  }

  const recTotals = new Map();
  pratoReceitas.forEach(r=>{
    const pratoNome = (pratosTbl||[]).find(p=>p.id===r.prato_id)?.nome;
    if(!mediaPratoDia.has(pratoNome)) return;
    const mediaDia = mediaPratoDia.get(pratoNome) || 0;
    const add = mediaDia * (r.qtd||0);
    const prev = recTotals.get(r.receita_id) || {perDia:0,un:r.unidade||'g'};
    prev.perDia += add; prev.un = r.unidade||prev.un; recTotals.set(r.receita_id, prev);
  });

  const recIds=[...recTotals.keys()];
  let receitasMeta=new Map(), itensByRec=new Map();
  if(recIds.length){
    const {data:recMeta}=await supa.from('receitas').select('id,nome,unidade_rendimento,rendimento_qtd,perda_pct').in('id',recIds);
    receitasMeta = new Map((recMeta||[]).map(r=>[r.id,r]));
    const {data:itens}=await supa.from('receita_itens').select('id,receita_id,tipo,ref_id,qtd,unidade,perda_pct').in('receita_id',recIds);
    (itens||[]).forEach(it=>{ const arr=itensByRec.get(it.receita_id)||[]; arr.push(it); itensByRec.set(it.receita_id,arr); });
  }

  const tb=$('tblPrev').querySelector('tbody'); tb.innerHTML='';
  [...recTotals.entries()]
    .map(([id,agg])=>({id, nome: receitasMeta.get(id)?.nome || ('Receita #'+id), un: agg.un, dia: agg.perDia, proj: agg.perDia*proj}))
    .sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'))
    .forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${r.un}</td><td class="nowrap">${fmt(r.dia)}</td><td class="nowrap">${fmt(r.proj)}</td>`;
      tb.appendChild(tr);
    });

  $('kpi-dias').textContent = String(win);
  $('kpi-pratos').textContent = String(mediaPratoDia.size);
  $('kpi-rec').textContent = String(recTotals.size);
  $('prev-hint').textContent = `Janela: ${isoIni} → ${isoFim} (média baseada em ${win} dia(s)). Projeção para ${proj} dia(s).`;

  setStatus('Consolidando ingredientes…','');

  async function ensureRecipeLoaded(id){
    if(!receitasMeta.has(id)){
      const {data:rm}=await supa.from('receitas').select('id,nome,unidade_rendimento,rendimento_qtd,perda_pct').eq('id',id).maybeSingle();
      if(rm){ receitasMeta.set(id,rm); }
    }
    if(!itensByRec.has(id)){
      const {data:it}=await supa.from('receita_itens').select('id,receita_id,tipo,ref_id,qtd,unidade,perda_pct').eq('receita_id',id);
      itensByRec.set(id,it||[]);
    }
  }
  const ingr = new Map();
  const visiting = new Set();
  async function expandRecipe(recipeId, perDia, unit){
    await ensureRecipeLoaded(recipeId);
    const meta = receitasMeta.get(recipeId); if(!meta) return;
    const rendBase = toBase(meta.rendimento_qtd||1, meta.unidade_rendimento||unit);
    const prodBase = toBase(perDia, unit||meta.unidade_rendimento||'g');

    if(rendBase.u.toLowerCase()!==prodBase.u.toLowerCase()){
      const key=`I??-??`; const prev=ingr.get(key)||{qtdDia:0,un:prodBase.u,note:`Verificar unidade da receita #${recipeId}`}; ingr.set(key,prev); return;
    }

    const linhas = itensByRec.get(recipeId)||[];
    for(const it of linhas){
      const baseItem = toBase(it.qtd, it.unidade);
      const fator = (baseItem.v/(rendBase.v||1)) * (1 + (it.perda_pct||0)/100);
      if(it.tipo==='INGREDIENTE'){
        const needBase = prodBase.v * fator;
        const key = `I${it.ref_id}-${baseItem.u}`;
        const prev = ingr.get(key)||{qtdDia:0,un:baseItem.u,note:''};
        prev.qtdDia += needBase; ingr.set(key,prev);
      }else if(it.tipo==='RECEITA'){
        if(visiting.has(it.ref_id)) { continue; }
        visiting.add(it.ref_id);
        await expandRecipe(it.ref_id, prodBase.v * fator, meta.unidade_rendimento||'g');
        visiting.delete(it.ref_id);
      }
    }
  }
  for(const [rid,agg] of recTotals.entries()){ await expandRecipe(rid, agg.perDia, agg.un); }

  const validKeys = [...ingr.keys()].filter(k=>/^I\d+-/.test(k));
  const ingIds=[...new Set(validKeys.map(k=> +k.split('-')[0].substring(1)).filter(x=>!Number.isNaN(x)))];
  let nomes=new Map(); if(ingIds.length){ const {data}=await supa.from('ingredientes').select('id,nome'); nomes=new Map((data||[]).map(i=>[i.id,i.nome])); }

  const tbCompras=$('tblCompras').querySelector('tbody'); tbCompras.innerHTML='';
  validKeys.sort((a,b)=>a.localeCompare(b)).forEach(key=>{
    const id=+key.split('-')[0].substring(1);
    const agg=ingr.get(key);
    const nome=nomes.get(id)||(`Ingrediente #${id}`);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${nome}</td><td>${agg.un}</td><td class="nowrap">${fmt(agg.qtdDia)}</td><td>${agg.note||''}</td>`;
    tbCompras.appendChild(tr);
  });
  const ghost = [...ingr.entries()].filter(([k])=>!/^I\d+-/.test(k));
  ghost.forEach(([k,agg])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>—</td><td>${agg.un}</td><td class="nowrap">${fmt(agg.qtdDia)}</td><td>${agg.note||'Verificar itens/und'}</td>`;
    tbCompras.appendChild(tr);
  });

  setStatus('Pronto','ok');
}

/* ===== binds e handlers ===== */

// Botão para gerar modo de preparo
$('btnGeneratePreparo')?.addEventListener('click', async (e) => {
    if (draftItems.length === 0) {
        alert('Adicione pelo menos um item à grade antes de gerar o modo de preparo.');
        return;
    }
    const itemsText = draftItems.map(it => `- ${it.qtd} ${it.unidade} de ${it.nome}`).join('\n');
    const prompt = `Sou um chef de cozinha e estou criando uma ficha técnica. Com base nesta lista de ingredientes, gere um modo de preparo claro e conciso, em formato de passos numerados:\n\n${itemsText}\n\nModo de Preparo:`;
    const preparoText = await callGemini(prompt, e.target);
    if (preparoText) {
        $('rec-preparo').value = preparoText;
        setStatus('Modo de preparo gerado com sucesso!', 'ok');
    }
});

// Botão para gerar nome e descrição do prato
$('btnGenerateDesc')?.addEventListener('click', async (e) => {
    if (!pratoEditId) {
        alert('Salve o prato primeiro ou selecione um prato existente para editar antes de gerar a descrição.');
        return;
    }
    setStatus('Buscando componentes do prato...');
    let componentesText = '';
    try {
        const { data, error } = await supa.from('prato_receitas').select('receitas(nome)').eq('prato_id', pratoEditId);
        if (error) throw error;
        if (!data || data.length === 0) {
            alert('Este prato não tem receitas associadas. Adicione componentes na aba "Componentes" primeiro.');
            setStatus('Pronto', 'ok');
            return;
        }
        componentesText = data.map(item => `- ${item.receitas.nome}`).join('\n');
    } catch (ex) {
        setStatus('Erro ao buscar componentes: ' + (ex.message || ex), 'err');
        return;
    }

    const prompt = `Para um cardápio de restaurante, crie um nome criativo e uma descrição de venda curta e apetitosa para um prato que é composto pelos seguintes itens:\n\n${componentesText}\n\nO resultado deve ser em JSON, com as chaves "nome" e "descricao".\n\nExemplo de saída:\n{\n  "nome": "Strogonoff Magnífico da Casa",\n  "descricao": "Suculentos cubos de frango ao molho cremoso de champignon, acompanhado de arroz soltinho e batata palha crocante."\n}`;
    
    const resultJsonString = await callGemini(prompt, e.target);

    if (resultJsonString) {
        try {
            const cleanedJsonString = resultJsonString.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(cleanedJsonString);
            if (result.nome) $('prato-nome').value = result.nome;
            if (result.descricao) $('prato-descricao').value = result.descricao;
            setStatus('Nome e descrição gerados com sucesso!', 'ok');
        } catch (parseError) {
            console.error('Falha ao parsear JSON do Gemini:', parseError, 'Resposta crua:', resultJsonString);
            $('prato-descricao').value = resultJsonString;
            setStatus('Descrição gerada (formato inesperado).', 'warn');
        }
    }
});

// Handlers de edição/exclusão/toggle para Receitas
document.querySelector('#tblRec')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const { act, id } = btn.dataset;

    if (act === 'toggle') {
        try {
            const { data: rec } = await supa.from('receitas').select('ativo').eq('id', id).single();
            if (!rec) throw new Error('Receita não encontrada');
            const { error } = await supa.from('receitas').update({ ativo: !rec.ativo }).eq('id', id);
            if (error) throw error;
            await loadReceitas();
        } catch (ex) { alert(ex.message || ex); }
    } else if (act === 'del') {
        if (!confirm('Excluir receita e todos os seus itens?')) return;
        try {
            const { error } = await supa.from('receitas').delete().eq('id', id);
            if (error) throw error;
            await loadReceitas();
        } catch (ex) { alert(ex.message || ex); }
    } else if (act === 'edit') {
         $('recipe-editor-container').style.display = 'block';
         $('recipe-editor-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
        try {
            const { data: rec, error } = await supa.from('receitas').select('*').eq('id', id).single();
            if (error) throw error;
            if (!rec) return;
            
            $('recipe-form-title').textContent = 'Editar Receita';
            recEditId = id;
            $('rec-nome').value = rec.nome || '';
            $('rec-rend-qtd').value = rec.rendimento_qtd || '';
            $('rec-rend-und').value = rec.unidade_rendimento || 'g';
            $('rec-perda').value = rec.perda_pct || 0;
            $('rec-obs').value = rec.obs || '';
            $('rec-preparo').value = rec.modo_preparo || '';
            $('rec-codigo-barras').value = rec.codigo_barras || '';
            $('rec-qrcode').value = rec.qrcode || '';

            setStatus('Carregando itens da receita...');
            const { data: items, error: itemsError } = await supa.from('receita_itens').select('*').eq('receita_id', id);
            if (itemsError) throw itemsError;

            const itemPromises = items.map(async (it) => {
                let nome = '—';
                if (it.tipo === 'INGREDIENTE') {
                    const { data: ing } = await supa.from('ingredientes').select('nome').eq('id', it.ref_id).single();
                    nome = ing?.nome || '(ingrediente removido)';
                } else {
                    const { data: subRec } = await supa.from('receitas').select('nome').eq('id', it.ref_id).single();
                    nome = subRec?.nome || '(receita removida)';
                }
                return { ...it, nome, ref_id: it.ref_id, qtd: it.qtd, unidade: it.unidade, perda_pct: it.perda_pct, tipo: it.tipo };
            });
            
            draftItems = await Promise.all(itemPromises);
            renderDraft();
            setStatus('Pronto', 'ok');

            $('btnSaveRec').style.display = 'none';
            $('btnUpdateRec').style.display = 'inline-flex';
            $('btnCancelRecEdit').style.display = 'inline-flex';
            $('rec-nome').focus();
        } catch (ex) { 
            alert(ex.message || ex); 
            setStatus('Erro ao carregar receita para edição.', 'err');
        }
    }
});

// Handlers para Ingredientes
let ingEditId = null;
document.querySelector('#tblIng')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const { act, id } = btn.dataset;

    if (act === 'toggle') {
        try {
            const { data: ing } = await supa.from('ingredientes').select('ativo').eq('id', id).single();
            if (!ing) throw new Error('Ingrediente não encontrado');
            const { error } = await supa.from('ingredientes').update({ ativo: !ing.ativo }).eq('id', id);
            if (error) throw error;
            await loadIngredientes();
        } catch (ex) { alert(ex.message || ex); }
    } else if (act === 'del') {
        if (!confirm('Excluir ingrediente?')) return;
        try {
            const { error } = await supa.from('ingredientes').delete().eq('id', id);
            if (error) throw error;
            await loadIngredientes();
        } catch (ex) { alert(ex.message || ex); }
    } else if (act === 'edit') {
        try {
            const { data: ing, error } = await supa.from('ingredientes').select('*').eq('id', id).single();
            if (error) throw error;
            if (!ing) return;

            $('ingrediente-editor-container').style.display = 'block';
            $('ingrediente-form-title').textContent = 'Editar Ingrediente';
            ingEditId = id;
            $('ing-nome').value = ing.nome || '';
            $('ing-categoria').value = ing.categoria || 'Alimentos';
            $('ing-und').value = ing.unidade || 'kg';
            $('ing-custo').value = ing.custo_unitario || '';
            $('ing-obs').value = ing.obs || '';
            $('ing-codigo-barras').value = ing.codigo_barras || '';
            $('ing-qrcode').value = ing.qrcode || '';

            $('btnSaveIng').textContent = 'Salvar Alterações';
            $('btnCancelIngEdit').style.display = 'inline-flex';
            $('ing-nome').focus();
        } catch (ex) { alert(ex.message || ex); }
    }
});

$('btnSaveIng').addEventListener('click', async () => {
    const nome = $('ing-nome').value.trim();
    if (!nome) return alert('O nome do ingrediente é obrigatório.');
    const basePayload = { 
        nome, 
        categoria: $('ing-categoria').value,
        unidade: $('ing-und').value, 
        custo_unitario: ptToNumber($('ing-custo').value), 
        obs: $('ing-obs').value.trim() || null
    };

    try {
        if (ingEditId) {
            const { error } = await supa.from('ingredientes').update(basePayload).eq('id', ingEditId);
            if (error) throw error;
        } else {
            const newBarcode = `BAR-${crypto.randomUUID()}`;
            const newQrcode = `QR-${crypto.randomUUID()}`;
            const insertPayload = { 
                ...basePayload, 
                codigo_barras: newBarcode,
                qrcode: newQrcode,
                ativo: true 
            };
            const { error } = await supa.from('ingredientes').insert(insertPayload);
            if (error) throw error;
        }
        $('btnCancelIngEdit').click();
        await loadIngredientes();
        setStatus('Ingrediente salvo.', 'ok');
    } catch (ex) { setStatus('Erro ao salvar ingrediente: ' + (ex.message || ex), 'err'); }
});
$('btnCancelIngEdit').addEventListener('click', () => {
    ingEditId = null;
    $('ingrediente-editor-container').style.display = 'none';
    $('ingrediente-form-title').textContent = 'Novo Ingrediente';
    $('ing-nome').value = '';
    $('ing-categoria').value = 'Alimentos';
    $('ing-und').value = 'kg';
    $('ing-custo').value = '';
    $('ing-obs').value = '';
    $('ing-codigo-barras').value = '';
    $('ing-qrcode').value = '';
    $('btnSaveIng').textContent = 'Salvar';
});

// Botão para mostrar formulário de nova receita
$('btnShowNewRecipeForm').addEventListener('click', () => {
    $('btnCancelRecEdit').click(); // Reseta o formulário e o estado
    $('recipe-editor-container').style.display = 'block';
    $('recipe-editor-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// Botão para mostrar formulário de novo ingrediente
$('btnShowNewIngredienteForm').addEventListener('click', () => {
    $('btnCancelIngEdit').click();
    $('ingrediente-editor-container').style.display = 'block';
});

document.getElementById('btnCalcularPrev').addEventListener('click',calcularPrevisaoReal);
document.getElementById('btnExportPrev').addEventListener('click',()=> alert('Exportar PDF: pronto para integrar.'));

/* ===== loaders ===== */
async function backfillUniqueCodes(tableName) {
    try {
        const { data, error } = await supa.from(tableName).select('id, qrcode').is('qrcode', null);

        if (error) {
            if (error.code === '42703') { // "column does not exist" error code in PostgreSQL
                 console.warn(`Aviso: A tabela '${tableName}' não possui as colunas 'codigo_barras' e/ou 'qrcode'. Por favor, adicione-as no seu banco de dados Supabase para que os códigos possam ser salvos.`);
                 setStatus(`Aviso: Tabela '${tableName}' não configurada para códigos.`, 'warn');
            } else {
                console.warn(`Não foi possível verificar códigos para ${tableName}. Erro: ${error.message}`);
            }
            return;
        }

        if (data && data.length > 0) {
            setStatus(`Atualizando ${data.length} registros antigos em ${tableName}...`, 'ok');
            
            for (const item of data) {
                 const newBarcode = `BAR-${crypto.randomUUID()}`;
                 const newQrcode = `QR-${crypto.randomUUID()}`;
                 const { error: updateError } = await supa.from(tableName)
                    .update({
                        codigo_barras: newBarcode,
                        qrcode: newQrcode
                    })
                    .eq('id', item.id);

                if (updateError) {
                    console.error(`Erro ao atualizar item ${item.id} na tabela ${tableName}:`, updateError);
                    // Continue to the next item even if one fails
                }
            }
            console.log(`${data.length} registros verificados em ${tableName}.`);
        }
    } catch (ex) {
        console.error(`Erro ao preencher códigos para ${tableName}:`, ex);
    }
}
async function loadPratos(){
  try{
    let data=null,error=null; ({data,error}=await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true}));
    if(error){ ({data,error}=await supa.from('pratos').select('*').order('nome',{ascending:true})); }
    pratos=data||[]; renderPratos();
    await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true});
  }catch(e){ pratos=[]; renderPratos(); setStatus('Não foi possível carregar pratos: '+(e.message||e),'err'); }
}

/* ===== MÓDULO DE ESTOQUE ===== */
const EstoqueModule = {
    currentMovType: null,
    stream: null,
    
    init() {
        $$('.mov-actions .btn').forEach(btn => btn.addEventListener('click', (e) => this.showMovForm(e.currentTarget.dataset.movType)));
        $('btnMovCancel').addEventListener('click', () => this.hideMovForm());
        $('frmMov')?.addEventListener('submit', (e) => this.handleMovimentacao(e));
        $('mov-item-tipo')?.addEventListener('change', () => this.populateItemsDropdown());
        $('btnMovScan').addEventListener('click', () => this.toggleCamera());
        this.loadInitialData();
    },

    async loadInitialData() {
        await this.populateUnidadesDropdown();
        await this.populateItemsDropdown();
        await this.loadRecentMovs();
        await this.loadSaldos();
    },

    async populateUnidadesDropdown() {
        await fillOptionsFrom('unidades', 'mov-unidade-origem', 'id', 'nome');
        await fillOptionsFrom('unidades', 'mov-unidade-destino', 'id', 'nome');
        await fillOptionsFrom('unidades', 'filtro-unidade-estoque', 'id', 'nome');
    },
    
    async populateItemsDropdown() {
        const tipo = $('mov-item-tipo').value;
        const tabela = (tipo === 'ING') ? 'ingredientes' : 'receitas';
        await fillOptionsFrom(tabela, 'mov-item', 'id', 'nome', { ativo: true });
    },

    showMovForm(type) {
        this.currentMovType = type;
        const container = $('mov-form-container');
        container.style.display = 'block';
        $('frmMov').reset();

        // Hide all conditional fields by default
        $('mov-unidade-origem-group').style.display = 'none';
        $('mov-unidade-destino-group').style.display = 'none';
        $('mov-validade-group').style.display = 'none';
        $('mov-custo-group').style.display = 'none';
        $('mov-ajuste-sinal-group').style.display = 'none';


        switch(type) {
            case 'ENTRADA':
                $('mov-form-title').textContent = 'Registrar Entrada';
                $('mov-unidade-destino-group').style.display = 'block';
                $('mov-validade-group').style.display = 'block';
                $('mov-custo-group').style.display = 'block';
                $('btnMovSubmit').textContent = 'Registrar Entrada';
                break;
            case 'SAIDA':
                 $('mov-form-title').textContent = 'Registrar Saída';
                 $('mov-unidade-origem-group').style.display = 'block';
                 $('btnMovSubmit').textContent = 'Registrar Saída';
                 break;
            case 'TRANSFERENCIA':
                $('mov-form-title').textContent = 'Registrar Transferência';
                $('mov-unidade-origem-group').style.display = 'block';
                $('mov-unidade-destino-group').style.display = 'block';
                $('btnMovSubmit').textContent = 'Transferir';
                break;
            case 'AJUSTE':
                $('mov-form-title').textContent = 'Registrar Ajuste';
                $('mov-unidade-origem-group').style.display = 'block'; // Unidade a ser ajustada
                $('mov-ajuste-sinal-group').style.display = 'block';
                $('btnMovSubmit').textContent = 'Ajustar';
                break;
        }
    },

    hideMovForm() {
        $('mov-form-container').style.display = 'none';
        this.stopCamera();
    },
    
    async handleMovimentacao(e) {
        e.preventDefault();
        const tipoMov = this.currentMovType;
        let rpcName = '';
        let payload = {};

        const item_tipo = $('mov-item-tipo').value;
        const item_id = $('mov-item').value;
        const qtd = ptToNumber($('mov-qtd').value);
        const un = $('mov-un').value;
        const doc = $('mov-doc').value || null;

        try {
            switch(tipoMov) {
                case 'ENTRADA':
                    rpcName = 'rpc_entrada';
                    payload = {
                        p_unidade_id: $('mov-unidade-destino').value,
                        p_item_tipo: item_tipo,
                        p_item_id: item_id,
                        p_lote: $('mov-lote').value || 'LOTE_PADRAO',
                        p_qtd: qtd,
                        p_un: un,
                        p_validade: $('mov-validade').value || null,
                        p_custo_unit: ptToNumber($('mov-custo').value),
                        p_ref_doc: doc
                    };
                    break;
                case 'SAIDA':
                    rpcName = 'rpc_saida';
                    payload = {
                        p_unidade_id: $('mov-unidade-origem').value,
                        p_item_tipo: item_tipo,
                        p_item_id: item_id,
                        p_qtd: qtd,
                        p_un: un,
                        p_ref_doc: doc,
                        p_tipo_saida: 'SAIDA'
                    };
                    break;
                case 'TRANSFERENCIA':
                    rpcName = 'rpc_transferencia';
                     payload = {
                        p_origem_id: $('mov-unidade-origem').value,
                        p_destino_id: $('mov-unidade-destino').value,
                        p_item_tipo: item_tipo,
                        p_item_id: item_id,
                        p_qtd: qtd,
                        p_un: un,
                        p_lote: $('mov-lote').value || null,
                        p_obs: doc
                    };
                    break;
                case 'AJUSTE':
                    rpcName = 'rpc_ajuste_estoque';
                    const sinal = $('mov-ajuste-sinal').value;
                    payload = {
                        p_unidade_id: $('mov-unidade-origem').value,
                        p_item_tipo: item_tipo,
                        p_item_id: item_id,
                        p_lote: $('mov-lote').value || null,
                        p_qtd: sinal === '+' ? qtd : -qtd,
                        p_un: un,
                        p_obs: doc
                    };
                    break;
                default:
                    throw new Error("Tipo de movimentação desconhecido.");
            }

            if (!payload.p_unidade_id && !payload.p_origem_id) {
                alert('Unidade de origem/destino é obrigatória.');
                return;
            }

            setStatus('Registrando movimentação...', '');
            const { data, error } = await supa.rpc(rpcName, payload);
            if (error) throw error;
            
            setStatus('Movimentação registrada com sucesso!', 'ok');
            this.hideMovForm();
            await this.loadRecentMovs();
            await this.loadSaldos();
        
        } catch(ex) {
            console.error('Erro na movimentação:', ex);
            setStatus('Erro ao registrar: ' + (ex.message || 'Verifique os dados'), 'err');
        }
    },
    
    toggleCamera() {
        if(this.stream) {
            this.stopCamera();
        } else {
            this.startCamera();
        }
    },

    startCamera() {
        const video = $('qr-video');
        video.style.display = 'block';
        $('btnMovScan').textContent = '📷 Parar Câmera';
        
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
            this.stream = stream;
            video.srcObject = stream;
            video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
            video.play();
            requestAnimationFrame(() => this.tick());
        }).catch(err => {
            console.error("Erro ao acessar a câmera: ", err);
            setStatus("Erro ao acessar a câmera.", "err");
            this.stopCamera();
        });
    },

    stopCamera() {
        if(this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
        }
        this.stream = null;
        $('qr-video').style.display = 'none';
        $('btnMovScan').textContent = '📷 Scan QR';
    },

    tick() {
        const video = $('qr-video');
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const canvasElement = document.createElement('canvas');
            const canvas = canvasElement.getContext("2d");
            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                $('qr-result').textContent = `Código detectado: ${code.data}`;
                // Aqui você pode adicionar a lógica para preencher o formulário
                this.stopCamera();
            }
        }
        if(this.stream) {
            requestAnimationFrame(() => this.tick());
        }
    },
    
    async loadRecentMovs() {
        const tb = $('tblMovRecentes')?.querySelector('tbody');
        if(!tb) return;
        tb.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
        try {
            const { data, error } = await supa.rpc('rpc_get_recent_movs', { p_limit: 20 });
            if(error) throw error;
            tb.innerHTML = '';
            data.forEach(mov => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(mov.ts).toLocaleTimeString('pt-BR')}</td>
                    <td>${mov.tipo}</td>
                    <td>${mov.item_nome || 'N/D'}</td>
                    <td>${mov.qtd}</td>
                    <td>${mov.unidade_nome || 'N/D'}</td>
                `;
                tb.appendChild(tr);
            });
        } catch(ex) {
            console.error(ex);
            tb.innerHTML = '<tr><td colspan="5">Erro ao carregar. Verifique se a RPC `rpc_get_recent_movs` foi criada (execute o SQL).</td></tr>';
        }
    },
    
    async loadSaldos() {
       // Placeholder para carregar saldos e KPIs
    }
};


async function init(){
  try{
    await backfillUniqueCodes('pratos');
    await backfillUniqueCodes('receitas');
    await backfillUniqueCodes('ingredientes');
    await loadPratos(); await loadReceitas(); await loadIngredientes(); await preencherCategorias(); await loadDash?.();
    EstoqueModule.init(); // Inicializa o módulo de estoque
    setStatus('Pronto','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
}
document.addEventListener('DOMContentLoaded',init);
</script>

<!-- Cadastros Overlay Addon | injected 2025-09-07T03:26:40.598948Z -->
<style id="cadastros-addon-style">
  #cad-btn-open {
    position: fixed; right: 16px; bottom: 16px; z-index: 9999;
    padding: 10px 14px; border-radius: 9999px; border: none; cursor: pointer;
    background: #0ea5e9; color: white; box-shadow: 0 6px 24px rgba(0,0,0,.2);
    font-weight: 600;
  }
  #cad-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 9998; display: none; }
  #cad-modal { position: fixed; right: 0; top: 0; height: 100vh; width: min(980px, 100vw); background: #0b1020; color: #e5e7eb; z-index: 99999; display: none; box-shadow: -16px 0 48px rgba(0,0,0,.45); }
  #cad-modal .cad-header { display:flex; align-items:center; justify-content:space-between; padding: 14px 18px; background: #0f172a; border-bottom: 1px solid #1f2a44; }
  #cad-modal .cad-tabs { display:flex; gap: 8px; padding: 8px 14px; background:#0b1020; border-bottom: 1px solid #1f2a44; flex-wrap: wrap; }
  .cad-tab-btn { padding: 8px 12px; border-radius: 10px; cursor:pointer; background:#111827; color:#e5e7eb; border:1px solid #1f2937; }
  .cad-tab-btn.active { background:#2563eb; border-color:#2563eb; }
  .cad-section { display:none; padding: 12px 16px; overflow:auto; height: calc(100vh - 120px); }
  .cad-actions { display:flex; gap:8px; margin: 8px 0 12px; }
  .cad-input { background:#0b1223; border:1px solid #1f2a44; color:#e5e7eb; border-radius:8px; padding:8px 10px; width:100%; }
  .cad-label { font-size:12px; color:#94a3b8; margin-top:8px; display:block; }
  .cad-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; }
  .col-3 { grid-column: span 3 / span 3; }
  .col-4 { grid-column: span 4 / span 4; }
  .col-6 { grid-column: span 6 / span 6; }
  .col-8 { grid-column: span 8 / span 8; }
  .col-12 { grid-column: 1 / -1; }
  .cad-table { width:100%; border-collapse: collapse; }
  .cad-table th, .cad-table td { border-bottom: 1px solid #1f2a44; padding: 8px 6px; font-size: 13px; }
  .cad-table th { text-align:left; color:#93c5fd; background:#0f172a; position: sticky; top: 0; }
  .cad-btn { padding: 8px 10px; border-radius: 8px; border: 1px solid #1f2a44; background:#0b1223; color:#e5e7eb; cursor:pointer; }
  .cad-btn.primary { background:#22c55e; border-color:#16a34a; color:#032511; font-weight:700; }
  .cad-badge { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:9999px; font-size:12px; border:1px solid #1f2a44; background:#0b1223; }
  .cad-badge.ok { color:#22c55e; border-color:#14532d; }
  .cad-badge.no { color:#f97316; border-color:#7c2d12; }
  .cad-help { color:#9ca3af; font-size:12px; }
</style>
<button id="cad-btn-open" title="Cadastros">Cadastros</button>
<div id="cad-modal-backdrop"></div>
<aside id="cad-modal" aria-hidden="true" role="dialog">
  <div class="cad-header">
    <div style="display:flex; align-items:center; gap:10px;">
      <strong style="letter-spacing:.3px">Cadastros</strong>
      <span class="cad-help">Gerencie unidades de medida, unidades (destino), categorias e tipos de item.</span>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <button class="cad-btn" id="cad-btn-reload">Recarregar</button>
      <button class="cad-btn" id="cad-btn-close">Fechar</button>
    </div>
  </div>
  <nav class="cad-tabs">
    <button class="cad-tab-btn active" data-tab="um">Unidades de Medida</button>
    <button class="cad-tab-btn" data-tab="un">Unidades (Destino)</button>
    <button class="cad-tab-btn" data-tab="cat">Categorias</button>
    <button class="cad-tab-btn" data-tab="tipo">Tipos de Item</button>
  </nav>
  <section class="cad-section" id="cad-tab-um" style="display:block;">
    <div class="cad-actions">
      <button class="cad-btn primary" id="um-btn-add">Nova UM</button>
      <span class="cad-help">Campos: sigla, nome, código, base, fator, ativo.</span>
    </div>
    <div class="cad-grid">
      <div class="col-12">
        <table class="cad-table" id="um-table">
          <thead><tr>
            <th>Sigla</th><th>Nome</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th style="width:160px">Ações</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
  <section class="cad-section" id="cad-tab-un">
    <div class="cad-actions">
      <button class="cad-btn primary" id="un-btn-add">Nova Unidade</button>
      <span class="cad-help">Cadastre locais de estoque (ex.: Depósito, Loja Centro).</span>
    </div>
    <div class="cad-grid">
      <div class="col-12">
        <table class="cad-table" id="un-table">
          <thead><tr>
            <th>Nome</th><th>Ativo</th><th style="width:160px">Ações</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
  <section class="cad-section" id="cad-tab-cat">
    <div class="cad-actions">
      <button class="cad-btn primary" id="cat-btn-add">Nova Categoria</button>
      <span class="cad-help">Campos: nome, tipo (opcional), ativo.</span>
    </div>
    <div class="cad-grid">
      <div class="col-12">
        <table class="cad-table" id="cat-table">
          <thead><tr>
            <th>Nome</th><th>Tipo</th><th>Ativo</th><th style="width:160px">Ações</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
  <section class="cad-section" id="cad-tab-tipo">
    <div class="cad-actions">
      <button class="cad-btn primary" id="tipo-btn-add">Novo Tipo</button>
      <span class="cad-help">Ex.: ING (Ingrediente), PRD (Produto acabado), INS (Insumo), etc.</span>
    </div>
    <div class="cad-grid">
      <div class="col-12">
        <table class="cad-table" id="tipo-table">
          <thead><tr>
            <th>Código</th><th>Nome</th><th>Ativo</th><th style="width:160px">Ações</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</aside>
<script id="cadastros-addon-script">
(function(){  // isolate scope
  const SB_URL = 'https://rqeagimulvgfecvuzubk.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
  const HDRS = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };
  const q = (sel, root=document) => root.querySelector(sel);
  const qa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // ---------- Helpers ----------
  function show(el) { el.style.display = 'block'; }
  function hide(el) { el.style.display = 'none'; }
  function fmtBool(v) { return v ? '<span class="cad-badge ok">Ativo</span>' : '<span class="cad-badge no">Inativo</span>'; }
  function toNumber(x, d=0) { const n = Number(x); return Number.isFinite(n) ? n : d; }
  async function apiSelect(table, selectCols) {
    // Try multiple select variants for schema compat
    const tries = Array.isArray(selectCols) ? selectCols : [selectCols];
    for (const sel of tries) {
      const url = new URL(`/rest/v1/${table}`, SB_URL);
      if (sel) url.searchParams.set('select', sel);
      // default order by nome if exists
      url.searchParams.set('order','nome.asc,nullsfirst');
      try {
        const r = await fetch(url, { headers: HDRS });
        const ok = r.ok;
        const data = await r.json().catch(()=>([]));
        if (ok) return { ok:true, data };
        // if 400, continue trying
      } catch (e) {
        // continue
      }
    }
    return { ok:false, data:[], error: `Falha ao consultar ${table}` };
  }
  async function apiInsert(table, row) {
    const url = new URL(`/rest/v1/${table}`, SB_URL);
    const r = await fetch(url, { method: 'POST', headers: HDRS, body: JSON.stringify(row) });
    const data = await r.json().catch(()=>[]);
    return { ok: r.ok, data, status: r.status, error: r.ok ? null : data };
  }
  async function apiPatchById(table, id, row) {
    const url = new URL(`/rest/v1/${table}`, SB_URL);
    url.searchParams.set('id','eq.' + id);
    const r = await fetch(url, { method: 'PATCH', headers: HDRS, body: JSON.stringify(row) });
    const data = await r.json().catch(()=>[]);
    return { ok: r.ok, data, status: r.status, error: r.ok ? null : data };
  }
  async function apiDeleteById(table, id) {
    const url = new URL(`/rest/v1/${table}`, SB_URL);
    url.searchParams.set('id','eq.' + id);
    const r = await fetch(url, { method: 'DELETE', headers: HDRS });
    return { ok: r.ok, status: r.status };
  }
  function confirmDelete() { return window.confirm('Confirma excluir este registro?'); }

  // ---------- Modal open/close ----------
  const btnOpen = q('#cad-btn-open');
  const btnClose = q('#cad-btn-close');
  const btnReload = q('#cad-btn-reload');
  const modal = q('#cad-modal');
  const backdrop = q('#cad-modal-backdrop');
  btnOpen.addEventListener('click', () => { show(modal); show(backdrop); loadAll(); });
  btnClose.addEventListener('click', () => { hide(modal); hide(backdrop); });
  backdrop.addEventListener('click', () => { hide(modal); hide(backdrop); });
  btnReload.addEventListener('click', () => loadAll());

  // ---------- Tabs ----------
  qa('.cad-tab-btn').forEach(b => b.addEventListener('click', () => {
    qa('.cad-tab-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    qa('.cad-section').forEach(x => hide(x));
    const tab = b.dataset.tab;
    show(q('#cad-tab-' + tab));
  }));

  // ---------- Unidades de Medida ----------
  async function loadUM() {
    const tbody = q('#um-table tbody');
    tbody.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
    const res = await apiSelect('unidades_medida', [
      'id,sigla,nome,codigo,base,fator,ativo',
      'id,sigla,nome,codigo,base,ativo',
      '*'
    ]);
    if (!res.ok) { tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar UM.</td></tr>'; return; }
    const rows = res.data;
    tbody.innerHTML='';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.sigla ?? ''}</td>
        <td>${r.nome ?? ''}</td>
        <td>${r.codigo ?? ''}</td>
        <td>${r.base ?? ''}</td>
        <td>${r.fator ?? ''}</td>
        <td>${fmtBool(r.ativo !== false)} </td>
        <td>
          <button class="cad-btn" data-id="${r.id}" data-kind="um-edit">Editar</button>
          <button class="cad-btn" data-id="${r.id}" data-kind="um-del">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    }
  }
  q('#um-btn-add').addEventListener('click', () => editUM());
  q('#um-table').addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    const kind = btn.dataset.kind;
    if (kind==='um-edit') return editUM(id);
    if (kind==='um-del') {
      if (!confirmDelete()) return;
      const {ok} = await apiDeleteById('unidades_medida', id);
      if (ok) loadUM(); else alert('Erro ao excluir.');
    }
  });
  function editUM(id=null) {
    const dlg = document.createElement('div');
    dlg.innerHTML = `
      <div style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100000;"></div>
      <div style="position:fixed; top:10%; left:50%; transform:translateX(-50%); width:min(720px, 96vw); background:#0f172a; border:1px solid #1f2a44; border-radius:12px; z-index:100001;">
        <div style="padding:12px 16px; display:flex; justify-content:space-between; align-items:center;">
          <strong>${id?'Editar':'Nova'} Unidade de Medida</strong>
          <button class="cad-btn" data-x="x">Fechar</button>
        </div>
        <div style="padding:12px 16px;">
          <div class="cad-grid">
            <div class="col-3"><label class="cad-label">Sigla</label><input class="cad-input" id="um_sigla"></div>
            <div class="col-6"><label class="cad-label">Nome</label><input class="cad-input" id="um_nome"></div>
            <div class="col-3"><label class="cad-label">Código</label><input class="cad-input" id="um_codigo"></div>
            <div class="col-4"><label class="cad-label">Base</label><input class="cad-input" id="um_base" placeholder="g, ml, un, ..."></div>
            <div class="col-4"><label class="cad-label">Fator</label><input class="cad-input" id="um_fator" type="number" step="0.000001" value="1"></div>
            <div class="col-4"><label class="cad-label">Ativo</label>
              <select class="cad-input" id="um_ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
              <button class="cad-btn" data-x="save">Salvar</button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(dlg);
    const close = () => dlg.remove();
    dlg.addEventListener('click', (e)=>{ if(e.target.dataset.x==='x') close(); });
    const btnSave = dlg.querySelector('[data-x="save"]');
    (async () => {
      if (id) {
        // fetch single
        const url = new URL('/rest/v1/unidades_medida', SB_URL);
        url.searchParams.set('select','id,sigla,nome,codigo,base,fator,ativo');
        url.searchParams.set('id','eq.'+id);
        const r = await fetch(url, { headers: HDRS });
        const arr = await r.json();
        const rec = arr[0] || {};
        dlg.querySelector('#um_sigla').value = rec.sigla ?? '';
        dlg.querySelector('#um_nome').value  = rec.nome ?? '';
        dlg.querySelector('#um_codigo').value= rec.codigo ?? '';
        dlg.querySelector('#um_base').value  = rec.base ?? '';
        dlg.querySelector('#um_fator').value = rec.fator ?? 1;
        dlg.querySelector('#um_ativo').value = String(rec.ativo !== false);
      }
    })();
    btnSave.addEventListener('click', async () => {
      const row = {
        sigla: (dlg.querySelector('#um_sigla').value||'').trim() || null,
        nome:  (dlg.querySelector('#um_nome').value||'').trim() || null,
        codigo:(dlg.querySelector('#um_codigo').value||'').trim() || null,
        base:  (dlg.querySelector('#um_base').value||'').trim() || null,
        fator: Number(dlg.querySelector('#um_fator').value)||1,
        ativo: dlg.querySelector('#um_ativo').value==='true'
      };
      let res;
      if (id) res = await apiPatchById('unidades_medida', id, row);
      else    res = await apiInsert('unidades_medida', row);
      if (!res.ok) alert('Erro ao salvar UM: ' + JSON.stringify(res.error));
      else { close(); loadUM(); }
    });
  }

  // ---------- Unidades (Destino) ----------
  async function loadUnidades() {
    const tbody = q('#un-table tbody');
    tbody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
    const res = await apiSelect('unidades', [
      'id,nome,ativo',
      '*'
    ]);
    if (!res.ok) { tbody.innerHTML = '<tr><td colspan="3">Erro ao carregar unidades.</td></tr>'; return; }
    const rows = res.data;
    tbody.innerHTML='';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.nome ?? ''}</td>
        <td>${fmtBool(r.ativo !== false)}</td>
        <td>
          <button class="cad-btn" data-id="${r.id}" data-kind="un-edit">Editar</button>
          <button class="cad-btn" data-id="${r.id}" data-kind="un-del">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    }
  }
  q('#un-btn-add').addEventListener('click', () => editUnidade());
  q('#un-table').addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    const kind = btn.dataset.kind;
    if (kind==='un-edit') return editUnidade(id);
    if (kind==='un-del') {
      if (!confirmDelete()) return;
      const {ok} = await apiDeleteById('unidades', id);
      if (ok) loadUnidades(); else alert('Erro ao excluir.');
    }
  });
  function editUnidade(id=null) {
    const dlg = document.createElement('div');
    dlg.innerHTML = `
      <div style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100000;"></div>
      <div style="position:fixed; top:12%; left:50%; transform:translateX(-50%); width:min(640px, 96vw); background:#0f172a; border:1px solid #1f2a44; border-radius:12px; z-index:100001;">
        <div style="padding:12px 16px; display:flex; justify-content:space-between; align-items:center;">
          <strong>${id?'Editar':'Nova'} Unidade</strong>
          <button class="cad-btn" data-x="x">Fechar</button>
        </div>
        <div style="padding:12px 16px;">
          <div class="cad-grid">
            <div class="col-8"><label class="cad-label">Nome</label><input class="cad-input" id="un_nome"></div>
            <div class="col-4"><label class="cad-label">Ativo</label>
              <select class="cad-input" id="un_ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
              <button class="cad-btn" data-x="save">Salvar</button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(dlg);
    const close = () => dlg.remove();
    dlg.addEventListener('click', (e)=>{ if(e.target.dataset.x==='x') close(); });
    const btnSave = dlg.querySelector('[data-x="save"]');
    (async () => {
      if (id) {
        const url = new URL('/rest/v1/unidades', SB_URL);
        url.searchParams.set('select','id,nome,ativo');
        url.searchParams.set('id','eq.'+id);
        const r = await fetch(url, { headers: HDRS });
        const rec = (await r.json())[0]||{};
        dlg.querySelector('#un_nome').value  = rec.nome??'';
        dlg.querySelector('#un_ativo').value = String(rec.ativo !== false);
      }
    })();
    btnSave.addEventListener('click', async () => {
      const row = {
        nome:  (dlg.querySelector('#un_nome').value||'').trim()||null,
        ativo: dlg.querySelector('#un_ativo').value==='true'
      };
      let res;
      if (id) res = await apiPatchById('unidades', id, row);
      else    res = await apiInsert('unidades', row);
      if (!res.ok) alert('Erro ao salvar unidade: ' + JSON.stringify(res.error));
      else { close(); loadUnidades(); }
    });
  }

  // ---------- Categorias ----------
  async function loadCategorias() {
    const tbody = q('#cat-table tbody');
    tbody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
    const res = await apiSelect('categorias', [
      'id,nome,tipo,ativo',
      'id,nome,ativo',
      '*'
    ]);
    if (!res.ok) { tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar categorias.</td></tr>'; return; }
    const rows = res.data;
    tbody.innerHTML='';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.nome ?? ''}</td>
        <td>${r.tipo ?? '—'}</td>
        <td>${fmtBool(r.ativo !== false)}</td>
        <td>
          <button class="cad-btn" data-id="${r.id}" data-kind="cat-edit">Editar</button>
          <button class="cad-btn" data-id="${r.id}" data-kind="cat-del">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    }
  }
  q('#cat-btn-add').addEventListener('click', () => editCategoria());
  q('#cat-table').addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    const kind = btn.dataset.kind;
    if (kind==='cat-edit') return editCategoria(id);
    if (kind==='cat-del') {
      if (!confirmDelete()) return;
      const {ok} = await apiDeleteById('categorias', id);
      if (ok) loadCategorias(); else alert('Erro ao excluir.');
    }
  });
  function editCategoria(id=null) {
    const dlg = document.createElement('div');
    dlg.innerHTML = `
      <div style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100000;"></div>
      <div style="position:fixed; top:12%; left:50%; transform:translateX(-50%); width:min(680px, 96vw); background:#0f172a; border:1px solid #1f2a44; border-radius:12px; z-index:100001;">
        <div style="padding:12px 16px; display:flex; justify-content:space-between; align-items:center;">
          <strong>${id?'Editar':'Nova'} Categoria</strong>
          <button class="cad-btn" data-x="x">Fechar</button>
        </div>
        <div style="padding:12px 16px;">
          <div class="cad-grid">
            <div class="col-6"><label class="cad-label">Nome</label><input class="cad-input" id="cat_nome"></div>
            <div class="col-3"><label class="cad-label">Tipo (opcional)</label><input class="cad-input" id="cat_tipo" placeholder="ex.: INGREDIENTE"></div>
            <div class="col-3"><label class="cad-label">Ativo</label>
              <select class="cad-input" id="cat_ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
              <button class="cad-btn" data-x="save">Salvar</button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(dlg);
    const close = () => dlg.remove();
    dlg.addEventListener('click', (e)=>{ if(e.target.dataset.x==='x') close(); });
    const btnSave = dlg.querySelector('[data-x="save"]');
    (async () => {
      if (id) {
        const url = new URL('/rest/v1/categorias', SB_URL);
        url.searchParams.set('select','id,nome,tipo,ativo');
        url.searchParams.set('id','eq.'+id);
        const r = await fetch(url, { headers: HDRS });
        const rec = (await r.json())[0]||{};
        dlg.querySelector('#cat_nome').value  = rec.nome??'';
        dlg.querySelector('#cat_tipo').value  = rec.tipo??'';
        dlg.querySelector('#cat_ativo').value = String(rec.ativo !== false);
      }
    })();
    btnSave.addEventListener('click', async () => {
      const row = {
        nome:  (dlg.querySelector('#cat_nome').value||'').trim()||null,
        ativo: dlg.querySelector('#cat_ativo').value==='true'
      };
      const tipo = (dlg.querySelector('#cat_tipo').value||'').trim();
      if (tipo) row.tipo = tipo;
      let res;
      if (id) res = await apiPatchById('categorias', id, row);
      else    res = await apiInsert('categorias', row);
      if (!res.ok) alert('Erro ao salvar categoria: ' + JSON.stringify(res.error));
      else { close(); loadCategorias(); }
    });
  }

  // ---------- Tipos de Item ----------
  async function loadTipos() {
    const tbody = q('#tipo-table tbody');
    tbody.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
    const res = await apiSelect('item_tipos', [
      'id,codigo,nome,ativo',
      '*'
    ]);
    if (!res.ok) { tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar tipos.</td></tr>'; return; }
    const rows = res.data;
    tbody.innerHTML='';
    for (const r of rows) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.codigo ?? ''}</td>
        <td>${r.nome ?? ''}</td>
        <td>${fmtBool(r.ativo !== false)}</td>
        <td>
          <button class="cad-btn" data-id="${r.id}" data-kind="tipo-edit">Editar</button>
          <button class="cad-btn" data-id="${r.id}" data-kind="tipo-del">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    }
  }
  q('#tipo-btn-add').addEventListener('click', () => editTipo());
  q('#tipo-table').addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const id = btn.dataset.id;
    const kind = btn.dataset.kind;
    if (kind==='tipo-edit') return editTipo(id);
    if (kind==='tipo-del') {
      if (!confirmDelete()) return;
      const {ok} = await apiDeleteById('item_tipos', id);
      if (ok) loadTipos(); else alert('Erro ao excluir.');
    }
  });
  function editTipo(id=null) {
    const dlg = document.createElement('div');
    dlg.innerHTML = `
      <div style="position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100000;"></div>
      <div style="position:fixed; top:12%; left:50%; transform:translateX(-50%); width:min(640px, 96vw); background:#0f172a; border:1px solid #1f2a44; border-radius:12px; z-index:100001;">
        <div style="padding:12px 16px; display:flex; justify-content:space-between; align-items:center;">
          <strong>${id?'Editar':'Novo'} Tipo</strong>
          <button class="cad-btn" data-x="x">Fechar</button>
        </div>
        <div style="padding:12px 16px;">
          <div class="cad-grid">
            <div class="col-4"><label class="cad-label">Código</label><input class="cad-input" id="tipo_codigo" placeholder="ex.: ING"></div>
            <div class="col-6"><label class="cad-label">Nome</label><input class="cad-input" id="tipo_nome" placeholder="Ingrediente"></div>
            <div class="col-2"><label class="cad-label">Ativo</label>
              <select class="cad-input" id="tipo_ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="col-12" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
              <button class="cad-btn" data-x="save">Salvar</button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.appendChild(dlg);
    const close = () => dlg.remove();
    dlg.addEventListener('click', (e)=>{ if(e.target.dataset.x==='x') close(); });
    (async () => {
      if (id) {
        const url = new URL('/rest/v1/item_tipos', SB_URL);
        url.searchParams.set('select','id,codigo,nome,ativo');
        url.searchParams.set('id','eq.'+id);
        const r = await fetch(url, { headers: HDRS });
        const rec = (await r.json())[0]||{};
        dlg.querySelector('#tipo_codigo').value = rec.codigo??'';
        dlg.querySelector('#tipo_nome').value   = rec.nome??'';
        dlg.querySelector('#tipo_ativo').value  = String(rec.ativo !== false);
      }
    })();
    dlg.querySelector('[data-x="save"]').addEventListener('click', async () => {
      const row = {
        codigo: (dlg.querySelector('#tipo_codigo').value||'').trim()||null,
        nome:   (dlg.querySelector('#tipo_nome').value||'').trim()||null,
        ativo:  dlg.querySelector('#tipo_ativo').value==='true'
      };
      let res;
      if (id) res = await apiPatchById('item_tipos', id, row);
      else    res = await apiInsert('item_tipos', row);
      if (!res.ok) alert('Erro ao salvar tipo: ' + JSON.stringify(res.error));
      else { close(); loadTipos(); }
    });
  }

  async function loadAll() {
    await Promise.all([ loadUM(), loadUnidades(), loadCategorias(), loadTipos() ]);
  }
})();
</script>

<script>
(function(){
  try{
    var fav = document.querySelector('link[rel="icon"]');
    if(!fav){ fav = document.createElement('link'); fav.rel='icon'; document.head.appendChild(fav); }
    // simple blue dot svg
    fav.href = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="14" fill="%230ea5e9"/></svg>';
  }catch(e){}
})();
</script>
</body>
</html>

