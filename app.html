<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mapa de Produção — v2.4</title>
  <!-- Favicon inline: evita 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark:#065f46; --warn:#b45309;
      --radius:12px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;height:100%}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:20px} h2{font-size:18px} h3{font-size:16px}
    .main{display:flex;flex-direction:column;height:100%}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:var(--wine);display:grid;place-items:center;color:#fff;font-weight:700}
    .tabs{display:flex;gap:6px;border:0;background:transparent}
    .tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;font-size:14px;color:#334155;cursor:pointer;border-radius:8px;position:relative}
    .tabs button.active{color:var(--wine)}
    .tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--wine)}
    .content-wrap{max-width:1280px;margin:0 auto;padding:18px 16px;flex:1;min-height:0;width:100%}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);width:100%;height:100%;overflow-y:auto}
    .tab-content{display:none;height:100%}
    .tab-content.active{display:block}
    /* Subtabs */
    .subtabs{display:flex;gap:6px;border-bottom:1px solid var(--line);margin-bottom:16px;padding-bottom:10px;flex-wrap:wrap}
    .subtabs button{padding:7px 12px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;font-size:14px;color:#475569;cursor:pointer;position:relative}
    .subtabs button.active{color:var(--wine);font-weight:700}
    .subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-11px;height:3px;border-radius:2px;background:var(--wine)}
    .subpage{display:none}
    .subpage.active{display:block;animation:fadeIn .2s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    /* UI */
    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(123,30,58,.18)}
    textarea{min-height:80px}
    .grid{display:grid;gap:14px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-5{grid-template-columns:repeat(5,1fr)}
    @media (max-width:1020px){.cols-2,.cols-3,.cols-4,.cols-5{grid-template-columns:1fr}}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.small{padding:7px 12px;font-size:13px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .right{display:flex;justify-content:flex-end;align-items:center;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 12px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:500;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}
    .pill.warn{border-color:#fde68a;background:#fef3c7;color:#b45309}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;vertical-align:middle;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:#64748b}
    tbody tr:hover{background:#fafafb}
    tbody tr:last-child td{border-bottom:0}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .status-bar{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px}
    details.help{border:1px dashed #cbd5e1;padding:14px;border-radius:12px;background:#fafbff;margin-top:12px}
    details.help summary{cursor:pointer;font-weight:600}
    .cardbar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .kpi .l{font-size:12px;color:#64748b}
    .kpi .v{font-size:18px;font-weight:700}
    .muted{color:#64748b}
  </style>
</head>
<body>
<main class="main">
  <div class="top">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1 style="margin:0;line-height:1.2">Mapa de Produção</h1>
        <div class="muted" style="margin:0">Cadastros, Produção, Compras e Estoque</div>
      </div>
    </div>
    <nav class="tabs" id="main-tabs">
      <button data-tab="cadastros" class="active">Cadastros</button>
      <button data-tab="producao">Produção</button>
      <button data-tab="compras">Compras</button>
      <button data-tab="estoque">Estoque</button>
    </nav>
    <div class="status-bar"><span id="status">Carregando…</span></div>
  </div>

  <div class="content-wrap">
    <!-- ============ CADASTROS ============ -->
    <section id="tab-cadastros" class="tab-content active">
      <div class="section">
        <nav class="subtabs" id="cadastro-subtabs">
          <button data-subtab="um" class="active">Unidades de Medida</button>
          <button data-subtab="unidades">Unidades (destino)</button>
          <button data-subtab="categorias">Categorias</button>
          <button data-subtab="tipos">Tipos de Item</button>
        </nav>

        <!-- Sub: Unidades de Medida -->
        <div id="sub-um" class="subpage active">
          <div class="cardbar">
            <div class="kpi"><div class="l">Unidades</div><div class="v" id="kpi-um">—</div></div>
            <div class="kpi"><div class="l">Ativas</div><div class="v" id="kpi-um-ativas">—</div></div>
            <div class="kpi"><div class="l">Bases definidas</div><div class="v" id="kpi-um-base">—</div></div>
            <div class="kpi"><div class="l">Fatores inválidos</div><div class="v" id="kpi-um-inv">—</div></div>
          </div>
          <div class="grid cols-4">
            <div><label>Sigla</label><input id="um-sigla" placeholder="Ex.: KG"></div>
            <div><label>Nome</label><input id="um-nome" placeholder="Ex.: Quilograma"></div>
            <div><label>Código</label><input id="um-codigo" placeholder="Ex.: kg"></div>
            <div><label>Base</label>
              <select id="um-base">
                <option value="">—</option>
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="un">un</option>
              </select>
            </div>
          </div>
          <div class="grid cols-4" style="margin-top:10px;align-items:end">
            <div><label>Fator</label><input id="um-fator" type="number" min="0" step="0.000001" placeholder="Ex.: 1000"></div>
            <div><label>Ativo</label>
              <select id="um-ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="right">
              <button id="btnUmSalvar" class="btn pri">Salvar</button>
              <button id="btnUmNovo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table-container" style="max-height:380px">
            <table id="tblUM"><thead>
              <tr><th>Sigla</th><th>Nome</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th>Ações</th></tr>
            </thead><tbody></tbody></table>
          </div>
          <details id="help-um" class="help" style="display:none">
            <summary>SQL sugerido — unidades_medida</summary>
            <pre id="sql-um" style="white-space:pre-wrap"></pre>
          </details>
        </div>

        <!-- Sub: Unidades (destino) -->
        <div id="sub-unidades" class="subpage">
          <div class="grid cols-3">
            <div><label>Nome da unidade</label><input id="u-nome" placeholder="Ex.: Depósito Principal"></div>
            <div><label>Ativo</label>
              <select id="u-ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="right" style="align-self:end">
              <button id="btnUSalvar" class="btn pri">Salvar</button>
              <button id="btnUNovo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table-container" style="max-height:420px">
            <table id="tblU"><thead><tr><th>Nome</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
          </div>
          <details id="help-u" class="help" style="display:none">
            <summary>SQL sugerido — unidades</summary>
            <pre id="sql-u" style="white-space:pre-wrap"></pre>
          </details>
        </div>

        <!-- Sub: Categorias -->
        <div id="sub-categorias" class="subpage">
          <div class="grid cols-4">
            <div><label>Nome</label><input id="c-nome" placeholder="Ex.: Carnes"></div>
            <div><label>Tipo</label>
              <select id="c-tipo">
                <option value="">—</option>
                <option>INGREDIENTE</option>
                <option>RECEITA</option>
                <option>PRATO</option>
                <option>OUTRO</option>
              </select>
            </div>
            <div><label>Ativo</label>
              <select id="c-ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="right" style="align-self:end">
              <button id="btnCSalvar" class="btn pri">Salvar</button>
              <button id="btnCNovo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table-container" style="max-height:420px">
            <table id="tblC"><thead><tr><th>Nome</th><th>Tipo</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
          </div>
          <details id="help-c" class="help" style="display:none">
            <summary>SQL sugerido — categorias</summary>
            <pre id="sql-c" style="white-space:pre-wrap"></pre>
          </details>
        </div>

        <!-- Sub: Tipos de Item -->
        <div id="sub-tipos" class="subpage">
          <div class="grid cols-4">
            <div><label>Nome</label><input id="t-nome" placeholder="Ex.: Ingrediente"></div>
            <div><label>Código</label><input id="t-codigo" placeholder="Ex.: ING"></div>
            <div><label>Ativo</label>
              <select id="t-ativo"><option value="true">Sim</option><option value="false">Não</option></select>
            </div>
            <div class="right" style="align-self:end">
              <button id="btnTSalvar" class="btn pri">Salvar</button>
              <button id="btnTNovo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table-container" style="max-height:420px">
            <table id="tblT"><thead><tr><th>Nome</th><th>Código</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
          </div>
          <details id="help-t" class="help" style="display:none">
            <summary>SQL sugerido — tipos_item</summary>
            <pre id="sql-t" style="white-space:pre-wrap"></pre>
          </details>
        </div>

      </div>
    </section>

    <!-- ============ PRODUÇÃO (placeholder de UI) ============ -->
    <section id="tab-producao" class="tab-content">
      <div class="section">
        <h2>Produção</h2>
        <p class="muted">Esta aba mantém o layout e integrações para previsão já existentes; foco atual nos cadastros.</p>
      </div>
    </section>

    <!-- ============ COMPRAS (placeholder resiliente) ============ -->
    <section id="tab-compras" class="tab-content">
      <div class="section">
        <h2>Compras</h2>
        <p class="muted">Integra com sua lógica SQL (pedidos, sugestões). Caso as views/tabelas não existam, aparecerá ajuda no Estoque.</p>
      </div>
    </section>

    <!-- ============ ESTOQUE (resiliente a 404/400) ============ -->
    <section id="tab-estoque" class="tab-content">
      <div class="section">
        <h2>Estoque</h2>
        <div class="grid cols-2">
          <div>
            <h3>Saldos (vw_estoque_saldos)</h3>
            <div class="table-container" style="max-height:260px">
              <table id="tblSaldo"><thead><tr><th>Unidade</th><th>Item tipo</th><th>Item</th><th>UM</th><th>Saldo</th><th>Valor</th></tr></thead><tbody></tbody></table>
            </div>
            <details id="help-es1" class="help" style="display:none">
              <summary>SQL sugerido — vw_estoque_saldos</summary>
              <pre id="sql-es1" style="white-space:pre-wrap"></pre>
            </details>
          </div>
          <div>
            <h3>Resumo (vw_estoque_saldos_resumo)</h3>
            <div class="table-container" style="max-height:260px">
              <table id="tblSaldoRes"><thead><tr><th>Unidade</th><th>Item</th><th>UM</th><th>Saldo</th><th>Mín</th><th>Máx</th><th>Status</th></tr></thead><tbody></tbody></table>
            </div>
            <details id="help-es2" class="help" style="display:none">
              <summary>SQL sugerido — vw_estoque_saldos_resumo</summary>
              <pre id="sql-es2" style="white-space:pre-wrap"></pre>
            </details>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/** ====== Config ====== */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** ====== Helpers ====== */
const $  = (id)=> document.getElementById(id);
const $$ = (sel,root=document)=> Array.from(root.querySelectorAll(sel));
const setStatus=(msg,cls)=>{const el=$('status'); if(!el) return; el.textContent=msg; el.style.color=(cls==='err'?'#b91c1c':cls==='ok'?'#065f46':cls==='warn'?'#b45309':'#64748b');};
const fmt=(n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
function showSqlHelp(key, visible=true){
  const blocks = {
    um: $('help-um'),
    u: $('help-u'),
    c: $('help-c'),
    t: $('help-t'),
    es1: $('help-es1'),
    es2: $('help-es2'),
  };
  const sqlBlocks = {
    um: $('sql-um'),
    u: $('sql-u'),
    c: $('sql-c'),
    t: $('sql-t'),
    es1: $('sql-es1'),
    es2: $('sql-es2'),
  };
  if(blocks[key]){
    blocks[key].style.display = visible? 'block':'none';
    if(visible && sqlBlocks[key]) sqlBlocks[key].textContent = SQL_SUGGEST[key];
  }
}

/** ====== SQL sugerido (fallback) ====== */
const SQL_SUGGEST = {
um:
`-- Tabela: public.unidades_medida
create table if not exists public.unidades_medida(
  id uuid primary key default gen_random_uuid(),
  sigla text not null,
  nome  text not null unique,
  codigo text,
  base text check (base in ('g','ml','un') or base is null),
  fator numeric(18,6) default 1,
  ativo boolean not null default true
);
-- Índice de apoio
create index if not exists ix_um_codigo on public.unidades_medida (codigo);
-- Inserts básicos (ignore conflitos)
insert into public.unidades_medida(sigla,nome,codigo,base,fator,ativo) values
('G','Grama','g','g',1,true),
('KG','Quilograma','kg','g',1000,true),
('ML','Mililitro','ml','ml',1,true),
('L','Litro','l','ml',1000,true),
('UN','Unidade','un','un',1,true),
('CX','Caixa','cx','un',1,true)
on conflict (nome) do nothing;`,

u:
`-- Tabela: public.unidades (locais/destinos)
create table if not exists public.unidades(
  id uuid primary key default gen_random_uuid(),
  nome text not null unique,
  ativo boolean not null default true
);
insert into public.unidades(nome,ativo) values
('Depósito Principal',true),('Loja Centro',true),('Loja Bairro',true)
on conflict (nome) do nothing;`,

c:
`-- Tabela: public.categorias
create table if not exists public.categorias(
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  tipo text check (tipo in ('INGREDIENTE','RECEITA','PRATO','OUTRO') or tipo is null),
  ativo boolean not null default true
);
create index if not exists ix_cat_nome on public.categorias (nome);`,

t:
`-- Tabela: public.tipos_item
create table if not exists public.tipos_item(
  id uuid primary key default gen_random_uuid(),
  nome text not null unique,
  codigo text not null unique,
  ativo boolean not null default true
);
insert into public.tipos_item(nome,codigo,ativo) values
('Ingrediente','ING',true),('Receita','REC',true),('Prato','PRT',true)
on conflict (nome) do nothing;`,

es1:
`-- View (stub) vw_estoque_saldos
-- Ajuste para sua modelagem real; esta view evita 404 e permite evoluir depois
create or replace view public.vw_estoque_saldos as
select
  u.id          as unidade_id,
  u.nome        as unidade_nome,
  'ING'::text   as item_tipo,
  null::uuid    as item_id,
  '—'::text     as item_nome,
  'un'::text    as un_medida,
  0::numeric    as saldo,
  0::numeric    as custo_medio,
  0::numeric    as valor
from public.unidades u
where false; -- vazio por padrão`,

es2:
`-- View (stub) vw_estoque_saldos_resumo
create or replace view public.vw_estoque_saldos_resumo as
select
  coalesce(unidade_nome,'—') as unidade_nome,
  coalesce(item_nome,'—')    as item_nome,
  'un'::text                 as un_medida,
  0::numeric                 as saldo,
  null::numeric              as est_min,
  null::numeric              as est_max,
  'OK'::text                 as status
from public.vw_estoque_saldos
where false; -- vazio por padrão`
};

/** ====== Roteamento por abas ====== */
function setupRouting(){
  const mainTabs = $('main-tabs');
  const mainContents = $$('.tab-content');
  mainTabs.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    mainTabs.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    mainContents.forEach(sec=> sec.classList.toggle('active', sec.id==='tab-'+b.dataset.tab));
  });

  const subTabs = $('cadastro-subtabs');
  const subpages = $$('#tab-cadastros .subpage');
  subTabs.addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    subTabs.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    subpages.forEach(p=> p.classList.toggle('active', p.id==='sub-'+b.dataset.subtab));
  });
}

/** ====== Data layer ====== */
async function safeSelect(table, sel='*', options={}){
  try{
    const q = supa.from(table).select(sel);
    if(options.order) q.order(options.order.col,{ascending:options.order.asc!==false});
    const {data,error,status} = await q;
    if(error){
      // 404/400: exibir SQL sugerido se houver
      setStatus(`${table}: ${error.message || 'Erro na consulta'}`, 'warn');
      return {data:null,error:{...error,status},status};
    }
    return {data,error:null,status};
  }catch(ex){
    setStatus(`${table}: ${ex.message || ex}`, 'err');
    return {data:null,error:ex,status:0};
  }
}
async function safeInsert(table, payload){
  const {data,error} = await supa.from(table).insert(payload).select().single();
  if(error) throw error;
  return data;
}
async function safeUpdate(table, id, payload){
  const {data,error} = await supa.from(table).update(payload).eq('id',id).select().single();
  if(error) throw error;
  return data;
}
async function safeDelete(table, id){
  const {error} = await supa.from(table).delete().eq('id',id);
  if(error) throw error;
  return true;
}

/** ====== Cadastros: Unidades de Medida ====== */
let um_edit_id=null;
async function loadUM(){
  const {data,error,status} = await safeSelect('unidades_medida','id,sigla,nome,codigo,base,fator,ativo',{order:{col:'nome'}});
  const tb = $('tblUM').querySelector('tbody'); tb.innerHTML='';
  if(error){
    showSqlHelp('um', true);
    tb.innerHTML = `<tr><td colspan="7">Tabela ausente ou inválida. Veja o bloco "SQL sugerido — unidades_medida".</td></tr>`;
    // KPIs zeradas
    $('kpi-um').textContent='0'; $('kpi-um-ativas').textContent='0'; $('kpi-um-base').textContent='0'; $('kpi-um-inv').textContent='0';
    return;
  }
  showSqlHelp('um', false);
  let ativas=0, bases=0, inv=0;
  (data||[]).forEach(r=>{
    if(r.ativo) ativas++;
    if(r.base) bases++;
    if(!r.fator || r.fator<=0) inv++;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.sigla||'—'}</td>
      <td>${r.nome||'—'}</td>
      <td>${r.codigo||'—'}</td>
      <td>${r.base||'—'}</td>
      <td>${r.fator??'—'}</td>
      <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
  $('kpi-um').textContent=String(data?.length||0);
  $('kpi-um-ativas').textContent=String(ativas);
  $('kpi-um-base').textContent=String(bases);
  $('kpi-um-inv').textContent=String(inv);
}
function clearUM(){
  um_edit_id=null;
  $('um-sigla').value=''; $('um-nome').value=''; $('um-codigo').value='';
  $('um-base').value=''; $('um-fator').value=''; $('um-ativo').value='true';
}
$('btnUmNovo').addEventListener('click', clearUM);
$('btnUmSalvar').addEventListener('click', async ()=>{
  const payload = {
    sigla: ($('um-sigla').value||'').trim() || null,
    nome:  ($('um-nome').value||'').trim()  || null,
    codigo:($('um-codigo').value||'').trim()|| null,
    base:  ($('um-base').value||'')|| null,
    fator: Number($('um-fator').value||'0') || null,
    ativo: $('um-ativo').value==='true'
  };
  if(!payload.nome || !payload.sigla){ alert('Informe pelo menos Nome e Sigla.'); return; }
  try{
    if(um_edit_id) await safeUpdate('unidades_medida',um_edit_id,payload);
    else await safeInsert('unidades_medida',payload);
    clearUM(); await loadUM(); setStatus('Unidade de medida salva.','ok');
  }catch(e){ alert(e.message||e); }
});
$('tblUM').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){
    // carregar registro
    const {data}=await supa.from('unidades_medida').select('*').eq('id',id).single();
    if(!data) return;
    um_edit_id=id;
    $('um-sigla').value=data.sigla||'';
    $('um-nome').value=data.nome||'';
    $('um-codigo').value=data.codigo||'';
    $('um-base').value=data.base||'';
    $('um-fator').value=data.fator??'';
    $('um-ativo').value= data.ativo?'true':'false';
  }else if(act==='toggle'){
    const {data} = await supa.from('unidades_medida').select('ativo').eq('id',id).single();
    await safeUpdate('unidades_medida',id,{ativo:!data.ativo});
    await loadUM();
  }else if(act==='del'){
    if(!confirm('Excluir unidade de medida?')) return;
    try{ await safeDelete('unidades_medida',id); await loadUM(); }catch(ex){ alert(ex.message||ex); }
  }
});

/** ====== Cadastros: Unidades (destino) ====== */
let u_edit_id=null;
function clearU(){ u_edit_id=null; $('u-nome').value=''; $('u-ativo').value='true'; }
$('btnUNovo').addEventListener('click', clearU);
$('btnUSalvar').addEventListener('click', async ()=>{
  const payload = { nome:($('u-nome').value||'').trim()||null, ativo:$('u-ativo').value==='true' };
  if(!payload.nome) return alert('Informe o nome da unidade.');
  try{
    if(u_edit_id) await safeUpdate('unidades',u_edit_id,payload);
    else await safeInsert('unidades',payload);
    clearU(); await loadU(); setStatus('Unidade salva.','ok');
  }catch(e){ alert(e.message||e); }
});
async function loadU(){
  const {data,error} = await safeSelect('unidades','id,nome,ativo',{order:{col:'nome'}});
  const tb=$('tblU').querySelector('tbody'); tb.innerHTML='';
  if(error){
    showSqlHelp('u', true);
    tb.innerHTML = `<tr><td colspan="3">Tabela ausente ou inválida. Veja "SQL sugerido — unidades".</td></tr>`;
    return;
  }
  showSqlHelp('u', false);
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td>
      <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
}
$('tblU').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){
    const {data}=await supa.from('unidades').select('*').eq('id',id).single();
    if(!data) return;
    u_edit_id=id; $('u-nome').value=data.nome||''; $('u-ativo').value=data.ativo?'true':'false';
  }else if(act==='toggle'){
    const {data}=await supa.from('unidades').select('ativo').eq('id',id).single();
    await safeUpdate('unidades',id,{ativo:!data.ativo}); await loadU();
  }else if(act==='del'){
    if(!confirm('Excluir unidade?')) return;
    try{ await safeDelete('unidades',id); await loadU(); }catch(ex){ alert(ex.message||ex); }
  }
});

/** ====== Cadastros: Categorias ====== */
let c_edit_id=null;
function clearC(){ c_edit_id=null; $('c-nome').value=''; $('c-tipo').value=''; $('c-ativo').value='true'; }
$('btnCNovo').addEventListener('click', clearC);
$('btnCSalvar').addEventListener('click', async ()=>{
  const payload={ nome:($('c-nome').value||'').trim()||null, tipo:$('c-tipo').value||null, ativo:$('c-ativo').value==='true' };
  if(!payload.nome) return alert('Informe o nome da categoria.');
  try{
    if(c_edit_id) await safeUpdate('categorias',c_edit_id,payload);
    else await safeInsert('categorias',payload);
    clearC(); await loadC(); setStatus('Categoria salva.','ok');
  }catch(e){ alert(e.message||e); }
});
async function loadC(){
  const {data,error} = await safeSelect('categorias','id,nome,tipo,ativo',{order:{col:'nome'}});
  const tb=$('tblC').querySelector('tbody'); tb.innerHTML='';
  if(error){
    showSqlHelp('c', true);
    tb.innerHTML = `<tr><td colspan="4">Tabela ausente ou inválida. Veja "SQL sugerido — categorias".</td></tr>`;
    return;
  }
  showSqlHelp('c', false);
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td><td>${r.tipo||'—'}</td>
      <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
}
$('tblC').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){
    const {data}=await supa.from('categorias').select('*').eq('id',id).single();
    if(!data) return;
    c_edit_id=id; $('c-nome').value=data.nome||''; $('c-tipo').value=data.tipo||''; $('c-ativo').value=data.ativo?'true':'false';
  }else if(act==='toggle'){
    const {data}=await supa.from('categorias').select('ativo').eq('id',id).single();
    await safeUpdate('categorias',id,{ativo:!data.ativo}); await loadC();
  }else if(act==='del'){
    if(!confirm('Excluir categoria?')) return;
    try{ await safeDelete('categorias',id); await loadC(); }catch(ex){ alert(ex.message||ex); }
  }
});

/** ====== Cadastros: Tipos de Item ====== */
let t_edit_id=null;
function clearT(){ t_edit_id=null; $('t-nome').value=''; $('t-codigo').value=''; $('t-ativo').value='true'; }
$('btnTNovo').addEventListener('click', clearT);
$('btnTSalvar').addEventListener('click', async ()=>{
  const payload={ nome:($('t-nome').value||'').trim()||null, codigo:($('t-codigo').value||'').trim()||null, ativo:$('t-ativo').value==='true' };
  if(!payload.nome || !payload.codigo) return alert('Informe Nome e Código.');
  try{
    if(t_edit_id) await safeUpdate('tipos_item',t_edit_id,payload);
    else await safeInsert('tipos_item',payload);
    clearT(); await loadT(); setStatus('Tipo de item salvo.','ok');
  }catch(e){ alert(e.message||e); }
});
async function loadT(){
  const {data,error} = await safeSelect('tipos_item','id,nome,codigo,ativo',{order:{col:'nome'}});
  const tb=$('tblT').querySelector('tbody'); tb.innerHTML='';
  if(error){
    showSqlHelp('t', true);
    tb.innerHTML = `<tr><td colspan="4">Tabela ausente ou inválida. Veja "SQL sugerido — tipos_item".</td></tr>`;
    return;
  }
  showSqlHelp('t', false);
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td><td>${r.codigo}</td>
      <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
}
$('tblT').addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){
    const {data}=await supa.from('tipos_item').select('*').eq('id',id).single();
    if(!data) return;
    t_edit_id=id; $('t-nome').value=data.nome||''; $('t-codigo').value=data.codigo||''; $('t-ativo').value=data.ativo?'true':'false';
  }else if(act==='toggle'){
    const {data}=await supa.from('tipos_item').select('ativo').eq('id',id).single();
    await safeUpdate('tipos_item',id,{ativo:!data.ativo}); await loadT();
  }else if(act==='del'){
    if(!confirm('Excluir tipo?')) return;
    try{ await safeDelete('tipos_item',id); await loadT(); }catch(ex){ alert(ex.message||ex); }
  }
});

/** ====== Estoque (views resilientes) ====== */
async function loadEstoque(){
  // vw_estoque_saldos
  {
    const {data,error} = await safeSelect('vw_estoque_saldos','*');
    const tb = $('tblSaldo').querySelector('tbody'); tb.innerHTML='';
    if(error){
      showSqlHelp('es1', true);
      tb.innerHTML = `<tr><td colspan="6">View ausente. Veja "SQL sugerido — vw_estoque_saldos".</td></tr>`;
    }else{
      showSqlHelp('es1', false);
      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.unidade_nome||'—'}</td><td>${r.item_tipo||'—'}</td><td>${r.item_nome||r.item_id||'—'}</td><td>${r.un_medida||'—'}</td><td>${fmt(r.saldo)}</td><td>${fmt(r.valor||0)}</td>`;
        tb.appendChild(tr);
      });
      if((data||[]).length===0){ tb.innerHTML = `<tr><td colspan="6">Sem registros.</td></tr>`; }
    }
  }
  // vw_estoque_saldos_resumo
  {
    const {data,error} = await safeSelect('vw_estoque_saldos_resumo','*');
    const tb = $('tblSaldoRes').querySelector('tbody'); tb.innerHTML='';
    if(error){
      showSqlHelp('es2', true);
      tb.innerHTML = `<tr><td colspan="7">View ausente. Veja "SQL sugerido — vw_estoque_saldos_resumo".</td></tr>`;
    }else{
      showSqlHelp('es2', false);
      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.unidade_nome||'—'}</td><td>${r.item_nome||'—'}</td><td>${r.un_medida||'—'}</td><td>${fmt(r.saldo||0)}</td><td>${r.est_min??'—'}</td><td>${r.est_max??'—'}</td><td>${r.status||'—'}</td>`;
        tb.appendChild(tr);
      });
      if((data||[]).length===0){ tb.innerHTML = `<tr><td colspan="7">Sem registros.</td></tr>`; }
    }
  }
}

/** ====== Init ====== */
async function init(){
  setupRouting();
  setStatus('Carregando cadastros…','');
  await Promise.all([loadUM(), loadU(), loadC(), loadT()]);
  setStatus('Carregando estoque…','');
  await loadEstoque();
  setStatus('Pronto','ok');
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
