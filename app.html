<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mapa de Produ√ß√£o ‚Äî Full</title>
  <!-- Favicon embutido (evita 404) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark:#065f46; --wine-dark:#881337; --radius:12px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;height:100vh;overflow:hidden}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:20px} h2{font-size:18px} h3{font-size:16px}
    .main{display:flex;flex-direction:column;height:100%;min-height:0}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;background:var(--wine);display:grid;place-items:center;color:#fff;font-weight:700}
    .tabs{display:flex;gap:6px}
    .tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;font-size:14px;color:#334155;cursor:pointer;border-radius:8px;position:relative}
    .tabs button.active{color:var(--wine)}
    .tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--wine)}
    .status-bar{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted)}
    .content-wrap{max-width:1280px;margin:0 auto;padding:18px 16px;flex:1;min-height:0;width:100%}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);width:100%;height:100%;overflow:hidden}
    .tab-content{display:none;height:100%}
    .tab-content.active{display:block}
    .subtabs{display:flex;gap:4px;border-bottom:1px solid var(--line);margin-bottom:16px;padding-bottom:10px;flex-wrap:wrap}
    .subtabs button{padding:7px 12px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;font-size:14px;color:#475569;cursor:pointer;position:relative}
    .subtabs button:hover{background:#f8fafc;color:var(--wine-dark)}
    .subtabs button.active{color:var(--wine);font-weight:700}
    .subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-11px;height:3px;border-radius:2px;background:var(--wine)}
    .subpage{display:none}
    .subpage.active{display:block;animation:fade .2s;flex:1;overflow:auto;min-height:0}
    @keyframes fade{from{opacity:.5}to{opacity:1}}
    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(123,30,58,.25)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.small{padding:7px 12px;font-size:13px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-5{grid-template-columns:repeat(5,1fr)}
    .right{display:flex;justify-content:flex-end;align-items:center;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 12px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:500;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:var(--down)}
    .pill.warn{border-color:#fde68a;background:#fefce8;color:#a16207}
    .hint{color:#64748b;font-size:12px;margin-top:4px}
    .sep{height:1px;background:var(--line);margin:16px 0}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;vertical-align:middle;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:#475569}
    tbody tr:hover{background:#fafafb}
    tbody tr:last-child td{border-bottom:0}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .nowrap{white-space:nowrap}
    .soft{color:var(--muted)}
    .mov-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px}
    .mov-actions .btn{padding:20px;font-size:16px;font-weight:700;flex-direction:column;height:100px}
    #mov-form-container{border:1px solid var(--line);border-radius:var(--radius);padding:16px;display:none}
    .filters-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;padding:12px;background-color:var(--bg);border-radius:var(--radius);margin-bottom:16px}
    @media (max-width:1020px){.cols-2,.cols-3,.cols-4,.cols-5{grid-template-columns:1fr}}
  </style>
</head>
<body>
<main class="main">
  <div class="top">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1 style="margin:0">Mapa de Produ√ß√£o</h1>
        <div class="hint">Ficha t√©cnica, previs√£o e compras</div>
      </div>
    </div>
    <nav class="tabs" id="main-tabs">
      <button data-tab="cadastros" class="active">Cadastros</button>
      <button data-tab="producao">Produ√ß√£o</button>
      <button data-tab="compras">Compras</button>
      <button data-tab="estoque">Estoque</button>
    </nav>
    <div class="status-bar"><span id="status">Carregando‚Ä¶</span></div>
  </div>

  <div class="content-wrap">

    <!-- ===== CADASTROS ===== -->
    <section id="tab-cadastros" class="tab-content active">
      <div class="section" id="section-cadastros">
        <nav class="subtabs" id="cadastro-subtabs">
          <button data-subtab="pratos" class="active">Pratos</button>
          <button data-subtab="componentes">Componentes</button>
          <button data-subtab="receitas">Receitas</button>
          <button data-subtab="ingredientes">Ingredientes</button>
          <button data-subtab="um">Unidades de Medida</button>
          <button data-subtab="unidades">Unidades (Destino)</button>
          <button data-subtab="categorias">Categorias</button>
          <button data-subtab="tipositem">Tipos de Item</button>
        </nav>

        <!-- PRATOS (preservado) -->
        <div id="sub-pratos" class="subpage active">
          <div class="grid cols-2">
            <div><input id="pratos-search" placeholder="Buscar prato..." /></div>
            <div class="right"><button id="btnNovoPrato" class="btn pri">+ Novo prato</button></div>
          </div>
          <div class="sep"></div>
          <div class="grid cols-2" style="align-items:flex-end">
            <div>
              <label>Filtrar categoria</label>
              <select id="pratos-cat-filter">
                <option value="">Todas</option>
                <option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option>
                <option>SOBREMESA</option><option>PROMO√á√ïES</option><option>OUTROS</option>
              </select>
            </div>
            <div class="right">
              <span class="pill" id="pratos-page-info">P√°gina 1/1</span>
              <div class="row-actions">
                <button class="btn small" id="pratos-prev">‚óÄ</button>
                <button class="btn small" id="pratos-next">‚ñ∂</button>
              </div>
            </div>
          </div>
          <div class="table-container" style="max-height:320px">
            <table id="tblPratos"><thead><tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>

          <div class="sep"></div>
          <h3 id="prato-form-title">Editar prato</h3>
          <div class="grid cols-4">
            <div><label>Nome</label><input id="prato-nome"></div>
            <div><label>Categoria</label>
              <select id="prato-cat"><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMO√á√ïES</option><option>OUTROS</option></select>
            </div>
            <div><label>Peso do prato</label><select id="prato-peso-un"><option>g</option><option>ml</option></select></div>
            <div><label>Qtd</label><input id="prato-peso" placeholder="500"></div>
          </div>
          <div class="grid cols-2" style="margin-top:10px">
            <div><label>C√≥d. Barras</label><input id="prato-codigo-barras" disabled></div>
            <div><label>QR Code</label><input id="prato-qrcode" disabled></div>
          </div>
          <div style="margin-top:10px">
            <label>Descri√ß√£o</label>
            <textarea id="prato-descricao" rows="3"></textarea>
          </div>
          <div class="grid cols-4" style="margin-top:10px;align-items:flex-end">
            <div><label>Pre√ßo de venda</label><input id="prato-preco" placeholder="fator ou R$"></div>
            <div><label>Custo (calc.)</label><input id="prato-custo" disabled></div>
            <div><label>√öltima altera√ß√£o</label><input id="prato-ultima" disabled></div>
            <div class="right">
              <button id="btnGenerateDesc" class="btn">‚ú® Sugerir (IA)</button>
              <button id="btnSalvarPrato" class="btn pri">Salvar</button>
              <button id="btnCancelarPrato" class="btn">Cancelar</button>
            </div>
          </div>

          <div class="sep"></div>
          <details class="dash" id="dash-import">
            <summary>Importar Pratos do Dashboard</summary>
            <div class="grid cols-3" style="margin-top:10px;align-items:flex-end">
              <div><label>Categoria (fonte)</label>
                <select id="dash-cat"><option value="">Sem categoria</option><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMO√á√ïES</option><option>OUTROS</option></select>
              </div>
              <div><label>Buscar</label><input id="dash-search" placeholder="Digite para filtrar‚Ä¶"></div>
              <div class="right"><button id="btnSyncAll" class="btn">Sincronizar</button></div>
            </div>
            <div class="table-container" style="overflow:auto;margin-top:10px;max-height:260px">
              <table id="tblDash"><thead><tr><th>Prato (dashboard)</th><th>Categoria</th><th>Situa√ß√£o</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table>
            </div>
          </details>
        </div>

        <!-- COMPONENTES (preservado) -->
        <div id="sub-componentes" class="subpage">
          <h2>Componentes do Prato</h2>
          <div class="grid cols-2">
            <div>
              <label>Selecione um prato</label>
              <select id="cp-prato"><option value="">Selecione...</option></select>
            </div>
          </div>
          <div id="componentes-editor" style="display:none">
            <div class="sep"></div>
            <h4>Adicionar Receita ao Prato</h4>
            <div class="grid cols-4">
              <div><label>Receita</label><select id="cp-receita"></select></div>
              <div><label>Qtd por prato</label><input id="cp-qtd" placeholder="220"></div>
              <div><label>Unidade</label><select id="cp-und"><option>g</option><option>ml</option><option>porcao</option></select></div>
              <div class="right" style="align-self:end"><button id="btnAddPrComp" class="btn pri">Adicionar</button></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px;align-items:flex-end">
              <div><label>Observa√ß√µes</label><input id="cp-obs" placeholder="Opcional"></div>
            </div>
            <div class="sep"></div>
            <h4>Receitas do prato</h4>
            <div class="table-container" style="max-height:320px">
              <table id="tblPrComp"><thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>

        <!-- RECEITAS (preservado) -->
        <div id="sub-receitas" class="subpage">
          <h2>Gerenciamento de Receitas</h2>
          <div class="right" style="margin-bottom:12px"><button id="btnShowNewRecipeForm" class="btn pri">+ Nova Receita</button></div>
          <div id="recipe-editor-container" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px">
            <h3 id="recipe-form-title">Nova Receita</h3>
            <div class="grid cols-3">
              <div><label>Nome</label><input id="rec-nome"></div>
              <div><label>Rendimento (qtd)</label><input id="rec-rend-qtd" placeholder="1000"></div>
              <div><label>Unidade</label><select id="rec-rend-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option value="porcao">por√ß√£o</option></select></div>
            </div>
            <div class="grid cols-3" style="margin-top:10px">
              <div><label>Perda global (%)</label><input id="rec-perda" value="0"></div>
              <div><label>C√≥d. Barras</label><input id="rec-codigo-barras" disabled></div>
              <div><label>QR Code</label><input id="rec-qrcode" disabled></div>
            </div>
            <div><label>Observa√ß√µes</label><input id="rec-obs" placeholder="Opcional"></div>
            <div style="margin-top:10px"><label>Modo de Preparo</label><textarea id="rec-preparo" rows="6"></textarea></div>
            <div class="sep"></div>
            <h4>Itens da Receita</h4>
            <div class="grid cols-4">
              <div><label>Tipo</label><select id="draft-tipo"><option>INGREDIENTE</option><option>RECEITA</option></select></div>
              <div><label>Refer√™ncia</label><select id="draft-ref"></select></div>
              <div><label>Qtd</label><input id="draft-qtd" placeholder="300"></div>
              <div><label>Unidade</label><select id="draft-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px;align-items:flex-end">
              <div><label>Perda da linha (%)</label><input id="draft-perda" value="0"></div>
              <div class="right"><button id="btnDraftAdd" class="btn">Adicionar</button><button id="btnDraftClear" class="btn">Limpar</button></div>
            </div>
            <div class="table-container" style="margin-top:8px;max-height:200px">
              <table id="tblDraft"><thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="sep"></div>
            <div class="right">
              <button id="btnGeneratePreparo" class="btn">‚ú® Gerar Preparo (IA)</button>
              <button id="btnSaveRec" class="btn pri">Salvar</button>
              <button id="btnUpdateRec" class="btn pri" style="display:none">Atualizar</button>
              <button id="btnCancelRecEdit" class="btn">Cancelar</button>
            </div>
          </div>
          <h3>Receitas Cadastradas</h3>
          <div class="table-container">
            <table id="tblRec"><thead><tr><th>Nome</th><th>Rendimento</th><th>Itens</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- INGREDIENTES (preservado) -->
        <div id="sub-ingredientes" class="subpage">
          <h2>Gerenciamento de Ingredientes</h2>
          <div class="right" style="margin-bottom:12px"><button id="btnShowNewIngredienteForm" class="btn pri">+ Novo Ingrediente</button></div>
          <div id="ingrediente-editor-container" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px">
            <h3 id="ingrediente-form-title">Novo Ingrediente</h3>
            <div class="grid cols-4">
              <div><label>Nome</label><input id="ing-nome" placeholder="Arroz branco cru"></div>
              <div><label>Categoria</label><select id="ing-categoria"><option>Alimentos</option><option>Bebidas</option><option>Descart√°veis</option><option>Prote√≠nas</option><option>Outros</option></select></div>
              <div><label>Unidade</label><select id="ing-und"><option>g</option><option selected>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
              <div><label>Custo unit√°rio</label><input id="ing-custo" placeholder="0,0123"></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px">
              <div><label>C√≥d. Barras</label><input id="ing-codigo-barras" disabled></div>
              <div><label>QR Code</label><input id="ing-qrcode" disabled></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px;align-items:flex-end">
              <div><label>Observa√ß√µes</label><input id="ing-obs" placeholder="Opcional"></div>
              <div class="right"><button id="btnSaveIng" class="btn pri">Salvar</button><button id="btnCancelIngEdit" class="btn">Cancelar</button></div>
            </div>
          </div>
          <div class="grid cols-2"><div class="pill">Ingredientes cadastrados</div><div class="right"><input id="ing-search" placeholder="Buscar..."></div></div>
          <div class="table-container" style="margin-top:6px">
            <table id="tblIng"><thead><tr><th>Nome</th><th>Categoria</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- UNIDADES DE MEDIDA (NOVO) -->
        <div id="sub-um" class="subpage">
          <h2>Unidades de Medida</h2>
          <div class="right" style="margin-bottom:12px"><button id="btnShowUMForm" class="btn pri">+ Nova UM</button></div>
          <div id="um-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px">
            <div class="grid cols-4">
              <div><label>Sigla</label><input id="um-sigla" placeholder="KG, L, UN"></div>
              <div><label>Nome</label><input id="um-nome" placeholder="Quilograma"></div>
              <div><label>C√≥digo</label><input id="um-codigo" placeholder="kg, l, un"></div>
              <div><label>Base</label><input id="um-base" placeholder="g, ml, un"></div>
            </div>
            <div class="grid cols-3" style="margin-top:10px;align-items:flex-end">
              <div><label>Fator</label><input id="um-fator" type="number" step="0.000001" value="1"></div>
              <div><label>Ativo</label>
                <select id="um-ativo"><option value="true" selected>Sim</option><option value="false">N√£o</option></select>
              </div>
              <div class="right"><button id="btnSaveUM" class="btn pri">Salvar</button><button id="btnCancelUM" class="btn">Cancelar</button></div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblUM"><thead><tr><th>Sigla</th><th>Nome</th><th>C√≥digo</th><th>Base</th><th>Fator</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- UNIDADES (DESTINO) (NOVO) -->
        <div id="sub-unidades" class="subpage">
          <h2>Unidades (Destino)</h2>
          <div class="right" style="margin-bottom:12px"><button id="btnShowUnForm" class="btn pri">+ Nova Unidade</button></div>
          <div id="un-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px">
            <div class="grid cols-2">
              <div><label>Nome</label><input id="un-nome" placeholder="Dep√≥sito Principal"></div>
              <div class="right" style="align-self:end"><button id="btnSaveUn" class="btn pri">Salvar</button><button id="btnCancelUn" class="btn">Cancelar</button></div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblUn"><thead><tr><th>Nome</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- CATEGORIAS (NOVO / segura) -->
        <div id="sub-categorias" class="subpage">
          <h2>Categorias</h2>
          <div class="right" style="margin-bottom:12px"><button id="btnShowCatForm" class="btn pri">+ Nova Categoria</button></div>
          <div id="cat-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px">
            <div class="grid cols-3">
              <div><label>Nome</label><input id="cat-nome" placeholder="Alimentos"></div>
              <div><label>Ativo</label><select id="cat-ativo"><option value="true" selected>Sim</option><option value="false">N√£o</option></select></div>
              <div class="right" style="align-self:end"><button id="btnSaveCat" class="btn pri">Salvar</button><button id="btnCancelCat" class="btn">Cancelar</button></div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblCat"><thead><tr><th>Nome</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <!-- TIPOS DE ITEM (NOVO / tolerante) -->
        <div id="sub-tipositem" class="subpage">
          <h2>Tipos de Item</h2>
          <div class="hint">Se existir a tabela <code>item_tipos(id, codigo, nome, ativo)</code>, esta UI far√° CRUD. Caso n√£o exista, mostra refer√™ncia (ING/REC) sem erros.</div>
          <div class="right" style="margin:10px 0"><button id="btnShowTipoForm" class="btn pri">+ Novo Tipo</button></div>
          <div id="tipo-editor" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px">
            <div class="grid cols-3">
              <div><label>C√≥digo</label><input id="tipo-cod" placeholder="ING"></div>
              <div><label>Nome</label><input id="tipo-nome" placeholder="Ingrediente"></div>
              <div class="right" style="align-self:end"><button id="btnSaveTipo" class="btn pri">Salvar</button><button id="btnCancelTipo" class="btn">Cancelar</button></div>
            </div>
          </div>
          <div class="table-container">
            <table id="tblTipos"><thead><tr><th>C√≥digo</th><th>Nome</th><th>Ativo</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

      </div>
    </section>

    <!-- ===== PRODU√á√ÉO (preservado) ===== -->
    <section id="tab-producao" class="tab-content">
      <div class="section">
        <h2>Mapa de Produ√ß√£o ‚Äì Previs√£o</h2>
        <div class="grid cols-4" style="align-items:flex-end">
          <div><label>M√©dia (dias)</label><input id="win-dias" type="number" min="1" step="1" value="7"></div>
          <div><label>Proje√ß√£o (dias)</label><input id="proj-dias" type="number" min="1" step="1" value="7"></div>
          <div><label>Categorias de Pratos</label><select id="cat-filter" multiple></select></div>
          <div class="right"><button id="btnCalcularPrev" class="btn pri">Calcular</button></div>
        </div>
        <div class="hint" id="prev-hint-top"></div>
        <div class="grid cols-3" style="margin-top:10px">
          <div class="pill"><span class="soft">Dias analisados:</span> <b id="kpi-dias">‚Äî</b></div>
          <div class="pill"><span class="soft">Pratos:</span> <b id="kpi-pratos">‚Äî</b></div>
          <div class="pill"><span class="soft">Receitas:</span> <b id="kpi-rec">‚Äî</b></div>
        </div>
        <div class="sep"></div>
        <h3>Resumo ‚Äî M√©dia de Vendas por Prato</h3>
        <div class="table-container" style="max-height:240px">
          <table id="tblResumoPratos"><thead><tr><th>Prato</th><th>Categoria</th><th>M√©dia/Dia</th><th id="th-proj-prato">Proje√ß√£o</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="sep"></div>
        <h3>Produ√ß√£o consolidada por Receita</h3>
        <div class="table-container" style="max-height:280px">
          <table id="tblPrev"><thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th id="th-proj">Qtd/Proje√ß√£o</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="right" style="margin-top:12px"><button id="btnExportPrev" class="btn">Exportar PDF</button></div>
        <div class="hint" id="prev-hint"></div>
      </div>
    </section>

    <!-- ===== COMPRAS (preservado; lista simples) ===== -->
    <section id="tab-compras" class="tab-content">
      <div class="section">
        <h3>Sugest√µes de Compra</h3>
        <div class="hint">Baseado em estoque, ponto de pedido, consumo e lead time.</div>
        <div class="right" style="margin:10px 0">
          <button id="btnRefreshSuggestions" class="btn">Atualizar</button>
          <button id="btnExportSuggestions" class="btn">Exportar CSV</button>
        </div>
        <div class="table-container">
          <table id="tblSugestoes"><thead><tr><th>Item</th><th>Status</th><th>Saldo</th><th>Ponto Pedido</th><th>Consumo/Dia</th><th>Sugest√£o</th><th>M√∫ltiplo</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <!-- ===== ESTOQUE (preservado) ===== -->
    <section id="tab-estoque" class="tab-content">
      <div class="section" id="section-estoque">
        <nav class="subtabs" id="estoque-subtabs">
          <button data-subtab="estoque-visao" class="active">Vis√£o Geral</button>
          <button data-subtab="estoque-mov">Movimentar</button>
          <button data-subtab="estoque-benef">Beneficiar</button>
          <button data-subtab="estoque-inv">Invent√°rio</button>
          <button data-subtab="estoque-param">Par√¢metros</button>
          <button data-subtab="estoque-anom">Anomalias (IA)</button>
        </nav>

        <!-- Vis√£o Geral (tolerante a views ausentes) -->
        <div id="sub-estoque-visao" class="subpage active">
          <div class="grid cols-5">
            <div class="pill bad">Cr√≠ticos: <b id="estoq-kpi-criticos">0</b></div>
            <div class="pill warn">Abaixo M√≠n.: <b id="estoq-kpi-min">0</b></div>
            <div class="pill">Acima M√°x.: <b id="estoq-kpi-max">0</b></div>
            <div class="pill warn">Venc. &lt; 7d: <b id="estoq-kpi-venc7">0</b></div>
            <div class="pill">Ajustes(30d): <b id="estoq-kpi-ajustes">R$ 0,00</b></div>
          </div>
          <div class="filters-bar">
            <div><label>Unidade</label><select id="filtro-unidade-estoque"></select></div>
            <div><label>Categoria</label><select id="filtro-categoria-estoque"></select></div>
            <div><label>Status</label><select id="filtro-status-estoque"><option value="">Todos</option><option value="CR√çTICO">Cr√≠tico</option><option value="ABAIXO DO M√çNIMO">Abaixo do M√≠nimo</option><option value="OK">OK</option></select></div>
          </div>
          <h4>Saldo Atual por Item</h4>
          <div class="table-container" style="max-height:220px">
            <table id="tblSaldo"><thead><tr><th>Item</th><th>Tipo</th><th>Unidade</th><th>Saldo</th><th>Custo M√©dio</th><th>Valor Total</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="sep"></div>
          <h4>Saldo Detalhado por Lote</h4>
          <div class="table-container" style="max-height:220px">
            <table id="tblSaldoLotes"><thead><tr><th>Item</th><th>Lote</th><th>Validade</th><th>Saldo</th><th>Unidade</th><th>Custo Unit.</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="hint" id="estoque-visao-hint"></div>
        </div>

        <!-- Movimentar (preservado) -->
        <div id="sub-estoque-mov" class="subpage">
          <h3>Opera√ß√µes de Estoque</h3>
          <div class="mov-actions">
            <button class="btn" data-mov-type="ENTRADA">üì• Entrada</button>
            <button class="btn" data-mov-type="SAIDA">üì§ Sa√≠da</button>
            <button class="btn" data-mov-type="TRANSFERENCIA">üîÑ Transfer√™ncia</button>
            <button class="btn" data-mov-type="AJUSTE">‚úçÔ∏è Ajuste</button>
          </div>
          <div id="mov-form-container">
            <h3 id="mov-form-title"></h3>
            <form id="frmMov">
              <div class="grid cols-2">
                <div id="mov-unidade-origem-group"><label>Unidade Origem</label><select id="mov-unidade-origem"></select></div>
                <div id="mov-unidade-destino-group"><label>Unidade Destino</label><select id="mov-unidade-destino"></select></div>
              </div>
              <div class="grid cols-2" style="margin-top:10px">
                <div><label>Item</label><select id="mov-item"></select></div>
                <div><label>Tipo Item</label><select id="mov-item-tipo"><option value="ING">Ingrediente</option><option value="REC">Receita</option></select></div>
              </div>
              <div class="grid cols-2" style="margin-top:10px">
                <div><label>Lote</label><input id="mov-lote" placeholder="Lote"></div>
                <div id="mov-validade-group"><label>Validade</label><input id="mov-validade" type="date"></div>
              </div>
              <div class="grid cols-3" style="margin-top:10px">
                <div><label>Quantidade</label><input id="mov-qtd" type="number" step="0.0001"></div>
                <div id="mov-ajuste-sinal-group"><label>Tipo de Ajuste</label><select id="mov-ajuste-sinal"><option value="+">Positivo (+)</option><option value="-">Negativo (-)</option></select></div>
                <div><label>Un. Medida</label><input id="mov-un" placeholder="kg, L, un"></div>
              </div>
              <div style="margin-top:10px" id="mov-custo-group"><label>Custo Unit√°rio</label><input id="mov-custo" type="number" step="0.0001"></div>
              <div style="margin-top:10px"><label>Documento/Obs</label><input id="mov-doc" placeholder="NF, motivo etc."></div>
              <div class="right" style="margin-top:12px">
                <button id="btnMovSubmit" type="submit" class="btn pri">Registrar</button>
                <button id="btnMovCancel" type="button" class="btn">Cancelar</button>
              </div>
            </form>
          </div>
          <div class="sep"></div>
          <h4>√öltimas 20 Movimenta√ß√µes</h4>
          <div class="table-container" style="max-height:240px">
            <table id="tblMovRecentes"><thead><tr><th>TS</th><th>Tipo</th><th>Item</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div id="sub-estoque-benef" class="subpage"><p>Beneficiamento ‚Äî em breve.</p></div>
        <div id="sub-estoque-inv" class="subpage"><p>Invent√°rio ‚Äî em breve.</p></div>
        <div id="sub-estoque-param" class="subpage"><p>Par√¢metros ‚Äî em breve.</p></div>
        <div id="sub-estoque-anom" class="subpage"><p>Anomalias (IA) ‚Äî em breve.</p></div>
      </div>
    </section>

  </div>
</main>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

<script>
/* ===== Helpers/UI ===== */
const $  = (id)=>document.getElementById(id);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
const setStatus=(msg,cls)=>{const el=$('status');if(!el)return;el.textContent=msg;el.style.color=(cls==='err'?'#b91c1c':cls==='ok'?'#065f46':'#64748b');};
const fmt=(n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
const ptToNumber=(v)=>{if(v==null)return 0;const s=String(v).trim().replace(/\./g,'').replace(',','.');const n=parseFloat(s);return isNaN(n)?0:n;};
const todayStr=()=> new Date().toISOString().slice(0,10);

/* ===== Routing (abas/subabas) ===== */
function setupRouting(){
  const mainTabs=$('main-tabs'); const contents=$$('.tab-content');
  mainTabs.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b)return;
    mainTabs.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tabId=b.dataset.tab;
    contents.forEach(c=>c.classList.toggle('active', c.id==='tab-'+tabId));
  });
  const setupSub=(containerId,prefix)=>{
    const nav=$(containerId); if(!nav)return;
    nav.addEventListener('click',e=>{
      const b=e.target.closest('button'); if(!b)return;
      nav.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const id='sub-'+b.dataset.subtab;
      $$('#'+prefix+' .subpage').forEach(p=>p.classList.toggle('active', p.id===id));
    });
  };
  setupSub('cadastro-subtabs','section-cadastros');
  setupSub('estoque-subtabs','section-estoque');
}
document.addEventListener('DOMContentLoaded',setupRouting);

/* ===== Supabase ===== */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== Safe wrappers (evita quebrar a UI com colunas/views ausentes) ===== */
async function safeSelect(table, selectCols, opts={}){
  try{
    const q = supa.from(table).select(selectCols || '*');
    if(opts.order) q.order(opts.order, {ascending: opts.ascending!==false});
    if(opts.limit) q.limit(opts.limit);
    const {data,error,status} = await q;
    if(error) throw Object.assign(error,{status});
    return data||[];
  }catch(err){
    console.warn(`[${table}]`,err);
    setStatus(`${table}: ${err.message||err}`, 'err');
    return null; // indica falha
  }
}
async function safeInsert(table, payload){
  try { const {error} = await supa.from(table).insert(payload); if(error) throw error; return true; }
  catch(err){ alert(`Erro ao salvar em ${table}: ${err.message||err}`); return false; }
}
async function safeUpdate(table, match, payload){
  try { const {error} = await supa.from(table).update(payload).match(match); if(error) throw error; return true; }
  catch(err){ alert(`Erro ao atualizar ${table}: ${err.message||err}`); return false; }
}
async function safeDelete(table, match){
  try { const {error} = await supa.from(table).delete().match(match); if(error) throw error; return true; }
  catch(err){ alert(`Erro ao excluir de ${table}: ${err.message||err}`); return false; }
}

/* =========================
   CADASTROS ‚Äî PRATOS
========================= */
let pratos=[], pratosPage=1; const PAGE_SIZE=10; let pratoEditId=null;
async function loadPratos(){
  const data = await safeSelect('pratos','id,nome,categoria,ativo,updated_at,peso,peso_un,preco_venda,custo,descricao,codigo_barras,qrcode',{order:'nome'});
  if(!data) return;
  pratos = data; renderPratos();
}
function renderPratos(){
  const term=$('pratos-search').value?.toLowerCase().trim()||'';
  const catF=$('pratos-cat-filter').value||'';
  const filtered=pratos.filter(p=>(!catF||String(p.categoria||'')===catF) && (!term||String(p.nome).toLowerCase().includes(term)));
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(pratosPage>totalPages) pratosPage=totalPages;
  const pageItems=filtered.slice((pratosPage-1)*PAGE_SIZE,(pratosPage-1)*PAGE_SIZE+PAGE_SIZE);
  const tb=$('tblPratos').querySelector('tbody'); tb.innerHTML='';
  pageItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.nome}</td><td>${p.categoria||'‚Äî'}</td><td>${p.receitas ?? '‚Äî'}</td>
      <td>${p.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${p.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${p.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
  $('pratos-page-info').textContent=`P√°gina ${pratosPage}/${totalPages}`;
  $('pratos-prev').disabled=pratosPage<=1; $('pratos-next').disabled=pratosPage>=totalPages;
}
$('pratos-prev').addEventListener('click',()=>{ pratosPage=Math.max(1,pratosPage-1); renderPratos(); });
$('pratos-next').addEventListener('click',()=>{ pratosPage++; renderPratos(); });
$('pratos-search').addEventListener('input',()=>{ pratosPage=1; renderPratos(); });
$('pratos-cat-filter').addEventListener('change',()=>{ pratosPage=1; renderPratos(); });

$('btnNovoPrato').addEventListener('click',()=>{
  pratoEditId=null;
  $('prato-form-title').textContent='Novo prato';
  $('prato-nome').value='';
  $('prato-cat').value='PRATOS';
  $('prato-peso').value=''; $('prato-peso-un').value='g';
  $('prato-preco').value=''; $('prato-custo').value=''; $('prato-ultima').value='';
  $('prato-descricao').value=''; $('prato-codigo-barras').value=''; $('prato-qrcode').value='';
});
$('btnCancelarPrato').addEventListener('click',()=>$('btnNovoPrato').click());
$('tblPratos').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id, act=b.dataset.act;
  const p=pratos.find(x=>String(x.id)===String(id));
  if(act==='edit' && p){
    pratoEditId=p.id; $('prato-form-title').textContent='Editar prato';
    $('prato-nome').value=p.nome||''; $('prato-cat').value=p.categoria||'PRATOS';
    $('prato-peso').value=p.peso??''; $('prato-peso-un').value=p.peso_un||'g';
    $('prato-preco').value=p.preco_venda??''; $('prato-custo').value=p.custo??'';
    $('prato-ultima').value=p.updated_at?new Date(p.updated_at).toLocaleString('pt-BR'):'‚Äî';
    $('prato-descricao').value=p.descricao||''; $('prato-codigo-barras').value=p.codigo_barras||''; $('prato-qrcode').value=p.qrcode||'';
  }
  if(act==='toggle' && p){ await safeUpdate('pratos',{id}, {ativo:!p.ativo}); await loadPratos(); }
  if(act==='del'){ if(!confirm('Excluir prato?')) return; await safeDelete('pratos',{id}); await loadPratos(); }
});
$('btnSalvarPrato').addEventListener('click',async ()=>{
  const nome=$('prato-nome').value.trim(); if(!nome) return alert('Informe o nome do prato');
  const payload={
    nome, categoria:$('prato-cat').value,
    peso:ptToNumber($('prato-peso').value), peso_un:$('prato-peso-un').value,
    preco_venda:$('prato-preco').value.trim()||null, descricao:$('prato-descricao').value.trim()||null
  };
  if(pratoEditId){ await safeUpdate('pratos',{id:pratoEditId},payload); }
  else {
    payload.codigo_barras = `BAR-${crypto.randomUUID()}`;
    payload.qrcode = `QR-${crypto.randomUUID()}`;
    payload.ativo = true;
    await safeInsert('pratos', payload);
  }
  await loadPratos(); $('btnNovoPrato').click(); setStatus('Prato salvo','ok');
});

/* Import do dashboard (preservado/tolerante) */
const DASHBOARD_PRATOS_SOURCE='vendas_pratos_pratos';
async function loadDash(){
  const tb=$('tblDash')?.querySelector('tbody'); if(!tb) return;
  tb.innerHTML='<tr><td colspan="4">Carregando‚Ä¶</td></tr>';
  try{
    let dash=null, err=null;
    ({data:dash, error:err}=await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato,categoria'));
    if(err){ ({data:dash, error:err}=await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato')); }
    if(err) throw err;
    const {data:pr} = await supa.from('pratos').select('nome');
    const exist=new Set((pr||[]).map(p=>p.nome));
    const cat=$('dash-cat').value?.toUpperCase()||'';
    const term=$('dash-search').value?.toLowerCase().trim()||'';
    tb.innerHTML='';
    (dash||[])
      .filter(r=>(!cat||String(r.categoria||'').toUpperCase()===cat) && (!term||String(r.prato||'').toLowerCase().includes(term)))
      .forEach(r=>{
        const already=exist.has(r.prato);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.prato}</td><td>${r.categoria||'<span class="soft">N/D</span>'}</td>
          <td>${already?'<span class="pill">J√° existe</span>':'<span class="pill">Falta importar</span>'}</td>
          <td>${already?'-':`<button class="btn small" data-import="${r.prato.replace(/"/g,'&quot;')}" data-cat="${(r.categoria||'PRATOS').replace(/"/g,'&quot;')}">Importar</button>`}</td>`;
        tb.appendChild(tr);
      });
  }catch(e){
    tb.innerHTML='<tr><td colspan="4">Fonte do dashboard indispon√≠vel.</td></tr>';
  }
}
document.addEventListener('click', async e=>{
  const b=e.target.closest('#tblDash button[data-import]'); if(!b) return;
  const {error} = await supa.from('pratos').insert({nome:b.dataset.import,categoria:b.dataset.cat||'PRATOS',ativo:true});
  if(error && !String(error.message||'').includes('duplicate')) return alert(error.message||error);
  await loadPratos(); await loadDash();
});

/* =========================
   COMPONENTES
========================= */
async function fillOptionsFrom(table, selId, valKey, labelKey, whereEq){
  const sel=$(selId); if(!sel) return; sel.innerHTML='<option value="">Carregando‚Ä¶</option>';
  try{
    let q=supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true});
    if(whereEq) Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v));
    const {data,error}=await q; if(error) throw error;
    sel.innerHTML='<option value="">Selecione</option>';
    (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
  }catch(e){ sel.innerHTML='<option value="">(n/d)</option>'; }
}
async function loadPratoCompTable(){
  const prato_id=$('cp-prato').value; const tb=$('tblPrComp').querySelector('tbody'); tb.innerHTML='';
  if(!prato_id) return;
  try{
    const {data, error}=await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id',prato_id);
    if(error) throw error;
    for(const row of (data||[])){
      const {data:rec}=await supa.from('receitas').select('nome').eq('id',row.receita_id).single();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${rec?.nome||'(removida)'}</td><td>${fmt(row.qtd)}</td><td>${row.unidade}</td>
        <td class="row-actions"><button class="btn small" data-del="${row.id}">Remover</button></td>`;
      tb.appendChild(tr);
    }
  }catch(ex){ tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>'; }
}
$('cp-prato')?.addEventListener('change',()=>{
  const editor=$('componentes-editor');
  if($('cp-prato').value){ editor.style.display='block'; loadPratoCompTable(); }
  else editor.style.display='none';
});
$('btnAddPrComp')?.addEventListener('click',async ()=>{
  const prato_id=$('cp-prato').value, receita_id=$('cp-receita').value, qtd=ptToNumber($('cp-qtd').value), unidade=$('cp-und').value, obs=null;
  if(!prato_id||!receita_id||!qtd) return alert('Selecione prato/receita e informe quantidade');
  const ok = await safeInsert('prato_receitas',{prato_id,receita_id,qtd,unidade,obs});
  if(ok){ $('cp-qtd').value=''; await loadPratoCompTable(); }
});
document.addEventListener('click', async e=>{
  const b=e.target.closest('#tblPrComp button[data-del]'); if(!b) return;
  if(!confirm('Remover receita do prato?')) return;
  await safeDelete('prato_receitas',{id:b.dataset.del}); await loadPratoCompTable();
});

/* =========================
   RECEITAS
========================= */
let recEditId=null, draftItems=[];
$('btnShowNewRecipeForm').addEventListener('click',()=>{$('recipe-editor-container').style.display='block';});
$('btnCancelRecEdit').addEventListener('click',()=>{
  recEditId=null; $('recipe-editor-container').style.display='none';
  $('recipe-form-title').textContent='Nova Receita';
  $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs').value=''; $('rec-preparo').value='';
  $('rec-codigo-barras').value=''; $('rec-qrcode').value='';
  draftItems=[]; renderDraft();
});
async function refreshDraftRefs(){
  const tipo=$('draft-tipo').value;
  if(tipo==='INGREDIENTE') await fillOptionsFrom('ingredientes','draft-ref','id','nome',{ativo:true});
  else await fillOptionsFrom('receitas','draft-ref','id','nome',{ativo:true});
}
$('draft-tipo')?.addEventListener('change',refreshDraftRefs);
function renderDraft(){
  const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML='';
  draftItems.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.tipo}</td><td>${it.nome}</td><td>${fmt(it.qtd)}</td><td>${it.unidade}</td><td>${fmt(it.perda_pct)}%</td>
      <td class="row-actions"><button class="btn small" data-rm="${i}">Remover</button></td>`;
    tb.appendChild(tr);
  });
}
document.addEventListener('click',e=>{
  const b=e.target.closest('#tblDraft button[data-rm]'); if(!b) return;
  draftItems.splice(+b.dataset.rm,1); renderDraft();
});
$('btnDraftAdd')?.addEventListener('click',async ()=>{
  const tipo=$('draft-tipo').value, ref_id=$('draft-ref').value, qtd=ptToNumber($('draft-qtd').value), unidade=$('draft-und').value, perda_pct=ptToNumber($('draft-perda').value);
  if(!ref_id||!qtd) return alert('Selecione a refer√™ncia e informe a quantidade');
  let nome='';
  if(tipo==='INGREDIENTE'){ const {data}=await supa.from('ingredientes').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; }
  else { const {data}=await supa.from('receitas').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; }
  draftItems.push({tipo,ref_id,nome,qtd,unidade,perda_pct}); $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft();
});
$('btnSaveRec')?.addEventListener('click',async ()=>{
  const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null, modo_preparo=$('rec-preparo').value.trim()||null;
  if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
  const payload={nome,rendimento_qtd,unidade_rendimento,perda_pct,obs,modo_preparo,codigo_barras:`BAR-${crypto.randomUUID()}`,qrcode:`QR-${crypto.randomUUID()}`};
  const {data:ins,error}=await supa.from('receitas').insert(payload).select('id').single(); if(error) return alert(error.message||error);
  if(draftItems.length){
    const lines=draftItems.map(d=>({receita_id:ins.id,tipo:d.tipo,ref_id:d.ref_id,qtd:d.qtd,unidade:d.unidade,perda_pct:d.perda_pct}));
    const {error:err2}=await supa.from('receita_itens').insert(lines); if(err2) alert('Receita salva, erro nos itens: '+(err2.message||err2));
  }
  $('btnCancelRecEdit').click(); await loadReceitas(); setStatus('Receita salva','ok');
});
$('btnUpdateRec')?.addEventListener('click',async ()=>{
  if(!recEditId) return;
  const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null, modo_preparo=$('rec-preparo').value.trim()||null;
  if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
  const {error}=await supa.from('receitas').update({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs,modo_preparo}).eq('id',recEditId);
  if(error) return alert(error.message||error);
  await loadReceitas(); setStatus('Receita atualizada','ok');
});
async function loadReceitas(){
  const tb=$('tblRec').querySelector('tbody'); tb.innerHTML='<tr><td colspan="5">Carregando‚Ä¶</td></tr>';
  try{
    const {data,error}=await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true});
    if(error) throw error;
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td><td>${r.itens}</td>
        <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="5">Crie a view <b>v_receitas_resumo</b> (ou libere acesso) para ver o resumo.</td></tr>';
  }
  await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true});
  await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true});
}

/* =========================
   INGREDIENTES
========================= */
async function loadIngredientes(){
  const tb=$('tblIng').querySelector('tbody'); tb.innerHTML='<tr><td colspan="6">Carregando‚Ä¶</td></tr>';
  try{
    const {data,error}=await supa.from('ingredientes').select('*').order('nome',{ascending:true});
    if(error) throw error;
    tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${r.categoria||'‚Äî'}</td><td>${r.unidade}</td><td>R$ ${fmt(r.custo_unitario)}</td>
        <td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
        <td class="row-actions">
          <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
          <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
          <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="6">Erro/Tabela n√£o encontrada: <b>ingredientes</b></td></tr>';
  }
}
$('btnShowNewIngredienteForm').addEventListener('click',()=>{$('ingrediente-editor-container').style.display='block';});
$('btnCancelIngEdit').addEventListener('click',()=>{$('ingrediente-editor-container').style.display='none';});
$('btnSaveIng').addEventListener('click',async ()=>{
  const nome=$('ing-nome').value.trim(); if(!nome) return alert('Informe o nome');
  const payload={nome, categoria:$('ing-categoria').value, unidade:$('ing-und').value, custo_unitario:ptToNumber($('ing-custo').value), ativo:true,
    codigo_barras:`BAR-${crypto.randomUUID()}`, qrcode:`QR-${crypto.randomUUID()}`};
  const ok=await safeInsert('ingredientes',payload); if(ok){ $('ingrediente-editor-container').style.display='none'; await loadIngredientes(); }
});

/* =========================
   NOVOS CADASTROS
========================= */
/* Unidades de Medida */
let umEditId=null;
$('btnShowUMForm').addEventListener('click',()=>{$('um-editor').style.display='block';});
$('btnCancelUM').addEventListener('click',()=>{$('um-editor').style.display='none';umEditId=null;});
$('btnSaveUM').addEventListener('click',async ()=>{
  const sigla=$('um-sigla').value.trim(), nome=$('um-nome').value.trim();
  if(!sigla||!nome) return alert('Informe sigla e nome');
  const payload={sigla, nome, codigo:$('um-codigo').value.trim()||null, base:$('um-base').value.trim()||null, fator:ptToNumber($('um-fator').value)||1, ativo:$('um-ativo').value==='true'};
  const ok = umEditId? await safeUpdate('unidades_medida',{id:umEditId},payload) : await safeInsert('unidades_medida',payload);
  if(ok){ $('um-editor').style.display='none'; umEditId=null; await loadUM(); }
});
async function loadUM(){
  const data = await safeSelect('unidades_medida','id,sigla,nome,codigo,base,fator,ativo',{order:'nome'});
  const tb=$('tblUM').querySelector('tbody'); tb.innerHTML='';
  if(!data){ tb.innerHTML='<tr><td colspan="7">Tabela <b>unidades_medida</b> indispon√≠vel.</td></tr>'; return; }
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.sigla}</td><td>${r.nome}</td><td>${r.codigo||'‚Äî'}</td><td>${r.base||'‚Äî'}</td><td>${fmt(r.fator)}</td>
      <td>${r.ativo?'<span class="pill ok">Sim</span>':'<span class="pill bad">N√£o</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-um-edit="${r.id}">Editar</button>
        <button class="btn small" data-um-del="${r.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
}
document.addEventListener('click',async e=>{
  const b1=e.target.closest('button[data-um-edit]'); if(b1){
    const id=b1.dataset.umEdit; const {data}=await supa.from('unidades_medida').select('*').eq('id',id).single();
    if(data){ umEditId=id; $('um-editor').style.display='block';
      $('um-sigla').value=data.sigla||''; $('um-nome').value=data.nome||''; $('um-codigo').value=data.codigo||'';
      $('um-base').value=data.base||''; $('um-fator').value=data.fator||1; $('um-ativo').value=String(!!data.ativo);
    }
  }
  const b2=e.target.closest('button[data-um-del]'); if(b2){
    if(!confirm('Excluir unidade de medida?')) return;
    await safeDelete('unidades_medida',{id:b2.dataset.umDel}); await loadUM();
  }
});

/* Unidades (Destino) */
let unEditId=null;
$('btnShowUnForm').addEventListener('click',()=>{$('un-editor').style.display='block';});
$('btnCancelUn').addEventListener('click',()=>{$('un-editor').style.display='none';unEditId=null;});
$('btnSaveUn').addEventListener('click',async ()=>{
  const nome=$('un-nome').value.trim(); if(!nome) return alert('Informe o nome');
  const ok = unEditId? await safeUpdate('unidades',{id:unEditId},{nome}) : await safeInsert('unidades',{nome});
  if(ok){ $('un-editor').style.display='none'; unEditId=null; await loadUnidades(); }
});
async function loadUnidades(){
  const data = await safeSelect('unidades','id,nome',{order:'nome'});
  const tb=$('tblUn').querySelector('tbody'); tb.innerHTML='';
  if(!data){ tb.innerHTML='<tr><td colspan="2">Tabela <b>unidades</b> indispon√≠vel ou sem permiss√£o.</td></tr>'; return; }
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td>
      <td class="row-actions"><button class="btn small" data-un-edit="${r.id}">Editar</button><button class="btn small" data-un-del="${r.id}">Excluir</button></td>`;
    tb.appendChild(tr);
  });
}
document.addEventListener('click',async e=>{
  const b1=e.target.closest('button[data-un-edit]'); if(b1){
    const id=b1.dataset.unEdit; const {data}=await supa.from('unidades').select('*').eq('id',id).single();
    if(data){ unEditId=id; $('un-editor').style.display='block'; $('un-nome').value=data.nome||''; }
  }
  const b2=e.target.closest('button[data-un-del]'); if(b2){
    if(!confirm('Excluir unidade?')) return;
    await safeDelete('unidades',{id:b2.dataset.unDel}); await loadUnidades();
  }
});

/* Categorias (sem campo tipo) */
let catEditId=null;
$('btnShowCatForm').addEventListener('click',()=>{$('cat-editor').style.display='block';});
$('btnCancelCat').addEventListener('click',()=>{$('cat-editor').style.display='none';catEditId=null;});
$('btnSaveCat').addEventListener('click',async ()=>{
  const nome=$('cat-nome').value.trim(); if(!nome) return alert('Informe o nome');
  const ativo=$('cat-ativo').value==='true';
  const ok = catEditId? await safeUpdate('categorias',{id:catEditId},{nome,ativo}) : await safeInsert('categorias',{nome,ativo});
  if(ok){ $('cat-editor').style.display='none'; catEditId=null; await loadCategorias(); }
});
async function loadCategorias(){
  // apenas colunas seguras ‚Üí evita 400 em "categorias.tipo"
  const data = await safeSelect('categorias','id,nome,ativo',{order:'nome'});
  const tb=$('tblCat').querySelector('tbody'); tb.innerHTML='';
  if(!data){ tb.innerHTML='<tr><td colspan="3">Tabela <b>categorias</b> indispon√≠vel.</td></tr>'; return; }
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td><td>${r.ativo?'<span class="pill ok">Sim</span>':'<span class="pill bad">N√£o</span>'}</td>
      <td class="row-actions"><button class="btn small" data-cat-edit="${r.id}">Editar</button><button class="btn small" data-cat-del="${r.id}">Excluir</button></td>`;
    tb.appendChild(tr);
  });
}
document.addEventListener('click',async e=>{
  const b1=e.target.closest('button[data-cat-edit]'); if(b1){
    const id=b1.dataset.catEdit; const {data}=await supa.from('categorias').select('*').eq('id',id).single();
    if(data){ catEditId=id; $('cat-editor').style.display='block'; $('cat-nome').value=data.nome||''; $('cat-ativo').value=String(!!data.ativo); }
  }
  const b2=e.target.closest('button[data-cat-del]'); if(b2){
    if(!confirm('Excluir categoria?')) return;
    await safeDelete('categorias',{id:b2.dataset.catDel}); await loadCategorias();
  }
});

/* Tipos de Item (tolerante) */
let tipoEditId=null;
$('btnShowTipoForm').addEventListener('click',()=>{$('tipo-editor').style.display='block';});
$('btnCancelTipo').addEventListener('click',()=>{$('tipo-editor').style.display='none';tipoEditId=null;});
$('btnSaveTipo').addEventListener('click',async ()=>{
  const codigo=$('tipo-cod').value.trim(); const nome=$('tipo-nome').value.trim();
  if(!codigo||!nome) return alert('Informe c√≥digo e nome');
  // tenta usar item_tipos; se 404/erro, avisa e n√£o quebra
  try{
    if(tipoEditId){ const {error}=await supa.from('item_tipos').update({codigo,nome}).eq('id',tipoEditId); if(error) throw error; }
    else { const {error}=await supa.from('item_tipos').insert({codigo,nome,ativo:true}); if(error) throw error; }
    $('tipo-editor').style.display='none'; tipoEditId=null; await loadTiposItem();
  }catch(err){ alert('Tabela opcional "item_tipos" n√£o dispon√≠vel. Mantendo refer√™ncia ING/REC.'); }
});
async function loadTiposItem(){
  const tb=$('tblTipos').querySelector('tbody'); tb.innerHTML='';
  try{
    const {data,error}=await supa.from('item_tipos').select('id,codigo,nome,ativo').order('codigo');
    if(error) throw error;
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.codigo}</td><td>${r.nome}</td><td>${r.ativo?'<span class="pill ok">Sim</span>':'<span class="pill bad">N√£o</span>'}</td>
        <td class="row-actions"><button class="btn small" data-tipo-edit="${r.id}">Editar</button><button class="btn small" data-tipo-del="${r.id}">Excluir</button></td>`;
      tb.appendChild(tr);
    });
  }catch(_){
    // fallback: mostrar ING/REC apenas para refer√™ncia
    const fallback=[{codigo:'ING',nome:'Ingrediente',ativo:true},{codigo:'REC',nome:'Receita',ativo:true}];
    fallback.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.codigo}</td><td>${r.nome}</td><td><span class="pill ok">Sim</span></td><td class="row-actions">‚Äî</td>`;
      tb.appendChild(tr);
    });
  }
}
document.addEventListener('click',async e=>{
  const b1=e.target.closest('button[data-tipo-edit]'); if(b1){
    const id=b1.dataset.tipoEdit; const {data}=await supa.from('item_tipos').select('*').eq('id',id).single();
    if(data){ tipoEditId=id; $('tipo-editor').style.display='block'; $('tipo-cod').value=data.codigo||''; $('tipo-nome').value=data.nome||''; }
  }
  const b2=e.target.closest('button[data-tipo-del]'); if(b2){
    if(!confirm('Excluir tipo?')) return;
    await safeDelete('item_tipos',{id:b2.dataset.tipoDel}); await loadTiposItem();
  }
});

/* =========================
   PRODU√á√ÉO ‚Äî Previs√£o (preservado/tolerante)
========================= */
function toBase(value,unit){ const u=(unit||'').toLowerCase(); if(u==='kg') return {v:value*1000,u:'g'}; if(u==='l') return {v:value*1000,u:'ml'}; if(u==='porcao') return {v:value,u:'un'}; return {v:value,u:(u==='ml'||u==='l')?'ml':(u==='kg'||u==='g')?'g':unit}; }
async function preencherCategorias(){
  try{
    const {data}=await supa.from('pratos').select('categoria').not('categoria','is',null);
    const cats=[...new Set((data||[]).map(x=>x.categoria||'OUTROS'))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
    const sel=$('cat-filter'); sel.innerHTML=''; cats.forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);});
  }catch(_){}
}
async function obterUltimaDataVenda(){
  try{
    const {data}=await supa.from('vendas_pratos_view_only_pratos').select('data').order('data',{ascending:false}).limit(1).maybeSingle();
    return data?.data || todayStr();
  }catch(_){ return todayStr(); }
}
async function calcularPrevisaoReal(){
  const win = Math.max(1, +$('win-dias').value||7);
  const proj = Math.max(1, +$('proj-dias').value||7);
  const refReal = await obterUltimaDataVenda();
  $('prev-hint-top').textContent = `√öltima data com lan√ßamento: ${refReal}.`;

  $('th-proj').textContent = `Qtd/Proje√ß√£o (${proj} dias)`;
  $('th-proj-prato').textContent = `Proje√ß√£o (${proj} dias)`;

  let vendas=[]; try{
    const fim = refReal; const ini=new Date(refReal); ini.setDate(new Date(refReal).getDate()-(win-1));
    const isoIni=ini.toISOString().slice(0,10), isoFim=fim;
    const r = await supa.from('vendas_pratos_view_only_pratos').select('data,prato,quantidade').gte('data',isoIni).lte('data',isoFim);
    vendas = r.data||[];
  }catch(_){ setStatus('Erro ao ler vendas','err'); return; }

  const {data:pratosTbl}=await supa.from('pratos').select('id,nome,categoria');
  const nomeToId = new Map((pratosTbl||[]).map(p=>[p.nome,p.id]));
  const nomeToCat= new Map((pratosTbl||[]).map(p=>[p.nome,p.categoria||'OUTROS']));
  const selCats = new Set(Array.from($('cat-filter').selectedOptions||[]).map(o=>o.value));
  const filtraCat = (pratoNome)=> selCats.size? selCats.has(nomeToCat.get(pratoNome)||'OUTROS') : true;

  const porPrato = new Map();
  (vendas||[]).forEach(v=>{ if(!filtraCat(v.prato)) return; porPrato.set(v.prato,(porPrato.get(v.prato)||0)+(v.quantidade||0)); });
  const mediaPratoDia = new Map([...porPrato.entries()].map(([p,tot])=> [p, tot / win] ));

  const tbResumo=$('tblResumoPratos').querySelector('tbody'); tbResumo.innerHTML='';
  [...mediaPratoDia.entries()].map(([nome,md])=>({nome,cat:nomeToCat.get(nome)||'‚Äî', md, proj: md*proj}))
    .sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'))
    .forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.cat}</td><td>${fmt(r.md)}</td><td>${fmt(r.proj)}</td>`; tbResumo.appendChild(tr); });

  // Consolida√ß√£o por receita
  const pratoIds = [...mediaPratoDia.keys()].map(n=> nomeToId.get(n)).filter(Boolean);
  let pratoReceitas=[]; if(pratoIds.length){ const {data:prc}=await supa.from('prato_receitas').select('prato_id,receita_id,qtd,unidade').in('prato_id',pratoIds); pratoReceitas=prc||[]; }
  const recTotals=new Map();
  pratoReceitas.forEach(r=>{
    const pratoNome=(pratosTbl||[]).find(p=>p.id===r.prato_id)?.nome;
    if(!mediaPratoDia.has(pratoNome)) return;
    const add=(mediaPratoDia.get(pratoNome)||0) * (r.qtd||0);
    const prev=recTotals.get(r.receita_id)||{perDia:0,un:r.unidade||'g'};
    prev.perDia+=add; prev.un=r.unidade||prev.un; recTotals.set(r.receita_id,prev);
  });
  const recIds=[...recTotals.keys()];
  let receitasMeta=new Map();
  if(recIds.length){ const {data:recMeta}=await supa.from('receitas').select('id,nome').in('id',recIds); receitasMeta=new Map((recMeta||[]).map(r=>[r.id,r])); }
  const tb=$('tblPrev').querySelector('tbody'); tb.innerHTML='';
  [...recTotals.entries()]
    .map(([id,agg])=>({id, nome: receitasMeta.get(id)?.nome || ('Receita #'+id), un: agg.un, dia: agg.perDia, proj: agg.perDia*proj}))
    .sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'))
    .forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.un}</td><td>${fmt(r.dia)}</td><td>${fmt(r.proj)}</td>`; tb.appendChild(tr); });

  $('kpi-dias').textContent=String(win);
  $('kpi-pratos').textContent=String(mediaPratoDia.size);
  $('kpi-rec').textContent=String(recTotals.size);
  $('prev-hint').textContent=`Janela: ${win} dia(s). Proje√ß√£o: ${proj} dia(s).`;
}
$('btnCalcularPrev').addEventListener('click',calcularPrevisaoReal);

/* =========================
   COMPRAS ‚Äî lista simples (placeholder seguro)
========================= */
async function loadSugestoes(){
  const tb=$('tblSugestoes').querySelector('tbody'); tb.innerHTML='<tr><td colspan="7">Calculando‚Ä¶</td></tr>';
  try{
    // Se voc√™ tiver uma view MV, troque a fonte aqui; sen√£o mant√©m placeholder
    const data = await safeSelect('vw_lista_compras','item_nome,status,saldo,ponto_pedido,consumo_medio,sugerido_compra,multiplo_compra',{order:'item_nome'});
    tb.innerHTML='';
    if(!data){ tb.innerHTML='<tr><td colspan="7">Crie/libere a view <b>vw_lista_compras</b> para usar as sugest√µes.</td></tr>'; return; }
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.item_nome}</td><td>${r.status||'‚Äî'}</td><td>${fmt(r.saldo)}</td><td>${fmt(r.ponto_pedido||0)}</td><td>${fmt(r.consumo_medio||0)}</td><td><b>${fmt(r.sugerido_compra||0)}</b></td><td>${fmt(r.multiplo_compra||1)}</td>`;
      tb.appendChild(tr);
    });
  }catch(_){}
}
$('btnRefreshSuggestions').addEventListener('click',loadSugestoes);
$('btnExportSuggestions').addEventListener('click',()=>{
  const rows=[['Item','Status','Saldo','PontoPedido','ConsumoDia','Sugestao','Multiplo']];
  $$('#tblSugestoes tbody tr').forEach(tr=>{
    rows.push(Array.from(tr.children).map(td=>td.textContent.trim()));
  });
  const csv=rows.map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='sugestoes_compra.csv'; a.click();
});

/* =========================
   ESTOQUE ‚Äî Vis√£o e Movimentar
========================= */
async function loadVisaoEstoque(){
  const saldo = await safeSelect('vw_estoque_saldos','item_id,item_tipo,un_medida,saldo,custo_medio,valor',{});
  const tb=$('tblSaldo').querySelector('tbody'); tb.innerHTML='';
  if(!saldo){ tb.innerHTML='<tr><td colspan="6">Crie/libere a view <b>vw_estoque_saldos</b>.</td></tr>'; $('estoque-visao-hint').textContent=''; return; }
  saldo.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.item_id}</td><td>${r.item_tipo}</td><td>${r.un_medida||'‚Äî'}</td><td>${fmt(r.saldo)}</td><td>R$ ${fmt(r.custo_medio||0)}</td><td>R$ ${fmt(r.valor||0)}</td>`;
    tb.appendChild(tr);
  });

  const lotes = await safeSelect('vw_estoque_saldos_resumo','item_nome,lote,validade,saldo,un_medida,custo_unit',{});
  const tb2=$('tblSaldoLotes').querySelector('tbody'); tb2.innerHTML='';
  if(!lotes){ tb2.innerHTML='<tr><td colspan="6">Crie/libere a view <b>vw_estoque_saldos_resumo</b>.</td></tr>'; $('estoque-visao-hint').textContent=''; return; }
  lotes.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.item_nome||'‚Äî'}</td><td>${r.lote||'‚Äî'}</td><td>${r.validade||'‚Äî'}</td><td>${fmt(r.saldo)}</td><td>${r.un_medida||'‚Äî'}</td><td>R$ ${fmt(r.custo_unit||0)}</td>`;
    tb2.appendChild(tr);
  });
  $('estoque-visao-hint').textContent = '';
}

/* Movimenta√ß√µes */
function showMovForm(kind){
  $('mov-form-container').style.display='block';
  $('mov-form-title').textContent = ({ENTRADA:'Registrar ENTRADA',SAIDA:'Registrar SA√çDA',TRANSFERENCIA:'Transfer√™ncia entre unidades',AJUSTE:'Ajuste de estoque'})[kind]||'Movimenta√ß√£o';
  $('mov-ajuste-sinal-group').style.display = (kind==='AJUSTE')?'block':'none';
  $('mov-unidade-destino-group').style.display = (kind==='TRANSFERENCIA')?'block':'none';
  $('mov-custo-group').style.display = (kind==='ENTRADA')?'block':'none';
  $('mov-validade-group').style.display = (kind==='ENTRADA')?'block':'none';
  $('frmMov').dataset.kind = kind;
}
$$('#sub-estoque-mov .mov-actions .btn').forEach(b=>b.addEventListener('click',()=>showMovForm(b.dataset.movType)));
$('btnMovCancel').addEventListener('click',()=>{$('mov-form-container').style.display='none';});

async function loadUnidadesTo(selId){
  const sel=$(selId); sel.innerHTML='';
  const data=await safeSelect('unidades','id,nome',{order:'nome'});
  if(!data){ sel.innerHTML='<option value="">(sem acesso)</option>'; return; }
  data.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.nome; sel.appendChild(o); });
}
async function loadItensTo(selId){
  const sel=$(selId); sel.innerHTML='';
  try{
    const ig=(await supa.from('ingredientes').select('id,nome').order('nome')).data||[];
    const rc=(await supa.from('receitas').select('id,nome').order('nome')).data||[];
    const optg1=document.createElement('optgroup'); optg1.label='Ingredientes'; ig.forEach(x=>{const o=document.createElement('option'); o.value='ING|'+x.id; o.textContent=x.nome; optg1.appendChild(o);});
    const optg2=document.createElement('optgroup'); optg2.label='Receitas'; rc.forEach(x=>{const o=document.createElement('option'); o.value='REC|'+x.id; o.textContent=x.nome; optg2.appendChild(o);});
    sel.appendChild(optg1); sel.appendChild(optg2);
  }catch(e){ sel.innerHTML='<option value="">(sem acesso)</option>'; }
}
$('frmMov').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const kind=ev.currentTarget.dataset.kind||'ENTRADA';
  const itemCombo=$('mov-item').value||'';
  const [item_tipo,item_id]=itemCombo.split('|');
  if(!item_id) return alert('Selecione o item');
  const base={
    id:crypto.randomUUID(),
    unidade_id:$('mov-unidade-origem').value||null,
    item_tipo, item_id,
    un:$('mov-un').value||null,
    un_medida:$('mov-un').value||null,
    qtd: +$('mov-qtd').value || 0,
    custo_unit: kind==='ENTRADA' ? (+$('mov-custo').value||0) : null,
    ts:new Date().toISOString(),
    usuario:'app',
    ref_doc:$('mov-doc').value||null
  };
  let rows=[];
  if(kind==='ENTRADA'){ rows.push({...base,tipo:'ENTRADA', validade:$('mov-validade').value||null, lote:$('mov-lote').value||null}); }
  if(kind==='SAIDA'){ rows.push({...base,tipo:'SAIDA'}); }
  if(kind==='AJUSTE'){ const sign=$('mov-ajuste-sinal').value==='-'?-1:1; rows.push({...base,tipo: sign>0?'AJUSTE_POSITIVO':'AJUSTE_NEGATIVO', qtd: Math.abs(base.qtd)*sign}); }
  if(kind==='TRANSFERENCIA'){
    const destino=$('mov-unidade-destino').value||null; if(!destino) return alert('Escolha a unidade destino');
    const ref=`TR-${Date.now()}`;
    rows.push({...base,tipo:'TRANSFER_SAIDA',ref_doc:ref});
    rows.push({...base,tipo:'TRANSFER_ENTRADA',unidade_id:destino,ref_doc:ref});
  }
  const ok = await safeInsert('mov_estoque', rows);
  if(ok){ $('mov-form-container').style.display='none'; setStatus('Movimenta√ß√£o registrada','ok'); await loadMovRecentes(); await loadVisaoEstoque(); }
});
async function loadMovRecentes(){
  const tb=$('tblMovRecentes').querySelector('tbody'); tb.innerHTML='';
  try{
    const {data}=await supa.from('mov_estoque').select('ts,tipo,item_tipo,item_id,qtd,unidade_id').order('ts',{ascending:false}).limit(20);
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${new Date(r.ts).toLocaleString('pt-BR')}</td><td>${r.tipo}</td><td>${r.item_tipo}</td><td>${fmt(r.qtd)}</td><td>${r.unidade_id?.slice(0,8)||'‚Äî'}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){ tb.innerHTML='<tr><td colspan="5">Sem acesso a <b>mov_estoque</b>.</td></tr>'; }
}

/* =========================
   BOOT
========================= */
async function boot(){
  setStatus('Carregando dados...');

  // Cadastros principais
  await loadPratos();
  await loadReceitas();
  await loadIngredientes();
  await loadDash();

  // Novos cadastros
  await loadUM();
  await loadUnidades();
  await loadCategorias();
  await loadTiposItem();

  // Produ√ß√£o
  await preencherCategorias();

  // Estoque
  await loadUnidadesTo('mov-unidade-origem');
  await loadUnidadesTo('mov-unidade-destino');
  await loadItensTo('mov-item');
  await loadVisaoEstoque();
  await loadMovRecentes();

  setStatus('Pronto','ok');
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
