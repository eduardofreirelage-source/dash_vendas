<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ERP Cozinha — Cadastros, Estoque & Compras</title>
<!-- Favicon inline para evitar 404 -->
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">ERP</text></svg>'/>
<style>
:root{
  --bg:#f6f7fb;--paper:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;
  --brand:#7b1e3a;--brand2:#8c2947;--ok:#065f46;--warn:#b45309;--bad:#b91c1c;
  --radius:12px;--shadow:0 8px 28px rgba(16,24,40,.06)
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;height:100%}
h1,h2,h3{margin:0 0 10px;font-weight:600}
h1{font-size:20px}h2{font-size:18px}h3{font-size:16px}
.main{display:flex;flex-direction:column;height:100%}
.top{position:sticky;top:0;background:var(--paper);z-index:10;border-bottom:1px solid var(--line);padding:10px 14px;display:flex;align-items:center;gap:12px;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;border-radius:10px;background:var(--brand);display:grid;place-items:center;color:#fff;font-weight:700}
.tabs{display:flex;gap:6px}
.tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;color:#334155;border-radius:8px;cursor:pointer;position:relative}
.tabs button.active{color:var(--brand)}
.tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--brand)}
.content{max-width:1280px;margin:0 auto;padding:18px 16px;flex:1;min-height:0;width:100%}
.card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.tab{display:none}.tab.active{display:block}
.subtabs{display:flex;gap:6px;border-bottom:1px solid var(--line);margin-bottom:14px;padding-bottom:10px;flex-wrap:wrap}
.subtabs button{padding:7px 12px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;color:#475569;cursor:pointer;position:relative}
.subtabs button.active{color:var(--brand)}
.subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-11px;height:3px;border-radius:2px;background:var(--brand)}
.subpage{display:none}.subpage.active{display:block}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:repeat(2,1fr)}
.cols-3{grid-template-columns:repeat(3,1fr)}
.cols-4{grid-template-columns:repeat(4,1fr)}
@media(max-width:1020px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
label{font-size:13px;color:#475569;display:block;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit}
textarea{min-height:80px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
.btn.pri{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.small{padding:6px 10px;font-size:12px}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.table{overflow:auto;border:1px solid var(--line);border-radius:12px}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:middle;font-size:13px}
thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:#64748b}
tbody tr:hover{background:#fafafb}
tbody tr:last-child td{border-bottom:0}
.row-actions{display:flex;gap:6px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:#475569;background:#f1f5f9}
.badge.ok{color:var(--ok);border-color:#a7f3d0;background:#dcfce7}
.badge.bad{color:var(--bad);border-color:#fecaca;background:#fef2f2}
.muted{color:#64748b}
.sep{height:1px;background:var(--line);margin:16px 0}
.note{background:#fff7ed;border:1px solid #fde68a;color:#92400e;padding:12px;border-radius:10px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi .l{font-size:12px;color:#64748b}.kpi .v{font-size:18px;font-weight:700}
.errbox{border:1px dashed #fca5a5;background:#fff1f2;color:#991b1b;padding:12px;border-radius:10px;margin-top:10px}
details.help{border:1px dashed #cbd5e1;padding:14px;border-radius:12px;background:#fafbff;margin-top:12px}
details.help summary{cursor:pointer;font-weight:600}
.statusbar{font-size:13px;color:#475569}
.statusbar b{color:var(--brand)}
</style>
</head>
<body>
<div class="main">
  <div class="top">
    <div class="brand"><div class="logo">ERP</div>
      <div><h1>ERP Cozinha</h1><div class="muted">Cadastros • Estoque • Compras • Produção</div></div>
    </div>
    <div class="statusbar">Estado: <b id="status">inicializando…</b></div>
    <nav class="tabs" id="tabs">
      <button data-tab="cad" class="active">Cadastros</button>
      <button data-tab="est">Estoque</button>
      <button data-tab="cmp">Compras</button>
      <button data-tab="pro">Produção</button>
    </nav>
  </div>

  <div class="content">
    <!-- ================= CADASTROS ================= -->
    <section id="tab-cad" class="tab active">
      <div class="card">
        <div class="subtabs" id="sub-cad">
          <button data-sub="um" class="active">Unidades de Medida</button>
          <button data-sub="uni">Unidades (destino)</button>
          <button data-sub="cat">Categorias</button>
          <button data-sub="tip">Tipos de Item</button>
        </div>

        <!-- UM -->
        <div id="cad-um" class="subpage active">
          <div class="kpis">
            <div class="kpi"><div class="l">Unidades</div><div class="v" id="k_um_total">—</div></div>
            <div class="kpi"><div class="l">Ativas</div><div class="v" id="k_um_ativas">—</div></div>
            <div class="kpi"><div class="l">Bases</div><div class="v" id="k_um_bases">—</div></div>
            <div class="kpi"><div class="l">Fatores inválidos</div><div class="v" id="k_um_inv">—</div></div>
          </div>
          <div class="grid cols-4">
            <div><label>Sigla</label><input id="um_sigla" placeholder="KG"></div>
            <div><label>Nome</label><input id="um_nome" placeholder="Quilograma"></div>
            <div><label>Código</label><input id="um_codigo" placeholder="kg"></div>
            <div><label>Base</label>
              <select id="um_base"><option value="">—</option><option value="g">g</option><option value="ml">ml</option><option value="un">un</option></select>
            </div>
          </div>
          <div class="grid cols-4" style="margin-top:8px">
            <div><label>Fator</label><input id="um_fator" type="number" step="0.000001" min="0" placeholder="1000"></div>
            <div><label>Ativo</label><select id="um_ativo"><option value="true">Sim</option><option value="false">Não</option></select></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_um_salvar" class="btn pri">Salvar</button>
              <button id="btn_um_novo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_um"><thead><tr>
            <th>Sigla</th><th>Nome</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th>Ações</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_um" class="errbox" style="display:none"></div>
          <details class="help" id="help_um" style="display:none"><summary>SQL sugerido — unidades_medida</summary><pre id="sql_um"></pre></details>
        </div>

        <!-- Unidades -->
        <div id="cad-uni" class="subpage">
          <div class="grid cols-3">
            <div><label>Nome da unidade</label><input id="u_nome" placeholder="Depósito Principal"></div>
            <div><label>Ativo</label><select id="u_ativo"><option value="true">Sim</option><option value="false">Não</option></select></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_u_salvar" class="btn pri">Salvar</button>
              <button id="btn_u_novo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_u"><thead><tr>
            <th>Nome</th><th>Ativo</th><th>Ações</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_u" class="errbox" style="display:none"></div>
          <details class="help" id="help_u" style="display:none"><summary>SQL sugerido — unidades</summary><pre id="sql_u"></pre></details>
        </div>

        <!-- Categorias -->
        <div id="cad-cat" class="subpage">
          <div class="grid cols-4">
            <div><label>Nome</label><input id="c_nome" placeholder="Carnes"></div>
            <div><label>Tipo</label><select id="c_tipo"><option value="">—</option><option>INGREDIENTE</option><option>RECEITA</option><option>PRATO</option><option>OUTRO</option></select></div>
            <div><label>Ativo</label><select id="c_ativo"><option value="true">Sim</option><option value="false">Não</option></select></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_c_salvar" class="btn pri">Salvar</button>
              <button id="btn_c_novo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_c"><thead><tr>
            <th>Nome</th><th>Tipo</th><th>Ativo</th><th>Ações</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_c" class="errbox" style="display:none"></div>
          <details class="help" id="help_c" style="display:none"><summary>SQL sugerido — categorias</summary><pre id="sql_c"></pre></details>
        </div>

        <!-- Tipos de item -->
        <div id="cad-tip" class="subpage">
          <div class="grid cols-4">
            <div><label>Nome</label><input id="t_nome" placeholder="Ingrediente"></div>
            <div><label>Código</label><input id="t_codigo" placeholder="ING"></div>
            <div><label>Ativo</label><select id="t_ativo"><option value="true">Sim</option><option value="false">Não</option></select></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_t_salvar" class="btn pri">Salvar</button>
              <button id="btn_t_novo" class="btn">Novo</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_t"><thead><tr>
            <th>Nome</th><th>Código</th><th>Ativo</th><th>Ações</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_t" class="errbox" style="display:none"></div>
          <details class="help" id="help_t" style="display:none"><summary>SQL sugerido — tipos_item</summary><pre id="sql_t"></pre></details>
        </div>
      </div>
    </section>

    <!-- ================= ESTOQUE ================= -->
    <section id="tab-est" class="tab">
      <div class="card">
        <div class="subtabs" id="sub-est">
          <button data-sub="mov" class="active">Movimentações</button>
          <button data-sub="saldos">Saldos</button>
          <button data-sub="resumo">Resumo</button>
        </div>

        <!-- Movimentações -->
        <div id="est-mov" class="subpage active">
          <div class="grid cols-4">
            <div><label>Unidade (UUID)</label><input id="mv_unidade" placeholder="UUID da unidade"></div>
            <div><label>Item Tipo</label><select id="mv_item_tipo"><option>ING</option><option>REC</option><option>PRT</option></select></div>
            <div><label>Item ID (UUID)</label><input id="mv_item_id" placeholder="UUID do item"></div>
            <div><label>UM</label><input id="mv_un" placeholder="kg/g/ml/un"></div>
          </div>
          <div class="grid cols-4">
            <div><label>Quantidade</label><input id="mv_qtd" type="number" step="0.000001"></div>
            <div><label>Tipo</label><select id="mv_tipo">
              <option>ENTRADA</option><option>SAIDA</option>
              <option>TRANSFER_SAIDA</option><option>TRANSFER_ENTRADA</option>
              <option>AJUSTE_POSITIVO</option><option>AJUSTE_NEGATIVO</option>
              <option>INVENTARIO</option>
            </select></div>
            <div><label>Custo Unit (R$)</label><input id="mv_custo" type="number" step="0.01"></div>
            <div><label>Ref. Doc</label><input id="mv_ref" placeholder="opcional"></div>
          </div>
          <div class="grid cols-3">
            <div><label>Usuário</label><input id="mv_user" placeholder="dashboard"></div>
            <div><label>UM Medida</label><input id="mv_un_medida" placeholder="kg/g/ml/un"></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_mv_lancar" class="btn pri">Lançar</button>
              <button id="btn_mv_limpar" class="btn">Limpar</button>
            </div>
          </div>
          <div id="err_mv" class="errbox" style="display:none"></div>
        </div>

        <!-- Saldos -->
        <div id="est-saldos" class="subpage">
          <div class="table"><table id="tb_saldos"><thead><tr>
            <th>Unidade</th><th>Item tipo</th><th>Item</th><th>UM</th><th>Saldo</th><th>Valor</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_es1" class="errbox" style="display:none"></div>
          <details class="help" id="help_es1" style="display:none"><summary>SQL sugerido — vw_estoque_saldos</summary><pre id="sql_es1"></pre></details>
        </div>

        <!-- Resumo -->
        <div id="est-resumo" class="subpage">
          <div class="table"><table id="tb_resumo"><thead><tr>
            <th>Unidade</th><th>Item</th><th>UM</th><th>Saldo</th><th>Mín</th><th>Máx</th><th>Status</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_es2" class="errbox" style="display:none"></div>
          <details class="help" id="help_es2" style="display:none"><summary>SQL sugerido — vw_estoque_saldos_resumo</summary><pre id="sql_es2"></pre></details>
        </div>
      </div>
    </section>

    <!-- ================= COMPRAS ================= -->
    <section id="tab-cmp" class="tab">
      <div class="card">
        <div class="subtabs" id="sub-cmp">
          <button data-sub="sug" class="active">Sugestões</button>
          <button data-sub="ped">Gerar Pedido</button>
          <button data-sub="lst">Pedidos</button>
          <button data-sub="rcb">Receber</button>
          <button data-sub="est">Estornar</button>
        </div>

        <!-- Sugestões (vw_lista_compras) -->
        <div id="cmp-sug" class="subpage active">
          <div class="grid cols-3">
            <div><label>Unidade (UUID)</label><input id="cmp_sug_unidade" placeholder="UUID da unidade"></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_cmp_sug_atualizar" class="btn pri">Atualizar</button>
              <button id="btn_cmp_sug_limpar" class="btn">Limpar</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_sug"><thead><tr>
            <th>Unidade</th><th>Fornecedor</th><th>Item</th><th>UM</th><th>Sugerido</th><th>Múltiplo</th><th>Qtd comprar</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_cmp_sug" class="errbox" style="display:none"></div>
          <details class="help" id="help_cmp_sug" style="display:none"><summary>SQL sugerido — vw_lista_compras</summary><pre id="sql_cmp_sug"></pre></details>
        </div>

        <!-- Gerar Pedido (RPC gerar_pedidos_compra) -->
        <div id="cmp-ped" class="subpage">
          <div class="grid cols-3">
            <div><label>Unidade (UUID)</label><input id="cmp_ped_unidade" placeholder="UUID da unidade"></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_cmp_ped_gerar" class="btn pri">Gerar</button>
              <button id="btn_cmp_ped_limpar" class="btn">Limpar</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_pedidos_gerados"><thead><tr>
            <th>Pedido ID</th><th>Fornecedor</th><th>Itens</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_cmp_ped" class="errbox" style="display:none"></div>
          <details class="help" id="help_cmp_ped" style="display:none"><summary>SQL sugerido — RPC gerar_pedidos_compra</summary><pre id="sql_cmp_ped"></pre></details>
        </div>

        <!-- Listar pedidos -->
        <div id="cmp-lst" class="subpage">
          <div class="grid cols-3">
            <div><label>Status</label><select id="lst_status"><option value="">(todos)</option><option>ABERTO</option><option>PARCIAL</option><option>RECEBIDO</option><option>CANCELADO</option></select></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_lst_atualizar" class="btn pri">Atualizar</button>
              <button id="btn_lst_limpar" class="btn">Limpar</button>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table"><table id="tb_pedidos"><thead><tr>
            <th>ID</th><th>Unidade</th><th>Status</th><th>Total</th><th>Data</th>
          </tr></thead><tbody></tbody></table></div>
          <div id="err_lst" class="errbox" style="display:none"></div>
        </div>

        <!-- Receber pedido (RPC receber_pedido_compra) -->
        <div id="cmp-rcb" class="subpage">
          <div class="grid cols-4">
            <div><label>Pedido ID (UUID)</label><input id="rcb_pedido_id"></div>
            <div><label>Usuário</label><input id="rcb_usuario" placeholder="dashboard"></div>
            <div><label>Preço padrão (R$)</label><input id="rcb_preco" type="number" step="0.01" placeholder="0"></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_rcb_receber" class="btn pri">Receber</button>
              <button id="btn_rcb_limpar" class="btn">Limpar</button>
            </div>
          </div>
          <div id="err_rcb" class="errbox" style="display:none"></div>
          <details class="help" id="help_rcb" style="display:none"><summary>SQL sugerido — RPC receber_pedido_compra</summary><pre id="sql_rcb"></pre></details>
        </div>

        <!-- Estornar (RPC estornar_recebimento_pedido) -->
        <div id="cmp-est" class="subpage">
          <div class="grid cols-3">
            <div><label>Pedido ID (UUID)</label><input id="est_pedido_id"></div>
            <div class="grid" style="grid-template-columns:auto auto;gap:8px;align-items:end">
              <button id="btn_est_estornar" class="btn pri">Estornar</button>
              <button id="btn_est_limpar" class="btn">Limpar</button>
            </div>
          </div>
          <div id="err_est" class="errbox" style="display:none"></div>
          <details class="help" id="help_est" style="display:none"><summary>SQL sugerido — RPC estornar_recebimento_pedido</summary><pre id="sql_est"></pre></details>
        </div>
      </div>
    </section>

    <!-- ================= PRODUÇÃO ================= -->
    <section id="tab-pro" class="tab">
      <div class="card">
        <h2>Produção</h2>
        <p class="muted">Interface placeholder — mantém navegação. (Podemos plugar as rotinas de beneficiamento/receita quando você quiser.)</p>
      </div>
    </section>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ===== CONFIG ===== */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== UI helpers ===== */
const $=(id)=>document.getElementById(id);
const $$=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
const setStatus=(msg,kind)=>{const el=$('status');if(el){el.textContent=msg;el.style.color=kind==='err'?'#b91c1c':kind==='ok'?'#065f46':kind==='warn'?'#b45309':'#334155';}};
const num=(v)=>isFinite(+v)?+v:null;
function showErr(boxId, err){const el=$(boxId);if(!el)return;el.style.display='block';el.innerHTML = `<b>Erro:</b> ${err?.message||err||'Falhou'}${err?.hint?`<br><b>Hint:</b> ${err.hint}`:''}${err?.details?`<br><b>Detalhes:</b> ${err.details}`:''}`;}
function hideErr(boxId){const el=$(boxId);if(el){el.style.display='none';el.textContent='';}}
function showHelp(id, sql){const d=$(id); if(!d) return; d.style.display='block'; d.querySelector('pre').textContent = sql;}
function hideHelp(id){const d=$(id); if(d) d.style.display='none';}

/* ===== SQL sugerido (stubs + políticas) ===== */
const SQL = {
  um: `create table if not exists public.unidades_medida(
  id uuid primary key default gen_random_uuid(),
  sigla text not null,
  nome  text not null unique,
  codigo text,
  base text check (base in ('g','ml','un') or base is null),
  fator numeric(18,6) default 1,
  ativo boolean not null default true
);`,
  u: `create table if not exists public.unidades(
  id uuid primary key default gen_random_uuid(),
  nome text not null unique,
  ativo boolean not null default true
);`,
  c: `create table if not exists public.categorias(
  id uuid primary key default gen_random_uuid(),
  nome text not null,
  tipo text check (tipo in ('INGREDIENTE','RECEITA','PRATO','OUTRO') or tipo is null),
  ativo boolean not null default true
);
create index if not exists ix_cat_nome on public.categorias(nome);`,
  t: `create table if not exists public.tipos_item(
  id uuid primary key default gen_random_uuid(),
  nome text not null unique,
  codigo text not null unique,
  ativo boolean not null default true
);`,
  es1: `-- View stub
create or replace view public.vw_estoque_saldos as
select u.id as unidade_id,u.nome as unidade_nome,
       'ING'::text as item_tipo,null::uuid as item_id,'(item)'::text as item_nome,
       'un'::text as un_medida,0::numeric as saldo,0::numeric as custo_medio,0::numeric as valor
from public.unidades u where false;`,
  es2: `create or replace view public.vw_estoque_saldos_resumo as
select unidade_nome,item_nome,'un'::text as un_medida,0::numeric as saldo,
       null::numeric as est_min,null::numeric as est_max,'OK'::text as status
from public.vw_estoque_saldos where false;`,
  rls_all: `-- Habilite apenas em DEV (permite tudo para anon)
alter table public.unidades_medida enable row level security;
alter table public.unidades enable row level security;
alter table public.categorias enable row level security;
alter table public.tipos_item enable row level security;

create policy if not exists "um all" on public.unidades_medida for all using (true) with check (true);
create policy if not exists "unidades all" on public.unidades for all using (true) with check (true);
create policy if not exists "categorias all" on public.categorias for all using (true) with check (true);
create policy if not exists "tipos all" on public.tipos_item for all using (true) with check (true);`,
  compras_vw: `-- vw_lista_compras (exemplo base mínima)
create or replace view public.vw_lista_compras as
select '—'::text as fornecedor, '00000000-0000-0000-0000-000000000000'::uuid as unidade_id,
       '(item)'::text as item_nome, 'un'::text as un_medida,
       0::numeric as sugerido_compra, 1::numeric as multiplo_compra, 0::numeric as qtd_para_comprar
where false;`,
  compras_rpc_gerar: `-- RPC gerar_pedidos_compra (stub simplificado)
create table if not exists public.pedido_compra(
  id uuid primary key default gen_random_uuid(),
  ts timestamptz default now(),
  unidade_id uuid not null,
  fornecedor text,
  status text not null default 'ABERTO' check (status in ('ABERTO','PARCIAL','RECEBIDO','CANCELADO')),
  total numeric(18,6)
);
create table if not exists public.pedido_compra_itens(
  id uuid primary key default gen_random_uuid(),
  pedido_id uuid not null references public.pedido_compra(id) on delete cascade,
  item_tipo text not null,
  item_id uuid not null,
  un_medida text not null,
  qtd_sugerida numeric(18,6),
  qtd_pedida numeric(18,6),
  preco_unit numeric(18,6),
  subtotal numeric(18,6)
);
create or replace function public.gerar_pedidos_compra(p_unidade_id uuid)
returns table(pedido_id uuid, fornecedor text, itens int)
language plpgsql as $$
declare v_id uuid;
begin
  insert into public.pedido_compra(unidade_id,fornecedor,status,total)
  values (p_unidade_id,'—','ABERTO',0) returning id into v_id;
  return query select v_id,'—',0;
end$$;`,
  compras_rpc_receber: `-- RPC receber_pedido_compra (stub simplificado)
create or replace function public.receber_pedido_compra(p_pedido_id uuid, p_usuario text default 'web', p_preco_padrao numeric default 0)
returns void language plpgsql as $$ begin
  update public.pedido_compra set status='RECEBIDO' where id=p_pedido_id;
end $$;`,
  compras_rpc_estornar: `-- RPC estornar_recebimento_pedido (stub simplificado)
create or replace function public.estornar_recebimento_pedido(p_pedido_id uuid, p_usuario text default 'web')
returns void language plpgsql as $$ begin
  update public.pedido_compra set status='ABERTO' where id=p_pedido_id;
end $$;`,
  rls_compras: `-- Políticas dev para compras
alter table public.pedido_compra enable row level security;
alter table public.pedido_compra_itens enable row level security;
create policy if not exists "pc all" on public.pedido_compra for all using (true) with check (true);
create policy if not exists "pci all" on public.pedido_compra_itens for all using (true) with check (true);`
};

/* ===== Navegação ===== */
function setupTabs(){
  const tabs=$('tabs'); const panes=$$('.tab');
  tabs.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    tabs.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    panes.forEach(p=>p.classList.toggle('active', p.id==='tab-'+b.dataset.tab));
  });
  const subCad=$('sub-cad'); const cadPages={'um':'cad-um','uni':'cad-uni','cat':'cad-cat','tip':'cad-tip'};
  subCad.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    subCad.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    Object.values(cadPages).forEach(id=>$(id).classList.remove('active'));
    $(cadPages[b.dataset.sub]).classList.add('active');
  });
  const subEst=$('sub-est'); const estPages={'mov':'est-mov','saldos':'est-saldos','resumo':'est-resumo'};
  subEst.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    subEst.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    Object.values(estPages).forEach(id=>$(id).classList.remove('active'));
    $(estPages[b.dataset.sub]).classList.add('active');
  });
  const subCmp=$('sub-cmp'); const cmpPages={'sug':'cmp-sug','ped':'cmp-ped','lst':'cmp-lst','rcb':'cmp-rcb','est':'cmp-est'};
  subCmp.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    subCmp.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    Object.values(cmpPages).forEach(id=>$(id).classList.remove('active'));
    $(cmpPages[b.dataset.sub]).classList.add('active');
  });
}

/* ===== Data utils ===== */
async function qSelect(table,sel='*',opts={}){
  try{
    let q=supa.from(table).select(sel);
    // (para evitar 400 por coluna inexistente, não aplico order no servidor)
    const {data,error,status}=await q;
    if(error){return {data:null,error,status}}
    return {data,error:null,status}
  }catch(ex){return {data:null,error:ex,status:0}}
}
async function qInsert(table,payload){const {data,error}=await supa.from(table).insert(payload).select().single(); if(error) throw error; return data;}
async function qUpdate(table,id,payload){const {data,error}=await supa.from(table).update(payload).eq('id',id).select().single(); if(error) throw error; return data;}
async function qDelete(table,id){const {error}=await supa.from(table).delete().eq('id',id); if(error) throw error; return true;}
function explainRLS(boxId, table){
  showErr(boxId,{message:`${table}: RLS/Permissão.`,details:`Sua requisição retornou 401/403. Crie políticas para o papel 'anon' (DEV).`,hint:`Use o bloco "SQL sugerido — Políticas DEV" abaixo.`});
}

/* ===== Cadastros: Unidades de Medida ===== */
let um_edit=null;
async function loadUM(){
  hideErr('err_um'); hideHelp('help_um');
  const {data,error,status}=await qSelect('unidades_medida','id,sigla,nome,codigo,base,fator,ativo');
  const tb=$('tb_um').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_um',SQL.um); }
    if(status===401||status===403){ explainRLS('err_um','unidades_medida'); }
    if(status===400){ showErr('err_um',error); showHelp('help_um',SQL.um); }
    tb.innerHTML='<tr><td colspan="7">Não foi possível listar.</td></tr>';
    setKPIsUM([]);
    return;
  }
  const rows=(data||[]).sort((a,b)=>String(a.nome||'').localeCompare(String(b.nome||'')));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.sigla||'—'}</td><td>${r.nome||'—'}</td><td>${r.codigo||'—'}</td><td>${r.base||'—'}</td><td>${r.fator??'—'}</td>
      <td>${r.ativo?'<span class="badge ok">Ativo</span>':'<span class="badge bad">Inativo</span>'}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
        <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
        <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  }
  if(!rows.length) tb.innerHTML='<tr><td colspan="7">Sem registros.</td></tr>';
  setKPIsUM(rows);
}
function setKPIsUM(rows){$('k_um_total').textContent=rows.length; $('k_um_ativas').textContent=rows.filter(r=>r.ativo).length; $('k_um_bases').textContent=rows.filter(r=>r.base).length; $('k_um_inv').textContent=rows.filter(r=>!(+r.fator>0)).length;}
$('btn_um_novo').addEventListener('click',()=>{um_edit=null;$('um_sigla').value='';$('um_nome').value='';$('um_codigo').value='';$('um_base').value='';$('um_fator').value='';$('um_ativo').value='true';});
$('btn_um_salvar').addEventListener('click',async ()=>{
  hideErr('err_um');
  const payload={sigla:($('um_sigla').value||'').trim()||null,nome:($('um_nome').value||'').trim()||null,codigo:($('um_codigo').value||'').trim()||null,base:$('um_base').value||null,fator:num($('um_fator').value),ativo:$('um_ativo').value==='true'};
  if(!payload.sigla||!payload.nome){return showErr('err_um',{message:'Informe Nome e Sigla.'});}
  try{
    if(um_edit){await qUpdate('unidades_medida',um_edit,payload);}else{await qInsert('unidades_medida',payload);}
    um_edit=null; await loadUM(); setStatus('UM salva.','ok');
  }catch(e){
    if(e.code==='PGRST301' || e.status===401) explainRLS('err_um','unidades_medida'); else showErr('err_um',e);
  }
});
$('tb_um').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b)return;
  const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){
    const {data}=await supa.from('unidades_medida').select('*').eq('id',id).single(); if(!data) return;
    um_edit=id; $('um_sigla').value=data.sigla||''; $('um_nome').value=data.nome||''; $('um_codigo').value=data.codigo||''; $('um_base').value=data.base||''; $('um_fator').value=data.fator??''; $('um_ativo').value=data.ativo?'true':'false';
  }else if(act==='toggle'){
    const {data}=await supa.from('unidades_medida').select('ativo').eq('id',id).single();
    try{await qUpdate('unidades_medida',id,{ativo:!data.ativo}); await loadUM();}catch(e){showErr('err_um',e);}
  }else if(act==='del'){
    if(!confirm('Excluir UM?'))return;
    try{await qDelete('unidades_medida',id); await loadUM();}catch(e){showErr('err_um',e);}
  }
});

/* ===== Cadastros: Unidades ===== */
let u_edit=null;
async function loadU(){
  hideErr('err_u'); hideHelp('help_u');
  const {data,error,status}=await qSelect('unidades','id,nome,ativo');
  const tb=$('tb_u').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_u',SQL.u); }
    if(status===401||status===403){ explainRLS('err_u','unidades'); }
    if(status===400){ showErr('err_u',error); showHelp('help_u',SQL.u); }
    tb.innerHTML='<tr><td colspan="3">Não foi possível listar.</td></tr>'; return;
  }
  const rows=(data||[]).sort((a,b)=>String(a.nome||'').localeCompare(String(b.nome||'')));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td><td>${r.ativo?'<span class="badge ok">Ativo</span>':'<span class="badge bad">Inativo</span>'}</td>
    <td class="row-actions">
      <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
      <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
      <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
    </td>`;
    tb.appendChild(tr);
  }
  if(!rows.length) tb.innerHTML='<tr><td colspan="3">Sem registros.</td></tr>';
}
$('btn_u_novo').addEventListener('click',()=>{u_edit=null;$('u_nome').value='';$('u_ativo').value='true';});
$('btn_u_salvar').addEventListener('click',async ()=>{
  hideErr('err_u');
  const payload={nome:($('u_nome').value||'').trim()||null,ativo:$('u_ativo').value==='true'};
  if(!payload.nome) return showErr('err_u',{message:'Informe nome.'});
  try{
    if(u_edit) await qUpdate('unidades',u_edit,payload); else await qInsert('unidades',payload);
    u_edit=null; await loadU(); setStatus('Unidade salva.','ok');
  }catch(e){ if(e.status===401) explainRLS('err_u','unidades'); else showErr('err_u',e); }
});
$('tb_u').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b)return; const id=b.dataset.id,act=b.dataset.act;
  if(act==='edit'){const {data}=await supa.from('unidades').select('*').eq('id',id).single(); if(!data)return; u_edit=id; $('u_nome').value=data.nome||''; $('u_ativo').value=data.ativo?'true':'false';}
  if(act==='toggle'){const {data}=await supa.from('unidades').select('ativo').eq('id',id).single(); try{await qUpdate('unidades',id,{ativo:!data.ativo}); await loadU();}catch(e){showErr('err_u',e);}}
  if(act==='del'){if(!confirm('Excluir unidade?'))return; try{await qDelete('unidades',id); await loadU();}catch(e){showErr('err_u',e);}}
});

/* ===== Cadastros: Categorias ===== */
let c_edit=null;
async function loadC(){
  hideErr('err_c'); hideHelp('help_c');
  const {data,error,status}=await qSelect('categorias','id,nome,tipo,ativo');
  const tb=$('tb_c').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_c',SQL.c); }
    if(status===401||status===403){ explainRLS('err_c','categorias'); }
    if(status===400){ showErr('err_c',error); showHelp('help_c',SQL.c); }
    tb.innerHTML='<tr><td colspan="4">Não foi possível listar.</td></tr>'; return;
  }
  const rows=(data||[]).sort((a,b)=>String(a.nome||'').localeCompare(String(b.nome||'')));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td><td>${r.tipo||'—'}</td><td>${r.ativo?'<span class="badge ok">Ativo</span>':'<span class="badge bad">Inativo</span>'}</td>
    <td class="row-actions">
      <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
      <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
      <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
    </td>`;
    tb.appendChild(tr);
  }
  if(!rows.length) tb.innerHTML='<tr><td colspan="4">Sem registros.</td></tr>';
}
$('btn_c_novo').addEventListener('click',()=>{c_edit=null;$('c_nome').value='';$('c_tipo').value='';$('c_ativo').value='true';});
$('btn_c_salvar').addEventListener('click',async ()=>{
  hideErr('err_c');
  const payload={nome:($('c_nome').value||'').trim()||null,tipo:$('c_tipo').value||null,ativo:$('c_ativo').value==='true'};
  if(!payload.nome) return showErr('err_c',{message:'Informe nome.'});
  try{
    if(c_edit) await qUpdate('categorias',c_edit,payload); else await qInsert('categorias',payload);
    c_edit=null; await loadC(); setStatus('Categoria salva.','ok');
  }catch(e){ if(e.status===401) explainRLS('err_c','categorias'); else showErr('err_c',e); }
});
$('tb_c').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b)return; const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){const {data}=await supa.from('categorias').select('*').eq('id',id).single(); if(!data)return; c_edit=id; $('c_nome').value=data.nome||''; $('c_tipo').value=data.tipo||''; $('c_ativo').value=data.ativo?'true':'false';}
  if(act==='toggle'){const {data}=await supa.from('categorias').select('ativo').eq('id',id).single(); try{await qUpdate('categorias',id,{ativo:!data.ativo}); await loadC();}catch(e){showErr('err_c',e);}}
  if(act==='del'){if(!confirm('Excluir?'))return; try{await qDelete('categorias',id); await loadC();}catch(e){showErr('err_c',e);}}
});

/* ===== Cadastros: Tipos de Item ===== */
let t_edit=null;
async function loadT(){
  hideErr('err_t'); hideHelp('help_t');
  const {data,error,status}=await qSelect('tipos_item','id,nome,codigo,ativo');
  const tb=$('tb_t').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_t',SQL.t); }
    if(status===401||status===403){ explainRLS('err_t','tipos_item'); }
    if(status===400){ showErr('err_t',error); showHelp('help_t',SQL.t); }
    tb.innerHTML='<tr><td colspan="4">Não foi possível listar.</td></tr>'; return;
  }
  const rows=(data||[]).sort((a,b)=>String(a.nome||'').localeCompare(String(b.nome||'')));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.nome}</td><td>${r.codigo}</td><td>${r.ativo?'<span class="badge ok">Ativo</span>':'<span class="badge bad">Inativo</span>'}</td>
    <td class="row-actions">
      <button class="btn small" data-act="edit" data-id="${r.id}">Editar</button>
      <button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button>
      <button class="btn small" data-act="del" data-id="${r.id}">Excluir</button>
    </td>`;
    tb.appendChild(tr);
  }
  if(!rows.length) tb.innerHTML='<tr><td colspan="4">Sem registros.</td></tr>';
}
$('btn_t_novo').addEventListener('click',()=>{t_edit=null;$('t_nome').value='';$('t_codigo').value='';$('t_ativo').value='true';});
$('btn_t_salvar').addEventListener('click',async ()=>{
  hideErr('err_t');
  const payload={nome:($('t_nome').value||'').trim()||null,codigo:($('t_codigo').value||'').trim()||null,ativo:$('t_ativo').value==='true'};
  if(!payload.nome||!payload.codigo) return showErr('err_t',{message:'Informe Nome e Código.'});
  try{
    if(t_edit) await qUpdate('tipos_item',t_edit,payload); else await qInsert('tipos_item',payload);
    t_edit=null; await loadT(); setStatus('Tipo salvo.','ok');
  }catch(e){ if(e.status===401) explainRLS('err_t','tipos_item'); else showErr('err_t',e); }
});
$('tb_t').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b)return; const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){const {data}=await supa.from('tipos_item').select('*').eq('id',id).single(); if(!data)return; t_edit=id; $('t_nome').value=data.nome||''; $('t_codigo').value=data.codigo||''; $('t_ativo').value=data.ativo?'true':'false';}
  if(act==='toggle'){const {data}=await supa.from('tipos_item').select('ativo').eq('id',id).single(); try{await qUpdate('tipos_item',id,{ativo:!data.ativo}); await loadT();}catch(e){showErr('err_t',e);}}
  if(act==='del'){if(!confirm('Excluir?'))return; try{await qDelete('tipos_item',id); await loadT();}catch(e){showErr('err_t',e);}}
});

/* ===== Estoque: Movimentações ===== */
$('btn_mv_limpar').addEventListener('click',()=>['mv_unidade','mv_item_id','mv_un','mv_qtd','mv_custo','mv_ref','mv_user','mv_un_medida'].forEach(id=>$(id).value=''));
$('btn_mv_lancar').addEventListener('click', async ()=>{
  hideErr('err_mv');
  try{
    const payload = {
      id: crypto.randomUUID(),
      unidade_id: $('mv_unidade').value.trim(),
      item_tipo: $('mv_item_tipo').value,
      item_id: $('mv_item_id').value.trim(),
      un: ($('mv_un').value||'').trim()||null,
      un_medida: ($('mv_un_medida').value||'').trim()||$('mv_un').value||null,
      qtd: num($('mv_qtd').value)||0,
      tipo: $('mv_tipo').value,
      custo_unit: num($('mv_custo').value),
      ref_doc: ($('mv_ref').value||'').trim()||null,
      usuario: ($('mv_user').value||'').trim()||'web',
      ts: new Date().toISOString()
    };
    if(!payload.unidade_id||!payload.item_id||!payload.un||!payload.un_medida) throw {message:'Preencha Unidade, Item, UM e UM Medida.'};
    const {error}=await supa.from('mov_estoque').insert(payload);
    if(error) throw error;
    setStatus('Movimentação lançada.','ok');
  }catch(e){
    if(e?.code==='PGRST301' || e?.status===401) showErr('err_mv',{message:'Permissão/RLS em mov_estoque.',details:e?.message}); else showErr('err_mv',e);
  }
});

/* ===== Estoque: Views ===== */
async function loadSaldo(){
  hideErr('err_es1'); hideHelp('help_es1');
  const {data,error,status}=await qSelect('vw_estoque_saldos','*');
  const tb=$('tb_saldos').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_es1',SQL.es1); }
    if(status===401||status===403){ showErr('err_es1',{message:'RLS/Permissão em vw_estoque_saldos.'}); }
    if(status===400){ showErr('err_es1',error); }
    tb.innerHTML='<tr><td colspan="6">Não foi possível listar.</td></tr>'; return;
  }
  for(const r of (data||[])){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.unidade_nome||'—'}</td><td>${r.item_tipo||'—'}</td><td>${r.item_nome||r.item_id||'—'}</td><td>${r.un_medida||'—'}</td><td>${r.saldo||0}</td><td>${r.valor||0}</td>`;
    tb.appendChild(tr);
  }
  if(!(data||[]).length) tb.innerHTML='<tr><td colspan="6">Sem registros.</td></tr>';
}
async function loadResumo(){
  hideErr('err_es2'); hideHelp('help_es2');
  const {data,error,status}=await qSelect('vw_estoque_saldos_resumo','*');
  const tb=$('tb_resumo').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_es2',SQL.es2); }
    if(status===401||status===403){ showErr('err_es2',{message:'RLS/Permissão em vw_estoque_saldos_resumo.'}); }
    if(status===400){ showErr('err_es2',error); }
    tb.innerHTML='<tr><td colspan="7">Não foi possível listar.</td></tr>'; return;
  }
  for(const r of (data||[])){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.unidade_nome||'—'}</td><td>${r.item_nome||'—'}</td><td>${r.un_medida||'—'}</td><td>${r.saldo||0}</td><td>${r.est_min??'—'}</td><td>${r.est_max??'—'}</td><td>${r.status||'—'}</td>`;
    tb.appendChild(tr);
  }
  if(!(data||[]).length) tb.innerHTML='<tr><td colspan="7">Sem registros.</td></tr>';
}

/* ===== Compras ===== */
// Sugestões
$('btn_cmp_sug_limpar').addEventListener('click',()=>{$('cmp_sug_unidade').value='';$('tb_sug').querySelector('tbody').innerHTML='';hideErr('err_cmp_sug');});
$('btn_cmp_sug_atualizar').addEventListener('click',async ()=>{
  hideErr('err_cmp_sug'); hideHelp('help_cmp_sug');
  const uni=$('cmp_sug_unidade').value.trim();
  const {data,error,status}=await qSelect('vw_lista_compras','*');
  const tb=$('tb_sug').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showHelp('help_cmp_sug', SQL.compras_vw); }
    if(status===401||status===403){ showErr('err_cmp_sug',{message:'RLS/Permissão em vw_lista_compras.'}); }
    if(status===400){ showErr('err_cmp_sug',error); }
    tb.innerHTML='<tr><td colspan="7">Não foi possível listar.</td></tr>'; return;
  }
  const rows = (data||[]).filter(r=>!uni || r.unidade_id===uni);
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.unidade_nome||'—'}</td><td>${r.fornecedor||'—'}</td><td>${r.item_nome||'—'}</td><td>${r.un_medida||'—'}</td><td>${r.sugerido_compra||0}</td><td>${r.multiplo_compra||1}</td><td>${r.qtd_para_comprar||0}</td>`;
    tb.appendChild(tr);
  }
  if(!rows.length) tb.innerHTML='<tr><td colspan="7">Sem sugestões.</td></tr>';
});

// Gerar pedido
$('btn_cmp_ped_limpar').addEventListener('click',()=>{$('cmp_ped_unidade').value='';$('tb_pedidos_gerados').querySelector('tbody').innerHTML='';hideErr('err_cmp_ped');});
$('btn_cmp_ped_gerar').addEventListener('click', async ()=>{
  hideErr('err_cmp_ped'); hideHelp('help_cmp_ped');
  const uni=$('cmp_ped_unidade').value.trim(); if(!uni) return showErr('err_cmp_ped',{message:'Informe Unidade.'});
  try{
    const {data,error}=await supa.rpc('gerar_pedidos_compra',{p_unidade_id:uni});
    if(error) throw error;
    const tb=$('tb_pedidos_gerados').querySelector('tbody'); tb.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.pedido_id}</td><td>${r.fornecedor||'—'}</td><td>${r.itens||0}</td>`;
      tb.appendChild(tr);
    });
    if(!(data||[]).length) tb.innerHTML='<tr><td colspan="3">Função retornou vazio.</td></tr>';
  }catch(e){
    showErr('err_cmp_ped',e);
    showHelp('help_cmp_ped', [SQL.compras_rpc_gerar, SQL.rls_compras, SQL.rls_all].join('\n\n'));
  }
});

// Listar pedidos
async function loadPedidos(){
  hideErr('err_lst');
  const st=$('lst_status').value;
  const {data,error,status}=await qSelect('pedido_compra','id,unidade_id,status,total,ts');
  const tb=$('tb_pedidos').querySelector('tbody'); tb.innerHTML='';
  if(error){
    if(status===404){ showErr('err_lst',{message:'Tabela pedido_compra ausente.'}); }
    if(status===401||status===403){ showErr('err_lst',{message:'RLS/Permissão em pedido_compra.'}); }
    if(status===400){ showErr('err_lst',error); }
    tb.innerHTML='<tr><td colspan="5">Não foi possível listar.</td></tr>'; return;
  }
  const rows=(data||[]).filter(r=>!st || r.status===st).sort((a,b)=>String(b.ts).localeCompare(String(a.ts)));
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.id}</td><td>${r.unidade_id}</td><td>${r.status}</td><td>${r.total??0}</td><td>${new Date(r.ts).toLocaleString('pt-BR')}</td>`;
    tb.appendChild(tr);
  }
  if(!rows.length) tb.innerHTML='<tr><td colspan="5">Sem pedidos.</td></tr>';
}
$('btn_lst_atualizar').addEventListener('click', loadPedidos);
$('btn_lst_limpar').addEventListener('click',()=>{$('lst_status').value='';$('tb_pedidos').querySelector('tbody').innerHTML='';hideErr('err_lst');});

// Receber pedido
$('btn_rcb_limpar').addEventListener('click',()=>{$('rcb_pedido_id').value='';$('rcb_usuario').value='';$('rcb_preco').value='';hideErr('err_rcb');});
$('btn_rcb_receber').addEventListener('click', async ()=>{
  hideErr('err_rcb'); hideHelp('help_rcb');
  const id=$('rcb_pedido_id').value.trim(); if(!id) return showErr('err_rcb',{message:'Informe pedido_id.'});
  const usuario=($('rcb_usuario').value||'web').trim(); const preco=num($('rcb_preco').value)||0;
  try{
    const {error}=await supa.rpc('receber_pedido_compra',{p_pedido_id:id,p_usuario:usuario,p_preco_padrao:preco});
    if(error) throw error;
    setStatus('Pedido recebido.','ok');
  }catch(e){
    showErr('err_rcb',e);
    showHelp('help_rcb', SQL.compras_rpc_receber);
  }
});

// Estornar
$('btn_est_limpar').addEventListener('click',()=>{$('est_pedido_id').value='';hideErr('err_est');});
$('btn_est_estornar').addEventListener('click', async ()=>{
  hideErr('err_est'); hideHelp('help_est');
  const id=$('est_pedido_id').value.trim(); if(!id) return showErr('err_est',{message:'Informe pedido_id.'});
  try{
    const {error}=await supa.rpc('estornar_recebimento_pedido',{p_pedido_id:id,p_usuario:'web'});
    if(error) throw error;
    setStatus('Recebimento estornado.','ok');
  }catch(e){
    showErr('err_est',e);
    // se seu RPC exige status='GERADO', ajuste no seu SQL
    showHelp('help_est', SQL.compras_rpc_estornar);
  }
});

/* ===== INIT ===== */
async function init(){
  setupTabs();
  setStatus('Carregando cadastros…');
  await Promise.all([loadUM(), loadU(), loadC(), loadT()]);
  setStatus('Carregando estoque…');
  await Promise.all([loadSaldo(), loadResumo()]);
  setStatus('Pronto','ok');

  // Preenche blocos SQL de ajuda estáticos (políticas DEV)
  $('sql_um').textContent = [SQL.um, SQL.rls_all].join('\n\n');
  $('sql_u').textContent  = [SQL.u, SQL.rls_all].join('\n\n');
  $('sql_c').textContent  = [SQL.c, SQL.rls_all].join('\n\n');
  $('sql_t').textContent  = [SQL.t, SQL.rls_all].join('\n\n');
  $('sql_es1').textContent= [SQL.es1].join('\n');
  $('sql_es2').textContent= [SQL.es2].join('\n');
  $('sql_cmp_sug').textContent = [SQL.compras_vw].join('\n');
  $('sql_cmp_ped').textContent = [SQL.compras_rpc_gerar, SQL.rls_compras].join('\n\n');
  $('sql_rcb').textContent = [SQL.compras_rpc_receber].join('\n');
  $('sql_est').textContent = [SQL.compras_rpc_estornar].join('\n');
}
document.addEventListener('DOMContentLoaded', ()=>{init().catch(e=>setStatus(e.message||'falha','err'));});
</script>
</body>
</html>
