<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Compras & Estoque — Módulo</title>
  <!-- Favicon inline evita 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark:#065f46; --wine-dark:#881337;
      --radius:12px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;height:100%}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:22px} h2{font-size:18px} h3{font-size:16px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:600;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:var(--wine-dark)}
    .muted{color:var(--muted);font-size:12px}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:10px 12px;text-align:left;font-size:13px;vertical-align:middle}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;color:#475569;font-weight:700}
    tbody tr:hover{background:#fafafb}
    .title{display:flex;align-items:center;justify-content:space-between}
    .status{color:var(--muted)}
    .warn{color:#b45309}
    .error{color:#b91c1c}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>Compras & Estoque</h1>
        <div id="status" class="status">Conectando…</div>
      </div>
      <div class="row">
        <label style="margin:0">Unidade</label>
        <select id="selUnidade"></select>
        <button class="btn" id="btnReload">Recarregar</button>
      </div>
    </div>

    <!-- Sugestões de Compra -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Sugestões de Compra</h2>
        <div class="row">
          <button class="btn" id="btnCarregarSug">Atualizar</button>
          <button class="btn pri" id="btnGerarPedidos">Gerar pedido para unidade</button>
        </div>
      </div>
      <div class="muted" id="hintSug">Fonte: mv_sugestoes_compra (fallback para vw_lista_compras).</div>
      <div class="sep"></div>
      <div class="table-container" style="max-height:320px">
        <table id="tblSug">
          <thead>
            <tr>
              <th>Fornecedor</th>
              <th>Item</th>
              <th>Un</th>
              <th>Saldo</th>
              <th>Mín</th>
              <th>Máx</th>
              <th>Sugerido</th>
              <th>Múltiplo</th>
              <th>Comprar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Pedidos de Compra -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Pedidos</h2>
        <div class="row">
          <label style="margin:0">Status</label>
          <select id="selStatus">
            <option value="">Todos</option>
            <option>ABERTO</option>
            <option>PARCIAL</option>
            <option>RECEBIDO</option>
            <option>CANCELADO</option>
          </select>
          <button class="btn" id="btnReloadPedidos">Atualizar</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="table-container" style="max-height:260px">
        <table id="tblPedidos">
          <thead>
            <tr>
              <th>Pedido</th>
              <th>Unidade</th>
              <th>Status</th>
              <th>Total (R$)</th>
              <th>Criado em</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Itens do Pedido Selecionado -->
    <section class="card" id="secItens" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2>Itens do Pedido</h2>
          <div class="muted" id="hintPedido"></div>
        </div>
        <div class="row">
          <input id="inpUsuario" placeholder="Usuário (ex.: dashboard)" style="width:220px">
          <input id="inpPrecoPadrao" placeholder="Preço padrão (R$)" style="width:180px">
          <button class="btn pri" id="btnReceber">Receber pedido</button>
          <button class="btn" id="btnEstornar">Estornar recebimento</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="table-container" style="max-height:320px">
        <table id="tblItens">
          <thead>
            <tr>
              <th>Item</th>
              <th>Un</th>
              <th>Qtd Pedida</th>
              <th>Preço Unit</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    // ====== CONFIG SUPABASE (mesmos do seu app original)
    const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ====== HELPERS
    const $ = (id) => document.getElementById(id);
    const fmtMoney = (n) => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(+n||0);
    const fmtNum   = (n) => new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
    const setStatus=(msg,cls)=>{const el=$('status'); el.textContent=msg; el.className='status '+(cls||'');};

    function pillStatus(s){
      if(s==='RECEBIDO') return '<span class="pill ok">RECEBIDO</span>';
      if(s==='CANCELADO')return '<span class="pill bad">CANCELADO</span>';
      if(s==='PARCIAL')  return '<span class="pill">PARCIAL</span>';
      return '<span class="pill">ABERTO</span>';
    }

    // ====== UNIDADES
    async function carregarUnidades(){
      const sel = $('selUnidade');
      sel.innerHTML = '<option value="">Carregando…</option>';
      try{
        const { data, error } = await supa.from('unidades').select('id,nome').order('nome',{ascending:true});
        if(error) throw error;
        sel.innerHTML = '<option value="">Selecione…</option>' + (data||[]).map(u=>`<option value="${u.id}">${u.nome}</option>`).join('');
        if(data && data.length){ sel.value = data[0].id; }
      }catch(e){ sel.innerHTML = '<option value="">(erro ao carregar)</option>'; console.error(e); }
    }

    // ====== SUGESTÕES
    async function carregarSugestoes(){
      const unidade_id = $('selUnidade').value;
      const tb = $('tblSug').querySelector('tbody');
      tb.innerHTML = '<tr><td colspan="9">Carregando…</td></tr>';
      setStatus('Carregando sugestões…');

      async function render(rows){
        tb.innerHTML = '';
        (rows||[]).forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.fornecedor ?? '—'}</td>
            <td>${r.item_nome ?? '(item)'}</td>
            <td>${r.un_medida ?? ''}</td>
            <td class="nowrap">${fmtNum(r.saldo ?? r.saldo_total ?? 0)}</td>
            <td class="nowrap">${fmtNum(r.est_min ?? 0)}</td>
            <td class="nowrap">${fmtNum(r.est_max ?? 0)}</td>
            <td class="nowrap">${fmtNum(r.sugerido_compra ?? 0)}</td>
            <td class="nowrap">${fmtNum(r.multiplo_compra ?? 1)}</td>
            <td class="nowrap">${fmtNum(r.qtd_para_comprar ?? r.sugerido_compra ?? 0)}</td>
          `;
          tb.appendChild(tr);
        });
      }

      try {
        // 1) tenta MV
        let { data, error } = await supa
          .from('mv_sugestoes_compra')
          .select('unidade_id,unidade_nome,fornecedor,item_tipo,item_nome,un_medida,saldo,est_min,est_max,sugerido_compra,multiplo_compra,qtd_para_comprar')
          .eq('unidade_id', unidade_id);

        if(error) throw error;
        if(!data || data.length===0){
          // 2) fallback para view
          const f = await supa
            .from('vw_lista_compras')
            .select('unidade_id,unidade_nome,fornecedor,item_tipo,item_nome,un_medida,saldo,est_min,est_max,sugerido_compra,multiplo_compra,qtd_para_comprar')
            .eq('unidade_id', unidade_id);
          if(f.error) throw f.error;
          await render(f.data);
        } else {
          await render(data);
        }
        setStatus('Pronto','ok');
      } catch(e){
        console.warn('mv_sugestoes_compra/vw_lista_compras erro:', e.message||e);
        tb.innerHTML = '<tr><td colspan="9">Não há sugestões ou views/materialized view ausentes.</td></tr>';
        setStatus('Sugestões indisponíveis','warn');
      }
    }

    async function gerarPedidos(){
      const unidade_id = $('selUnidade').value;
      if(!unidade_id){ alert('Selecione a unidade.'); return; }
      setStatus('Gerando pedido…');
      try{
        const { data, error } = await supa.rpc('gerar_pedidos_compra', { p_unidade_id: unidade_id });
        if(error) throw error;
        // data esperado: lista (pedido_id, fornecedor, itens)
        alert('Pedido gerado com sucesso.');
        await carregarPedidos();
      }catch(e){
        console.error(e);
        alert('Erro ao gerar pedido: ' + (e.message||e));
      }finally{
        setStatus('Pronto','ok');
      }
    }

    // ====== PEDIDOS
    let selectedPedidoId = null;
    async function carregarPedidos(){
      const status = $('selStatus').value;
      const tb = $('tblPedidos').querySelector('tbody');
      tb.innerHTML = '<tr><td colspan="6">Carregando…</td></tr>';
      try{
        let q = supa.from('pedido_compra').select('id,unidade_id,status,total,ts').order('ts',{ascending:false}).limit(200);
        if(status) q = q.eq('status', status);
        const { data, error } = await q;
        if(error) throw error;

        // mapear unidades para nome
        const un = await supa.from('unidades').select('id,nome');
        const mapUn = new Map((un.data||[]).map(u=>[u.id, u.nome]));

        tb.innerHTML = '';
        (data||[]).forEach(p=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><code>${p.id}</code></td>
            <td>${mapUn.get(p.unidade_id) || '(?)'}</td>
            <td>${pillStatus(p.status)}</td>
            <td class="nowrap">${fmtMoney(p.total||0)}</td>
            <td>${new Date(p.ts).toLocaleString('pt-BR')}</td>
            <td>
              <button class="btn" data-open="${p.id}">Abrir</button>
            </td>
          `;
          tb.appendChild(tr);
        });

      }catch(e){
        console.error(e); tb.innerHTML = '<tr><td colspan="6">Erro ao carregar pedidos</td></tr>';
      }
    }

    async function abrirPedido(pedidoId){
      selectedPedidoId = pedidoId;
      $('secItens').style.display = 'block';
      $('hintPedido').textContent = 'Pedido: ' + pedidoId;

      const tb = $('tblItens').querySelector('tbody');
      tb.innerHTML = '<tr><td colspan="5">Carregando…</td></tr>';

      // tenta view bonita
      try{
        const v = await supa.from('vw_pedidos_compra_itens')
          .select('pedido_id,item_nome,un_medida,qtd_pedida,preco_unit,subtotal')
          .eq('pedido_id', pedidoId);
        if(v.data && v.data.length){
          tb.innerHTML = '';
          v.data.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.item_nome ?? '(item)'}</td>
              <td>${r.un_medida ?? ''}</td>
              <td class="nowrap">${fmtNum(r.qtd_pedida ?? 0)}</td>
              <td class="nowrap">${r.preco_unit!=null ? fmtMoney(r.preco_unit) : '—'}</td>
              <td class="nowrap">${r.subtotal!=null ? fmtMoney(r.subtotal) : '—'}</td>
            `;
            tb.appendChild(tr);
          });
          return;
        }
      }catch(e){ /* ignora */ }

      // fallback: tabela base
      try{
        const it = await supa.from('pedido_compra_itens')
          .select('item_id,un_medida,qtd_pedida,preco_unit,subtotal')
          .eq('pedido_id', pedidoId);
        tb.innerHTML = '';
        for(const r of (it.data||[])){
          let nome='(item)';
          // tenta descobrir nome do ingrediente
          try{
            const q = await supa.from('ingredientes').select('nome').eq('id', r.item_id).maybeSingle();
            if(q.data && q.data.nome) nome = q.data.nome;
          }catch(_){}
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${nome}</td>
            <td>${r.un_medida ?? ''}</td>
            <td class="nowrap">${fmtNum(r.qtd_pedida ?? 0)}</td>
            <td class="nowrap">${r.preco_unit!=null ? fmtMoney(r.preco_unit) : '—'}</td>
            <td class="nowrap">${r.subtotal!=null ? fmtMoney(r.subtotal) : '—'}</td>
          `;
          tb.appendChild(tr);
        }
      }catch(e){
        console.error(e);
        tb.innerHTML = '<tr><td colspan="5">Erro ao carregar itens</td></tr>';
      }
    }

    // ====== AÇÕES DO PEDIDO
    async function receberPedido(){
      if(!selectedPedidoId){ alert('Selecione um pedido.'); return; }
      const usuario = $('inpUsuario').value.trim() || 'dashboard';
      const precoPadrao = parseFloat(($('inpPrecoPadrao').value||'0').replace(',','.')) || 0;
      setStatus('Recebendo pedido…');
      try{
        const { data, error } = await supa.rpc('receber_pedido_compra', {
          p_pedido_id: selectedPedidoId,
          p_usuario: usuario,
          p_preco_padrao: precoPadrao
        });
        if(error) throw error;
        alert('Recebido com sucesso.');
        await abrirPedido(selectedPedidoId);
        await carregarPedidos();
      }catch(e){
        console.error(e);
        alert('Erro ao receber: ' + (e.message||e));
      }finally{ setStatus('Pronto','ok'); }
    }

    async function estornarPedido(){
      if(!selectedPedidoId){ alert('Selecione um pedido.'); return; }
      const usuario = $('inpUsuario').value.trim() || 'dashboard';
      setStatus('Estornando recebimento…');
      try{
        // função com 2 params (uuid, text) ou com 3 (uuid, text, text) -> tentamos a mais nova
        let { data, error } = await supa.rpc('estornar_recebimento_pedido', {
          p_pedido_id: selectedPedidoId,
          p_usuario: usuario,
          p_status_pos_estorno: 'ABERTO'
        });
        if(error){
          // fallback assinatura antiga (uuid, text)
          const alt = await supa.rpc('estornar_recebimento_pedido', {
            p_pedido_id: selectedPedidoId,
            p_usuario: usuario
          });
          if(alt.error) throw alt.error;
        }
        alert('Estorno concluído.');
        await abrirPedido(selectedPedidoId);
        await carregarPedidos();
      }catch(e){
        console.error(e);
        alert('Erro ao estornar: ' + (e.message||e));
      }finally{ setStatus('Pronto','ok'); }
    }

    // ====== BINDS
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-open]');
      if(b){ abrirPedido(b.dataset.open); }
    });
    document.getElementById('btnReload').addEventListener('click', async ()=>{
      await carregarUnidades(); await carregarSugestoes(); await carregarPedidos();
    });
    document.getElementById('btnCarregarSug').addEventListener('click', carregarSugestoes);
    document.getElementById('btnGerarPedidos').addEventListener('click', gerarPedidos);
    document.getElementById('btnReloadPedidos').addEventListener('click', carregarPedidos);
    document.getElementById('btnReceber').addEventListener('click', receberPedido);
    document.getElementById('btnEstornar').addEventListener('click', estornarPedido);
    document.getElementById('selUnidade').addEventListener('change', async ()=>{
      await carregarSugestoes(); await carregarPedidos();
    });

    // ====== INIT
    async function init(){
      setStatus('Conectado. Carregando dados…');
      await carregarUnidades();
      await carregarSugestoes();
      await carregarPedidos();
      setStatus('Pronto','ok');
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
