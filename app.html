<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1" name="viewport"/>
    <title>Mapa de Produ√ß√£o</title>
    <link href='data:image/svg+xml,&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"&gt;&lt;rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/&gt;&lt;text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white"&gt;MP&lt;/text&gt;&lt;/svg&gt;' rel="icon"/>
    <link rel="stylesheet" href="estoque_styles.css?v=8.1">
</head>
<body>
<main class="main">
    <div class="top">
        <div class="brand">
            <div class="logo">MP</div>
            <div>
                <h1 style="font-size:18px; margin:0; line-height:1.2">Mapa de Produ√ß√£o</h1>
                <div class="hint" style="margin:0;">Ficha t√©cnica, previs√£o e compras</div>
            </div>
        </div>
        <nav class="tabs" id="main-tabs">
            <button class="active" data-tab="cadastros">Cadastros</button>
            <button data-tab="producao">Produ√ß√£o</button>
            <button data-tab="compras">Compras</button>
            <button data-tab="estoque">Estoque</button>
        </nav>
        <div class="status-bar">
            <div id="status">Carregando‚Ä¶</div>
        </div>
    </div>

    <div class="content-wrap">
    
    <section class="tab-content active" id="tab-cadastros">
        <div class="section" id="section-cadastros">
            <nav class="subtabs" id="cadastro-subtabs">
                <button class="active" data-subtab="pratos">Pratos</button>
                <button data-subtab="componentes">Componentes</button>
                <button data-subtab="receitas">Receitas</button>
                <button data-subtab="ingredientes">Ingredientes</button>
                <button class="chip" data-subtab="um">Unidades de Medida</button>
                <button class="chip" data-subtab="unidades">Locais/Unidades</button>
                <button class="chip" data-subtab="categorias">Categorias</button>
            </nav>

            <div class="subpage active" id="sub-pratos">
                <div class="actions-bar">
                    <h2>Pratos</h2>
                    <div class="right">
                        <button class="btn" id="btnImportarPratos">üì• Importar de Vendas</button>
                        <button class="btn pri" id="btnNovoPrato">‚ûï Novo Prato</button>
                    </div>
                </div>

                <div class="editor-container" id="prato-editor-container">
                    <h3 id="prato-form-title">Novo Prato</h3>
                    <form id="form-prato" class="form-grid">
                        <input type="hidden" name="id">
                        <div class="form-span-col-2">
                            <label for="prato-nome">Nome do Prato</label>
                            <input type="text" id="prato-nome" name="nome" required>
                        </div>
                        <div>
                            <label for="prato-cat">Categoria</label>
                            <select id="prato-cat" name="categoria_id"></select>
                        </div>
                        <div>
                            <label for="prato-preco">Pre√ßo de Venda</label>
                            <input type="number" id="prato-preco" name="preco_venda" step="0.01" min="0" data-type="number">
                        </div>
                        <div>
                            <label for="prato-ativo"><input type="checkbox" id="prato-ativo" name="ativo" checked> Ativo</label>
                        </div>
                        <div class="right form-span-col-2">
                            <button type="button" class="btn" id="btnCancelarPrato">Cancelar</button>
                            <button type="submit" class="btn pri">Salvar Prato</button>
                        </div>
                    </form>
                </div>

                <div class="editor-container" id="prato-import-container">
                     <h3>Importar Pratos N√£o Cadastrados</h3>
                     <p class="hint">Busca na sua tabela de vendas por pratos que foram vendidos mas ainda n√£o existem no cadastro de pratos.</p>
                     
                     <div class="import-error-box" id="import-error-detail" style="display: none;">
                        <strong>Erro ao buscar pratos:</strong>
                        <p id="import-error-message" style="margin: 8px 0;"></p>
                        <div id="import-sql-fix" style="display:none;">
                            <p><strong>Solu√ß√£o:</strong> Parece que uma fun√ß√£o necess√°ria n√£o existe no seu banco de dados. Por favor, execute o seguinte c√≥digo SQL no Editor SQL do Supabase:</p>
                            <pre><code>CREATE OR REPLACE FUNCTION get_unregistered_dishes()\nRETURNS TABLE(nome_prato TEXT, categoria_sugerida TEXT)\nLANGUAGE plpgsql\nAS $$\nBEGIN\n    -- Verifica se a tabela de vendas existe\n    IF NOT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'vendas_pratos') THEN\n        RAISE EXCEPTION 'A tabela de vendas_pratos n√£o foi encontrada. Importe os dados de vendas primeiro.';\n    END IF;\n\n    RETURN QUERY\n    SELECT DISTINCT v.nome_prato, v.categoria AS categoria_sugerida\n    FROM vendas_pratos v\n    LEFT JOIN pratos p ON v.nome_prato = p.nome\n    WHERE p.id IS NULL;\nEND;\n$$;</code></pre>
                        </div>
                    </div>

                     <div id="import-loader" style="display: none; text-align: center; padding: 20px;">Carregando...</div>
                     <div class="table-container" style="max-height: 300px;">
                        <table id="tblImportPratos">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"><input type="checkbox" id="importCheckAll"></th>
                                    <th>Nome do Prato Vendido</th>
                                    <th>Categoria Sugerida</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                     <div class="right">
                        <button type="button" class="btn" id="btnCancelImport">Cancelar</button>
                        <button type="button" class="btn pri" id="btnConfirmImport" disabled>Importar Selecionados</button>
                     </div>
                </div>

                <div class="table-container">
                    <table id="tblPratos">
                        <thead><tr><th>Nome</th><th>Categoria</th><th>Pre√ßo Venda</th><th>N¬∫ Receitas</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="subpage" id="sub-componentes">
                 <div class="actions-bar">
                    <h2>Componentes do Prato (Receitas)</h2>
                 </div>
                 <div class="form-grid" style="align-items: flex-end; margin-bottom: 16px;">
                    <div>
                        <label for="cp-prato">Selecione o Prato</label>
                        <select id="cp-prato"></select>
                    </div>
                    <div>
                        <label for="cp-receita">Adicionar Receita</label>
                        <select id="cp-receita"></select>
                    </div>
                    <div>
                        <label for="cp-qtd">Quantidade</label>
                        <input type="number" id="cp-qtd" value="1" step="0.001" min="0.001">
                    </div>
                    <div>
                        <button class="btn pri" id="btnAddPrComp">Adicionar Componente</button>
                    </div>
                 </div>
                 <div class="table-container">
                    <table id="tblPrComp">
                        <thead><tr><th>Nome da Receita</th><th>Quantidade</th><th>A√ß√µes</th></tr></thead>
                        <tbody><tr><td colspan="3" style="text-align: center;">Selecione um prato para ver seus componentes.</td></tr></tbody>
                    </table>
                 </div>
            </div>

            <div class="subpage" id="sub-receitas">
                 <div class="actions-bar">
                    <h2>Receitas (Ficha T√©cnica)</h2>
                    <div class="right">
                        <button class="btn pri" id="btnShowNewRecipeForm">‚ûï Nova Receita</button>
                    </div>
                </div>
                <div class="editor-container" id="recipe-editor-container">
                    </div>

                <div class="table-container">
                    <table id="tblRec">
                        <thead><tr><th>Nome</th><th>Rendimento</th><th>N¬∫ Itens</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="subpage" id="sub-ingredientes">
                 <div class="actions-bar">
                    <h2>Ingredientes</h2>
                    <div class="right">
                        <button class="btn pri" id="btnShowNewIngredienteForm">‚ûï Novo Ingrediente</button>
                    </div>
                </div>
                <div class="editor-container" id="ingrediente-editor-container">
                </div>

                <div class="table-container">
                    <table id="tblIng">
                        <thead><tr><th>Nome</th><th>Categoria</th><th>Un. Medida</th><th>Custo Unit√°rio</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="subpage" id="sub-um"></div>
            <div class="subpage" id="sub-unidades"></div>
            <div class="subpage" id="sub-categorias"></div>
        </div>
    </section>

    <section class="tab-content" id="tab-producao">
        <div class="section">
            <div class="actions-bar">
                <h2>Previs√£o de Vendas</h2>
                <div class="filters-container">
                    <div>
                        <label for="prev-data-inicio">Data In√≠cio</label>
                        <input type="date" id="prev-data-inicio">
                    </div>
                    <div>
                        <label for="prev-data-fim">Data Fim</label>
                        <input type="date" id="prev-data-fim">
                    </div>
                    <div>
                        <label for="cat-filter">Categoria de Prato</label>
                        <select id="cat-filter"><option value="">Todas as Categorias</option></select>
                    </div>
                </div>
                <div class="right">
                    <button class="btn pri" id="btnCalcularPrev">Calcular</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="tbl-previsao">
                    <thead>
                        <tr>
                            <th>Nome do Prato</th>
                            <th>Total Vendido no Per√≠odo</th>
                            <th>Previs√£o Ajustada (Di√°ria)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" style="text-align: center; padding: 20px;">Selecione o per√≠odo e clique em Calcular.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="tab-content" id="tab-compras">
        <div class="section">
             <div class="actions-bar">
                <h2>Sugest√µes de Compra</h2>
                <div class="right">
                    <button class="btn" id="btnRefreshSuggestions">üîÑ Atualizar</button>
                </div>
            </div>
            <p class="hint">Itens que est√£o abaixo do ponto de pedido (Estoque M√≠nimo) definido no cadastro de Ingredientes.</p>
            <div class="table-container">
                <table id="tbl-sugestoes">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Estoque Atual</th>
                            <th>Ponto de Pedido</th>
                            <th>Sugest√£o de Compra</th>
                            <th>√öltimo Fornecedor</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section class="tab-content" id="tab-estoque">
        <div class="section">
            <nav class="subtabs" id="estoque-subtabs">
                <button class="active" data-subtab="movimentar">Movimentar</button>
                <button data-subtab="geral">Saldo Geral</button>
                <button data-subtab="lotes">Saldo por Lotes</button>
                <button data-subtab="historico">Hist√≥rico</button>
            </nav>
            
            <div class="subpage active" id="sub-movimentar">
                <div class="actions-bar">
                    <h2>Movimenta√ß√£o de Estoque</h2>
                </div>

                <div class="quick-actions-bar" id="quick-actions-bar">
                    <span class="quick-actions-label">A√ß√µes R√°pidas:</span>
                    <button class="btn quick-btn" data-quickmov="ENTRADA">‚ûï Entrada</button>
                    <button class="btn quick-btn" data-quickmov="SAIDA">‚ûñ Sa√≠da</button>
                    <button class="btn quick-btn" data-quickmov="AJUSTE">üîß Ajuste</button>
                    <button class="btn quick-btn" data-quickmov="TRANSFERENCIA">‚û°Ô∏è Transfer√™ncia</button>
                    <button class="btn quick-btn" data-quickmov="PRODUCAO">üç≥ Produ√ß√£o</button>
                </div>
                
                <form id="form-movimentacao">
                    <div class="form-grid">
                        <div>
                            <label for="mov-tipo">Tipo de Movimenta√ß√£o</label>
                            <select id="mov-tipo" name="tipo" required>
                                <option value="">Selecione...</option>
                                <option value="ENTRADA">Entrada (Compra)</option>
                                <option value="SAIDA">Sa√≠da (Uso/Perda)</option>
                                <option value="AJUSTE">Ajuste de Invent√°rio</option>
                                <option value="TRANSFERENCIA">Transfer√™ncia entre Unidades</option>
                                <option value="PRODUCAO">Produ√ß√£o (Baixa de ingredientes)</option>
                            </select>
                        </div>
                        <div>
                            <label for="mov-item">Item (Ingrediente ou Receita)</label>
                            <select id="mov-item" name="item_id" required></select>
                        </div>
                        <div>
                            <label for="mov-qtd">Quantidade</label>
                            <input type="number" id="mov-qtd" name="quantidade" step="0.001" min="0.001" required>
                        </div>
                        <div id="field-custo" style="display: none;">
                            <label for="mov-custo">Custo Unit√°rio (R$)</label>
                            <input type="number" id="mov-custo" name="custo_unitario" step="0.01" min="0" data-type="number">
                        </div>
                        <div id="field-origem" style="display: none;">
                            <label for="mov-unidade-origem">Unidade de Origem</label>
                            <select id="mov-unidade-origem" name="unidade_origem_id"></select>
                        </div>
                        <div id="field-destino" style="display: none;">
                            <label for="mov-unidade-destino">Unidade de Destino</label>
                            <select id="mov-unidade-destino" name="unidade_destino_id"></select>
                        </div>
                        <div id="field-validade" style="display: none;">
                            <label for="mov-validade">Data de Validade</label>
                            <input type="date" id="mov-validade" name="data_validade">
                        </div>
                        <div class="form-span-col-2">
                             <label for="mov-obs">Observa√ß√£o</label>
                             <input type="text" id="mov-obs" name="obs">
                        </div>
                    </div>
                    <div class="right">
                        <button type="button" class="btn" id="btnMovCancel">Limpar</button>
                        <button type="submit" class="btn pri">Registrar Movimenta√ß√£o</button>
                    </div>
                </form>
            </div>
            
            <div class="subpage" id="sub-geral">
                <div class="table-container"><table id="tblEstoqueGeral">
                    <thead><tr><th>Item</th><th>Qtd. Total</th><th>Un. Medida</th><th>Custo M√©dio</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>
            <div class="subpage" id="sub-lotes">
                <div class="table-container"><table id="tblEstoqueLotes">
                    <thead><tr><th>Item</th><th>Qtd.</th><th>Un. Medida</th><th>Custo Unit.</th><th>Validade</th><th>Local</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>
            <div class="subpage" id="sub-historico">
                 <div class="table-container"><table id="tblHistorico">
                    <thead><tr><th>Data/Hora</th><th>Tipo</th><th>Item</th><th>Quantidade</th><th>Origem/Destino</th><th>Usu√°rio</th><th>Obs.</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>
        </div>
    </section>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script src="app.js?v=8.1"></script>
</body>
</html>
