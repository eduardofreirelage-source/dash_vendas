<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mapa de Produção — Compras & Estoque (Full)</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --chip:#fef2f2; --ok:#0b5d47; --down:#b91c1c;
      --ok-dark: #065f46; --wine-dark: #881337;
      --radius:14px; --shadow:0 8px 28px rgba(16,24,40,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{margin:0 0 10px;font-weight:600}
    h1{font-size:22px} h2{font-size:18px} h3{font-size:16px}
    .muted{color:var(--muted)}

    html, body { height: 100vh; overflow: hidden; }
    body { display: flex; flex-direction: column; }
    .main{ display:flex; flex-direction:column; height:100%; flex:1; min-height:0; }
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:34px;height:34px;border-radius:10px;background:var(--wine);display:grid;place-items:center;color:#fff;font-weight:700}
    .tabs{display:flex;gap:6px;border:0;background:transparent;flex-wrap:wrap}
    .tabs button{padding:8px 12px;border:0;background:transparent;font-weight:700;font-size:14px;color:#334155;cursor:pointer;border-radius:8px;position:relative}
    .tabs button.active{background:transparent;color:var(--wine)} .tabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-10px;height:3px;border-radius:2px;background:var(--wine)}
    .status-bar { display:flex; align-items:center; gap:12px; font-size:13px; color:var(--muted); }

    .content-wrap{ max-width:1320px; margin:0 auto; padding:18px 16px; flex:1; min-height:0; width:100%;}
    .section{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); width:100%; height:100%; overflow:hidden; display:flex; flex-direction:column; }
    .section-body{ flex:1; min-height:0; overflow:auto; }

    .tab-content{ display:none; height:100%; }
    .tab-content.active{ display:block }

    /* Subtabs */
    .subtabs{display:flex;gap:4px;border-bottom:1px solid var(--line);margin-bottom:10px;padding-bottom:8px;flex-wrap:wrap}
    .subtabs button{padding:7px 12px;border-radius:8px;border:1px solid transparent;background:transparent;font-weight:600;font-size:14px;color:#475569;cursor:pointer;position: relative;}
    .subtabs button:hover{background:#f8fafc;color: var(--wine-dark);}
    .subtabs button.active{background:transparent;border-color:transparent;color:var(--wine); font-weight: 700;}
    .subtabs button.active::after{content:"";position:absolute;left:8px;right:8px;bottom:-11px;height:3px;border-radius:2px;background:var(--wine)}

    /* Components */
    label{font-size:13px;color:#475569;margin-bottom:6px;display:block;font-weight:500}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:42px;font-family:inherit;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(123,30,58,.2)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px; white-space: nowrap;}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}
    .btn.small{padding:7px 12px;font-size:13px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent}
    .right{display:flex;justify-content:flex-end;align-items:center;gap:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .cols-5{grid-template-columns:repeat(5,1fr)}
    @media (max-width:1020px){.cols-2,.cols-3,.cols-4,.cols-5{grid-template-columns:1fr}}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 12px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:12px;font-weight:500;color:#475569}
    .pill.ok{border-color:#a7f3d0;background:#dcfce7;color:var(--ok-dark)}
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:var(--wine-dark)}
    .soft{color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .hint{color:#64748b;font-size:12px;margin-top:4px}
    .table-container{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:12px;text-align:left;vertical-align:middle;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;z-index:1;font-weight:600;color:var(--muted)}
    tbody tr:hover{background:#fafafb}
    tbody tr:last-child td{border-bottom:0}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .nowrap{white-space:nowrap}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .card{background:#fafbff;border:1px dashed #cbd5e1;padding:12px;border-radius:12px;min-width:180px}
    .alert{padding:10px 12px;border-radius:8px;border:1px solid var(--line);background:#fff}
    .alert.err{border-color:#fecaca;background:#fff5f5;color:#7f1d1d}
    .alert.ok{border-color:#a7f3d0;background:#ecfdf5;color:#064e3b}
  </style>
</head>
<body>
<main class="main">
  <div class="top">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1 style="font-size:18px; margin:0; line-height:1.2">Mapa de Produção — v3 (Full)</h1>
        <div class="hint" style="margin:0">Cadastros • Produção • Compras • Estoque</div>
      </div>
    </div>
    <nav class="tabs" id="main-tabs">
      <button data-tab="cadastros" class="active">Cadastros</button>
      <button data-tab="producao">Produção</button>
      <button data-tab="compras">Compras</button>
      <button data-tab="estoque">Estoque</button>
    </nav>
    <div class="status-bar">
      <div id="status">Carregando…</div>
    </div>
  </div>

  <div class="content-wrap">
    <!-- ===== CADASTROS ===== -->
    <section id="tab-cadastros" class="tab-content active">
      <div class="section">
        <nav class="subtabs" id="cadastro-subtabs">
          <button data-subtab="pratos" class="active">Pratos</button>
          <button data-subtab="componentes">Componentes</button>
          <button data-subtab="receitas">Receitas</button>
          <button data-subtab="ingredientes">Ingredientes</button>
          <button data-subtab="um">Unid. de Medida</button>
          <button data-subtab="unidades">Unidades (Destino)</button>
          <button data-subtab="categorias">Categorias</button>
          <button data-subtab="tipos">Tipos de Item</button>
        </nav>
        <div class="section-body">
          <!-- Sub: PRATOS (resumo minimal para manter) -->
          <div id="sub-pratos" class="subpage active">
            <div class="row" style="justify-content:space-between;align-items:flex-end">
              <div style="flex:1;min-width:260px">
                <label>Buscar prato</label>
                <input id="pratos-search" placeholder="Digite para filtrar…">
              </div>
              <div class="right"><button id="btnNovoPrato" class="btn pri">+ Novo prato</button></div>
            </div>
            <div class="sep"></div>
            <div class="grid cols-2" style="margin:6px 0; align-items:flex-end;">
              <div>
                <label>Filtrar categoria</label>
                <select id="pratos-cat-filter">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="right">
                <span class="pill" id="pratos-page-info">Página 1/1</span>
                <div class="row-actions"><button class="btn small" id="pratos-prev">◀</button><button class="btn small" id="pratos-next">▶</button></div>
              </div>
            </div>
            <div class="table-container" style="max-height:300px;">
              <table id="tblPratos"><thead><tr><th>Nome</th><th>Categoria</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="sep"></div>
            <h3 id="prato-form-title">Editar prato</h3>
            <div class="grid cols-4">
              <div><label>Nome</label><input id="prato-nome" placeholder="Ex.: Strogonoff de frango"></div>
              <div><label>Categoria</label><select id="prato-cat"></select></div>
              <div><label>Und peso</label><select id="prato-peso-un"><option>g</option><option>ml</option></select></div>
              <div><label>Qtd</label><input id="prato-peso" placeholder="Ex.: 500"></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px;">
              <div><label>Cód. Barras</label><input id="prato-codigo-barras" disabled></div>
              <div><label>QR Code</label><input id="prato-qrcode" disabled></div>
            </div>
            <div style="margin-top:10px;">
              <label>Descrição</label>
              <textarea id="prato-descricao" rows="3" placeholder="Descreva o prato…"></textarea>
            </div>
            <div class="grid cols-4" style="margin-top:10px; align-items:flex-end;">
              <div><label>Preço venda</label><input id="prato-preco" placeholder="Ex.: 34,90"></div>
              <div><label>Custo (calc.)</label><input id="prato-custo" disabled placeholder="R$ 0,00"></div>
              <div><label>Última alt.</label><input id="prato-ultima" disabled placeholder="—"></div>
              <div class="right">
                <button id="btnSalvarPrato" class="btn pri">Salvar</button>
                <button id="btnCancelarPrato" class="btn">Cancelar</button>
              </div>
            </div>
          </div>

          <!-- Sub: COMPONENTES (prato_receitas) -->
          <div id="sub-componentes" class="subpage">
            <h3>Componentes do Prato</h3>
            <div class="grid cols-3">
              <div><label>Prato</label><select id="cp-prato"><option value="">Selecione…</option></select></div>
              <div><label>Receita</label><select id="cp-receita"></select></div>
              <div><label>Qtd por prato</label><input id="cp-qtd" placeholder="Ex.: 220"></div>
            </div>
            <div class="grid cols-3" style="margin-top:10px">
              <div><label>Unidade</label><select id="cp-und"><option>g</option><option>ml</option><option>porcao</option></select></div>
              <div><label>Obs</label><input id="cp-obs" placeholder="Opcional"></div>
              <div class="right" style="align-self:end"><button id="btnAddPrComp" class="btn pri">Adicionar</button></div>
            </div>
            <div class="sep"></div>
            <div class="table-container" style="max-height:280px"><table id="tblPrComp"><thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>

          <!-- Sub: RECEITAS -->
          <div id="sub-receitas" class="subpage">
            <div class="right" style="margin-bottom: 10px;"><button id="btnShowNewRecipeForm" class="btn pri">+ Nova Receita</button></div>
            <div id="recipe-editor-container" style="display:none;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
              <h3 id="recipe-form-title">Nova Receita</h3>
              <div class="grid cols-3">
                <div><label>Nome</label><input id="rec-nome"></div>
                <div><label>Rendimento (qtd)</label><input id="rec-rend-qtd"></div>
                <div><label>Und rendimento</label><select id="rec-rend-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option value="porcao">porção</option></select></div>
              </div>
              <div class="grid cols-3" style="margin-top:10px;">
                <div><label>Perda global %</label><input id="rec-perda" value="0"></div>
                <div><label>Cód. Barras</label><input id="rec-codigo-barras" disabled></div>
                <div><label>QR Code</label><input id="rec-qrcode" disabled></div>
              </div>
              <div><label>Modo de Preparo</label><textarea id="rec-preparo" rows="5"></textarea></div>
              <div class="sep"></div>
              <h4>Itens</h4>
              <div class="grid cols-4">
                <div><label>Tipo</label><select id="draft-tipo"><option>INGREDIENTE</option><option>RECEITA</option></select></div>
                <div><label>Referência</label><select id="draft-ref"></select></div>
                <div><label>Qtd</label><input id="draft-qtd"></div>
                <div><label>Unidade</label><select id="draft-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
              </div>
              <div class="grid cols-2" style="margin-top:10px; align-items:flex-end;">
                <div><label>Perda linha %</label><input id="draft-perda" value="0"></div>
                <div class="right">
                  <button id="btnDraftAdd" class="btn">Adicionar Item</button>
                  <button id="btnDraftClear" class="btn">Limpar Itens</button>
                </div>
              </div>
              <div class="table-container" style="margin-top:8px;max-height:180px"><table id="tblDraft"><thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
              <div class="right" style="margin-top:10px">
                <button id="btnSaveRec" class="btn pri">Salvar</button>
                <button id="btnUpdateRec" class="btn pri" style="display:none">Atualizar</button>
                <button id="btnCancelRecEdit" class="btn">Cancelar</button>
              </div>
            </div>
            <h3>Receitas Cadastradas</h3>
            <div class="table-container" style="max-height:300px"><table id="tblRec"><thead><tr><th>Nome</th><th>Rendimento</th><th>Itens</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>

          <!-- Sub: INGREDIENTES -->
          <div id="sub-ingredientes" class="subpage">
            <div class="grid cols-3">
              <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco"></div>
              <div><label>Unidade</label><select id="ing-und"><option>g</option><option selected>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
              <div><label>Custo unitário</label><input id="ing-custo" placeholder="Ex.: 0,0123"></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px;">
              <div><label>Cód. Barras</label><input id="ing-codigo-barras" disabled></div>
              <div><label>QR Code</label><input id="ing-qrcode" disabled></div>
            </div>
            <div class="grid cols-2" style="margin-top:10px; align-items:flex-end;">
              <div><label>Observações</label><input id="ing-obs" placeholder="Opcional"></div>
              <div class="right"><button id="btnSaveIng" class="btn pri">Salvar</button><button id="btnCancelIngEdit" class="btn" style="display:none">Cancelar</button></div>
            </div>
            <div id="ing-mode-hint" class="hint"></div>
            <div class="sep"></div>
            <div class="grid cols-2"><div class="pill">Ingredientes cadastrados</div><div class="right"><input id="ing-search" placeholder="Buscar..."></div></div>
            <div class="table-container" style="margin-top:6px;max-height:260px"><table id="tblIng"><thead><tr><th>Nome</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>

          <!-- Sub: UM (Unidades de Medida) -->
          <div id="sub-um" class="subpage">
            <h3>Unidades de Medida</h3>
            <div class="grid cols-5">
              <div><label>Sigla</label><input id="um-sigla" placeholder="KG"></div>
              <div><label>Nome</label><input id="um-nome" placeholder="Quilograma"></div>
              <div><label>Código</label><input id="um-codigo" placeholder="kg"></div>
              <div><label>Base</label><select id="um-base"><option value="">—</option><option value="g">g</option><option value="ml">ml</option><option value="un">un</option></select></div>
              <div><label>Fator</label><input id="um-fator" placeholder="1000"></div>
            </div>
            <div class="right" style="margin-top:10px"><button id="btnSaveUM" class="btn pri">Salvar</button></div>
            <div class="sep"></div>
            <div class="table-container" style="max-height:260px"><table id="tblUM"><thead><tr><th>Sigla</th><th>Nome</th><th>Código</th><th>Base</th><th>Fator</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
            <div id="um-hint" class="hint"></div>
          </div>

          <!-- Sub: UNIDADES (destino) -->
          <div id="sub-unidades" class="subpage">
            <h3>Unidades (Destino)</h3>
            <div class="grid cols-3">
              <div><label>Nome</label><input id="uni-nome" placeholder="Loja Centro"></div>
              <div><label>Observação</label><input id="uni-obs" placeholder="Opcional"></div>
              <div class="right" style="align-self:end"><button id="btnSaveUni" class="btn pri">Salvar</button></div>
            </div>
            <div class="sep"></div>
            <div class="table-container" style="max-height:260px"><table id="tblUnidades"><thead><tr><th>Nome</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>

          <!-- Sub: CATEGORIAS -->
          <div id="sub-categorias" class="subpage">
            <h3>Categorias</h3>
            <div class="grid cols-3">
              <div><label>Nome</label><input id="cat-nome" placeholder="PRATOS"></div>
              <div><label>Tipo (opcional)</label><input id="cat-tipo" placeholder="ex.: PRATO/ING/RECEITA"></div>
              <div class="right" style="align-self:end"><button id="btnSaveCat" class="btn pri">Salvar</button></div>
            </div>
            <div class="sep"></div>
            <div class="table-container" style="max-height:260px"><table id="tblCat"><thead><tr><th>Nome</th><th>Tipo</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>

          <!-- Sub: TIPOS DE ITEM -->
          <div id="sub-tipos" class="subpage">
            <h3>Tipos de Item</h3>
            <div class="grid cols-3">
              <div><label>Código</label><input id="tipo-cod" placeholder="ING / REC / PRATO"></div>
              <div><label>Nome</label><input id="tipo-nome" placeholder="Ingrediente"></div>
              <div class="right" style="align-self:end"><button id="btnSaveTipo" class="btn pri">Salvar</button></div>
            </div>
            <div class="sep"></div>
            <div class="table-container" style="max-height:260px"><table id="tblTipos"><thead><tr><th>Código</th><th>Nome</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== PRODUÇÃO ===== -->
    <section id="tab-producao" class="tab-content">
      <div class="section">
        <h2>Mapa de Produção – Previsão</h2>
        <div class="row" style="align-items:flex-end;">
          <div>
            <label>Média dos últimos (dias)</label>
            <input id="win-dias" type="number" min="1" step="1" value="7" />
          </div>
          <div>
            <label>Projetar próximos (dias)</label>
            <input id="proj-dias" type="number" min="1" step="1" value="7" />
          </div>
          <div>
            <label>Categorias</label>
            <select id="cat-filter" multiple style="min-width:220px"></select>
          </div>
          <div class="right">
            <button id="btnCalcularPrev" class="btn pri">Calcular</button>
          </div>
        </div>
        <div class="hint" id="prev-hint-top"></div>
        <div class="kpi" style="margin-top:10px">
          <div class="card"><div class="muted">Dias analisados</div><div id="kpi-dias" style="font-weight:700">—</div></div>
          <div class="card"><div class="muted">Pratos</div><div id="kpi-pratos" style="font-weight:700">—</div></div>
          <div class="card"><div class="muted">Receitas</div><div id="kpi-rec" style="font-weight:700">—</div></div>
        </div>
        <div class="sep"></div>
        <h3>Resumo — Média de Vendas por Prato</h3>
        <div class="table-container" style="max-height:220px;">
          <table id="tblResumoPratos">
            <thead><tr><th>Prato</th><th>Categoria</th><th>Média/Dia</th><th id="th-proj-prato">Projeção</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="sep"></div>
        <h3>Produção consolidada por Receita</h3>
        <div class="table-container" style="max-height:260px;">
          <table id="tblPrev">
            <thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th id="th-proj">Qtd/Projeção</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="right" style="margin-top:12px"><button id="btnExportPrev" class="btn">Exportar PDF</button></div>
        <div class="hint" id="prev-hint"></div>
      </div>
    </section>

    <!-- ===== COMPRAS ===== -->
    <section id="tab-compras" class="tab-content">
      <div class="section">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h2>Compras & Pedidos</h2>
          <div class="row">
            <div>
              <label>Unidade (trabalho)</label>
              <select id="compras-unidade"></select>
            </div>
            <button id="btnRefreshAllCompras" class="btn">Atualizar</button>
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid cols-2 section-body" style="gap:20px">
          <div>
            <h3>Sugestões de compra</h3>
            <div id="compras-sug-hint" class="hint">Usa mv_sugestoes_compra ou vw_lista_compras (fallback).</div>
            <div class="table-container" style="max-height:320px">
              <table id="tblSugestoes">
                <thead><tr><th>Fornecedor</th><th>Item</th><th>Un</th><th>Sugerido</th><th>Múltiplo</th><th>Qtd</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="right" style="margin-top:10px"><button id="btnGerarPedido" class="btn pri">Gerar Pedido</button></div>
          </div>
          <div>
            <h3>Pedidos</h3>
            <div class="row" style="align-items:flex-end">
              <div>
                <label>Status</label>
                <select id="ped-status"><option value="">Todos</option><option>ABERTO</option><option>PARCIAL</option><option>RECEBIDO</option><option>CANCELADO</option></select>
              </div>
              <button id="btnListarPedidos" class="btn">Listar</button>
            </div>
            <div class="table-container" style="max-height:180px;margin-top:8px">
              <table id="tblPedidos"><thead><tr><th>Pedido</th><th>Fornecedor</th><th>Itens</th><th>Total</th><th>Status</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="sep"></div>
            <h3>Itens do Pedido</h3>
            <div class="row" style="align-items:flex-end">
              <div style="flex:1;min-width:240px">
                <label>Pedido</label>
                <select id="pedido-sel"></select>
              </div>
              <div><label>Usuário</label><input id="pedido-user" placeholder="ex.: app_user"></div>
              <div><label>Preço padrão (R$)</label><input id="pedido-preco" placeholder="0,00"></div>
              <button id="btnReceberPedido" class="btn pri">Receber</button>
              <button id="btnEstornarPedido" class="btn ghost">Estornar</button>
            </div>
            <div class="table-container" style="max-height:220px;margin-top:8px">
              <table id="tblPedidoItens"><thead><tr><th>Item</th><th>Un</th><th>Sugerido</th><th>Pedido</th><th>Preço</th><th>Subtotal</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== ESTOQUE ===== -->
    <section id="tab-estoque" class="tab-content">
      <div class="section">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2>Estoque — Movimentações</h2>
          <div class="row">
            <div>
              <label>Unidade (trabalho)</label>
              <select id="est-unidade"></select>
            </div>
            <button id="btnRefreshEstoque" class="btn">Atualizar</button>
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid cols-2 section-body" style="gap:20px">
          <div>
            <h3>Entrada / Saída</h3>
            <div class="grid cols-2">
              <div><label>Tipo</label><select id="est-tipo-es"><option value="ENTRADA">ENTRADA</option><option value="SAIDA">SAÍDA</option></select></div>
              <div><label>Item tipo</label><select id="est-item-tipo"><option value="ING">ING</option><option value="REC">REC</option><option value="PRATO">PRATO</option></select></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px">
              <div><label>Item</label><select id="est-item"></select></div>
              <div><label>Un med.</label><select id="est-un"><option>kg</option><option>g</option><option>ml</option><option>L</option><option>un</option></select></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px">
              <div><label>Quantidade</label><input id="est-qtd" placeholder="Ex.: 10"></div>
              <div><label>Custo unitário (R$)</label><input id="est-custo" placeholder="Ex.: 6,50"></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px">
              <div><label>Ref. doc</label><input id="est-ref" placeholder="NF, pedido, etc."></div>
              <div><label>Observação</label><input id="est-obs"></div>
            </div>
            <div class="right" style="margin-top:8px"><button id="btnSalvarMovES" class="btn pri">Lançar</button></div>
            <div id="est-es-msg" class="hint"></div>
            <div class="sep"></div>
            <h3>Transferência</h3>
            <div class="grid cols-2">
              <div><label>Origem</label><select id="tr-origem"></select></div>
              <div><label>Destino</label><select id="tr-destino"></select></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px">
              <div><label>Item (ING)</label><select id="tr-item"></select></div>
              <div><label>Un med.</label><select id="tr-un"><option>kg</option><option>g</option><option>ml</option><option>L</option><option>un</option></select></div>
            </div>
            <div class="grid cols-2" style="margin-top:8px">
              <div><label>Quantidade</label><input id="tr-qtd" placeholder="Ex.: 5"></div>
              <div><label>Ref doc</label><input id="tr-ref" placeholder="TR-..."></div>
            </div>
            <div class="right" style="margin-top:8px"><button id="btnTransferir" class="btn pri">Transferir</button></div>
          </div>
          <div>
            <h3>Saldo por Item/Unidade</h3>
            <div class="table-container" style="max-height:320px">
              <table id="tblSaldo"><thead><tr><th>Unidade</th><th>Item</th><th>Un med.</th><th>Saldo</th><th>Status</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="sep"></div>
            <h3>Últimos lançamentos</h3>
            <div class="table-container" style="max-height:180px">
              <table id="tblMovs"><thead><tr><th>Data</th><th>Tipo</th><th>Item</th><th>Qtd</th><th>Un</th><th>Custo</th><th>Ref</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
(function(){
  'use strict';

  /* ===== Helpers ===== */
  const $  = (id)=> document.getElementById(id);
  const $$ = (sel,root=document)=> Array.from(root.querySelectorAll(sel));
  const setStatus=(msg,cls)=>{const el=$('status'); if(!el) return; el.textContent=msg; el.style.color=(cls==='err'?'var(--down)':cls==='ok'?'var(--ok)':'var(--muted)');};
  const fmt=(n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
  const ptToNumber=(v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
  const todayStr=()=> new Date().toISOString().slice(0,10);
  const weekDayPt=(iso)=> new Date(iso+'T00:00:00').toLocaleDateString('pt-BR',{weekday:'long'});

  /* ===== Supabase (use os mesmos do seu projeto) ===== */
  const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===== Router ===== */
  function setupRouting() {
    const mainTabsContainer = $('main-tabs');
    const mainContents = $$('.tab-content');
    const cadastroSubTabsContainer = $('cadastro-subtabs');
    const cadastroSubContents = $$('#tab-cadastros .subpage');

    mainTabsContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const tabId = btn.dataset.tab;
      mainTabsContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      mainContents.forEach(content => content.classList.toggle('active', content.id === 'tab-' + tabId));
    });

    cadastroSubTabsContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const subTabId = btn.dataset.subtab;
      cadastroSubTabsContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      cadastroSubContents.forEach(content => content.classList.toggle('active', content.id === 'sub-' + subTabId));
    });
  }

  /* ===== Generic fills ===== */
  async function fillOptions(table, selId, valKey, labelKey, whereEq, allowEmpty=true) {
    const sel=$(selId); if(!sel) return;
    sel.innerHTML = allowEmpty ? '<option value=\"\">Selecione</option>' : '';
    try{
      let q=supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true});
      if(whereEq) Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v));
      const {data,error}=await q;
      if(error) throw error;
      (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); });
    }catch(e){
      const o=document.createElement('option'); o.value=''; o.textContent='(configure '+table+')'; sel.appendChild(o);
    }
  }
  async function backfillCodes(tableName) {
    try {
      const { data, error } = await supa.from(tableName).select('id, qrcode').is('qrcode', null);
      if (error) return;
      if (data && data.length > 0) {
        setStatus(`Atualizando ${data.length} em ${tableName}…`,'');            
        for (const item of data) {
          const newId = crypto.randomUUID();
          await supa.from(tableName).update({ codigo_barras:newId, qrcode:newId }).eq('id', item.id);
        }
      }
    } catch(_) {}
  }

  /* ===== PRATOS (lista simples) ===== */
  let pratos=[], pratosPage=1; const PAGE_SIZE=10; let pratoEditId=null;
  async function loadPratos(){
    try{
      let data=null,error=null; ({data,error}=await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true}));
      if(error){ ({data,error}=await supa.from('pratos').select('*').order('nome',{ascending:true})); }
      pratos=data||[]; renderPratos();
      await fillOptions('categorias','prato-cat','id','nome');
      await fillOptions('pratos','cp-prato','id','nome',{ativo:true});
      await fillOptions('receitas','cp-receita','id','nome',{ativo:true});
      await fillOptions('pratos','pratos-cat-filter','categoria','categoria',null); // fallback simple
    }catch(e){ pratos=[]; renderPratos(); setStatus('Não foi possível carregar pratos: '+(e.message||e),'err'); }
  }
  function renderPratos(){
    const term=$('pratos-search').value?.toLowerCase().trim()||'';
    const catF= $('pratos-cat-filter').value||'';
    const filtered=pratos.filter(p=>(!catF||String(p.categoria||'')===catF) && (!term||String(p.nome).toLowerCase().includes(term)));
    const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
    if(pratosPage>totalPages) pratosPage=totalPages;
    const pageItems=filtered.slice((pratosPage-1)*PAGE_SIZE,(pratosPage-1)*PAGE_SIZE+PAGE_SIZE);
    const tb=$('tblPratos').querySelector('tbody'); tb.innerHTML='';
    pageItems.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${p.nome}</td><td>${p.categoria||'—'}</td>
        <td>${p.ativo?'<span class=\"pill ok\">Ativo</span>':'<span class=\"pill bad\">Inativo</span>'}</td>
        <td class=\"row-actions\"><button class=\"btn small\" data-act=\"edit\" data-id=\"${p.id}\">Editar</button>
        <button class=\"btn small\" data-act=\"toggle\" data-id=\"${p.id}\">${p.ativo?'Desativar':'Ativar'}</button>
        <button class=\"btn small\" data-act=\"del\" data-id=\"${p.id}\">Excluir</button></td>`;
      tb.appendChild(tr);
    });
    $('pratos-page-info').textContent=`Página ${pratosPage}/${totalPages}`;
    $('pratos-prev').disabled=pratosPage<=1; $('pratos-next').disabled=pratosPage>=totalPages;
  }
  $('pratos-prev').addEventListener('click',()=>{ pratosPage=Math.max(1,pratosPage-1); renderPratos(); });
  $('pratos-next').addEventListener('click',()=>{ pratosPage=pratosPage+1; renderPratos(); });
  $('pratos-search').addEventListener('input',()=>{ pratosPage=1; renderPratos(); });
  $('pratos-cat-filter').addEventListener('change',()=>{ pratosPage=1; renderPratos(); });
  $('btnNovoPrato').addEventListener('click',()=>{ 
    pratoEditId=null; $('prato-form-title').textContent='Novo prato'; $('prato-nome').value=''; $('prato-cat').value=''; $('prato-peso').value=''; $('prato-peso-un').value='g'; $('prato-preco').value=''; $('prato-custo').value=''; $('prato-ultima').value=''; $('prato-descricao').value = ''; $('prato-codigo-barras').value = ''; $('prato-qrcode').value = '';
  });
  $('btnCancelarPrato').addEventListener('click',()=> $('btnNovoPrato').click());
  $('tblPratos').addEventListener('click',async e=>{
    const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id, act=b.dataset.act;
    if(act==='edit'){ 
      const p=pratos.find(x=>String(x.id)===String(id)); if(!p) return; pratoEditId=p.id; $('prato-form-title').textContent='Editar prato'; $('prato-nome').value=p.nome||''; $('prato-cat').value=p.categoria||''; $('prato-peso').value=p.peso??''; $('prato-peso-un').value=p.peso_un||'g'; $('prato-preco').value=p.preco_venda??''; $('prato-custo').value=p.custo??''; $('prato-ultima').value=p.updated_at?new Date(p.updated_at).toLocaleString('pt-BR'):'—'; $('prato-descricao').value = p.descricao || ''; $('prato-codigo-barras').value = p.codigo_barras || ''; $('prato-qrcode').value = p.qrcode || '';
    }
    if(act==='toggle'){ try{ const p=pratos.find(x=>String(x.id)===String(id)); const {error}=await supa.from('pratos').update({ativo:!p.ativo}).eq('id',id); if(error) throw error; await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
    if(act==='del'){ if(!confirm('Excluir prato?')) return; try{ const {error}=await supa.from('pratos').delete().eq('id',id); if(error) throw error; await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
  });
  $('btnSalvarPrato').addEventListener('click',async ()=>{
    const nome=$('prato-nome').value.trim(); if(!nome){ alert('Informe o nome do prato'); return; }
    const basePayload={ 
      nome, categoria:$('prato-cat').value||null, peso:ptToNumber($('prato-peso').value), peso_un:$('prato-peso-un').value, preco_venda:$('prato-preco').value.trim(), descricao: $('prato-descricao').value.trim() || null
    };
    try{
      if(pratoEditId){ const {error}=await supa.from('pratos').update(basePayload).eq('id',pratoEditId); if(error) throw error; }
      else { const newId = crypto.randomUUID(); const insertPayload = { ...basePayload, codigo_barras:newId, qrcode:newId, ativo:true }; const {error}=await supa.from('pratos').insert(insertPayload); if(error) throw error; }
      await loadPratos(); $('btnNovoPrato').click(); setStatus('Prato salvo','ok');
    }catch(e){ setStatus(e.message||e,'err'); }
  });

  // Componentes (prato_receitas)
  async function loadPratoCompTable(){
    const prato_id=$('cp-prato').value; const tb=$('tblPrComp').querySelector('tbody'); tb.innerHTML='';
    if(!prato_id) return;
    try{
      const {data, error}=await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id',prato_id);
      if(error) throw error;
      for(const row of (data||[])){
        const {data:rec}=await supa.from('receitas').select('nome').eq('id',row.receita_id).single();
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${rec?.nome||'(removida)'}</td><td>${fmt(row.qtd)}</td><td>${row.unidade}</td><td class=\"row-actions\"><button class=\"btn small\" data-del=\"${row.id}\">Remover</button></td>`;
        tb.appendChild(tr);
      }
    }catch(ex){ tb.innerHTML='<tr><td colspan=\"4\">Erro ao listar</td></tr>'; }
  }
  $('cp-prato')?.addEventListener('change', async () => { await loadPratoCompTable(); });
  $('btnAddPrComp')?.addEventListener('click',async ()=>{
    const prato_id=$('cp-prato').value, receita_id=$('cp-receita').value, qtd=ptToNumber($('cp-qtd').value), unidade=$('cp-und').value, obs=$('cp-obs').value.trim()||null;
    if(!prato_id||!receita_id||!qtd){ return alert('Selecione prato/receita e informe quantidade'); }
    const {error}=await supa.from('prato_receitas').insert({prato_id,receita_id,qtd,unidade,obs});
    if(error && !String(error.message||'').includes('duplicate')) return alert(error.message||error);
    $('cp-qtd').value=''; $('cp-obs').value=''; await loadPratoCompTable();
  });
  document.addEventListener('click', async e=>{
    const b=e.target.closest('#tblPrComp button[data-del]'); if(!b) return;
    if(!confirm('Remover receita do prato?')) return;
    const {error}=await supa.from('prato_receitas').delete().eq('id',b.dataset.del);
    if(error) return alert(error.message||error);
    await loadPratoCompTable();
  });

  /* ===== Receitas ===== */
  let recEditId=null, draftItems=[];
  async function refreshDraftRefs(){ const tipo=$('draft-tipo').value; if(tipo==='INGREDIENTE') await fillOptions('ingredientes','draft-ref','id','nome',{ativo:true}); else await fillOptions('receitas','draft-ref','id','nome',{ativo:true}); }
  function renderDraft(){ const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML=''; draftItems.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.tipo}</td><td>${it.nome}</td><td>${fmt(it.qtd)}</td><td>${it.unidade}</td><td>${fmt(it.perda_pct)}%</td><td class=\"row-actions\"><button class=\"btn small\" data-rm=\"${i}\">Remover</button></td>`; tb.appendChild(tr); }); }
  $('draft-tipo')?.addEventListener('change',refreshDraftRefs);
  document.addEventListener('click',e=>{ const b=e.target.closest('#tblDraft button[data-rm]'); if(!b) return; draftItems.splice(+b.dataset.rm,1); renderDraft(); });
  $('btnDraftAdd')?.addEventListener('click',async ()=>{ const tipo=$('draft-tipo').value, ref_id=$('draft-ref').value, qtd=ptToNumber($('draft-qtd').value), unidade=$('draft-und').value, perda_pct=ptToNumber($('draft-perda').value); if(!ref_id||!qtd) return alert('Selecione a referência e informe a quantidade'); let nome=''; if(tipo==='INGREDIENTE'){ const {data}=await supa.from('ingredientes').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; } else { const {data}=await supa.from('receitas').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; } draftItems.push({tipo,ref_id,nome,qtd,unidade,perda_pct}); $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft(); });
  $('btnDraftClear')?.addEventListener('click',()=>{ draftItems=[]; renderDraft(); });
  $('btnShowNewRecipeForm').addEventListener('click', () => { $('btnCancelRecEdit').click(); $('recipe-editor-container').style.display = 'block'; $('recipe-editor-container').scrollIntoView({ behavior: 'smooth', block: 'start' }); });
  $('btnSaveRec')?.addEventListener('click',async ()=>{
    const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs')?.value?.trim()||null, modo_preparo = $('rec-preparo').value.trim()||null;
    if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
    const newId = crypto.randomUUID();
    const payload = { nome, rendimento_qtd, unidade_rendimento, perda_pct, obs, modo_preparo, codigo_barras: newId, qrcode: newId };
    const {data:ins,error}=await supa.from('receitas').insert(payload).select('id').single(); if(error) return alert(error.message||error);
    if(draftItems.length){ const payload=draftItems.map(d=>({receita_id:ins.id,tipo:d.tipo,ref_id:d.ref_id,qtd:d.qtd,unidade:d.unidade,perda_pct:d.perda_pct})); const {error:err2}=await supa.from('receita_itens').insert(payload); if(err2) alert('Receita salva, erro nos itens: '+(err2.message||err2)); }
    $('btnCancelRecEdit').click(); await loadReceitas(); setStatus('Receita salva','ok');
  });
  $('btnUpdateRec')?.addEventListener('click',async ()=>{ if(!recEditId) return; const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs')?.value?.trim()||null, modo_preparo = $('rec-preparo').value.trim()||null; if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento'); const payload = { nome, rendimento_qtd, unidade_rendimento, perda_pct, obs, modo_preparo }; const {error}=await supa.from('receitas').update(payload).eq('id',recEditId); if(error) return alert(error.message||error); await loadReceitas(); setStatus('Receita atualizada','ok'); });
  $('btnCancelRecEdit').addEventListener('click',()=>{ recEditId=null; $('recipe-editor-container').style.display = 'none'; $('recipe-form-title').textContent = 'Nova Receita'; $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-rend-und').value='g'; $('rec-perda').value='0'; $('rec-obs')&&($('rec-obs').value=''); $('rec-preparo').value=''; $('rec-codigo-barras').value = ''; $('rec-qrcode').value = ''; draftItems = []; renderDraft(); $('btnSaveRec').style.display='inline-flex'; $('btnUpdateRec').style.display='none'; $('btnCancelRecEdit').style.display='inline-flex'; });
  async function loadReceitas(){
    const tb=$('tblRec').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"6\">Carregando…</td></tr>';
    try{ const {data,error}=await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true}); if(error) throw error;
      tb.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td><td>${r.itens}</td><td>${r.ativo?'<span class=\"pill ok\">Ativo</span>':'<span class=\"pill bad\">Inativo</span>'}</td><td class=\"row-actions\"><button class=\"btn small\" data-act=\"edit\" data-id=\"${r.id}\">Editar</button><button class=\"btn small\" data-act=\"toggle\" data-id=\"${r.id}\">${r.ativo?'Desativar':'Ativar'}</button><button class=\"btn small\" data-act=\"del\" data-id=\"${r.id}\">Excluir</button></td>`; tb.appendChild(tr); });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"6\">Crie a view v_receitas_resumo</td></tr>'; }
    await fillOptions('pratos','cp-prato','id','nome',{ativo:true}); await fillOptions('receitas','cp-receita','id','nome',{ativo:true}); 
  }

  /* ===== Ingredientes ===== */
  let ingEditId = null;
  async function loadIngredientes(){
    const tb=$('tblIng').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"5\">Carregando…</td></tr>';
    try{ const {data,error}=await supa.from('ingredientes').select('*').order('nome',{ascending:true}); if(error) throw error;
      tb.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.unidade}</td><td>R$ ${fmt(r.custo_unitario)}</td><td>${r.ativo?'<span class=\"pill ok\">Ativo</span>':'<span class=\"pill bad\">Inativo</span>'}</td><td class=\"row-actions\"><button class=\"btn small\" data-act=\"edit\" data-id=\"${r.id}\">Editar</button><button class=\"btn small\" data-act=\"toggle\" data-id=\"${r.id}\">${r.ativo?'Desativar':'Ativar'}</button><button class=\"btn small\" data-act=\"del\" data-id=\"${r.id}\">Excluir</button></td>`; tb.appendChild(tr); });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"5\">Erro/Tabela não encontrada: ingredientes</td></tr>'; }
  }
  document.querySelector('#tblIng')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('button'); if (!btn) return;
    const { act, id } = btn.dataset;
    if (act === 'toggle') {
      try { const { data: ing } = await supa.from('ingredientes').select('ativo').eq('id', id).single(); if (!ing) throw new Error('Ingrediente não encontrado'); const { error } = await supa.from('ingredientes').update({ ativo: !ing.ativo }).eq('id', id); if (error) throw error; await loadIngredientes(); } catch (ex) { alert(ex.message || ex); }
    } else if (act === 'del') {
      if (!confirm('Excluir ingrediente?')) return;
      try { const { error } = await supa.from('ingredientes').delete().eq('id', id); if (error) throw error; await loadIngredientes(); } catch (ex) { alert(ex.message || ex); }
    } else if (act === 'edit') {
      try { const { data: ing, error } = await supa.from('ingredientes').select('*').eq('id', id).single(); if (error) throw error; if (!ing) return;
        ingEditId = id; $('ing-nome').value = ing.nome || ''; $('ing-und').value = ing.unidade || 'kg'; $('ing-custo').value = ing.custo_unitario || ''; $('ing-obs').value = ing.obs || ''; $('ing-codigo-barras').value = ing.codigo_barras || ''; $('ing-qrcode').value = ing.qrcode || ''; $('btnSaveIng').textContent = 'Salvar Alterações'; $('btnCancelIngEdit').style.display = 'inline-flex'; $('ing-mode-hint').textContent = `Editando: ${ing.nome}`; $('ing-nome').focus();
      } catch (ex) { alert(ex.message || ex); }
    }
  });
  $('btnSaveIng').addEventListener('click', async () => {
    const nome = $('ing-nome').value.trim(); if (!nome) return alert('O nome do ingrediente é obrigatório.');
    const basePayload = { nome, unidade: $('ing-und').value, custo_unitario: ptToNumber($('ing-custo').value), obs: $('ing-obs').value?.trim() || null };
    try {
      if (ingEditId) { const { error } = await supa.from('ingredientes').update(basePayload).eq('id', ingEditId); if (error) throw error; }
      else { const newId = crypto.randomUUID(); const insertPayload = { ...basePayload, codigo_barras:newId, qrcode:newId, ativo: true }; const { error } = await supa.from('ingredientes').insert(insertPayload); if (error) throw error; }
      $('btnCancelIngEdit').click(); await loadIngredientes(); setStatus('Ingrediente salvo.', 'ok');
    } catch (ex) { setStatus('Erro ao salvar ingrediente: ' + (ex.message || ex), 'err'); }
  });
  $('btnCancelIngEdit').addEventListener('click', () => { ingEditId = null; $('ing-nome').value = ''; $('ing-und').value = 'kg'; $('ing-custo').value = ''; $('ing-obs').value = ''; $('ing-codigo-barras').value = ''; $('ing-qrcode').value = ''; $('btnSaveIng').textContent = 'Salvar'; $('btnCancelIngEdit').style.display = 'none'; $('ing-mode-hint').textContent = ''; });

  /* ===== UM (Unidades de Medida) ===== */
  async function loadUM(){
    const tb=$('tblUM').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"7\">Carregando…</td></tr>';
    try {
      const {data,error}=await supa.from('unidades_medida').select('id,sigla,nome,codigo,base,fator,ativo').order('codigo',{ascending:true});
      if(error) throw error;
      tb.innerHTML='';
      (data||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.sigla||''}</td><td>${r.nome||''}</td><td>${r.codigo||''}</td><td>${r.base||''}</td><td>${fmt(r.fator||0)}</td><td>${r.ativo?'<span class=\"pill ok\">Ativo</span>':'<span class=\"pill bad\">Inativo</span>'}</td><td class=\"row-actions\"><button class=\"btn small\" data-act=\"toggle-um\" data-id=\"${r.id}\" data-cur=\"${r.ativo?'1':'0'}\">${r.ativo?'Desativar':'Ativar'}</button><button class=\"btn small\" data-act=\"del-um\" data-id=\"${r.id}\">Excluir</button></td>`;
        tb.appendChild(tr);
      });
      $('um-hint').textContent = `Total: ${(data||[]).length}`;
    } catch(e) {
      tb.innerHTML='<tr><td colspan=\"7\">Crie a tabela public.unidades_medida</td></tr>';
    }
  }
  $('tblUM').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const act=b.dataset.act, id=b.dataset.id;
    if(act==='toggle-um'){ const cur=b.dataset.cur==='1'; try{ const {error}=await supa.from('unidades_medida').update({ativo:!cur}).eq('id',id); if(error) throw error; await loadUM(); }catch(ex){ alert(ex.message||ex); } }
    if(act==='del-um'){ if(!confirm('Excluir unidade de medida?')) return; try{ const {error}=await supa.from('unidades_medida').delete().eq('id',id); if(error) throw error; await loadUM(); }catch(ex){ alert(ex.message||ex); } }
  });
  $('btnSaveUM').addEventListener('click', async()=>{
    const sigla=$('um-sigla').value.trim(); const nome=$('um-nome').value.trim(); const codigo=$('um-codigo').value.trim(); const base=$('um-base').value||null; const fator=ptToNumber($('um-fator').value||'1');
    if(!sigla||!nome||!codigo){ alert('Preencha sigla, nome e código'); return; }
    try { const {error} = await supa.from('unidades_medida').insert({ id:crypto.randomUUID(), sigla, nome, codigo, base, fator, ativo:true }); if(error) throw error; $('um-sigla').value=''; $('um-nome').value=''; $('um-codigo').value=''; $('um-base').value=''; $('um-fator').value=''; await loadUM(); setStatus('Unidade de medida salva.','ok'); }catch(e){ setStatus(e.message||e,'err'); }
  });

  /* ===== UNIDADES destino ===== */
  async function loadUnidades(){
    const tb=$('tblUnidades').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"2\">Carregando…</td></tr>';
    try {
      const {data,error}=await supa.from('unidades').select('id,nome').order('nome',{ascending:true});
      if(error) throw error;
      tb.innerHTML=''; (data||[]).forEach(u=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.nome}</td><td class=\"row-actions\"><button class=\"btn small\" data-act=\"del-uni\" data-id=\"${u.id}\">Excluir</button></td>`; tb.appendChild(tr); });
      // fill work selects
      await fillOptions('unidades','compras-unidade','id','nome');
      await fillOptions('unidades','est-unidade','id','nome');
      await fillOptions('unidades','tr-origem','id','nome');
      await fillOptions('unidades','tr-destino','id','nome');
    } catch(e) { tb.innerHTML='<tr><td colspan=\"2\">Crie a tabela public.unidades</td></tr>'; }
  }
  $('tblUnidades').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='del-uni'){ if(!confirm('Excluir unidade?')) return; try{ const {error}=await supa.from('unidades').delete().eq('id',b.dataset.id); if(error) throw error; await loadUnidades(); }catch(ex){ alert(ex.message||ex); } }
  });
  $('btnSaveUni').addEventListener('click', async()=>{
    const nome=$('uni-nome').value.trim(); if(!nome) { alert('Informe o nome'); return; }
    try{ const {error}=await supa.from('unidades').insert({id:crypto.randomUUID(),nome}); if(error) throw error; $('uni-nome').value=''; $('uni-obs').value=''; await loadUnidades(); setStatus('Unidade salva','ok'); }catch(e){ setStatus(e.message||e,'err'); }
  });

  /* ===== Categorias ===== */
  async function loadCategorias(){
    const tb=$('tblCat').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"4\">Carregando…</td></tr>';
    try {
      const {data,error}=await supa.from('categorias').select('id,nome,tipo,ativo').order('nome',{ascending:true});
      if(error) throw error;
      tb.innerHTML=''; (data||[]).forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td>${c.tipo||''}</td><td>${c.ativo?'<span class=\"pill ok\">Ativo</span>':'<span class=\"pill bad\">Inativo</span>'}</td><td class=\"row-actions\"><button class=\"btn small\" data-act=\"toggle-cat\" data-id=\"${c.id}\" data-cur=\"${c.ativo?'1':'0'}\">${c.ativo?'Desativar':'Ativar'}</button><button class=\"btn small\" data-act=\"del-cat\" data-id=\"${c.id}\">Excluir</button></td>`; tb.appendChild(tr); });
      await fillOptions('categorias','prato-cat','id','nome');
    } catch(e) { tb.innerHTML='<tr><td colspan=\"4\">(Opcional) Crie a tabela public.categorias</td></tr>'; }
  }
  $('tblCat').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const {act,id,cur}=b.dataset;
    if(act==='toggle-cat'){ const active=cur==='1'; try{ const {error}=await supa.from('categorias').update({ativo:!active}).eq('id',id); if(error) throw error; await loadCategorias(); }catch(ex){ alert(ex.message||ex); } }
    if(act==='del-cat'){ if(!confirm('Excluir categoria?')) return; try{ const {error}=await supa.from('categorias').delete().eq('id',id); if(error) throw error; await loadCategorias(); }catch(ex){ alert(ex.message||ex); } }
  });
  $('btnSaveCat').addEventListener('click', async()=>{
    const nome=$('cat-nome').value.trim(); const tipo=$('cat-tipo').value.trim()||null; if(!nome){ alert('Informe nome'); return; }
    try{ const {error}=await supa.from('categorias').insert({id:crypto.randomUUID(),nome,tipo,ativo:true}); if(error) throw error; $('cat-nome').value=''; $('cat-tipo').value=''; await loadCategorias(); setStatus('Categoria salva','ok'); }catch(e){ setStatus(e.message||e,'err'); }
  });

  /* ===== Tipos de Item ===== */
  async function loadTipos(){
    const tb=$('tblTipos').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"4\">Carregando…</td></tr>';
    try {
      const {data,error}=await supa.from('tipos_item').select('id,codigo,nome,ativo').order('codigo',{ascending:true});
      if(error) throw error;
      tb.innerHTML=''; (data||[]).forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.codigo}</td><td>${t.nome}</td><td>${t.ativo?'<span class=\"pill ok\">Ativo</span>':'<span class=\"pill bad\">Inativo</span>'}</td><td class=\"row-actions\"><button class=\"btn small\" data-act=\"toggle-tipo\" data-id=\"${t.id}\" data-cur=\"${t.ativo?'1':'0'}\">${t.ativo?'Desativar':'Ativar'}</button><button class=\"btn small\" data-act=\"del-tipo\" data-id=\"${t.id}\">Excluir</button></td>`; tb.appendChild(tr); });
    } catch(e) { tb.innerHTML='<tr><td colspan=\"4\">(Opcional) Crie a tabela public.tipos_item</td></tr>'; }
  }
  $('tblTipos').addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const {act,id,cur}=b.dataset;
    if(act==='toggle-tipo'){ const active=cur==='1'; try{ const {error}=await supa.from('tipos_item').update({ativo:!active}).eq('id',id); if(error) throw error; await loadTipos(); }catch(ex){ alert(ex.message||ex); } }
    if(act==='del-tipo'){ if(!confirm('Excluir tipo?')) return; try{ const {error}=await supa.from('tipos_item').delete().eq('id',id); if(error) throw error; await loadTipos(); }catch(ex){ alert(ex.message||ex); } }
  });
  $('btnSaveTipo').addEventListener('click', async()=>{
    const codigo=$('tipo-cod').value.trim(); const nome=$('tipo-nome').value.trim(); if(!codigo||!nome){ alert('Informe código e nome'); return; }
    try{ const {error}=await supa.from('tipos_item').insert({id:crypto.randomUUID(),codigo,nome,ativo:true}); if(error) throw error; $('tipo-cod').value=''; $('tipo-nome').value=''; await loadTipos(); setStatus('Tipo salvo','ok'); }catch(e){ setStatus(e.message||e,'err'); }
  });

  /* ===== PRODUÇÃO: funções da sua versão anterior (simplificado) ===== */
  async function preencherCategorias(){
    const sel=$('cat-filter'); sel.innerHTML='';
    try{
      const {data}=await supa.from('pratos').select('categoria').not('categoria','is',null);
      const cats=[...new Set((data||[]).map(x=>x.categoria||'OUTROS'))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
      cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
    }catch(_){}
  }
  async function obterUltimaDataVenda(){
    try{ const {data}=await supa.from('vendas_pratos_view_only_pratos').select('data').order('data',{ascending:false}).limit(1).maybeSingle(); return data?.data || todayStr(); }catch(_){ return todayStr(); }
  }
  async function calcularPrevisaoReal(){
    const win = Math.max(1, +$('win-dias').value||7);
    const proj = Math.max(1, +$('proj-dias').value||7);
    const refReal = await obterUltimaDataVenda();
    $('prev-hint-top').textContent = `Usando como referência: ${refReal} (${weekDayPt(refReal)}).`;
    setStatus('Calculando…','');
    $('th-proj').textContent = `Qtd/Projeção (${proj} dias)`;
    $('th-proj-prato').textContent = `Projeção (${proj} dias)`;
    const fim = new Date(refReal);
    const ini = new Date(refReal); ini.setDate(fim.getDate()-(win-1));
    const isoIni = ini.toISOString().slice(0,10), isoFim = refReal;

    let vendas=[]; try{
      const {data:v,error:errV}=await supa.from('vendas_pratos_view_only_pratos').select('data,prato,quantidade').gte('data',isoIni).lte('data',isoFim);
      if(errV) throw errV; vendas=v||[];
    }catch(_){ vendas=[]; }

    const {data:pratosTbl=[]}=await supa.from('pratos').select('id,nome,categoria');
    const nomeToId = new Map((pratosTbl||[]).map(p=>[p.nome,p.id]));
    const nomeToCat= new Map((pratosTbl||[]).map(p=>[p.nome,p.categoria||'OUTROS']));
    const selCats = new Set(Array.from($('cat-filter').selectedOptions||[]).map(o=>o.value));
    const filtraCat = (pratoNome)=> selCats.size? selCats.has(nomeToCat.get(pratoNome)||'OUTROS') : true;
    const porPrato = new Map();
    (vendas||[]).forEach(v=>{ if(!filtraCat(v.prato)) return; porPrato.set(v.prato,(porPrato.get(v.prato)||0)+(v.quantidade||0)); });
    const mediaPratoDia = new Map([...porPrato.entries()].map(([p,tot])=> [p, tot / win] ));

    const tbResumo=$('tblResumoPratos').querySelector('tbody'); tbResumo.innerHTML='';
    [...mediaPratoDia.entries()].map(([nome,md])=>({nome,cat:nomeToCat.get(nome)||'—', md, proj: md*proj})).sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR')).forEach(r=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.cat}</td><td>${fmt(r.md)}</td><td>${fmt(r.proj)}</td>`; tbResumo.appendChild(tr);
    });
    $('kpi-dias').textContent = String(win); $('kpi-pratos').textContent = String(mediaPratoDia.size);

    // Consolidação por receita (usando prato_receitas)
    const pratoIds = [...mediaPratoDia.keys()].map(n=> nomeToId.get(n)).filter(Boolean);
    let pratoReceitas=[]; if(pratoIds.length){ const {data:prc}=await supa.from('prato_receitas').select('prato_id,receita_id,qtd,unidade').in('prato_id',pratoIds); pratoReceitas = prc||[]; }
    const recTotals = new Map();
    pratoReceitas.forEach(r=>{ const pratoNome = (pratosTbl||[]).find(p=>p.id===r.prato_id)?.nome; if(!mediaPratoDia.has(pratoNome)) return; const mediaDia = mediaPratoDia.get(pratoNome) || 0; const add = mediaDia * (r.qtd||0); const prev = recTotals.get(r.receita_id) || {perDia:0,un:r.unidade||'g'}; prev.perDia += add; prev.un = r.unidade||prev.un; recTotals.set(r.receita_id, prev); });
    $('kpi-rec').textContent = String(recTotals.size);
    const {data:recMetaArr=[]}= await supa.from('receitas').select('id,nome');
    const recMeta = new Map(recMetaArr.map(r=>[r.id,r.nome]));
    const tb=$('tblPrev').querySelector('tbody'); tb.innerHTML='';
    [...recTotals.entries()].map(([id,agg])=>({id, nome: recMeta.get(id) || ('Receita #'+id), un: agg.un, dia: agg.perDia, proj: agg.perDia*proj})).sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR')).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.un}</td><td class=\"nowrap\">${fmt(r.dia)}</td><td class=\"nowrap\">${fmt(r.proj)}</td>`; tb.appendChild(tr); });
    $('prev-hint').textContent = `Janela: ${isoIni} → ${isoFim} (média ${win} dia(s)). Projeção ${proj} dia(s).`;
    setStatus('Pronto','ok');
  }

  /* ===== COMPRAS ===== */
  async function listarSugestoes(unidadeId){
    const tb=$('tblSugestoes').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"6\">Carregando…</td></tr>';
    // tenta mv_sugestoes_compra; se erro, usa vw_lista_compras
    try{
      let sug = null;
      try{
        const { data, error } = await supa.from('mv_sugestoes_compra').select('*').eq('unidade_id', unidadeId);
        if(error) throw error; sug = data||[];
        $('compras-sug-hint').textContent = 'Fonte: mv_sugestoes_compra';
      }catch(_){
        const { data, error } = await supa.from('vw_lista_compras').select('*').eq('unidade_id', unidadeId);
        if(error) throw error; sug = data||[];
        $('compras-sug-hint').textContent = 'Fonte: vw_lista_compras (fallback)';
      }
      tb.innerHTML='';
      (sug||[]).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.fornecedor||'—'}</td><td>${r.item_nome||'(item)'}</td><td>${r.un_medida||''}</td><td class=\"nowrap\">${fmt(r.sugerido_compra||0)}</td><td>${fmt(r.multiplo_compra||1)}</td><td>${fmt(r.qtd_para_comprar||r.sugerido_compra||0)}</td>`;
        tb.appendChild(tr);
      });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"6\">Não foi possível listar. Verifique suas views.</td></tr>'; }
  }
  async function gerarPedido(){
    const unidadeId = $('compras-unidade').value;
    if(!unidadeId){ alert('Selecione a unidade'); return; }
    setStatus('Gerando pedido…','');
    try{
      const { data, error } = await supa.rpc('gerar_pedidos_compra', { p_unidade_id: unidadeId });
      if(error) throw error;
      setStatus('Pedido gerado.','ok');
      await listarPedidos();
    }catch(e){ setStatus('Erro gerar pedido: '+(e.message||e),'err'); }
  }
  async function listarPedidos(){
    const tb=$('tblPedidos').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"5\">Carregando…</td></tr>';
    try{
      const status = $('ped-status').value;
      let q = supa.from('pedido_compra').select('id, fornecedor, total, status').order('ts',{ascending:false});
      if(status) q = q.eq('status', status);
      const {data,error} = await q.limit(100);
      if(error) throw error;
      tb.innerHTML='';
      const sel = $('pedido-sel'); sel.innerHTML='<option value=\"\">Selecione…</option>';
      (data||[]).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${p.id}</td><td>${p.fornecedor||'—'}</td><td class=\"nowrap\">—</td><td>${p.total?('R$ '+fmt(p.total)):''}</td><td>${p.status}</td>`;
        tb.appendChild(tr);
        const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.id} (${p.status})`; sel.appendChild(o);
      });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"5\">Erro ao listar pedidos</td></tr>'; }
  }
  async function listarItensPedido(pedidoId){
    const tb=$('tblPedidoItens').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"6\">Carregando…</td></tr>';
    if(!pedidoId){ tb.innerHTML=''; return; }
    try{
      const {data,error} = await supa.from('pedido_compra_itens').select('*').eq('pedido_id', pedidoId).order('id');
      if(error) throw error;
      tb.innerHTML='';
      (data||[]).forEach(i=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${i.item_id}</td><td>${i.un_medida}</td><td>${fmt(i.qtd_sugerida||0)}</td><td>${fmt(i.qtd_pedida||0)}</td><td>${i.preco_unit?('R$ '+fmt(i.preco_unit)):''}</td><td>${i.subtotal?('R$ '+fmt(i.subtotal)):''}</td>`;
        tb.appendChild(tr);
      });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"6\">Erro ao listar itens</td></tr>'; }
  }
  $('btnGerarPedido').addEventListener('click', gerarPedido);
  $('btnListarPedidos').addEventListener('click', listarPedidos);
  $('pedido-sel').addEventListener('change', e => listarItensPedido(e.target.value));
  $('btnReceberPedido').addEventListener('click', async ()=>{
    const pedidoId = $('pedido-sel').value; const user = $('pedido-user').value||'app'; const preco = ptToNumber($('pedido-preco').value||'0');
    if(!pedidoId){ alert('Selecione o pedido'); return; }
    try{
      const { data, error } = await supa.rpc('receber_pedido_compra', { p_pedido_id: pedidoId, p_usuario: user, p_preco_padrao: preco });
      if(error) throw error;
      setStatus('Pedido recebido.','ok');
      await listarItensPedido(pedidoId); await listarPedidos(); await loadSaldo();
    }catch(e){ setStatus('Erro receber: '+(e.message||e),'err'); }
  });
  $('btnEstornarPedido').addEventListener('click', async ()=>{
    const pedidoId = $('pedido-sel').value; const user = $('pedido-user').value||'app';
    if(!pedidoId){ alert('Selecione o pedido'); return; }
    try{
      const { data, error } = await supa.rpc('estornar_recebimento_pedido', { p_pedido_id: pedidoId, p_usuario: user });
      if(error) throw error;
      setStatus('Estornado.','ok');
      await listarItensPedido(pedidoId); await listarPedidos(); await loadSaldo();
    }catch(e){ setStatus('Erro estornar: '+(e.message||e),'err'); }
  });
  $('btnRefreshAllCompras').addEventListener('click', async ()=>{ const u=$('compras-unidade').value; if(u) await listarSugestoes(u); await listarPedidos(); });

  /* ===== ESTOQUE ===== */
  async function loadSaldo(){
    const tb=$('tblSaldo').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"5\">Carregando…</td></tr>';
    try{
      let data=null;
      try{ const r=await supa.from('vw_estoque_saldos').select('*'); if(r.error) throw r.error; data=r.data||[]; }
      catch(_){ const r=await supa.from('vw_estoque_saldos_resumo').select('*'); if(r.error) throw r.error; data=r.data||[]; }
      tb.innerHTML='';
      (data||[]).forEach(s=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${s.unidade_nome||s.unidade_id}</td><td>${s.item_nome||s.item_id}</td><td>${s.un_medida}</td><td class=\"nowrap\">${fmt(s.saldo||0)}</td><td>${s.status||''}</td>`;
        tb.appendChild(tr);
      });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"5\">Crie vw_estoque_saldos(_resumo)</td></tr>'; }
  }
  async function loadMovs(limit=50){
    const tb=$('tblMovs').querySelector('tbody'); tb.innerHTML='<tr><td colspan=\"7\">Carregando…</td></tr>';
    try{
      const {data,error}=await supa.from('mov_estoque').select('ts,tipo,item_tipo,item_id,qtd,un,un_medida,custo_unit,ref_doc').order('ts',{ascending:false}).limit(limit);
      if(error) throw error; tb.innerHTML='';
      (data||[]).forEach(m=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${new Date(m.ts).toLocaleString('pt-BR')}</td><td>${m.tipo}</td><td>${m.item_tipo}</td><td>${m.item_id}</td><td>${fmt(m.qtd)}</td><td>${m.un_medida||m.un}</td><td>${m.custo_unit?('R$ '+fmt(m.custo_unit)):''}</td><td>${m.ref_doc||''}</td>`;
        tb.appendChild(tr);
      });
    }catch(e){ tb.innerHTML='<tr><td colspan=\"7\">Erro ao listar movimentações</td></tr>'; }
  }
  async function loadItemsFor(tipoSel, selId){
    const map = { 'ING':'ingredientes', 'REC':'receitas', 'PRATO':'pratos' };
    const table = map[tipoSel];
    if(!table){ $(selId).innerHTML='<option value=\"\">—</option>'; return; }
    try{ await fillOptions(table, selId, 'id', 'nome', {ativo:true}); }catch(_){ await fillOptions(table, selId, 'id', 'nome'); }
  }
  $('est-item-tipo').addEventListener('change', async (e)=>{ await loadItemsFor(e.target.value,'est-item'); });
  $('tr-item').addEventListener('focus', async ()=>{ await fillOptions('ingredientes','tr-item','id','nome'); });

  $('btnSalvarMovES').addEventListener('click', async ()=>{
    const unidadeId = $('est-unidade').value; if(!unidadeId){ alert('Selecione a unidade (topo da aba)'); return; }
    const tipo = $('est-tipo-es').value;
    const itemTipo = $('est-item-tipo').value;
    const itemId = $('est-item').value;
    const un = $('est-un').value;
    const qtd = ptToNumber($('est-qtd').value||'0');
    const custo = ptToNumber($('est-custo').value||'0');
    const ref = $('est-ref').value||null;
    const obs = $('est-obs').value||null;
    if(!itemId || !qtd){ alert('Selecione item e informe quantidade'); return; }
    try{
      const payload = { id:crypto.randomUUID(), unidade_id:unidadeId, item_tipo:itemTipo, item_id:itemId, un:un, un_medida:un, qtd:qtd, tipo:tipo, custo_unit:(tipo==='ENTRADA'?custo:null), ts:new Date().toISOString(), usuario:'app', ref_doc:ref, obs:obs };
      const {error} = await supa.from('mov_estoque').insert(payload);
      if(error) throw error;
      $('est-es-msg').textContent = 'Lançamento registrado.';
      await loadSaldo(); await loadMovs();
    }catch(e){ $('est-es-msg').textContent = 'Erro: '+(e.message||e); }
  });
  $('btnTransferir').addEventListener('click', async ()=>{
    const origem=$('tr-origem').value, destino=$('tr-destino').value, item=$('tr-item').value, un=$('tr-un').value, qtd=ptToNumber($('tr-qtd').value||'0'), ref=$('tr-ref').value||null;
    if(!origem||!destino||!item||!qtd){ alert('Preencha origem, destino, item e quantidade'); return; }
    try{
      const ts=new Date().toISOString();
      const base = { item_tipo:'ING', item_id:item, un:un, un_medida:un, qtd:qtd, custo_unit:null, ts, usuario:'app', ref_doc:ref||'TR-'+Date.now(), obs:null };
      const saida = { id:crypto.randomUUID(), unidade_id:origem, tipo:'TRANSFER_SAIDA', ...base };
      const entrada = { id:crypto.randomUUID(), unidade_id:destino, tipo:'TRANSFER_ENTRADA', ...base };
      let r1 = await supa.from('mov_estoque').insert(saida); if(r1.error) throw r1.error;
      let r2 = await supa.from('mov_estoque').insert(entrada); if(r2.error) throw r2.error;
      setStatus('Transferência registrada.','ok'); await loadSaldo(); await loadMovs();
    }catch(e){ setStatus('Erro transferir: '+(e.message||e),'err'); }
  });
  $('btnRefreshEstoque').addEventListener('click', async ()=>{ await loadSaldo(); await loadMovs(); });

  /* ===== INIT ===== */
  async function init(){
    setupRouting();
    try{
      await backfillCodes('pratos'); await backfillCodes('receitas'); await backfillCodes('ingredientes');
    }catch(_){}
    await loadPratos(); await loadReceitas(); await loadIngredientes();
    await loadUM(); await loadUnidades(); await loadCategorias(); await loadTipos();
    await preencherCategorias(); await loadSaldo(); await loadMovs();
    // Compras — carregar sugestões inicial se houver unidade
    const uSel = $('compras-unidade'); const estSel=$('est-unidade');
    setTimeout(async ()=>{
      const u = uSel?.value; if(u) await listarSugestoes(u);
    }, 300);
    uSel?.addEventListener('change', async (e)=>{ if(e.target.value) await listarSugestoes(e.target.value); });
    setStatus('Pronto','ok');
  }
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
