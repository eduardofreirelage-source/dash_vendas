<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pratos & Mapa de Produção</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">MP</text></svg>'/>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--ink:#101828;--muted:#667085;--line:#e7e9ee;--wine:#7b1e3a;--ok:#059669;--bad:#dc2626}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px} h1{margin:0 0 14px;font-size:28px} h2{margin:0 0 12px;font-size:20px}
    .tabs,.subtabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab,.subtab{padding:9px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .tab.active,.subtab.active{background:#eef2f6;font-weight:700}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(16,24,40,.05);margin-bottom:14px}
    .grid{display:grid;gap:12px}.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:repeat(3,1fr)}.cols-4{grid-template-columns:repeat(4,1fr)}
    label{font-size:12px;color:#475569;margin-bottom:6px;display:block}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-height:40px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.pri{background:var(--wine);border-color:var(--wine);color:#fff}.btn.small{padding:7px 10px;font-size:13px}.btn[disabled]{opacity:.6;cursor:not-allowed}
    .right{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 9px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .pill.ok{border-color:#b7f7d2;background:#ecfdf5;color:#065f46}.pill.bad{border-color:#fecaca;background:#fff1f2;color:#991b1b}
    .hint{color:#64748b;font-size:12px}.sep{height:1px;background:var(--line);margin:10px 0}
    table{width:100%;border-collapse:collapse} th,td{border:1px solid var(--line);padding:9px 10px;text-align:left;vertical-align:middle}
    th{background:#f8fafc}.row-actions{display:flex;gap:6px;flex-wrap:wrap}
    details.dash{border:1px dashed #cbd5e1;padding:12px;border-radius:12px;background:#fafbff} summary{cursor:pointer;font-weight:600}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}.kpi .box{background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:12px;min-width:160px}
    .soft{color:#64748b}.nowrap{white-space:nowrap}
    .status{font-size:13px}.status.ok{color:var(--ok)}.status.err{color:var(--bad)}
    @media (max-width:900px){.cols-2,.cols-3,.cols-4{grid-template-columns:1fr}}
  </style>

  <!-- Router para esconder/mostrar se vier via #producao ou #cadastros -->
  <script>
    (function(){
      const onReady = (fn)=> document.readyState!=='loading'?fn():document.addEventListener('DOMContentLoaded',fn);
      function applyHash(){
        const h = (location.hash||'').toLowerCase();
        const tabCadBtn = document.querySelector('.tab[data-tab="tab-pratos"]');
        const tabProBtn = document.querySelector('.tab[data-tab="tab-producao"]');
        const secCad    = document.getElementById('tab-pratos');
        const secPro    = document.getElementById('tab-producao');
        [tabCadBtn, tabProBtn, secCad, secPro].forEach(el=> el && (el.style.display=''));
        if (h.startsWith('#producao')) { if (tabCadBtn) tabCadBtn.style.display='none'; if (secCad) secCad.style.display='none'; if (tabProBtn) tabProBtn.click?.(); }
        if (h.startsWith('#cadastros')){ if (tabProBtn) tabProBtn.style.display='none'; if (secPro) secPro.style.display='none'; if (tabCadBtn) tabCadBtn.click?.(); }
      }
      window.addEventListener('hashchange', applyHash);
      onReady(applyHash);
    })();
  </script>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <h1>Pratos & Mapa de Produção</h1>
    <div id="status" class="status">Carregando…</div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="tab-pratos">Pratos</button>
    <button class="tab" data-tab="tab-producao">Mapa de Produção</button>
  </div>

  <!-- CADASTROS -->
  <div class="section" id="tab-pratos">
    <div class="subtabs">
      <button class="subtab active" data-sub="sub-lista-pratos">Pratos</button>
      <button class="subtab" data-sub="sub-componentes">Componentes de Prato</button>
      <button class="subtab" data-sub="sub-receitas">Receitas</button>
      <button class="subtab" data-sub="sub-ingredientes">Ingredientes</button>
    </div>

    <!-- Sub: PRATOS -->
    <div id="sub-lista-pratos" class="subpage">
      <h2>Pratos</h2>
      <div class="grid cols-2">
        <div><input id="pratos-search" placeholder="Buscar prato cadastrado"></div>
        <div class="right"><button id="btnNovoPrato" class="btn">+ Novo prato</button></div>
      </div>
      <div class="sep"></div>
      <div class="hint">Mostrando até 10 por página</div>
      <div style="overflow:auto">
        <table id="tblPratos"><thead><tr><th>Nome</th><th>Categoria</th><th>Receitas</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="right" style="margin-top:8px;gap:12px">
        <span class="pill" id="pratos-page-info">Página 1/1</span>
        <div class="row-actions">
          <button class="btn small" id="pratos-prev">◀</button>
          <button class="btn small" id="pratos-next">▶</button>
        </div>
      </div>

      <div class="sep"></div>
      <h2 id="prato-form-title">Editar prato</h2>
      <div class="grid cols-4">
        <div><label>Nome</label><input id="prato-nome" placeholder="Ex.: Strogonoff de frango"></div>
        <div><label>Categoria</label><select id="prato-cat"><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMOÇÕES</option><option>OUTROS</option></select></div>
        <div><label>Peso do prato</label><select id="prato-peso-un"><option>g</option><option>ml</option></select><input id="prato-peso" placeholder="Ex.: 500 (g/ml)" style="margin-top:8px"></div>
        <div><label>Preço de venda (fator ou preço)</label><input id="prato-preco" placeholder="Ex.: 3,2 (fator) ou 34,90 (R$)"></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Custo do prato (calculado)</label><input id="prato-custo" disabled placeholder="R$ 0,00"></div>
        <div><label>Última alteração</label><input id="prato-ultima" disabled placeholder="—"></div>
        <div style="align-self:end" class="right"><button id="btnSalvarPrato" class="btn pri">Salvar</button><button id="btnCancelarPrato" class="btn">Cancelar</button></div>
      </div>

      <div class="sep"></div>
      <details class="dash" id="dash-import">
        <summary>Pratos do Dashboard (clique para expandir/ocultar)</summary>
        <div class="grid cols-3" style="margin-top:10px">
          <div><label>Categoria (quando disponível na fonte)</label><select id="dash-cat"><option value="">Sem categoria</option><option>PRATOS</option><option>ACOMPANHAMENTOS</option><option>BEBIDAS</option><option>SOBREMESA</option><option>PROMOÇÕES</option><option>OUTROS</option></select></div>
          <div><label>Buscar no dashboard</label><input id="dash-search" placeholder="Digite para filtrar…"></div>
          <div style="align-self:end" class="right"><button id="btnSyncAll" class="btn">Sincronizar todos que faltam</button></div>
        </div>
        <div style="overflow:auto;margin-top:10px">
          <table id="tblDash"><thead><tr><th>Prato (dashboard)</th><th>Categoria</th><th>Situação</th><th>Ação</th></tr></thead><tbody></tbody></table>
        </div>
      </details>
    </div>

    <!-- Sub: COMPONENTES -->
    <div id="sub-componentes" class="subpage" style="display:none">
      <h2>Componentes do Prato</h2>
      <div class="grid cols-4">
        <div><label>Selecione o prato</label><select id="cp-prato"></select></div>
        <div><label>Receita</label><select id="cp-receita"></select></div>
        <div><label>Qtd por prato</label><input id="cp-qtd" placeholder="Ex.: 220"></div>
        <div><label>Unidade</label><select id="cp-und"><option>g</option><option>ml</option><option>porcao</option></select></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label>Observações</label><input id="cp-obs" placeholder="Opcional"></div>
        <div style="align-self:end" class="right"><button id="btnAddPrComp" class="btn pri">Adicionar Receita ao Prato</button><button id="btnReloadPrComp" class="btn">Recarregar</button></div>
      </div>
      <div class="sep"></div>
      <div style="overflow:auto"><table id="tblPrComp"><thead><tr><th>Receita</th><th>Qtd</th><th>Un</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- Sub: RECEITAS -->
    <div id="sub-receitas" class="subpage" style="display:none">
      <h2>Receitas</h2>
      <div class="grid cols-3">
        <div><label>Nome da receita</label><input id="rec-nome" placeholder="Ex.: Arroz Branco pronto"></div>
        <div><label>Rendimento (quantidade)</label><input id="rec-rend-qtd" placeholder="Ex.: 1000"></div>
        <div><label>Unidade do rendimento</label><select id="rec-rend-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option value="porcao">porção</option></select></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div><label>Perda global (%)</label><input id="rec-perda" value="0"></div>
        <div><label>Observações</label><input id="rec-obs" placeholder="Opcional"></div>
        <div style="align-self:end" class="right"><button id="btnSaveRec" class="btn pri">Salvar NOVA Receita + Itens</button><button id="btnUpdateRec" class="btn" style="display:none">Salvar alterações</button><button id="btnCancelRecEdit" class="btn" style="display:none">Cancelar</button></div>
      </div>
      <div class="sep"></div>
      <div class="pill" style="font-weight:700">Itens da NOVA receita</div>
      <div class="grid cols-4">
        <div><label>Tipo</label><select id="draft-tipo"><option>INGREDIENTE</option><option>RECEITA</option></select></div>
        <div><label>Referência</label><select id="draft-ref"></select></div>
        <div><label>Qtd</label><input id="draft-qtd" placeholder="Ex.: 300"></div>
        <div><label>Unidade</label><select id="draft-und"><option>g</option><option>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label>Perda da linha (%)</label><input id="draft-perda" value="0"></div>
        <div style="align-self:end" class="right"><button id="btnDraftAdd" class="btn">Adicionar à grade</button><button id="btnDraftClear" class="btn">Limpar</button></div>
      </div>
      <div style="overflow:auto;margin-top:8px"><table id="tblDraft"><thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
      <div class="sep"></div>
      <div class="grid cols-2">
        <div><label>Receitas existentes (selecione para editar)</label><select id="ri-receita"></select></div>
        <div style="align-self:end"><span class="pill">Edite o cabeçalho acima e os itens abaixo</span></div>
      </div>
      <div style="overflow:auto;margin-top:8px"><table id="tblRi"><thead><tr><th>Tipo</th><th>Nome</th><th>Qtd</th><th>Un</th><th>Perda%</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
      <div class="sep"></div>
      <div style="overflow:auto"><table id="tblRec"><thead><tr><th>Nome</th><th>Rendimento</th><th>Perda %</th><th>Itens</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- Sub: INGREDIENTES -->
    <div id="sub-ingredientes" class="subpage" style="display:none">
      <h2>Ingredientes</h2>
      <div class="grid cols-3">
        <div><label>Nome</label><input id="ing-nome" placeholder="Ex.: Arroz branco cru"></div>
        <div><label>Unidade</label><select id="ing-und"><option>g</option><option selected>kg</option><option>ml</option><option>L</option><option>un</option></select></div>
        <div><label>Custo unitário</label><input id="ing-custo" placeholder="Ex.: 0,0123"></div>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="cols-2"><label>Observações</label><input id="ing-obs" placeholder="Opcional"></div>
        <div style="align-self:end" class="right"><button id="btnSaveIng" class="btn pri">Salvar ingrediente</button><button id="btnCancelIngEdit" class="btn" style="display:none">Cancelar edição</button></div>
      </div>
      <div id="ing-mode-hint" class="hint"></div>
      <div class="sep"></div>
      <div class="grid cols-2"><div class="pill">Ingredientes cadastrados</div><div class="right"><input id="ing-search" placeholder="Buscar"></div></div>
      <div style="overflow:auto;margin-top:6px"><table id="tblIng"><thead><tr><th>Nome</th><th>Unidade</th><th>Custo</th><th>Ativo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- PRODUÇÃO -->
  <div class="section" id="tab-producao" style="display:none">
    <div class="subtabs">
      <button class="subtab active" data-sub="sub-prev">Previsão</button>
      <button class="subtab" data-sub="sub-compras">Compras</button>
    </div>

    <div id="sub-prev" class="subpage">
      <h2>Mapa de Produção – Previsão</h2>

      <div class="grid cols-4">
        <div>
          <label>Média dos últimos (dias)</label>
          <input id="win-dias" type="number" min="1" step="1" value="7" />
        </div>
        <div>
          <label>Projetar próximos (dias)</label>
          <input id="proj-dias" type="number" min="1" step="1" value="7" />
        </div>
        <div>
          <label>Até (data de referência)</label>
          <input id="ref-data" type="date" />
        </div>
        <div style="align-self:end" class="right">
          <button id="btnCalcularPrev" class="btn pri">Calcular previsão</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="soft">Dias analisados</div><div id="kpi-dias" style="font-weight:700">—</div></div>
        <div class="box"><div class="soft">Pratos considerados</div><div id="kpi-pratos" style="font-weight:700">—</div></div>
        <div class="box"><div class="soft">Receitas consolidadas</div><div id="kpi-rec" style="font-weight:700">—</div></div>
      </div>

      <div class="sep"></div>
      <h3>Produção consolidada por Receita</h3>
      <div style="overflow:auto">
        <table id="tblPrev">
          <thead><tr><th>Receita</th><th>Un</th><th>Qtd/Dia</th><th id="th-proj">Qtd/Projeção</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="right" style="margin-top:8px"><button id="btnExportPrev" class="btn">Exportar PDF</button></div>
      <div class="hint" id="prev-hint"></div>
    </div>

    <div id="sub-compras" class="subpage" style="display:none">
      <h2>Mapa de Produção – Compras (derivado da previsão)</h2>
      <div class="hint">Consolidação de ingredientes baseada nas receitas acima.</div>
      <div class="sep"></div>
      <div style="overflow:auto"><table id="tblCompras"><thead><tr><th>Ingrediente</th><th>Un</th><th>Qtd total/dia</th><th>Observações</th></tr></thead><tbody></tbody></table></div>
      <div class="right" style="margin-top:8px"><button id="btnExportCompras" class="btn">Exportar PDF</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* ===== Helpers ===== */
const $  = (id)=> document.getElementById(id);
const $$ = (sel,root=document)=> Array.from(root.querySelectorAll(sel));
const setStatus=(msg,cls)=>{const el=$('status'); if(!el) return; el.textContent=msg; el.className='status'+(cls?(' '+cls):'');};
const fmt=(n)=> new Intl.NumberFormat('pt-BR',{maximumFractionDigits:3}).format(+n||0);
const ptToNumber=(v)=>{ if(v==null) return 0; const s=String(v).trim().replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
const todayStr=()=> new Date().toISOString().slice(0,10);
const weekDayPt=(iso)=> new Date(iso+'T00:00:00').toLocaleDateString('pt-BR',{weekday:'long'});

/* ===== Supabase ===== */
const SUPABASE_URL  = 'https://rqeagimulvgfecvuzubk.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZWFnaW11bHZnZmVjdnV6dWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzkyMzUsImV4cCI6MjA3MjU1NTIzNX0.SeNHyHOlpqjm-QTl7KXq7YF-48fk5iOQCRgpangP4zU';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== Tabs/Subtabs ===== */
function switchTab(id){ $$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id)); $$('.section').forEach(s=> s.style.display=(s.id===id?'block':'none')); }
function switchSub(id,scope){ $$('.subtab',scope).forEach(s=> s.classList.toggle('active',s.dataset.sub===id)); $$('.subpage',scope.parentElement).forEach(p=> p.style.display=(p.id===id?'block':'none')); }
$$('.tab').forEach(b=> b.addEventListener('click',()=> switchTab(b.dataset.tab)));
$$('#tab-pratos .subtab').forEach(b=> b.addEventListener('click',()=> switchSub(b.dataset.sub,$('tab-pratos'))));
$$('#tab-producao .subtab').forEach(b=> b.addEventListener('click',()=> switchSub(b.dataset.sub,$('tab-producao'))));

/* ===== Estado PRATOS (lista/paginação) ===== */
let pratos=[], pratosPage=1; const PAGE_SIZE=10; let pratoEditId=null;
function renderPratos(){
  const term=$('pratos-search').value?.toLowerCase().trim()||'';
  const filtered=pratos.filter(p=>!term||String(p.nome).toLowerCase().includes(term));
  const totalPages=Math.max(1,Math.ceil(filtered.length/PAGE_SIZE));
  if(pratosPage>totalPages) pratosPage=totalPages;
  const pageItems=filtered.slice((pratosPage-1)*PAGE_SIZE,(pratosPage-1)*PAGE_SIZE+PAGE_SIZE);
  const tb=$('tblPratos').querySelector('tbody'); tb.innerHTML='';
  pageItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.nome}</td><td>${p.categoria||'—'}</td><td>${p.receitas ?? '—'}</td>
      <td>${p.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td>
      <td class="row-actions"><button class="btn small" data-act="edit" data-id="${p.id}">Editar</button>
      <button class="btn small" data-act="toggle" data-id="${p.id}">${p.ativo?'Desativar':'Ativar'}</button>
      <button class="btn small" data-act="del" data-id="${p.id}">Excluir</button></td>`;
    tb.appendChild(tr);
  });
  $('pratos-page-info').textContent=`Página ${pratosPage}/${totalPages}`;
  $('pratos-prev').disabled=pratosPage<=1; $('pratos-next').disabled=pratosPage>=totalPages;
}
$('pratos-prev').addEventListener('click',()=>{ pratosPage=Math.max(1,pratosPage-1); renderPratos(); });
$('pratos-next').addEventListener('click',()=>{ pratosPage=pratosPage+1; renderPratos(); });
$('pratos-search').addEventListener('input',()=>{ pratosPage=1; renderPratos(); });

/* ===== CRUD PRATOS ===== */
$('btnNovoPrato').addEventListener('click',()=>{ pratoEditId=null; $('prato-form-title').textContent='Novo prato'; $('prato-nome').value=''; $('prato-cat').value='PRATOS'; $('prato-peso').value=''; $('prato-peso-un').value='g'; $('prato-preco').value=''; $('prato-custo').value=''; $('prato-ultima').value=''; });
$('btnCancelarPrato').addEventListener('click',()=> $('btnNovoPrato').click());
$('tblPratos').addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id, act=b.dataset.act;
  if(act==='edit'){ const p=pratos.find(x=>String(x.id)===String(id)); if(!p) return; pratoEditId=p.id; $('prato-form-title').textContent='Editar prato'; $('prato-nome').value=p.nome||''; $('prato-cat').value=p.categoria||'PRATOS'; $('prato-peso').value=p.peso??''; $('prato-peso-un').value=p.peso_un||'g'; $('prato-preco').value=p.preco_venda??''; $('prato-custo').value=p.custo??''; $('prato-ultima').value=p.updated_at?new Date(p.updated_at).toLocaleString('pt-BR'):'—'; }
  if(act==='toggle'){ try{ const p=pratos.find(x=>String(x.id)===String(id)); const {error}=await supa.from('pratos').update({ativo:!p.ativo}).eq('id',id); if(error) throw error; await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
  if(act==='del'){ if(!confirm('Excluir prato?')) return; try{ const {error}=await supa.from('pratos').delete().eq('id',id); if(error) throw error; await loadPratos(); }catch(ex){ alert(ex.message||ex); } }
});
$('btnSalvarPrato').addEventListener('click',async ()=>{
  const nome=$('prato-nome').value.trim(); if(!nome){ alert('Informe o nome do prato'); return; }
  const payload={ nome, categoria:$('prato-cat').value, peso:ptToNumber($('prato-peso').value), peso_un:$('prato-peso-un').value, preco_venda:$('prato-preco').value.trim() };
  try{
    if(pratoEditId){ const {error}=await supa.from('pratos').update(payload).eq('id',pratoEditId); if(error) throw error; }
    else{ const {error}=await supa.from('pratos').insert({...payload,ativo:true}); if(error) throw error; }
    await loadPratos(); setStatus('Prato salvo','ok');
  }catch(ex){ setStatus(ex.message||ex,'err'); }
});

/* ===== Import do Dashboard de Pratos ===== */
const DASHBOARD_PRATOS_SOURCE='vendas_pratos_pratos';
async function loadDash(){
  const tb=$('tblDash')?.querySelector('tbody'); if(!tb) return;
  tb.innerHTML='<tr><td colspan="4">Carregando…</td></tr>';
  try{
    let dash=null, err=null; ({data:dash, error:err}=await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato,categoria')); if(err){ ({data:dash, error:err}=await supa.from(DASHBOARD_PRATOS_SOURCE).select('prato')); }
    if(err) throw err;
    const {data:pr}=await supa.from('pratos').select('id,nome'); const exist=new Set((pr||[]).map(p=>p.nome));
    const cat=$('dash-cat').value?.toUpperCase()||''; const term=$('dash-search').value?.toLowerCase().trim()||'';
    tb.innerHTML='';
    (dash||[]).filter(r=> (!cat||String(r.categoria||'').toUpperCase()===cat) && (!term||String(r.prato||'').toLowerCase().includes(term)) )
      .forEach(r=>{
        const already=exist.has(r.prato);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.prato}</td><td>${r.categoria||'<span class="soft">N/D</span>'}</td>
          <td>${already?'<span class="pill">Já existe</span>':'<span class="pill">Falta importar</span>'}</td>
          <td>${already?'-':`<button class="btn small" data-import="${r.prato.replace(/"/g,'&quot;')}" data-cat="${(r.categoria||'PRATOS').replace(/"/g,'&quot;')}">Importar</button>`}</td>`;
        tb.appendChild(tr);
      });
  }catch(e){ tb.innerHTML='<tr><td colspan="4">Não foi possível ler a fonte do dashboard.</td></tr>'; }
}
document.addEventListener('click', e=>{
  const b=e.target.closest('#tblDash button[data-import]'); if(!b) return;
  (async ()=>{
    const {error}=await supa.from('pratos').insert({nome:b.dataset.import,categoria:b.dataset.cat||'PRATOS',ativo:true});
    if(error && !String(error.message||'').includes('duplicate')) return alert(error.message||error);
    await loadPratos(); await loadDash();
  })();
});

/* ===== Componentes de prato ===== */
async function loadPratoCompTable(){
  const prato_id=$('cp-prato').value; const tb=$('tblPrComp').querySelector('tbody'); tb.innerHTML='';
  if(!prato_id) return;
  try{
    const {data, error}=await supa.from('prato_receitas').select('id,receita_id,qtd,unidade').eq('prato_id',prato_id);
    if(error) throw error;
    for(const row of (data||[])){
      const {data:rec}=await supa.from('receitas').select('nome').eq('id',row.receita_id).single();
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${rec?.nome||'(removida)'}</td><td>${fmt(row.qtd)}</td><td>${row.unidade}</td><td class="row-actions"><button class="btn small" data-del="${row.id}">Remover</button></td>`;
      tb.appendChild(tr);
    }
  }catch(ex){ tb.innerHTML='<tr><td colspan="4">Erro ao listar</td></tr>'; }
}
$('cp-prato')?.addEventListener('change',loadPratoCompTable);
$('btnReloadPrComp')?.addEventListener('click',loadPratoCompTable);
$('btnAddPrComp')?.addEventListener('click',async ()=>{
  const prato_id=$('cp-prato').value, receita_id=$('cp-receita').value, qtd=ptToNumber($('cp-qtd').value), unidade=$('cp-und').value, obs=$('cp-obs').value.trim()||null;
  if(!prato_id||!receita_id||!qtd){ return alert('Selecione prato/receita e informe quantidade'); }
  const {error}=await supa.from('prato_receitas').insert({prato_id,receita_id,qtd,unidade,obs});
  if(error && !String(error.message||'').includes('duplicate')) return alert(error.message||error);
  $('cp-qtd').value=''; $('cp-obs').value=''; await loadPratoCompTable();
});
document.addEventListener('click', async e=>{
  const b=e.target.closest('#tblPrComp button[data-del]'); if(!b) return;
  if(!confirm('Remover receita do prato?')) return;
  const {error}=await supa.from('prato_receitas').delete().eq('id',b.dataset.del);
  if(error) return alert(error.message||error);
  await loadPratoCompTable();
});

/* ===== Receitas ===== */
let recEditId=null, draftItems=[];
async function refreshDraftRefs(){ const tipo=$('draft-tipo').value; if(tipo==='INGREDIENTE') await fillOptionsFrom('ingredientes','draft-ref','id','nome',{ativo:true}); else await fillOptionsFrom('receitas','draft-ref','id','nome',{ativo:true}); }
function renderDraft(){ const tb=$('tblDraft').querySelector('tbody'); tb.innerHTML=''; draftItems.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.tipo}</td><td>${it.nome}</td><td>${fmt(it.qtd)}</td><td>${it.unidade}</td><td>${fmt(it.perda_pct)}%</td><td class="row-actions"><button class="btn small" data-rm="${i}">Remover</button></td>`; tb.appendChild(tr); }); }
$('draft-tipo')?.addEventListener('change',refreshDraftRefs);
document.addEventListener('click',e=>{ const b=e.target.closest('#tblDraft button[data-rm]'); if(!b) return; draftItems.splice(+b.dataset.rm,1); renderDraft(); });
$('btnDraftAdd')?.addEventListener('click',async ()=>{ const tipo=$('draft-tipo').value, ref_id=$('draft-ref').value, qtd=ptToNumber($('draft-qtd').value), unidade=$('draft-und').value, perda_pct=ptToNumber($('draft-perda').value); if(!ref_id||!qtd) return alert('Selecione a referência e informe a quantidade'); let nome=''; if(tipo==='INGREDIENTE'){ const {data}=await supa.from('ingredientes').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; } else { const {data}=await supa.from('receitas').select('nome').eq('id',ref_id).single(); nome=data?.nome||''; } draftItems.push({tipo,ref_id,nome,qtd,unidade,perda_pct}); $('draft-qtd').value=''; $('draft-perda').value='0'; renderDraft(); });
$('btnDraftClear')?.addEventListener('click',()=>{ draftItems=[]; renderDraft(); });

$('btnSaveRec')?.addEventListener('click',async ()=>{
  const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null;
  if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento');
  const {data:ins,error}=await supa.from('receitas').insert({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).select('id').single(); if(error) return alert(error.message||error);
  if(draftItems.length){ const payload=draftItems.map(d=>({receita_id:ins.id,tipo:d.tipo,ref_id:d.ref_id,qtd:d.qtd,unidade:d.unidade,perda_pct:d.perda_pct})); const {error:err2}=await supa.from('receita_itens').insert(payload); if(err2) alert('Receita salva, erro ao salvar itens: '+(err2.message||err2)); }
  draftItems=[]; renderDraft(); $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-perda').value='0'; $('rec-obs').value=''; await loadReceitas(); setStatus('Receita salva','ok');
});
$('btnUpdateRec')?.addEventListener('click',async ()=>{ if(!recEditId) return; const nome=$('rec-nome').value.trim(), rendimento_qtd=ptToNumber($('rec-rend-qtd').value), unidade_rendimento=$('rec-rend-und').value, perda_pct=ptToNumber($('rec-perda').value), obs=$('rec-obs').value.trim()||null; if(!nome||!rendimento_qtd) return alert('Informe nome e rendimento'); const {error}=await supa.from('receitas').update({nome,rendimento_qtd,unidade_rendimento,perda_pct,obs}).eq('id',recEditId); if(error) return alert(error.message||error); await loadReceitas(); setStatus('Receita atualizada','ok'); });
$('btnCancelRecEdit')?.addEventListener('click',()=>{ recEditId=null; $('btnSaveRec').style.display='inline-flex'; $('btnUpdateRec').style.display='none'; $('btnCancelRecEdit').style.display='none'; $('rec-nome').value=''; $('rec-rend-qtd').value=''; $('rec-perda').value='0'; $('rec-obs').value=''; });

$('ri-receita')?.addEventListener('change',loadReceitaItensTable);
async function loadReceitaItensTable(){
  const id=$('ri-receita').value; const tb=$('tblRi').querySelector('tbody'); tb.innerHTML=''; if(!id) return;
  const {data, error}=await supa.from('receita_itens').select('*').eq('receita_id',id); if(error) return tb.innerHTML='<tr><td colspan="6">Erro ao listar</td></tr>';
  for(const it of (data||[]).sort((a,b)=>a.tipo.localeCompare(b.tipo))){
    let nome='—'; if(it.tipo==='INGREDIENTE'){ const {data:ing}=await supa.from('ingredientes').select('nome').eq('id',it.ref_id).single(); nome=ing?.nome||'(ingrediente removido)'; } else { const {data:rec}=await supa.from('receitas').select('nome').eq('id',it.ref_id).single(); nome=rec?.nome||'(receita removida)'; }
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.tipo}</td><td>${nome}</td>
      <td><input data-k="qtd" data-id="${it.id}" value="${it.qtd}"></td>
      <td><select data-k="unidade" data-id="${it.id}">${['g','kg','ml','L','un'].map(u=>`<option value="${u}" ${u===it.unidade?'selected':''}>${u}</option>`).join('')}</select></td>
      <td><input data-k="perda_pct" data-id="${it.id}" value="${it.perda_pct||0}"></td>
      <td class="row-actions"><button class="btn small" data-act="save-row" data-id="${it.id}">Salvar</button><button class="btn small" data-act="del" data-id="${it.id}">Remover</button></td>`; tb.appendChild(tr);
  }
}

async function fillOptionsFrom(table, selId, valKey, labelKey, whereEq){
  const sel=$(selId); if(!sel) return; sel.innerHTML='<option value="">Carregando…</option>';
  try{ let q=supa.from(table).select(`${valKey},${labelKey}`).order(labelKey,{ascending:true}); if(whereEq) Object.entries(whereEq).forEach(([k,v])=> q=q.eq(k,v)); const {data,error}=await q; if(error) throw error; sel.innerHTML=''; (data||[]).forEach(x=>{ const o=document.createElement('option'); o.value=x[valKey]; o.textContent=x[labelKey]; sel.appendChild(o); }); }catch(e){ sel.innerHTML='<option value="">(n/d)</option>'; }
}
async function loadReceitas(){
  const tb=$('tblRec').querySelector('tbody'); tb.innerHTML='<tr><td colspan="6">Carregando…</td></tr>';
  try{ const {data,error}=await supa.from('v_receitas_resumo').select('*').order('nome',{ascending:true}); if(error) throw error;
    tb.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${fmt(r.rendimento_qtd)} ${r.unidade_rendimento}</td><td>${fmt(r.perda_pct)}%</td><td>${r.itens}</td><td>${r.ativo?'<span class="pill ok">Ativo</span>':'<span class="pill bad">Inativo</span>'}</td><td class="row-actions"><button class="btn small" data-act="edit" data-id="${r.id}">Editar</button><button class="btn small" data-act="toggle" data-id="${r.id}">${r.ativo?'Desativar':'Ativar'}</button><button class="btn small" data-act="del" data-id="${r.id}">Excluir</button></td>`; tb.appendChild(tr); });
  }catch(e){ tb.innerHTML='<tr><td colspan="6">Crie a view v_receitas_resumo</td></tr>'; }
  await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true}); await fillOptionsFrom('receitas','cp-receita','id','nome',{ativo:true}); await fillOptionsFrom('receitas','ri-receita','id','nome',{ativo:true});
}
document.addEventListener('click',async e=>{
  const tgt=e.target;
  // receitas list actions
  const actBtn=tgt.closest('#tblRec button'); if(!actBtn) return;
});

/* ===== Previsão real: média últimos N dias -> projeção próximos X dias ===== */
function unitCompat(u1,u2){ const g=['g','kg'], ml=['ml','L']; const un=['un','porcao']; const inG=a=>g.includes((a||'').toLowerCase()), inML=a=>ml.includes((a||'').toLowerCase()), inUN=a=>un.includes((a||'').toLowerCase()); return (inG(u1)&&inG(u2))||(inML(u1)&&inML(u2))||(inUN(u1)&&inUN(u2)); }
function toBase(value,unit){ const u=(unit||'').toLowerCase(); if(u==='kg') return {v:value*1000,u:'g'}; if(u==='l') return {v:value*1000,u:'ml'}; return {v:value,u:unit}; }

async function calcularPrevisaoReal(){
  const win = Math.max(1, +$('win-dias').value||7);           // janelinha (média histórica)
  const proj = Math.max(1, +$('proj-dias').value||7);         // quantos dias produzir
  const ref = $('ref-data').value || todayStr();              // data final (inclusiva)

  setStatus('Calculando…',''); 
  const tb=$('tblPrev').querySelector('tbody'); tb.innerHTML='<tr><td colspan="4">Calculando…</td></tr>';
  $('th-proj').textContent = `Qtd/Projeção (${proj} dias)`;

  // intervalo histórico: [ref - (win-1), ref]
  const fim = new Date(ref);
  const ini = new Date(ref); ini.setDate(fim.getDate()-(win-1));
  const isoIni = ini.toISOString().slice(0,10), isoFim = fim.toISOString().slice(0,10);

  // 1) Vendas reais do período histórico
  const {data:vendas,error:errV}=await supa
    .from('vendas_pratos_view_only_pratos')
    .select('data,prato,quantidade')
    .gte('data',isoIni).lte('data',isoFim);

  if(errV){ setStatus('Erro ao ler vendas: '+(errV.message||errV),'err'); return; }

  // Se não tiver vendas, retorna zerado (mas coerente)
  if(!vendas || !vendas.length){
    tb.innerHTML='<tr><td colspan="4">Sem vendas no período de análise.</td></tr>';
    $('kpi-dias').textContent = String(win);
    $('kpi-pratos').textContent='0';
    $('kpi-rec').textContent='0';
    $('prev-hint').textContent = `Média baseada nos últimos ${win} dias (até ${isoFim}). Projeção para ${proj} dia(s).`;
    setStatus('Pronto','ok');
    return;
  }

  // 2) média por prato = total / dias distintos com venda
  const diasDistinct = new Set(vendas.map(v=>v.data)).size || win; // (se der 0, protege com win)
  const porPrato = new Map();
  vendas.forEach(v=> porPrato.set(v.prato, (porPrato.get(v.prato)||0) + (v.quantidade||0)) );
  const mediaPratoDia = new Map([...porPrato.entries()].map(([p,tot])=> [p, tot / diasDistinct] )); // qtd/dia

  // 3) liga prato -> receitas (qtd por prato)
  const {data:pratosTbl}=await supa.from('pratos').select('id,nome');
  const nomeToId = new Map((pratosTbl||[]).map(p=>[p.nome,p.id]));
  const pratoIds = [...mediaPratoDia.keys()].map(n=> nomeToId.get(n)).filter(Boolean);
  let pratoReceitas=[];
  if(pratoIds.length){
    const {data:prc}=await supa.from('prato_receitas').select('prato_id,receita_id,qtd,unidade').in('prato_id',pratoIds);
    pratoReceitas = prc||[];
  }

  // 4) consolida por receita (perDia e projeção)
  const recTotals = new Map(); // receita_id -> {perDia, un}
  pratoReceitas.forEach(r=>{
    const pratoNome = (pratosTbl||[]).find(p=>p.id===r.prato_id)?.nome;
    const mediaDia = mediaPratoDia.get(pratoNome) || 0;          // pratos/dia
    const add = mediaDia * (r.qtd||0);                            // receita por dia
    const prev = recTotals.get(r.receita_id) || {perDia:0,un:r.unidade||'g'};
    prev.perDia += add; prev.un = r.unidade||prev.un; recTotals.set(r.receita_id, prev);
  });

  // 5) metadados da receita
  const recIds=[...recTotals.keys()];
  let receitasMeta=new Map();
  if(recIds.length){
    const {data:recMeta}=await supa.from('receitas').select('id,nome,unidade_rendimento,rendimento_qtd').in('id',recIds);
    receitasMeta = new Map((recMeta||[]).map(r=>[r.id,r]));
  }

  // 6) render
  tb.innerHTML='';
  [...recTotals.entries()]
    .map(([id,agg])=>({id, nome: receitasMeta.get(id)?.nome || ('Receita #'+id), un: agg.un, dia: agg.perDia, proj: agg.perDia*proj}))
    .sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'))
    .forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nome}</td><td>${r.un}</td><td class="nowrap">${fmt(r.dia)}</td><td class="nowrap">${fmt(r.proj)}</td>`;
      tb.appendChild(tr);
    });

  $('kpi-dias').textContent = String(diasDistinct);
  $('kpi-pratos').textContent = String(mediaPratoDia.size);
  $('kpi-rec').textContent = String(recTotals.size);
  $('prev-hint').textContent = `Média baseada nos últimos ${win} dias (até ${isoFim} — ${weekDayPt(isoFim)}). Projeção para ${proj} dia(s).`;
  setStatus('Pronto','ok');

  // 7) compras (baseadas em perDia — mantemos diário; se quiser por janela proj, é só multiplicar depois)
  await calcularCompras(recTotals, receitasMeta);
}

async function calcularCompras(recTotals, receitasMeta){
  const tb=$('tblCompras').querySelector('tbody'); tb.innerHTML='<tr><td colspan="4">Consolidando…</td></tr>';
  const recIds=[...recTotals.keys()]; if(!recIds.length){ tb.innerHTML='<tr><td colspan="4">Sem receitas previstas.</td></tr>'; return; }
  const {data:itens}=await supa.from('receita_itens').select('receita_id,tipo,ref_id,qtd,unidade').in('receita_id',recIds);
  const ingredientes = new Map();

  for(const id of recIds){
    const meta=receitasMeta.get(id); if(!meta) continue;
    const prodDia = recTotals.get(id).perDia;
    const rendQtd = meta.rendimento_qtd || 1;
    const rendUn  = meta.unidade_rendimento || recTotals.get(id).un;
    const rows=(itens||[]).filter(x=>x.receita_id===id && x.tipo==='INGREDIENTE');

    for(const it of rows){
      if(!unitCompat(it.unidade,rendUn)){
        const key=`I${it.ref_id}-??${it.unidade}`;
        const prev=ingredientes.get(key)||{qtdDia:0,un:it.unidade,note:'Verificar unidade (incompatível com rendimento)'};
        ingredientes.set(key,prev); continue;
      }
      const baseItem = toBase(it.qtd, it.unidade);
      const baseRend = toBase(rendQtd, rendUn);
      const fator = baseItem.v / (baseRend.v || 1);
      const baseProd = toBase(prodDia, recTotals.get(id).un);
      if(baseProd.u.toLowerCase()!==baseRend.u.toLowerCase()){
        const key=`I${it.ref_id}-??${it.unidade}`;
        const prev=ingredientes.get(key)||{qtdDia:0,un:it.unidade,note:'Verificar unidade (plano vs rendimento)'}; ingredientes.set(key,prev); continue;
      }
      const needDia = baseProd.v * fator;
      const key=`I${it.ref_id}-${(baseItem.u||it.unidade)}`;
      const prev=ingredientes.get(key)||{qtdDia:0,un:(baseItem.u||it.unidade),note:''};
      prev.qtdDia += needDia; ingredientes.set(key,prev);
    }
  }
  const ingIds=[...ingredientes.keys()].map(k=> +k.split('-')[0].substring(1)).filter(x=>!Number.isNaN(x));
  let nomes=new Map(); if(ingIds.length){ const {data}=await supa.from('ingredientes').select('id,nome'); nomes=new Map((data||[]).map(i=>[i.id,i.nome])); }
  tb.innerHTML='';
  [...ingredientes.entries()].sort((a,b)=> a[0].localeCompare(b[0])).forEach(([key,agg])=>{
    const id=+key.split('-')[0].substring(1); const nome=nomes.get(id)||(`Ingrediente #${id}`);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${nome}</td><td>${agg.un}</td><td class="nowrap">${fmt(agg.qtdDia)}</td><td>${agg.note||''}</td>`; tb.appendChild(tr);
  });
}

/* ===== binds ===== */
document.getElementById('ref-data').value = todayStr();
document.getElementById('btnCalcularPrev').addEventListener('click',calcularPrevisaoReal);
document.getElementById('btnExportPrev').addEventListener('click',()=> alert('Exportar PDF: pronto para integrar.'));
document.getElementById('btnExportCompras').addEventListener('click',()=> alert('Exportar PDF de compras: pronto para integrar.'));

/* ===== loaders ===== */
async function loadPratos(){
  try{
    let data=null,error=null; ({data,error}=await supa.from('v_pratos_resumo').select('*').order('nome',{ascending:true}));
    if(error){ ({data,error}=await supa.from('pratos').select('*').order('nome',{ascending:true})); }
    pratos=data||[]; renderPratos();
    await fillOptionsFrom('pratos','cp-prato','id','nome',{ativo:true});
  }catch(e){ pratos=[]; renderPratos(); setStatus('Não foi possível carregar pratos: '+(e.message||e),'err'); }
}
async function loadReceitas(){ /* já definido acima */ }
async function loadIngredientes(){ /* já definido acima */ }
async function loadDash(){ /* já definido acima (pro import) */ }

async function init(){
  try{
    await loadPratos(); await loadReceitas(); await loadIngredientes(); await loadDash();
    setStatus('Pronto','ok');
  }catch(e){ setStatus(e.message||e,'err'); }
}
document.addEventListener('DOMContentLoaded',init);
</script>

<!-- Hash para sub-abas (#cadastros/receitas etc.) -->
<script>
(function(){
  const CAD = { 'pratos':'sub-lista-pratos','componentes':'sub-componentes','receitas':'sub-receitas','ingredientes':'sub-ingredientes' };
  const PRO = { 'prev':'sub-prev','compras':'sub-compras' };
  const $ = (s,r=document)=>r.querySelector(s);
  const $$= (s,r=document)=>Array.from(r.querySelectorAll(s));
  function go(){
    const h=(location.hash||'').toLowerCase();
    if (h.startsWith('#producao/')){
      const key=h.split('/')[1]||'prev', id=PRO[key]||PRO.prev;
      $$('#tab-producao .subtab').forEach(b=> b.classList.toggle('active', b.dataset.sub===id));
      $$('#tab-producao .subpage').forEach(p=> p.style.display = (p.id===id?'block':'none'));
    }
    if (h.startsWith('#cadastros/')){
      const key=h.split('/')[1]||'pratos', id=CAD[key]||CAD.pratos;
      $$('#tab-pratos .subtab').forEach(b=> b.classList.toggle('active', b.dataset.sub===id));
      $$('#tab-pratos .subpage').forEach(p=> p.style.display = (p.id===id?'block':'none'));
    }
  }
  window.addEventListener('hashchange', go);
  document.addEventListener('DOMContentLoaded', go);
})();
</script>
</body>
</html>
