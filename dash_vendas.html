<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Início — Diagnóstico Supabase (v0)</title>
  <!-- Evita 404 de favicon -->
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --ring:rgba(37,99,235,.35);
      --ok:#16a34a;
      --bad:#dc2626;
      --pill:#eef2ff;
      --pill-text:#4338ca;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font: 15px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    .container{
      max-width:1100px;
      margin:28px auto 80px;
      padding:0 18px;
    }
    h1{font-size:24px;margin:0 0 18px 0}
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1.1fr .9fr;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.1);
      padding:16px;
    }
    .row{display:flex; gap:10px; align-items:center; margin:10px 0}
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0 6px}
    input[type="text"], input[type="password"]{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      outline:0;
      background:#fff;
    }
    input[type="date"]{
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    input:focus{border-color:var(--primary); box-shadow:0 0 0 3px var(--ring)}
    .btn{
      border:0;
      border-radius:10px;
      padding:10px 14px;
      background:var(--primary);
      color:#fff;
      cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{background:#e5e7eb; color:#111827}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .help{color:var(--muted); font-size:12px}
    .pills{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .pill{
      background:var(--pill);
      color:var(--pill-text);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .log{
      background:#0b1020;
      color:#d1d5db;
      border-radius:12px;
      padding:12px;
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      min-height:54px;
    }
    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{padding:10px 12px; border-top:1px solid #eef2f7; text-align:left; font-size:13px}
    thead th{position:sticky; top:0; background:var(--card); z-index:1}
    .ok{color:var(--ok); font-weight:600}
    .bad{color:var(--bad); font-weight:600}
    .section-title{font-size:14px; font-weight:700; margin:4px 0 2px}
    @media (max-width: 950px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Início — Diagnóstico Supabase (v0)</h1>

    <div class="grid">
      <div class="card">
        <div class="section-title">1) Conexão</div>
        <div class="row">
          <div style="flex:2">
            <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
            <input id="projectUrl" type="text" placeholder="https://xxxxx.supabase.co">
          </div>
          <div style="flex:2">
            <label>Anon Key</label>
            <input id="anonKey" type="password" placeholder="ey...">
          </div>
        </div>
        <div class="row">
          <button id="btnTest" class="btn">Testar conexão (OpenAPI)</button>
          <button id="btnList" class="btn secondary">Listar tabelas</button>
          <button id="btnSave" class="btn secondary">Salvar config</button>
          <label style="margin-left:6px; display:flex; align-items:center; gap:6px">
            <input id="onlyPublic" type="checkbox" checked> <span class="help">Somente schema <b>public</b>?</span>
          </label>
        </div>

        <div class="section-title">2) Tabelas detectadas</div>
        <div id="tables" class="pills"></div>

        <div class="section-title">3) Config de leitura</div>
        <div class="row">
          <div style="flex:2">
            <label>Tabela (pode incluir schema; ex.: <code>public.vendas_xlsx</code>)</label>
            <input id="table" type="text" placeholder="ex.: public.vendas_xlsx">
          </div>
          <div style="flex:2">
            <label>Coluna de data (opcional; precisa ser date/timestamp)</label>
            <input id="dateCol" type="text" placeholder="ex.: created_at / data / dt / dh / hora">
          </div>
          <div style="flex:2">
            <label>Coluna de valor (opcional; para totalizar depois)</label>
            <input id="valueCol" type="text" placeholder="ex.: total / valor_total / receita">
          </div>
        </div>

        <div class="row">
          <div style="display:flex; flex-direction:column">
            <label>Início</label>
            <input id="start" type="date">
          </div>
          <div style="display:flex; flex-direction:column">
            <label>Fim</label>
            <input id="end" type="date">
          </div>
        </div>

        <div class="row">
          <button id="btnCount" class="btn">Contar registros (Content-Range)</button>
          <button id="btnSample" class="btn secondary">Carregar amostra (20)</button>
          <button id="btnClear" class="btn secondary">Limpar</button>
        </div>

        <div id="log" class="log">Pronto.</div>
      </div>

      <div class="card">
        <div class="section-title">Amostra de dados</div>
        <div id="sample">—</div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Helpers
  const $ = (sel) => document.querySelector(sel);
  const log = (msg, kind=null) => {
    const el = $("#log");
    const ts = new Date().toTimeString().slice(0,8);
    const line = "["+ts+"] "+msg;
    el.textContent = (el.textContent ? (el.textContent + "\\n") : "") + line;
  };
  const setLoading = (btn, loading) => {
    if(!btn) return;
    btn.disabled = !!loading;
    btn.textContent = loading ? "Aguarde..." : btn.dataset.label;
  };

  // UI elements
  const els = {
    projectUrl: $("#projectUrl"),
    anonKey: $("#anonKey"),
    onlyPublic: $("#onlyPublic"),
    btnTest: $("#btnTest"),
    btnList: $("#btnList"),
    btnSave: $("#btnSave"),
    tables: $("#tables"),
    table: $("#table"),
    dateCol: $("#dateCol"),
    valueCol: $("#valueCol"),
    start: $("#start"),
    end: $("#end"),
    btnCount: $("#btnCount"),
    btnSample: $("#btnSample"),
    btnClear: $("#btnClear"),
    sample: $("#sample"),
  };
  // Label caching for loading states
  [els.btnTest, els.btnList, els.btnSave, els.btnCount, els.btnSample, els.btnClear].forEach(b => { if(b){ b.dataset.label = b.textContent; } });

  // Persist minimal config in localStorage
  const STORAGE_KEY = "diag_supabase_v0";
  function saveLocal(){
    const data = {
      url: els.projectUrl.value.trim(),
      key: els.anonKey.value.trim(),
      only: !!els.onlyPublic.checked,
      table: els.table.value.trim(),
      dateCol: els.dateCol.value.trim(),
      valueCol: els.valueCol.value.trim()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    log("Config salva.");
  }
  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      els.projectUrl.value = d.url||"";
      els.anonKey.value = d.key||"";
      els.onlyPublic.checked = !!d.only;
      els.table.value = d.table||"";
      els.dateCol.value = d.dateCol||"";
      els.valueCol.value = d.valueCol||"";
    }catch(e){}
  }
  loadLocal();

  function headers(){
    const k = els.anonKey.value.trim();
    return {
      apikey: k,
      Authorization: "Bearer " + k,
      "Content-Type": "application/json",
      Prefer: "count=exact"
    };
  }
  function base(){
    const u = els.projectUrl.value.trim().replace(/\/+$/,"");
    if(!u){ throw new Error("Informe a URL do projeto."); }
    return u + "/rest/v1";
  }

  async function fetchOpenAPI(){
    const url = base() + "/";
    const res = await fetch(url, { headers: { ...headers(), Accept: "application/json" }});
    if(!res.ok){
      const txt = await res.text();
      throw new Error("OpenAPI falhou ("+res.status+"). " + txt.slice(0,180));
    }
    const data = await res.json();
    // O retorno costuma ser um objeto com chaves para cada tabela.
    // Vamos extrair nomes, filtrando por schema public se marcado.
    let list = [];
    if(Array.isArray(data)){
      // Algumas instalações retornam array com objetos { name, schema }
      list = data;
    }else if (typeof data === "object"){
      // Supabase geralmente entrega { definitions: { public_tabela: {...}, schema_tabela: {...} } }
      const defs = data.definitions || data.paths || data;
      for(const k in defs){
        // Tentamos isolar "schema.table" quando possível
        const name = k.replace(/^definitions\./,"").replace(/^\/|\/$/g,"");
        list.push({ name });
      }
    }
    // Normaliza nomes
    const uniq = new Set();
    const items = [];
    for(const it of list){
      let n = it.name || it.table_name || it.title || "";
      if(!n) continue;
      n = n.replace(/^public\./,"public.").replace(/^\//,"").replace(/#/g,"");
      // Tenta manter apenas o pedaço final após /
      if(n.includes("/")) n = n.split("/").pop();
      // Remove "public_" prefixo comum do OpenAPI de supabase? (não sempre)
      n = n.replace(/^public\./,"public.");
      if(els.onlyPublic.checked){
        // Se já tem schema, aceita public.*, senão mostramos ambos
        if(n.includes(".")){
          if(!n.startsWith("public.")) continue;
        }
      }
      // Aceita tokens alfanuméricos e underscores/dots
      if(!/^[a-zA-Z0-9_.]+$/.test(n)) continue;
      if(uniq.has(n)) continue;
      uniq.add(n);
      items.push(n);
    }
    items.sort();
    return items;
  }

  function renderTables(items){
    els.tables.innerHTML = "";
    if(!items.length){
      const small = document.createElement("div");
      small.className="help";
      small.textContent = "Nenhuma tabela detectada a partir do OpenAPI. Preencha a tabela manualmente.";
      els.tables.appendChild(small);
      return;
    }
    items.forEach(n => {
      const b = document.createElement("div");
      b.className = "pill";
      b.textContent = n;
      b.title = "Usar \""+n+"\"";
      b.onclick = () => {
        els.table.value = n.includes(".") ? n : (els.onlyPublic.checked ? ("public."+n) : n);
        saveLocal();
      };
      els.tables.appendChild(b);
    });
  }

  async function listTables(){
    setLoading(els.btnList, true);
    try{
      const items = await fetchOpenAPI();
      if(items.length){
        renderTables(items);
        log("OpenAPI OK. "+items.length+" tabelas vistas.");
      }else{
        renderTables([]);
        log("[AVISO] OpenAPI carregado, mas nenhuma tabela foi identificada.");
      }
    }catch(err){
      console.error(err);
      log("[ERRO] "+ err.message);
    }finally{
      setLoading(els.btnList, false);
    }
  }

  async function testConnection(){
    setLoading(els.btnTest, true);
    try{
      const items = await fetchOpenAPI();
      renderTables(items);
      log("OpenAPI carregado. "+items.length+" tabelas.");
    }catch(err){
      console.error(err);
      log("[ERRO] "+ err.message);
    }finally{
      setLoading(els.btnTest, false);
    }
  }

  function makeRangeParams(){
    const col = els.dateCol.value.trim();
    const s = els.start.value;
    const e = els.end.value;
    if(!col || !s || !e) return "";
    try{
      const startIso = s; // YYYY-MM-DD
      // adiciona 1 dia ao fim para usar lt (exclusivo)
      const dt = new Date(e+"T00:00:00");
      dt.setDate(dt.getDate()+1);
      const endIso = dt.toISOString().slice(0,10);
      // para colunas timestamp, acrescentamos T00:00:00
      const isTs = /at|time/i.test(col) || col.toLowerCase().includes("hora") || col.toLowerCase().includes("dh");
      const from = isTs ? (startIso+"T00:00:00") : startIso;
      const to   = isTs ? (endIso  +"T00:00:00") : endIso;
      const params = encodeURIComponent(col)+"=gte."+encodeURIComponent(from) + "&" + encodeURIComponent(col)+"=lt."+encodeURIComponent(to);
      return params;
    }catch{
      return "";
    }
  }

  function ensureTable(){
    let t = els.table.value.trim();
    if(!t){ throw new Error("Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx)."); }
    return t;
  }

  async function countViaHead(){
    setLoading(els.btnCount, true);
    try{
      const t = ensureTable();
      const params = makeRangeParams();
      const url = base()+"/"+encodeURIComponent(t.replace(/^public\./,"public.")) + "?select=id" + (params?("&"+params):"");
      const res = await fetch(url, { method:"HEAD", headers: headers() });
      if(!res.ok){
        throw new Error("Erro no count: HTTP "+res.status);
      }
      const cr = res.headers.get("Content-Range") || res.headers.get("content-range");
      if(!cr){
        log("[AVISO] Sem cabeçalho Content-Range. Verifique 'Prefer: count=exact'.");
        return;
      }
      // content-range formato: 0-0/123 ou */123
      const total = (cr.split("/")[1]||"").trim();
      if(total){
        log("Total via Content-Range: "+ total);
      }else{
        log("Content-Range: "+cr);
      }
    }catch(err){
      console.error(err);
      log("[ERRO] "+ err.message);
    }finally{
      setLoading(els.btnCount, false);
    }
  }

  async function loadSample(){
    setLoading(els.btnSample, true);
    try{
      const t = ensureTable();
      const params = makeRangeParams();
      const url = base()+"/"+encodeURIComponent(t.replace(/^public\./,"public.")) + "?select=*&limit=20" + (params?("&"+params):"");
      const res = await fetch(url, { headers: headers() });
      if(!res.ok){
        const txt = await res.text();
        throw new Error("HTTP "+res.status+" ao carregar amostra. "+txt.slice(0,180));
      }
      const rows = await res.json();
      renderTable(rows);
      log("Amostra carregada ("+rows.length+"). URL: "+url);
    }catch(err){
      console.error(err);
      log("[ERRO] "+ err.message);
    }finally{
      setLoading(els.btnSample, false);
    }
  }

  function renderTable(rows){
    if(!rows || !rows.length){ els.sample.innerHTML="—"; return; }
    const cols = Object.keys(rows[0]);
    let html = "<div style='overflow:auto; max-height:520px'><table><thead><tr>";
    cols.forEach(c => html += "<th>"+escapeHtml(c)+"</th>");
    html += "</tr></thead><tbody>";
    rows.forEach(r => {
      html += "<tr>";
      cols.forEach(c => {
        let v = r[c];
        if(v === null || v === undefined) v = "";
        if(typeof v === "object") v = JSON.stringify(v);
        html += "<td>"+escapeHtml(String(v))+"</td>";
      });
      html += "</tr>";
    });
    html += "</tbody></table></div>";
    els.sample.innerHTML = html;
  }

  function escapeHtml(s){
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");
  }

  function clearAll(){
    els.sample.innerHTML = "—";
    $("#log").textContent = "Pronto.";
  }

  // Wire up
  els.btnTest.addEventListener("click", testConnection);
  els.btnList.addEventListener("click", listTables);
  els.btnSave.addEventListener("click", saveLocal);
  els.btnCount.addEventListener("click", countViaHead);
  els.btnSample.addEventListener("click", loadSample);
  els.btnClear.addEventListener("click", clearAll);

  // Se já houver URL/Key, tenta carregar lista
  if(els.projectUrl.value && els.anonKey.value){
    testConnection().catch(()=>{});
  }
})();
</script>
</body>
</html>
