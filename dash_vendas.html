<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dash de Vendas — Diagnóstico (REST + OpenAPI)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#101828;
      --muted:#667085;
      --border:#e5e7eb;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --ring:#bfdbfe;
      --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:16px 20px;
      font-weight:700;
      font-size:20px;
      border-bottom:1px solid var(--border);
      background:#fff;
      position:sticky;top:0;z-index:10;
    }
    .container{padding:20px;max-width:1200px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      box-shadow: 0 1px 2px rgba(16,24,40,.04);
    }
    h2{font-size:16px;margin:0 0 12px 0}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input[type="text"],input[type="password"],input[type="date"]{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:white;
    }
    input[type="checkbox"]{transform:translateY(1px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:12px}
    .btn{
      background:var(--primary);
      color:#fff;border:0;border-radius:10px;
      padding:10px 14px;font-weight:600;cursor:pointer;font-size:14px;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--border)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{border:1px solid var(--border);background:var(--chip);color:#3730a3;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .chip:hover{filter:brightness(.97)}
    pre{
      background:#0b1220;color:#e5e7eb;border-radius:12px;padding:12px;
      font-size:12px;line-height:1.5;overflow:auto;min-height:72px;
    }
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;padding:8px;color:#0f172a}
    tbody td{border-bottom:1px solid var(--border);padding:8px;color:#111827}
    .muted{color:var(--muted)}
    .inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>Dash de Vendas — <span class="muted">Diagnóstico (REST + OpenAPI)</span></header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <h2>Diagnóstico (REST + OpenAPI)</h2>

        <div class="row">
          <div>
            <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
            <input id="projectUrl" type="text" placeholder="https://xxxx.supabase.co">
            <div class="inline" style="margin-top:6px">
              <input id="onlyPublic" type="checkbox" />
              <label for="onlyPublic" style="margin:0">Somente <code>schema public</code>?</label>
            </div>
          </div>
          <div>
            <label>Anon Key</label>
            <input id="anonKey" type="password" placeholder="ey...">
          </div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button id="btnDiscover" class="btn">Descobrir tabelas e colunas (OpenAPI)</button>
        </div>

        <div id="discoverResult" class="chips" aria-live="polite"></div>

        <div class="row3" style="margin-top:14px">
          <div>
            <label>Tabela de vendas (use <code>schema.tabela</code> se necessário)</label>
            <input id="tableName" type="text" placeholder="ex.: public.vendas_xlsx">
          </div>
          <div>
            <label>Coluna de data</label>
            <input id="dateCol" type="text" placeholder="ex.: dia / data / dt / dh / created_at / hora">
          </div>
          <div>
            <label>Coluna de valor (opcional)</label>
            <input id="valueCol" type="text" placeholder="ex.: total / valor_total / receita">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Coluna de cancelado (opcional)</label>
            <input id="cancelCol" type="text" placeholder="ex.: cancelado / status">
          </div>
          <div class="row" style="gap:8px">
            <div>
              <label>Início</label>
              <input id="start" type="date">
            </div>
            <div>
              <label>Fim</label>
              <input id="end" type="date">
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="btnCount" class="btn secondary">Contar registros (Content-Range)</button>
          <button id="btnSample" class="btn secondary">Carregar amostra</button>
          <button id="btnSave" class="btn">Salvar</button>
        </div>

        <label style="margin-top:12px">Console</label>
        <pre id="log">Pronto.</pre>
        <p class="muted" style="margin-top:8px">
          Dicas: a contagem via HEAD usa <code>?select=id</code> e cabeçalho
          <code>Prefer: count=exact</code>. Se a coluna de data ficar vazia, nenhuma filtragem por período será aplicada.
        </p>
      </section>

      <section class="card">
        <h2>Amostra de dados</h2>
        <div id="tableWrap" class="muted">—</div>
      </section>
    </div>
  </div>

<script>
(() => {
  // ——— Util ———
  const qs = (sel) => document.querySelector(sel);
  const projectUrl = qs('#projectUrl');
  const anonKey    = qs('#anonKey');
  const onlyPublic = qs('#onlyPublic');
  const btnDiscover= qs('#btnDiscover');
  const tableName  = qs('#tableName');
  const dateCol    = qs('#dateCol');
  const valueCol   = qs('#valueCol');
  const cancelCol  = qs('#cancelCol');
  const startInput = qs('#start');
  const endInput   = qs('#end');
  const btnCount   = qs('#btnCount');
  const btnSample  = qs('#btnSample');
  const btnSave    = qs('#btnSave');
  const logEl      = qs('#log');
  const chipsEl    = qs('#discoverResult');
  const tableWrap  = qs('#tableWrap');

  function log(msg){
    const now = new Date();
    const stamp = now.toTimeString().slice(0,8);
    logEl.textContent += `\\n[${stamp}] ${msg}`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setLog(msg){
    logEl.textContent = msg;
  }
  function cleanBase(url){
    return url.replace(/\\/*$/,"");
  }
  function toISODate(d){ // expects yyyy-mm-dd or empty
    if(!d) return null;
    const m = /^(\\d{4})-(\\d{2})-(\\d{2})$/.exec(d);
    return m ? `${m[1]}-${m[2]}-${m[3]}` : null;
  }

  function saveConfig(){
    const cfg = {
      projectUrl: projectUrl.value.trim(),
      anonKey: anonKey.value.trim(),
      onlyPublic: !!onlyPublic.checked,
      table: tableName.value.trim(),
      dateCol: dateCol.value.trim(),
      valueCol: valueCol.value.trim(),
      cancelCol: cancelCol.value.trim(),
      start: startInput.value,
      end: endInput.value
    };
    localStorage.setItem('dv_cfg', JSON.stringify(cfg));
    log('Config salva.');
  }

  function loadConfig(){
    try{
      const raw = localStorage.getItem('dv_cfg');
      if(!raw) return;
      const cfg = JSON.parse(raw);
      projectUrl.value = cfg.projectUrl || '';
      anonKey.value    = cfg.anonKey || '';
      onlyPublic.checked = !!cfg.onlyPublic;
      tableName.value  = cfg.table || '';
      dateCol.value    = cfg.dateCol || '';
      valueCol.value   = cfg.valueCol || '';
      cancelCol.value  = cfg.cancelCol || '';
      startInput.value = cfg.start || '';
      endInput.value   = cfg.end || '';
    }catch(e){
      console.warn(e);
    }
  }
  loadConfig();

  function headers(){
    const key = anonKey.value.trim();
    return {
      'apikey': key,
      'Authorization': 'Bearer ' + key
    };
  }

  // ——— OpenAPI discovery ———
  btnDiscover.addEventListener('click', async () => {
    chipsEl.innerHTML = '';
    tableWrap.innerHTML = '—';
    setLog('Buscando OpenAPI…');

    const base = cleanBase(projectUrl.value.trim());
    if(!base){ setLog('Informe o Project URL.'); return; }

    const url = `${base}/rest/v1/`;
    try{
      const res = await fetch(url, {
        method: 'GET',
        headers: {
          ...headers(),
          'Accept': 'application/openapi+json'
        }
      });
      if(!res.ok){
        setLog(`OpenAPI falhou: HTTP ${res.status}`);
        return;
      }
      const spec = await res.json();
      // Extrai nomes de tabelas/visões a partir de paths simples "/tabela"
      const found = new Set();
      for(const p in spec.paths){
        // pega somente caminhos do tipo "/nome" (sem /rpc, sem /bucket etc)
        if (!/^\\/[a-zA-Z0-9_]+$/.test(p)) continue;
        const name = p.slice(1);
        if(onlyPublic.checked){
          // se o usuário marcou "somente public", esconda o que parece schema prefixado
          if(name.includes('.')){
            if(name.startsWith('public.')) found.add(name);
          }else{
            // pode ser que a API exponha sem schema — mostramos assim mesmo
            found.add(name);
          }
        }else{
          found.add(name);
        }
      }

      const list = Array.from(found).sort((a,b)=>a.localeCompare(b));
      if(list.length===0){
        setLog('OpenAPI carregado. 0 tabelas.');
      }else{
        setLog(`OpenAPI OK. ${list.length} tabelas vistas.`);
      }
      // Render chips
      for(const t of list){
        const div = document.createElement('button');
        div.className = 'chip';
        div.type = 'button';
        div.textContent = t;
        div.addEventListener('click', () => { tableName.value = t; });
        chipsEl.appendChild(div);
      }
    }catch(err){
      console.error(err);
      setLog('Erro ao buscar OpenAPI: ' + (err?.message || err));
    }
  });

  // ——— Query helpers ———
  function buildFilterParams(dateColumn){
    const params = new URLSearchParams({ select: 'id' });
    const s = toISODate(startInput.value);
    const e = toISODate(endInput.value);
    if(dateColumn && s && e){
      params.append(dateColumn, `gte.${s}`);
      // Supabase filtra com lt (exclusive) — se quiser inclusivo, some 1 dia
      params.append(dateColumn, `lt.${e}`);
    }
    return params;
  }

  async function countRows(){
    const base = cleanBase(projectUrl.value.trim());
    const table = tableName.value.trim();
    if(!base || !anonKey.value.trim()){ setLog('Informe URL e Anon Key.'); return; }
    if(!table){ setLog('Informe a tabela.'); return; }

    const dateColumn = dateCol.value.trim() || '';
    const params = buildFilterParams(dateColumn);
    const url = `${base}/rest/v1/${encodeURIComponent(table)}?${params.toString()}`;

    setLog('Contando via HEAD…');
    try{
      const res = await fetch(url, {
        method: 'HEAD',
        headers: {
          ...headers(),
          'Prefer': 'count=exact',
          'Range': '0-0'
        }
      });
      if(res.ok){
        const cr = res.headers.get('Content-Range') || '';
        const total = (cr.split('/')[1]) || '?';
        log(`Total via Content-Range: ${total}`);
        return;
      }else{
        log(`HEAD falhou (${res.status}). Tentando GET para contar…`);
      }
    }catch(e){
      log('HEAD falhou: ' + (e?.message || e));
    }

    // Fallback: GET com range mínimo
    try{
      const res2 = await fetch(url, {
        method: 'GET',
        headers: {
          ...headers(),
          'Prefer': 'count=exact',
          'Range': '0-0'
        }
      });
      const cr2 = res2.headers.get('Content-Range') || '';
      const total2 = (cr2.split('/')[1]) || (res2.ok ? '>=1' : '?');
      log(`Total (fallback): ${total2} — HTTP ${res2.status}`);
    }catch(e){
      log('GET fallback falhou: ' + (e?.message || e));
    }
  }

  async function loadSample(){
    const base = cleanBase(projectUrl.value.trim());
    const table = tableName.value.trim();
    if(!base || !anonKey.value.trim()){ setLog('Informe URL e Anon Key.'); return; }
    if(!table){ setLog('Informe a tabela.'); return; }

    const dateColumn = dateCol.value.trim() || '';
    const params = new URLSearchParams();
    params.set('select', '*');
    params.set('limit', '50');
    if(dateColumn){
      const s = toISODate(startInput.value);
      const e = toISODate(endInput.value);
      if(s && e){
        params.append(dateColumn, `gte.${s}`);
        params.append(dateColumn, `lt.${e}`);
        params.set('order', `${dateColumn}.asc`);
      }else{
        params.set('order', `${dateColumn}.asc`);
      }
    }else{
      params.set('order', 'id.asc');
    }

    const url = `${base}/rest/v1/${encodeURIComponent(table)}?${params.toString()}`;
    setLog('Carregando amostra…');
    try{
      const res = await fetch(url, { headers: headers() });
      if(!res.ok){
        const txt = await res.text();
        setLog(`Erro na amostra: HTTP ${res.status}\\n${txt}`);
        return;
      }
      const data = await res.json();
      renderTable(data);
      log(`Amostra carregada: ${data.length} linhas.`);
    }catch(e){
      setLog('Erro na amostra: ' + (e?.message || e));
    }
  }

  // ——— Render ———
  function renderTable(rows){
    if(!rows || rows.length===0){
      tableWrap.innerHTML = '<div class="muted">Sem dados para exibir.</div>';
      return;
    }
    const cols = Array.from(rows.reduce((acc, r) => {
      Object.keys(r).forEach(k => acc.add(k));
      return acc;
    }, new Set()));
    const thead = '<thead><tr>' + cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + rows.map(r => {
      return '<tr>' + cols.map(c => `<td>${escapeHtml(fmt(r[c]))}</td>`).join('') + '</tr>';
    }).join('') + '</tbody>';
    tableWrap.innerHTML = `<div style="overflow:auto;max-height:520px;border:1px solid var(--border);border-radius:10px">
      <table>${thead}${tbody}</table></div>`;
  }

  function fmt(v){
    if(v==null) return '—';
    if(typeof v === 'number'){
      return Number.isInteger(v) ? v.toString() : v.toFixed(2);
    }
    if(typeof v === 'string'){
      // Mostra só começo de strings longas
      return v.length>180 ? v.slice(0,180)+'…' : v;
    }
    try{ return JSON.stringify(v); }catch{ return String(v); }
  }
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // ——— Bindings ———
  btnCount.addEventListener('click', countRows);
  btnSample.addEventListener('click', loadSample);
  btnSave.addEventListener('click', saveConfig);

  // Preenche datas padrão (últimos 30 dias)
  if(!startInput.value || !endInput.value){
    const today = new Date();
    const end = today.toISOString().slice(0,10);
    const past = new Date(today.getTime() - 30*86400*1000).toISOString().slice(0,10);
    startInput.value = past;
    endInput.value = end;
  }
})();</script>
</body>
</html>
