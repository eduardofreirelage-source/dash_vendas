<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Dash Vendas — Diagnóstico (ES5, sem limite)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:0;color:#111827;background:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .toolbar label{font-size:12px;color:#6b7280;margin-right:4px}
    .toolbar input,.toolbar select{padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;background:#fff}
    .tabs{display:flex;gap:8px;margin:8px 0 16px}
    .tab-btn{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#f3f4f6;cursor:pointer}
    .tab-btn.active{background:#111827;color:#fff;border-color:#111827}
    .tab{display:none}
    .tab.active{display:block}
    .hero{display:flex;gap:16px;align-items:baseline;flex-wrap:wrap;margin:12px 0 8px}
    .hero-value-number{font-size:32px;font-weight:800}
    .delta{font-size:14px;padding:2px 6px;border-radius:6px;border:1px solid #e5e7eb;background:#f9fafb}
    .delta.up{color:#065f46;border-color:#a7f3d0;background:#ecfdf5}
    .delta.down{color:#991b1b;border-color:#fecaca;background:#fef2f2}
    .hero-sub-value{color:#6b7280;margin-left:8px}
    .hero-context{margin-top:6px;color:#374151}
    .section{margin-top:16px;padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .card{padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:white}
    .muted{color:#6b7280}
    .ins-list{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .ins-card{grid-column:span 6;display:flex;gap:8px;align-items:flex-start;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .ins-card .dot{width:10px;height:10px;border-radius:50%;margin-top:4px;background:#9ca3af}
    .ins-card.up .dot{background:#10b981}
    .ins-card.down .dot{background:#ef4444}
    .proj{display:flex;gap:16px;flex-wrap:wrap}
    .proj-kpi-sub{display:flex;gap:16px}
    .proj-value{font-weight:700}
    .proj-value-small{font-weight:600}
    /* simples placeholder p/ outros gráficos/áreas do seu dash */
    .placeholder{padding:24px;border:1px dashed #d1d5db;border-radius:10px;color:#6b7280;text-align:center}
  </style>

  <!-- Credenciais Supabase (as que você forneceu) -->
  <script>
    window.SUPABASE_URL = "https://msmyfxgrnuusnvoqyeuo.supabase.co";
    window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U";
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Dash de Vendas</h1>

    <!-- Filtros "rápidos" com os mesmos IDs que você usa -->
    <div class="toolbar">
      <div>
        <label for="fxDuStart">Início</label>
        <input id="fxDuStart" type="date"/>
      </div>
      <div>
        <label for="fxDuEnd">Fim</label>
        <input id="fxDuEnd" type="date"/>
      </div>
      <div>
        <label for="fxCanceled">Cancelado</label>
        <select id="fxCanceled">
          <option value="">Todos</option>
          <option value="sim">Somente cancelados</option>
          <option value="nao">Somente válidos</option>
        </select>
      </div>
      <div>
        <label for="kpi-select">KPI</label>
        <select id="kpi-select">
          <option value="fat">Faturamento</option>
          <option value="ped">Pedidos</option>
          <option value="tkt">Ticket Médio</option>
          <option value="des">Desconto (R$)</option>
          <option value="desperc">% Desconto</option>
          <option value="fre">Frete (R$)</option>
          <option value="canc_ped">Cancelados (qtd)</option>
          <option value="canc_val">Cancelados (R$)</option>
          <option value="roi">ROI</option>
        </select>
      </div>
    </div>

    <!-- Abas (uma placeholder e a de Diagnóstico) -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="principal">Principal</button>
      <button class="tab-btn" data-tab="diagnostico">Diagnóstico</button>
    </div>

    <div id="tab-principal" class="tab active">
      <div class="placeholder">Sua página/visão principal entra aqui (mantida intacta no seu projeto).</div>
    </div>

    <div id="tab-diagnostico" class="tab">
      <div class="hero">
        <div class="hero-value-number">—</div>
        <div class="delta">—</div>
        <div class="hero-sub-value muted">Período anterior: —</div>
      </div>
      <div class="hero-context muted">—</div>

      <div class="section">
        <div class="grid">
          <div class="card" style="grid-column:span 12">
            <div class="muted" style="margin-bottom:6px">Insights</div>
            <div class="ins-list">
              <div class="ins-card"><div class="dot"></div><div>
                <div class="ins-title">—</div>
                <div class="ins-sub muted">—</div>
                <div class="ins-action muted">—</div>
              </div></div>
            </div>
          </div>
          <div class="card" style="grid-column:span 12">
            <div class="muted" style="margin-bottom:6px">Projeções</div>
            <div class="proj">
              <div>Próx. 30d: <span class="proj-value">—</span></div>
              <div class="proj-kpi-sub">
                <div class="sub-kpi">Pedidos: <span class="proj-value-small">—</span></div>
                <div class="sub-kpi">Ticket: <span class="proj-value-small">—</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>

  <script>
    // Simples comutação de abas
    (function(){
      var btns = document.querySelectorAll('.tab-btn');
      for (var i=0;i<btns.length;i++){
        btns[i].addEventListener('click', function(e){
          var t = e.currentTarget.getAttribute('data-tab');
          var all = document.querySelectorAll('.tab-btn'); for (var j=0;j<all.length;j++) all[j].classList.remove('active');
          e.currentTarget.classList.add('active');
          var tabs = document.querySelectorAll('.tab'); for (var k=0;k<tabs.length;k++) tabs[k].classList.remove('active');
          var el = document.getElementById('tab-'+t); if (el) el.classList.add('active');
        });
      }
      // datas padrão (últimos 30 dias)
      var end = new Date(); var start = new Date(end); start.setDate(end.getDate()-30);
      var pad = function(n){ return (n<10?'0':'')+n; };
      var iso = function(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); };
      var fxA = document.getElementById('fxDuStart'), fxB = document.getElementById('fxDuEnd');
      if (fxA && fxB && !fxA.value && !fxB.value){ fxA.value = iso(start); fxB.value = iso(end); }
    })();
  </script>

  <!-- ====== CORE DIAGNÓSTICO (ES5, compatível) ====== -->
  <script>
  (function(){
    'use strict';

    // Polyfill de datas — computePrevRangeISO
    if (!window.DateHelpers || typeof window.DateHelpers.computePrevRangeISO !== 'function') {
      window.DateHelpers = window.DateHelpers || {};
      window.DateHelpers.computePrevRangeISO = function(deISO, ateISO){
        try{
          var de = new Date(deISO+'T00:00:00');
          var ate = new Date(ateISO+'T00:00:00');
          var span = ate - de;
          var prevEnd = new Date(de.getTime()-86400000);
          var prevStart = new Date(prevEnd.getTime()-span);
          return { dePrev: prevStart.toISOString().slice(0,10), atePrev: prevEnd.toISOString().slice(0,10) };
        }catch(e){
          var end=new Date(); var start=new Date(end); start.setDate(end.getDate()-30);
          var prevEnd2=new Date(start); prevEnd2.setDate(start.getDate()-1);
          var prevStart2=new Date(prevEnd2); prevStart2.setDate(prevEnd2.getDate()-30);
          return { dePrev: prevStart2.toISOString().slice(0,10), atePrev: prevEnd2.toISOString().slice(0,10) };
        }
      };
    }

    // Helpers
    function $(s){ return document.querySelector(s); }
    function safeGet(obj, path){ try{ for(var i=0;i<path.length;i++){ if(!obj) return null; obj=obj[path[i]]; } return obj; }catch(e){ return null; } }
    function norm(s){ return (s||'').toLowerCase(); }

    // Agregações
    function agg(rows){
      var byDay={}, byStore={}, byHour={}, byCanal={};
      var canc_val=0, canc_ped=0;
      for (var i=0;i<(rows||[]).length;i++){
        var r = rows[i];
        var dia=r.dia;
        var loja=r.loja||'—';
        var h = (r.hora==null? '—' : String(r.hora)); if (h.length===1) h='0'+h;
        var canal=r.canal||'—';
        var fat=+r.fat||0, des=+r.des||0, fre=+r.fre||0;
        if(!byDay[dia]) byDay[dia]={fat:0,des:0,fre:0,ped:0};
        byDay[dia].fat+=fat; byDay[dia].des+=des; byDay[dia].fre+=fre; byDay[dia].ped+=1;
        if(!byStore[loja]) byStore[loja]={fat:0,des:0,fre:0,ped:0};
        byStore[loja].fat+=fat; byStore[loja].des+=des; byStore[loja].fre+=fre; byStore[loja].ped+=1;
        if(!byHour[h]) byHour[h]={fat:0,des:0,fre:0,ped:0};
        byHour[h].fat+=fat; byHour[h].des+=des; byHour[h].fre+=fre; byHour[h].ped+=1;
        if(!byCanal[canal]) byCanal[canal]={fat:0,des:0,fre:0,ped:0};
        byCanal[canal].fat+=fat; byCanal[canal].des+=des; byCanal[canal].fre+=fre; byCanal[canal].ped+=1;
        if (String(r.cancelado)==='Sim'){ canc_ped+=1; canc_val+=fat; }
      }
      var dias=0; for (var k in byDay) if (byDay.hasOwnProperty(k)) dias++;
      var tot={fat:0,des:0,fre:0,ped:0,dias:dias,canc_ped:canc_ped,canc_val:canc_val};
      for (var d in byDay){ if(!byDay.hasOwnProperty(d)) continue; tot.fat+=byDay[d].fat; tot.des+=byDay[d].des; tot.fre+=byDay[d].fre; tot.ped+=byDay[d].ped; }
      return {byDay:byDay, byStore:byStore, byHour:byHour, byCanal:byCanal, tot:tot};
    }

    function valBy(key, a){
      if (key==='fat') return a.fat;
      if (key==='des') return a.des;
      if (key==='fre') return a.fre;
      if (key==='ped') return a.ped;
      if (key==='tkt') return (a.ped>0? a.fat/a.ped:0);
      if (key==='fatmed') return (a.dias>0? a.fat/a.dias:0);
      if (key==='fremed') return (a.ped>0? a.fre/a.ped:0);
      if (key==='desperc') return (a.fat>0? a.des/a.fat:0);
      if (key==='canc_ped') return a.canc_ped||0;
      if (key==='canc_val') return a.canc_val||0;
      if (key==='roi') return (a.des>0? (a.fat-a.des)/a.des: NaN);
      return 0;
    }

    function fmt(key, v){
      var fmtHint = (window.KPI_META && window.KPI_META[key] && window.KPI_META[key].fmt) ? window.KPI_META[key].fmt : null;
      var m;
      if (fmtHint) m = fmtHint;
      else {
        if (key==='ped' || key==='canc_ped') m='count';
        else if (key==='desperc' || key==='roi') m='percent';
        else m='money';
      }
      if (m==='money')   return isFinite(v)? ('R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})):'—';
      if (m==='count')   return isFinite(v)? (+v).toLocaleString('pt-BR'):'—';
      if (m==='percent') return isFinite(v)? ((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%':'—';
      return String(v);
    }

    function delta(now, prev){
      if(!isFinite(prev)||prev===0) return {txt:'—',cls:'flat'};
      var p=((now-prev)/prev)*100;
      return {txt:(p>=0?'▲ ':'▼ ')+Math.abs(p).toFixed(1)+'%', cls:(p>=0?'up':'down')};
    }

    function topN(mapObj, key, n){
      var arr=[], k;
      for (k in mapObj){ if(!mapObj.hasOwnProperty(k)) continue;
        var v = mapObj[k];
        var sortVal = (key==='ped'? v.ped : (key==='tkt'? (v.ped? v.fat/v.ped:0): v.fat));
        arr.push({name:k, val:sortVal});
      }
      arr.sort(function(a,b){ return (b.val||0)-(a.val||0); });
      var out=[];
      for (var i=0;i<Math.min(n,arr.length);i++) out.push(arr[i].name);
      return out;
    }

    function selectedKey(){
      var sel = $('#kpi-select');
      var raw = sel ? (sel.value || sel.getAttribute('data-value')) : '';
      if (!raw && sel && sel.options && sel.selectedIndex>=0){
        var opt = sel.options[sel.selectedIndex];
        raw = (opt.value || opt.text || '').trim();
      }
      var s = norm(raw);
      if (window.KPI_META && window.KPI_META[raw]) return raw;
      if (s.indexOf('fat')>-1) return 'fat';
      if (s.indexOf('ped')>-1 || s.indexOf('pedido')>-1) return 'ped';
      if (s.indexOf('ticket')>-1 || s==='tkt') return 'tkt';
      if (s.indexOf('frete')>-1 || s==='fre') return 'fre';
      if (s.indexOf('desc')>-1 || s==='des') return 'des';
      if (s.indexOf('%')>-1 || s.indexOf('perc')>-1) return 'desperc';
      if (s.indexOf('roi')>-1) return 'roi';
      if (s.indexOf('cancel')>-1 && s.indexOf('pedido')>-1) return 'canc_ped';
      if (s.indexOf('cancel')>-1 && s.indexOf('valor')>-1) return 'canc_val';
      return 'fat';
    }

    function uiDates(){
      var a = $('#fxDuStart') ? $('#fxDuStart').value : null;
      var b = $('#fxDuEnd') ? $('#fxDuEnd').value : null;
      if(!a || !b) return null;
      var start = (b>=a)? a : b;
      var end   = (b>=a)? b : a;
      return {start:start, end:end};
    }

    // ===== REST paginado (chunks de 50k) + HEAD count =====
    function hasCreds(){ return !!(window.SUPABASE_URL && window.SUPABASE_KEY); }

    function dxFetchRESTPaged(de, ate, anal, cb){
      if (!hasCreds()){ cb(null, []); return; }
      var URL = window.SUPABASE_URL, KEY = window.SUPABASE_KEY;
      var base = URL + '/rest/v1/vendas_canon';
      var qs = [
        'select=dia,hora,loja,canal,fat,des,fre,cancelado',
        'dia=gte.'+encodeURIComponent(de),
        'dia=lte.'+encodeURIComponent(ate),
        'order=dia.asc,hora.asc'
      ];
      try{
        if (anal && anal.cancelado==='sim') qs.push('cancelado=eq.Sim');
        if (anal && anal.cancelado==='nao') qs.push('cancelado=neq.Sim');
      }catch(e){}
      var url = base + '?' + qs.join('&');
      var KEYH = { apikey: window.SUPABASE_KEY, Authorization: 'Bearer '+window.SUPABASE_KEY, 'Range-Unit': 'items', Range: '0-49999', Prefer: 'count=exact' };
      var chunk = 50000, start = 0, rows = [], pages = 0, maxPages = 200;

      function step(){
        KEYH.Range = String(start) + '-' + String(start + chunk - 1);
        return fetch(url, { headers: KEYH }).then(function(r){
          if (!r.ok){ cb(null, rows); return; }
          var cr = r.headers && r.headers.get ? r.headers.get('content-range') : null;
          return r.json().then(function(data){
            var got = (data && data.length) ? data.length : 0;
            for (var i=0;i<got;i++) rows.push(data[i]);
            pages += 1; start += chunk;
            var total = null;
            if (cr){ var parts = cr.split('/'); if (parts && parts.length===2) total = parseInt(parts[1],10); }
            var done = (got < chunk) || (total!=null && rows.length >= total) || (pages >= maxPages);
            if (done){ cb(null, rows); return; }
            return step();
          });
        }).catch(function(_e){ cb(null, rows); });
      }
      step();
    }

    function dxHeadCount(de, ate, anal, cb){
      if (!hasCreds()){ cb(null); return; }
      var URL = window.SUPABASE_URL, KEY = window.SUPABASE_KEY;
      var base = URL + '/rest/v1/vendas_canon';
      var qs = [
        'select=dia',
        'dia=gte.'+encodeURIComponent(de),
        'dia=lte.'+encodeURIComponent(ate)
      ];
      try{
        if (anal && anal.cancelado==='sim') qs.push('cancelado=eq.Sim');
        if (anal && anal.cancelado==='nao') qs.push('cancelado=neq.Sim');
      }catch(e){}
      var url = base + '?' + qs.join('&');
      var headers = { apikey: KEY, Authorization: 'Bearer '+KEY, 'Range-Unit': 'items', Range: '0-0', Prefer: 'count=exact' };
      fetch(url, { headers: headers }).then(function(r){
        var cr = r && r.headers && r.headers.get ? r.headers.get('content-range') : null;
        if (!cr){ cb(null); return; }
        var parts = cr.split('/');
        if (parts && parts.length===2){ cb(parseInt(parts[1],10)); } else { cb(null); }
      }).catch(function(){ cb(null); });
    }

    // ===== BaseQuery wrapper: usa baseQuery e remove cap se detectado via HEAD =====
    try{
      if (typeof window.baseQuery === 'function' && !window.__dx_bq_wrapped__){
        var original = window.baseQuery;
        window.baseQuery = function(de, ate, anal){
          try{
            var p = original.apply(this, arguments);
            if (!p || !p.then){ return Promise.resolve(p); }
            return p.then(function(rows){
              rows = rows || [];
              return new Promise(function(resolve){
                dxHeadCount(de, ate, anal, function(total){
                  if (total!=null && rows.length < total && hasCreds()){
                    dxFetchRESTPaged(de, ate, anal, function(_e, fullRows){
                      if (fullRows && fullRows.length){ resolve(fullRows); }
                      else { resolve(rows); }
                    });
                  } else {
                    resolve(rows);
                  }
                });
              });
            });
          }catch(e){
            return new Promise(function(resolve){
              dxFetchRESTPaged(de, ate, anal, function(_e, fullRows){
                resolve(fullRows || []);
              });
            });
          }
        };
        window.__dx_bq_wrapped__ = true;
      }
    }catch(e){ /* noop */ }

    // ===== Runner do Diagnóstico (ES5) =====
    function run(){
      var dates = uiDates(); if (!dates) return;
      var key = selectedKey();
      var anal = {
        unidade: safeGet(window, ['ms','unids','get']) ? window.ms.unids.get() : [],
        loja:    safeGet(window, ['ms','lojas','get']) ? window.ms.lojas.get() : [],
        turno:   safeGet(window, ['ms','turnos','get']) ? window.ms.turnos.get() : [],
        canal:   safeGet(window, ['ms','canais','get']) ? window.ms.canais.get() : [],
        pagamento: safeGet(window, ['ms','pags','get']) ? window.ms.pags.get() : [],
        cancelado: $('#fxCanceled') ? $('#fxCanceled').value : null
      };
      var prev = window.DateHelpers.computePrevRangeISO(dates.start, dates.end);

      // Fonte: baseQuery (já com wrapper acima). Se não existir, REST paginado.
      function fallback(cb){ dxFetchRESTPaged(dates.start, dates.end, anal, cb); }

      var fetchNow;
      if (typeof window.baseQuery === 'function'){
        fetchNow = window.baseQuery(dates.start, dates.end, anal).then(function(r){ return r||[]; }).catch(function(){ return new Promise(function(res){ fallback(function(_e, rows){ res(rows||[]); }); }); });
      } else {
        fetchNow = new Promise(function(res){ fallback(function(_e, rows){ res(rows||[]); }); });
      }

      fetchNow.then(function(rowsNow){
        dxFetchRESTPaged(prev.dePrev, prev.atePrev, anal, function(_e2, rowsPrev){
          var A = agg(rowsNow||[]), B = agg(rowsPrev||[]);
          var mode = (typeof window.effectiveMode==='function') ? window.effectiveMode() : 'total';
          var curr = (mode==='media') ? valBy(key, { fat:(A.tot.dias? A.tot.fat/A.tot.dias:0), fre:(A.tot.ped? A.tot.fre/A.tot.ped:0), ped:A.tot.ped, des:A.tot.des, dias:A.tot.dias, canc_ped:A.tot.canc_ped, canc_val:A.tot.canc_val })
                                      : valBy(key, A.tot);
          var prevv= (mode==='media') ? valBy(key, { fat:(B.tot.dias? B.tot.fat/B.tot.dias:0), fre:(B.tot.ped? B.tot.fre/B.tot.ped:0), ped:B.tot.ped, des:B.tot.des, dias:B.tot.dias, canc_ped:B.tot.canc_ped, canc_val:B.tot.canc_val })
                                      : valBy(key, B.tot);

          var pK = document.querySelector('.hero-value-number'); if (pK) pK.textContent = fmt(key, curr);
          var pD = document.querySelector('.delta');
          if (pD){
            var dlt = delta(curr, prevv);
            pD.textContent = dlt.txt;
            pD.className = 'delta '+dlt.cls;
          }
          var pS = document.querySelector('.hero-sub-value'); if (pS) pS.textContent = 'Período anterior: ' + fmt(key, prevv);

          var ctx = document.querySelector('.hero-context');
          if (ctx){
            var lo = topN(A.byStore,key,2).join(' e ') || '—';
            var ho = topN(A.byHour,key,2).join('–') || '—';
            var ca = topN(A.byCanal,key,1).join(', ') || '—';
            ctx.innerHTML = '<strong>Destaques:</strong> Lojas '+lo+' • <strong>Horário:</strong> '+ho+' • <strong>Canal:</strong> '+ca;
          }

          // insights simples
          var byDayKeys=[]; for (var d in A.byDay){ if (A.byDay.hasOwnProperty(d)) byDayKeys.push(d); }
          byDayKeys.sort();
          var tail=byDayKeys.slice(-28), prevWin=byDayKeys.slice(-56,-28);
          function sumFat(keys, map){ var s=0; for (var i=0;i<keys.length;i++){ s+= (map[keys[i]]? map[keys[i]].fat:0); } return s; }
          function sumPed(keys, map){ var s=0; for (var i=0;i<keys.length;i++){ s+= (map[keys[i]]? map[keys[i]].ped:0); } return s; }
          var nowFat=sumFat(tail,A.byDay), prevFat=sumFat(prevWin,A.byDay);
          var box=document.querySelector('.ins-list'); if (box) {
            box.innerHTML='';
            if(nowFat>0||prevFat>0){
              var up = nowFat>=prevFat;
              var el=document.createElement('div'); el.className='ins-card '+(up?'up':'down');
              el.innerHTML='<div class="dot"></div><div><div class="ins-title">'+(up?'Aceleração':'Desaceleração')+' nas últimas 4 semanas</div><div class="ins-sub">Δ '+(((nowFat-prevFat)/Math.max(1,prevFat)*100).toFixed(1))+'% em receita agregada.</div><div class="ins-action">Ação: '+(up?'reforçar':'ajustar')+' mix de <strong>combos almoço</strong> nas Top Lojas.</div></div>';
              box.appendChild(el);
            }
            var desperc=(A.tot.fat>0? A.tot.des/A.tot.fat:0);
            (function(){
              var warn=desperc>=0.12, el=document.createElement('div');
              el.className='ins-card '+(warn?'down':'up');
              el.innerHTML='<div class="dot"></div><div><div class="ins-title">'+(warn?'Subsídio acima do ideal':'Subsídio dentro do alvo')+'</div><div class="ins-sub">% Incentivos atual: '+(desperc*100).toFixed(1)+'%.</div><div class="ins-action">Ação: '+(warn?'migrar para <strong>tiers 60/90/120</strong>':'manter tiers atuais e testar horário-alvo (11–14h)')+'</div></div>';
              box.appendChild(el);
            })();
          }

          var N = tail.length>0? tail.length : 1;
          var mmFat= nowFat/Math.max(1,N), mmPed=sumPed(tail,A.byDay)/Math.max(1,N);
          var trend=(isFinite(prevFat)&&prevFat>0)? ((nowFat-prevFat)/prevFat):0, boost=1+(trend*0.5);
          var pv=document.querySelector('.proj-value'); if(pv) pv.textContent='R$ '+(mmFat*30*boost).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
          var a=document.querySelector('.proj-kpi-sub .sub-kpi:nth-child(1) .proj-value-small'); if(a) a.textContent = Math.round(mmPed*30*boost).toLocaleString('pt-BR');
          var b=document.querySelector('.proj-kpi-sub .sub-kpi:nth-child(2) .proj-value-small'); if(b) b.textContent = 'R$ '+(A.tot.ped? (A.tot.fat/A.tot.ped).toFixed(2).replace('.',',') : '0,00');

        });
      });
    }

    // binds de UI (ES5)
    function bind(){
      var ids = ['#fxDuStart','#fxDuEnd','#fxCanceled','#kpi-select'];
      for (var i=0;i<ids.length;i++){
        var el = $(ids[i]); if (!el) continue;
        if (!el.__dx_es5__){
          el.addEventListener('change', run);
          el.addEventListener('input', run);
          el.__dx_es5__ = true;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function(){ bind(); run(); });
  })();
  </script>

  <!-- ===== DX Patch (ES5) — remove limite de 1000 no baseQuery sem quebrar o app ===== -->
  <script>
  (function(){
    'use strict';
    function hasCreds(){ return !!(window.SUPABASE_URL && window.SUPABASE_KEY); }
    function dxFetchRESTPaged(de, ate, anal, cb){
      if (!hasCreds()){ cb(null, []); return; }
      var URL = window.SUPABASE_URL, KEY = window.SUPABASE_KEY;
      var base = URL + '/rest/v1/vendas_canon';
      var qs = [
        'select=dia,hora,loja,canal,fat,des,fre,cancelado',
        'dia=gte.'+encodeURIComponent(de),
        'dia=lte.'+encodeURIComponent(ate),
        'order=dia.asc,hora.asc'
      ];
      try{
        if (anal && anal.cancelado==='sim') qs.push('cancelado=eq.Sim');
        if (anal && anal.cancelado==='nao') qs.push('cancelado=neq.Sim');
      }catch(e){}
      var url = base + '?' + qs.join('&');
      var headers = { apikey: KEY, Authorization: 'Bearer '+KEY, 'Range-Unit': 'items', Range: '0-49999', Prefer: 'count=exact' };
      var chunk = 50000, start = 0, rows = [], pages = 0, maxPages = 200;
      function step(){
        headers.Range = String(start) + '-' + String(start + chunk - 1);
        return fetch(url, { headers: headers }).then(function(r){
          if (!r.ok){ cb(null, rows); return; }
          var cr = r.headers && r.headers.get ? r.headers.get('content-range') : null;
          return r.json().then(function(data){
            var got = (data && data.length) ? data.length : 0;
            for (var i=0;i<got;i++) rows.push(data[i]);
            pages += 1; start += chunk;
            var total = null;
            if (cr){ var parts = cr.split('/'); if (parts && parts.length===2) total = parseInt(parts[1],10); }
            var done = (got < chunk) || (total!=null && rows.length >= total) || (pages >= maxPages);
            if (done){ cb(null, rows); return; }
            return step();
          });
        }).catch(function(_e){ cb(null, rows); });
      }
      step();
    }
    function dxHeadCount(de, ate, anal, cb){
      if (!hasCreds()){ cb(null); return; }
      var URL = window.SUPABASE_URL, KEY = window.SUPABASE_KEY;
      var base = URL + '/rest/v1/vendas_canon';
      var qs = [
        'select=dia',
        'dia=gte.'+encodeURIComponent(de),
        'dia=lte.'+encodeURIComponent(ate)
      ];
      try{
        if (anal && anal.cancelado==='sim') qs.push('cancelado=eq.Sim');
        if (anal && anal.cancelado==='nao') qs.push('cancelado=neq.Sim');
      }catch(e){}
      var url = base + '?' + qs.join('&');
      var headers = { apikey: KEY, Authorization: 'Bearer '+KEY, 'Range-Unit': 'items', Range: '0-0', Prefer: 'count=exact' };
      fetch(url, { headers: headers }).then(function(r){
        var cr = r && r.headers && r.headers.get ? r.headers.get('content-range') : null;
        if (!cr){ cb(null); return; }
        var parts = cr.split('/');
        if (parts && parts.length===2){ cb(parseInt(parts[1],10)); } else { cb(null); }
      }).catch(function(){ cb(null); });
    }
    try{
      if (typeof window.baseQuery === 'function' && !window.__dx_bq_wrapped__){
        var original = window.baseQuery;
        window.baseQuery = function(de, ate, anal){
          try{
            var p = original.apply(this, arguments);
            if (!p || !p.then){ return Promise.resolve(p); }
            return p.then(function(rows){
              rows = rows || [];
              return new Promise(function(resolve){
                dxHeadCount(de, ate, anal, function(total){
                  if (total!=null && rows.length < total && hasCreds()){
                    dxFetchRESTPaged(de, ate, anal, function(_e, fullRows){
                      if (fullRows && fullRows.length){ resolve(fullRows); }
                      else { resolve(rows); }
                    });
                  } else {
                    resolve(rows);
                  }
                });
              });
            });
          }catch(e){
            return new Promise(function(resolve){
              dxFetchRESTPaged(de, ate, anal, function(_e, fullRows){
                resolve(fullRows || []);
              });
            });
          }
        };
        window.__dx_bq_wrapped__ = true;
      }
    }catch(e){}
  })();
  </script>
</body>
</html>
