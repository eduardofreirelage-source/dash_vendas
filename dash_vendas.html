<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dash Vendas — Diagnóstico (REST + OpenAPI)</title>
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%232563eb'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-size='28' fill='white' font-family='Arial'%3ED%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f6f7fb;--panel:#fff;--ink:#111827;--muted:#6b7280;--line:#e5e7eb;--brand:#2563eb;--brand-ink:#fff;--chip:#eef2ff;--chip-ink:#3730a3}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 18px}
    .row{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:960px){.row{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    .label{font-weight:600;margin:2px 0 6px;font-size:12px;color:var(--muted)}
    .input, select{width:100%;height:40px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff}
    .input:read-only{background:#fafafa}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{height:40px;border-radius:10px;border:1px solid var(--line);background:#fff;padding:0 12px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
    .btn.ghost{background:#f8fafc}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{border-radius:999px;background:var(--chip);color:var(--chip-ink);padding:6px 10px;font-size:12px;cursor:pointer;user-select:none}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .log{background:#0b1020;color:#d7f2ff;border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;height:120px;overflow:auto;white-space:pre-wrap}
    table{border-collapse:collapse;width:100%}
    th,td{border-top:1px solid var(--line);padding:8px 8px;text-align:left}
    th{position:sticky;top:0;background:#f9fafb;z-index:1}
    .empty{border:1px dashed var(--line);border-radius:10px;min-height:52px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dash de Vendas — <span style="font-weight:600">Diagnóstico (REST + OpenAPI)</span></h1>

    <div class="row">
      <!-- Painel de Config -->
      <div class="card">
        <div class="label">Project URL (ex.: https://xxxxx.supabase.co)</div>
        <input id="projectUrl" class="input" placeholder="https://xxxxx.supabase.co">

        <div class="label" style="margin-top:10px">Anon Key</div>
        <input id="anonKey" class="input" placeholder="eyJh...">

        <div class="controls" style="margin-top:10px;align-items:center">
          <label style="display:flex;gap:8px;align-items:center">
            <input id="onlyPublic" type="checkbox" checked>
            <span class="hint">Somente schema <b>public</b> ?</span>
          </label>
          <button id="btnTest" class="btn ghost">1) Testar conexão (OpenAPI)</button>
          <button id="btnList" class="btn ghost">2) Listar tabelas</button>
          <button id="btnSaveCfg" class="btn">Salvar config</button>
        </div>

        <div class="chips" id="tablesList"></div>

        <div class="label" style="margin-top:10px">Tabela (use <i>schema.tabela</i> se precisar)</div>
        <input id="salesTable" class="input" placeholder="ex.: public.vendas_xlsx">

        <div class="controls" style="margin-top:10px">
          <div style="flex:1">
            <div class="label">Coluna de data (opcional)</div>
            <input id="dateCol" class="input" placeholder="ex.: dia / created_at / dh / hora">
          </div>
          <div style="flex:1">
            <div class="label">Coluna de valor (opcional)</div>
            <input id="valueCol" class="input" placeholder="ex.: total / valor_total / receita / fat">
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <div style="flex:1">
            <div class="label">Início</div>
            <input id="dtStart" class="input" type="date">
          </div>
          <div style="flex:1">
            <div class="label">Fim</div>
            <input id="dtEnd" class="input" type="date">
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button id="btnCount" class="btn primary">Contar registros (Content-Range)</button>
          <button id="btnSample" class="btn">Carregar amostra (20)</button>
          <button id="btnClear" class="btn">Limpar</button>
        </div>

        <div class="label" style="margin-top:10px">Log</div>
        <div id="log" class="log">Pronto.</div>
        <div class="hint">Dicas: a contagem via HEAD usa <code>?select=id</code> e cabeçalho <code>Prefer: count=exact</code>. Se a coluna de data ficar vazia, nenhuma filtragem por período será aplicada.</div>
      </div>

      <!-- Painel de Amostra -->
      <div class="card">
        <div class="label">Amostra de dados</div>
        <div id="sampleBox" class="empty">—</div>
        <div id="sampleTable" style="margin-top:10px;overflow:auto;max-height:560px"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // ---------- util ----------
  const $ = (id)=>document.getElementById(id);
  const log = (msg)=>{
    const box = $("log");
    const ts = new Date().toTimeString().slice(0,8);
    box.textContent = (box.textContent ? box.textContent + "\\n" : "Pronto.\\n") + "["+ts+"] " + msg;
    box.scrollTop = box.scrollHeight;
  };

  const saveCfg = ()=>{
    const cfg = {
      projectUrl: $("projectUrl").value.trim(),
      anonKey: $("anonKey").value.trim(),
      onlyPublic: $("onlyPublic").checked,
      table: $("salesTable").value.trim(),
      dateCol: $("dateCol").value.trim(),
      valueCol: $("valueCol").value.trim(),
      dtStart: $("dtStart").value,
      dtEnd: $("dtEnd").value
    };
    localStorage.setItem("dv_cfg", JSON.stringify(cfg));
    log("Config salva.");
  };

  const loadCfg = ()=>{
    try{
      const raw = localStorage.getItem("dv_cfg");
      if(!raw) return;
      const cfg = JSON.parse(raw);
      $("projectUrl").value = cfg.projectUrl || "";
      $("anonKey").value = cfg.anonKey || "";
      $("onlyPublic").checked = !!cfg.onlyPublic;
      $("salesTable").value = cfg.table || "";
      $("dateCol").value = cfg.dateCol || "";
      $("valueCol").value = cfg.valueCol || "";
      $("dtStart").value = cfg.dtStart || "";
      $("dtEnd").value = cfg.dtEnd || "";
    }catch(e){ /* ignore */ }
  };

  const headers = (key)=>({
    "apikey": key,
    "Authorization": "Bearer " + key
  });

  const openapiHeaders = (key)=>({
    ...headers(key),
    "Accept": "application/openapi+json"
  });

  const asYMD = (d)=>d instanceof Date ? d.toISOString().slice(0,10) : String(d || "");
  const plusDays = (d, days)=>{
    const dt = new Date(d + "T00:00:00");
    dt.setDate(dt.getDate() + days);
    return asYMD(dt);
  };

  const buildUrl = (base, table, params)=>{
    // Nao prefixamos "public." automaticamente para evitar "public.public.X"
    const path = (table || "").trim();
    const url = new URL(base.replace(/\/+$/,"") + "/rest/v1/" + encodeURIComponent(path));
    if (params && typeof params === "object"){
      Object.keys(params).forEach(k=>{
        if (params[k] !== undefined && params[k] !== null && params[k] !== ""){
          url.searchParams.set(k, params[k]);
        }
      });
    }
    return url.toString();
  };

  const parseOpenApiTables = (spec, onlyPublic)=>{
    try{
      const paths = Object.keys(spec.paths || {});
      const names = paths.map(p=>p.replace(/^\/+/,"").split("/")[0]);
      const uniq = Array.from(new Set(names)).filter(n=>n && !n.startsWith("#"));
      return onlyPublic ? uniq.filter(n => !n.includes("." ) || n.startsWith("public.")) : uniq;
    }catch(e){ return []; }
  };

  const renderChips = (list)=>{
    const box = $("tablesList");
    box.innerHTML = "";
    list.forEach(n=>{
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = n;
      chip.title = "Usar " + n;
      chip.onclick = ()=>{
        $("salesTable").value = n;
        saveCfg();
      };
      box.appendChild(chip);
    });
  };

  const renderSample = (rows)=>{
    const box = $("sampleBox");
    const tbl = $("sampleTable");
    if(!rows || !rows.length){
      box.style.display = "flex";
      box.textContent = "Sem dados.";
      tbl.innerHTML = "";
      return;
    }
    box.style.display = "none";
    const keys = Object.keys(rows[0]);
    const thead = "<thead><tr>" + keys.map(k=>"<th>"+k+"</th>").join("") + "</tr></thead>";
    const tbody = "<tbody>" + rows.map(r=>"<tr>"+keys.map(k=>"<td>"+(r[k]===null?"":String(r[k]))+"</td>").join("")+"</tr>").join("") + "</tbody>";
    tbl.innerHTML = "<table>"+thead+tbody+"</table>";
  };

  // ---------- ações ----------
  $("btnSaveCfg").onclick = saveCfg;
  $("btnClear").onclick = ()=>{ $("log").textContent = "Pronto."; $("sampleTable").innerHTML=""; $("sampleBox").style.display="flex"; $("sampleBox").textContent="—"; };
  $("btnList").onclick = async ()=>{
    saveCfg();
    const base = $("projectUrl").value.trim();
    const key = $("anonKey").value.trim();
    if(!base || !key){ log("[ERRO] Informe URL e Anon Key."); return; }
    try{
      const url = base.replace(/\/+$/,"") + "/rest/v1/?apikey=" + encodeURIComponent(key);
      const r = await fetch(url, {headers: openapiHeaders(key)});
      if(!r.ok){ log("[ERRO] OpenAPI HTTP " + r.status); return; }
      const spec = await r.json();
      const names = parseOpenApiTables(spec, $("onlyPublic").checked);
      renderChips(names);
      log("OpenAPI OK. " + names.length + " tabelas vistas.");
    }catch(err){
      log("[ERRO] " + err.message);
    }
  };

  $("btnTest").onclick = async ()=>{
    // teste simples: HEAD em /rest/v1/ com Accept: openapi
    $("tablesList").innerHTML = "";
    await $("btnList").onclick();
  };

  $("btnCount").onclick = async ()=>{
    saveCfg();
    const base = $("projectUrl").value.trim();
    const key = $("anonKey").value.trim();
    const table = $("salesTable").value.trim();
    const dateCol = $("dateCol").value.trim();
    const d1 = $("dtStart").value;
    const d2 = $("dtEnd").value;
    if(!base || !key){ log("[ERRO] Informe URL e Anon Key."); return; }
    if(!table){ log("[ERRO] Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx)."); return; }

    const qp = { select: "id" };
    if(dateCol){
      const start = asYMD(d1 || "");
      const end = asYMD(d2 || "");
      if(start && end){
        // Usamos lt = dia seguinte de d2 para abranger o ultimo dia
        const lt = plusDays(end, 1);
        const isTs = /dh|hora|created_at|timestamp/i.test(dateCol);
        qp[dateCol] = (isTs ? "gte." + start + "T00:00:00" : "gte." + start);
        qp[dateCol] += "&" + encodeURIComponent(dateCol) + "=" + (isTs ? "lt." + lt + "T00:00:00" : "lt." + lt);
      }
    }

    const url = buildUrl(base, table, qp);
    try{
      const r = await fetch(url, { method: "HEAD", headers: { ...headers(key), "Prefer": "count=exact" } });
      if(!r.ok){ log("[ERRO] Erro no count: HTTP " + r.status); return; }
      const cr = r.headers.get("Content-Range") || "";
      const total = (cr.split("/")[1] || "").trim();
      log("Count via Content-Range: " + (total || "?"));
    }catch(err){
      log("[ERRO] " + err.message);
    }
  };

  $("btnSample").onclick = async ()=>{
    saveCfg();
    const base = $("projectUrl").value.trim();
    const key = $("anonKey").value.trim();
    const table = $("salesTable").value.trim();
    const dateCol = $("dateCol").value.trim();
    const d1 = $("dtStart").value;
    const d2 = $("dtEnd").value;
    if(!base || !key){ log("[ERRO] Informe URL e Anon Key."); return; }
    if(!table){ log("[ERRO] Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx)."); return; }

    const params = { select: "*", limit: "20" };
    if(dateCol){
      const start = asYMD(d1 || "");
      const end = asYMD(d2 || "");
      if(start && end){
        const lt = plusDays(end, 1);
        const isTs = /dh|hora|created_at|timestamp/i.test(dateCol);
        params[dateCol] = isTs ? "gte." + start + "T00:00:00" : "gte." + start;
        // acrescentar segundo filtro com o mesmo nome exige sintaxe de query "col=gte.A&col=lt.B"
        // faremos manual abaixo
      }
    }

    // Construir URL manualmente para permitir colunas repetidas no filtro
    let url = new URL(base.replace(/\/+$/,"") + "/rest/v1/" + encodeURIComponent(table));
    url.searchParams.set("select","*");
    url.searchParams.set("limit","20");

    if(dateCol){
      const start = asYMD(d1 || "");
      const end = asYMD(d2 || "");
      if(start && end){
        const lt = plusDays(end, 1);
        const isTs = /dh|hora|created_at|timestamp/i.test(dateCol);
        url.searchParams.append(dateCol, (isTs ? "gte."+start+"T00:00:00" : "gte."+start));
        url.searchParams.append(dateCol, (isTs ? "lt."+lt+"T00:00:00" : "lt."+lt));
      }
    }

    try{
      const r = await fetch(url.toString(), { headers: headers(key) });
      if(!r.ok){
        log("[ERRO] HTTP " + r.status + " ao carregar amostra.");
        renderSample([]);
        return;
      }
      const data = await r.json();
      renderSample(data);
      log("Amostra carregada. " + data.length + " linhas.");
    }catch(err){
      log("[ERRO] " + err.message);
    }
  };

  // defaults para facilitar teste
  const today = new Date();
  const first = new Date(today.getFullYear(), today.getMonth(), 1);
  $("dtStart").value = asYMD(first);
  $("dtEnd").value = asYMD(today);

  loadCfg();
})();
</script>
</body>
</html>
