<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Diagnóstico Supabase (v0b) — REST + OpenAPI</title>
<link rel="icon" href="data:,">
<style>
  :root{--bg:#f6f7fb;--fg:#111827;--muted:#6b7280;--card:#fff;--primary:#2563eb;--border:#e5e7eb;--accent:#1118270f}
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  h1{font-size:20px;margin:12px 0 16px}
  .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  label{display:block;font-weight:600;margin:8px 0 4px}
  input[type=text],input[type=password],input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;padding:6px 10px;margin:4px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer;white-space:nowrap}
  .muted{color:var(--muted)}
  pre{background:#0b1220;color:#e5edff;border-radius:10px;padding:10px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border-top:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:top}
  th{background:var(--accent);font-weight:600}
  small.k{font-family:ui-monospace,Consolas,monospace;background:#eef2ff;border:1px solid #e0e7ff;border-radius:6px;padding:0 6px}
  .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>Diagnóstico Supabase (v0b) — REST + OpenAPI</h1>
  <div class="card">
    <div class="row">
      <div>
        <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
        <input id="url" type="text" placeholder="https://xxxxx.supabase.co">
      </div>
      <div>
        <label>Anon Key</label>
        <input id="key" type="password" placeholder="eyJhbGciOiJIUzI1NiIs...">
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <label class="flex" style="gap:6px;align-items:center;margin:0">
        <input id="onlyPublic" type="checkbox" checked> Somente schema <b>public</b>?
      </label>
      <button id="btnTest" class="btn">1) Testar conexão (OpenAPI)</button>
      <button id="btnList" class="btn">2) Listar tabelas</button>
      <button id="btnSave" class="btn">Salvar config</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="pills" class="flex" style="margin-top:8px"></div>
    <div class="row3" style="margin-top:12px">
      <div>
        <label>Tabela <span class="muted">(use <small class="k">schema.tabela</small> se precisar)</span></label>
        <input id="table" type="text" placeholder="ex.: vendas_xlsx ou public.vendas_xlsx">
      </div>
      <div>
        <label>Coluna de data (opcional)</label>
        <input id="dateCol" type="text" placeholder="ex.: created_at / data / dt / dh / hora">
      </div>
      <div>
        <label>Coluna de valor (opcional)</label>
        <input id="valueCol" type="text" placeholder="ex.: total / valor_total / receita">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Início</label>
        <input id="start" type="date">
      </div>
      <div>
        <label>Fim</label>
        <input id="end" type="date">
      </div>
    </div>
    <div class="flex" style="margin-top:12px">
      <button id="btnCount" class="btn">Contar registros (Content-Range)</button>
      <button id="btnSample" class="btn primary">Carregar amostra (20)</button>
      <button id="btnClear" class="btn">Limpar</button>
    </div>
    <div style="margin-top:12px">
      <label>Log</label>
      <pre id="log">Pronto.</pre>
    </div>
  </div>
  <div class="card">
    <h2 style="margin:0 0 8px">Amostra de dados</h2>
    <div id="sample">—</div>
  </div>
</div>

<script>
const $ = (sel)=>document.querySelector(sel);
const logEl = $("#log"), pillsEl = $("#pills"), sampleEl = $("#sample"), statusEl = $("#status");

function log(msg){ const ts = new Date().toTimeString().slice(0,8); logEl.textContent += `\\n[${ts}] ${msg}`; logEl.scrollTop = logEl.scrollHeight; }
function setLog(msg){ logEl.textContent = msg; }

function saveCfg(){
  const cfg = {
    url: $("#url").value.trim(),
    key: $("#key").value.trim(),
    onlyPublic: $("#onlyPublic").checked,
    table: $("#table").value.trim(),
    dateCol: $("#dateCol").value.trim(),
    valueCol: $("#valueCol").value.trim(),
    start: $("#start").value,
    end: $("#end").value
  };
  localStorage.supabase_diag_v0b = JSON.stringify(cfg);
  log("Config salva.");
}
function restoreCfg(){
  try{
    const cfg = JSON.parse(localStorage.supabase_diag_v0b || "{}");
    if(cfg.url) $("#url").value = cfg.url;
    if(cfg.key) $("#key").value = cfg.key;
    if(typeof cfg.onlyPublic === "boolean") $("#onlyPublic").checked = cfg.onlyPublic;
    if(cfg.table) $("#table").value = cfg.table;
    if(cfg.dateCol) $("#dateCol").value = cfg.dateCol;
    if(cfg.valueCol) $("#valueCol").value = cfg.valueCol;
    if(cfg.start) $("#start").value = cfg.start;
    if(cfg.end) $("#end").value = cfg.end;
  }catch(_){}
}
restoreCfg();

function headers(schema){
  const key = $("#key").value.trim();
  const h = { apikey:key, Authorization:`Bearer ${key}` };
  if(schema){ h["Accept-Profile"]=schema; h["Content-Profile"]=schema; }
  return h;
}

function parseSchemaTable(raw, onlyPublic){
  let s = null, t = (raw||"").trim();
  if(!t) throw new Error("Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx).");
  // Normalize oddities "public.public.tbl"
  t = t.replace(/^public\.public\./i, "public.");
  // Convert "schema:table" -> "schema.table"
  if(/^[a-z0-9_]+:[a-z0-9_]+$/i.test(t)){ const [a,b]=t.split(":"); return {schema:a, table:b}; }
  // If already schema-qualified, keep it but split:
  if(t.includes(".")){ const [a,b] = t.split("."); return {schema:a, table:b}; }
  // Only table name:
  if(onlyPublic) return {schema:"public", table:t};
  return {schema:null, table:t};
}

function path(project, table){ 
  return `${project.replace(/\/+$/,'')}/rest/v1/${encodeURIComponent(table)}`;
}

async function fetchOpenAPI(){
  const base = $("#url").value.trim();
  if(!base) throw new Error("Informe o Project URL.");
  statusEl.textContent = "Carregando OpenAPI…";
  const res = await fetch(`${base.replace(/\/+$/,'')}/rest/v1/`, {
    headers: { ...headers(null), Accept: "application/openapi+json; charset=utf-8; version=1.0" }
  });
  if(!res.ok) throw new Error(`HTTP ${res.status} ao carregar OpenAPI.`);
  const spec = await res.json();
  statusEl.textContent = "";
  return spec;
}

function extractTablesFromOpenAPI(spec){
  const set = new Set();
  const paths = Object.keys(spec.paths || {});
  for(const p of paths){
    if(p.startsWith("/rpc/")) continue;
    if(p.includes("{")) continue;
    const name = p.replace(/^\//,"");
    if(!name) continue;
    // Some specs come as "public:table" or just "table"
    set.add(name);
  }
  return Array.from(set).sort();
}

function renderPills(list){
  pillsEl.innerHTML = "";
  const onlyPublic = $("#onlyPublic").checked;
  for(const raw of list){
    let label = raw;
    // Visual label sem schema quando for public:
    if(raw.includes(":")){
      const [schema, tbl] = raw.split(":");
      label = (schema==="public") ? tbl : `${schema}.${tbl}`;
    }
    const pill = document.createElement("button");
    pill.className = "pill";
    pill.textContent = label;
    pill.title = raw;
    pill.onclick = ()=>{
      // Preenche #table sem duplicar schema
      if(raw.includes(":")){
        const [s,t] = raw.split(":");
        $("#table").value = (s==="public") ? t : `${s}.${t}`;
      }else{
        $("#table").value = onlyPublic ? raw : raw; // se quiser outro schema, usuário digita
      }
      saveCfg();
    };
    pillsEl.appendChild(pill);
  }
}

async function doTest(){
  try{
    const spec = await fetchOpenAPI();
    const list = extractTablesFromOpenAPI(spec);
    log(`OpenAPI carregado. ${list.length} tabelas.`);
  }catch(e){ log(`[ERRO] ${e.message}`); }
}
async function doList(){
  try{
    const spec = await fetchOpenAPI();
    const list = extractTablesFromOpenAPI(spec);
    // Se "somente public", reduza visualmente, mas mantenha títulos completos
    const onlyPublic = $("#onlyPublic").checked;
    const filtered = onlyPublic ? list.filter(n => !n.includes(":") || n.startsWith("public:")) : list;
    renderPills(filtered);
    log(`OpenAPI OK. ${filtered.length} tabelas vistas.`);
  }catch(e){ log(`[ERRO] ${e.message}`); }
}

function buildDateFilters(dateCol, start, end){
  if(!dateCol) return "";
  const params = [];
  if(start){
    const s = `${start}T00:00:00`;
    params.push(`${encodeURIComponent(dateCol)}=gte.${encodeURIComponent(s)}`);
  }
  if(end){
    // end é exclusivo (lt fim+1 dia)
    const d = new Date(end+"T00:00:00Z");
    d.setUTCDate(d.getUTCDate()+1);
    const next = d.toISOString().slice(0,19);
    params.push(`${encodeURIComponent(dateCol)}=lt.${encodeURIComponent(next)}`);
  }
  return params.length?("&"+params.join("&")):"";
}

async function doCount(){
  try{
    const base = $("#url").value.trim(); if(!base) throw new Error("Informe o Project URL.");
    const onlyPublic = $("#onlyPublic").checked;
    const {schema, table} = parseSchemaTable($("#table").value, onlyPublic);
    const h = headers(schema);
    h["Prefer"] = "count=exact";
    const filters = buildDateFilters($("#dateCol").value.trim(), $("#start").value, $("#end").value);
    const url = path(base, table) + `?select=id${filters}`;
    const res = await fetch(url, { method:"HEAD", headers: h });
    if(!res.ok) throw new Error(`Erro no count: HTTP ${res.status}`);
    const cr = res.headers.get("Content-Range") || "";
    const total = (cr.split("/")[1] || "").trim();
    log(`Count via Content-Range: ${total || "?"}`);
  }catch(e){ log(`[ERRO] ${e.message}`); }
}

function renderTable(rows){
  if(!rows || !rows.length){ sampleEl.innerHTML = "—"; return; }
  const cols = Array.from(Object.keys(rows[0]));
  let html = "<div style='overflow:auto'><table><thead><tr>";
  for(const c of cols) html += `<th>${c}</th>`;
  html += "</tr></thead><tbody>";
  for(const r of rows){
    html += "<tr>";
    for(const c of cols){
      let v = r[c];
      if(v===null || v===undefined) v = "";
      if(typeof v === "object") v = JSON.stringify(v);
      html += `<td>${String(v)}</td>`;
    }
    html += "</tr>";
  }
  html += "</tbody></table></div>";
  sampleEl.innerHTML = html;
}

async function doSample(){
  try{
    const base = $("#url").value.trim(); if(!base) throw new Error("Informe o Project URL.");
    const onlyPublic = $("#onlyPublic").checked;
    const {schema, table} = parseSchemaTable($("#table").value, onlyPublic);
    const h = headers(schema);
    const filters = buildDateFilters($("#dateCol").value.trim(), $("#start").value, $("#end").value);
    const url = path(base, table) + `?select=*&limit=20${filters}`;
    const res = await fetch(url, { headers: h });
    if(!res.ok){
      const txt = await res.text().catch(()=>null);
      throw new Error(`HTTP ${res.status} ao carregar amostra. ${txt || ""}`.trim());
    }
    const json = await res.json();
    renderTable(json);
    log(`Amostra carregada. ${json.length} linhas.`);
  }catch(e){ log(`[ERRO] ${e.message}`); }
}

function doClear(){
  $("#table").value = "";
  $("#dateCol").value = "";
  $("#valueCol").value = "";
  $("#start").value = "";
  $("#end").value = "";
  sampleEl.innerHTML = "—";
  setLog("Pronto.");
}

$("#btnTest").onclick = ()=>{ saveCfg(); doTest(); };
$("#btnList").onclick = ()=>{ saveCfg(); doList(); };
$("#btnSave").onclick = ()=>{ saveCfg(); };
$("#btnCount").onclick = ()=>{ saveCfg(); doCount(); };
$("#btnSample").onclick = ()=>{ saveCfg(); doSample(); };
$("#btnClear").onclick = ()=>{ doClear(); };

// UX: Enter em campos disparam ações
$("#table").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("#btnSample").click(); });
$("#url").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("#btnTest").click(); });

</script>
</body>
</html>
