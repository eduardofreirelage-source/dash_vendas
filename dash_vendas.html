<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dash Vendas â€” Pratos</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="22" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">DV</text></svg>'/>
  <style>
    :root{ --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --c-now:#7b1e3a; --c-prev:#94a3b8; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-size:22px;font-weight:700;letter-spacing:.2px}
    .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(10,18,32,.05);margin-bottom:12px}
    .row{display:grid;gap:12px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.sm{padding:6px 10px;font-size:12px;border-radius:8px}
    input[type="date"], .msel-btn{ width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff; min-height:44px;font-size:16px; }
    .chips{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    .chip{padding:10px 0;border:1px solid #efd5db;border-radius:10px;background:#f7e9ed;cursor:pointer;text-align:center;font-weight:800;color:#7b1e3a}
    .chip.active{background:var(--c-now);border-color:var(--c-now);color:#fff;}
    .switch{display:flex;align-items:center;gap:10px}
    .switch input{width:40px;height:22px;appearance:none;background:#e2e8f0;border-radius:999px;position:relative;outline:none;cursor:pointer;border:1px solid #cbd5e1}
    .switch input:checked{background:#7b1e3a}
    .switch input::after{content:'';position:absolute;top:1px;left:1px;width:18px;height:18px;background:#fff;border-radius:50%;transition:left .2s}
    .switch input:checked::after{left:20px}
    .msel{position:relative}
    .msel-btn{cursor:pointer;text-align:left}
    .msel-btn:after{content:"â–¾";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:40;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:300px;overflow:auto;padding:8px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px}
    .msel-opt:hover{background:#f3f4f6}
    .krow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{position:relative;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 14px;box-shadow:0 8px 24px rgba(10,18,32,.05);cursor:pointer}
    .kpi.active{outline:2px solid var(--c-now)}
    .kpi h4{margin:0 0 6px;font-size:13px;color:#475569;display:flex;align-items:center;gap:10px}
    .kpi .val{font-size:22px;font-weight:800}
    .kpi .accent{height:2px;background:#7b1e3a;border-radius:999px;margin:6px 0}
    .kpi .sub{font-size:12px;color:#667085;margin-top:2px}
    .delta{display:inline-flex;gap:6px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:12px;margin-left:auto;background:rgba(148,163,184,.15);color:#64748b}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:#7b1e3a}
    .delta.down{background:rgba(148,163,184,.15);border-color:rgba(148,163,184,.35);color:#64748b}
    .chart-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 8px 12px;box-shadow:0 8px 24px rgba(10,18,32,.05)}
    .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;gap:10px;flex-wrap:wrap}
    .chart-box{height:320px;position:relative}
    .chart-box canvas{display:block;width:100%;height:100%}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 9px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#475569}
    .note{font-size:12px;color:#475569}
    @media (max-width:1024px){.cols-3,.cols-2,.krow{grid-template-columns:1fr}}
  </style>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/plugin/isoWeek.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek)</script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard de Vendas â€” Pratos</h1>

    <!-- Filtros data + upload -->
    <div class="section">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <div class="switch">
          <label for="onlyPratos">Somente PRATOS</label><input type="checkbox" id="onlyPratos"/>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnUpload" class="btn">ðŸ“¤ Carregar Excel</button>
          <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
          <span class="badge" id="uploadInfo">Sem arquivo â€¢ Exibindo dados de exemplo</span>
        </div>
      </div>
      <div class="row cols-3">
        <div><div class="muted" style="margin-bottom:6px;">InÃ­cio</div><input type="date" id="fDe"></div>
        <div><div class="muted" style="margin-bottom:6px;">Fim</div><input type="date" id="fAte"></div>
        <div>
          <div class="muted" style="margin-bottom:6px;">PerÃ­odo RÃ¡pido (dias)</div>
          <div class="chips">
            <button class="chip" data-q="7">07</button><button class="chip" data-q="15">15</button><button class="chip active" data-q="30">30</button>
            <button class="chip" data-q="60">60</button><button class="chip" data-q="90">90</button><button class="chip" data-q="120">120</button>
          </div>
          <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:12px;">â€”</div>
        </div>
      </div>
    </div>

    <!-- Filtros venda -->
    <div class="section">
      <div class="row cols-3">
        <div>
          <div class="muted" style="margin-bottom:6px;">Unidade</div>
          <div id="ms-unids" class="msel">
            <button class="msel-btn">Todas</button>
            <div class="msel-panel"></div>
          </div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Categoria</div>
          <div id="ms-cats" class="msel">
            <button class="msel-btn">Todas</button>
            <div class="msel-panel"></div>
          </div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Prato</div>
          <div id="ms-pratos" class="msel">
            <button class="msel-btn">Todos</button>
            <div class="msel-panel"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="krow" id="kpiRow">
      <div class="kpi" data-metric="total">
        <h4><span>Itens Vendidos</span><span class="delta" id="d_qtd">â€”</span></h4>
        <div class="val" id="k_total">â€”</div><div class="accent"></div>
        <div class="sub">Anterior: <span id="p_total">â€”</span></div>
      </div>
      <div class="kpi" data-metric="unique">
        <h4><span>Pratos/Itens Ãšnicos</span></h4>
        <div class="val" id="k_unique">â€”</div><div class="accent"></div>
        <div class="sub">Total de itens distintos no perÃ­odo</div>
      </div>
      <div class="kpi" data-metric="avg">
        <h4><span>MÃ©dia DiÃ¡ria</span><span class="pill">Ignora dias sem venda</span></h4>
        <div class="val" id="k_avg">â€”</div><div class="accent"></div>
        <div class="sub">Itens vendidos/dia (com venda)</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="section" style="margin-top:12px">
      <div class="chart-card" style="margin-bottom:10px">
        <div class="chart-head">
          <div class="muted">Top 10 Mais Vendidos</div>
          <div class="note" id="note_topmais">â€”</div>
        </div>
        <div class="chart-box"><canvas id="ch_top10_mais"></canvas></div>
      </div>

      <div class="chart-card" style="margin-bottom:10px">
        <div class="chart-head">
          <div class="muted">Top 10 Menos Vendidos</div>
          <div class="note" id="note_topmenos">â€”</div>
        </div>
        <div class="chart-box"><canvas id="ch_top10_menos"></canvas></div>
      </div>

      <div class="row cols-2">
        <div class="chart-card">
          <div class="chart-head">
            <div class="muted">Vendas por Dia da Semana</div>
            <div class="pill" id="labWeek">Total</div>
          </div>
          <div class="chart-box"><canvas id="ch_semana"></canvas></div>
        </div>

        <div class="chart-card">
          <div class="chart-head">
            <div class="muted">Vendas por Categoria</div>
            <div class="note" id="note_cat">â€”</div>
          </div>
          <div class="chart-box"><canvas id="ch_cat"></canvas></div>
        </div>
      </div>

      <div class="chart-card" style="margin-top:10px">
        <div class="chart-head">
          <div class="muted">Vendas por MÃªs (Ãºltimos 12M vs. 12M anteriores)</div>
          <div class="pill" id="labMes">Total</div>
        </div>
        <div class="chart-box"><canvas id="ch_mes"></canvas></div>
      </div>
    </div>

    <div class="muted" style="margin-top:8px">Dica: clique em um KPI para ajustar todos os grÃ¡ficos para a mÃ©trica correspondente.</div>
  </div>

<script>
(function(){
  // ====== State ======
  const state = {
    raw: [],           // linhas brutas
    periodo: {de:null, ate:null},
    foco: 'total',     // 'total' | 'avg' | 'unique'
    filtros: {unids:new Set(), cats:new Set(), pratos:new Set(), onlyPratos:false},
  };

  const fmt = new Intl.NumberFormat('pt-BR');
  const fmtMoeda = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  const fmtDate = (d)=> dayjs(d).format('DD/MM/YYYY');

  const dom = (sel)=> document.querySelector(sel);

  // ====== Helpers ======
  function unique(arr){ return [...new Set(arr)]; }
  function groupBy(arr, keyFn){
    return arr.reduce((acc, row)=>{
      const k = keyFn(row); (acc[k]||(acc[k]=[])).push(row); return acc;
    },{});
  }
  function parseDate(v){
    // aceita Date, string ISO, dd/mm/yyyy
    if(!v) return null;
    if(v instanceof Date) return v;
    if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
      const [dd,mm,yy] = v.split('/').map(Number);
      return new Date(yy,mm-1,dd);
    }
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }

  // aplica filtro de estado
  function filterRows(rows){
    return rows.filter(r=>{
      if(state.periodo.de && parseDate(r.data) < state.periodo.de) return false;
      if(state.periodo.ate && parseDate(r.data) > state.periodo.ate) return false;
      if(state.filtros.onlyPratos && (r.categoria||'').toUpperCase()!=='PRATOS') return false;
      if(state.filtros.unids.size && !state.filtros.unids.has(r.unidade)) return false;
      if(state.filtros.cats.size && !state.filtros.cats.has(r.categoria)) return false;
      if(state.filtros.pratos.size && !state.filtros.pratos.has(r.prato)) return false;
      return true;
    });
  }

  function calcKPIs(rows){
    const qtdTotal = rows.reduce((s,r)=> s+(Number(r.qtd)||0), 0);
    const diasSet = new Set(rows.map(r=> fmtDate(parseDate(r.data))));
    const diasComVenda = [...diasSet].filter(d=> rows.some(r=> fmtDate(parseDate(r.data))===d && (Number(r.qtd)||0)>0 )).length || 1;
    const media = qtdTotal / diasComVenda;
    const unicos = new Set(rows.map(r=> r.prato)).size;
    return {total:qtdTotal, avg:media, unique:unicos};
  }

  function buildWeekSeries(rows, metric){
    const days = ['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
    const init = days.reduce((o,k)=> (o[k]=0,o), {});
    const g = rows.reduce((acc,r)=>{
      const d = new Date(parseDate(r.data));
      const k = days[d.getDay()];
      acc[k] = (acc[k]||0) + (Number(r.qtd)||0);
      return acc;
    }, {...init});
    if(metric==='avg'){
      // mÃ©dia por dia com venda em cada dia da semana
      const counts = rows.reduce((acc,r)=>{ const k = days[new Date(parseDate(r.data)).getDay()]; acc[k]=(acc[k]||0)+((Number(r.qtd)||0)>0?1:0); return acc; }, {...init});
      for(const k of days){ g[k] = counts[k] ? g[k]/counts[k] : 0; }
    }
    return days.map(k=> g[k]);
  }

  function buildMonthSeries(rows, metric){
    // Ãºltimos 12 meses e 12 meses anteriores (janela terminando em max data)
    const maxDate = rows.length ? rows.map(r=> parseDate(r.data)).reduce((a,b)=> a>b?a:b) : new Date();
    const end = dayjs(maxDate).endOf('month');
    const months = []; for(let i=11;i>=0;i--) months.push(end.subtract(i,'month'));
    function sumFor(month){
      const m = month.month(), y = month.year();
      const rowsM = rows.filter(r=>{ const d=parseDate(r.data); return d && d.getMonth()===m && d.getFullYear()===y; });
      if(metric==='avg'){
        // mÃ©dia por dia com venda no mÃªs
        const byDay = groupBy(rowsM, r=> fmtDate(parseDate(r.data)));
        const dias = Object.keys(byDay).length || 1;
        const tot = rowsM.reduce((s,r)=> s+(Number(r.qtd)||0), 0);
        return tot/dias;
      }
      return rowsM.reduce((s,r)=> s+(Number(r.qtd)||0), 0);
    }
    const now = months.map(m=> sumFor(m));
    const prev = months.map(m=> sumFor(m.subtract(1,'year')));
    const labels = months.map(m=> m.format('MMM/YY'));
    return {labels, now, prev};
  }

  function buildTop(rows, metric, asc=false){
    const byPrato = groupBy(rows, r=> r.prato||'â€”');
    const items = Object.entries(byPrato).map(([k,arr])=>{
      const tot = arr.reduce((s,r)=> s+(Number(r.qtd)||0), 0);
      let v = tot;
      if(metric==='avg'){
        const dias = new Set(arr.map(r=> fmtDate(parseDate(r.data)))).size || 1;
        v = tot/dias;
      }
      return {name:k, value:v};
    });
    items.sort((a,b)=> asc ? a.value-b.value : b.value-a.value);
    return items.slice(0,10);
  }

  function buildCat(rows, metric){
    const byCat = groupBy(rows, r=> r.categoria||'â€”');
    return Object.entries(byCat).map(([k,arr])=>{
      const tot = arr.reduce((s,r)=> s+(Number(r.qtd)||0), 0);
      let v = tot;
      if(metric==='avg'){
        const dias = new Set(arr.map(r=> fmtDate(parseDate(r.data)))).size || 1;
        v = tot/dias;
      }
      if(metric==='unique'){
        v = new Set(arr.map(r=> r.prato)).size;
      }
      return {name:k, value:v};
    }).sort((a,b)=> b.value-a.value);
  }

  // ====== Charts ======
  const charts = {};
  function ensureChart(id, cfg){
    if(charts[id]){ charts[id].destroy(); }
    charts[id] = new Chart(document.querySelector('#'+id), cfg);
  }

  function renderAll(){
    const rows = filterRows(state.raw);
    const k = calcKPIs(rows);
    document.querySelector('#k_total').textContent = fmt.format(Math.round(k.total));
    document.querySelector('#k_avg').textContent   = fmt.format(k.avg % 1 === 0 ? k.avg : k.avg.toFixed(2));
    document.querySelector('#k_unique').textContent= fmt.format(k.unique);

    // labels de pill
    document.querySelector('#labWeek').textContent = state.foco==='avg' ? 'MÃ©dia' : 'Total';
    document.querySelector('#labMes').textContent  = state.foco==='avg' ? 'MÃ©dia' : 'Total';

    // notas de mÃ©trica aplicÃ¡vel
    document.querySelector('#note_topmais').textContent  = state.foco==='unique' ? 'KPI "Itens Ãºnicos" nÃ£o se aplica â€” mostrando Totais.' : '';
    document.querySelector('#note_topmenos').textContent = state.foco==='unique' ? 'KPI "Itens Ãºnicos" nÃ£o se aplica â€” mostrando Totais.' : '';
    document.querySelector('#note_cat').textContent      = state.foco==='unique' ? 'Mostrando diversidade: quantidade de pratos distintos por categoria.' : '';

    // TOP 10 mais/menos
    const topMais = buildTop(rows, state.foco==='unique'?'total':state.foco,false);
    const topMenos= buildTop(rows, state.foco==='unique'?'total':state.foco,true);
    ensureChart('ch_top10_mais', {
      type:'bar',
      data:{
        labels: topMais.map(x=> x.name),
        datasets:[{label:'Atual', data: topMais.map(x=> x.value), backgroundColor:'rgba(123,30,58,0.9)'}]
      },
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
    ensureChart('ch_top10_menos', {
      type:'bar',
      data:{
        labels: topMenos.map(x=> x.name),
        datasets:[{label:'Atual', data: topMenos.map(x=> x.value), backgroundColor:'rgba(123,30,58,0.9)'}]
      },
      options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Semana (Atual x Anterior)
    const serieNowW = buildWeekSeries(rows, state.foco);
    // sÃ©rie anterior: subtrai 1 ano
    const rowsPrev = rows.map(r=> ({...r, data: dayjs(parseDate(r.data)).subtract(1,'year').toDate()}));
    const seriePrevW = buildWeekSeries(rowsPrev, state.foco);
    ensureChart('ch_semana', {
      type:'bar',
      data:{
        labels:['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'],
        datasets:[
          {label:'Atual', data:serieNowW, backgroundColor:'rgba(123,30,58,0.9)'},
          {label:'Anterior', data:seriePrevW, backgroundColor:'rgba(148,163,184,0.9)'}
        ]
      },
      options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
    });

    // Categoria (pizza)
    const cat = buildCat(rows, state.foco);
    ensureChart('ch_cat', {
      type:'pie',
      data:{
        labels:cat.map(c=>c.name),
        datasets:[{label:'', data:cat.map(c=>c.value), backgroundColor:[
          'rgba(123,30,58,0.95)','rgba(148,163,184,0.95)','rgba(123,30,58,0.65)',
          'rgba(148,163,184,0.65)','rgba(123,30,58,0.45)','rgba(148,163,184,0.45)',
          'rgba(123,30,58,0.25)','rgba(148,163,184,0.25)'
        ]}]
      },
      options:{responsive:true,plugins:{legend:{position:'top'}}}
    });

    // Meses (12M vs 12M anteriores)
    const m = buildMonthSeries(rows, state.foco);
    ensureChart('ch_mes', {
      type:'bar',
      data:{
        labels:m.labels,
        datasets:[
          {label:'Atual', data:m.now, backgroundColor:'rgba(123,30,58,0.9)'},
          {label:'Anterior', data:m.prev, backgroundColor:'rgba(148,163,184,0.9)'}
        ]
      },
      options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
    });

    // delta simples (total vs anterior)
    const totPrev = m.prev.reduce((a,b)=>a+b,0);
    const totNow  = m.now.reduce((a,b)=>a+b,0);
    const diffPct = totPrev ? ((totNow - totPrev)/totPrev)*100 : 0;
    const deltaEl = document.querySelector('#d_qtd');
    deltaEl.textContent = (diffPct>=0?'+':'') + diffPct.toFixed(1).replace('.',',') + '%';
    deltaEl.classList.toggle('up', diffPct>=0);
    deltaEl.classList.toggle('down', diffPct<0);
    document.querySelector('#p_total').textContent = fmt.format(Math.round(totPrev));
  }

  // ====== Multi-select UI ======
  function buildMSelect(el, values, selectedSet, placeholder){
    const btn = el.querySelector('.msel-btn');
    const panel = el.querySelector('.msel-panel');
    el.classList.remove('open'); panel.innerHTML='';
    const search = document.createElement('input'); search.placeholder='Buscarâ€¦'; search.className='msel-search';
    panel.appendChild(search);
    const optsWrap = document.createElement('div'); panel.appendChild(optsWrap);
    function render(list){
      optsWrap.innerHTML='';
      list.forEach(v=>{
        const o = document.createElement('label'); o.className='msel-opt';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = selectedSet.has(v); cb.dataset.val=v;
        const sp = document.createElement('span'); sp.textContent = v||'â€”';
        o.appendChild(cb); o.appendChild(sp); optsWrap.appendChild(o);
      });
    }
    render(values);
    search.addEventListener('input', ()=>{
      const q = search.value.toLowerCase();
      render(values.filter(v=> (v||'').toLowerCase().includes(q) ));
    });
    panel.addEventListener('change', (e)=>{
      if(e.target.type==='checkbox'){
        const v = e.target.dataset.val;
        if(e.target.checked) selectedSet.add(v); else selectedSet.delete(v);
        btn.textContent = selectedSet.size ? [...selectedSet].join(', ').slice(0,40) + (selectedSet.size>1?'â€¦':'') : placeholder;
        renderAll();
      }
    });
    btn.textContent = selectedSet.size ? [...selectedSet].join(', ').slice(0,40) + (selectedSet.size>1?'â€¦':'') : placeholder;
    btn.onclick = ()=> el.classList.toggle('open');
    document.addEventListener('click', (ev)=>{ if(!el.contains(ev.target)) el.classList.remove('open'); });
  }

  function refreshSelectors(){
    const rows = filterRows(state.raw.length?state.raw:sampleData);
    const unids = unique(rows.map(r=> r.unidade)).sort();
    const cats  = unique(rows.map(r=> r.categoria)).sort();
    const pratos= unique(rows.map(r=> r.prato)).sort();
    buildMSelect(document.querySelector('#ms-unids'), unids, state.filtros.unids, 'Todas');
    buildMSelect(document.querySelector('#ms-cats'),  cats,  state.filtros.cats,  'Todas');
    buildMSelect(document.querySelector('#ms-pratos'),pratos,state.filtros.pratos,'Todos');
  }

  // ====== CSV/XLSX upload ======
  function normalizeRow(obj){
    // aceita vÃ¡rias nomenclaturas comuns
    const keys = Object.fromEntries(Object.keys(obj).map(k=> [k.toLowerCase().trim(), k]));
    function pick(...cands){
      for(const c of cands){ if(keys[c]) return obj[keys[c]]; }
      return null;
    }
    const data = pick('data','date','dt','dia');
    const unidade = pick('unidade','loja','filial','store');
    const categoria = (pick('categoria','categoria_venda','cat')||'').toUpperCase();
    const prato = pick('prato','item','produto','descricao');
    const qtd = Number(pick('qtd','quantidade','qte','qtde','qtd_vendida'))||0;
    const valor = Number(pick('valor','total','receita','faturamento','venda'))||0;
    const turno = pick('turno','periodo')||'';
    const hora  = Number(pick('hora','hr','hh'))||null;
    return {data:parseDate(data)||new Date(), unidade, categoria, prato, qtd, valor, turno, hora};
  }

  function onFile(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {defval:''}).map(normalizeRow);
        state.raw = rows;
        document.querySelector('#uploadInfo').textContent = `${rows.length} linhas carregadas`;
        refreshSelectors();
        renderAll();
      }catch(err){
        console.error(err);
        alert('Erro ao ler o arquivo. Confira o formato.');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // ====== Sample data (fallback) ======
  const sampleData = (function(){
    const cats = ['PRATOS','ACOMPANHAMENTOS','BEBIDAS','SOBREMESAS','PROMOÃ‡Ã•ES','OUTROS'];
    const pratos = ['Strogonoff','Salada','Parmegiana','Burger','Frango grelhado','Coca-cola','Suco','Pudim','Brownie'];
    const unids = ['Uni.Raja','Uni.Savassi'];
    const rows = [];
    const today = dayjs();
    for(let i=0;i<365;i++){
      const dia = today.subtract(i,'day');
      unids.forEach(u=>{
        // 60% dos dias com venda
        if(Math.random()>0.4){
          for(let j=0;j<5;j++){
            const cat = cats[Math.floor(Math.random()*cats.length)];
            const p   = pratos[Math.floor(Math.random()*pratos.length)];
            const qtd = Math.floor(Math.random()*25)+1;
            rows.push({data:dia.toDate(), unidade:u, categoria:cat, prato:p, qtd, valor:qtd*20, turno: (Math.random()>0.5?'Dia':'Noite'), hora: 10+Math.floor(Math.random()*12)});
          }
        }
      });
    }
    return rows;
  })();

  // ====== Events & init ======
  function setPeriodoRapido(dias){
    const ate = new Date(); const de = dayjs(ate).subtract(dias-1,'day').startOf('day').toDate();
    state.periodo = {de, ate};
    document.querySelector('#fDe').valueAsDate = de; document.querySelector('#fAte').valueAsDate = ate;
    document.querySelector('#periodoInfo').textContent = `Ãšltimo dia carregado: ${dayjs(ate).format('DD/MM/YYYY')}`;
  }

  function readPeriodoInputs(){
    const de = document.querySelector('#fDe').value ? new Date(document.querySelector('#fDe').value+'T00:00:00') : null;
    const ate= document.querySelector('#fAte').value ? new Date(document.querySelector('#fAte').value+'T23:59:59') : null;
    state.periodo = {de, ate};
    renderAll();
  }

  // KPI clicking behavior
  function markActiveKPI(){
    document.querySelectorAll('.kpi').forEach(k=> k.classList.toggle('active', k.dataset.metric===state.foco));
  }

  function init(){
    // defaults
    state.raw = sampleData;
    setPeriodoRapido(30);
    refreshSelectors();
    renderAll();
    markActiveKPI();

    // inputs
    document.querySelectorAll('.chip').forEach(ch=> ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip').forEach(x=> x.classList.remove('active'));
      ch.classList.add('active'); setPeriodoRapido(Number(ch.dataset.q)); renderAll();
    }));
    document.querySelector('#fDe').addEventListener('change', readPeriodoInputs);
    document.querySelector('#fAte').addEventListener('change', readPeriodoInputs);
    document.querySelector('#onlyPratos').addEventListener('change', (e)=>{ state.filtros.onlyPratos = e.target.checked; renderAll(); });

    // upload
    document.querySelector('#btnUpload').addEventListener('click', ()=> document.querySelector('#fileExcel').click());
    document.querySelector('#fileExcel').addEventListener('change', (e)=>{ if(e.target.files[0]) onFile(e.target.files[0]); });

    // KPI click => muda foco
    document.querySelectorAll('.kpi').forEach(k=> k.addEventListener('click', ()=>{
      state.foco = k.dataset.metric;
      markActiveKPI();
      renderAll();
    }));
  }

  // start
  window.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
