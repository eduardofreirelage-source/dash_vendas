<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dash de Vendas — Diagnóstico (REST + OpenAPI)</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --accent:#2d6cdf;
    --ok:#16a34a;
    --err:#b91c1c;
    --chip:#eef2ff;
    --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  header{position:sticky;top:0;z-index:2;background:#fff;border-bottom:1px solid var(--border);}
  .bar{max-width:1100px;margin:auto;display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem}
  .tabs a{display:inline-block;padding:.4rem .7rem;border-radius:.6rem;text-decoration:none;color:var(--muted)}
  .tabs a.active{background:var(--ink);color:#fff}
  h1{font-size:22px;margin:0 0 .4rem 0}
  main{max-width:1100px;margin:20px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:920px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
  .card h2{font-size:16px;margin:0 0 10px 0}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input[type="text"],input[type="date"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit}
  input[type="checkbox"]{transform:translateY(1px)}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:780px){ .row{grid-template-columns:1.2fr 1fr 1fr} }
  .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border);background:#fff;padding:.55rem .85rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
  .btn.ghost{background:#fff}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{border-radius:100px;padding:.35rem .6rem;background:var(--chip);border:1px solid #c7d2fe;color:#3730a3;font-size:12px}
  .chip[data-sel="1"]{background:#1e293b;color:#fff;border-color:#1e293b}
  .muted{color:var(--muted)}
  .kpi{display:flex;gap:20px}
  .kpi div{background:var(--card);border:1px solid var(--border);padding:14px;border-radius:12px;flex:1}
  .kpi b{display:block;font-size:18px;margin-top:6px}
  .log{background:#0b1220;color:#e2e8f0;padding:12px;border-radius:10px;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;min-height:54px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
  th{font-size:12px;color:var(--muted)}
  tfoot td{color:var(--muted)}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div style="font-weight:600">Dash de Vendas</div>
      <nav class="tabs" aria-label="Seções">
        <a href="#" class="active">Diagnóstico</a>
        <a href="#" title="Exemplo visual (não funcional)">Principal</a>
        <a href="#" title="Exemplo visual (não funcional)">Cadastros</a>
      </nav>
      <div style="margin-left:auto" class="muted">Versão de Diagnóstico (REST + OpenAPI)</div>
    </div>
  </header>

  <main>
    <section class="grid">
      <div class="card">
        <h2>Diagnóstico (REST + OpenAPI)</h2>
        <div class="row">
          <div>
            <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
            <input id="inpUrl" type="text" placeholder="https://xxxxx.supabase.co">
            <div class="hint"><label><input id="chkPublic" type="checkbox"> Somente <code>schema public</code>?</label></div>
          </div>
          <div>
            <label>Anon Key</label>
            <input id="inpKey" type="text" placeholder="ey...">
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button id="btnOpenApi" class="btn primary">Descobrir tabelas e colunas (OpenAPI)</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Tabela de vendas (use <code>schema.tabela</code> se necessário)</label>
            <input id="inpTable" type="text" placeholder="ex.: public.vendas_xlsx">
          </div>
          <div>
            <label>Coluna de data</label>
            <input id="inpDateCol" type="text" placeholder="ex.: dia / data / dt / dh / created_at / hora">
          </div>
          <div>
            <label>Coluna de valor (opcional)</label>
            <input id="inpValueCol" type="text" placeholder="ex.: total / valor_total / receita">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Coluna de cancelado (opcional)</label>
            <input id="inpCanceledCol" type="text" placeholder="ex.: cancelado / status">
          </div>
          <div>
            <label>Início</label>
            <input id="inpStart" type="date">
          </div>
          <div>
            <label>Fim</label>
            <input id="inpEnd" type="date">
          </div>
        </div>

        <div class="chips" id="chips"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnCount" class="btn">Contar registros (Content-Range)</button>
          <button id="btnSample" class="btn ghost">Carregar amostra</button>
          <button id="btnSave" class="btn ghost" title="Gravar no navegador">Salvar</button>
        </div>

        <div style="margin-top:10px">
          <div class="log" id="log" aria-live="polite">Pronto.</div>
          <div class="hint">Dicas: a contagem via <code>HEAD</code> usa <code>?select=id</code> e cabeçalho <code>Prefer: count=exact</code>. Se a coluna de data ficar vazia, nenhuma filtragem por período será aplicada.</div>
        </div>
      </div>

      <div class="card">
        <h2>Amostra de dados</h2>
        <div style="overflow:auto;max-height:520px">
          <table id="tbl">
            <thead></thead>
            <tbody></tbody>
            <tfoot><tr><td class="muted">—</td></tr></tfoot>
          </table>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  // ---------- util ----------
  const $ = (sel)=>document.querySelector(sel);
  const log = (msg, kind="info") => {
    const el = $('#log');
    const now = new Date();
    const stamp = now.toTimeString().slice(0,8);
    const tag = kind==="error" ? "[ERRO]" : (kind==="ok" ? "[OK]" : "");
    el.textContent += `\\n[${stamp}] ${tag} ${msg}`;
    el.scrollTop = el.scrollHeight;
  };
  const setLog = (msg)=>{ $('#log').textContent = msg; };

  const normalizeBaseUrl = (u)=>{
    if(!u) return "";
    let s = u.trim().replace(/\\/$/, ""); // remove trailing /
    // force https://xxxx.supabase.co
    if(!/^https?:\\/\\//i.test(s)) s = "https://" + s;
    return s;
  };

  const cfgKey = "dash_vendas_cfg_v2";
  const saveCfg = () => {
    const cfg = {
      url: normalizeBaseUrl($('#inpUrl').value),
      key: $('#inpKey').value.trim(),
      table: $('#inpTable').value.trim(),
      dateCol: $('#inpDateCol').value.trim(),
      valueCol: $('#inpValueCol').value.trim(),
      canceledCol: $('#inpCanceledCol').value.trim(),
      onlyPublic: $('#chkPublic').checked,
      start: $('#inpStart').value,
      end: $('#inpEnd').value
    };
    localStorage.setItem(cfgKey, JSON.stringify(cfg));
    log("Config salva.");
    return cfg;
  };
  const loadCfg = () => {
    try{
      const cfg = JSON.parse(localStorage.getItem(cfgKey) || "{}");
      if(cfg.url) $('#inpUrl').value = cfg.url;
      if(cfg.key) $('#inpKey').value = cfg.key;
      if(cfg.table) $('#inpTable').value = cfg.table;
      if(cfg.dateCol) $('#inpDateCol').value = cfg.dateCol;
      if(cfg.valueCol) $('#inpValueCol').value = cfg.valueCol;
      if(cfg.canceledCol) $('#inpCanceledCol').value = cfg.canceledCol;
      if(typeof cfg.onlyPublic === "boolean") $('#chkPublic').checked = cfg.onlyPublic;
      if(cfg.start) $('#inpStart').value = cfg.start;
      if(cfg.end) $('#inpEnd').value = cfg.end;
    }catch(e){/* ignore */}
  };

  const headers = (anon) => ({
    "apikey": anon,
    "Authorization": "Bearer " + anon,
    "Accept-Profile": "public",
  });

  const openApiHeaders = (anon, onlyPublic) => ({
    "apikey": anon,
    "Authorization": "Bearer " + anon,
    "Accept": "application/openapi+json",
    ...(onlyPublic ? {"Accept-Profile":"public"} : {}),
  });

  const chipContainer = $('#chips');
  const setChips = (tables, selected) => {
    chipContainer.innerHTML = "";
    tables.forEach(t => {
      const b = document.createElement('button');
      b.className = "chip";
      b.type="button";
      b.textContent = t;
      if (selected && selected === t) b.dataset.sel = "1";
      b.onclick = ()=> { $('#inpTable').value = t; setChips(tables, t); };
      chipContainer.appendChild(b);
    });
  };

  const parseTablesFromOpenApi = (spec, onlyPublic) => {
    // Supabase OpenAPI paths include entries like "/table" or "/schema.table"
    const paths = (spec && spec.paths) ? Object.keys(spec.paths) : [];
    const names = [];
    for(const p of paths){
      if(p.startsWith("/rpc/")) continue; // skip functions
      const name = p.replace(/^\\//,"");
      // ignore special and root
      if(!name || name==="") continue;
      // Prefer only public if requested
      if(onlyPublic && name.includes(".") && !name.startsWith("public.")) continue;
      names.push(name);
    }
    // unique + sorted
    return Array.from(new Set(names)).sort((a,b)=>a.localeCompare(b));
  };

  const buildFilterByDate = (dateCol, start, end) => {
    if(!dateCol) return "";
    const enc = encodeURIComponent;
    // Add end as < end (day after) if end given
    let q = "";
    if(start) q += `&${enc(dateCol)}=gte.${start}`;
    if(end){
      // comparison is lt end+1 day to include the full last day when column is date/datetime
      const d = new Date(end + "T00:00:00Z");
      d.setUTCDate(d.getUTCDate() + 1);
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,"0");
      const da = String(d.getUTCDate()).padStart(2,"0");
      q += `&${enc(dateCol)}=lt.${y}-${m}-${da}`;
    }
    return q;
  };

  const buildUrl = ({base, table, select="*", dateCol, start, end, limit, orderCol}) => {
    const enc = encodeURIComponent;
    let url = `${base}/rest/v1/${table}?select=${enc(select)}`;
    url += buildFilterByDate(dateCol, start, end);
    if(orderCol) url += `&order=${enc(orderCol)}.asc.nullslast`;
    if(limit) url += `&limit=${encodeURIComponent(String(limit))}`;
    return url;
  };

  // ---------- actions ----------
  $('#btnOpenApi').onclick = async ()=>{
    const cfg = saveCfg();
    const base = normalizeBaseUrl(cfg.url);
    if(!base || !cfg.key){ setLog("Informe URL e Anon Key."); return; }
    setLog("Carregando OpenAPI...");
    try{
      const res = await fetch(`${base}/rest/v1/`, { headers: openApiHeaders(cfg.key, cfg.onlyPublic) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const spec = await res.json();
      const tables = parseTablesFromOpenApi(spec, cfg.onlyPublic);
      setChips(tables, cfg.table && tables.includes(cfg.table) ? cfg.table : "");
      setLog(`OpenAPI OK. ${tables.length} tabelas vistas.`);
      if(!$('#inpTable').value && tables.length) $('#inpTable').value = tables[0];
    }catch(err){
      log("Falha ao obter OpenAPI: " + err.message, "error");
    }
  };

  $('#btnSave').onclick = ()=> saveCfg();

  $('#btnCount').onclick = async ()=>{
    const cfg = saveCfg();
    const base = normalizeBaseUrl(cfg.url);
    if(!base || !cfg.key){ setLog("Informe URL e Anon Key."); return; }
    if(!cfg.table){ setLog("Informe tabela."); return; }
    const url = buildUrl({base, table: cfg.table, select: "id", dateCol: cfg.dateCol, start: cfg.start, end: cfg.end, limit: 0});
    setLog("HEAD " + url);
    try{
      const res = await fetch(url, { method:"HEAD", headers: {...headers(cfg.key), "Prefer":"count=exact"} });
      const cr = res.headers.get("Content-Range") || "";
      if(res.ok && cr){
        const total = (cr.split("/")[1]||"0").replace(/\\D/g,"") || "0";
        log(`Total via Content-Range: ${total}`, "ok");
      }else{
        log(`Sem Content-Range; tentando GET (Range: 0-0).`);
        const res2 = await fetch(url, { method:"GET", headers: {...headers(cfg.key), "Prefer":"count=exact"},  });
        const cr2 = res2.headers.get("Content-Range") || "";
        if(res2.ok && cr2){
          const total = (cr2.split("/")[1]||"0").replace(/\\D/g,"") || "0";
          log(`Total via Content-Range (GET): ${total}`, "ok");
        }else{
          throw new Error(`HTTP ${res.status}. Content-Range ausente.`);
        }
      }
    }catch(err){
      log("Erro no count: " + err.message, "error");
    }
  };

  $('#btnSample').onclick = async ()=>{
    const cfg = saveCfg();
    const base = normalizeBaseUrl(cfg.url);
    if(!base || !cfg.key){ setLog("Informe URL e Anon Key."); return; }
    if(!cfg.table){ setLog("Informe tabela."); return; }
    const url = buildUrl({base, table: cfg.table, select: "*", dateCol: cfg.dateCol, start: cfg.start, end: cfg.end, orderCol: cfg.dateCol || "id", limit: 50});
    setLog("GET " + url);
    try{
      const res = await fetch(url, { headers: headers(cfg.key) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      renderTable(data);
      log(`Amostra carregada: ${data.length} linhas.`, "ok");
    }catch(err){
      log("Erro ao carregar amostra: " + err.message, "error");
    }
  };

  function renderTable(rows){
    const thead = document.querySelector("#tbl thead");
    const tbody = document.querySelector("#tbl tbody");
    const tfoot = document.querySelector("#tbl tfoot td");

    if(!rows || !rows.length){
      thead.innerHTML = "";
      tbody.innerHTML = "";
      tfoot.textContent = "Sem dados para exibir.";
      return;
    }
    const cols = Object.keys(rows[0]);
    thead.innerHTML = "<tr>" + cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("") + "</tr>";
    tbody.innerHTML = rows.map(r=>"<tr>"+cols.map(c=>`<td>${escapeHtml(formatCell(r[c]))}</td>`).join("")+"</tr>").join("");
    tfoot.textContent = rows.length + " linha(s) — mostras as primeiras 50.";
  }

  function escapeHtml(s){
    if(s===null || s===undefined) return "";
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function formatCell(v){
    if(v===null || v===undefined) return "";
    if(typeof v==="object") return JSON.stringify(v);
    return v;
  }

  // Default dates: last 30d
  (function setDefaultDates(){
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate()-30);
    const f = (d)=>d.toISOString().slice(0,10);
    $('#inpStart').value = f(start);
    $('#inpEnd').value = f(end);
  })();

  // Init
  loadCfg();
  setLog("Pronto.\\n• Preencha URL e Anon Key.\\n• Clique em 'Descobrir tabelas' para listar endpoints.\\n• Informe tabela e (opcionalmente) coluna de data.\\n• Use 'Contar registros' ou 'Carregar amostra'.");
})();
</script>
</body>
</html>
