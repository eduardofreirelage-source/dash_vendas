<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dash de Vendas — Diagnóstico (fix)</title>
  <style>
    :root{--bg:#f7f7fb;--panel:#fff;--muted:#8a8f98;--ink:#0f172a;--accent:#0ea5e9;--ok:#16a34a;--warn:#b91c1c;--line:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1160px;margin:24px auto;padding:0 16px}
    header h1{font-size:28px;margin:0 0 12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:16px}
    .toolbar input,.toolbar select{height:36px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;color:var(--ink)}
    .tabs{display:flex;gap:8px;margin:8px 0 16px}
    .tabs button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .tabs .active{background:var(--ink);color:#fff}
    .kpi{font-size:40px;font-weight:800;margin:8px 0}
    .delta{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px}
    .delta.up{background:#e8f7ee;color:#15803d}.delta.down{background:#fde2e2;color:#b91c1c}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .ins-list{display:grid;gap:8px}
    .ins-card{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:14px;border:1px solid var(--line)}
    .ins-card.up{background:#f0fdf4}.ins-card.down{background:#fef2f2}
    .dot{width:10px;height:10px;border-radius:50%}
    .ins-card.up .dot{background:#16a34a}.ins-card.down .dot{background:#b91c1c}
    .proj{display:flex;gap:24px;align-items:center}
    .proj .big{font-size:28px;font-weight:800}
    .pill{background:#f3f4f6;color:#111827;border-radius:999px;padding:4px 8px;font-size:12px}
    .footer{display:flex;justify-content:space-between;align-items:center}
    .btn{height:32px;padding:0 12px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Dash de Vendas</h1>
    </header>

    <div class="tabs"><button class="btn" id="tabMain">Principal</button><button class="btn active">Diagnóstico</button></div>

    <div class="toolbar">
      <label>Início <input id="dtIni" type="date"></label>
      <label>Fim <input id="dtFim" type="date"></label>
      <label>Cancelado 
        <select id="cancelado">
          <option value="all">Todos</option>
          <option value="false">Não</option>
          <option value="true">Sim</option>
        </select>
      </label>
      <label>KPI 
        <select id="kpiSel">
          <option value="fat">Faturamento</option>
          <option value="ped">Pedidos</option>
          <option value="ticket">Ticket Médio</option>
          <option value="desc">Desconto (R$)</option>
        </select>
      </label>
    </div>

    <div class="panel">
      <div id="kpiLabel" class="muted">—</div>
      <div class="kpi" id="kpiValue">—</div>
      <div class="muted">Período anterior: <span id="prevValue">—</span> <span id="delta" class="delta" style="display:none"></span></div>
      <div class="muted" id="highlights" style="margin-top:6px"></div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="muted" style="margin-bottom:8px">Insights</div>
        <div class="ins-list" id="ins"></div>
      </div>
      <div class="panel">
        <div class="muted" style="margin-bottom:8px">Projeções</div>
        <div class="proj">
          <div>
            <div class="muted">Receita projetada (30d)</div>
            <div class="big" id="proj_value">—</div>
          </div>
          <div>
            <div class="muted">Pedidos</div>
            <div class="big" id="proj_ped">—</div>
          </div>
          <div>
            <div class="muted">Ticket Médio</div>
            <div class="big" id="proj_ticket">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel footer">
      <div><strong>Teste de Paginação (Diagnóstico)</strong> — Total via HEAD: <span id="headTotal" class="mono">—</span></div>
      <button id="btnTest" class="btn">Rodar teste</button>
    </div>
  </div>

  <script>
  // ==== CONFIG SUPABASE (use os seus valores) ====
  const SUPABASE_URL = "https://msmyfxgrnuusnvoqyeuo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U";
  // Endpoints candidatos (tabela ou view). O primeiro que responder OK será usado.
  const DX_ENDPOINTS = [
    "/rest/v1/vendas",
    "/rest/v1/vw_vendas",
    "/rest/v1/sales",
    "/rest/v1/vendas_diario"
  ];
  // Possíveis colunas de data/tempo (tentamos na ordem).
  const DATE_COLS = [
    {name:"dt", type:"date"},
    {name:"data", type:"date"},
    {name:"dh", type:"ts"},
    {name:"created_at", type:"ts"},
    {name:"hora", type:"ts"}
  ];

  // ==== Helpers ====
  const $ = (sel) => document.querySelector(sel);
  const fmtBRL = (v) => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtInt = (v) => (Number(v)||0).toLocaleString('pt-BR');
  const todayISO = () => new Date().toISOString().slice(0,10);
  const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };

  // Mapeia campos de uma linha
  function getFat(o){
    const k = ["fat","faturamento","valor","total","venda_total","vlr"];
    for (let i=0;i<k.length;i++){ const v=o[k[i]]; if (v!=null) return Number(v)||0; }
    return 0;
  }
  function getPed(o){
    const k = ["ped","qtd","n","qte","quantidade","itens","num_pedidos"];
    for (let i=0;i<k.length;i++){ const v=o[k[i]]; if (v!=null) return Number(v)||0; }
    // se a linha representa um pedido, cair como 1
    return 1;
  }
  function getDesc(o){
    const k = ["desc","desconto","vl_desconto","discount"];
    for (let i=0;i<k.length;i++){ const v=o[k[i]]; if (v!=null) return Number(v)||0; }
    return 0;
  }

  // Detecta endpoint + coluna de data válidos via HEAD
  async function detectRouteAndDateRange(dtIni, dtFim){
    const start = dtIni;
    const end = dtFim;
    const headers = {
      "apikey": SUPABASE_KEY,
      "Authorization": "Bearer " + SUPABASE_KEY,
      "Range": "0-0",
      "Prefer": "count=exact"
    };
    for (let e=0;e<DX_ENDPOINTS.length;e++){
      const base = SUPABASE_URL + DX_ENDPOINTS[e] + "?select=id";
      for (let d=0; d<DATE_COLS.length; d++){
        const col = DATE_COLS[d];
        const suffix = (col.type==="ts") ? "T00:00:00" : "";
        const url = `${base}&${col.name}=gte.${start}${suffix}&${col.name}=lt.${end}${suffix}`;
        try {
          const res = await fetch(url, {method:"HEAD", headers});
          if (res.ok){
            const cr = res.headers.get("content-range") || "";
            return { endpoint: DX_ENDPOINTS[e], dateCol: col.name, type: col.type, headTotal: parseInt((cr.split("/")[1]||"0"),10) || 0 };
          }
        } catch (err){ /* tenta próximo */ }
      }
    }
    // fallback: sem data
    return { endpoint: DX_ENDPOINTS[0], dateCol: null, type: "date", headTotal: 0 };
  }

  // Faz paginação usando Range: a-b (1000 registros por página)
  async function fetchPaged(endpoint, dateCol, type, dtIni, dtFim, canceladoSel){
    const page = 1000;
    let data = [];
    const hdr = { "apikey": SUPABASE_KEY, "Authorization": "Bearer "+SUPABASE_KEY, "Prefer": "count=exact" };
    const base = new URL(SUPABASE_URL + endpoint);
    base.searchParams.set("select", "*");
    // filtros
    if (dateCol){
      const suffix = (type==="ts")? "T00:00:00" : "";
      base.searchParams.set(dateCol + "=", ""); // placeholder para impedir repetição
      base.searchParams.delete(dateCol + "=");
      base.searchParams.set(dateCol + "gte", dtIni + suffix);
      base.searchParams.set(dateCol + "lt", dtFim + suffix);
    }
    if (canceladoSel === "true"){ base.searchParams.set("cancelado", "eq.true"); }
    else if (canceladoSel === "false"){ base.searchParams.set("cancelado", "eq.false"); }

    // HEAD para total
    const head = await fetch(base.toString(), { method:"HEAD", headers:{...hdr, "Range":"0-0"} });
    const cr = head.headers.get("content-range") || "*/0";
    const total = parseInt(cr.split("/")[1]||"0",10) || 0;
    $("#headTotal").textContent = fmtInt(total);

    if (total === 0) return data;
    const pages = Math.ceil(total / page);
    for (let i=0;i<pages;i++){
      const from = i*page;
      const to = Math.min(from + page - 1, total-1);
      const res = await fetch(base.toString(), { headers:{...hdr, "Range": `${from}-${to}`} });
      if (!res.ok) throw new Error("Falha REST página " + i);
      const rows = await res.json();
      data.push(...rows);
    }
    return data;
  }

  function groupByDay(rows, dateCol){
    const out = {};
    for (const r of rows){
      let d;
      if (dateCol && r[dateCol]){
        d = String(r[dateCol]).slice(0,10);
      }else{
        // fallback: tenta campos comuns
        const k = ["dt","data","dh","created_at","hora"];
        let val = null;
        for (const c of k){ if (r[c]) { val = r[c]; break; } }
        d = val ? String(val).slice(0,10) : "";
      }
      if (!d) continue;
      if (!out[d]) out[d] = {fat:0,ped:0,desc:0};
      out[d].fat += getFat(r);
      out[d].ped += getPed(r);
      out[d].desc += getDesc(r);
    }
    return out;
  }

  function calcKPI(rows, kpi){
    let fat=0, ped=0, desc=0;
    for (const r of rows){ fat+=getFat(r); ped+=getPed(r); desc+=getDesc(r); }
    if (kpi==="fat") return {v:fat, fmt:fmtBRL(fat)};
    if (kpi==="ped") return {v:ped, fmt:fmtInt(ped)};
    if (kpi==="ticket"){ const t = ped>0? fat/ped : 0; return {v:t, fmt:fmtBRL(t)}; }
    if (kpi==="desc") return {v:desc, fmt:fmtBRL(desc)};
    return {v:0, fmt:"—"};
  }

  function renderDelta(curV, prevV){
    const el = $("#delta");
    if (!el) return;
    if (prevV<=0){ el.style.display="none"; return; }
    const d = (curV - prevV)/prevV;
    el.style.display="";
    el.className = "delta " + (d>=0? "up":"down");
    el.textContent = (d>=0? "▲ ":"▼ ") + Math.abs(d*100).toFixed(1).replace(".", ",") + "%";
  }

  function renderInsights(byDay){
    const box = $("#ins");
    box.innerHTML = "";
    const days = Object.keys(byDay).sort();
    if (!days.length){ box.innerHTML = '<div class="muted">Sem dados no período.</div>'; return; }
    const last = days.slice(-28);
    // aceleração (fat em janelas)
    const sum = (keys, field) => keys.reduce((s,k)=> s + (byDay[k]?.[field]||0), 0);
    const nowFat = sum(last,"fat");
    const prevFat = sum(days.slice(-56,-28), "fat");
    const up = nowFat>=prevFat;
    const c1 = document.createElement("div"); c1.className="ins-card "+(up?"up":"down");
    c1.innerHTML = `<div class="dot"></div><div><div><strong>${up?"Aceleração":"Desaceleração"} nas últimas 4 semanas</strong></div>
    <div class="muted">Base: receita 28d vs. 28d anteriores.</div></div>`;
    box.appendChild(c1);
  }

  function renderProj(byDay, pedTotal, fatTotal){
    const days = Object.keys(byDay).sort();
    const tail = days.slice(-28);
    const sum = (keys, field) => keys.reduce((s,k)=> s + (byDay[k]?.[field]||0), 0);
    const nowFat = sum(tail,"fat");
    const nowPed = sum(tail,"ped");
    const N = Math.max(1, tail.length);
    const mmFat = nowFat / N;
    const mmPed = nowPed / N;
    $("#proj_value").textContent = fmtBRL(mmFat*30);
    $("#proj_ped").textContent = fmtInt(Math.round(mmPed*30));
    const tk = pedTotal>0? fatTotal/pedTotal : 0;
    $("#proj_ticket").textContent = fmtBRL(tk);
  }

  async function run(){
    // datas padrão: último mês
    const ini = $("#dtIni").value || addDays(todayISO(), -30);
    const fim = $("#dtFim").value || todayISO();
    $("#dtIni").value = ini; $("#dtFim").value = fim;

    const kpi = $("#kpiSel").value;
    $("#kpiLabel").textContent = $("#kpiSel").selectedOptions[0].textContent;

    const route = await detectRouteAndDateRange(ini, addDays(fim,1));
    $("#headTotal").textContent = fmtInt(route.headTotal);

    const rows = await fetchPaged(route.endpoint, route.dateCol, route.type, ini, addDays(fim,1), $("#cancelado").value);

    // Total atual
    const k = calcKPI(rows, kpi);
    $("#kpiValue").textContent = k.fmt;

    // Período anterior com mesma duração:
    const dur = Math.max(1, Math.ceil((new Date(addDays(fim,1)) - new Date(ini))/86400000));
    const prevIni = addDays(ini, -dur), prevFim = ini;
    const rowsPrev = await fetchPaged(route.endpoint, route.dateCol, route.type, prevIni, prevFim, $("#cancelado").value);
    const kPrev = calcKPI(rowsPrev, kpi);
    $("#prevValue").textContent = kPrev.fmt;
    renderDelta(k.v, kPrev.v);

    // Destaques básicos
    $("#highlights").textContent = "Destaques: — (dados reais, sem amostras).";

    // Projeções + insights
    const byDay = groupByDay(rows, route.dateCol);
    const totFat = rows.reduce((s,r)=>s+getFat(r),0);
    const totPed = rows.reduce((s,r)=>s+getPed(r),0);
    renderProj(byDay, totPed, totFat);
    renderInsights(byDay);
  }

  $("#btnTest").addEventListener("click", async ()=>{
    const ini = $("#dtIni").value || addDays(todayISO(), -30);
    const fim = $("#dtFim").value || todayISO();
    const route = await detectRouteAndDateRange(ini, addDays(fim,1));
    $("#headTotal").textContent = fmtInt(route.headTotal);
    alert("HEAD total = " + route.headTotal);
  });
  // roda no load
  run().catch(err=>{
    console.error("[DX] Falha geral", err);
    alert("Erro ao carregar diagnóstico: " + (err.message||err));
  });
  </script>
</body>
</html>
