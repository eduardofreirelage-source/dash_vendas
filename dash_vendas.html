<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DASHBOARD EXECUTIVO ‚Äî CFO v9.5 (Compacto + Accordion + Gr√°ficos Estrat√©gicos)</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">CFO</text></svg>'/>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --ink:#0b1220; --muted:#667085; --line:#e6e7eb; --pri:#7b1e3a;
      --ok:#10b981; --down:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:12px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    .dashboard{display:flex;min-height:100vh}
    /* Painel lateral de filtros */
    .filter-panel{width:280px;background:#fff;border-right:1px solid var(--line);padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    .filter-panel h2{margin:0 0 10px 0;font-size:18px;display:flex;align-items:center;gap:8px}
    .filter-section{margin-bottom:12px}
    .filter-section-title{font-size:14px;font-weight:700;margin:0 0 8px 0}
    /* Accordion */
    .acc{border-top:1px solid var(--line);padding-top:8px;margin-top:8px}
    .acc-head{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
    .acc-head-title{font-size:13px;font-weight:700}
    .acc .chev{width:14px;height:14px;transition:transform .2s}
    .acc:not(.open) .chev{transform:rotate(-90deg)}
    .acc-body{display:block;margin-top:8px}
    .acc:not(.open) .acc-body{display:none}
    /* Inputs */
    input[type="date"], .msel-btn{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:6px;background:#fff;min-height:34px;font-size:12px}
    .chips{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px}
    .chip{padding:6px 0;border:1px solid #efd5db;border-radius:6px;background:#fff;cursor:pointer;text-align:center;font-weight:700;color:#7b1e3a;font-size:12px}
    .chip.active{background:#7b1e3a;color:#fff;border-color:#7b1e3a}
    /* MultiSelect simples */
    .msel{position:relative}
    .msel-btn:after{content:"‚ñæ";float:right;color:#475569}
    .msel-panel{position:absolute;z-index:10;top:110%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:8px;box-shadow:0 10px 24px rgba(0,0,0,.08);max-height:250px;overflow:auto;padding:6px;display:none}
    .msel.open .msel-panel{display:block}
    .msel-search{width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;margin-bottom:6px}
    .msel-opt{display:flex;align-items:center;gap:8px;padding:5px;border-radius:6px;font-size:12px}
    .msel-opt:hover{background:#f3f4f6}
    /* A√ß√µes do painel */
    .filter-actions{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:6px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700;font-size:12px}
    .btn.primary{background:#7b1e3a;color:#fff;border-color:#7b1e3a}
    /* Conte√∫do principal */
    .main{flex:1;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:22px;letter-spacing:-.3px}
    .upload-bar{display:flex;align-items:center;gap:10px}
    .upload-info{font-size:11px;color:#334155}
    /* KPIs */
    .headline-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px}
    .kpi{position:relative;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:11px;box-shadow:0 1px 2px rgba(0,0,0,.03);cursor:pointer;transition:transform .15s, box-shadow .15s}
    .kpi:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .kpi.active{border-color:#7b1e3a;box-shadow:0 0 0 3px rgba(123,30,58,.08)}
    .kpi h4{margin:0 0 4px 0;font-size:12px;color:var(--muted);display:flex;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .kpi h4 .spacer{flex:1}
    .kpi .val{font-size:24px;font-weight:800;letter-spacing:-0.5px;line-height:1}
    .kpi .sub{font-size:11px;color:var(--muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:10px;margin-left:6px;background:rgba(148,163,184,.15);color:#6b7280}
    .delta.up{background:rgba(123,30,58,.10);border-color:rgba(123,30,58,.25);color:#7b1e3a}
    .delta.down{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.25);color:#ef4444}
    /* Painel de gr√°ficos */
    .analytics{display:grid;grid-template-columns:1fr 260px;gap:12px;margin-bottom:18px}
    .chart-card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:11px;display:flex;flex-direction:column;min-height:280px}
    .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .chart-title{font-weight:800;font-size:13px}
    .chart-box{position:relative;flex:1;min-height:260px}
    .chart-box canvas{width:100%;height:100%}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:6px;overflow:hidden}
    .seg button{padding:4px 8px;border:0;background:#fff;cursor:pointer;font-weight:700;font-size:11px}
    .seg button.active{background:#7b1e3a;color:#fff}
    /* Detalhes */
    .section-title{font-size:16px;font-weight:900;margin:0 0 10px 0;border-bottom:1px solid var(--line);padding-bottom:8px}
    .detail-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    .detail-charts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .center-link{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.95);border:1px solid var(--line);padding:2px 8px;border-radius:999px;cursor:pointer;font-weight:800;font-size:11px;color:#334155;white-space:nowrap}
    /* Responsivo */
    @media (max-width:1200px){
      .dashboard{flex-direction:column}
      .filter-panel{position:relative;height:auto}
      .analytics{grid-template-columns:1fr}
      .headline-kpis{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:768px){
      .detail-kpis,.detail-charts,.headline-kpis{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="filter-panel" id="filter-panel">
      <h2>üîé Painel de Filtros</h2>

      <div class="filter-section">
        <h3 class="filter-section-title">Per√≠odo</h3>
        <div class="acc open" id="acc-periodo">
          <div class="acc-head">
            <span class="acc-head-title">Per√≠odo</span>
            <svg class="chev" viewBox="0 0 20 20" fill="currentColor"><path d="M6 8l4 4 4-4"/></svg>
          </div>
          <div class="acc-body">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <div class="muted" style="margin-bottom:4px;font-size:11px">In√≠cio</div>
                <input type="date" id="fDe">
              </div>
              <div>
                <div class="muted" style="margin-bottom:4px;font-size:11px">Fim</div>
                <input type="date" id="fAte">
              </div>
            </div>
            <div class="chips">
              <button class="chip" data-q="7">7D</button>
              <button class="chip" data-q="15">15D</button>
              <button class="chip active" data-q="30">30D</button>
              <button class="chip" data-q="60">60D</button>
              <button class="chip" data-q="90">90D</button>
              <button class="chip" data-q="120">120D</button>
            </div>
            <div id="periodoInfo" class="muted" style="margin-top:6px;font-size:11px">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <h3 class="filter-section-title">Categorias</h3>
        <div class="acc" id="acc-categorias">
          <div class="acc-head">
            <span class="acc-head-title">Categorias</span>
            <svg class="chev" viewBox="0 0 20 20" fill="currentColor"><path d="M6 8l4 4 4-4"/></svg>
          </div>
          <div class="acc-body" style="display:grid;grid-template-columns:1fr;gap:8px">
            <div>
              <div class="muted" style="margin-bottom:4px;font-size:11px">Unidade</div>
              <div id="ms-unids" class="msel"><button class="msel-btn">Todas</button><div class="msel-panel"></div></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;font-size:11px">Nome da Loja</div>
              <div id="ms-lojas" class="msel"><button class="msel-btn">Todas</button><div class="msel-panel"></div></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;font-size:11px">Turno da Venda</div>
              <div id="ms-turnos" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;font-size:11px">Canal de Venda</div>
              <div id="ms-canais" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;font-size:11px">Tipo de Pagamento</div>
              <div id="ms-pags" class="msel"><button class="msel-btn">Todos</button><div class="msel-panel"></div></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;font-size:11px">Cancelado</div>
              <div id="ms-cancel" class="msel"><button class="msel-btn">N√£o</button>
                <div class="msel-panel">
                  <div class="msel-opt"><input type="checkbox" value=""><label>Todos</label></div>
                  <div class="msel-opt"><input type="checkbox" value="N√£o" checked><label>N√£o</label></div>
                  <div class="msel-opt"><input type="checkbox" value="Sim"><label>Sim</label></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-actions">
          <button id="btnClear" class="btn">‚úñ Limpar Filtros</button>
          <button id="btnUpload" class="btn primary">üì§ Carregar Excel</button>
          <input id="fileExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none">
          <div id="uploadInfo" class="upload-info" style="display:none"></div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="top">
        <h1>Dashboard Executivo</h1>
        <div class="upload-bar">
          <span id="status" class="muted">‚Äî</span>
          <span id="diag" class="upload-info"></span>
        </div>
      </div>

      <section class="headline-kpis">
        <div class="kpi active" data-kpi="fat"><h4><span>Faturamento</span><span class="spacer"></span><span id="d_fat" class="delta flat">‚Äî</span></h4><div class="val" id="k_fat">‚Äî</div><div class="sub">Anterior: <span id="p_fat">‚Äî</span></div></div>
        <div class="kpi" data-kpi="ped"><h4><span>Pedidos</span><span class="spacer"></span><span id="d_ped" class="delta flat">‚Äî</span></h4><div class="val" id="k_ped">‚Äî</div><div class="sub">Anterior: <span id="p_ped">‚Äî</span></div></div>
        <div class="kpi" data-kpi="tkt"><h4><span>Ticket M√©dio</span><span class="spacer"></span><span id="d_tkt" class="delta flat">‚Äî</span></h4><div class="val" id="k_tkt">‚Äî</div><div class="sub">Anterior: <span id="p_tkt">‚Äî</span></div></div>
        <div class="kpi" data-kpi="des"><h4><span>Incentivos</span><span class="spacer"></span><span id="d_des" class="delta flat">‚Äî</span></h4><div class="val" id="k_des">‚Äî</div><div class="sub">Anterior: <span id="p_des">‚Äî</span></div></div>
      </section>

      <section class="analytics">
        <div class="chart-card">
          <div class="chart-head">
            <div class="chart-title" id="title_month">Vendas por m√™s ‚Äî √∫ltimos 12M vs. 12M anteriores</div>
            <div id="segGlobal" class="seg"><button class="seg-btn active" data-mode="total">Total</button><button class="seg-btn" data-mode="media">M√©dia</button></div>
          </div>
          <div class="chart-box"><canvas id="ch_month"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-head"><div class="chart-title" id="title_turno">Vendas por turno</div></div>
          <div class="chart-box"><canvas id="ch_turno"></canvas></div>
        </div>
      </section>

      <section>
        <h2 class="section-title">M√©tricas Operacionais e Detalhamento</h2>
        <div class="detail-kpis">
          <div class="kpi" data-kpi="fatmed"><h4><span>Faturamento M√©dio</span><span class="spacer"></span><span id="d_fatmed" class="delta flat">‚Äî</span></h4><div class="val" id="k_fatmed">‚Äî</div><div class="sub">Anterior: <span id="p_fatmed">‚Äî</span></div></div>
          <div class="kpi" data-kpi="roi"><h4><span>ROI</span><span class="spacer"></span><span id="d_roi" class="delta flat">‚Äî</span></h4><div class="val" id="k_roi">‚Äî</div><div class="sub">Anterior: <span id="p_roi">‚Äî</span></div></div>
          <div class="kpi" data-kpi="canc_val"><h4><span>Valor Cancelado</span><span class="spacer"></span><span id="d_canc_val" class="delta flat">‚Äî</span></h4><div class="val" id="k_canc_val">‚Äî</div><div class="sub">Anterior: <span id="p_canc_val">‚Äî</span></div></div>
        </div>

        <div class="detail-charts">
          <div class="chart-card">
            <div class="chart-head"><div class="chart-title" id="title_dow">Vendas por dia da semana</div></div>
            <div class="chart-box"><canvas id="ch_dow"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-head"><div class="chart-title" id="title_hour">Vendas por hora</div></div>
            <div class="chart-box"><canvas id="ch_hour"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-head"><div class="chart-title" id="title_top6">Participa√ß√£o por loja ‚Äî Top 6</div></div>
            <div class="chart-box"><canvas id="ch_top6"></canvas><button id="top6Center" class="center-link">Total: R$ 0,00</button></div>
          </div>
          <div class="chart-card">
            <div class="chart-head"><div class="chart-title">Reserva</div></div>
            <div class="chart-box" style="display:flex;align-items:center;justify-content:center"><span class="muted" style="color:#64748b">Adicione novos gr√°ficos conforme necess√°rio</span></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>

  <script>
  // ===================== CONFIG =====================
  const READ_VIEW        = 'vendas_canon';
  const DEST_INSERT_TABLE= 'vendas_xlsx';
  const REFRESH_RPC      = 'refresh_sales_materialized';
  const SUPABASE_URL  = 'COLOQUE_SUA_URL_AQUI';      // ex: https://xxxxx.supabase.co
  const SUPABASE_ANON = 'COLOQUE_SUA_CHAVE_ANON_AQUI';
  const supa = (SUPABASE_URL.includes('http')) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;

  // ===================== CHART.JS TEMA =====================
  Chart.defaults.font.family='-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif';
  Chart.defaults.color='#334155';
  Chart.defaults.plugins.legend.position='top';
  Chart.defaults.plugins.tooltip.backgroundColor='rgba(15,23,42,.95)';
  Chart.defaults.plugins.tooltip.titleColor='#e2e8f0';
  Chart.defaults.plugins.tooltip.bodyColor='#e2e8f0';
  Chart.defaults.plugins.tooltip.borderColor='rgba(148,163,184,.25)';
  Chart.defaults.plugins.tooltip.borderWidth=1;
  Chart.defaults.datasets.bar.borderRadius=6;
  Chart.defaults.datasets.bar.borderSkipped=false;
  Chart.defaults.datasets.bar.maxBarThickness=42;
  Chart.defaults.devicePixelRatio=Math.max(1, window.devicePixelRatio||1);

  function gradNow(ctx){ const g=ctx.createLinearGradient(0,0,0,240); g.addColorStop(0,'rgba(123,30,58,0.95)'); g.addColorStop(1,'rgba(156,53,84,0.55)'); return g; }
  function gradPrev(ctx){ const g=ctx.createLinearGradient(0,0,0,240); g.addColorStop(0,'rgba(148,163,184,0.85)'); g.addColorStop(1,'rgba(203,213,225,0.45)'); return g; }

  // ===================== HELPERS =====================
  const $ = (id)=>document.getElementById(id);
  const money=v=>(v==null||!isFinite(+v))?'R$ 0,00':'R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const num  =v=>(v==null||!isFinite(+v))?'0':(+v).toLocaleString('pt-BR');
  const pctf =v=>(v==null||!isFinite(+v))?'0,0%':((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%';
  const setStatus=(t,k)=>{ const el=$('status'); if(!el) return; el.textContent=t; el.style.color=(k==='err'?'#ef4444':k==='ok'?'#10b981':'#667085'); };
  const setDiag=(msg)=>{ const el=$('diag'); if(el) el.textContent=msg||''; };

  function iso(d){return d.toISOString().slice(0,10);}
  function addDaysISO(isoStr,n){const d=new Date(isoStr+'T00:00:00'); d.setDate(d.getDate()+n); return iso(d);}
  function daysLen(de,ate){const d1=new Date(de+'T00:00:00'), d2=new Date(ate+'T00:00:00');return Math.round((d2-d1)/(1000*60*60*24))+1;}
  function monthStartISO(isoStr){ const d=new Date(isoStr+'T00:00:00'); d.setDate(1); return iso(d); }
  function monthEndISO(isoStr){ const d=new Date(isoStr+'T00:00:00'); d.setMonth(d.getMonth()+1,0); return iso(d); }
  function addMonthsISO(isoStr, delta){ const d=new Date(isoStr+'T00:00:00'); const day=d.getDate(); d.setDate(1); d.setMonth(d.getMonth()+delta); const last=new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); d.setDate(Math.min(day,last)); return iso(d); }
  function formatYM(isoStr){ const d=new Date(isoStr+'T00:00:00'); const m=d.getMonth(); const y=String(d.getFullYear()).slice(-2); const n=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; return `${n[m]}/${y}`; }

  // ===================== MULTISELECT =====================
  function MultiSelect(rootId, placeholder){
    const root=$(rootId), btn=root.querySelector('.msel-btn'), panel=root.querySelector('.msel-panel');
    let options=[], selected=new Set(), filtered=[];
    function render(){ panel.innerHTML=''; const q=document.createElement('input'); q.className='msel-search'; q.placeholder='Filtrar‚Ä¶';
      q.addEventListener('input',()=>{filtered=options.filter(v=>v.toLowerCase().includes(q.value.toLowerCase())); draw();});
      panel.appendChild(q); draw();
    }
    function draw(){
      const box=document.createElement('div');
      (filtered.length?filtered:options).forEach((v)=>{
        const row=document.createElement('div'); row.className='msel-opt';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.value=v; cb.checked=selected.has(v);
        const lb=document.createElement('label'); lb.textContent=v;
        cb.addEventListener('change',()=>{cb.checked?selected.add(v):selected.delete(v); refresh(); applyAll();});
        row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
      });
      panel.querySelectorAll('.msel-opt').forEach(n=>n.remove());
      panel.appendChild(box);
    }
    function refresh(){ btn.textContent = selected.size===0 ? placeholder : `${selected.size} sel.`; }
    btn.addEventListener('click',()=>{ root.classList.toggle('open'); });
    document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) root.classList.remove('open'); });
    return {
      setOptions(list){ options=(list||[]).filter(v=>v!=null).map(String).sort((a,b)=>a.localeCompare(b,'pt-BR')); filtered=options.slice(); selected=new Set([...selected].filter(v=>options.includes(v))); render(); refresh(); },
      get(){return [...selected];},
      set(vals){selected=new Set((vals||[]).map(String)); refresh(); draw();}
    };
  }

  // ===================== ESTADO / PER√çODO =====================
  let firstDay='', lastDay='';
  let lastPrevRange = {dePrev:null, atePrev:null};
  const chips=[...document.querySelectorAll('.chip')];
  const fDe=$('fDe'), fAte=$('fAte'), periodoInfo=$('periodoInfo');
  const ms={
    unids:  MultiSelect('ms-unids','Todas'),
    lojas:  MultiSelect('ms-lojas','Todas'),
    canais: MultiSelect('ms-canais','Todos'),
    turnos: MultiSelect('ms-turnos','Todos'),
    pags:   MultiSelect('ms-pags','Todos'),
    cancel: MultiSelect('ms-cancel','Todos')
  };
  function setActiveChip(val){ chips.forEach(c=>c.classList.toggle('active', c.dataset.q===String(val))); }
  function applyQuick(val){
    setActiveChip(val);
    const ate=lastDay||iso(new Date());
    const de=addDaysISO(ate, -(Number(val)-1));
    fDe.value=de; fAte.value=ate;
    periodoInfo.textContent=`√öltimo dia carregado: ${lastDay || '‚Äî'}`;
    applyAll();
  }
  $('btnClear').addEventListener('click', ()=>{
    ms.unids.set([]); ms.lojas.set([]); ms.canais.set([]); ms.turnos.set([]); ms.pags.set([]);
    ms.cancel.set(['N√£o']);
    applyQuick('30');
  });
  chips.forEach(b=> b.addEventListener('click', ()=> applyQuick(b.dataset.q)));

  // ===================== KPI & C√ÅLCULOS =====================
  function agg(rows){ let ped=0,fat=0,des=0,fre=0; for(const r of (rows||[])){ ped+=+r.pedidos||0; fat+=+r.fat||0; des+=+r.des||0; fre+=+r.fre||0; } return {ped,fat,des,fre}; }
  function upSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 4l5 6h-3v6H8v-6H5l5-6z"/></svg>';}
  function downSVG(){return '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M10 16l-5-6h3V4h4v6h3l-5 6z"/></svg>';}
  function deltaBadge(el,curr,prev){
    if(!isFinite(prev)||+prev===0){ el.textContent='‚Äî'; el.className='delta flat'; return; }
    const p=((curr-prev)/prev)*100;
    el.innerHTML=(p>=0? upSVG():downSVG())+' '+Math.abs(p).toFixed(1)+'%';
    el.className='delta '+(p>=0?'up':'down');
  }

  // ===================== GR√ÅFICOS =====================
  function formatCurrencyTick(value){
    const v=Number(value)||0;
    if(Math.abs(v)>=1_000_000) return 'R$ '+(v/1_000_000).toFixed(1).replace('.',',')+' mi';
    if(Math.abs(v)>=1_000)     return 'R$ '+(v/1_000).toFixed(1).replace('.',',')+' mil';
    return 'R$ '+v.toFixed(0).replace(/\\B(?=(\\d{3})+(?!\\d))/g,'.');
  }
  function formatTickBy(fmt,v){ if(fmt==='count') return (Number(v)||0).toLocaleString('pt-BR'); if(fmt==='percent'){ const n=Number(v)||0; return (n*100).toFixed(0)+'%'; } return formatCurrencyTick(v); }
  function formatValueBy(fmt,v){ if(fmt==='count') return (Number(v)||0).toLocaleString('pt-BR'); if(fmt==='percent'){ const n=Number(v)||0; return (n*100).toFixed(1)+'%'; } return money(v); }

  function ensureChart(canvasId, labels, nowArr, prevArr, tooltipExtra='', fmt='money'){
    const cvs = $(canvasId); if(!cvs) return;
    if(cvs.__chart){ try{cvs.__chart.destroy();}catch(e){} cvs.__chart = null; }
    const ctx = cvs.getContext('2d');

    // M√™s: Atual em Barra, Anterior como Linha pontilhada
    if(canvasId === 'ch_month'){
      const chart = new Chart(ctx,{
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Atual', data: (nowArr||[]).map(v=>+v||0), backgroundColor: gradNow(ctx), order: 1 },
            { label: 'Anterior', type: 'line', data: (prevArr||[]).map(v=>+v||0),
              borderColor: '#9ca3af', borderWidth: 2, borderDash: [6,4], pointRadius: 2.5, pointHitRadius: 8, fill: false, tension: 0.35, order: 0 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, animation: false,
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: (v)=>formatTickBy(fmt,v) } }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              mode: 'index', intersect: false,
              callbacks: {
                label: (c)=> `${c.dataset.label}: ${formatValueBy(fmt, c.parsed.y||0)}`,
                footer: ()=> tooltipExtra
              }
            }
          }
        }
      });
      cvs.__chart = chart;
      return;
    }

    // Turno: barras horizontais
    if(canvasId === 'ch_turno'){
      const chart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:'Atual', data:(nowArr||[]).map(v=>+v||0), backgroundColor: gradNow(ctx) },
            { label:'Anterior', data:(prevArr||[]).map(v=>+v||0), backgroundColor: gradPrev(ctx) }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, animation:false, indexAxis:'y',
          scales:{
            x:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,0.05)' }, ticks:{ callback:(v)=>formatTickBy(fmt,v) } },
            y:{ grid:{ display:false } }
          },
          plugins:{
            legend:{ position:'top' },
            tooltip:{
              mode:'index', intersect:false,
              callbacks:{ label:(c)=> `${c.dataset.label}: ${formatValueBy(fmt, c.parsed.x||0)}`, footer:()=>tooltipExtra }
            }
          }
        }
      });
      cvs.__chart = chart;
      return;
    }

    // Demais: padr√£o barras comparativas
    const chart=new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[
        {label:'Atual', data:(nowArr||[]).map(v=>+v||0), backgroundColor:gradNow(ctx)},
        {label:'Anterior', data:(prevArr||[]).map(v=>+v||0), backgroundColor:gradPrev(ctx)}
      ]},
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)'}, ticks:{callback:(v)=>formatTickBy(fmt,v)}}},
        plugins:{ legend:{position:'top'},
          tooltip:{mode:'index',intersect:false,callbacks:{
            label:(c)=>`${c.dataset.label}: ${formatValueBy(fmt, c.parsed.y||0)}`,
            footer:()=> tooltipExtra
          }}
        }
      }
    });
    cvs.__chart=chart;
  }

  // ===================== BASE (REST) E RPC (opcional) =====================
  async function baseQuery(de, ate){
    if(!supa){ return demoRows(de, ate); } // fallback demo
    let q = supa.from(READ_VIEW)
      .select('dia,hora,turno,fat,des,fre,cancelado,loja,unidade,canal,pagamento_base,pedidos')
      .gte('dia', de).lte('dia', ate)
      .order('dia', { ascending:true })
      .range(0, 99999);

    const unids = ms.unids.get(); if(unids.length) q = q.in('unidade', unids);
    const lojas = ms.lojas.get(); if(lojas.length) q = q.in('loja', lojas);
    const turns = ms.turnos.get(); if(turns.length) q = q.in('turno', turns);
    const cans  = ms.canais.get(); if(cans.length)  q = q.in('canal', cans);
    const pags  = ms.pags.get(); if(pags.length)   q = q.in('pagamento_base', pags);
    const canc = ms.cancel.get();
    if(canc.length===1 && (canc[0]==='Sim' || canc[0]==='N√£o')) q = q.in('cancelado', [canc[0]]);

    const { data, error } = await q;
    if(error){ console.error('[REST baseQuery]', error); throw error; }
    return data||[];
  }

  // ===================== AGREGADORES CLIENT-SIDE =====================
  function bucketKey(type, row){
    if(type==='dow'){ return (new Date(row.dia+'T00:00:00')).getDay(); }
    if(type==='hour'){ return Number(row.hora ?? 0); }
    if(type==='turno'){ return row.turno ?? null; }
    if(type==='month'){ const d=new Date(row.dia+'T00:00:00'); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    return null;
  }
  function computeByBucket(rows, type, metric, mode){
    const bucketDays = new Map();
    const bucketDaily = new Map();
    for(const r of rows){
      const bkey = bucketKey(type, r);
      if(bkey==null) continue;
      if(!bucketDays.has(bkey)) bucketDays.set(bkey, new Set());
      bucketDays.get(bkey).add(r.dia);
      if(!bucketDaily.has(bkey)) bucketDaily.set(bkey, new Map());
      const dayMap = bucketDaily.get(bkey);
      const dkey = r.dia;
      if(!dayMap.has(dkey)) dayMap.set(dkey, {fat:0, des:0, fre:0, ped:0});
      const dacc = dayMap.get(dkey);
      dacc.fat += +r.fat||0;
      dacc.des += +r.des||0;
      dacc.fre += +r.fre||0;
      dacc.ped += +r.pedidos||0;
    }
    function computeRatio(dailyMap, metric){
      const days = [...dailyMap.values()];
      const dailyVals = days.map(d => {
        switch(metric){
          case 'tkt': return (d.ped > 0) ? (d.fat / d.ped) : 0;
          case 'desperc': return (d.fat > 0) ? (d.des / d.fat) : 0;
          case 'fremed': return (d.ped > 0) ? (d.fre / d.ped) : 0;
          case 'roi': return (d.des > 0) ? ((d.fat - d.des) / d.des) : 0;
          default: return 0;
        }
      }).filter(v => isFinite(v));
      if(!dailyVals.length) return 0;
      return dailyVals.reduce((a,b)=>a+b, 0) / dailyVals.length;
    }
    function computeNonRatio(dailyMap, metric, numDays){
      const total = {fat:0, des:0, fre:0, ped:0};
      for(const d of dailyMap.values()){
        total.fat += d.fat;
        total.des += d.des;
        total.fre += d.fre;
        total.ped += d.ped;
      }
      switch(metric){
        case 'fat': return mode==='media' ? (total.fat / numDays) : total.fat;
        case 'ped': return mode==='media' ? (total.ped / numDays) : total.ped;
        case 'des': return mode==='media' ? (total.des / numDays) : total.des;
        case 'fre': return mode==='media' ? (total.fre / numDays) : total.fre;
        case 'fatmed': return total.fat / numDays;
        case 'canc_val': return mode==='media' ? (total.fat / numDays) : total.fat;
        default: return 0;
      }
    }
    const keys=[...bucketDaily.keys()].sort((a,b)=>{
      if(type==='dow' || type==='hour') return Number(a)-Number(b);
      if(type==='month'){ return a.localeCompare(b); }
      return String(a).localeCompare(String(b),'pt-BR');
    });
    return keys.map(k=>{
      const dailyMap = bucketDaily.get(k);
      const numDays = bucketDays.get(k)?.size || 1;
      let value;
      const isRatio = ['tkt','desperc','fremed','roi'].includes(metric);
      value = isRatio ? (mode === 'media' ? computeRatio(dailyMap, metric) : (function(){
        const total = {fat:0, des:0, fre:0, ped:0};
        for(const d of dailyMap.values()){ total.fat+=d.fat; total.des+=d.des; total.fre+=d.fre; total.ped+=d.ped; }
        switch(metric){
          case 'tkt': return (total.ped > 0) ? (total.fat / total.ped) : 0;
          case 'desperc': return (total.fat > 0) ? (total.des / total.fat) : 0;
          case 'fremed': return (total.ped > 0) ? (total.fre / total.ped) : 0;
          case 'roi': return (total.des > 0) ? ((total.fat - total.des) / total.des) : 0;
        }
        return 0;
      })()) : computeNonRatio(dailyMap, metric, numDays);
      return { key:k, value };
    });
  }

  // ===================== CONTROLE DE KPIs & MODO =====================
  let chartModeGlobal = 'total';
  let selectedKPI = 'fat';
  const KPI_META = {
    fat:      { label:'Faturamento',           fmt:'money'  },
    ped:      { label:'Pedidos',               fmt:'count'  },
    tkt:      { label:'Ticket M√©dio',          fmt:'money',   forceMode:'media' },
    des:      { label:'Incentivos',            fmt:'money'  },
    fatmed:   { label:'Faturamento M√©dio',     fmt:'money',   forceMode:'media' },
    roi:      { label:'ROI',                   fmt:'percent', forceMode:'media' },
    canc_val: { label:'Valor de cancelados',   fmt:'money'  },
  };
  function effectiveMode(){
    const m=KPI_META[selectedKPI];
    return m?.forceMode || chartModeGlobal;
  }
  function updateChartTitles(){
    const m=KPI_META[selectedKPI]||KPI_META.fat;
    const mode = effectiveMode()==='media' ? ' (m√©dia)' : '';
    $('title_month').textContent = `${m.label}${mode} por m√™s ‚Äî √∫ltimos 12M vs. 12M anteriores`;
    $('title_dow').textContent   = `${m.label}${mode} por dia da semana`;
    $('title_hour').textContent  = `${m.label}${mode} por hora`;
    $('title_turno').textContent = `${m.label}${mode} por turno`;
    $('title_top6').textContent  = `Participa√ß√£o por loja ‚Äî Top 6 (${m.label}${mode})`;
  }
  function bindKPIClick(){
    document.querySelectorAll('.kpi[data-kpi]').forEach(card=>{
      card.addEventListener('click', ()=>{
        selectedKPI = card.dataset.kpi;
        document.querySelectorAll('.kpi[data-kpi]').forEach(k=>k.classList.toggle('active', k===card));
        updateChartTitles();
        updateMonth12x12();
        updateCharts();
        updateTop6();
      });
    });
  }
  const segGlobal = $('segGlobal');
  segGlobal.addEventListener('click',(e)=>{
    const btn=e.target.closest('.seg-btn'); if(!btn) return;
    chartModeGlobal = btn.dataset.mode;
    segGlobal.querySelectorAll('.seg-btn').forEach(b=> b.classList.toggle('active', b===btn));
    updateMonth12x12();
    updateCharts();
    updateTop6();
  });

  // ===================== DONUT TOP 6 =====================
  const wine = ["#7b1e3a","#8c2947","#9c3554","#ad4061","#bd4c6e","#ce577b"];
  function ensureDonutTop6(labels, values, centerText, fmt='money'){
    const cvs = $('ch_top6'); if(!cvs) return;
    if(cvs.__chart){ try{cvs.__chart.destroy();}catch(e){} cvs.__chart=null; }
    const ctx = cvs.getContext('2d');
    const total = (values||[]).reduce((a,b)=>a+(+b||0),0);
    $('top6Center').textContent = centerText!=null ? centerText : 'Total: '+(fmt==='money'?money(total): fmt==='count'? num(total) : formatValueBy(fmt, total));
    const chart = new Chart(ctx,{
      type:'doughnut',
      data:{ labels, datasets:[{ data: values, backgroundColor: wine, hoverBackgroundColor: wine, borderColor:'#fff', borderWidth:1 }]},
      options:{
        responsive:true, maintainAspectRatio:false, cutout:'60%',
        plugins:{
          legend:{ position:'right', labels:{ usePointStyle:true, pointStyle:'circle', boxWidth:10, padding:16, color:'#334155' } },
          tooltip:{ callbacks:{ label:(ctx)=>{ const label = ctx.label||''; const val = ctx.parsed||0; const ds = ctx.chart.data.datasets[0]; const tt = (ds.data||[]).reduce((a,b)=>a+(+b||0),0); const perc = tt ? ((val/tt)*100).toFixed(1) : 0; return `${label}: ${formatValueBy(KPI_META[selectedKPI]?.fmt||'money', val)} (${perc}%)`; } } }
        }
      }
    });
    cvs.__chart = chart;
  }

  // ===================== DATA (RPC opcional) / REST / DEMO =====================
  async function updateKPIsFromRows(rowsNow, rowsPrev, de, ate, dePrev, atePrev){
    const N=agg(rowsNow), P=agg(rowsPrev);
    const len=daysLen(de,ate);
    const tktN = (N.ped>0)? (N.fat/N.ped) : 0, tktP = (P.ped>0)? (P.fat/P.ped) : 0;
    const fatMedN = len? (N.fat/len) : 0,    fatMedP = len? (P.fat/len) : 0;
    $('k_ped').textContent=num(N.ped); $('p_ped').textContent=num(P.ped); deltaBadge($('d_ped'),N.ped,P.ped);
    $('k_tkt').textContent=money(tktN); $('p_tkt').textContent=money(tktP); deltaBadge($('d_tkt'),tktN,tktP);
    $('k_fat').textContent=money(N.fat); $('p_fat').textContent=money(P.fat); deltaBadge($('d_fat'),N.fat,P.fat);
    $('k_fatmed').textContent=money(fatMedN); $('p_fatmed').textContent=money(fatMedP); deltaBadge($('d_fatmed'),fatMedN,fatMedP);
    $('k_des').textContent=money(N.des); $('p_des').textContent=money(P.des); deltaBadge($('d_des'),N.des,P.des);
    $('k_roi').textContent='‚Äî'; $('p_roi').textContent='‚Äî';
    $('k_canc_val').textContent=money(0); $('p_canc_val').textContent=money(0); deltaBadge($('d_canc_val'),0,0);
  }

  async function updateCharts(){
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    const {dePrev, atePrev} = computePrevRangeISO(de,ate);
    lastPrevRange = {dePrev, atePrev};
    const meta = KPI_META[selectedKPI]||KPI_META.fat;
    const mode = effectiveMode();

    try{
      const [rowsNow, rowsPrev] = await Promise.all([ baseQuery(de,ate), baseQuery(dePrev,atePrev) ]);
      await updateKPIsFromRows(rowsNow, rowsPrev, de, ate, dePrev, atePrev);
      const tip = `Per√≠odo anterior: ${dePrev} ‚Üí ${atePrev}`;

      // dow
      const lab = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
      const curDow = computeByBucket(rowsNow,'dow', selectedKPI, mode);
      const prvDow = computeByBucket(rowsPrev,'dow', selectedKPI, mode);
      const nArrDow = Array(7).fill(0), pArrDow=Array(7).fill(0);
      curDow.forEach(o=>{ nArrDow[o.key]=o.value; });
      prvDow.forEach(o=>{ pArrDow[o.key]=o.value; });
      ensureChart('ch_dow', lab, nArrDow, pArrDow, tip, meta.fmt);

      // hour
      const all=Array.from({length:24},(_,h)=>h);
      const curH = computeByBucket(rowsNow,'hour', selectedKPI, mode);
      const prvH = computeByBucket(rowsPrev,'hour', selectedKPI, mode);
      const mNowH = new Map(curH.map(o=>[o.key,o.value]));
      const mPrvH = new Map(prvH.map(o=>[o.key,o.value]));
      const labelsH = all.filter(h => mNowH.has(h)||mPrvH.has(h)).map(h=>String(h).padStart(2,'0')+'h');
      const nArrH = all.filter(h => mNowH.has(h)||mPrvH.has(h)).map(h=>mNowH.get(h)||0);
      const pArrH = all.filter(h => mNowH.has(h)||mPrvH.has(h)).map(h=>mPrvH.get(h)||0);
      ensureChart('ch_hour', labelsH, nArrH, pArrH, tip, meta.fmt);

      // turno (horizontal)
      const ord=['Dia','Noite'];
      const curT = computeByBucket(rowsNow,'turno', selectedKPI, mode);
      const prvT = computeByBucket(rowsPrev,'turno', selectedKPI, mode);
      const mNowT = new Map(curT.map(o=>[o.key,o.value]));
      const mPrvT = new Map(prvT.map(o=>[o.key,o.value]));
      const labelsT = ord.filter(k=> mNowT.has(k)||mPrvT.has(k));
      ensureChart('ch_turno', labelsT, labelsT.map(k=>mNowT.get(k)||0), labelsT.map(k=>mPrvT.get(k)||0), tip, meta.fmt);

      setStatus('OK ‚Äî gr√°ficos atualizados','ok');
    }catch(e){
      console.error(e);
      setStatus('OK (sem gr√°ficos ‚Äî dados indispon√≠veis)','ok');
      setDiag(e.message||String(e));
    }
  }

  async function updateMonth12x12(){
    const end = lastDay || iso(new Date());
    const endMonthStart = monthStartISO(end);
    const last12Start = addMonthsISO(endMonthStart, -11);
    const prev12Start = addMonthsISO(endMonthStart, -23);
    const last12End   = monthEndISO(end);
    const prev12EndAdj= monthEndISO(addMonthsISO(endMonthStart, -12));
    const meta = KPI_META[selectedKPI]||KPI_META.fat;
    const mode = effectiveMode();

    // Deriva labels (MMM/YY)
    let labels=[]; let cur=last12Start;
    for(let i=0;i<12;i++){ labels.push(formatYM(cur)); cur = addMonthsISO(cur, 1); }

    try{
      const [rowsNow, rowsPrev] = await Promise.all([ baseQuery(last12Start,last12End), baseQuery(prev12Start,prev12EndAdj) ]);
      const curNow = computeByBucket(rowsNow,'month', selectedKPI, mode);
      const curPrv = computeByBucket(rowsPrev,'month', selectedKPI, mode);
      const mNow = new Map(curNow.map(o=>[o.key,o.value]));
      const mPrv = new Map(curPrv.map(o=>[o.key,o.value]));
      const ymsNow = []; cur = last12Start;
      for(let i=0;i<12;i++){ const d=new Date(cur+'T00:00:00'); const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; ymsNow.push(ym); cur=addMonthsISO(cur,1); }
      const ymsPrev = ymsNow.map(ym=>{ const [yy,mm]=ym.split('-').map(Number); const p=new Date(yy,mm-1-12,1); return `${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,'0')}`; });
      const nowArr  = ymsNow.map(ym => mNow.get(ym)||0);
      const prevArr = ymsPrev.map(ym => mPrv.get(ym)||0);
      const tip = `Compara√ß√£o fixa: √öltimos 12M (${formatYM(last12Start)} ‚Üí ${formatYM(endMonthStart)}) vs 12M anteriores (${formatYM(prev12Start)} ‚Üí ${formatYM(addMonthsISO(endMonthStart,-1))})`;
      ensureChart('ch_month', labels, nowArr, prevArr, tip, meta.fmt);
      setStatus('OK ‚Äî gr√°fico mensal 12x12','ok');
    }catch(e){
      console.error(e);
      setStatus('OK (mensal 12x12 indispon√≠vel)','ok');
    }
  }

  // ===================== DEMO DATA (fallback quando sem Supabase) =====================
  function demoRows(de, ate){
    // Gera dados sint√©ticos est√°veis no per√≠odo para visual
    const start=new Date(de+'T00:00:00'), end=new Date(ate+'T00:00:00');
    const rows=[]; const lojas=['Savassi','Estoril','Raja','Funcion√°rios','Lourdes','Belvedere'];
    const turnos=['Dia','Noite']; const canais=['Mesa','Delivery','Retirada']; const pags=['Cr√©dito','D√©bito','Pix'];
    for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
      const dia=iso(d);
      for(const loja of lojas){
        const base = (d.getDay()===5||d.getDay()===6)? 1.2 : 1; // sex/s√°b sobem
        for(const turno of turnos){
          const fator = turno==='Dia'? 0.85 : 1.15;
          const pedidos = Math.max(5, Math.round(20*base*fator*(0.8+Math.random()*0.4)));
          const fat = pedidos * (40 + Math.random()*60);
          const des = fat * (0.03 + Math.random()*0.04);
          const fre = fat * (0.06 + Math.random()*0.02);
          rows.push({dia,hora:Math.floor(Math.random()*24),turno,fat,des,fre,cancelado:'N√£o',loja,unidade:loja,canal:canais[Math.floor(Math.random()*canais.length)],pagamento_base:pags[Math.floor(Math.random()*pags.length)],pedidos});
        }
      }
    }
    return rows;
  }

  // ===================== UPLOAD EXCEL (local para demo) =====================
  const fileExcel = $('fileExcel');
  $('btnUpload').addEventListener('click',()=> fileExcel.click());
  fileExcel.addEventListener('change', async (ev)=>{
    const f = ev.target.files?.[0];
    if(!f) return;
    $('uploadInfo').style.display='block';
    $('uploadInfo').textContent = 'Arquivo carregado: '+f.name+' ('+Math.round(f.size/1024)+' KB) ‚Äî somente visual local (demo)';
  });

  // ===================== RANGE PREVIO & TITLES =====================
  function lastDayOfMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function isFullYear(d1,d2){ return d1.getMonth()===0 && d1.getDate()===1 && d2.getMonth()===11 && d2.getDate()===31 && d1.getFullYear()===d2.getFullYear(); }
  function isFullMonthsAligned(d1,d2){ return d1.getDate()===1 && d2.getDate()=== lastDayOfMonth(d2.getFullYear(), d2.getMonth()); }
  function shiftYear(date,delta){ const d=new Date(date); d.setFullYear(d.getFullYear()+delta); const ld=lastDayOfMonth(d.getFullYear(), d.getMonth()); if(d.getDate()>ld) d.setDate(ld); return d; }
  function computePrevRangeISO(deISO, ateISO){
    const d1=new Date(deISO+'T00:00:00'), d2=new Date(ateISO+'T00:00:00');
    if(isFullYear(d1,d2) || isFullMonthsAligned(d1,d2)){ const p1=shiftYear(d1,-1), p2=shiftYear(d2,-1); return { dePrev: iso(p1), atePrev: iso(p2) }; }
    const len=daysLen(deISO,ateISO); const atePrev=new Date(d1.getTime()-86400000); const dePrev=new Date(atePrev.getTime()-(len-1)*86400000);
    return { dePrev: iso(dePrev), atePrev: iso(atePrev) };
  }

  function applyAll(){
    updateChartTitles();
    updateMonth12x12();
    updateCharts();
    updateTop6();
  }

  async function updateTop6(){
    // usa dados do per√≠odo atual para top6 (por loja)
    const de=fDe.value||firstDay, ate=fAte.value||lastDay;
    try{
      const rowsNow = await baseQuery(de,ate);
      const map = new Map();
      rowsNow.forEach(r=>{ map.set(r.loja, (map.get(r.loja)||0) + (+r.fat||0)); });
      const sorted = [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6);
      ensureDonutTop6(sorted.map(x=>x[0]), sorted.map(x=>x[1]), null, 'money');
    }catch(e){
      console.error(e);
    }
  }

  // ===================== INIT =====================
  (function init(){
    // Accordions
    document.querySelectorAll('.acc').forEach(acc=>{
      const head=acc.querySelector('.acc-head'); if(!head) return;
      const key = 'acc_'+(acc.id||Math.random());
      const saved = localStorage.getItem(key);
      if(saved==='0') acc.classList.remove('open');
      head.addEventListener('click',()=>{ acc.classList.toggle('open'); localStorage.setItem(key, acc.classList.contains('open')?'1':'0'); });
    });

    // Multiselect options (demo)
    ms.unids.setOptions(['Savassi','Estoril','Raja','Funcion√°rios','Lourdes','Belvedere']);
    ms.lojas.setOptions(['Savassi','Estoril','Raja','Funcion√°rios','Lourdes','Belvedere']);
    ms.turnos.setOptions(['Dia','Noite']);
    ms.canais.setOptions(['Mesa','Delivery','Retirada']);
    ms.pags.setOptions(['Cr√©dito','D√©bito','Pix']);
    ms.cancel.set(['N√£o']);

    // Per√≠odo default: √∫ltimos 30 dias
    lastDay = iso(new Date()); firstDay = addDaysISO(lastDay, -29);
    fDe.value = firstDay; fAte.value = lastDay;
    bindKPIClick();
    applyAll();
  })();
  </script>
</body>
</html>
