<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dash de Vendas — Diagnóstico (Autodiscovery)</title>
  <!-- Favicon embutido (evita 404 do /favicon.ico em muitos navegadores) -->
  <link rel="icon" type="image/svg+xml" 
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b6cff'/%3E%3Cpath d='M14 42c7 0 10-4 14-10s7-10 14-10' stroke='%23fff' stroke-width='6' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='42' cy='22' r='5' fill='%23fff'/%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#f7f7fb;--card:#ffffff;--muted:#6b7280;--text:#0f172a;--brand:#0b6cff;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card)}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600}
    .btn.ghost{background:#eaf2ff;color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .title{font-weight:700;margin-bottom:6px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    input,select,textarea{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;width:100%}
    details{margin-top:8px}
    summary{cursor:pointer}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#274acc}
    .tag{display:inline-block;background:#f3f4f6;color:#111827;border-radius:8px;padding:2px 6px;font-size:12px;margin-right:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .small{font-size:12px}
    .kpi{font-size:36px;font-weight:800}
    pre{white-space:pre-wrap;background:#0b1220;color:#c9d1d9;padding:10px;border-radius:12px;overflow:auto}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dash de Vendas <span class="badge">Diagnóstico (REST + OpenAPI)</span></h1>

    <!-- Filtros topo -->
    <div class="row" style="margin-top:10px">
      <div class="pill"><label class="small muted">Início<br><input type="date" id="dtIni"></label></div>
      <div class="pill"><label class="small muted">Fim<br><input type="date" id="dtFim"></label></div>
      <div class="pill"><label class="small muted">Cancelado<br>
        <select id="fCancel">
          <option value="todos">Todos</option>
          <option value="somente_validos">Apenas válidos</option>
          <option value="somente_cancelados">Apenas cancelados</option>
        </select></label>
      </div>
      <div class="pill"><label class="small muted">KPI<br>
        <select id="kpi">
          <option value="fat">Faturamento</option>
          <option value="ped">Pedidos</option>
          <option value="ticket">Ticket Médio</option>
        </select></label>
      </div>
      <button class="btn" id="btnRun">Atualizar</button>
      <button class="btn ghost right" id="btnTest">Rodar teste</button>
    </div>

    <!-- KPI -->
    <div class="card" style="margin-top:14px">
      <div class="title">Faturamento</div>
      <div class="kpi" id="kpiValue">—</div>
      <div class="muted small" id="kpiHint">Destaques: —</div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <div class="title">Insights</div>
        <div class="muted" id="insights">Sem dados no período.</div>
      </div>
      <div class="card">
        <div class="title">Projeções</div>
        <div class="row">
          <div>Receita projetada (30d): <b id="pReceita">R$ 0,00</b></div>
          <div>Pedidos: <b id="pPed">0</b></div>
          <div>Ticket: <b id="pTicket">R$ 0,00</b></div>
        </div>
      </div>
    </div>

    <!-- Diagnóstico e Config -->
    <div class="card" style="margin-top:14px">
      <div class="title">Teste de Paginação (Diagnóstico) — <span class="muted">Total via Content-Range:</span> <b id="totalHead">0</b></div>
      <details open>
        <summary>⚙️ Config (ajuste se auto-detecção falhar)</summary>
        <div class="grid" style="margin-top:8px">
          <label>Project URL
            <input id="projUrl" placeholder="https://xxxxx.supabase.co">
          </label>
          <label>Anon Key
            <input id="anonKey" class="mono" placeholder="ey...">
          </label>
          <label>Tabela de vendas
            <input id="tb" list="tbList" placeholder="ex.: vendas / vw_vendas / sales">
            <datalist id="tbList"></datalist>
          </label>
          <label>Coluna de data
            <input id="colDt" list="dtList" placeholder="ex.: data / created_at / dh / dt / hora">
            <datalist id="dtList"></datalist>
          </label>
          <label>Coluna de valor (opcional)
            <input id="colVal" list="valList" placeholder="ex.: valor_total / total / valor / receita">
            <datalist id="valList"></datalist>
          </label>
          <label>Coluna de cancelado (opcional)
            <input id="colCanc" list="cancList" placeholder="ex.: cancelado / status">
            <datalist id="cancList"></datalist>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnSave">Salvar</button>
          <button class="btn ghost" id="btnDiscover">Descobrir tabelas e colunas (OpenAPI)</button>
          <span class="muted small" id="cfgMsg"></span>
        </div>
        <div class="divider"></div>
        <div class="small muted">Última URL chamada:</div>
        <pre id="lastUrl" class="mono small">(vazio)</pre>
        <div id="debug" class="small"></div>
      </details>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // ---------- Helpers
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
  const fmtBRL = (n)=> (isFinite(n)? n : 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

  // ---------- DOM refs
  const elIni = qs('#dtIni'), elFim = qs('#dtFim'), elKPI = qs('#kpi'), elCancel = qs('#fCancel');
  const elProj = qs('#projUrl'), elKey = qs('#anonKey'), elTb = qs('#tb'), elDt = qs('#colDt'), elVal = qs('#colVal'), elCanc = qs('#colCanc');
  const elTbList = qs('#tbList'), elDtList = qs('#dtList'), elValList = qs('#valList'), elCancList = qs('#cancList');
  const elTotalHead = qs('#totalHead'), elLastUrl = qs('#lastUrl'), elCfgMsg = qs('#cfgMsg'), elDebug = qs('#debug');
  const elKpiValue = qs('#kpiValue'), elKpiHint = qs('#kpiHint'), elPRec = qs('#pReceita'), elPPed = qs('#pPed'), elPTick = qs('#pTicket'), elInsights = qs('#insights');

  // ---------- State & defaults
  const SKEY = 'dx_cfg_v1';
  const guessCfg = {
    projUrl: 'https://msmyfxgrnuusnvoqyeuo.supabase.co',
    anonKey: '',
    schema: 'public',
    table: '',
    colDate: '',
    colVal: '',
    colCancel: ''
  };

  function loadCfg(){
    try{
      const saved = JSON.parse(localStorage.getItem(SKEY)||'{}');
      return Object.assign({}, guessCfg, saved);
    }catch(e){return {...guessCfg};}
  }
  function saveCfg(cfg){
    localStorage.setItem(SKEY, JSON.stringify(cfg));
  }
  function applyCfgToInputs(cfg){
    elProj.value = cfg.projUrl||'';
    elKey.value  = cfg.anonKey||'';
    elTb.value   = cfg.table||'';
    elDt.value   = cfg.colDate||'';
    elVal.value  = cfg.colVal||'';
    elCanc.value = cfg.colCancel||'';
  }

  // Dates init (hoje - 31d .. hoje)
  const today = new Date();
  const ini = new Date(today); ini.setDate(today.getDate()-31);
  elIni.value = ini.toISOString().slice(0,10);
  elFim.value = today.toISOString().slice(0,10);

  // Load cfg
  const CFG = loadCfg();
  applyCfgToInputs(CFG);

  // ---------- HTTP (REST/OpenAPI)
  function headers(cfg, extra={}){
    const h = {
      'apikey': cfg.anonKey||'',
      'Authorization': cfg.anonKey ? ('Bearer '+cfg.anonKey) : '',
      'Content-Type': 'application/json',
      'Accept-Profile': cfg.schema||'public',
      'Content-Profile': cfg.schema||'public',
      ...extra
    };
    return h;
  }
  function urlJoin(...parts){
    return parts.map(p=> String(p).replace(/\/+$/,'').replace(/^\/+/,'')).join('/');
  }
  function setLastUrl(u){ elLastUrl.textContent = u; }

  async function fetchOpenAPI(cfg){
    const u = urlJoin(cfg.projUrl, 'rest', 'v1', '');
    setLastUrl(u+' (OpenAPI)');
    const res = await fetch(u, { method:'GET', headers: headers(cfg, {'Accept': 'application/openapi+json'}) });
    if(!res.ok) throw new Error('OpenAPI error: HTTP '+res.status);
    return res.json();
  }

  function pickBestTable(tables){
    // prefer vendas > vw_vendas > sales > pedidos
    const pref = ['vendas','vw_vendas','sales','pedidos'];
    const lower = tables.map(t=>t.toLowerCase());
    for(const p of pref){
      const i = lower.findIndex(t=> t===p || t.includes(p));
      if(i>=0) return tables[i];
    }
    return tables[0] || '';
  }

  function columnsFromSchema(openapi, table, schema='public'){
    // PostgREST OpenAPI usually exposes components.schemas like "public_vendas" or "vendas"
    const comp = openapi.components && openapi.components.schemas ? openapi.components.schemas : {};
    const keys = Object.keys(comp);
    const candidates = keys.filter(k=>{
      const lk = k.toLowerCase();
      const t = table.toLowerCase();
      return lk===t || lk.endsWith('_'+t) || lk.includes('.'+t);
    });
    const chosen = candidates[0] || keys.find(k=>k.toLowerCase().includes(table.toLowerCase())) || null;
    if(!chosen) return null;
    const props = (comp[chosen] && comp[chosen].properties) ? comp[chosen].properties : {};
    return Object.keys(props);
  }

  function guessDateColumn(cols){
    const pref = ['data','dt','dh','created_at','hora','date','timestamp','dthr','dth'];
    const l = cols.map(c=>c.toLowerCase());
    for(const p of pref){
      const i = l.findIndex(c=> c===p || c.endsWith('.'+p) || c.includes(p));
      if(i>=0) return cols[i];
    }
    return cols[0]||'';
  }
  function guessValueColumn(cols){
    const pref = ['valor_total','total','valor','faturamento','receita','vr_total'];
    const l = cols.map(c=>c.toLowerCase());
    for(const p of pref){
      const i = l.findIndex(c=> c===p || c.includes(p));
      if(i>=0) return cols[i];
    }
    return '';
  }
  function guessCancelColumn(cols){
    const pref = ['cancelado','status','fl_cancelado','is_cancelled','canc'];
    const l = cols.map(c=>c.toLowerCase());
    for(const p of pref){
      const i = l.findIndex(c=> c===p || c.includes(p));
      if(i>=0) return cols[i];
    }
    return '';
  }

  function buildRangeQuery(cfg){
    // Return filter string like "data=gte.2025-08-01&data=lt.2025-09-01"
    const dtCol = cfg.colDate;
    if(!dtCol) return '';
    const di = elIni.value; // YYYY-MM-DD
    const df = elFim.value;
    // If column name suggests timestamp, add T00:00:00
    const ts = /hora|dh|created_at|timestamp|dthr|dth/i.test(dtCol);
    const ini = ts ? (di+'T00:00:00') : di;
    const fim = ts ? (df+'T00:00:00') : df;
    return encodeURIComponent(dtCol)+'=gte.'+ini+'&'+encodeURIComponent(dtCol)+'=lt.'+fim;
  }

  async function headCount(cfg){
    // Use HEAD with Prefer: count=exact and Range: 0-0 to get total
    if(!cfg.table || !cfg.colDate) throw new Error('Config incompleta: tabela/coluna data');
    const q = buildRangeQuery(cfg);
    const u = urlJoin(cfg.projUrl,'rest','v1',cfg.table)+'?select=id'+(q?('&'+q):'');
    setLastUrl(u+' [HEAD]');
    const res = await fetch(u, {
      method:'HEAD',
      headers: headers(cfg, {'Prefer':'count=exact'})
    });
    if(!res.ok) throw new Error('HEAD error HTTP '+res.status);
    const cr = res.headers.get('Content-Range') || '*/0';
    const total = parseInt(cr.split('/').pop()||'0',10) || 0;
    return total;
  }

  async function fetchPage(cfg, from, to){
    const q = buildRangeQuery(cfg);
    const u = urlJoin(cfg.projUrl,'rest','v1',cfg.table)+'?select=*'+(q?('&'+q):'');
    setLastUrl(u+' [GET '+from+'-'+to+']');
    const res = await fetch(u, {
      method:'GET',
      headers: headers(cfg, {'Range': `${from}-${to}`, 'Prefer':'count=exact'})
    });
    if(!res.ok) throw new Error('GET error HTTP '+res.status);
    return res.json();
  }

  async function fetchPagedAll(cfg, perPage=1000){
    const total = await headCount(cfg);
    elTotalHead.textContent = total.toLocaleString('pt-BR');
    const rows = [];
    for(let start=0; start<total; start+=perPage){
      const end = Math.min(start+perPage-1, total-1);
      const page = await fetchPage(cfg, start, end);
      rows.push(...page);
      // pequena pausa para não saturar (opcional)
      await sleep(5);
    }
    return rows;
  }

  function safeNumber(v){
    const n = Number(v);
    return isFinite(n) ? n : 0;
  }

  function aggregate(rows, cfg){
    const ped = rows.length;
    let fat = 0;
    if(cfg.colVal){
      for(const r of rows) fat += safeNumber(r[cfg.colVal]);
    }
    const ticket = ped>0 ? fat/ped : 0;
    return {ped, fat, ticket};
  }

  function showKPIs(agg){
    if(elKPI.value==='ped'){
      elKpiValue.textContent = (agg.ped||0).toLocaleString('pt-BR');
      elKpiHint.textContent = 'Pedidos no período';
    }else if(elKPI.value==='ticket'){
      elKpiValue.textContent = fmtBRL(agg.ticket||0);
      elKpiHint.textContent = 'Ticket médio no período';
    }else{
      elKpiValue.textContent = fmtBRL(agg.fat||0);
      elKpiHint.textContent = 'Faturamento no período';
    }
    elPRec.textContent = fmtBRL((agg.fat||0)); // placeholder simples
    elPPed.textContent = (agg.ped||0).toLocaleString('pt-BR');
    elPTick.textContent = fmtBRL(agg.ticket||0);
  }

  function logDebug(msg){
    const p = document.createElement('div');
    p.className = 'small mono';
    p.textContent = msg;
    elDebug.prepend(p);
  }

  // ---------- Discover via OpenAPI
  async function discover(){
    elCfgMsg.textContent = 'Descobrindo tabelas/colunas via OpenAPI…';
    try{
      const cfg = {
        projUrl: elProj.value.trim(),
        anonKey: elKey.value.trim(),
        schema: 'public'
      };
      const openapi = await fetchOpenAPI(cfg);
      // tables from paths
      const paths = openapi.paths ? Object.keys(openapi.paths) : [];
      const tables = paths
        .map(p=> p.replace(/^\//,'').split('/')[0])
        .filter(p=> p && !p.startsWith('rpc'))
        .filter((v,i,a)=> a.indexOf(v)===i);
      elTbList.innerHTML = tables.map(t=>`<option value="${t}"></option>`).join('');
      const table = elTb.value || pickBestTable(tables);
      elTb.value = table;

      // columns
      const cols = columnsFromSchema(openapi, table) || [];
      elDtList.innerHTML = cols.map(c=>`<option value="${c}"></option>`).join('');
      elValList.innerHTML = elDtList.innerHTML;
      elCancList.innerHTML = elDtList.innerHTML;
      elDt.value = elDt.value || guessDateColumn(cols);
      if(!elVal.value) elVal.value = guessValueColumn(cols);
      if(!elCanc.value) elCanc.value = guessCancelColumn(cols);

      elCfgMsg.textContent = 'OpenAPI OK. Tabela/colunas sugeridas.';
      logDebug('[DISCOVER] tables='+tables.length+' cols='+cols.length);
    }catch(e){
      elCfgMsg.textContent = 'Falha na descoberta: '+e.message;
      logDebug('[DISCOVER][ERR] '+e.message);
    }
  }

  // ---------- Run
  async function run(){
    elDebug.innerHTML='';
    const cfg = {
      projUrl: elProj.value.trim(),
      anonKey: elKey.value.trim(),
      schema: 'public',
      table: elTb.value.trim(),
      colDate: elDt.value.trim(),
      colVal: elVal.value.trim(),
      colCancel: elCanc.value.trim()
    };
    if(!cfg.projUrl || !cfg.anonKey){
      elKpiValue.textContent = '—'; elInsights.textContent = 'Erro. Preencha Project URL e Anon Key.';
      return;
    }
    if(!cfg.table || !cfg.colDate){
      elKpiValue.textContent = '—'; elInsights.textContent = 'Erro. Informe tabela e coluna de data.';
      return;
    }
    try{
      logDebug('[RUN] HEAD total…');
      const total = await headCount(cfg);
      elTotalHead.textContent = total.toLocaleString('pt-BR');
      logDebug('[RUN] total='+total);
      const rows = await fetchPagedAll(cfg, 1000);
      logDebug('[RUN] rows carregadas='+rows.length);
      const agg = aggregate(rows, cfg);
      showKPIs(agg);
      elInsights.textContent = 'OK • Linhas: '+rows.length.toLocaleString('pt-BR');
    }catch(e){
      elKpiValue.textContent = '—';
      elInsights.textContent = 'Erro. Veja “Config” abaixo.';
      logDebug('[RUN][ERR] '+e.message);
    }
  }

  // ---------- Test (só HEAD + sample colunas)
  async function test(){
    elDebug.innerHTML='';
    try{
      // Primeiro, tentar descobrir automaticamente se faltarem tabela/colunas
      if(!elTb.value || !elDt.value){
        await discover();
      }
      const cfg = {
        projUrl: elProj.value.trim(),
        anonKey: elKey.value.trim(),
        schema: 'public',
        table: elTb.value.trim(),
        colDate: elDt.value.trim()
      };
      const total = await headCount(cfg);
      elTotalHead.textContent = total.toLocaleString('pt-BR');
      logDebug('[TEST] HEAD total='+total);

      // Pega 1 página pequena para inspecionar colunas reais
      const sample = await fetchPage({...cfg}, 0, Math.min(9, total-1));
      logDebug('[TEST] sample cols='+(sample[0]? Object.keys(sample[0]).join(', ') : '(vazio)'));
    }catch(e){
      logDebug('[TEST][ERR] '+e.message);
    }
  }

  // ---------- Bindings
  qs('#btnRun').onclick = run;
  qs('#btnTest').onclick = test;
  qs('#btnDiscover').onclick = discover;
  qs('#btnSave').onclick = ()=>{
    const cfg = {
      projUrl: elProj.value.trim(),
      anonKey: elKey.value.trim(),
      schema: 'public',
      table: elTb.value.trim(),
      colDate: elDt.value.trim(),
      colVal: elVal.value.trim(),
      colCancel: elCanc.value.trim()
    };
    saveCfg(cfg);
    elCfgMsg.textContent = 'Config salva.';
    setTimeout(()=> elCfgMsg.textContent='', 2000);
  };

})();</script>
</body>
</html>
