<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dash Vendas — Diagnóstico (safe v2)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28'/%3E%3C/svg%3E">
<style>
  :root { --bg:#f7f7fb; --card:#fff; --txt:#0f172a; --muted:#6b7280; --pri:#1e40af; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626; --bd:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;background:var(--bg);color:var(--txt)}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--bd);padding:16px 20px;z-index:5}
  .wrap{max-width:1080px;margin:0 auto;padding:20px}
  h1{margin:0;font-size:22px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .muted{color:var(--muted)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button,textarea{font:inherit;border:1px solid var(--bd);border-radius:10px;padding:10px 12px;background:#fff}
  input:focus,select:focus,textarea:focus{outline:2px solid #c7d2fe;border-color:#93c5fd}
  button{background:var(--pri);color:#fff;border:none;cursor:pointer}
  button.ghost{background:#f3f4f6;color:#111827;border:1px solid var(--bd)}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .mt-8{margin-top:8px}.mt-16{margin-top:16px}.mt-24{margin-top:24px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#f8fafc;border:1px solid var(--bd);padding:6px 8px;border-radius:999px;font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .log{font-size:12px;white-space:pre-wrap;background:#0b1020;color:#d1d5db;border-radius:8px;padding:12px;overflow:auto;max-height:280px}
  .right{margin-left:auto}
  .success{color:var(--ok)} .error{color:var(--err)} .warn{color:var(--warn)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid var(--bd)}
  .list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>Dash de Vendas</h1>
    <span class="pill muted">Diagnóstico (REST + OpenAPI safe v2)</span>
    <button id="btnAtualizar" class="right">Atualizar</button>
    <button id="btnRodarTeste" class="">Rodar teste</button>
  </div>
</header>

<main class="wrap grid">
  <section class="grid cols-2">
    <div class="card">
      <label class="muted">Faturamento</label>
      <div id="kpiValor" style="font-size:28px;font-weight:700">—</div>
      <div class="muted mt-8" id="kpiSub">Período anterior: —</div>
      <div class="muted mt-8" id="kpiHighlights">Destaques: —</div>
    </div>
    <div class="card">
      <label class="muted">Projeções</label>
      <div>Receita projetada (30d): <b id="projReceita">R$ 0,00</b></div>
      <div>Pedidos: <b id="projPed">0</b> · Ticket: <b id="projTick">R$ 0,00</b></div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="align-items:center">
      <b>Teste de Paginação (Diagnóstico)</b>
      <span class="muted">— Total via <code>Content-Range</code>: <b id="totalHead">0</b></span>
    </div>

    <details class="mt-16" open>
      <summary>⚙️ Config (ajuste se auto-detecção falhar)</summary>
      <div class="grid cols-2 mt-16">
        <div>
          <label>Project URL</label>
          <input id="inpUrl" placeholder="https://xxxx.supabase.co">
        </div>
        <div>
          <label>Anon Key</label>
          <input id="inpKey" class="mono" placeholder="eyJ...">
        </div>
      </div>
      <div class="grid cols-2 mt-8">
        <div>
          <label>Tabela de vendas (pode usar schema.tabela) <small class="muted">(lista abaixo)</small></label>
          <input id="inpTabela" placeholder="ex.: vendas, schema.tabela" list="dlTables">
          <datalist id="dlTables"></datalist>
        </div>
        <div>
          <label>Coluna de data</label>
          <input id="inpColData" placeholder="ex.: data / dt / dh / created_at / hora">
        </div>
      </div>
      <div class="grid cols-2 mt-8">
        <div>
          <label>Coluna de valor (opcional)</label>
          <input id="inpColValor" placeholder="ex.: total / valor_total / valor">
        </div>
        <div>
          <label>Coluna de cancelado (opcional)</label>
          <input id="inpColCancel" placeholder="ex.: cancelado / status">
        </div>
      </div>
      <div class="row mt-8">
        <button id="btnSalvar">Salvar</button>
        <button id="btnDiscover" class="ghost">Descobrir tabelas e colunas (OpenAPI)</button>
        <span id="openapiOk" class="muted"></span>
      </div>
      <div class="mt-8">
        <label>Última URL chamada:</label>
        <div class="mono pill" id="lastUrl">—</div>
      </div>
      <div class="mt-8 log" id="log"></div>
      <div class="mt-8">
        <label>Tabelas detectadas:</label>
        <div id="tablesList" class="list"></div>
      </div>
    </details>
  </section>

  <section class="card">
    <div class="row">
      <b>Amostra de dados</b>
      <button class="ghost right" id="btnLoadAmostra">Carregar amostra</button>
    </div>
    <div class="mt-8">
      <table id="tbl"><thead></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
const log = (m, cls='') => { const box=$("#log"); const t=new Date().toLocaleTimeString(); box.innerHTML += (cls?`<span class="\${cls}">`:'') + '['+t+'] ' + m + (cls?'</span>':'') + '\\n'; box.scrollTop = box.scrollHeight; };
const money = v => (v??0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtInt = v => (v??0).toLocaleString('pt-BR');

const DX = window.DX || (window.DX={});
DX.state = {
  url: localStorage.getItem('dx_url') || '',
  key: localStorage.getItem('dx_key') || '',
  tabela: localStorage.getItem('dx_tab') || '',
  colData: localStorage.getItem('dx_dtcol') || '',
  colValor: localStorage.getItem('dx_vcol') || '',
  colCancel: localStorage.getItem('dx_ccol') || '',
};
function applyInputs(){
  $("#inpUrl").value = DX.state.url;
  $("#inpKey").value = DX.state.key;
  $("#inpTabela").value = DX.state.tabela;
  $("#inpColData").value = DX.state.colData;
  $("#inpColValor").value = DX.state.colValor;
  $("#inpColCancel").value = DX.state.colCancel;
}
applyInputs();

function saveConfig(){
  DX.state.url = $("#inpUrl").value.trim();
  DX.state.key = $("#inpKey").value.trim();
  DX.state.tabela = $("#inpTabela").value.trim();
  DX.state.colData = $("#inpColData").value.trim();
  DX.state.colValor = $("#inpColValor").value.trim();
  DX.state.colCancel = $("#inpColCancel").value.trim();
  localStorage.setItem('dx_url', DX.state.url);
  localStorage.setItem('dx_key', DX.state.key);
  localStorage.setItem('dx_tab', DX.state.tabela);
  localStorage.setItem('dx_dtcol', DX.state.colData);
  localStorage.setItem('dx_vcol', DX.state.colValor);
  localStorage.setItem('dx_ccol', DX.state.colCancel);
  initSupabase();
  log('Config salva.','success');
}
$("#btnSalvar").onclick = saveConfig;

function initSupabase(){
  if (!DX.state.url || !DX.state.key) { DX.sb=null; return; }
  DX.sb = supabase.createClient(DX.state.url, DX.state.key, { auth:{ persistSession:false }});
}
initSupabase();

DX.rest = (path, init={}) => {
  if (!DX.state.url) throw new Error('URL do projeto não informada');
  const url = DX.state.url.replace(/\/+$/,'') + path;
  $("#lastUrl").textContent = url;
  return fetch(url, { ...init, headers:{ 'apikey':DX.state.key, 'Authorization':'Bearer '+DX.state.key, ...(init.headers||{}) }});
};
DX.tableExists = async (table) => {
  const r = await DX.rest(`/rest/v1/\${encodeURIComponent(table)}?select=id&limit=0`, { method:'HEAD' });
  return r.status===200;
};
DX.hasCols = async (table, cols) => {
  const out = {}; await Promise.all(cols.map(async c=>{ const r = await DX.rest(`/rest/v1/\${encodeURIComponent(table)}?select=\${encodeURIComponent(c)}&limit=0`, { method:'HEAD' }); out[c]=r.ok; })); return out;
};

async function discoverViaOpenAPI(){
  try{
    if (!DX.state.url || !DX.state.key){ log('Informe URL/Key antes de descobrir.','warn'); return; }
    const r = await DX.rest('/rest/v1/', { method:'GET' });
    if (!r.ok){ $("#openapiOk").textContent = `OpenAPI falhou (\${r.status})`; $("#openapiOk").className='warn'; return; }
    const json = await r.json();
    const paths = Object.keys(json.paths||{});
    // extrai /rest/v1/{schema?}.{table}
    const tables = [];
    for (const p of paths){
      const seg = p.split('/').filter(Boolean).pop() || '';
      if (!seg) continue;
      // ignora RPC e raiz
      if (seg.startsWith('rpc')) continue;
      tables.push(seg);
    }
    const uniq = Array.from(new Set(tables)).sort((a,b)=>a.localeCompare(b));
    $("#openapiOk").textContent = `OpenAPI OK. \${uniq.length} tabelas vistas.`;
    $("#openapiOk").className='success';

    // popular datalist e chips
    $("#dlTables").innerHTML = uniq.map(t=>`<option value="\${t}">`).join('');
    const container = $("#tablesList"); container.innerHTML='';
    uniq.slice(0,80).forEach(t=>{
      const el = document.createElement('button');
      el.className='chip';
      el.textContent=t;
      el.onclick=()=>{ $("#inpTabela").value=t; };
      container.appendChild(el);
    });
  }catch(e){
    $("#openapiOk").textContent = `OpenAPI erro: \${e.message}`;
    $("#openapiOk").className='error';
    log(e.message,'error');
  }
}
$("#btnDiscover").onclick = discoverViaOpenAPI;

// HEAD total using date filter
async function headTotal(table, whereQuery){
  const r = await DX.rest(`/rest/v1/\${encodeURIComponent(table)}?select=id\${whereQuery}`, { method:'HEAD' });
  const cr = r.headers.get('Content-Range'); let total=0;
  if (cr && cr.includes('/')) total = parseInt(cr.split('/').pop(),10)||0;
  $("#totalHead").textContent = fmtInt(total);
  return total;
}
async function fetchPaged(table, selectCols, whereQuery){
  const pageSize=1000, out=[]; const total = await headTotal(table, whereQuery);
  if (total===0) return out;
  for (let start=0; start<total; start+=pageSize){
    const end = Math.min(start+pageSize-1, total-1);
    const range = `\${start}-\${end}`;
    const url = `/rest/v1/\${encodeURIComponent(table)}?select=\${encodeURIComponent(selectCols)}\${whereQuery}`;
    const r = await DX.rest(url, { headers:{ Range:`items=\${range}` }});
    if (!r.ok){ const txt=await r.text(); throw new Error(`Erro página Range \${range}: \${r.status} \${txt}`); }
    const part = await r.json(); log(`[DX] Page via Range \${range} got= \${part.length} total= \${total} acc= \${out.length+part.length}`);
    out.push(...part);
  }
  return out;
}

async function run(){
  try{
    if (!DX.state.url || !DX.state.key){ log('Informe URL e Anon Key.','error'); return; }
    if (!DX.state.tabela){ log('Informe a Tabela de vendas (use a lista).','error'); return; }
    if (!DX.state.colData){ log('Informe a Coluna de data.','error'); return; }
    initSupabase();

    const di = new Date(); di.setDate(di.getDate()-30);
    const df = new Date();
    const diStr = (localStorage.getItem('dx_dini') || di.toISOString().slice(0,10));
    const dfStr = (localStorage.getItem('dx_dfim') || df.toISOString().slice(0,10));
    const d0 = diStr; const d1 = new Date(dfStr); d1.setDate(d1.getDate()+1);
    const d1s = d1.toISOString().slice(0,10);

    const col = DX.state.colData;
    const where = `&\${encodeURIComponent(col)}=gte.\${d0}&\${encodeURIComponent(col)}=lt.\${d1s}`;
    const cols = ['id', col]; if (DX.state.colValor) cols.push(DX.state.colValor); if (DX.state.colCancel) cols.push(DX.state.colCancel);
    const data = await fetchPaged(DX.state.tabela, cols.join(','), where);
    log(`[DX] REST paginado trouxe \${data.length} linhas`, 'success');

    const vcol = DX.state.colValor; const totalValor = vcol ? data.reduce((s,r)=>s+(Number(r[vcol])||0),0) : 0;
    $("#kpiValor").textContent = money(totalValor);
    $("#projReceita").textContent = money(totalValor*1.1);
    $("#projPed").textContent = fmtInt(data.length);
    $("#projTick").textContent = money(data.length? totalValor/data.length : 0);
  }catch(e){ log(e.message,'error'); console.error(e); }
}

$("#btnRodarTeste").onclick = run; $("#btnAtualizar").onclick = run;
$("#btnLoadAmostra").onclick = async ()=>{
  try{
    if (!DX.state.tabela || !DX.state.colData){ log('Informe tabela e coluna de data.','warn'); return; }
    const exists = await DX.hasCols(DX.state.tabela, ['id', DX.state.colData]);
    const cols = ['id']; if (exists[DX.state.colData]) cols.push(DX.state.colData);
    if (DX.state.colValor){ const ok = await DX.hasCols(DX.state.tabela,[DX.state.colValor]); if (ok[DX.state.colValor]) cols.push(DX.state.colValor); }
    const { data, error } = await DX.sb.from(DX.state.tabela).select(cols.join(',')).limit(20);
    if (error) throw error;
    renderTableSample(data||[]);
  }catch(e){ log(e.message,'error'); }
};
function renderTableSample(rows){
  const thead=$("#tbl thead"), tbody=$("#tbl tbody"); thead.innerHTML=''; tbody.innerHTML='';
  if (!rows || !rows.length){ thead.innerHTML='<tr><th class="muted">Sem dados</th></tr>'; return; }
  const cols = Object.keys(rows[0]); thead.innerHTML='<tr>'+cols.map(c=>`<th>\${c}</th>`).join('')+'</tr>';
  tbody.innerHTML = rows.map(r=>'<tr>'+cols.map(c=>`<td>\${r[c]??''}</td>`).join('')+'</tr>').join('');
}
</script>
</body>
</html>
