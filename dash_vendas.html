<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diagnóstico Supabase — REST + OpenAPI (v3.2)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='48' fill='%23222'/%3E%3Cpath d='M64 160l64-96 64 96H64z' fill='%23fff'/%3E%3C/svg%3E">
<style>
  :root{
    --bg:#0b0c10; --panel:#121318; --muted:#9aa0a6; --text:#e8eaed; --brand:#8ab4f8; --ok:#34a853; --err:#ea4335;
    --chip:#1f232b; --chip-b:#2b313a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
  header{padding:18px 20px;border-bottom:1px solid #1a1d23;background:#0e1116;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-weight:650;font-size:16px;letter-spacing:.2px}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:420px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid #1a1d23;border-radius:12px;padding:14px}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  input[type=text], input[type=date]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #232732;background:#0e1015;color:var(--text);outline:none}
  input[type=text]::placeholder{color:#78808a}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{appearance:none;border:1px solid #273043;background:#151820;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:#1b2738;border-color:#223045;color:#c8dafc}
  button:disabled{opacity:.6;cursor:not-allowed}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--chip-b);background:var(--chip);cursor:pointer;color:#cfd4db}
  .chip:hover{filter:brightness(1.1)}
  .log{background:#07080c;border:1px solid #1a1d23;border-radius:10px;padding:10px;min-height:90px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .log b{color:#cbd5ff}
  .ok{color:var(--ok)}
  .err{color:var(--err)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #1a1d23}
  th{color:#b9c0c7;text-align:left;position:sticky;top:0;background:#121318}
  .actions{display:flex;gap:8px;align-items:end;margin-top:8px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header><h1>Diagnóstico Supabase — REST + OpenAPI (v3.2)</h1></header>
<main>
  <div class="grid">
    <section class="card">
      <div class="row">
        <div style="flex:1">
          <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
          <input id="url" type="text" placeholder="https://xxxxx.supabase.co">
        </div>
        <div style="flex:1">
          <label>Anon Key</label>
          <input id="key" type="text" placeholder="ey...">
        </div>
      </div>

      <div class="row" style="margin-top:6px;align-items:center">
        <label style="margin:0;display:flex;align-items:center;gap:6px"><input id="onlyPublic" type="checkbox" checked> Somente schema <b>public</b> ?</label>
        <button id="btnOpenApi" class="primary">1) Testar conexão (OpenAPI)</button>
        <button id="btnList">2) Listar tabelas</button>
        <button id="btnSave">Salvar config</button>
      </div>

      <div class="chips" id="chips"></div>

      <div class="row">
        <div style="flex:1">
          <label>Tabela (use <span class="muted">schema.tabela</span> se precisar; dica: clique num chip acima)</label>
          <input id="table" type="text" placeholder="ex.: public.vendas_xlsx">
        </div>
        <div style="flex:1">
          <label>Coluna de data (opcional)</label>
          <input id="datecol" type="text" placeholder="ex.: dia / data / created_at / dh / hora">
        </div>
        <div style="flex:1">
          <label>Coluna de valor (opcional)</label>
          <input id="valcol" type="text" placeholder="ex.: total / valor_total / receita">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Início</label>
          <input id="from" type="date">
        </div>
        <div style="flex:1">
          <label>Fim</label>
          <input id="to" type="date">
        </div>
      </div>

      <div class="actions">
        <button id="btnCount">Contar registros (Content-Range)</button>
        <button id="btnSample" class="primary">Carregar amostra (20)</button>
        <button id="btnClear">Limpar</button>
      </div>

      <label>Log</label>
      <div id="log" class="log">[<b>Pronto</b>] Interface carregada — cole a URL e a Anon Key, depois clique em “<b>Testar conexão</b>”.</div>
    </section>

    <section class="card">
      <div id="output" class="muted">—</div>
    </section>
  </div>
</main>

<script>
const qs = sel => document.querySelector(sel);
const urlEl = qs('#url');
const keyEl = qs('#key');
const onlyPublicEl = qs('#onlyPublic');
const chipsEl = qs('#chips');
const tableEl = qs('#table');
const dateEl = qs('#datecol');
const valEl = qs('#valcol');
const fromEl = qs('#from');
const toEl = qs('#to');
const out = qs('#output');
const logEl = qs('#log');

function log(msg, cls){
  const time = new Date().toTimeString().slice(0,8);
  const span = `<span class="${cls||''}">`+msg+`</span>`;
  logEl.innerHTML += `\\n[${time}] ${span}`;
  logEl.scrollTop = logEl.scrollHeight;
}
function setOut(html){
  out.innerHTML = html;
}

function saveConfig(){
  const cfg = {
    url: urlEl.value.trim(),
    key: keyEl.value.trim(),
    onlyPublic: !!onlyPublicEl.checked,
    table: tableEl.value.trim(),
    datecol: dateEl.value.trim(),
    valcol: valEl.value.trim(),
    from: fromEl.value,
    to: toEl.value
  };
  localStorage.setItem('sb_diag_v32', JSON.stringify(cfg));
  log('Config salva.', 'ok');
}
function loadConfig(){
  try{
    const cfg = JSON.parse(localStorage.getItem('sb_diag_v32')||'{}');
    urlEl.value = cfg.url||'';
    keyEl.value = cfg.key||'';
    onlyPublicEl.checked = !!cfg.onlyPublic;
    tableEl.value = cfg.table||'';
    dateEl.value = cfg.datecol||'';
    valEl.value = cfg.valcol||'';
    fromEl.value = cfg.from||'';
    toEl.value = cfg.to||'';
  }catch(e){}
}
loadConfig();

function parseTable(input){
  // returns { schema: 'public', table: 'vendas_xlsx', path: 'vendas_xlsx' }
  let raw = (input||'').trim();
  let schema = 'public', table = raw;
  if(raw.includes('.')){
    const parts = raw.split('.').filter(Boolean);
    if(parts.length>=2){ schema = parts[0]; table = parts.slice(1).join('.'); }
  }
  // sanitize path (PostgREST expects ONLY the table/view in the path)
  const path = table;
  return {schema, table, path};
}

function headers(schema){
  const key = keyEl.value.trim();
  return {
    apikey: key,
    Authorization: 'Bearer '+key,
    'Accept': 'application/json',
    'Accept-Profile': schema||'public',
    'Content-Profile': schema||'public',
    'Prefer': 'count=exact'
  };
}

async function fetchOpenAPI(){
  saveConfig();
  const base = urlEl.value.trim();
  if(!base || !keyEl.value.trim()){ log('[ERRO] Informe URL e Key.', 'err'); return; }
  setOut('—');
  chipsEl.innerHTML = '';
  log('Carregando OpenAPI…');
  try{
    const res = await fetch(base.replace(/\/+$/,'') + '/rest/v1/', {
      method: 'GET',
      headers: {
        ...headers('public'),
        'Accept': 'application/openapi+json;version=1.0'
      }
    });
    if(!res.ok){
      const txt = await res.text();
      log(`[ERRO] OpenAPI HTTP ${res.status}. ${txt}`, 'err');
      return;
    }
    const spec = await res.json();
    const paths = spec.paths || {};
    // Collect table/view names from paths keys like "/table" or "/schema.table"
    let set = new Set();
    for(const k of Object.keys(paths)){
      const m = k.replace(/^\/+/,''); // remove leading slash
      // ignore RPC
      if(m.startsWith('rpc/')) continue;
      // strip query templates
      const name = m.split('{')[0].replace(/\/+$/,'');
      if(!name) continue;
      set.add(name);
    }
    let list = Array.from(set).filter(n => !n.startsWith('graphql'))
      .filter(n => n.indexOf('.')===-1 || !onlyPublicEl.checked || n.startsWith('public.'));
    // Normalize to show chips without schema for public, with schema for others
    list = list.map(n => {
      if(n.startsWith('public.')) return n; // keep explicit
      if(n.indexOf('.')===-1) return n; // plain
      return n;
    }).sort((a,b)=>a.localeCompare(b));
    chipsEl.innerHTML = '';
    if(list.length===0){
      log('OpenAPI OK. 0 tabelas vistas.');
    }else{
      log(`OpenAPI OK. ${list.length} tabelas vistas.`,'ok');
      for(const name of list){
        const chip = document.createElement('button');
        chip.className='chip';
        chip.textContent = name;
        chip.title = 'Clique para preencher o campo Tabela';
        chip.onclick = ()=>{
          tableEl.value = name;
          saveConfig();
        };
        chipsEl.appendChild(chip);
      }
    }
  }catch(e){
    log('[ERRO] '+e.message, 'err');
  }
}

function buildQuery(params){
  const q = new URLSearchParams();
  for(const [k,v] of Object.entries(params)){
    if(v!==undefined && v!==null) q.append(k, v);
  }
  const s = q.toString();
  return s ? ('?'+s) : '';
}

function iso(d){ return d.toISOString().slice(0,10); }
function addDays(s, n){
  const d = new Date(s+'T00:00:00'); d.setDate(d.getDate()+n); return iso(d);
}

async function countContentRange(){
  saveConfig();
  setOut('—');
  const base = urlEl.value.trim();
  const key = keyEl.value.trim();
  const tbl = tableEl.value.trim();
  if(!base || !key || !tbl){ log('[ERRO] Informe URL, Key e tabela.', 'err'); return; }
  const {schema, path} = parseTable(tbl);
  const dateCol = (dateEl.value||'').trim();
  const from = fromEl.value, to = toEl.value;
  const qs = new URLSearchParams();
  qs.set('select','id');
  if(dateCol && from){
    qs.set(dateCol, 'gte.'+from);
  }
  if(dateCol && to){
    const lt = addDays(to, 1);
    qs.append(dateCol, 'lt.'+lt);
  }
  const url = base.replace(/\/+$/,'') + '/rest/v1/' + encodeURIComponent(path) + (qs.toString()?('?'+qs.toString()):'');
  log('Contando (GET + Content-Range)…');
  try{
    const res = await fetch(url, {
      method: 'GET',
      headers: {
        ...headers(schema),
        Range: '0-0',
        'Range-Unit': 'items'
      }
    });
    if(!res.ok){
      const txt = await res.text();
      log(`[ERRO] Count fallback: HTTP ${res.status}${txt?(' — '+txt):''}`, 'err');
      return;
    }
    const cr = res.headers.get('Content-Range')||'';
    const total = (cr.split('/')[1]||'').trim();
    log(`Count via Content-Range: ${total||'?'}`, 'ok');
  }catch(e){
    log('[ERRO] '+e.message, 'err');
  }
}

async function loadSample(){
  saveConfig();
  const base = urlEl.value.trim();
  const key = keyEl.value.trim();
  const tbl = tableEl.value.trim();
  if(!base || !key || !tbl){ log('[ERRO] Informe URL, Key e tabela.', 'err'); return; }
  const {schema, path} = parseTable(tbl);
  const dateCol = (dateEl.value||'').trim();
  const valCol = (valEl.value||'').trim();
  const from = fromEl.value, to = toEl.value;

  let order = dateCol ? `${dateCol}.asc` : 'id.asc';
  const params = {
    select: '*',
    order,
    limit: 20
  };
  if(dateCol && from){
    params[dateCol] = 'gte.'+from;
  }
  if(dateCol && to){
    const lt = addDays(to, 1);
    if(params[dateCol]){
      // when already exists, we need to add another key with same name -> use URLSearchParams directly later
    }
  }
  // Build URL with possible duplicate date filters
  const usp = new URLSearchParams();
  usp.set('select','*');
  usp.set('order', order);
  usp.set('limit', '20');
  if(dateCol && from) usp.append(dateCol, 'gte.'+from);
  if(dateCol && to) usp.append(dateCol, 'lt.'+addDays(to,1));

  const url = base.replace(/\/+$/,'') + '/rest/v1/' + encodeURIComponent(path) + '?' + usp.toString();
  setOut('Carregando…');
  log('Carregando amostra…');
  try{
    const res = await fetch(url, { headers: headers(schema) });
    const txt = await res.text();
    if(!res.ok){
      log(`[ERRO] HTTP ao carregar amostra. HTTP ${res.status}`,'err');
      setOut(`<pre class="log err">${txt||('HTTP '+res.status)}</pre>`);
      // tentativa automática: se veio "public.public.*", sugerir ajuste (já não usamos mais schema no path)
      return;
    }
    const data = JSON.parse(txt);
    log('Amostra carregada. '+data.length+' linhas.', 'ok');
    renderTable(data);
  }catch(e){
    setOut(`<pre class="log err">${e.message}</pre>`);
    log('[ERRO] '+e.message, 'err');
  }
}

function renderTable(rows){
  if(!rows || !rows.length){ setOut('<div class="muted">Sem dados.</div>'); return; }
  const cols = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
  let html = '<div style="overflow:auto; max-height:70vh"><table><thead><tr>';
  for(const c of cols) html += '<th>'+escapeHtml(c)+'</th>';
  html += '</tr></thead><tbody>';
  for(const r of rows){
    html += '<tr>';
    for(const c of cols){
      let v = r[c];
      if(v===null || v===undefined) v = '';
      if(typeof v==='object') v = JSON.stringify(v);
      html += '<td>'+escapeHtml(String(v))+'</td>';
    }
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  setOut(html);
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// Wire
qs('#btnOpenApi').onclick = fetchOpenAPI;
qs('#btnList').onclick = fetchOpenAPI;
qs('#btnSave').onclick = saveConfig;
qs('#btnCount').onclick = countContentRange;
qs('#btnSample').onclick = loadSample;
qs('#btnClear').onclick = ()=>{ setOut('—'); log('Limpo.'); };

// First paint
log('Use os chips para preencher a tabela sem digitar (evita erros de schema).');

</script>
</body>
</html>
