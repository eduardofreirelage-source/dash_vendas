<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dash de Vendas — Diagnóstico (REST + OpenAPI)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --primary:#2563eb;
      --ring:#c7d2fe;
      --danger:#ef4444;
      --ok:#16a34a;
      --chip:#eef2ff;
      --chip-ink:#3730a3;
      --mono:#0b1020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:0;
      background:var(--bg);
      color:var(--ink);
      font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    h1{font-size:28px; margin:0 0 16px 0}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .card{
      background:var(--card);
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:16px;
      box-shadow:0 1px 2px rgba(0,0,0,.03);
    }
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    label{display:block; font-weight:600; font-size:12px; color:var(--muted); margin:4px 0 6px}
    input[type=text], input[type=date], select, textarea{
      width:100%;
      border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;
      outline:none; background:#fff; color:var(--ink);
    }
    input:focus, select:focus, textarea:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px var(--ring)}
    .btn{
      appearance:none; border:0; border-radius:999px; padding:10px 14px;
      background:var(--primary); color:#fff; font-weight:600; cursor:pointer
    }
    .btn.secondary{background:#e5e7eb; color:#111827}
    .btn.ghost{background:transparent; border:1px solid #d1d5db; color:#111827}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .kpis{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .kpi{background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:14px}
    .kpi h3{margin:0; font-size:12px; color:var(--muted)}
    .kpi .v{font-size:24px; font-weight:700}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .chip{
      background:var(--chip); color:var(--chip-ink); border:1px solid #e5e7eb;
      padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none
    }
    .chip:hover{filter:brightness(.98)}
    .log{
      font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","Courier New",monospace;
      background:#0b1020; color:#bcd;
      border-radius:10px; padding:10px; white-space:pre-wrap; min-height:70px;
    }
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eef2f7; padding:8px 10px; text-align:left}
    th{font-weight:700; color:#475569; background:#fafbff}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dash de Vendas <span class="muted">— Diagnóstico (REST + OpenAPI)</span></h1>

    <div class="row">
      <div class="card" style="flex:1 1 520px; min-width:320px">
        <div class="grid cols-2">
          <div>
            <label>Início</label>
            <input type="date" id="dtIni">
          </div>
          <div>
            <label>Fim</label>
            <input type="date" id="dtFim">
          </div>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><h3>Faturamento</h3><div class="v" id="kpiFat">R$ 0,00</div></div>
          <div class="kpi"><h3>Pedidos</h3><div class="v" id="kpiPed">0</div></div>
          <div class="kpi"><h3>Ticket</h3><div class="v" id="kpiTkt">R$ 0,00</div></div>
        </div>
        <div class="inline" style="margin-top:12px">
          <button class="btn" id="btnAtualizar">Atualizar</button>
          <button class="btn ghost" id="btnTest">Rodar teste</button>
        </div>
      </div>

      <div class="card" style="flex:1 1 520px; min-width:320px">
        <h3 style="margin:0 0 10px">Config (ajuste se auto-detecção falhar)</h3>
        <div class="grid cols-2">
          <div>
            <label>Project URL</label>
            <input type="text" id="projectUrl" placeholder="https://xxxx.supabase.co">
          </div>
          <div>
            <label>Anon Key</label>
            <input type="text" id="anonKey" placeholder="eyJhbGciOi...">
          </div>
          <div class="inline" style="align-items:center; margin-top:6px">
            <input type="checkbox" id="chkPublic" checked>
            <label for="chkPublic" style="margin:0">Somente schema <b>public</b>?</label>
          </div>
        </div>
        <div class="inline" style="margin-top:10px">
          <button class="btn" id="btnOpenApi">Descobrir tabelas e colunas (OpenAPI)</button>
          <span class="muted" id="openapiStatus"></span>
        </div>

        <div class="grid cols-3" style="margin-top:14px">
          <div>
            <label>Tabela de vendas (use schema.tabela se necessário)</label>
            <div class="inline">
              <input type="text" id="salesTable" list="tablesList" placeholder="ex.: public.vendas_canon">
              <datalist id="tablesList"></datalist>
            </div>
          </div>
          <div>
            <label>Coluna de data</label>
            <input type="text" id="dateCol" placeholder="ex.: dia / data / dt / dh / created_at / hora">
          </div>
          <div>
            <label>Coluna de valor (opcional)</label>
            <input type="text" id="valueCol" placeholder="ex.: fat / valor_total / receita">
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Coluna de cancelado (opcional)</label>
            <input type="text" id="cancelCol" placeholder="ex.: cancelado / status">
          </div>
          <div class="inline" style="align-items:flex-end">
            <button class="btn secondary" id="btnSave">Salvar</button>
          </div>
        </div>

        <div class="chips" id="chips"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="inline">
        <strong>Teste rápido</strong>
        <span class="muted">— HEAD com <code>Content-Range</code> e GET de amostra</span>
      </div>

      <div class="inline" style="margin:12px 0">
        <button class="btn" id="btnCount">Contar registros (Content-Range)</button>
        <button class="btn secondary" id="btnSample">Carregar amostra</button>
        <span id="lastUrl" class="muted" style="margin-left:8px"></span>
      </div>
      <div class="log" id="log"></div>

      <h3 style="margin:18px 0 8px">Amostra de dados</h3>
      <div style="overflow:auto">
        <table id="tbl"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const logBox = $('#log');
  const tablesList = $('#tablesList');
  const chipsBox = $('#chips');
  const state = {
    spec:null,
    tables:[],
    guessCols:{},
  };

  const LS_KEY = 'dash_vendas_cfg_v1';
  const fmtBRL = v => (isFinite(v)? v : 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  function setTodayRange(){
    const end = new Date();
    const start = new Date(end);
    start.setDate(end.getDate()-30);
    $('#dtIni').value = start.toISOString().slice(0,10);
    $('#dtFim').value  = end.toISOString().slice(0,10);
  }

  function saveCfg(){
    const cfg = {
      projectUrl: $('#projectUrl').value.trim(),
      anonKey: $('#anonKey').value.trim(),
      publicOnly: $('#chkPublic').checked,
      salesTable: $('#salesTable').value.trim(),
      dateCol: $('#dateCol').value.trim(),
      valueCol: $('#valueCol').value.trim(),
      cancelCol: $('#cancelCol').value.trim(),
    };
    localStorage.setItem(LS_KEY, JSON.stringify(cfg));
    log('Config salva.');
    return cfg;
  }
  function loadCfg(){
    try{
      const cfg = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      if(cfg.projectUrl) $('#projectUrl').value = cfg.projectUrl;
      if(cfg.anonKey)    $('#anonKey').value = cfg.anonKey;
      if(typeof cfg.publicOnly==='boolean') $('#chkPublic').checked = cfg.publicOnly;
      if(cfg.salesTable) $('#salesTable').value = cfg.salesTable;
      if(cfg.dateCol)    $('#dateCol').value = cfg.dateCol;
      if(cfg.valueCol)   $('#valueCol').value = cfg.valueCol;
      if(cfg.cancelCol)  $('#cancelCol').value = cfg.cancelCol;
    }catch(e){}
  }

  function log(msg, type){
    const t = new Date().toTimeString().slice(0,8);
    const line = `[${t}] ${msg}`;
    logBox.textContent += (logBox.textContent? '\\n' : '') + line;
    logBox.scrollTop = logBox.scrollHeight;
    if(type==='url') $('#lastUrl').textContent = 'Última URL: ' + msg;
  }

  function headers(){
    const anon = $('#anonKey').value.trim();
    return {
      'apikey': anon,
      'Authorization': 'Bearer ' + anon,
      'Accept': 'application/json',
      'Prefer': 'count=exact'
    };
  }
  function baseUrl(){
    return $('#projectUrl').value.replace(/\\/$/, '');
  }

  // OpenAPI discovery
  async function discover(){
    try{
      const url = baseUrl() + '/rest/v1/';
      const res = await fetch(url, {headers: headers()});
      if(!res.ok){
        throw new Error('HTTP '+res.status);
      }
      const spec = await res.json();
      state.spec = spec;
      // build list of tables from spec.definitions
      const defs = spec.definitions || {};
      const tables = Object.keys(defs).filter(k=>k!=='_rpc' && !k.startsWith('graphql'));
      state.tables = tables.sort((a,b)=>a.localeCompare(b));
      tablesList.innerHTML = '';
      chipsBox.innerHTML = '';
      const onlyPublic = $('#chkPublic').checked;

      const uniq = [];
      for(const t of state.tables){
        if(onlyPublic && !/^public\\./.test(t)) continue;
        const opt = document.createElement('option'); opt.value = t; tablesList.appendChild(opt);
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = t.replace(/^public\\./,'');
        chip.title = t;
        chip.onclick = ()=>{ $('#salesTable').value = t; tryGuessColumns(t); };
        chipsBox.appendChild(chip);
        uniq.push(t);
      }
      $('#openapiStatus').textContent = `OpenAPI OK. ${uniq.length} tabelas vistas.`;
      log(`OpenAPI carregado. ${uniq.length} tabelas.`);

      // se já houver uma tabela, tentar sugerir colunas
      const current = $('#salesTable').value.trim();
      if(current){ tryGuessColumns(current); }
      else {
        // preferência por vendas_* ou vw_vendas_*
        const pref = uniq.find(n=>/\\b(vendas|vw_vendas)/.test(n));
        if(pref){ $('#salesTable').value = pref; tryGuessColumns(pref); }
      }
    }catch(e){
      log('Falha no OpenAPI: ' + e.message);
    }
  }

  function tryGuessColumns(table){
    try{
      const def = state.spec?.definitions?.[table];
      if(!def) return;
      const props = def.properties ? Object.keys(def.properties) : [];
      // Candidatas de data (em ordem)
      const datePrefs = ['dia','data','dt','dh','created_at','hora'];
      const dCol = datePrefs.find(c=>props.includes(c));
      if(dCol){ $('#dateCol').value = dCol; }
      // Valor
      const valPrefs = ['fat','valor_total','total','receita'];
      const vCol = valPrefs.find(c=>props.includes(c));
      if(vCol && !$('#valueCol').value){ $('#valueCol').value = vCol; }
      // Cancelado
      const cPrefs = ['cancelado','status','canceled'];
      const cCol = cPrefs.find(c=>props.includes(c));
      if(cCol && !$('#cancelCol').value){ $('#cancelCol').value = cCol; }
      log(`Tabela/colunas sugeridas: ${table} | data=${$('#dateCol').value || '?'} | valor=${$('#valueCol').value || '-'} | cancelado=${$('#cancelCol').value || '-'}`);
    }catch(e){}
  }

  function ensureCfg(){
    const cfg = saveCfg();
    if(!cfg.projectUrl || !/^https?:\\/\\//.test(cfg.projectUrl)){ log('Informe Project URL.', 'err'); throw new Error('cfg'); }
    if(!cfg.anonKey){ log('Informe Anon Key.', 'err'); throw new Error('cfg'); }
    if(!cfg.salesTable){ log('Informe tabela de vendas.', 'err'); throw new Error('cfg'); }
    if(!cfg.dateCol){ log('Informe coluna de data.', 'err'); throw new Error('cfg'); }
    if(cfg.dateCol.toLowerCase().includes('hora')){
      log('⚠️ A coluna "hora" é numérica (0-23). Selecione sua coluna de data (ex.: dia/data/dt/dh/created_at).');
      throw new Error('dateCol');
    }
    return cfg;
  }

  function makeDateParams(dateCol){
    const ini = $('#dtIni').value;
    const fim = $('#dtFim').value;
    const usp = new URLSearchParams();
    usp.set('select','id');
    if(dateCol){
      usp.append(dateCol, 'gte.' + ini);
      usp.append(dateCol, 'lt.' + fim);
    }
    return {params:usp, ini, fim};
  }

  async function countRecords(){
    const cfg = ensureCfg();
    const {params, ini, fim} = makeDateParams(cfg.dateCol);
    const url = baseUrl() + '/rest/v1/' + encodeURIComponentPath(cfg.salesTable) + '?' + params.toString();
    log(url, 'url');
    const res = await fetch(url, {method:'HEAD', headers: headers()});
    if(!res.ok){
      log('Erro no count: HTTP ' + res.status); return;
    }
    const cr = res.headers.get('content-range'); // ex.: 0-0/1234
    const total = cr ? parseInt(cr.split('/').pop()||'0',10) : NaN;
    if(!isFinite(total)) log('Sem Content-Range. Adicione Prefer: count=exact.');
    else log('Total via Content-Range: ' + total);
    return total;
  }

  async function loadSample(limit=100){
    const cfg = ensureCfg();
    const {params} = makeDateParams(cfg.dateCol);
    params.set('select','*');
    params.set('limit', String(limit));
    const url = baseUrl() + '/rest/v1/' + encodeURIComponentPath(cfg.salesTable) + '?' + params.toString();
    log(url, 'url');
    const res = await fetch(url, {headers: headers()});
    if(!res.ok){
      log('Erro na amostra: HTTP ' + res.status);
      renderTable([]);
      return [];
    }
    const rows = await res.json();
    renderTable(rows);
    log('Amostra carregada: ' + rows.length + ' linha(s).');
    return rows;
  }

  function encodeURIComponentPath(s){
    // mantém schema.tabela sem codificar o ponto
    return s.replace(/[^A-Za-z0-9_.~-]/g, c => '%' + c.charCodeAt(0).toString(16).toUpperCase());
  }

  function renderTable(rows){
    const thead = $('#tbl thead'); const tbody = $('#tbl tbody');
    thead.innerHTML = ''; tbody.innerHTML = '';
    if(!rows || !rows.length){
      thead.innerHTML = '<tr><th>Nenhum dado</th></tr>';
      return;
    }
    const cols = Object.keys(rows[0]);
    thead.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
    tbody.innerHTML = rows.map(r=>'<tr>' + cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('') + '</tr>').join('');
  }

  function escapeHtml(v){
    if(v===null || v===undefined) return '';
    return String(v).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
  }

  async function updateKPIs(){
    try{
      const cfg = ensureCfg();
      const {params} = makeDateParams(cfg.dateCol);
      params.set('select', [cfg.valueCol || 'fat','pedidos'].filter(Boolean).join(','));
      params.set('limit','1000'); // amostra razoável; para produção use RPC/SQL agregador
      const url = baseUrl() + '/rest/v1/' + encodeURIComponentPath(cfg.salesTable) + '?' + params.toString();
      log(url, 'url');
      const res = await fetch(url, {headers: headers()});
      if(!res.ok){ log('Erro no KPI: HTTP '+res.status); return; }
      const rows = await res.json();
      let totalFat = 0, totalPed = 0;
      for(const r of rows){
        const v = Number(r[cfg.valueCol || 'fat']) || 0;
        const p = Number(r.pedidos) || 0;
        totalFat += v;
        totalPed += p || 1; // fallback se não houver "pedidos"
      }
      const ticket = totalPed ? totalFat/totalPed : 0;
      $('#kpiFat').textContent = fmtBRL(totalFat);
      $('#kpiPed').textContent = String(totalPed);
      $('#kpiTkt').textContent = fmtBRL(ticket);
    }catch(e){
      // apenas log
    }
  }

  // Events
  $('#btnOpenApi').onclick = discover;
  $('#btnSave').onclick = saveCfg;
  $('#btnCount').onclick = countRecords;
  $('#btnSample').onclick = ()=>loadSample(200);
  $('#btnAtualizar').onclick = ()=>{ updateKPIs(); };

  $('#btnTest').onclick = async ()=>{
    try{
      const total = await countRecords();
      await loadSample(50);
      if(Number.isFinite(total)) log('Teste OK. Total='+total);
    }catch(e){
      log('Teste falhou: ' + e.message);
    }
  };

  // init
  setTodayRange();
  loadCfg();
  // tentativa de descobrir ao abrir (se tiver URL e key)
  if($('#projectUrl').value && $('#anonKey').value){
    discover();
  }
})();
</script>
</body>
</html>
