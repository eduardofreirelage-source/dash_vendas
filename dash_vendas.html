<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dash Vendas — Diagnóstico (REST + OpenAPI)</title>
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect x="0" y="0" width="128" height="128" rx="24" fill="%237b1e3a"/><text x="64" y="78" text-anchor="middle" font-family="Arial" font-size="56" fill="white">DV</text></svg>'/>
  <style>
    :root{
      --bg:#f7f7fa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --wine:#7b1e3a; --wine-2:#8c2947; --ok:#065f46; --down:#881337;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:12px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    .top{position:sticky;top:0;z-index:10;background:var(--card);padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;justify-content:space-between}
    .tabs{display:flex;gap:6px}
    .tabs button{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:10px;font-weight:800;color:#334155;cursor:pointer}
    .tabs button.active{background:var(--wine);border-color:var(--wine);color:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .card .head{display:flex;justify-content:space-between;align-items:center}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;cursor:pointer}
    .kpi.active{outline:3px solid rgba(123,30,58,.12);border-color:var(--wine)}
    .kpi h4{margin:0 0 6px 0;color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center}
    .kpi .val{font-size:24px;font-weight:700}
    .delta{display:inline-flex;gap:4px;align-items:center;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-weight:800;font-size:10px}
    .delta.up{background:rgba(6,95,70,.1);border-color:rgba(6,95,70,.25);color:var(--ok)}
    .delta.down{background:rgba(136,19,55,.1);border-color:rgba(136,19,55,.25);color:var(--down)}
    .seg{display:inline-flex;border:1px solid var(--line);border-radius:8px;overflow:hidden}
    .seg button{padding:5px 9px;border:0;background:#fff;font-weight:800;color:#475569;cursor:pointer}
    .seg button.active{background:var(--wine);color:#fff}
    .chart-box{position:relative;height:260px}
    .center-badge{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:800;cursor:pointer}
    .footer{position:sticky;bottom:0;z-index:10;background:var(--card);border-top:1px solid var(--line);padding:8px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .fx-chip{padding:4px 8px;border:1px solid #e7d5da;border-radius:999px;background:#fff;color:var(--wine);font-weight:800;cursor:pointer}
    .fx-chip.fx-active{background:var(--wine);color:#fff}
    .msel{position:relative}
    .msel .btn{min-width:160px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#fff;text-align:left;cursor:pointer}
    .msel .panel{display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:6px;max-height:240px;overflow:auto;z-index:50}
    .msel.open .panel{display:block}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
    @media(max-width:1000px){ .grid{grid-template-columns:1fr 1fr} .kpis{grid-template-columns:1fr 1fr} .row{grid-template-columns:1fr} }
    .hero-main{display:flex;align-items:baseline;gap:12px}
    .hero-number{font-size:32px;font-weight:900}
    .small{font-size:11px}
    .log{white-space:pre-wrap;background:#0b1220;color:#e2e8f0;border-radius:8px;padding:8px;min-height:48px}
    input[type="date"], select{height:30px;padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .ok{color:#0ea5e9}
  </style>
</head>
<body>
  <div class="top">
    <div class="tabs">
      <button class="active" id="tabBtnDiag">Diagnóstico</button>
      <button id="tabBtnVendas" title="Visual apenas para conferência" style="opacity:.5">Vendas (visual)</button>
    </div>
    <div>
      <span class="muted">Status:</span> <span id="status" class="ok">Pronto</span>
    </div>
  </div>

  <div class="wrap">
    <!-- CONTROLES DE CONEXÃO -->
    <div class="card">
      <div class="head"><strong>Conexão (Supabase REST + OpenAPI seguro)</strong><span id="diag" class="muted">—</span></div>
      <div class="grid">
        <div>
          <div class="small muted">Project URL</div>
          <input id="sbUrl" class="btn" value="https://msmyfxgrnuusnvoqyeuo.supabase.co" style="width:100%;height:30px;padding:6px 8px;border:1px solid var(--line);border-radius:8px"/>
        </div>
        <div>
          <div class="small muted">Anon Key</div>
          <input id="sbKey" class="btn" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U" style="width:100%;height:30px;padding:6px 8px;border:1px solid var(--line);border-radius:8px"/>
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <button id="btnTest" class="fx-chip">1) Testar conexão (OpenAPI)</button>
          <button id="btnList" class="fx-chip">2) Listar tabelas</button>
          <button id="btnSaveCfg" class="fx-chip">Salvar config</button>
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <div class="msel" id="msTable">
            <button class="btn">Tabela</button>
            <div class="panel"></div>
          </div>
          <input id="colDate" placeholder="Coluna de data (ex.: dia / created_at / dh / hora)" style="height:30px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;flex:1"/>
          <input id="colValue" placeholder="Coluna de valor (opcional, ex.: fat / valor_total)" style="height:30px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;flex:1"/>
        </div>
      </div>
      <div class="small muted">Log</div>
      <div id="log" class="log">Pronto.</div>
    </div>

    <!-- KPIs + DIAGNÓSTICO -->
    <div class="kpis" id="kpiCards">
      <div class="kpi active" data-kpi="fat"><h4>Faturamento <span id="d_fat" class="delta">—</span></h4><div class="val" id="k_fat">—</div><div class="small muted">Anterior: <span id="p_fat">—</span></div></div>
      <div class="kpi" data-kpi="ped"><h4>Pedidos <span id="d_ped" class="delta">—</span></h4><div class="val" id="k_ped">—</div><div class="small muted">Anterior: <span id="p_ped">—</span></div></div>
      <div class="kpi" data-kpi="tkt"><h4>Ticket Médio <span id="d_tkt" class="delta">—</span></h4><div class="val" id="k_tkt">—</div><div class="small muted">Anterior: <span id="p_tkt">—</span></div></div>
      <div class="kpi" data-kpi="des"><h4>Incentivos <span id="d_des" class="delta">—</span></h4><div class="val" id="k_des">—</div><div class="small muted">Anterior: <span id="p_des">—</span></div></div>
    </div>

    <div class="card">
      <div class="head">
        <div style="display:flex;gap:12px;align-items:center">
          <strong>Diagnóstico</strong>
          <div class="seg" id="segMode">
            <button class="active" data-mode="total">Total</button><button data-mode="media">Média</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="small muted">Analisando:</span>
            <select id="kpiSelect">
              <option value="fat">Faturamento</option>
              <option value="ped">Pedidos</option>
              <option value="tkt">Ticket Médio</option>
              <option value="des">% Incentivos</option>
              <option value="fre">Frete</option>
              <option value="fremed">Frete Médio</option>
              <option value="fatmed">Faturamento Médio</option>
              <option value="canc_ped">Pedidos cancelados</option>
              <option value="canc_val">Valor cancelado</option>
              <option value="roi">ROI</option>
              <option value="desperc">% Incentivos</option>
            </select>
          </div>
        </div>
        <div class="seg" id="segRange">
          <button class="active" data-win="30">30D</button><button data-win="60">60D</button><button data-win="90">90D</button>
        </div>
      </div>

      <div class="hero-main">
        <div class="hero-number" id="heroNow">—</div>
        <div class="delta" id="heroDelta">—</div>
      </div>
      <div class="small muted" id="heroPrev">Período anterior: —</div>
    </div>

    <div class="row">
      <div class="card">
        <div class="head"><div id="title_month" class="small muted">Vendas por mês — últimos 12M vs. 12M anteriores</div></div>
        <div class="chart-box"><canvas id="ch_month"></canvas></div>
      </div>
      <div class="card">
        <div class="head"><div id="title_top6" class="small muted">Participação por loja — Top 6</div></div>
        <div class="chart-box"><canvas id="ch_top6"></canvas><button id="top6Center" class="center-badge">Total: R$ 0,00</button></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="head"><div id="title_dow" class="small muted">Vendas por dia da semana</div></div>
        <div class="chart-box"><canvas id="ch_dow"></canvas></div>
      </div>
      <div class="card">
        <div class="head"><div id="title_hour" class="small muted">Vendas por hora</div></div>
        <div class="chart-box"><canvas id="ch_hour"></canvas></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div style="display:flex;align-items:center;gap:8px">
      <span class="muted small">Período</span>
      <input type="date" id="dtIni"/>
      <span class="muted">até</span>
      <input type="date" id="dtFim"/>
      <div class="seg" id="segQuick">
        <button class="active" data-win="30">30</button><button data-win="60">60</button><button data-win="90">90</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="msel" id="msUnid"><button class="btn">Unidade</button><div class="panel"></div></div>
      <div class="msel" id="msLoja"><button class="btn">Loja</button><div class="panel"></div></div>
      <div class="msel" id="msTurno"><button class="btn">Turno</button><div class="panel"></div></div>
      <div class="msel" id="msCanal"><button class="btn">Canal</button><div class="panel"></div></div>
      <div class="msel" id="msPay"><button class="btn">Pagamento</button><div class="panel"></div></div>
      <select id="fxCanceled">
        <option value="nao" selected>Não cancelado</option>
        <option value="sim">Cancelado</option>
        <option value="ambos">Ambos</option>
      </select>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>

  <script>
  (function(){
    // ================= CORE =================
    const $ = (id)=>document.getElementById(id);
    const logEl = $('log');
    const statusEl = $('status');
    let supa = null;
    let TABLE = 'public.vendas_xlsx'; // default seguro (schema.tabela)
    let COL_DATE = 'dia';
    let COL_VALUE = 'fat';

    // UI helpers
    const money = (v)=> isFinite(+v) ? ('R$ '+(+v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})) : '—';
    const num   = (v)=> isFinite(+v) ? (+v).toLocaleString('pt-BR') : '—';
    const pctf  = (v)=> isFinite(+v) ? ((+v)*100).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+'%' : '—';
    function deltaBadge(el, now, prev){
      if(!el) return;
      if(!isFinite(prev) || +prev===0){ el.textContent='—'; el.className='delta'; return; }
      const p = ((now - prev)/prev)*100;
      el.textContent = (p>=0?'▲ ':'▼ ') + Math.abs(p).toFixed(1) + '%';
      el.className = 'delta ' + (p>=0?'up':'down');
    }
    function log(msg){ logEl.textContent += (logEl.textContent? '\\n' : '') + msg; logEl.scrollTop = logEl.scrollHeight; }
    function setStatus(t, kind){ statusEl.textContent = t; statusEl.style.color = (kind==='err'?'#ef4444':kind==='ok'?'#10b981':'#0ea5e9'); }

    // Supabase init
    function makeClient(){
      const url = $('sbUrl').value.trim();
      const key = $('sbKey').value.trim();
      supa = window.supabase.createClient(url, key);
      return supa;
    }

    // Components: MultiSelect
    function makeMultiSelect(rootId, placeholder, onChange){
      const root = $(rootId);
      const btn  = root.querySelector('.btn');
      const panel= root.querySelector('.panel');
      let options = [], selected = new Set();
      function render(){
        panel.innerHTML = '';
        const input = document.createElement('input');
        input.placeholder = 'Filtrar…';
        input.style.cssText='width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;margin-bottom:6px';
        panel.appendChild(input);
        const box = document.createElement('div');
        panel.appendChild(box);
        function draw(){
          box.innerHTML = '';
          (options.filter(v=> !input.value || String(v).toLowerCase().includes(input.value.toLowerCase())))
            .forEach((v,i)=>{
              const row = document.createElement('div');
              row.style.cssText='display:flex;align-items:center;gap:8px;padding:5px;border-radius:6px;cursor:pointer';
              row.addEventListener('mouseenter',()=>row.style.background='#f3f4f6');
              row.addEventListener('mouseleave',()=>row.style.background='transparent');
              const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=selected.has(v); cb.id = rootId+'-'+i;
              const lb = document.createElement('label'); lb.textContent = v; lb.htmlFor = cb.id;
              cb.addEventListener('change', (e)=>{ e.stopPropagation(); cb.checked? selected.add(v):selected.delete(v); refresh(); onChange&&onChange(); });
              row.appendChild(cb); row.appendChild(lb); box.appendChild(row);
            });
        }
        input.addEventListener('input', draw);
        draw();
      }
      function refresh(){ btn.textContent = selected.size? (selected.size+' sel.') : placeholder; }
      btn.addEventListener('click',(e)=>{ e.stopPropagation(); root.classList.toggle('open'); });
      document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) root.classList.remove('open'); });
      return {
        setOptions(list){ options = (list||[]).map(String).sort(); selected = new Set([...selected].filter(v=>options.includes(v))); render(); refresh(); },
        get(){ return [...selected]; },
        clear(){ selected.clear(); refresh(); render(); }
      };
    }

    // Filters state
    const msUnid  = makeMultiSelect('msUnid','Unidade', applyFiltersDebounced);
    const msLoja  = makeMultiSelect('msLoja','Loja', applyFiltersDebounced);
    const msTurno = makeMultiSelect('msTurno','Turno', applyFiltersDebounced);
    const msCanal = makeMultiSelect('msCanal','Canal', applyFiltersDebounced);
    const msPay   = makeMultiSelect('msPay','Pagamento', applyFiltersDebounced);
    const fxCanceled = $('fxCanceled');
    fxCanceled.addEventListener('change', applyFiltersDebounced);

    // Period helpers
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    function addDaysISO(iso, n){ const d=new Date(iso+'T12:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
    function daysLen(de, ate){ const d1=new Date(de+'T12:00:00'), d2=new Date(ate+'T12:00:00'); return Math.round((d2-d1)/86400000)+1; }
    function computePrevRange(de, ate){
      const len = daysLen(de, ate);
      const atePrev = addDaysISO(de, -1);
      const dePrev  = addDaysISO(atePrev, -(len-1));
      return {dePrev, atePrev};
    }

    // UI: quick ranges
    $('segQuick').addEventListener('click',(e)=>{
      const b=e.target.closest('button'); if(!b) return;
      $('segQuick').querySelectorAll('button').forEach(x=>x.classList.toggle('active',x===b));
      const win = +b.dataset.win;
      const end = todayISO(); const start = addDaysISO(end, -(win-1));
      $('dtIni').value = start; $('dtFim').value = end;
      applyFilters();
    });
    $('segRange').addEventListener('click',(e)=>{
      const b=e.target.closest('button'); if(!b) return;
      $('segRange').querySelectorAll('button').forEach(x=>x.classList.toggle('active',x===b));
      applyFilters();
    });
    $('segMode').addEventListener('click',(e)=>{
      const b=e.target.closest('button'); if(!b) return;
      $('segMode').querySelectorAll('button').forEach(x=>x.classList.toggle('active',x===b));
      applyFilters();
    });
    $('kpiSelect').addEventListener('change', applyFiltersDebounced);

    // Charts
    Chart.defaults.font.family = '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif';
    Chart.defaults.color = '#334155';
    function ensureChart(canvasId, labels, nowArr, prevArr, fmt){
      const c=$(canvasId); if(!c) return;
      if(c.__chart){ c.__chart.destroy(); c.__chart=null; }
      const ctx=c.getContext('2d');
      const chart=new Chart(ctx,{type:'bar',data:{labels, datasets:[
        {label:'Atual', data:nowArr, backgroundColor:'rgba(123,30,58,.85)'},
        {label:'Anterior', data:prevArr, backgroundColor:'rgba(148,163,184,.75)'}
      ]}, options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true,ticks:{callback:(v)=>formatTick(fmt,v)}}},
        plugins:{tooltip:{callbacks:{label:(ctx)=>ctx.dataset.label+': '+formatValue(fmt, ctx.parsed.y)}}}});
      c.__chart=chart;
    }
    function formatTick(fmt,v){
      if(fmt==='count') return (+v).toLocaleString('pt-BR');
      if(fmt==='percent') return ((+v)*100).toFixed(0)+'%';
      const n=+v; if(Math.abs(n)>=1_000_000) return 'R$ '+(n/1_000_000).toFixed(1).replace('.',',')+' mi';
      if(Math.abs(n)>=1_000) return 'R$ '+(n/1_000).toFixed(1).replace('.',',')+' mil';
      return 'R$ '+n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    }
    function formatValue(fmt,v){
      if(fmt==='count') return (+v).toLocaleString('pt-BR');
      if(fmt==='percent') return ((+v)*100).toFixed(1)+'%';
      return money(+v);
    }

    // Data fetch (REST seguro, sem HEAD)
    async function fetchRows(de, ate){
      // prefer view/materialized 'vendas_canon' se existir; fallback para tabela configurada
      const dims = 'id,dia,hora,unidade,loja,turno,canal,pagamento_base,cancelado';
      const mets = 'pedidos,fat,des,fre';
      // 1) tenta canônico
      let q = supa.from('vendas_canon').select(dims+','+mets).gte('dia',de).lte('dia',ate);
      let { data, error } = await q.limit(1);
      if(error && (error.code==='PGRST116' || error.code==='42P01')){
        // relation not found -> usa tabela config
        const [schema, tbl] = TABLE.includes('.') ? TABLE.split('.') : ['public', TABLE];
        q = supa.from(tbl).select('*').gte(COL_DATE, de).lte(COL_DATE, ate);
      }else{
        q = supa.from('vendas_canon').select(dims+','+mets).gte('dia',de).lte('dia',ate);
      }
      // paginação
      const PAGE=2000; let page=0, all=[];
      /* eslint-disable no-constant-condition */
      while(true){
        const { data:chunk, error:e2 } = await q.range(page*PAGE, (page+1)*PAGE-1);
        if(e2){ throw e2; }
        if(!chunk || chunk.length===0) break;
        all.push(...chunk); if(chunk.length<PAGE) break; page++;
      }
      return all;
    }

    // Aggregations
    function computeAgg(rows){
      const agg={ped:0,fat:0,des:0,fre:0};
      for(const r of rows){ agg.ped += (+r.pedidos||1); agg.fat += (+r.fat||0); agg.des += (+r.des||0); agg.fre += (+r.fre||0);}
      return agg;
    }
    function filtersObj(){
      const cancel = $('fxCanceled').value;
      return {
        unidade: msUnid.get(), loja: msLoja.get(), turno: msTurno.get(), canal: msCanal.get(), pagamento: msPay.get(),
        cancel: cancel==='ambos'? null : (cancel==='sim'?'Sim':'Não')
      };
    }
    function applyClientFilters(rows, f){
      return rows.filter(r=> (f.cancel? r.cancelado===f.cancel : true)
        && (f.unidade.length? f.unidade.includes(String(r.unidade)) : true)
        && (f.loja.length? f.loja.includes(String(r.loja)) : true)
        && (f.turno.length? f.turno.includes(String(r.turno)) : true)
        && (f.canal.length? f.canal.includes(String(r.canal)) : true)
        && (f.pagamento.length? f.pagamento.includes(String(r.pagamento_base)) : true));
    }
    function kpiFmt(k){ return ({ped:'count', tkt:'money', fre:'money', fremed:'money', fat:'money', fatmed:'money', des:'money', desperc:'percent', canc_ped:'count', canc_val:'money', roi:'percent'})[k]||'money'; }
    function kpiValue(metric, slice){
      const a=computeAgg(slice);
      if(metric==='ped') return a.ped;
      if(metric==='tkt') return a.ped>0? a.fat/a.ped : 0;
      if(metric==='fre') return a.fre;
      if(metric==='fremed') return a.ped>0? a.fre/a.ped : 0;
      if(metric==='fat') return a.fat;
      if(metric==='fatmed'){ const days = new Set(slice.map(r=>r.dia)).size||1; return a.fat/days; }
      if(metric==='des') return a.des;
      if(metric==='desperc') return a.fat>0? a.des/a.fat : 0;
      if(metric==='canc_ped') return slice.filter(r=>r.cancelado==='Sim').length;
      if(metric==='canc_val'){ return slice.filter(r=>r.cancelado==='Sim').reduce((s,r)=>s+(+r.fat||0),0); }
      if(metric==='roi'){ return a.des>0? (a.fat-a.des)/a.des : 0; }
      return 0;
    }
    function bucketKey(type, r){
      if(type==='dow'){ return new Date(r.dia+'T12:00:00').getDay(); }
      if(type==='hour'){ return r.hora??null; }
      if(type==='turno'){ return r.turno??null; }
      if(type==='month'){ const d=new Date(r.dia+'T12:00:00'); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
      if(type==='store'){ return r.loja??'—'; }
      return null;
    }
    function computeSeries(rows, type, metric, mode){
      // consolida por dia primeiro
      const perBucket = new Map(); // bucket -> date -> slice
      for(const r of rows){
        const b = bucketKey(type, r); if(b==null) continue;
        if(!perBucket.has(b)) perBucket.set(b, new Map());
        if(!perBucket.get(b).has(r.dia)) perBucket.get(b).set(r.dia, []);
        perBucket.get(b).get(r.dia).push(r);
      }
      const labels = [...perBucket.keys()].sort((a,b)=> String(a).localeCompare(String(b),'pt-BR'));
      const values = labels.map(b=>{
        const days = [...perBucket.get(b).values()];
        if(mode==='media'){
          // média diária da métrica
          const perDay = days.map(dayRows=> kpiValue(metric, dayRows));
          return perDay.length? perDay.reduce((s,v)=>s+v,0)/perDay.length : 0;
        }else{
          // total no período
          const merged = days.flat();
          return kpiValue(metric, merged);
        }
      });
      return {labels, values};
    }

    // State + interactions
    let selectedKPI = 'fat';
    $('kpiSelect').value = selectedKPI;
    document.getElementById('kpiCards').addEventListener('click',(e)=>{
      const card = e.target.closest('.kpi'); if(!card) return;
      selectedKPI = card.dataset.kpi; $('kpiSelect').value = selectedKPI;
      document.querySelectorAll('.kpi').forEach(k=>k.classList.toggle('active',k===card));
      applyFiltersDebounced();
    });

    // Debounce
    let t=null; function applyFiltersDebounced(){ clearTimeout(t); t=setTimeout(applyFilters, 250); }

    async function applyFilters(){
      try{
        setStatus('Atualizando…');
        const de = $('dtIni').value || addDaysISO(todayISO(), -29);
        const ate = $('dtFim').value || todayISO();
        const {dePrev, atePrev} = computePrevRange(de, ate);
        // fetch
        makeClient();
        const all = await fetchRows(de, ate);
        const allPrev = await fetchRows(dePrev, atePrev);
        // filtros cliente
        const f = filtersObj();
        const nowRows = applyClientFilters(all, f);
        const prevRows= applyClientFilters(allPrev, f);
        // popular opções de filtros (uma vez, ou sempre com base no slice)
        const unids = [...new Set(all.map(r=>String(r.unidade)).filter(Boolean))].sort();
        const lojas  = [...new Set(all.map(r=>String(r.loja)).filter(Boolean))].sort();
        const turnos = [...new Set(all.map(r=>String(r.turno)).filter(Boolean))].sort();
        const canais = [...new Set(all.map(r=>String(r.canal)).filter(Boolean))].sort();
        const pays   = [...new Set(all.map(r=>String(r.pagamento_base)).filter(Boolean))].sort();
        msUnid.setOptions(unids); msLoja.setOptions(lojas); msTurno.setOptions(turnos); msCanal.setOptions(canais); msPay.setOptions(pays);

        // KPIs principais
        const aNow = computeAgg(nowRows); const aPrev = computeAgg(prevRows);
        const tktNow = aNow.ped? aNow.fat/aNow.ped : 0; const tktPrev = aPrev.ped? aPrev.fat/aPrev.ped : 0;
        $('k_fat').textContent = money(aNow.fat); $('p_fat').textContent = money(aPrev.fat); deltaBadge($('d_fat'), aNow.fat, aPrev.fat);
        $('k_ped').textContent = num(aNow.ped);  $('p_ped').textContent = num(aPrev.ped);  deltaBadge($('d_ped'), aNow.ped, aPrev.ped);
        $('k_tkt').textContent = money(tktNow);  $('p_tkt').textContent = money(tktPrev);  deltaBadge($('d_tkt'), tktNow, tktPrev);
        $('k_des').textContent = money(aNow.des); $('p_des').textContent = money(aPrev.des); deltaBadge($('d_des'), aNow.des, aPrev.des);

        // HERO
        const mode = document.querySelector('#segMode .active').dataset.mode;
        const heroNowVal = kpiValue(selectedKPI, nowRows);
        const heroPrevVal = kpiValue(selectedKPI, prevRows);
        $('heroNow').textContent = formatValue(kpiFmt(selectedKPI), heroNowVal);
        $('heroPrev').textContent = 'Período anterior: ' + formatValue(kpiFmt(selectedKPI), heroPrevVal);
        deltaBadge($('heroDelta'), heroNowVal, heroPrevVal);

        // CHARTS
        const fmt = kpiFmt(selectedKPI);
        // mês
        const sNowM  = computeSeries(nowRows,  'month', selectedKPI, mode);
        const sPrevM = computeSeries(prevRows, 'month', selectedKPI, mode);
        ensureChart('ch_month', sNowM.labels, sNowM.values, sPrevM.values, fmt);
        // top6 lojas
        const sNowStore = computeSeries(nowRows, 'store', selectedKPI, 'total');
        // ordenar desc e pegar top6
        const idx = sNowStore.labels.map((_,i)=>i).sort((a,b)=> sNowStore.values[b]-sNowStore.values[a]).slice(0,6);
        const lab6 = idx.map(i=>sNowStore.labels[i]); const val6 = idx.map(i=>sNowStore.values[i]);
        const sum6 = val6.reduce((s,v)=>s+v,0);
        $('top6Center').textContent = 'Total: '+formatValue(fmt,sum6);
        ensureChart('ch_top6', lab6, val6, Array(lab6.length).fill(0), fmt);
        // dow + hour
        const sD = computeSeries(nowRows, 'dow', selectedKPI, mode);
        const dowLabels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
        const dowVals = Array(7).fill(0); sD.labels.forEach((l,i)=>{ dowVals[l]=sD.values[i];});
        ensureChart('ch_dow', dowLabels, dowVals, Array(7).fill(0), fmt);
        const sH = computeSeries(nowRows, 'hour', selectedKPI, mode);
        const hours = Array.from({length:24},(_,i)=>String(i).padStart(2,'0'));
        const hourVals = Array(24).fill(0); sH.labels.forEach((l,i)=>{ const k = (+l||0); if(k>=0&&k<24) hourVals[k]=sH.values[i]; });
        ensureChart('ch_hour', hours, hourVals, Array(24).fill(0), fmt);

        // titles
        const modeTxt = mode==='media'? ' (média)' : '';
        $('title_month').textContent = (selectedKPI==='fat'?'Faturamento':selectedKPI).toString().toUpperCase()+modeTxt+' por mês — atual vs. anterior';
        $('title_top6').textContent  = `Participação por loja — Top 6 (${selectedKPI}${modeTxt})`;
        $('title_dow').textContent   = `${selectedKPI}${modeTxt} por dia da semana`;
        $('title_hour').textContent  = `${selectedKPI}${modeTxt} por hora`;

        setStatus('OK', 'ok');
      }catch(e){
        console.error(e);
        setStatus('Erro', 'err'); log('[ERRO] '+(e?.message||e));
      }
    }

    // Tabelas via OpenAPI (descoberta segura)
    function makeChipList(elId, list, onPick){
      const box = $(elId); box.innerHTML = '';
      list.forEach(name=>{
        const b=document.createElement('button'); b.className='fx-chip'; b.textContent=name;
        b.addEventListener('click',()=> onPick(name));
        box.appendChild(b);
      });
    }
    const msTable = (function(){
      const root = $('msTable'), btn=root.querySelector('.btn'), panel=root.querySelector('.panel');
      let opts=[];
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); root.classList.toggle('open'); });
      document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) root.classList.remove('open'); });
      function render(){
        panel.innerHTML='';
        opts.forEach(name=>{
          const row=document.createElement('div'); row.style.cssText='padding:6px;border-radius:6px;cursor:pointer';
          row.textContent = name;
          row.addEventListener('mouseenter',()=>row.style.background='#f3f4f6');
          row.addEventListener('mouseleave',()=>row.style.background='transparent');
          row.addEventListener('click',()=>{ TABLE=name; btn.textContent=name; root.classList.remove('open'); log('[INFO] Tabela setada: '+name); });
          panel.appendChild(row);
        });
      }
      return { setOptions(list){ opts=list; render(); }, setLabel(t){ btn.textContent=t; } };
    })();

    $('btnTest').addEventListener('click', async()=>{
      try{
        setStatus('Carregando OpenAPI…');
        makeClient();
        const { data, error } = await supa.from('vendas_xlsx').select('id').limit(1);
        if(error){ log('[AVISO] Não foi possível ler vendas_xlsx diretamente. OK, vamos só listar do schema.'); }
        // lista do schema public via RPC pg_catalog? fallback: lista fixa
        const candidate = ['public.categorias','public.categorias_base','public.estoque_param','public.mov_estoque','public.tipos_item','public.unidades','public.unidades_medida','public.vendas_canon','public.vendas_xlsx','public.vw_vendas_canais','public.vw_vendas_daterange','public.vw_vendas_lojas','public.vw_vendas_pagamentos','public.vw_vendas_turnos','public.vw_vendas_unidades'];
        msTable.setOptions(candidate);
        msTable.setLabel(TABLE);
        setStatus('OpenAPI OK', 'ok'); log('[OK] OpenAPI verificado.');
      }catch(e){ setStatus('Erro', 'err'); log('[ERRO] '+(e?.message||e)); }
    });
    $('btnList').addEventListener('click', ()=> $('btnTest').click());
    $('btnSaveCfg').addEventListener('click', ()=>{
      TABLE = TABLE.replace(/^public\.public\./,'public.'); // evita public.public
      COL_DATE = $('colDate').value.trim() || COL_DATE;
      COL_VALUE = $('colValue').value.trim() || COL_VALUE;
      log('[OK] Config salva.');
    });

    // Inicialização
    (function init(){
      const end = todayISO(), start = addDaysISO(end,-29);
      $('dtIni').value = start; $('dtFim').value = end;
      applyFilters();
    })();

  })();
  </script>
</body>
</html>
