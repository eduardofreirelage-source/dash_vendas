<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Diagnóstico Supabase — REST + OpenAPI</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='7' fill='%2300c853'/%3E%3Ctext x='8' y='11' font-size='9' text-anchor='middle' fill='white'%3EDS%3C/text%3E%3C/svg%3E">
<style>
:root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#2563eb;--chip:#eef2ff;--ok:#10b981;--err:#ef4444;--border:#e5e7eb}
*{box-sizing:border-box}
html,body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 1px rgba(0,0,0,.03);padding:16px}
h1{font-size:22px;margin:0 0 8px}
small.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:var(--muted)}
label{font-size:12px;color:var(--muted);display:block;margin:12px 0 6px}
input[type=text],input[type=password],input[type=date]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
button.ghost{background:#f9fafb}
button:disabled{opacity:.5;cursor:not-allowed}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px dashed #c7d2fe;color:#4338ca;font-size:12px;cursor:pointer;user-select:none}
.chip:hover{filter:brightness(.98)}
.log{background:#0b1220;border-radius:12px;color:#cbd5e1;font-family:ui-monospace,Menlo,Consolas,monospace;padding:12px;height:120px;overflow:auto;white-space:pre-wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:13px}
.table th{color:#374151;background:#fafafa;position:sticky;top:0;z-index:1}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px}
.badge.ok{background:#ecfdf5;color:#065f46}
.badge.err{background:#fef2f2;color:#991b1b}
.flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
footer{max-width:1200px;margin:8px auto 24px;padding:0 16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="card" id="cfg">
    <h1>Diagnóstico Supabase</h1>
    <small class="mono">REST + OpenAPI (v2 seguro)</small>

    <label>Project URL</label>
    <input id="projectUrl" type="text" placeholder="https://xxxxx.supabase.co">

    <label>Anon Key</label>
    <input id="anonKey" type="password" placeholder="••••••••••••••••">

    <div class="flex" style="margin:8px 0 12px">
      <label style="margin:0;display:flex;align-items:center;gap:6px">
        <input id="onlyPublic" type="checkbox" checked> Somente schema <b>public</b> ?
      </label>
      <button id="btnOpenAPI" class="ghost">1) Testar conexão (OpenAPI)</button>
      <button id="btnList" class="ghost">2) Listar tabelas</button>
      <button id="btnSave" class="">Salvar config</button>
    </div>

    <div id="tablesWrap" class="chips"></div>

    <div class="row">
      <div>
        <label>Tabela (use <span class="mono">schema.tabela</span> se precisar)</label>
        <input id="table" type="text" placeholder="ex.: public.vendas_xlsx">
      </div>
      <div>
        <label>Coluna de data (opcional)</label>
        <input id="dateCol" type="text" placeholder="ex.: dia / created_at / dh / hora">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Coluna de valor (opcional)</label>
        <input id="valueCol" type="text" placeholder="ex.: total / valor_total / receita">
      </div>
      <div>
        <label>Coluna de cancelado (opcional)</label>
        <input id="cancelCol" type="text" placeholder="ex.: cancelado / status">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Início</label>
        <input id="dtStart" type="date">
      </div>
      <div>
        <label>Fim</label>
        <input id="dtEnd" type="date">
      </div>
    </div>

    <div class="flex" style="margin-top:12px">
      <button id="btnCount" class="primary">Contar registros (Content-Range)</button>
      <button id="btnSample" class="">Carregar amostra (20)</button>
      <button id="btnClear" class="ghost">Limpar</button>
      <span id="status" class="badge ok" style="display:none"></span>
    </div>

    <label style="margin-top:14px">Log</label>
    <div id="log" class="log">Pronto.</div>
  </div>

  <div class="card" id="dataCard">
    <div class="flex" style="justify-content:space-between">
      <h1 style="margin-bottom:0">Amostra de dados</h1>
      <small id="lastUrl" class="mono"></small>
    </div>
    <div style="overflow:auto;max-height:70vh">
      <table id="grid" class="table"></table>
    </div>
  </div>
</div>

<footer>Se um endpoint retornar 400 no HEAD, a contagem faz fallback para GET com <span class="mono">Range: 0-0</span> e, por fim, <span class="mono">select=count:count()</span>.</footer>

<script>
(function(){
  "use strict";

  const els = {
    projectUrl: document.getElementById('projectUrl'),
    anonKey: document.getElementById('anonKey'),
    onlyPublic: document.getElementById('onlyPublic'),
    btnOpenAPI: document.getElementById('btnOpenAPI'),
    btnList: document.getElementById('btnList'),
    btnSave: document.getElementById('btnSave'),
    tablesWrap: document.getElementById('tablesWrap'),
    table: document.getElementById('table'),
    dateCol: document.getElementById('dateCol'),
    valueCol: document.getElementById('valueCol'),
    cancelCol: document.getElementById('cancelCol'),
    dtStart: document.getElementById('dtStart'),
    dtEnd: document.getElementById('dtEnd'),
    btnCount: document.getElementById('btnCount'),
    btnSample: document.getElementById('btnSample'),
    btnClear: document.getElementById('btnClear'),
    log: document.getElementById('log'),
    status: document.getElementById('status'),
    grid: document.getElementById('grid'),
    lastUrl: document.getElementById('lastUrl'),
  };

  const LSKEY = 'diag_supabase_v2';
  let openapi = null;
  let listedTables = [];

  // utils
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
  function appendLog(msg, cls){
    const time = new Date().toTimeString().slice(0,8);
    const line = `[${time}] ${msg}`;
    els.log.textContent = (els.log.textContent ? els.log.textContent + "\\n" : "") + line;
    els.log.scrollTop = els.log.scrollHeight;
    if(cls){
      els.status.style.display = 'inline-block';
      els.status.className = 'badge ' + (cls==='ok'?'ok':'err');
      els.status.textContent = (cls==='ok'?'OK':'ERRO');
    }
  }
  function saveCfg(){
    const cfg = {
      projectUrl: els.projectUrl.value.trim(),
      anonKey: els.anonKey.value.trim(),
      onlyPublic: els.onlyPublic.checked,
      table: els.table.value.trim(),
      dateCol: els.dateCol.value.trim(),
      valueCol: els.valueCol.value.trim(),
      cancelCol: els.cancelCol.value.trim(),
      dtStart: els.dtStart.value,
      dtEnd: els.dtEnd.value,
    };
    localStorage.setItem(LSKEY, JSON.stringify(cfg));
    appendLog('Config salva.', 'ok');
    return cfg;
  }
  function loadCfg(){
    try{
      const cfg = JSON.parse(localStorage.getItem(LSKEY)||'{}');
      for(const k in cfg){
        if(els[k]) els[k].value !== undefined ? els[k].value = cfg[k] : els[k].checked = !!cfg[k];
      }
    }catch(e){}
  }
  function assertBasic(){
    const url = els.projectUrl.value.trim().replace(/\/+$/,''); // no trailing slash
    const key = els.anonKey.value.trim();
    if(!url || !/^https:\/\/.+\.supabase\.co$/i.test(url)){
      throw new Error('Informe Project URL válido (https://xxxx.supabase.co).');
    }
    if(!key) throw new Error('Informe o Anon Key.');
    return {url, key};
  }
  function normalizeTable(name){
    // não duplicar "public."
    name = (name||'').trim();
    return name.replace(/^public\.public\./,'public.').replace(/^public\.(public\.)/,'public.').replace(/^public\.public\./,'public.');
  }
  function buildDateFilters(dateCol, start, end){
    const qp = [];
    if(!dateCol) return qp;
    if(start){
      qp.push(`${encodeURIComponent(dateCol)}=gte.${encodeURIComponent(start)}`);
    }
    if(end){
      qp.push(`${encodeURIComponent(dateCol)}=lt.${encodeURIComponent(end)}`);
    }
    return qp;
  }
  function toISODate(d){ // yyyy-mm-dd
    return d ? new Date(d+'T00:00:00').toISOString().slice(0,10) : '';
  }
  function plusOneDay(d){ const x=new Date(d+'T00:00:00'); x.setDate(x.getDate()+1); return x.toISOString().slice(0,10); }

  async function fetchJSON(url, opts={}){
    const res = await fetch(url, opts);
    if(!res.ok) {
      const txt = await res.text().catch(()=>'');
      throw new Error(`${res.status} ${res.statusText}${txt?` — ${txt}`:''}`);
    }
    const ct = res.headers.get('content-type')||'';
    return ct.includes('json') ? res.json() : res.text();
  }

  // OpenAPI
  async function loadOpenAPI(){
    const {url, key} = assertBasic();
    const oUrl = `${url}/rest/v1/?`;
    appendLog('Carregando OpenAPI…');
    const res = await fetch(oUrl, {
      method: 'GET',
      headers: {
        'apikey': key,
        'Authorization': `Bearer ${key}`,
        'Accept': 'application/openapi+json',
      }
    });
    if(!res.ok){
      const t = await res.text().catch(()=>'');
      appendLog(`[ERRO] OpenAPI: ${res.status} ${res.statusText} ${t}`,'err');
      throw new Error('OpenAPI falhou');
    }
    openapi = await res.json();
    const paths = Object.keys(openapi.paths||{});
    const tables = new Set();
    for(const p of paths){
      const m = p.match(/\/rest\/v1\/([^/?]+)$/);
      if(m){
        const t = m[1];
        if(els.onlyPublic.checked){
          // ignorar schemas que não sejam public, exceto quando não há schema
          if(t.includes('.')){
            if(t.startsWith('public.')) tables.add(t);
          }else{
            tables.add(t);
          }
        }else{
          tables.add(t);
        }
      }
    }
    listedTables = Array.from(tables).sort();
    appendLog(`OpenAPI OK. ${listedTables.length} tabelas vistas.`, 'ok');
  }

  function renderChips(){
    els.tablesWrap.innerHTML = '';
    listedTables.forEach(t => {
      const b = document.createElement('button');
      b.textContent = t;
      b.className = 'chip';
      b.title = 'Clique para preencher a caixa de tabela';
      b.onclick = ()=> { els.table.value = t; saveCfg(); };
      els.tablesWrap.appendChild(b);
    });
  }

  function setLastUrl(u){ els.lastUrl.textContent = u; }

  function renderTable(rows){
    const grid = els.grid;
    grid.innerHTML='';
    if(!rows || !rows.length){ grid.innerHTML='<tr><td>Nenhum dado.</td></tr>'; return; }
    const cols = Object.keys(rows[0]);
    const thead = `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
    const body = rows.map(r=> `<tr>${cols.map(c=>`<td>${r[c]===null?'—':(typeof r[c]==='number'?r[c]:String(r[c]))}</td>`).join('')}</tr>` ).join('');
    grid.innerHTML = thead + body;
  }

  function buildBaseUrl(selectFrag='*', limit=null){
    const {url} = assertBasic();
    const table = normalizeTable(els.table.value);
    if(!table) throw new Error("Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx).");
    const schemaTable = table; // já normalizado
    const u = new URL(`${url}/rest/v1/${schemaTable}`);
    u.searchParams.set('select', selectFrag);
    if(limit!=null) u.searchParams.set('limit', String(limit));
    return u;
  }

  function deriveDateBounds(){
    const col = (els.dateCol.value||'').trim();
    if(!col) return {col:'', start:'', end:''};
    const s = els.dtStart.value ? toISODate(els.dtStart.value) : '';
    const e = els.dtEnd.value ? plusOneDay(toISODate(els.dtEnd.value)) : '';
    return {col, start:s, end:e};
  }

  function applyDateFilters(u, dateInfo){
    if(!dateInfo.col) return;
    if(dateInfo.start) u.searchParams.append(dateInfo.col, 'gte.'+dateInfo.start);
    if(dateInfo.end) u.searchParams.append(dateInfo.col, 'lt.'+dateInfo.end);
  }

  async function countExact(){
    const {key} = assertBasic();
    const dateInfo = deriveDateBounds();
    let u = buildBaseUrl('id', null);
    applyDateFilters(u, dateInfo);

    // 1) Tentar GET com Range 0-0 (mais aceito que HEAD em alguns setups)
    try{
      appendLog('Contando (GET + Content-Range)…');
      setLastUrl(u.toString());
      const res = await fetch(u.toString(), {
        method: 'GET',
        headers: {
          'apikey': key,
          'Authorization': `Bearer ${key}`,
          'Accept': 'application/json',
          'Prefer': 'count=exact',
          'Range': '0-0'
        }
      });
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      const cr = res.headers.get('content-range')||res.headers.get('Content-Range');
      if(cr && /\/(\d+)$/.test(cr)){
        const total = RegExp.$1;
        appendLog(`Count via Content-Range: ${total}`,'ok');
        return Number(total);
      }
      // Se não vier o header, ainda dá para contar pelo corpo (1 linha ou 0)
      const data = await res.json().catch(()=>[]);
      appendLog(`Count indireto: ${data.length>0?'>=1':'0'} (sem Content-Range)`,'ok');
      return data.length>0 ? 1 : 0;
    }catch(e){
      appendLog(`[WARN] GET+Content-Range falhou (${e.message}). Tentando count agregada…`);
    }

    // 2) Fallback: agregação count:count()
    try{
      const u2 = buildBaseUrl('count:count()', null);
      applyDateFilters(u2, dateInfo);
      setLastUrl(u2.toString());
      const data = await fetchJSON(u2.toString(), {
        headers: {
          'apikey': key,
          'Authorization': `Bearer ${key}`,
          'Accept': 'application/json'
        }
      });
      const n = Array.isArray(data) && data[0] && (data[0].count|0);
      appendLog(`Count via agregação: ${n}`,'ok');
      return n|0;
    }catch(e){
      appendLog(`[ERRO] Count falhou: ${e.message}`,'err');
      throw e;
    }
  }

  async function loadSample(limit=20){
    const {key} = assertBasic();
    const valueCol = (els.valueCol.value||'').trim();
    const cancelCol = (els.cancelCol.value||'').trim();

    const u = buildBaseUrl('*', limit);
    const dateInfo = deriveDateBounds();
    applyDateFilters(u, dateInfo);
    // ordenar por data desc se existir
    if(dateInfo.col) u.searchParams.append('order', `${dateInfo.col}.desc.nullslast`);

    setLastUrl(u.toString());
    appendLog('Carregando amostra…');
    try{
      const data = await fetchJSON(u.toString(), {
        headers: {
          'apikey': key,
          'Authorization': `Bearer ${key}`,
          'Accept': 'application/json'
        }
      });
      renderTable(data);
      appendLog(`Amostra carregada. ${data.length} linhas.`,'ok');
    }catch(e){
      appendLog(`[ERRO] HTTP ao carregar amostra. ${e.message}`,'err');
      throw e;
    }
  }

  // events
  els.btnOpenAPI.onclick = async ()=>{
    try{
      saveCfg();
      await loadOpenAPI();
    }catch(e){ /* já logado */ }
  };
  els.btnList.onclick = ()=>{
    if(!openapi){ appendLog('Carregue o OpenAPI primeiro (botão 1).'); return; }
    renderChips();
  };
  els.btnSave.onclick = ()=> saveCfg();
  els.btnCount.onclick = async ()=>{
    try{
      saveCfg();
      await countExact();
    }catch(e){}
  };
  els.btnSample.onclick = async ()=>{
    try{
      saveCfg();
      await loadSample(20);
    }catch(e){}
  };
  els.btnClear.onclick = ()=>{
    els.grid.innerHTML='';
    els.lastUrl.textContent='';
    els.log.textContent='Pronto.';
    els.status.style.display='none';
  };

  // boot
  loadCfg();
  appendLog('Interface pronta — cole a URL e a Anon Key, depois clique em "1) Testar conexão".');
})();
</script>
</body>
</html>
