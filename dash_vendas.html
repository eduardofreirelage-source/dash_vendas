<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dash de Vendas â€” DiagnÃ³stico (REST + OpenAPI)</title>
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸ“Š</text></svg>'>
  <style>
    :root{
      --bg:#f6f6fb;--card:#fff;--muted:#6b7280;--text:#111827;--brand:#2563eb;--border:#e5e7eb;
      --ok:#059669;--warn:#f59e0b;--err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .kpi{font-size:20px;font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="date"],input[type="password"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none
    }
    input[type="checkbox"]{transform:translateY(2px)}
    .btn{padding:10px 14px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    .btn.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.ghost{background:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:999px;font-size:13px;margin:4px;cursor:pointer;user-select:none}
    .pill:hover{border-color:#c7cbd1}
    .stack{display:grid;gap:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{position:sticky;top:0;background:#fafafa;z-index:1}
    .log{background:#0b1020;color:#e2e8f0;padding:12px;border-radius:10px;font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;max-height:160px;overflow:auto;white-space:pre-wrap}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="align-items:center;justify-content:space-between">
    <h1 style="margin:0">Dash de Vendas</h1>
    <div class="controls">
      <button id="btnRefresh" class="btn brand">Atualizar</button>
      <button id="btnTest" class="btn">Rodar teste</button>
    </div>
  </div>

  <div class="row">
    <div class="card" style="flex:1 1 520px;min-width:320px">
      <h3>Faturamento</h3>
      <div class="kpi" id="kpiFat">â€”</div>
      <div class="muted" id="kpiDestaques">Destaques: â€”</div>
    </div>

    <div class="card" style="flex:1 1 520px;min-width:320px">
      <h3>ProjeÃ§Ãµes</h3>
      <div class="row">
        <div style="flex:1">Receita projetada (30d): <b id="projReceita">R$ 0,00</b></div>
        <div style="flex:1">Pedidos: <b id="projPed">0</b></div>
        <div style="flex:1">Ticket: <b id="projTick">R$ 0,00</b></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>DiagnÃ³stico (REST + OpenAPI)</h3>

    <div class="grid-3">
      <div class="stack">
        <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
        <input id="inpProject" type="text" placeholder="https://xxxxx.supabase.co">
        <div class="small"><label><input id="chkOnlyPublic" type="checkbox" checked> Somente schema <b>public</b>?</label></div>
      </div>
      <div class="stack">
        <label>Anon Key</label>
        <input id="inpAnon" type="password" placeholder="eyJh...">
      </div>
      <div class="stack" style="align-content:end">
        <button id="btnDiscover" class="btn brand">Descobrir tabelas e colunas (OpenAPI)</button>
        <div id="openApiStatus" class="small muted"></div>
      </div>
    </div>

    <div class="grid-3" style="margin-top:16px">
      <div class="stack">
        <label>Tabela de vendas (use schema.tabela se necessÃ¡rio)</label>
        <div class="controls">
          <input id="inpTable" type="text" placeholder="ex.: public.vendas_xlsx" list="dlTables">
          <datalist id="dlTables"></datalist>
          <button id="btnSave" class="btn">Salvar</button>
        </div>
      </div>
      <div class="stack">
        <label>Coluna de data</label>
        <input id="inpDateCol" type="text" placeholder="ex.: dia / data / dt / dh / created_at / hora">
      </div>
      <div class="stack">
        <label>Coluna de valor (opcional)</label>
        <input id="inpValueCol" type="text" placeholder="ex.: total / valor_total / receita">
      </div>
    </div>

    <div class="grid-3" style="margin-top:12px">
      <div class="stack">
        <label>Coluna de cancelado (opcional)</label>
        <input id="inpCancelCol" type="text" placeholder="ex.: cancelado / status">
      </div>
      <div class="stack">
        <label>InÃ­cio</label>
        <input id="inpIni" type="date">
      </div>
      <div class="stack">
        <label>Fim</label>
        <input id="inpFim" type="date">
      </div>
    </div>

    <div style="margin:12px 0 6px" class="muted">Tabelas detectadas:</div>
    <div id="pills" class="row"></div>

    <div class="row" style="margin-top:12px">
      <div class="controls">
        <button id="btnCount" class="btn brand">Contar registros (Content-Range)</button>
        <button id="btnSample" class="btn">Carregar amostra</button>
      </div>
    </div>

    <div id="log" class="log" style="margin-top:12px">Pronto.</div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Amostra de dados</h3>
    <div class="muted" id="sampleCount">â€”</div>
    <div style="overflow:auto;max-height:420px;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script>
(() => {
  // -------------------- Util --------------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtReal = n => isFinite(n) ? n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : 'R$ 0,00';
  const log = (...msg) => { const el=$('#log'); el.textContent += (el.textContent? '\\n':'') + msg.join(' '); el.scrollTop = el.scrollHeight; };

  const st = {
    get project(){ return $('#inpProject').value.trim() },
    get anon(){ return $('#inpAnon').value.trim() },
    get onlyPublic(){ return $('#chkOnlyPublic').checked },
    get table(){ return $('#inpTable').value.trim() },
    get dateCol(){ return $('#inpDateCol').value.trim() },
    get valueCol(){ return $('#inpValueCol').value.trim() },
    get cancelCol(){ return $('#inpCancelCol').value.trim() },
    get ini(){ return $('#inpIni').value },
    get fim(){ return $('#inpFim').value },
  };

  const saveLocal = () => {
    const o = {project:st.project,anon:st.anon,onlyPublic:st.onlyPublic,table:st.table,dateCol:st.dateCol,valueCol:st.valueCol,cancelCol:st.cancelCol};
    localStorage.setItem('dx_cfg', JSON.stringify(o));
  };
  const loadLocal = () => {
    try{
      const o = JSON.parse(localStorage.getItem('dx_cfg')||'{}');
      if(o.project) $('#inpProject').value = o.project;
      if(o.anon) $('#inpAnon').value = o.anon;
      if(typeof o.onlyPublic === 'boolean') $('#chkOnlyPublic').checked = o.onlyPublic;
      if(o.table) $('#inpTable').value = o.table;
      if(o.dateCol) $('#inpDateCol').value = o.dateCol;
      if(o.valueCol) $('#inpValueCol').value = o.valueCol;
      if(o.cancelCol) $('#inpCancelCol').value = o.cancelCol;
    }catch(e){}
    // Datas padrÃ£o: Ãºltimo mÃªs rolling
    const today = new Date();
    const fim = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const ini = new Date(fim); ini.setMonth(ini.getMonth()-1);
    $('#inpIni').value = ini.toISOString().slice(0,10);
    $('#inpFim').value = fim.toISOString().slice(0,10);
  };

  const buildBase = () => st.project.replace(/\/+$/,'') + '/rest/v1/' + encodeURIComponent(st.table);
  const authHeaders = () => ({ 'apikey': st.anon, 'Authorization': 'Bearer ' + st.anon });

  const ensureCfg = () => {
    if(!st.project || !st.anon){ log('[ERRO] Informe URL e Anon Key.'); return false; }
    if(!st.table || !st.dateCol){ log('[ERRO] Informe tabela e coluna de data.'); return false; }
    return true;
  };

  // -------------------- OpenAPI discovery --------------------
  async function discoverOpenAPI(){
    $('#openApiStatus').textContent = 'Carregando OpenAPI...';
    $('#pills').innerHTML = '';
    $('#dlTables').innerHTML = '';
    try{
      const url = st.project.replace(/\/+$/,'') + '/rest/v1/';
      const res = await fetch(url, { headers: { ...authHeaders(), 'Accept': 'application/openapi+json' } });
      if(!res.ok){ $('#openApiStatus').textContent = 'Erro OpenAPI: ' + res.status; log(`[OpenAPI] Falhou ${res.status}. Verifique URL/AnonKey/Policies.`); return; }
      const api = await res.json();
      const paths = Object.keys(api.paths || {});
      const tables = [];
      for(const p of paths){
        if(!p || p.indexOf('{')!==-1) continue;        // ignora endpoints com parÃ¢metros
        // Evita regex com barras (para nÃ£o gerar "invalid flags"). Usamos string pura.
        let name = p.startsWith('/') ? p.slice(1) : p;  // remove barra inicial
        if(!name) continue;
        if(st.onlyPublic && !name.startsWith('public.')) continue;
        if(name.startsWith('rpc/')) continue;          // ignora RPC
        if(!tables.includes(name)) tables.push(name);
      }
      tables.sort((a,b)=>a.localeCompare(b));
      // UI: pills + datalist
      const pills = $('#pills');
      const dl = $('#dlTables');
      for(const t of tables){
        const p = document.createElement('div');
        p.className = 'pill';
        p.textContent = t;
        p.title = 'Usar ' + t;
        p.onclick = () => { $('#inpTable').value = t; saveLocal(); };
        pills.appendChild(p);

        const opt = document.createElement('option');
        opt.value = t;
        dl.appendChild(opt);
      }
      $('#openApiStatus').innerHTML = `<span class="ok">OpenAPI OK.</span> ${tables.length} tabelas vistas.`;
      log(`[${new Date().toLocaleTimeString()}] OpenAPI carregado. ${tables.length} tabelas.`);
    }catch(err){
      $('#openApiStatus').innerHTML = `<span class="err">OpenAPI erro.</span>`;
      log('[OpenAPI][ERR]', err.message||err);
    }
  }

  // -------------------- Query helpers --------------------
  function makeDateFilters(){
    const dcol = st.dateCol;
    if(!dcol || !st.ini || !st.fim) return [];
    // para colunas de data/timestamp fazemos [gte, lt]
    const ini = new Date(st.ini + 'T00:00:00');
    const endNext = new Date(st.fim + 'T00:00:00'); endNext.setDate(endNext.getDate()+1);
    const iniISO = ini.toISOString();
    const fimISO = endNext.toISOString();
    return [`${encodeURIComponent(dcol)}=gte.${encodeURIComponent(iniISO)}`, `${encodeURIComponent(dcol)}=lt.${encodeURIComponent(fimISO)}`];
  }

  function addOptionalFilters(qs){
    // cancelado: queremos excluir cancelados por padrÃ£o? aqui sÃ³ adicionamos se o usuÃ¡rio quiser no futuro
    // valueCol nÃ£o Ã© filtro, Ã© sÃ³ para agregaÃ§Ãµes (fora do escopo deste diagn.) â€” entÃ£o nÃ£o usamos aqui.
    return qs;
  }

  async function countContentRange(){
    if(!ensureCfg()) return;
    try{
      const base = buildBase();
      const qs = ['select=id', ...makeDateFilters()];
      const url = base + '?' + qs.join('&');
      log(`[${new Date().toLocaleTimeString()}] HEAD-COUNT URL: ${url}`);
      // Usamos GET com Range 0-0 (PostgREST responde 206 e header Content-Range com total)
      const res = await fetch(url, {
        method: 'GET',
        headers: { ...authHeaders(), 'Range': '0-0', 'Prefer': 'count=exact' }
      });
      if(!res.ok && res.status!==206){ log(`[ERRO no count]: HTTP ${res.status}`); return; }
      const cr = res.headers.get('Content-Range') || '';
      const total = (cr.split('/')[1]||'0').trim();
      log(`[${new Date().toLocaleTimeString()}] Total (Content-Range): ${total||'0'}`);
      $('#sampleCount').textContent = `Total estimado: ${total||'0'}`;
    }catch(err){
      log('[count][ERR]', err.message||err);
    }
  }

  async function loadSample(limit=50){
    if(!ensureCfg()) return;
    try{
      const base = buildBase();
      const qs = ['select=*', ...makeDateFilters(), st.dateCol? `order=${encodeURIComponent(st.dateCol)}.asc` : '', `limit=${limit}`].filter(Boolean);
      const url = base + '?' + qs.join('&');
      log(`[${new Date().toLocaleTimeString()}] GET amostra: ${url}`);
      const res = await fetch(url, { headers: { ...authHeaders(), 'Prefer':'count=planned' } });
      if(!res.ok){ const t = await res.text(); log(`[ERR ${res.status}] ${t}`); return; }
      const data = await res.json();
      renderTable(data);
      $('#sampleCount').textContent = `Amostra carregada: ${data.length} linhas`;
      // Atualiza KPIs simples
      $('#kpiFat').textContent = 'â€”';
      if(data.length && st.valueCol && data[0].hasOwnProperty(st.valueCol)){
        const soma = data.reduce((acc,r)=> acc + (+r[st.valueCol]||0), 0);
        $('#kpiFat').textContent = fmtReal(soma);
      }
    }catch(err){
      log('[sample][ERR]', err.message||err);
    }
  }

  function renderTable(rows){
    const thead = $('#tbl thead'); const tbody = $('#tbl tbody');
    thead.innerHTML = ''; tbody.innerHTML = '';
    if(!rows || !rows.length){ return; }
    const cols = Object.keys(rows[0]);
    thead.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = cols.map(c=>`<td>${safeCell(r[c])}</td>`).join('');
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
  }
  function safeCell(v){
    if(v===null || v===undefined) return '<span class="muted">â€”</span>';
    if(typeof v==='number') return String(v);
    if(typeof v==='object') return JSON.stringify(v);
    return String(v);
  }

  // -------------------- Wire up --------------------
  loadLocal();
  $('#btnDiscover').onclick = () => { saveLocal(); discoverOpenAPI(); };
  $('#btnSave').onclick = () => { saveLocal(); log(`[${new Date().toLocaleTimeString()}] Config salva.`); };
  $('#btnCount').onclick = countContentRange;
  $('#btnSample').onclick = () => loadSample(100);
  $('#btnRefresh').onclick = () => { countContentRange(); loadSample(100); };
  $('#btnTest').onclick = () => { log('Teste OK â€” interface responsiva.'); };

  // Se jÃ¡ houver URL + AnonKey, tenta auto-descobrir ao abrir
  if(st.project && st.anon){ discoverOpenAPI(); }
})();
</script>
</body>
</html>
