<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dash de Vendas — Diagnóstico (REST + OpenAPI)</title>
  <!-- Favicon inline para evitar 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%231433E6'/%3E%3Cpath d='M30 88c0-18 14-32 32-32s32 14 32 32' stroke='white' stroke-width='10' fill='none'/%3E%3Ccircle cx='62' cy='44' r='12' fill='white'/%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#f7f7fb; --panel:#fff; --muted:#6b7280; --fg:#111827; --primary:#2563eb;
      --ok:#059669; --warn:#d97706; --err:#dc2626; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial,'Apple Color Emoji','Segoe UI Emoji';background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid var(--border);background:#fafafe;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:24px;}
    .container{max-width:1100px;margin:16px auto;padding:0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
    .card h3{margin:0 0 8px 0;font-size:14px;color:#111}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input,select{border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:#fff;min-width:140px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    code,kbd,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
    pre{background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px;overflow:auto}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;border:1px solid #dbe3ff;color:#1d4ed8;border-radius:999px;padding:3px 8px;font-size:12px}
    .stat{font-size:28px;font-weight:700}
    .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
    .small{font-size:12px}
    .input-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .label{font-size:12px;color:var(--muted)}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:600;color:#111}
    .log{white-space:pre-wrap;font-size:12px;color:#d1d5db}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="align-items:center;justify-content:space-between">
      <h1>Dash de Vendas <span class="pill">Diagnóstico (REST + OpenAPI)</span></h1>
      <div class="input-row">
        <button id="btnRefresh" class="btn">Atualizar</button>
        <button id="btnTest" class="btn">Rodar teste</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Filtros topo -->
    <div class="row">
      <div class="card" style="flex:1">
        <div class="grid">
          <div>
            <div class="label">Início</div>
            <input id="dtIni" type="date">
          </div>
          <div>
            <div class="label">Fim</div>
            <input id="dtFim" type="date">
          </div>
          <div>
            <div class="label">Cancelado</div>
            <select id="selCancel">
              <option value="todos">Todos</option>
              <option value="somente_nao">Somente não cancelados</option>
              <option value="somente_sim">Somente cancelados</option>
            </select>
          </div>
          <div>
            <div class="label">KPI</div>
            <select id="selKpi">
              <option value="fat">Faturamento</option>
              <option value="ped">Pedidos</option>
              <option value="ticket">Ticket Médio</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI principal -->
    <div class="row">
      <div class="card" style="flex:1">
        <h3>Faturamento</h3>
        <div class="stat" id="statMain">—</div>
        <div class="small muted" id="highlights">Destaques: —</div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1">
        <h3>Insights</h3>
        <div class="small muted" id="insights">Erro. Informe tabela e coluna de data.</div>
      </div>
      <div class="card" style="flex:1">
        <h3>Projeções</h3>
        <div class="small">Receita projetada (30d): <b id="proj_rec">R$ 0,00</b> &nbsp; Pedidos: <b id="proj_ped">0</b> &nbsp; Ticket: <b id="proj_tick">R$ 0,00</b></div>
      </div>
    </div>

    <!-- Diagnóstico / Config -->
    <div class="row">
      <div class="card" style="flex:1">
        <h3 class="section-title">Teste de Paginação (Diagnóstico) — <span class="muted">Total via Content-Range:</span> <b id="totalHead">0</b></h3>
        <details open>
          <summary class="small">⚙️ Config (ajuste se auto-detecção falhar)</summary>
          <div class="grid" style="margin-top:8px">
            <div>
              <div class="label">Project URL</div>
              <input id="inProject" placeholder="https://{ref}.supabase.co">
            </div>
            <div>
              <div class="label">Anon Key</div>
              <input id="inAnon" placeholder="eyJhbGciOiJIUzI1NiIs...">
            </div>
            <div>
              <div class="label">Tabela de vendas</div>
              <input id="inTable" placeholder="ex.: vendas / sales / vw_vendas">
            </div>
            <div>
              <div class="label">Coluna de data</div>
              <input id="inDateCol" placeholder="ex.: data / created_at / dh / dt / hora">
            </div>
            <div>
              <div class="label">Coluna de valor (opcional)</div>
              <input id="inValCol" placeholder="ex.: valor_total / total / valor / receita">
            </div>
            <div>
              <div class="label">Coluna de cancelado (opcional)</div>
              <input id="inCancelCol" placeholder="ex.: cancelado / status">
            </div>
          </div>
          <div class="input-row" style="margin-top:8px">
            <button id="btnSave" class="btn">Salvar</button>
            <button id="btnDiscover" class="btn">Descobrir tabelas e colunas (OpenAPI)</button>
            <span id="discoverStatus" class="small muted">—</span>
          </div>
        </details>

        <div class="small muted" style="margin-top:8px">Última URL chamada:</div>
        <pre id="lastUrl" class="log">—</pre>
        <pre id="log" class="log"></pre>
      </div>
    </div>
  </div>

  <script>
    // ===== Util =====
    const $ = sel => document.querySelector(sel);
    const fmtBRL = v => (new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'})).format(Number(v||0));
    const sleep = (ms) => new Promise(r=>setTimeout(r,ms));

    function readConfig(){
      const cfg = {
        url: $('#inProject').value?.trim(),
        key: $('#inAnon').value?.trim(),
        table: $('#inTable').value?.trim(),
        dateCol: $('#inDateCol').value?.trim(),
        valCol: $('#inValCol').value?.trim() || null,
        cancelCol: $('#inCancelCol').value?.trim() || null,
      };
      localStorage.setItem('dxcfg', JSON.stringify(cfg));
      return cfg;
    }
    function loadConfig(){
      const def = JSON.parse(localStorage.getItem('dxcfg')||'{}');
      if(def.url) $('#inProject').value = def.url;
      if(def.key) $('#inAnon').value = def.key;
      if(def.table) $('#inTable').value = def.table;
      if(def.dateCol) $('#inDateCol').value = def.dateCol;
      if(def.valCol) $('#inValCol').value = def.valCol;
      if(def.cancelCol) $('#inCancelCol').value = def.cancelCol;
    }
    function baseHeaders(cfg){
      return {
        'apikey': cfg.key || '',
        'Authorization': `Bearer ${cfg.key||''}`,
        'Content-Type':'application/json',
        'Accept':'application/json',
        'Prefer':'count=exact'
      };
    }
    function setLog(msg){ $('#log').textContent = msg; }
    function appendLog(msg){ $('#log').textContent += msg + "\\n"; }
    function setLastUrl(u){ $('#lastUrl').textContent = u; }

    // ===== OpenAPI Discovery =====
    async function discoverOpenAPI(cfg){
      const url = (cfg.url||'').replace(/\\/$/,'') + '/rest/v1/';
      setLastUrl(url + ' (OpenAPI)');
      try{
        const r = await fetch(url, { headers: baseHeaders(cfg) });
        if(!r.ok){
          $('#discoverStatus').textContent = `OpenAPI erro ${r.status}`;
          appendLog(\`[DISCOVER][ERR] status=\${r.status} \`);
          return {tables:[],suggestions:{}};
        }
        const spec = await r.json(); // OpenAPI JSON
        // Tables as keys in "paths" where path starts with /{table}
        const paths = Object.keys(spec.paths || {});
        // Filter only GET on /{table}
        const tables = Array.from(new Set(paths.map(p=>p.split('/')[1]).filter(Boolean)));
        $('#discoverStatus').textContent = \`OpenAPI OK. Tabelas encontradas: \${tables.length}\`;
        appendLog(\`[DISCOVER] tables=\${tables.length}\\n\`);

        // Try to sample first 1 row of each table to infer columns
        let suggestions = {};
        for(const t of tables.slice(0, 20)){ // cap 20 to be gentle
          const sampleUrl = (cfg.url||'').replace(/\\/$/,'') + \`/rest/v1/\${t}?select=*&limit=1\`;
          setLastUrl(sampleUrl);
          try{
            const rs = await fetch(sampleUrl, { headers: baseHeaders(cfg) });
            if(rs.ok){
              const arr = await rs.json();
              if(Array.isArray(arr) && arr[0]){
                const cols = Object.keys(arr[0]);
                suggestions[t] = cols;
                appendLog(\`[DISCOVER] \${t} cols=\${cols.length}\\n\`);
              }else{
                appendLog(\`[DISCOVER] \${t} sem amostra\\n\`);
              }
            }else{
              appendLog(\`[DISCOVER][WARN] table=\${t} status=\${rs.status}\\n\`);
            }
          }catch(e){
            appendLog(\`[DISCOVER][EXC] table=\${t} \${e}\\n\`);
          }
          await sleep(30);
        }
        return {tables, suggestions};
      }catch(err){
        $('#discoverStatus').textContent = 'OpenAPI falhou';
        appendLog('[DISCOVER][EXC] ' + err);
        return {tables:[], suggestions:{}};
      }
    }

    function guessCols(cols){
      const lc = cols.map(c=>c.toLowerCase());
      const dateCandidates = ['data','dt','dh','created_at','hora','date','timestamp','ts','day'];
      const valCandidates  = ['valor_total','total','valor','venda','receita','faturamento','amount','sum','gross'];
      const cancelCandidates = ['cancelado','status','canceled','is_canceled','cancel','st','situacao'];

      const pick = (cands)=>{
        for(const c of cands){
          const idx = lc.indexOf(c);
          if(idx>=0) return cols[idx];
        }
        return null;
      };
      return {
        dateCol: pick(dateCandidates),
        valCol: pick(valCandidates),
        cancelCol: pick(cancelCandidates)
      };
    }

    // ===== Paginação com Range =====
    async function getTotalByHead(cfg, table, dateCol, ini, fim, cancelCol, cancelMode){
      const base = (cfg.url||'').replace(/\\/$/,'') + \`/rest/v1/\${table}?select=id\`;
      const where = [];
      if(ini && fim){
        // Use gte / lt para datas (compativel com date e timestamp)
        where.push(\`\${encodeURIComponent(dateCol)}=gte.\${encodeURIComponent(ini)}\`);
        where.push(\`\${encodeURIComponent(dateCol)}=lt.\${encodeURIComponent(fim)}\`);
      }
      const qs = where.length? ('&' + where.join('&')):'';
      const url = base + qs;
      setLastUrl(url);
      const r = await fetch(url, { method:'HEAD', headers: baseHeaders(cfg) });
      const cr = r.headers.get('Content-Range') || '*/0';
      const total = Number((cr.split('/')[1]||'0'));
      return {ok:r.ok, status:r.status, total, contentRange:cr};
    }

    async function fetchPaged(cfg, table, dateCol, ini, fim){
      // devolve até 1e6 linhas em páginas de 1000 usando Range
      const pageSize = 1000;
      // 1) HEAD para total
      const {ok, status, total, contentRange} = await getTotalByHead(cfg, table, dateCol, ini, fim);
      $('#totalHead').textContent = String(total);
      appendLog(\`[HEAD] status=\${status} content-range=\${contentRange}\\n\`);
      if(!ok) throw new Error('HEAD falhou: ' + status);
      if(total === 0) return [];

      // 2) Paginado GET
      const rows = [];
      const base = (cfg.url||'').replace(/\\/$/,'') + \`/rest/v1/\${table}?select=*\`;
      const where = [];
      if(ini && fim){
        where.push(\`\${encodeURIComponent(dateCol)}=gte.\${encodeURIComponent(ini)}\`);
        where.push(\`\${encodeURIComponent(dateCol)}=lt.\${encodeURIComponent(fim)}\`);
      }
      const qs = where.length? ('&' + where.join('&')):'';

      let start = 0;
      while(start < total){
        const end = Math.min(start + pageSize - 1, total - 1);
        const url = base + qs;
        setLastUrl(url + \` [Range: \${start}-\${end}]\`);
        const headers = {...baseHeaders(cfg), 'Range': \`\${start}-\${end}\`};
        const r = await fetch(url, { headers });
        if(!r.ok){
          appendLog(\`[PAGE][ERR] status=\${r.status}\\n\`);
          throw new Error('GET falhou: ' + r.status);
        }
        const chunk = await r.json();
        rows.push(...(Array.isArray(chunk)?chunk:[]));
        appendLog(\`[PAGE] got=\${chunk.length} acc=\${rows.length}/\${total}\\n\`);
        if(chunk.length === 0) break; // segurança
        start = end + 1;
        await sleep(10);
      }
      return rows;
    }

    // ===== KPIs (simples) =====
    function computeKPIs(rows, cfg){
      const ped = rows.length;
      let fat = 0;
      if(cfg.valCol){
        for(const r of rows){
          const v = Number(r?.[cfg.valCol] ?? 0);
          if(Number.isFinite(v)) fat += v;
        }
      }
      const ticket = ped ? fat / ped : 0;
      return {ped, fat, ticket};
    }

    // ===== Run principal =====
    async function run(loadData=true){
      setLog('');
      const cfg = readConfig();
      // datas (fechas fim exclusivas)
      const ini = $('#dtIni').value || '';
      const fim = $('#dtFim').value || '';
      if(!cfg.url || !cfg.key){
        appendLog('[TEST][ERR] Informe URL e Anon Key');
        return;
      }
      if(!cfg.table || !cfg.dateCol){
        $('#insights').textContent = 'Erro. Informe tabela e coluna de data.';
      }
      try{
        if(!cfg.table || !cfg.dateCol){
          // só testa HEAD vazio para conferir auth / OpenAPI
          const {status} = await getTotalByHead(cfg, 'qualquer', 'created_at', '1900-01-01', '1900-01-02');
          appendLog('[TEST] HEAD dummy status='+status);
          return;
        }
        const rows = await fetchPaged(cfg, cfg.table, cfg.dateCol, ini, fim);
        const {ped, fat, ticket} = computeKPIs(rows, cfg);

        // Exibe
        $('#statMain').textContent = fmtBRL(cfg.valCol ? fat : 0);
        $('#proj_rec').textContent = fmtBRL(cfg.valCol ? (fat/Math.max(1, (rows.length||1))) * 30 : 0);
        $('#proj_ped').textContent = String(ped);
        $('#proj_tick').textContent = fmtBRL(ticket);
        $('#insights').textContent = rows.length ? 'OK' : 'Sem dados no período.';
      }catch(err){
        appendLog('[RUN][ERR] ' + err.message);
      }
    }

    // ===== Eventos =====
    $('#btnSave').onclick = ()=>{ readConfig(); appendLog('[CFG] salvo'); };
    $('#btnRefresh').onclick = ()=> run(true);
    $('#btnTest').onclick = async ()=>{
      setLog('');
      const cfg = readConfig();
      if(!cfg.url || !cfg.key){ appendLog('[TEST][ERR] Informe URL e Anon Key'); return; }
      // HEAD total (se tabela/coluna informadas), senão testa apenas OpenAPI
      if(cfg.table && cfg.dateCol){
        const ini = $('#dtIni').value || '';
        const fim = $('#dtFim').value || '';
        try{
          const {status,total,contentRange} = await getTotalByHead(cfg, cfg.table, cfg.dateCol, ini, fim);
          appendLog(\`[TEST] HEAD total=\${total} content-range=\${contentRange} status=\${status}\`);
        }catch(e){
          appendLog('[TEST][EXC] ' + e.message);
        }
      }else{
        appendLog('[TEST] Config incompleta: tabela/coluna data');
      }
    };
    $('#btnDiscover').onclick = async ()=>{
      setLog('');
      const cfg = readConfig();
      if(!cfg.url || !cfg.key){ appendLog('[DISCOVER][ERR] Informe URL e Anon Key'); return; }
      const d = await discoverOpenAPI(cfg);
      // Pick suggestion: table with most columns and with date-like column
      let bestTable = null, bestCols = [];
      for(const [t, cols] of Object.entries(d.suggestions)){
        if(cols.length > bestCols.length){ bestTable = t; bestCols = cols; }
      }
      if(bestTable){
        const guesses = guessCols(bestCols);
        if(!$('#inTable').value) $('#inTable').value = bestTable;
        if(guesses.dateCol && !$('#inDateCol').value) $('#inDateCol').value = guesses.dateCol;
        if(guesses.valCol && !$('#inValCol').value) $('#inValCol').value = guesses.valCol;
        if(guesses.cancelCol && !$('#inCancelCol').value) $('#inCancelCol').value = guesses.cancelCol;
        readConfig();
        $('#discoverStatus').textContent = 'Sugestões preenchidas.';
      }else{
        $('#discoverStatus').textContent = 'OpenAPI OK, mas sem amostras com colunas.';
      }
    };

    // ===== Init =====
    (function init(){
      loadConfig();
      const today = new Date();
      const d0 = new Date(today); d0.setDate(d0.getDate()-30);
      $('#dtIni').value = (new Date(d0.getTime()-d0.getTimezoneOffset()*60000)).toISOString().slice(0,10);
      $('#dtFim').value = (new Date(today.getTime()-today.getTimezoneOffset()*60000)).toISOString().slice(0,10);
      appendLog('[DX] Ready');
    })();
  </script>
</body>
</html>
