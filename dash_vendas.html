<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dash Vendas — Diagnóstico (Auto)</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23009066'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-size='28' font-family='Arial' fill='white'%3ED%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#f7f7fa;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#111827;
      --accent:#0ea5e9;
      --ok:#10b981;
      --bad:#ef4444;
      --br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--primary);font:16px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{position:sticky;top:0;background:#fff;z-index:5;border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1180px;margin:0 auto;padding:16px 20px}
    h1{font-size:28px;margin:8px 0 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    input[type=date],select,button{
      height:36px;border:1px solid #e5e7eb;border-radius:10px;padding:0 10px;background:#fff;outline:none;
    }
    button{cursor:pointer}
    main .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border-radius:var(--br);box-shadow:0 1px 2px rgba(0,0,0,.03);border:1px solid #eef0f3}
    .card .wrap{padding:16px 18px}
    .kpi{font-weight:800;font-size:42px;letter-spacing:-.02em}
    .muted{color:var(--muted)}
    .title{font-weight:700}
    .debug{font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space:pre-wrap;background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px;overflow:auto;max-height:220px}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border-radius:999px;padding:2px 10px;font-size:12px}
    .ok{color:#065f46;background:#ecfdf5}
    .bad{color:#991b1b;background:#fef2f2}
    details{margin-top:6px}
    summary{cursor:pointer;color:#334155}
    .small{font-size:13px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Dash de Vendas</h1>
    <div class="row">
      <div class="field">
        <label>Início</label>
        <input id="dtIni" type="date"/>
      </div>
      <div class="field">
        <label>Fim</label>
        <input id="dtFim" type="date"/>
      </div>
      <div class="field">
        <label>Cancelado</label>
        <select id="cancelado">
          <option value="todos">Todos</option>
          <option value="nao">Não</option>
          <option value="sim">Sim</option>
        </select>
      </div>
      <div class="field">
        <label>KPI</label>
        <select id="kpi">
          <option value="fat">Faturamento</option>
          <option value="ped">Pedidos</option>
          <option value="tck">Ticket Médio</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="btnRun">Atualizar</button>
      </div>
      <div class="field" style="margin-left:auto">
        <label>&nbsp;</label>
        <button id="btnTest">Rodar teste</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:10px">
  <div class="card">
    <div class="wrap">
      <div class="title small" id="kpiTitle">Faturamento</div>
      <div class="kpi" id="kpiValue">—</div>
      <div class="muted small" id="kpiPrev">Período anterior: —</div>
      <div class="muted small" id="kpiHighlights">Destaques: —</div>
    </div>
  </div>

  <div class="grid" style="margin-top:14px">
    <div class="card">
      <div class="wrap">
        <div class="title">Insights</div>
        <div class="muted" id="insights">Sem dados no período.</div>
      </div>
    </div>

    <div class="card">
      <div class="wrap">
        <div class="title">Projeções</div>
        <div class="row small" style="margin-top:6px">
          <div>Receita projetada (30d): <b id="projFat">R$ 0,00</b></div>
          <div style="margin-left:18px">Pedidos: <b id="projPed">0</b></div>
          <div style="margin-left:18px">Ticket: <b id="projTck">R$ 0,00</b></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="wrap">
      <div class="title">Teste de Paginação (Diagnóstico) — <span class="muted">Total via Content‑Range:</span> <b id="totalHead">0</b></div>
      <details style="margin-top:8px">
        <summary>Config (ajuste se auto‑detecção falhar)</summary>
        <div class="row small" style="margin-top:8px">
          <div class="field"><label>Project URL</label><input id="cfgUrl" style="min-width:420px"></div>
          <div class="field"><label>Anon Key</label><input id="cfgKey" style="min-width:420px"></div>
        </div>
        <div class="row small" style="margin-top:8px">
          <div class="field"><label>Tabela de vendas</label><input id="cfgTable" placeholder="ex.: vendas"/></div>
          <div class="field"><label>Coluna de data</label><input id="cfgDateCol" placeholder="ex.: data / created_at"/></div>
          <div class="field"><label>Coluna de valor (opcional)</label><input id="cfgValueCol" placeholder="ex.: valor_total / total"/></div>
          <div class="field"><label>Coluna de cancelado (opcional)</label><input id="cfgCancelCol" placeholder="ex.: cancelado / status"/></div>
          <div class="field"><label>&nbsp;</label><button id="btnSaveCfg">Salvar</button></div>
        </div>
        <div class="debug" id="dbg">Pronto.</div>
      </details>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ====== CONFIG PADRÃO (pode ajustar em "Config") ======
const DEFAULTS = {
  url: "https://msmyfxgrnuusnvoqyeuo.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbXlmeGdybnV1c252b3F5ZXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTYzMTEsImV4cCI6MjA3MjIzMjMxMX0.21NV7RdrdXLqA9-PIG9TP2aZMgIseW7_qM1LDZzkO7U",
  table: "vendas",       // chutamos um nome comum; pode alterar no painel
  dateCol: "data",       // idem
  valueCol: "",          // detectaremos se vazio
  cancelCol: ""          // opcional
};

function loadCfg(){
  try{
    const cfg = JSON.parse(localStorage.getItem("dx_cfg")||"{}");
    return {...DEFAULTS, ...cfg};
  }catch(e){ return {...DEFAULTS}; }
}
function saveCfg(cfg){
  localStorage.setItem("dx_cfg", JSON.stringify(cfg));
  setCfgUI(cfg);
}

function setCfgUI(cfg){
  cfgUrl.value = cfg.url;
  cfgKey.value = cfg.key;
  cfgTable.value = cfg.table;
  cfgDateCol.value = cfg.dateCol;
  cfgValueCol.value = cfg.valueCol||"";
  cfgCancelCol.value = cfg.cancelCol||"";
}

let cfg = loadCfg();
setCfgUI(cfg);

let supa = window.supabase.createClient(cfg.url, cfg.key);

// ====== UI helpers ======
const $ = (sel)=>document.querySelector(sel);
const dbg = (msg)=>{
  const el = document.getElementById("dbg");
  el.textContent = (typeof msg==="string")? msg : JSON.stringify(msg, null, 2);
};

function fmtMoney(n){
  if(!isFinite(n)) return "—";
  return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function iso(d){ return d.toISOString().slice(0,10); }
function addDays(date, days){
  const d = new Date(date); d.setDate(d.getDate()+days); return d;
}

// ====== Auto prefill dates ======
(function initDates(){
  const today = new Date();
  const ini = addDays(today,-31);
  dtIni.value = iso(ini);
  dtFim.value = iso(today);
})();

btnSaveCfg.onclick = ()=>{
  cfg = {
    url: cfgUrl.value.trim(),
    key: cfgKey.value.trim(),
    table: cfgTable.value.trim(),
    dateCol: cfgDateCol.value.trim(),
    valueCol: cfgValueCol.value.trim(),
    cancelCol: cfgCancelCol.value.trim(),
  };
  saveCfg(cfg);
  supa = window.supabase.createClient(cfg.url, cfg.key);
  dbg("Config salva.");
};

// ====== Core: fetch paginado por Range ======
async function fetchPage(table, q, from, to){
  const url = `${cfg.url}/rest/v1/${encodeURIComponent(table)}?${q}`;
  const h = {
    apikey: cfg.key,
    Authorization: `Bearer ${cfg.key}`,
    "Range-Unit":"items",
    Range: `${from}-${to}`,
    Prefer: "count=exact"
  };
  const res = await fetch(url, {headers: h});
  if(!res.ok){
    throw new Error(`HTTP ${res.status} ${res.statusText} @ ${url}`);
  }
  const contentRange = res.headers.get("content-range")||res.headers.get("Content-Range")||"";
  const m = contentRange.match(/(\d+)-(\d+)\/(\d+|\*)/);
  const total = m && m[3] && m[3]!=="*" ? parseInt(m[3],10) : null;
  const data = await res.json();
  return {data, total};
}

async function fetchPaged(table, dateCol, fromISO, toISO, pageSize=1000){
  // monta query de datas (usa .gte / .lt)
  // PostgREST aceita datas e timestamps no mesmo formato; vamos enviar AAAA-MM-DD e AAAA-MM-DDTHH:MM:SS
  const isTimestamp = /(_at|hora|dh|timestamp)/i.test(dateCol);
  const vFrom = isTimestamp ? `${fromISO}T00:00:00` : fromISO;
  const vTo = isTimestamp ? `${toISO}T00:00:00` : toISO; // exclusivo

  const parts = [`select=*`, `${encodeURIComponent(dateCol)}=gte.${encodeURIComponent(vFrom)}`, `${encodeURIComponent(dateCol)}=lt.${encodeURIComponent(vTo)}`];
  // cancelado (opcional)
  if(cfg.cancelCol && cancelado.value!=="todos"){
    if(cancelado.value==="nao") parts.push(`${encodeURIComponent(cfg.cancelCol)}=eq.false`);
    if(cancelado.value==="sim") parts.push(`${encodeURIComponent(cfg.cancelCol)}=eq.true`);
  }
  const baseQ = parts.join("&");

  let acc = [];
  // primeira página: obter também o total via Content-Range
  let start = 0, end = pageSize-1;
  let {data, total} = await fetchPage(table, baseQ, start, end);
  acc = acc.concat(data||[]);
  if(total==null) total = acc.length; // fallback
  totalHead.textContent = total.toLocaleString("pt-BR");

  while(acc.length < total){
    start = acc.length;
    end = Math.min(acc.length + pageSize - 1, total-1);
    const page = await fetchPage(table, baseQ, start, end);
    acc = acc.concat(page.data||[]);
  }
  return acc;
}

// ====== Auto-detecção de tabela/colunas ======
const TABLE_CANDIDATES = ["vendas","vw_vendas","sales","vendas_diario","pedidos"];
const DATE_CANDIDATES = ["data","dt","dh","created_at","hora","date","data_pedido"];

async function detectTableAndColumns(){
  // 1) tenta tabela informada no cfg; se falhar, percorre os candidatos
  const candidates = [cfg.table, ...TABLE_CANDIDATES.filter(t=>t!==cfg.table)];
  let chosenTable = null, sampleRow = null;

  for(const t of candidates){
    try{
      const {data} = await fetchPage(t, "select=*&limit=1", 0, 0);
      if(Array.isArray(data) && data.length){
        chosenTable = t; sampleRow = data[0]; break;
      }
    }catch(e){
      // ignora 404/401/…
    }
  }
  if(!chosenTable){
    throw new Error("Não foi possível detectar a tabela. Informe na Config.");
  }

  // 2) detectar coluna de data
  let dateCol = cfg.dateCol && (cfg.dateCol in (sampleRow||{})) ? cfg.dateCol : null;
  if(!dateCol){
    for(const c of DATE_CANDIDATES){
      if(sampleRow && (c in sampleRow)){ dateCol = c; break; }
    }
  }
  if(!dateCol){
    // fallback: a primeira que pareça data
    for(const k of Object.keys(sampleRow||{})){
      const v = sampleRow[k];
      if(typeof v === "string" && /^\d{4}-\d{2}-\d{2}/.test(v)){ dateCol = k; break; }
    }
  }
  if(!dateCol) throw new Error("Não foi possível detectar a coluna de data. Informe na Config.");

  // 3) detectar coluna de valor (opcional)
  let valueCol = cfg.valueCol && (cfg.valueCol in sampleRow) ? cfg.valueCol : "";
  if(!valueCol){
    const keys = Object.keys(sampleRow||{});
    for(const k of keys){
      if(/^(vl|valor|total|amount|fatur|receita)/i.test(k) && typeof sampleRow[k] === "number"){
        valueCol = k; break;
      }
    }
  }

  // 4) coluna cancelado (opcional)
  let cancelCol = cfg.cancelCol && (cfg.cancelCol in sampleRow) ? cfg.cancelCol : "";
  if(!cancelCol){
    for(const k of Object.keys(sampleRow||{})){
      if(/cancel/i.test(k)){ cancelCol = k; break; }
      if(/status/i.test(k)){ cancelCol = k; break; }
    }
  }

  // Persiste descoberta para as próximas execuções
  cfg = {...cfg, table: chosenTable, dateCol, valueCol, cancelCol};
  saveCfg(cfg);
  dbg({detect: {table: chosenTable, dateCol, valueCol, cancelCol}, sampleRow});
  return cfg;
}

// ====== KPIs ======
function aggregate(rows){
  const ped = rows.length;
  // somar por valueCol se existir; caso contrário tenta somar números plausíveis
  let fat = 0;
  if(cfg.valueCol){
    for(const r of rows){
      const v = Number(r[cfg.valueCol]);
      if(isFinite(v)) fat += v;
    }
  }else{
    // busca heurística única por linha
    for(const r of rows){
      let added=false;
      for(const k of Object.keys(r)){
        if(/^(vl|valor|total|amount|fatur|receita)/i.test(k) && typeof r[k]==="number"){
          fat += r[k]; added=true; break;
        }
      }
      if(!added){
        // tenta price * qty se existir
        const priceKey = Object.keys(r).find(k=>/price|preco|valor_unit/i.test(k));
        const qtyKey = Object.keys(r).find(k=>/qty|quant|qtd/i.test(k));
        if(priceKey && qtyKey){
          const v = Number(r[priceKey]) * Number(r[qtyKey]);
          if(isFinite(v)) fat += v;
        }
      }
    }
  }
  const tck = ped>0 ? fat/ped : 0;
  return {ped, fat, tck};
}

function setKpiCards(curr, prev){
  const sel = kpi.value;
  const titleMap = {fat:"Faturamento", ped:"Pedidos", tck:"Ticket Médio"};
  kpiTitle.textContent = titleMap[sel];
  const currVal = sel==="fat"?fmtMoney(curr.fat): sel==="ped"? curr.ped.toLocaleString("pt-BR"): fmtMoney(curr.tck);
  kpiValue.textContent = currVal;
  const prevVal = sel==="fat"?fmtMoney(prev.fat): sel==="ped"? prev.ped.toLocaleString("pt-BR"): fmtMoney(prev.tck);
  kpiPrev.textContent = `Período anterior: ${prevVal}`;

  projFat.textContent = fmtMoney(curr.fat*1.5); // projeção bobinha só pra ilustrar
  projPed.textContent = Math.round(curr.ped*1.2).toLocaleString("pt-BR");
  projTck.textContent = fmtMoney(curr.tck);
}

// ====== Runner ======
async function run(){
  try{
    // Detectar (apenas na primeira vez / quando config incompleta)
    if(!cfg.table || !cfg.dateCol){
      await detectTableAndColumns();
    }

    const from = new Date(dtIni.value);
    const to = addDays(new Date(dtFim.value), 1); // exclusivo

    const rows = await fetchPaged(cfg.table, cfg.dateCol, iso(from), iso(to));
    const curr = aggregate(rows);

    // período anterior com mesmo tamanho
    const days = Math.max(1, Math.round((to - from)/(24*3600*1000)));
    const prevFrom = addDays(from, -days);
    const prevTo = from;
    const prevRows = await fetchPaged(cfg.table, cfg.dateCol, iso(prevFrom), iso(prevTo));
    const prev = aggregate(prevRows);

    setKpiCards(curr, prev);
    insights.textContent = rows.length ? "—" : "Sem dados no período.";
    dbg({cfg, curr, prev, sample: rows[0]});
  }catch(err){
    dbg(String(err));
    kpiValue.textContent = "—";
    kpiPrev.textContent = "Erro. Veja 'Config' abaixo.";
  }
}

btnRun.onclick = run;
btnTest.onclick = async ()=>{
  try{
    await detectTableAndColumns();
    const from = new Date(dtIni.value);
    const to = addDays(new Date(dtFim.value), 1);
    const sample = await fetchPaged(cfg.table, cfg.dateCol, iso(from), iso(to));
    dbg({ok:true, table: cfg.table, dateCol: cfg.dateCol, total: sample.length});
  }catch(e){
    dbg(String(e));
  }
};

// roda automático ao abrir
run();
</script>
</body>
</html>
