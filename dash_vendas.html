<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diagnóstico Supabase (v0b) — REST + OpenAPI</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--sub:#475569;--muted:#94a3b8;--line:#e2e8f0;--brand:#2563eb;--brand-ink:#fff;--pill:#eef2ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type=text],input[type=password]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink);outline:none}
  input[type=text]:focus,input[type=password]:focus{border-color:#b3c5ff;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  button{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer}
  button.primary{background:var(--brand);border-color:var(--brand);color:var(--brand-ink)}
  button.ghost{background:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .kvs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .pill{background:var(--pill);border:1px solid #d9ddff;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;user-select:none}
  .pill:hover{background:#e6eaff}
  .inline{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);}
  .log{background:#0b1220;color:#b9e0ff;border-radius:10px;padding:10px;white-space:pre-wrap;min-height:62px}
  .grid{width:100%;border-collapse:collapse;margin-top:10px}
  .grid th,.grid td{border:1px solid var(--line);padding:8px 10px;text-align:left;font-variant-numeric:tabular-nums}
  .grid th{background:#f8fafc}
  .hint{font-size:12px;color:var(--sub);margin-top:8px}
  .badge{display:inline-block;background:#e8f5e9;color:#176f2c;border:1px solid #b9e4c0;padding:2px 8px;border-radius:999px;font-weight:600;margin-right:6px}
  .ok{color:#176f2c}
  .err{color:#b42318}
  .split{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  @media (max-width:980px){.row,.split{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Diagnóstico Supabase (v0b) — REST + OpenAPI</h1>
    <div class="split">
      <div class="card">
        <div class="row">
          <div>
            <label>Project URL <span class="muted">(ex.: https://xxxxx.supabase.co)</span></label>
            <input id="projectUrl" type="text" placeholder="https://xxxxx.supabase.co" />
          </div>
          <div>
            <label>Anon Key</label>
            <input id="anonKey" type="password" placeholder="•••••••••••••••••" />
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <label class="inline" style="font-weight:500"><input id="onlyPublic" type="checkbox" />&nbsp;Somente <code>schema public</code> ?</label>
          <button id="btnTest" class="ghost">1) Testar conexão (OpenAPI)</button>
          <button id="btnList" class="ghost">2) Listar tabelas</button>
          <button id="btnSave" class="ghost">Salvar config</button>
        </div>

        <div id="tables" class="pillbar" aria-live="polite"></div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Tabela <span class="muted">(use <code>schema.tabela</code> se precisar)</span></label>
            <input id="tableName" type="text" placeholder="ex.: vendas_xlsx" />
          </div>
          <div>
            <label>Coluna de data (opcional)</label>
            <input id="dateCol" type="text" placeholder="ex.: dia / data / created_at / dh / hora" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Coluna de valor (opcional)</label>
            <input id="valueCol" type="text" placeholder="ex.: total / valor_total / receita" />
          </div>
          <div></div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Início</label>
            <input id="start" type="text" placeholder="dd/mm/aaaa" />
          </div>
          <div>
            <label>Fim</label>
            <input id="end" type="text" placeholder="dd/mm/aaaa" />
          </div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button id="btnCount" class="primary">Contar registros (Content-Range)</button>
          <button id="btnSample" class="ghost">Carregar amostra (20)</button>
          <button id="btnClear" class="ghost">Limpar</button>
        </div>

        <label style="margin-top:12px">Log</label>
        <div id="log" class="log">Pronto.</div>

        <div class="hint">
          <span class="badge">Dica</span>
          A contagem via <code>HEAD</code> usa <code>?select=id</code> + cabeçalho <code>Prefer: count=exact</code>.
          Se a coluna de data ficar vazia, nenhuma filtragem por período será aplicada.
        </div>
      </div>

      <div class="card">
        <label>Amostra de dados</label>
        <div id="sampleWrap" class="muted">—</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const logBox = $("log");
  const sampleWrap = $("sampleWrap");
  const pillsWrap = $("tables");

  const state = {
    openapi: null,
    lastURL: ""
  };

  function saveLocal(){
    const cfg = {
      projectUrl: $("projectUrl").value.trim(),
      anonKey: $("anonKey").value.trim(),
      onlyPublic: $("onlyPublic").checked,
      tableName: $("tableName").value.trim(),
      dateCol: $("dateCol").value.trim(),
      valueCol: $("valueCol").value.trim(),
      start: $("start").value.trim(),
      end: $("end").value.trim()
    };
    localStorage.setItem("diag_supabase_v0b", JSON.stringify(cfg));
    log("Config salva.");
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem("diag_supabase_v0b");
      if(!raw) return;
      const cfg = JSON.parse(raw);
      for(const k in cfg){
        if($(k) == null) continue;
        if(k === "onlyPublic") $("onlyPublic").checked = !!cfg[k];
        else $(k).value = cfg[k] ?? "";
      }
    }catch(e){}
  }

  function log(msg, cls){
    const t = new Date().toTimeString().slice(0,8);
    const line = `[${t}] ${msg}`;
    logBox.textContent = (logBox.textContent ? logBox.textContent + "\\n" : "") + line;
    if(cls === "err") logBox.style.color = "#ffb4b4"; else logBox.style.color = "#b9e0ff";
  }

  function parseDateBR(s){
    // expects dd/mm/yyyy; returns 'YYYY-MM-DD'
    const m = (s||"").trim().match(/^([0-3]?\\d)\\/([0-1]?\\d)\\/(\\d{4})$/);
    if(!m) return null;
    const [_, d, mo, y] = m;
    const iso = `${y.padStart(4,"0")}-${mo.padStart(2,"0")}-${d.padStart(2,"0")}`;
    return iso;
  }

  function addDaysISO(iso, days){
    const dt = new Date(iso + "T00:00:00Z");
    dt.setUTCDate(dt.getUTCDate()+days);
    return dt.toISOString().slice(0,10);
  }

  function buildHeaders(schema){
    const ak = $("anonKey").value.trim();
    const h = {
      "apikey": ak,
      "Authorization": "Bearer " + ak,
      "Accept": "application/json"
    };
    if(schema) h["Accept-Profile"] = schema; // PostgREST schema routing
    return h;
  }

  function normalizeTable(){
    let t = $("tableName").value.trim();
    let schema = $("onlyPublic").checked ? "public" : null;
    if(!t) return {schema, table: ""};
    // accept forms: 'public.tabela', 'public:tabela', 'tabela'
    t = t.replace(/\\s+/g,"");
    const m = t.match(/^([a-zA-Z0-9_]+)[\\.:]([a-zA-Z0-9_]+)$/);
    if(m){
      schema = m[1];
      t = m[2];
    }
    if(schema === "public" && /^public\\./i.test($("tableName").value.trim())){
      // prevent public.public.* loops
      $("tableName").value = t;
    }
    return {schema, table: t};
  }

  function projectBase(){
    let u = $("projectUrl").value.trim().replace(/\\/$/,"");
    if(!/^https?:\\/\\//i.test(u)) u = "https://" + u;
    return u + "/rest/v1";
  }

  async function fetchOpenAPI(){
    try{
      const {schema} = normalizeTable();
      const res = await fetch(projectBase() + "/", {
        method: "GET",
        headers: {
          ...buildHeaders(schema || ($("onlyPublic").checked ? "public" : null)),
          "Accept": "application/openapi+json"
        }
      });
      if(!res.ok){
        log("OpenAPI falhou: HTTP " + res.status, "err");
        return null;
      }
      const json = await res.json();
      state.openapi = json;
      const tables = extractTablesFromOpenAPI(json);
      log(`OpenAPI carregado. ${tables.length} tabelas.`);
      return tables;
    }catch(e){
      log("Erro ao carregar OpenAPI: " + e.message, "err");
      return null;
    }
  }

  function extractTablesFromOpenAPI(spec){
    try{
      const paths = Object.keys(spec.paths || {});
      // Paths look like "/categorias", "/rpc/..." — keep only non-rpc simple tables/views
      const names = paths
        .map(p => p.replace(/^\\//,""))
        .filter(n => n && !n.startsWith("rpc/"));
      // Deduplicate & sort
      const uniq = Array.from(new Set(names)).sort((a,b)=>a.localeCompare(b));
      return uniq;
    }catch(e){
      return [];
    }
  }

  function renderTablePills(list){
    pillsWrap.innerHTML = "";
    if(!list || !list.length){
      pillsWrap.textContent = "—";
      return;
    }
    list.forEach(name => {
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = name;
      pill.title = "Usar tabela: " + name;
      pill.onclick = () => {
        $("tableName").value = name;
        log("Tabela selecionada: " + name);
      };
      pillsWrap.appendChild(pill);
    });
  }

  function buildDateFilters(q){
    const dateCol = $("dateCol").value.trim();
    const sISO = parseDateBR($("start").value);
    const eISO = parseDateBR($("end").value);
    if(!dateCol || !(sISO && eISO)) return q;
    const eLT = addDaysISO(eISO, 1); // [start, end]
    q.set(dateCol, "gte." + sISO);
    q.append(dateCol, "lt." + eLT);
    return q;
  }

  function buildURL(selectStar=false, limit=0, forCount=false){
    const {schema, table} = normalizeTable();
    if(!table){ log("Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx).", "err"); return null; }
    const base = projectBase() + "/" + encodeURIComponent(table);
    const q = new URLSearchParams();
    q.set("select", selectStar ? "*" : "id");
    if(limit>0) q.set("limit", String(limit));
    buildDateFilters(q);
    const url = base + "?" + q.toString();
    state.lastURL = url;
    return { url, schema };
  }

  function renderSampleTable(rows){
    if(!rows || !rows.length){ sampleWrap.innerHTML = "<span class='muted'>— sem dados —</span>"; return; }
    const cols = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
    let html = "<table class='grid'><thead><tr>";
    cols.forEach(c => html += `<th>${escapeHTML(c)}</th>`);
    html += "</tr></thead><tbody>";
    rows.forEach(r => {
      html += "<tr>";
      cols.forEach(c => html += `<td>${escapeHTML(String(r[c] ?? ""))}</td>`);
      html += "</tr>";
    });
    html += "</tbody></table>";
    sampleWrap.innerHTML = html;
  }

  function escapeHTML(s){ return s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[m])); }

  // Actions
  $("btnSave").onclick = saveLocal;

  $("btnClear").onclick = () => {
    sampleWrap.innerHTML = "—";
    logBox.textContent = "Pronto.";
  };

  $("btnTest").onclick = async () => {
    const list = await fetchOpenAPI();
    if(list) log("Interface responsiva.");
  };

  $("btnList").onclick = async () => {
    const list = await fetchOpenAPI();
    renderTablePills(list || []);
    if(list) log(`OpenAPI OK. ${list.length} tabelas vistas.`);
  };

  $("btnCount").onclick = async () => {
    try{
      const b = buildURL(false, 0, true);
      if(!b) return;
      const res = await fetch(b.url, {
        method: "HEAD",
        headers: {
          ...buildHeaders(b.schema || ($("onlyPublic").checked ? "public": null)),
          "Prefer": "count=exact"
        }
      });
      if(!res.ok){ log(`Erro no count: HTTP ${res.status}`, "err"); return; }
      const cr = res.headers.get("Content-Range") || "";
      const total = cr.split("/")[1] || "?";
      log(`Count via Content-Range: ${total}`);
    }catch(e){
      log("Falha no count: " + e.message, "err");
    }
  };

  $("btnSample").onclick = async () => {
    try{
      const b = buildURL(true, 20, false);
      if(!b) return;
      const res = await fetch(b.url, {
        headers: buildHeaders(b.schema || ($("onlyPublic").checked ? "public": null))
      });
      if(!res.ok){
        log(`HTTP ${res.status} ao carregar amostra. ${await safeText(res)}`, "err");
        return;
      }
      const json = await res.json();
      renderSampleTable(json);
      log(`Amostra carregada. ${json.length} linhas.`);
    }catch(e){
      log("Erro ao buscar amostra: " + e.message, "err");
    }
  };

  async function safeText(res){
    try{ return JSON.stringify(await res.json()); }catch(_){ try{ return await res.text(); }catch(__){ return ""; } }
  }

  // bootstrap
  loadLocal();
  // convenience: click pills should also save
  pillsWrap.addEventListener("click", ()=>setTimeout(saveLocal, 0));

})();</script>
</body>
</html>
