<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dash Vendas — Diagnóstico (REST + OpenAPI)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --text:#0f172a; --accent:#2563eb;
      --chip:#eef2ff; --chip-text:#3730a3; --error:#991b1b; --ok:#065f46;
    }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; background:var(--bg); color:var(--text); }
    h1{ font-size: 22px; margin:24px 0 8px; }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .card{ background:var(--card); border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .card h2{ font-size:16px; margin:0 0 8px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input[type="text"]{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; }
    input[readonly]{ background:#f9fafb; }
    .btn{ background:var(--accent); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:12px; }
    .ok{ color:var(--ok); }
    .err{ color:var(--error); }
    .log{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1220; color:#e5e7eb; border-radius:10px; padding:10px; font-size:12px; line-height:1.5; white-space:pre-wrap; }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .chip{ background:var(--chip); color:var(--chip-text); border:1px solid #c7d2fe; padding:8px 10px; border-radius:999px; font-size:12px; cursor:pointer; }
    .chip:hover{ filter:brightness(.96); }
    table{ width:100%; border-collapse: collapse; }
    th,td{ border-bottom:1px solid #e5e7eb; padding:8px 10px; font-size:13px; }
    th{ text-align:left; color:var(--muted); font-weight:600; }
    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-6{ grid-column: span 6; } .col-4{ grid-column: span 4; } .col-3{ grid-column: span 3; } .col-12{ grid-column: span 12; }
    @media (max-width: 900px){
      .col-6, .col-4, .col-3, .col-12{ grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dash de Vendas — <span class="muted">Diagnóstico (REST + OpenAPI)</span></h1>

    <div class="card">
      <div class="grid">
        <div class="col-6">
          <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
          <input id="projectUrl" type="text" placeholder="https://xxxxx.supabase.co">
        </div>
        <div class="col-6">
          <label>Anon Key</label>
          <input id="anonKey" type="text" placeholder="eyJhbGci...">
        </div>
        <div class="col-3">
          <label>Somente schema public?</label>
          <input id="onlyPublic" type="checkbox" checked />
        </div>
        <div class="col-3">
          <label style="visibility:hidden">.</label>
          <button id="btnDiscover" class="btn" style="width:100%">Descobrir tabelas e colunas (OpenAPI)</button>
        </div>
        <div class="col-6">
          <div id="discoverStatus" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Config de Vendas</h2>
      <div class="grid">
        <div class="col-6">
          <label>Tabela de vendas (use schema.tabela se necessário)</label>
          <input id="salesTable" type="text" list="tablesList" placeholder="ex.: public.vendas_xlsx">
          <datalist id="tablesList"></datalist>
        </div>
        <div class="col-3">
          <label>Coluna de data</label>
          <input id="dateCol" type="text" placeholder="ex.: data / dt / dh / created_at / hora">
        </div>
        <div class="col-3">
          <label>Coluna de valor (opcional)</label>
          <input id="valueCol" type="text" placeholder="ex.: total / valor_total / receita">
        </div>
        <div class="col-3">
          <label>Coluna de cancelado (opcional)</label>
          <input id="cancelCol" type="text" placeholder="ex.: cancelado / status">
        </div>
        <div class="col-3">
          <label style="visibility:hidden">.</label>
          <button id="btnSave" class="btn secondary" style="width:100%">Salvar</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">Tabelas detectadas:</div>
      <div id="chips" class="chips"></div>
    </div>

    <div class="card">
      <h2>Teste rápido</h2>
      <div class="grid">
        <div class="col-3">
          <label>Início</label>
          <input id="start" type="date">
        </div>
        <div class="col-3">
          <label>Fim</label>
          <input id="end" type="date">
        </div>
        <div class="col-3">
          <label style="visibility:hidden">.</label>
          <button id="btnCount" class="btn" style="width:100%">Contar registros (Content‑Range)</button>
        </div>
        <div class="col-3">
          <label style="visibility:hidden">.</label>
          <button id="btnSample" class="btn secondary" style="width:100%">Carregar amostra</button>
        </div>
      </div>

      <div id="lastUrl" class="muted" style="margin-top:10px"></div>
      <div id="log" class="log" style="margin-top:8px; min-height:60px">Pronto.</div>
    </div>

    <div id="sampleCard" class="card">
      <h2>Amostra de dados</h2>
      <div id="sampleWrap"></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const st = {
    projectUrl: localStorage.getItem('dx.projectUrl') || '',
    anonKey: localStorage.getItem('dx.anonKey') || '',
    table: localStorage.getItem('dx.table') || '',
    dateCol: localStorage.getItem('dx.dateCol') || '',
    valueCol: localStorage.getItem('dx.valueCol') || '',
    cancelCol: localStorage.getItem('dx.cancelCol') || '',
    onlyPublic: (localStorage.getItem('dx.onlyPublic') || '1') === '1',
  };

  // hydrate
  $('projectUrl').value = st.projectUrl;
  $('anonKey').value = st.anonKey;
  $('salesTable').value = st.table;
  $('dateCol').value = st.dateCol;
  $('valueCol').value = st.valueCol;
  $('cancelCol').value = st.cancelCol;
  $('onlyPublic').checked = st.onlyPublic;

  function saveState() {
    localStorage.setItem('dx.projectUrl', $('projectUrl').value.trim());
    localStorage.setItem('dx.anonKey', $('anonKey').value.trim());
    localStorage.setItem('dx.table', $('salesTable').value.trim());
    localStorage.setItem('dx.dateCol', $('dateCol').value.trim());
    localStorage.setItem('dx.valueCol', $('valueCol').value.trim());
    localStorage.setItem('dx.cancelCol', $('cancelCol').value.trim());
    localStorage.setItem('dx.onlyPublic', $('onlyPublic').checked ? '1' : '0');
  }

  $('btnSave').onclick = () => { saveState(); log('Config salva.'); };

  function log(msg, isErr=false){
    const el = $('log');
    const ts = new Date().toTimeString().slice(0,8);
    el.textContent = `[${ts}] ${msg}`;
    if(isErr){ el.classList.add('err'); } else { el.classList.remove('err'); }
  }
  function setLastUrl(u){ $('lastUrl').textContent = 'Última URL: ' + u; }

  // Helpers
  const headers = () => ({
    'apikey': $('anonKey').value.trim(),
    'Authorization': 'Bearer ' + $('anonKey').value.trim(),
    'Accept': 'application/json',
    'Prefer': 'count=exact'
  });

  function toPath(schema, name){
    return (schema && schema !== 'public') ? `${schema}.${name}` : name;
  }

  async function discover(){
    const base = $('projectUrl').value.trim().replace(/\/+$/,'');
    if(!base || !$('anonKey').value.trim()){
      log('Informe Project URL e Anon Key.', true);
      return;
    }
    $('btnDiscover').disabled = true;
    $('discoverStatus').textContent = 'Lendo OpenAPI…';

    try{
      const url = `${base}/rest/v1/`;
      setLastUrl(url);
      const res = await fetch(url, { headers: headers() });
      if(!res.ok){ throw new Error(`OpenAPI HTTP ${res.status}`); }
      const spec = await res.json();

      // Coleta candidatos a partir de paths
      const paths = Object.keys(spec.paths || {});
      let tables = [];
      for(const p of paths){
        if(!p.startsWith('/')) continue;
        const name = p.slice(1); // remove '/'
        // ignora RPC e internals
        if(name.startsWith('rpc/')) continue;
        if(name.includes('*')) continue;
        // PostgREST usa "schema.table" quando schema != public
        tables.push(name);
      }

      // opção: apenas schema public
      if($('onlyPublic').checked){
        tables = tables.filter(t => !t.includes('.') || t.startsWith('public.'));
        tables = tables.map(t => t.replace(/^public\./,''));
      }

      // normaliza e ordena
      const uniq = Array.from(new Set(tables)).sort((a,b)=>a.localeCompare(b));

      // preenche datalist
      const dl = $('tablesList');
      dl.innerHTML = uniq.map(t => `<option value="${t}"></option>`).join('');

      // chips clicáveis
      const chips = $('chips');
      chips.innerHTML = '';
      uniq.forEach(t => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'chip';
        chip.textContent = t;
        chip.onclick = () => { $('salesTable').value = t; saveState(); };
        chips.appendChild(chip);
      });

      $('discoverStatus').innerHTML = `<span class="ok">OpenAPI OK. ${uniq.length} tabelas vistas.</span>`;
      log(`OpenAPI carregado. ${uniq.length} tabelas.`);
    }catch(err){
      $('discoverStatus').innerHTML = `<span class="err">Falha ao ler OpenAPI: ${err.message}</span>`;
      log(`Erro ao ler OpenAPI: ${err.message}`, true);
    }finally{
      $('btnDiscover').disabled = false;
    }
  }

  async function countRange(){
    const base = $('projectUrl').value.trim().replace(/\/+$/,'');
    const table = $('salesTable').value.trim();
    const dateCol = $('dateCol').value.trim();
    if(!base || !table || !dateCol){
      log('Informe tabela e coluna de data.', true);
      return;
    }
    const start = $('start').value;
    const end = $('end').value;
    if(!start || !end){ log('Informe datas de início e fim.', true); return; }

    const q = new URLSearchParams();
    q.set('select','id');
    q.append(dateCol, `gte.${start}`);
    q.append(dateCol, `lt.${end}`);
    const url = `${base}/rest/v1/${table}?${q.toString()}`;
    setLastUrl(url);

    try{
      const res = await fetch(url, { method:'GET', headers: { ...headers(), 'Range':'0-0' } });
      const cr = res.headers.get('Content-Range'); // "0-0/NNN"
      if(!res.ok && res.status !== 206){
        throw new Error(`HTTP ${res.status}`);
      }
      const total = cr && cr.includes('/') ? cr.split('/').pop() : '—';
      log(`Total no período: ${total}`);
    }catch(err){
      log(`Erro no count: ${err.message}`, true);
    }
  }

  async function loadSample(){
    const base = $('projectUrl').value.trim().replace(/\/+$/,'');
    const table = $('salesTable').value.trim();
    if(!base || !table){ log('Informe tabela.', true); return; }
    const url = `${base}/rest/v1/${table}?select=*&limit=5`;
    setLastUrl(url);
    try{
      const res = await fetch(url, { headers: headers() });
      if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
      const rows = await res.json();
      renderSample(rows);
      // se a coluna de data não foi informada, sugere uma
      if(!$('dateCol').value.trim() && rows.length){
        const candidates = ['data','dt','dh','created_at','hora'];
        const keys = Object.keys(rows[0]);
        const hit = candidates.find(c => keys.includes(c));
        if(hit){ $('dateCol').value = hit; saveState(); log(`Coluna de data sugerida: ${hit}`); }
      }
    }catch(err){
      renderSample([]);
      log(`Erro ao carregar amostra: ${err.message}`, true);
    }
  }

  function renderSample(rows){
    const wrap = $('sampleWrap');
    if(!rows || !rows.length){ wrap.innerHTML = '<div class="muted">Sem dados.</div>'; return; }
    const head = Object.keys(rows[0]);
    let html = '<div style="overflow:auto"><table><thead><tr>';
    html += head.map(h=>`<th>${h}</th>`).join('');
    html += '</tr></thead><tbody>';
    for(const r of rows){
      html += '<tr>' + head.map(h=>`<td>${escapeHtml(String(r[h] ?? ''))}</td>`).join('') + '</tr>';
    }
    html += '</tbody></table></div>';
    $('sampleWrap').innerHTML = html;
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    })[m]);
  }

  // defaults for dates: últimos 30 dias
  const today = new Date();
  const dEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1);
  const dStart = new Date(dEnd); dStart.setDate(dEnd.getDate()-30);
  $('end').value = dEnd.toISOString().slice(0,10);
  $('start').value = dStart.toISOString().slice(0,10);

  // events
  $('btnDiscover').onclick = discover;
  $('btnCount').onclick = countRange;
  $('btnSample').onclick = loadSample;
})();
</script>
</body>
</html>
