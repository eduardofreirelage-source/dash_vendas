<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Diagnóstico Supabase — REST + OpenAPI (v3.1)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%2300c853'/%3E%3Ctext x='8' y='11' font-size='9' text-anchor='middle' fill='white'%3EDS%3C/text%3E%3C/svg%3E">
<style>
  :root { --bg:#f7f7fb; --panel:#fff; --ink:#1a1a1a; --sub:#6b7280; --accent:#2563eb; --ok:#059669; --err:#dc2626; --chip:#eef2ff; --chipTxt:#1e40af; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px} .muted{color:var(--sub)}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,button,select{font:inherit} input[type="text"]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{background:#f3f4f6}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chipTxt);cursor:pointer;border:1px solid #c7d2fe}
  .chip:hover{filter:brightness(.98)}
  .log{background:#0b1220;color:#d1d5db;border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;height:130px;overflow:auto;white-space:pre-wrap}
  table{border-collapse:collapse;width:100%} thead th{position:sticky;top:0;background:#f9fafb}
  th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .help{font-size:12px;color:var(--sub)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Diagnóstico Supabase — <span class="muted">REST + OpenAPI (v3.1)</span></h1>
  <div class="grid">
    <section class="card">
      <div class="row">
        <div style="flex:1">
          <label>Project URL (ex.: https://xxxxx.supabase.co)</label>
          <input id="projectUrl" type="text" placeholder="https://xxxxx.supabase.co">
        </div>
        <div style="flex:1">
          <label>Anon Key</label>
          <input id="anonKey" type="text" placeholder="eyJhbGciOi...">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <label class="row" style="margin:0 12px 0 0"><input id="onlyPublic" type="checkbox" checked style="margin-right:8px">Somente schema <b>public</b> ?</label>
        <button id="btnOpenApi" class="btn">1) Testar conexão (OpenAPI)</button>
        <button id="btnList" class="btn ghost">2) Listar tabelas</button>
        <button id="btnSaveCfg" class="btn">Salvar config</button>
      </div>

      <div id="chips" class="chips"></div>

      <div class="row" style="margin-top:14px">
        <div style="flex:1.2">
          <label>Tabela <span class="help">(use <i>schema.tabela</i> se precisar; dica: clique num chip abaixo)</span></label>
          <input id="tb" type="text" placeholder="ex.: public.vendas_xlsx">
        </div>
        <div style="flex:1">
          <label>Coluna de data <span class="help">(opcional)</span></label>
          <input id="dtcol" type="text" placeholder="ex.: dia / data / created_at / dh / hora">
        </div>
        <div style="flex:1">
          <label>Coluna de valor <span class="help">(opcional)</span></label>
          <input id="valcol" type="text" placeholder="ex.: total / valor_total / receita / fat">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Início</label>
          <input id="ini" type="date">
        </div>
        <div style="flex:1">
          <label>Fim</label>
          <input id="fim" type="date">
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnCount" class="btn">Contar registros (Content-Range)</button>
        <button id="btnSample" class="btn primary">Carregar amostra (20)</button>
        <button id="btnClear" class="btn ghost">Limpar</button>
      </div>

      <label style="margin-top:12px">Log</label>
      <div id="log" class="log"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">Amostra de dados</h3>
      <div class="help" id="sampleInfo">—</div>
      <div style="overflow:auto;max-height:520px;border:1px solid #e5e7eb;border-radius:10px;margin-top:8px">
        <table id="tbl"><thead></thead><tbody></tbody></table>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  const qs = id => document.getElementById(id);
  const log = qs('log');
  const chips = qs('chips');
  const tbl = { thead: document.querySelector('#tbl thead'), tbody: document.querySelector('#tbl tbody') };
  const state = {
    url: localStorage.getItem('sv_url') || '',
    key: localStorage.getItem('sv_key') || '',
    onlyPublic: (localStorage.getItem('sv_only_public') ?? 'true') === 'true',
    tables: [],
    chosenTable: localStorage.getItem('sv_tb') || '',
    dtcol: localStorage.getItem('sv_dtcol') || '',
    valcol: localStorage.getItem('sv_valcol') || '',
    ini: localStorage.getItem('sv_ini') || '',
    fim: localStorage.getItem('sv_fim') || ''
  };
  qs('projectUrl').value = state.url;
  qs('anonKey').value = state.key;
  qs('onlyPublic').checked = state.onlyPublic;
  qs('tb').value = state.chosenTable;
  qs('dtcol').value = state.dtcol;
  qs('valcol').value = state.valcol;
  qs('ini').value = state.ini;
  qs('fim').value = state.fim;

  function appendLog(msg, cls){
    const t = new Date();
    const hh = String(t.getHours()).padStart(2,'0');
    const mm = String(t.getMinutes()).padStart(2,'0');
    const ss = String(t.getSeconds()).padStart(2,'0');
    const stamp = `[${hh}:${mm}:${ss}]`;
    const span = document.createElement('span');
    if(cls) span.className = cls;
    span.textContent = `${stamp} ${msg}\n`;
    log.appendChild(span);
    log.scrollTop = log.scrollHeight;
  }
  function saveCfg(){
    state.url = qs('projectUrl').value.trim();
    state.key = qs('anonKey').value.trim();
    state.onlyPublic = qs('onlyPublic').checked;
    state.chosenTable = sanitizeTable(qs('tb').value.trim());
    state.dtcol = qs('dtcol').value.trim();
    state.valcol = qs('valcol').value.trim();
    state.ini = qs('ini').value;
    state.fim = qs('fim').value;
    localStorage.setItem('sv_url', state.url);
    localStorage.setItem('sv_key', state.key);
    localStorage.setItem('sv_only_public', String(state.onlyPublic));
    localStorage.setItem('sv_tb', state.chosenTable);
    localStorage.setItem('sv_dtcol', state.dtcol);
    localStorage.setItem('sv_valcol', state.valcol);
    localStorage.setItem('sv_ini', state.ini);
    localStorage.setItem('sv_fim', state.fim);
    appendLog('Config salva.');
  }
  qs('btnSaveCfg').onclick = saveCfg;
  qs('btnClear').onclick = () => { log.textContent=''; appendLog('Pronto.'); }

  function normBase(url){ return url.replace(/\/+$/,''); } // remove barra final
  function buildHeaders(extra){
    return Object.assign({ apikey: state.key, Authorization: `Bearer ${state.key}` }, extra||{});
  }
  function sanitizeTable(name){
    // protege contra "public.public.tabela" e espaços
    let n = (name || '').trim().replace(/^public\.public\./,'public.').replace(/\s+/g,'');
    // se usuário clicar chip "vendas_xlsx" copiamos "public.vendas_xlsx"
    return n;
  }

  async function apiFetch(url, opts){
    const res = await fetch(url, opts || {});
    if(!res.ok){
      let detail = '';
      try{ const js = await res.json(); detail = ' ' + JSON.stringify(js); }catch(_){}
      const e = new Error(`HTTP ${res.status}${detail}`);
      e.status = res.status; throw e;
    }
    return res;
  }

  async function loadOpenAPI(){
    saveCfg();
    if(!state.url || !state.key){ appendLog('[ERRO] Informe URL e Anon Key.', 'err'); return; }
    const base = normBase(state.url);
    const endpoint = `${base}/rest/v1/`;
    appendLog('Carregando OpenAPI…');
    try{
      const res = await apiFetch(endpoint, { headers: buildHeaders({ Accept: 'application/openapi+json' }) });
      const spec = await res.json();
      const list = extractTablesFromOpenAPI(spec, state.onlyPublic);
      state.tables = list;
      renderChips();
      appendLog(`OpenAPI OK. ${list.length} tabelas vistas.`, 'ok');
    }catch(e){
      appendLog(`[ERRO] Ao carregar OpenAPI: ${e.message}`, 'err');
    }
  }
  qs('btnOpenApi').onclick = loadOpenAPI;
  qs('btnList').onclick = () => { if(state.tables.length===0) appendLog('Nenhuma tabela detectada. Desmarque "Somente public?" ou verifique policies.', 'err'); renderChips(true); };

  function extractTablesFromOpenAPI(spec, onlyPublic){
    const out = new Set();
    const add = (full) => {
      if(!full) return;
      // normaliza "public.table" e evita duplicados
      const norm = full.replace(/^public\.public\./,'public.').replace(/^\./,'');
      const sch = norm.includes('.') ? norm.split('.',2)[0] : 'public';
      const tbl = norm.includes('.') ? norm.split('.',2)[1] : norm;
      if(!tbl) return;
      if(!onlyPublic || sch==='public') out.add(`${sch}.${tbl}`);
    };
    // components.schemas
    const schemas = spec?.components?.schemas || {};
    for(const key of Object.keys(schemas)){
      if(key.includes('.')) add(key);
      else add('public.'+key);
    }
    // definitions
    const defs = spec?.definitions || {};
    for(const key of Object.keys(defs)){
      if(key.includes('.')) add(key);
      else add('public.'+key);
    }
    // paths
    const paths = spec?.paths || {};
    for(const p of Object.keys(paths)){
      const m = p.match(/^\/rest\/v1\/([^/?]+)$/);
      if(m){ add(decodeURIComponent(m[1]).includes('.')?decodeURIComponent(m[1]):'public.'+decodeURIComponent(m[1])); }
    }
    return Array.from(out).sort((a,b)=>a.localeCompare(b));
  }

  function renderChips(){
    chips.innerHTML = '';
    state.tables.forEach(full => {
      const chip = document.createElement('button');
      chip.type = 'button'; chip.className = 'chip';
      chip.textContent = full.split('.')[1]; chip.title = full;
      chip.onclick = () => { qs('tb').value = full; saveCfg(); };
      chips.appendChild(chip);
    });
  }

  function buildQueryURL({ table, select='*', limit=null, order=null, filters=[] }){
    let base = `${normBase(state.url)}/rest/v1/${encodeURIComponent(table)}`;
    const params = new URLSearchParams();
    if(select) params.set('select', select);
    if(limit!=null) params.set('limit', String(limit));
    if(order) params.set('order', `${order.col}.${order.desc?'desc':'asc'}`);
    for(const f of filters){ if(f && f.col && f.op){ params.append(f.col, `${f.op}.${f.val}`); } }
    return `${base}?${params.toString()}`;
  }

  async function countViaContentRange(){
    saveCfg();
    if(!state.url || !state.key || !qs('tb').value.trim()){ appendLog('[ERRO] Informe URL, Key e tabela.', 'err'); return; }
    const table = sanitizeTable(qs('tb').value.trim());
    const dtcol = qs('dtcol').value.trim();
    const ini = qs('ini').value;
    const fim = qs('fim').value;
    appendLog('Contando (GET + Content-Range)…');

    const filters = [];
    if(dtcol && ini && fim){
      filters.push({ col: dtcol, op: 'gte', val: ini });
      const fimEx = new Date(fim); fimEx.setDate(fimEx.getDate()+1);
      const fimStr = fimEx.toISOString().slice(0,10);
      filters.push({ col: dtcol, op: 'lt', val: fimStr });
    }
    const url = buildQueryURL({ table, select: 'id', limit: 1, filters });
    try{
      const res = await apiFetch(url, { method:'GET', headers: buildHeaders({ Range: '0-0', Prefer: 'count=exact' }) });
      const cr = res.headers.get('Content-Range');
      const total = cr ? cr.split('/')[1] : null;
      if(total!=null) appendLog(`Count via Content-Range: ${total}`, 'ok'); else await countFallback(table, filters);
    }catch(e){
      appendLog(`[ERRO] Count: ${e.message}`, 'err');
      if(String(e.message).includes('Perhaps you meant the table')) trySuggestionAndRetry(e.message, 'count', filters);
      else await countFallback(table, filters);
    }
  }
  async function countFallback(table, filters){
    const url = buildQueryURL({ table, select: 'count:count()', limit: 1, filters });
    try{
      const res = await apiFetch(url, { headers: buildHeaders() });
      const js = await res.json();
      const total = js?.[0]?.count ?? null;
      if(total!=null) appendLog(`Count via select=count(): ${total}`, 'ok');
      else appendLog('Count fallback sem retorno.', 'err');
    }catch(e){
      appendLog(`[ERRO] Count fallback: ${e.message}`, 'err');
      if(String(e.message).includes('Perhaps you meant the table')) trySuggestionAndRetry(e.message, 'count', filters);
    }
  }

  async function loadSample(){
    saveCfg();
    const table = sanitizeTable(qs('tb').value.trim());
    if(!state.url || !state.key || !table){ appendLog('[ERRO] Informe URL, Key e tabela.', 'err'); return; }
    appendLog('Carregando amostra…');
    const dtcol = qs('dtcol').value.trim();
    const ini = qs('ini').value;
    const fim = qs('fim').value;

    const filters = [];
    let order = null;
    if(dtcol){
      order = { col: dtcol, desc: true };
      if(ini && fim){
        const fimEx = new Date(fim); fimEx.setDate(fimEx.getDate()+1);
        const fimStr = fimEx.toISOString().slice(0,10);
        filters.push({ col: dtcol, op: 'gte', val: ini });
        filters.push({ col: dtcol, op: 'lt', val: fimStr });
      }
    }
    const url = buildQueryURL({ table, select:'*', limit:20, order, filters });
    try{
      const res = await apiFetch(url, { headers: buildHeaders() });
      const rows = await res.json();
      renderTable(rows);
      document.getElementById('sampleInfo').textContent = `${rows.length} linhas — ${table}`;
      appendLog('Amostra carregada. 20 linhas.', 'ok');
    }catch(e){
      appendLog(`[ERRO] HTTP ao carregar amostra. ${e.message}`, 'err');
      if(String(e.message).includes('Perhaps you meant the table')) trySuggestionAndRetry(e.message, 'sample', filters);
    }
  }

  function trySuggestionAndRetry(msg, mode, filters){
    const m = msg.match(/Perhaps you meant the table '([^']+)'/);
    if(!m) return;
    const suggested = m[1];
    const pretty = suggested.replace(/^public\./,'');
    qs('tb').value = suggested; saveCfg();
    appendLog(`⚙️ Ajustei a tabela para '${suggested}' (sugestão do PostgREST). Tentando novamente…`, 'ok');
    if(mode==='sample') loadSample(); else countViaContentRange();
  }

  function renderTable(rows){
    tbl.thead.innerHTML=''; tbl.tbody.innerHTML='';
    if(!rows || rows.length===0){ return; }
    const cols = Object.keys(rows[0]);
    const trh = document.createElement('tr');
    cols.forEach(c => { const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
    tbl.thead.appendChild(trh);
    for(const r of rows){
      const tr = document.createElement('tr');
      cols.forEach(c => {
        const td=document.createElement('td');
        const v=r[c]; td.textContent=(v==null)?'':String(v); tr.appendChild(td);
      });
      tbl.tbody.appendChild(tr);
    }
  }

  qs('btnCount').onclick = countViaContentRange;
  qs('btnSample').onclick = loadSample;

  appendLog('Interface pronta — cole a URL e a Anon Key, depois clique em "1) Testar conexão".');
})();
</script>
</body>
</html>
