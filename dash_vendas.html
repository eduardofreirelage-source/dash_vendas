<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Início — Diagnóstico Supabase (v0)</title>
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --muted:#64748b; --ring:#3b82f6; --ok:#16a34a; --err:#dc2626; }
    * { box-sizing: border-box; }
    body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; color:var(--fg); background:var(--bg); }
    header { padding:16px 20px; border-bottom:1px solid #e5e7eb; background:#fff; position:sticky; top:0; z-index:2; }
    h1 { font-size:18px; margin:0; }
    main { max-width:1000px; margin:24px auto; padding:0 16px 40px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { font-size:12px; color:var(--muted); display:block; margin:6px 0; }
    input, select, button, textarea { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; }
    input:focus, select:focus, textarea:focus { outline:2px solid var(--ring); outline-offset: 0; border-color:transparent; }
    button { cursor:pointer; }
    .btn { background:#111827; color:#fff; border:none; }
    .btn.secondary { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; font-size:12px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0b1220; color:#e5edff; padding:12px; border-radius:10px; white-space:pre-wrap; min-height:48px; }
    table { width:100%; border-collapse:collapse; margin-top:6px; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eef2f7; }
    th { font-weight:600; font-size:12px; color:var(--muted); background:#fafafa; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    small.muted { color:var(--muted); }
  </style>
</head>
<body>
  <header><h1>Início — Diagnóstico Supabase (v0)</h1></header>
  <main>
    <section class="card">
      <div class="row">
        <div>
          <label>Project URL</label>
          <input id="url" placeholder="https://xxxxx.supabase.co" />
        </div>
        <div>
          <label>Anon Key</label>
          <input id="key" placeholder="eyJhbGciOi..." />
        </div>
      </div>
      <div class="grid-3" style="margin-top:12px;">
        <button id="btnOpenAPI" class="btn">1) Testar conexão (OpenAPI)</button>
        <button id="btnListar" class="btn secondary">2) Listar tabelas</button>
        <button id="btnSalvar" class="btn secondary">Salvar config</button>
      </div>
      <div style="margin-top:10px;">
        <div class="chips" id="chips"></div>
      </div>
      <div style="margin-top:12px;">
        <div class="row">
          <div>
            <label>Tabela</label>
            <input id="tabela" placeholder="ex.: public.vendas_xlsx ou vendas_xlsx" />
          </div>
          <div>
            <label>Coluna de data (opcional)</label>
            <input id="colData" placeholder="ex.: data / created_at / dh / hora" />
          </div>
        </div>
        <div class="grid-3" style="margin-top:12px;">
          <button id="btnAmostra" class="btn">Carregar amostra (20)</button>
          <button id="btnContar" class="btn secondary">Contar via Content-Range</button>
          <button id="btnLimpar" class="btn secondary">Limpar</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <label>Log</label>
        <div class="log" id="log">Pronto.</div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">Amostra de dados</h3>
      <div id="dataWrap">—</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0;">Como usar (passo a passo rápido)</h3>
      <ol>
        <li>Preencha <b>Project URL</b> e <b>Anon Key</b>.</li>
        <li>Clique em <b>“Testar conexão (OpenAPI)”</b>. Se OK, clique em <b>“Listar tabelas”</b> para ver as disponíveis.</li>
        <li>Clique num chip de tabela, ou digite manualmente no campo <b>Tabela</b>.</li>
        <li>Opcional: diga a <b>Coluna de data</b> para filtrar um período quando for contar/regatar.</li>
        <li>Use <b>Amostra</b> para buscar até 20 linhas e verificar o acesso.</li>
      </ol>
      <small class="muted">
        Dicas: 404 geralmente indica nome de tabela/visão errado ou schema diferente de <code>public</code> (use <code>schema.tabela</code>). 401/403 indicam RLS/Permissões.
      </small>
    </section>
  </main>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const logEl = $("#log");
  const chipsEl = $("#chips");
  const dataWrap = $("#dataWrap");

  // Estado simples
  const S = {
    get url(){ return $("#url").value.trim().replace(/\/+$/,''); },
    get key(){ return $("#key").value.trim(); },
    set url(v){ $("#url").value = v || ""; },
    set key(v){ $("#key").value = v || ""; }
  };

  // Persistência básica
  const LS_KEY = "diag_v0_cfg";
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      const cfg = JSON.parse(raw);
      S.url = cfg.url; S.key = cfg.key;
      $("#tabela").value = cfg.tabela || "";
      $("#colData").value = cfg.colData || "";
      write("Config carregada do navegador.");
    }
  } catch(e){}

  $("#btnSalvar").onclick = () => {
    const cfg = { url:S.url, key:S.key, tabela:$("#tabela").value.trim(), colData:$("#colData").value.trim() };
    localStorage.setItem(LS_KEY, JSON.stringify(cfg));
    ok("Config salva.");
  };

  $("#btnLimpar").onclick = () => {
    localStorage.removeItem(LS_KEY);
    $("#tabela").value = ""; $("#colData").value = "";
    chipsEl.innerHTML = ""; dataWrap.innerHTML = "—";
    write("Limpou config local.");
  };

  $("#btnOpenAPI").onclick = async () => {
    try {
      mustURLKey();
      const u = S.url + "/rest/v1/";
      const res = await fetch(u, {
        headers: {
          "Accept":"application/openapi+json",
          "apikey": S.key,
          "Authorization": "Bearer " + S.key
        }
      });
      if (!res.ok) return err(`OpenAPI falhou: HTTP ${res.status}`);
      const spec = await res.json();
      const nPaths = spec && spec.paths ? Object.keys(spec.paths).length : 0;
      ok(`OpenAPI OK. paths=${nPaths}. Clique “Listar tabelas”.`);
      window.__lastSpec = spec;
    } catch(e){ err(e.message || String(e)); }
  };

  $("#btnListar").onclick = () => {
    try {
      const spec = window.__lastSpec;
      if (!spec || !spec.paths) return err("Carregue OpenAPI primeiro.");
      const set = new Set();
      for (const p of Object.keys(spec.paths)) {
        // Extrai primeiro segmento do path: /schema.tabela ou /tabela
        const m = /^\/([^\/\?]+)/.exec(p);
        if (m && m[1]) set.add(m[1]);
      }
      const list = Array.from(set).sort();
      chipsEl.innerHTML = "";
      list.forEach(name => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip";
        chip.textContent = name;
        chip.onclick = () => { $("#tabela").value = name; write(`Tabela selecionada: ${name}`); };
        chipsEl.appendChild(chip);
      });
      ok(`Listou ${list.length} nomes.`);
    } catch(e){ err(e.message || String(e)); }
  };

  $("#btnAmostra").onclick = async () => {
    try {
      mustURLKey();
      const tbl = mustTable();
      const q = new URLSearchParams();
      q.set("select","*");
      q.set("limit","20");
      const col = $("#colData").value.trim();
      // Sem data fixa; só exemplo simples. Se quiser, você pode adicionar filtros depois.
      const u = `${S.url}/rest/v1/${encodeURIComponent(tbl)}?${q.toString()}`;
      const res = await fetch(u, {
        headers: { "apikey": S.key, "Authorization": "Bearer " + S.key, "Prefer":"count=exact" }
      });
      if (!res.ok) return err(`Amostra falhou: HTTP ${res.status}`);
      const rows = await res.json();
      renderTable(rows);
      const cr = res.headers.get("Content-Range");
      ok(`Amostra carregada. Content-Range: ${cr || "—"}`);
    } catch(e){ err(e.message || String(e)); }
  };

  $("#btnContar").onclick = async () => {
    try {
      mustURLKey();
      const tbl = mustTable();
      const col = $("#colData").value.trim();
      // HEAD + count exato; se 404/405, cai em GET com limit=0
      const base = `${S.url}/rest/v1/${encodeURIComponent(tbl)}`;
      let url = base + "?select=id";
      if (col) {
        // Filtro simples por exemplo: últimos 30 dias (ajuste conforme sua coluna/tipo)
        const end = new Date();
        const start = new Date(end.getTime() - 29*86400000);
        const f = (d) => d.toISOString().slice(0,10);
        url += `&${encodeURIComponent(col)}=gte.${f(start)}&${encodeURIComponent(col)}=lt.${f(new Date(end.getTime()+86400000))}`;
      }
      let res = await fetch(url, { method:"HEAD", headers: { "apikey": S.key, "Authorization": "Bearer " + S.key, "Prefer":"count=exact", "Range":"0-0" }});
      if (!res.ok) {
        // fallback GET
        res = await fetch(url + "&limit=0", { headers: { "apikey": S.key, "Authorization": "Bearer " + S.key, "Prefer":"count=exact", "Range":"0-0" }});
      }
      if (!res.ok) return err(`Contagem falhou: HTTP ${res.status}`);
      const cr = res.headers.get("Content-Range") || "—";
      ok(`Total via Content-Range: ${cr}`);
    } catch(e){ err(e.message || String(e)); }
  };

  // helpers
  function write(msg){ logEl.textContent = String(msg); }
  function ok(msg){ write("✅ " + msg); }
  function err(msg){ write("❌ " + msg); console.error(msg); }
  function mustURLKey(){
    if (!S.url || !/^https:\/\/.+\.supabase\.co$/i.test(S.url)) throw new Error("Informe Project URL válido (https://xxxxx.supabase.co).");
    if (!S.key) throw new Error("Informe Anon Key.");
  }
  function mustTable(){
    const t = $("#tabela").value.trim();
    if (!t) throw new Error("Informe a tabela (pode incluir schema, ex.: public.vendas_xlsx).");
    return t;
  }
  function renderTable(rows){
    if (!Array.isArray(rows) || rows.length === 0) { dataWrap.innerHTML = "— Sem linhas —"; return; }
    const cols = Object.keys(rows[0]);
    let html = "<div style='overflow:auto'><table><thead><tr>";
    html += cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("");
    html += "</tr></thead><tbody>";
    for (const r of rows) {
      html += "<tr>" + cols.map(c=>`<td>${escapeHtml(fmt(r[c]))}</td>`).join("") + "</tr>";
    }
    html += "</tbody></table></div>";
    dataWrap.innerHTML = html;
  }
  function fmt(v){
    if (v == null) return "—";
    if (typeof v === "object") return JSON.stringify(v);
    return String(v);
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
})();
</script>
</body>
</html>
